[{"id":"a26dba1745837d214d39192aa8ca3207","title":"SpringBootæºç åˆ†æ","content":"1 å¦‚ä½•æ­å»ºSpringBootæºç è°ƒè¯•ç¯å¢ƒ1 å‰è¨€è¿™æ˜¯ SpringBoot2.1 æºç åˆ†æä¸“é¢˜çš„ç¬¬ä¸€ç¯‡æ–‡ç« ï¼Œä¸»è¦è®²å¦‚ä½•æ¥æ­å»ºæˆ‘ä»¬çš„æºç é˜…è¯»è°ƒè¯•ç¯å¢ƒã€‚å¦‚æœæœ‰ç»éªŒçš„å°ä¼™ä¼´ä»¬å¯ä»¥ç•¥è¿‡æ­¤ç¯‡æ–‡ç« ã€‚\n\n2 ç¯å¢ƒå®‰è£…è¦æ±‚\nIntelliJ IDEA\nJDK1.8\nMaven3.5 ä»¥ä¸Š\n\n\n3 ä» Github ä¸Šå°† SpringBoot æºç é¡¹ç›®ä¸‹è½½ä¸‹æ¥é¦–å…ˆæä¾›SpringBoot2.1.0çš„ github åœ°å€ï¼š github.com&#x2F;spring-projâ€¦\nå› ä¸ºè¦è¿›è¡Œé˜…è¯»æºç å’Œåˆ†ææºç é¡¹ç›®ï¼Œæˆ‘ä»¬æ˜¯ä¸æ˜¯è¦åœ¨é‡Œé¢å†™ä¸€äº›æ³¨é‡Šå¸®åŠ©æˆ‘ä»¬é˜…è¯»ç†è§£æºç ï¼Œå› æ­¤éœ€è¦å°† SpringBoot æºç é¡¹ç›® fork åˆ°è‡ªå·±çš„ github ä»“åº“ä¸­ï¼Œç„¶åå†åˆ©ç”¨git clone urlå‘½ä»¤å°†å·²ç» fork åˆ°è‡ªå·± github ä»“åº“çš„ SpringBoot æºç æ‹‰å–ä¸‹æ¥å³å¯ã€‚ ä½†ç”±äºä»¥ä¸Šæ–¹å¼å¾€å¾€å¾ˆæ…¢ï¼Œé€šå¸¸ä¼šè¶…æ—¶ï¼Œæ‰€ä»¥ç¬”è€…ç›´æ¥å°† SpringBoot é¡¹ç›®ç›´æ¥ä¸‹è½½ä¸‹æ¥ï¼Œç„¶åå†å¯¼å…¥ IDEA ä¸­ã€‚\n\n\n4 å°† SpringBoot æºç é¡¹ç›®å¯¼å…¥åˆ° IDEA ä¸­å°†åˆšæ‰ä¸‹è½½çš„ spring-boot2.1.0.RELEASE é¡¹ç›®é€‰æ‹© maven æ–¹å¼å¯¼å…¥åˆ° IDEA ä¸­ï¼Œç„¶åä¸€ç›´ next å³å¯å¯¼å…¥å®Œæˆï¼Œæ³¨æ„é€‰æ‹© JDK ç‰ˆæœ¬æ˜¯ 1.8ï¼Œmaven ç‰ˆæœ¬æ˜¯ 3.5+ã€‚\n\næ­¤æ—¶ä¸‹è½½ maven ä¾èµ–æ˜¯ä¸€ä¸ªæ¼«é•¿çš„ç­‰å¾…è¿‡ç¨‹ï¼Œå»ºè®® maven æ²¡æœ‰é…ç½®ï¼ˆé˜¿-é‡Œ-äº‘ï¼‰ä»“åº“çš„å°ä¼™ä¼´ä»¬é…ç½®ä¸€ä¸‹ï¼Œè¿™æ ·ä¸‹è½½é€Ÿåº¦ä¼šå¿«å¾ˆå¤šã€‚å‚è€ƒé…ç½® maven ä½¿ç”¨ï¼ˆé˜¿-é‡Œ-äº‘ï¼‰ä»“åº“è¿›è¡Œé…ç½®å³å¯ã€‚\n\n5 ç¼–è¯‘æ„å»º SpringBoot æºç é¡¹ç›®æ­¤æ—¶å¯¼å…¥é¡¹ç›®åï¼Œæˆ‘ä»¬è¿›è¡Œç¼–è¯‘æ„å»º SpringBoot æºç é¡¹ç›®äº†ï¼Œåœ¨æ„å»ºä¹‹å‰åšä¸¤ä¸ªé…ç½®ï¼š\n1ã€æˆ‘ä»¬è¦ç¦ç”¨ maven çš„ä»£ç æ£€æŸ¥ï¼Œåœ¨æ ¹ pom.xml ä¸­å¢åŠ ä¸€ä¸‹é…ç½®å³å¯ï¼Œå¦‚ä¸‹å›¾ï¼š\n\n2ã€å¯èƒ½æœ‰çš„å°ä¼™ä¼´ä»¬çš„ pom.xml æ–‡ä»¶çš„ project æ ‡ç­¾ä¸Šæ˜¾ç¤ºjava.lang.OutOfMemoryErroré”™è¯¯ï¼Œè¿™æ˜¯å› ä¸º IDEA é‡Œçš„ Maven çš„ importer è®¾ç½®çš„ JVM æœ€å¤§å †å†…å­˜è¿‡å°è€Œå¯¼è‡´çš„ï¼Œå¦‚ä¸‹å›¾,æ­¤æ—¶å¯å‚è€ƒMaven ä¾èµ–åŒ…å¯¼å…¥é”™è¯¯ï¼ˆIntelliJ IDEAï¼‰è§£å†³å³å¯ã€‚\n\nè¿›è¡Œäº†ä¸Šé¢çš„ä¸¤ç‚¹é…ç½®åï¼Œæ­¤æ—¶æˆ‘ä»¬å°±å¯ä»¥ç›´æ¥æ‰§è¡Œä»¥ä¸‹ maven å‘½ä»¤æ¥ç¼–è¯‘æ„å»ºæºç é¡¹ç›®äº†ã€‚\nmvn clean install -DskipTests -Pfast\n\n æ­¤æ—¶åˆæ˜¯æ¼«é•¿çš„ç­‰å¾…ï¼Œæˆ‘è¿™é‡Œç­‰å¾… 5 åˆ†é’Ÿå·¦å³å°±æ˜¾ç¤ºæ„å»ºæˆåŠŸäº†ï¼Œå¦‚ä¸‹å›¾ï¼š\n\n\n6 è¿è¡Œ SpringBoot è‡ªå¸¦çš„ sampleå› ä¸º SpringBoot æºç ä¸­çš„ spring-boot-samples æ¨¡å—è‡ªå¸¦äº†å¾ˆå¤š DEMO æ ·ä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨å…¶ä¸­çš„ä¸€ä¸ª sample æ¥æµ‹è¯•è¿è¡Œåˆšåˆšæ„å»ºçš„ springboot æºç é¡¹ç›®å³å¯ã€‚ä½†æ­¤æ—¶å‘ç° spring-boot-samples æ¨¡å—æ˜¯ç°è‰²çš„ï¼Œå¦‚ä¸‹å›¾ï¼š\n\nè¿™æ˜¯å› ä¸º spring-boot-samples æ¨¡å—æ²¡æœ‰è¢«æ·»åŠ åˆ°æ ¹ pom.xml ä¸­ï¼Œæ­¤æ—¶å°†å…¶æ·»åŠ åˆ°æ ¹ pom.xml ä¸­å³å¯ï¼Œå¢åŠ å¦‚ä¸‹é…ç½®ï¼Œå¦‚ä¸‹å›¾ï¼š\n æ­¤æ—¶æˆ‘ä»¬æŒ‘é€‰ spring-boot-samples æ¨¡å—ä¸‹çš„ spring-boot-sample-tomcat æ ·ä¾‹é¡¹ç›®æ¥æµ‹è¯•å¥½äº†ï¼Œæ­¤æ—¶å¯åŠ¨SampleTomcatApplicationçš„mainå‡½æ•°ï¼Œå¯åŠ¨æˆåŠŸç•Œé¢å¦‚ä¸‹ï¼š\n ç„¶åæˆ‘ä»¬å†åœ¨æµè§ˆå™¨å‘é€ä¸€ä¸ª HTTP è¯·æ±‚ï¼Œæ­¤æ—¶å¯ä»¥çœ‹åˆ°æœåŠ¡ç«¯æˆåŠŸè¿”å›å“åº”ï¼Œè¯´æ˜æ­¤æ—¶ SpringBoot æºç ç¯å¢ƒå°±å·²ç»æ„å»ºæˆåŠŸäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±å¯ä»¥è¿›è¡Œè°ƒè¯•äº†ï¼Œå¦‚ä¸‹å›¾ï¼š\n\n\n7 åŠ¨æ‰‹å®è·µç¯èŠ‚å‰é¢å·²ç»æˆåŠŸæ„å»ºäº† SpringBoot çš„æºç é˜…è¯»ç¯å¢ƒï¼Œå°ä¼™ä¼´ä»¬è®°å¾—è‡ªå·±åŠ¨æ‰‹æ­å»ºä¸€å¥—å±äºè‡ªå·±çš„ SpringBoot æºç è°ƒè¯•ç¯å¢ƒå“¦ï¼Œé˜…è¯»æºç åŠ¨æ‰‹è°ƒè¯•å¾ˆé‡è¦ï¼Œå˜¿å˜¿ã€‚\n2 å¦‚ä½•åˆ†æSpringBootæºç æ¨¡å—åŠç»“æ„æ³¨ï¼šè¯¥æºç åˆ†æå¯¹åº”SpringBootç‰ˆæœ¬ä¸º2.1.0.RELEASE\n\n1 å‰è¨€å‰é¢æ­å»ºå¥½äº†è‡ªå·±æœ¬åœ°çš„SpringBootæºç è°ƒè¯•ç¯å¢ƒåï¼Œæ­¤æ—¶æˆ‘ä»¬ä¸è¦æ€¥ç€ä¸‹æ‰‹è¿›å…¥åˆ°å…·ä½“çš„æºç è°ƒè¯•ç»†èŠ‚ä¸­ï¼Œåˆšå¼€å§‹é˜…è¯»æºç ï¼Œæ­¤æ—¶æˆ‘ä»¬ä¸€å®šè¦å¯¹é¡¹ç›®ç»“æ„ç­‰æœ‰ä¸€ä¸ªæ•´ä½“çš„è®¤è¯†ï¼Œç„¶åå†è¿›è¡Œæºç åˆ†æè°ƒè¯•ã€‚æ¨èé˜…è¯»ä¸‹ç¬”è€…ä¹‹å‰å†™çš„çš„åˆ†æå¼€æºé¡¹ç›®æºç ï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•å…¥æ‰‹åˆ†æï¼Ÿä¸€æ–‡ï¼Œå¹²è´§æ»¡æ»¡å“¦ã€‚\n\n2 SpringBootæºç æ¨¡å—ä¸€è§ˆæˆ‘ä»¬å…ˆæ¥å¯¹SpringBootçš„æºç æ¨¡å—æ¥ä¸€ä¸ªå¤§è‡´çš„äº†è§£ï¼Œå¦‚ä¸‹å›¾ï¼š\n\nä»ä¸Šå›¾å¯ä»¥çœ‹åˆ°ï¼Œä¸»è¦æœ‰ä»¥ä¸‹å››ä¸ªæ¨¡å—ï¼š\n\n**spring-boot-project**ï¼šæ•´ä¸ªSpringBootæ¡†æ¶å…¨éƒ¨åŠŸèƒ½åœ¨è¿™ä¸ªæ¨¡å—å®ç°ï¼ŒSpringBooté¡¹ç›®95%çš„ä»£ç éƒ½åœ¨è¿™é‡Œå®ç°ï¼Œæºç æ€»å…±æœ‰25ä¸‡è¡Œå·¦å³ã€‚\n**spring-boot-samples**ï¼šè¿™ä¸ªæ˜¯SpringBootç»™å°ä¼™ä¼´ä»¬èµ é€çš„ç¦åˆ©ï¼Œé‡Œé¢åŒ…å«äº†å„ç§å„æ ·ä½¿ç”¨SpringBootçš„ç®€å•demoï¼Œæˆ‘ä»¬è°ƒè¯•é˜…è¯»æºç çš„æ—¶å€™å¯ä»¥å……åˆ†åˆ©ç”¨è¯¥æ¨¡å—ã€‚\n**spring-boot-sample-invoker**ï¼šè¿™ä¸ªæ¨¡å—åº”è¯¥æ˜¯è·Ÿsampleæ¨¡å—æœ‰å…³ï¼Œæ³¨æ„æ ¹pom.xmlä¸­æœ‰è¿™ä¹ˆä¸€å¥è¯ï¼šSamples are built via the invoker pluginï¼Œè¯¥æ¨¡å—æ— ä»£ç ã€‚\n**spring-boot-tests**ï¼šè¿™ä¸ªæ¨¡å—SpringBootçš„æµ‹è¯•æ¨¡å—ï¼Œè·Ÿéƒ¨ç½²æµ‹è¯•å’Œé›†æˆæµ‹è¯•æœ‰å…³ã€‚\n\nå› ä¸ºSpringBootçš„å…¨éƒ¨åŠŸèƒ½åœ¨spring-boot-projectæ¨¡å—å®ç°ï¼Œå› æ­¤ä¸‹é¢é‡ç‚¹æ¥ä»‹ç»ä¸‹ spring-boot-project æ¨¡å—ã€‚\n\n3 spring-boot-projectæºç æ¨¡å—è¯¦è§£å…ˆæ¥çœ‹ä¸‹ spring-boot-project æ•´ä½“æ¨¡å—ç»“æ„ï¼Œå¦‚ä¸‹å›¾ï¼Œç„¶åæˆ‘ä»¬å†é€ä¸ªæ¥ä»‹ç»ï¼š\n\n\n1) spring-boot-parent\nè¿™ä¸ªæ¨¡å—æ²¡æœ‰ä»£ç ï¼Œæ˜¯spring-bootæ¨¡å—çš„çˆ¶é¡¹ç›®ï¼Œè¢«å…¶ä»–å­æ¨¡å—ç»§æ‰¿ã€‚\n\n2) spring-boot\nè¿™ä¸ªæ¨¡å—æ˜¯SpringBooté¡¹ç›®çš„æ ¸å¿ƒï¼Œå¯ä»¥è¯´ä¸€äº›åŸºç¡€æ ¸å¿ƒçš„åŠŸèƒ½éƒ½åœ¨è¿™é‡Œå®ç°ï¼Œä¸ºSpringBootçš„å…¶ä»–æ¨¡å—ç»„ä»¶åŠŸèƒ½æä¾›äº†æ”¯æŒï¼Œä¸»è¦åŒ…æ‹¬ä»¥ä¸‹æ ¸å¿ƒåŠŸèƒ½ï¼š\n\nSpringApplicationç±»ï¼Œè¿™ä¸ªæ˜¯SpringBootçš„å¯åŠ¨ç±»ï¼Œæä¾›äº†ä¸€ä¸ªé™æ€çš„runæ–¹æ³•æ¥å¯åŠ¨ç¨‹åºï¼Œè¯¥ç±»ä¸»è¦ç”¨æ¥åˆ›å»ºå¹¶ä¸”åˆ·æ–°Springå®¹å™¨ApplicationContext.\næ”¯æŒé€‰æ‹©ä¸åŒçš„å®¹å™¨æ¯”å¦‚Tomcat,Jettyç­‰æ¥ä½œä¸ºåº”ç”¨çš„åµŒå…¥å®¹å™¨ï¼Œè¿™ä¸ªæ˜¯SpringBootçš„æ–°ç‰¹æ€§ä¹‹ä¸€ã€‚\nå¤–éƒ¨é…ç½®æ”¯æŒï¼Œè¿™ä¸ªæŒ‡çš„æ˜¯æˆ‘ä»¬æ‰§è¡Œjava -jar xxx.jarå‘½ä»¤æ—¶å¯ä»¥å¸¦ä¸€äº›å‚æ•°ï¼Œæ¯”å¦‚æ‰§è¡Œjava -jar demo.jar --server.port=8888æ¥å°†åº”ç”¨ç«¯å£ä¿®æ”¹ä¸º8888.\nè¯¥æ¨¡å—å†…ç½®äº†ä¸€äº›SpringBootå¯åŠ¨æ—¶çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶å’Œä¸€äº›å®¹å™¨åˆå§‹åŒ–å™¨(ApplicationContext initializers)ï¼Œæ¥æ‰§è¡Œä¸€äº›SpringBootå¯åŠ¨æ—¶çš„åˆå§‹åŒ–é€»è¾‘ã€‚\n\n\n3) spring-boot-autoconfigure\nè¿™ä¸ªæ¨¡å—è·ŸSpringBootçš„è‡ªåŠ¨é…ç½®æœ‰å…³ï¼Œä¹Ÿæ˜¯SpringBootçš„æ–°ç‰¹æ€§ä¹‹ä¸€ã€‚æ¯”å¦‚SpringBootèƒ½åŸºäºç±»è·¯å¾„æ¥è‡ªåŠ¨é…ç½®æŸä¸ªé¡¹ç›®æ¨¡å—ï¼Œè‡ªåŠ¨é…ç½®æœ€ä¸ºå…³é”®çš„æ³¨è§£æ˜¯@EnableAutoConfiguration,è¿™ä¸ªæ³¨è§£èƒ½è§¦å‘Springä¸Šä¸‹æ–‡çš„è‡ªåŠ¨é…ç½®ã€‚å¦å¤–ä¸€ä¸ªé‡è¦çš„æ³¨è§£æ˜¯@Conditionalã€‚\n\n\n\n\n\n\n\n\n\nä¸¾ä¸ªæ —å­ï¼Œè‹¥HSQLDBåœ¨é¡¹ç›®çš„ç±»è·¯å¾„ä¸­ï¼Œä¸”æˆ‘ä»¬æ²¡æœ‰é…ç½®ä»»ä½•å…¶ä»–æ•°æ®åº“çš„è¿æ¥ï¼Œæ­¤æ—¶è‡ªåŠ¨é…ç½®å°±ä¼šè‡ªåŠ¨æ ¹æ®ç±»è·¯å¾„æ¥åˆ›å»ºç›¸åº”çš„beanã€‚\né™¤äº†æ ¹æ®ç±»è·¯å¾„æ¥è¿›è¡Œè‡ªåŠ¨é…ç½®å¤–ï¼Œè¿˜æœ‰æ ¹æ®å®¹å™¨ä¸­æ˜¯å¦å­˜åœ¨æŸä¸ªbeanç­‰æ–¹å¼æ¥è¿›è¡Œè‡ªåŠ¨é…ç½®ï¼Œè¿™é‡Œä¸ä¼šè¿›å…¥åˆ°å…·ä½“ç»†èŠ‚ä¸­ã€‚\n4) spring-boot-starters\nè¿™ä¸ªæ¨¡å—æ˜¯è·ŸSpringBootçš„èµ·æ­¥ä¾èµ–æœ‰å…³ï¼Œä¹Ÿæ˜¯SpringBootçš„æ–°ç‰¹æ€§ä¹‹ä¸€ã€‚SpringBooté€šè¿‡æä¾›ä¼—å¤šèµ·æ­¥ä¾èµ–é™ä½é¡¹ç›®ä¾èµ–çš„å¤æ‚åº¦ã€‚èµ·æ­¥ä¾èµ–å…¶å®å°±æ˜¯åˆ©ç”¨mavené¡¹ç›®æ¨¡å‹å°†å…¶ä»–ç›¸å…³çš„ä¾èµ–ç»™èšåˆèµ·æ¥ï¼Œé‡Œé¢å„ç§ä¾èµ–çš„ç‰ˆæœ¬å·éƒ½ç»™å®šä¹‰å¥½ï¼Œé¿å…ç”¨æˆ·åœ¨å¼•å…¥ä¾èµ–æ—¶å‡ºç°å„ç§ç‰ˆæœ¬å†²çªï¼Œæ–¹ä¾¿äº†æˆ‘ä»¬çš„ä½¿ç”¨ã€‚\n\n\n\n\n\n\n\n\n\nä¸¾ä¸ªæ —å­ï¼Œæˆ‘ä»¬è¦ç”¨åˆ°activemqæ—¶ï¼Œæ­¤æ—¶å¯ä»¥ç›´æ¥å¼•å…¥spring-boot-starter-activemqèµ·æ­¥ä¾èµ–å³å¯ï¼Œè‹¥SpringBootå®˜ç½‘æˆ–ç¬¬ä¸‰æ–¹ç»„ç»‡æ²¡æœ‰æä¾›ç›¸åº”çš„SpringBootèµ·æ­¥ä¾èµ–æ—¶ï¼Œæ­¤æ—¶æˆ‘ä»¬å¯ä»¥è¿›è¡Œå®šåˆ¶è‡ªå·±çš„èµ·æ­¥ä¾èµ–ã€‚\næ³¨æ„ï¼Œè¯¥æ¨¡å—æ²¡æœ‰ä»£ç ï¼Œä¸»è¦æ˜¯é€šè¿‡mavençš„pom.xmlæ¥ç»„ç»‡å„ç§ä¾èµ–ã€‚\n5) spring-boot-cli\nSpring Boot CLIæ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼Œå¦‚æœæ‚¨æƒ³ä½¿ç”¨Springå¿«é€Ÿå¼€å‘ï¼Œå¯ä»¥ä½¿ç”¨å®ƒã€‚å®ƒå…è®¸æ‚¨è¿è¡ŒGroovyè„šæœ¬ï¼Œè¿™æ„å‘³ç€æ‚¨æœ‰ä¸€ä¸ªç†Ÿæ‚‰çš„ç±»ä¼¼Javaçš„è¯­æ³•ï¼Œè€Œæ²¡æœ‰é‚£ä¹ˆå¤šæ ·æ¿ä»£ç ã€‚æ‚¨è¿˜å¯ä»¥å¼•å¯¼ä¸€ä¸ªæ–°é¡¹ç›®æˆ–ç¼–å†™è‡ªå·±çš„å‘½ä»¤ã€‚\n\n6) spring-boot-actuator\nè¿™ä¸ªè·ŸSpringBootçš„ç›‘æ§æœ‰å…³ï¼Œä¹Ÿæ˜¯SpringBootçš„æ–°ç‰¹æ€§ä¹‹ä¸€ã€‚å¯ä»¥é€šè¿‡HTTPç«¯ç‚¹æˆ–JMXç­‰æ¥ç®¡ç†å’Œç›‘æ§åº”ç”¨ã€‚å®¡è®¡ã€è¿è¡ŒçŠ¶å†µå’Œåº¦é‡æ”¶é›†å¯ä»¥è‡ªåŠ¨åº”ç”¨åˆ°åº”ç”¨ç¨‹åºã€‚è¿™ä¸ªç›‘æ§æ¨¡å—æ˜¯å¼€ç®±å³ç”¨çš„ï¼Œæä¾›äº†ä¸€ç³»åˆ—ç«¯ç‚¹åŒ…æ‹¬HealthEndpoint, EnvironmentEndpointå’ŒBeansEndpointç­‰ç«¯ç‚¹ã€‚\n\n7) spring-boot-actuator-autoconfigure\nè¿™ä¸ªæ¨¡å—ä¸ºç›‘æ§æ¨¡å—æä¾›è‡ªåŠ¨é…ç½®çš„åŠŸèƒ½ï¼Œé€šå¸¸ä¹Ÿæ˜¯æ ¹æ®ç±»è·¯å¾„æ¥è¿›è¡Œé…ç½®ã€‚æ¯”å¦‚Micrometerå­˜åœ¨äºç±»è·¯å¾„ä¸­ï¼Œé‚£ä¹ˆå°†ä¼šè‡ªåŠ¨é…ç½®MetricsEndpointã€‚\n\n8) spring-boot-test\nè¿™ä¸ªæ¨¡å¼æ˜¯spring-bootçš„è·Ÿæµ‹è¯•æœ‰å…³çš„æ¨¡å—ï¼ŒåŒ…å«äº†ä¸€äº›å¸®åŠ©æˆ‘ä»¬æµ‹è¯•çš„æ ¸å¿ƒç±»å’Œæ³¨è§£ï¼ˆæ¯”å¦‚@SpringBootTestï¼‰ã€‚\n\n9) spring-boot-dependencies\nè¿™ä¸ªæ¨¡å—ä¹Ÿæ²¡æœ‰ä»£ç ï¼Œä¸»è¦æ˜¯å®šä¹‰äº†ä¸€äº›SpringBootçš„mavenç›¸å…³çš„ä¸€äº›ä¾èµ–åŠå…¶ç‰ˆæœ¬ã€‚\n\n10) spring-boot-devtools\nè¿™ä¸ªæ¨¡å—è·ŸSpringBootçš„çƒ­éƒ¨ç½²æœ‰å…³ï¼Œå³ä¿®æ”¹ä»£ç åæ— éœ€é‡å¯åº”ç”¨å³ç”Ÿæ•ˆã€‚\n\n11) spring-boot-docs\nè¿™ä¸ªæ¨¡å—åº”è¯¥æ˜¯è·Ÿæ–‡æ¡£ç›¸å…³çš„æ¨¡å—ã€‚\n\n12) spring-boot-properties-migrator\nçœ‹åˆ° migrator è¿™ä¸ªå•è¯ï¼Œä¼°è®¡å°±æ˜¯è·Ÿé¡¹ç›®è¿ç§»æœ‰å…³ï¼Œæ²¡æœ‰å»ç»† ç©¶ã€‚\n\n13) spring-boot-test-autoconfigure\nè¿™ä¸ªæ¨¡å—ä¸€çœ‹å°±æ˜¯è·ŸSpringBootçš„æµ‹è¯•çš„è‡ªåŠ¨é…ç½®æœ‰å…³ã€‚\n\n14) spring-boot-tools\nè¿™ä¸ªæ¨¡å—ä¸€çœ‹å°±æ˜¯SpringBootçš„å·¥å…·ç›¸å…³çš„æ¨¡å—ï¼Œæä¾›äº†åŠ è½½ï¼Œmavenæ’ä»¶,metadataå’Œåç½®å¤„ç†ç›¸å…³çš„æ”¯æŒã€‚\nä¸Šé¢ä»‹ç»äº†è¿™ä¹ˆå¤šspring-bootæ¨¡å—ä¸‹çš„å­æ¨¡å—ï¼Œä¸ç”¨æ…Œï¼Œæˆ‘ä»¬è¦è¿›è¡Œè§£è¯»çš„æ¨¡å—ä¸å¤šï¼Œæˆ‘ä»¬çœŸæ­£è¦çœ‹çš„æ¨¡å—æœ‰spring-bootï¼Œspring-boot-autoconfigureï¼Œspring-boot-starterså’Œspring-boot-actuatoræ¨¡å—ã€‚\n\n4 ç”¨ä¸€ä¸ªæ€ç»´å¯¼å›¾æ¥æ€»ç»“ä¸‹SpringBootæºç é¡¹ç›®çš„è„‰ç»œ\n\n5 SpringBootæ¨¡å—ä¹‹é—´çš„pomå…³ç³»è¯¦è§£å‰é¢å¼„æ¸…æ¥šäº†SpringBootçš„å„ä¸ªæ¨¡å—çš„å…·ä½“åŠŸèƒ½ï¼Œæ­¤æ—¶æˆ‘ä»¬æ¥çœ‹ä¸‹SpringBootæ¨¡å—çš„pomä¹‹é—´çš„å…³ç³»æ˜¯æ€æ ·çš„ï¼Œå› ä¸ºé¡¹ç›®æ˜¯é€šè¿‡mavenæ„å»ºçš„ï¼Œå› æ­¤è¿˜æ˜¯æœ‰å¿…è¦å»ç ”ç©¶ä¸‹è¿™å—å…³ç³»æ»´ã€‚\nå…ˆçœ‹SpringBootæºç é¡¹ç›®çš„pomå…³ç³»ï¼Œå¦‚ä¸‹å›¾ï¼š\n æ ¹æ®ä¸Šå›¾å¯å¾—å‡ºä»¥ä¸‹ç»“è®ºï¼š\n\nspring-boot-build(pom.xml)æ˜¯é¡¹ç›®çš„æ ¹pomï¼Œå…¶å­pomæœ‰spring-boot-project(pom.xml)å’Œspring-boot-dependencies(pom.xml)ï¼›\nspring-boot-dependencies(pom.xml)ä¸»è¦å®šä¹‰äº†SpringBooté¡¹ç›®çš„å„ç§ä¾èµ–åŠå…¶ç‰ˆæœ¬ï¼Œå…¶å­pomæœ‰spring-boot-parent(pom.xml)å’Œspring-boot-starter-parent(pom.xml)ï¼›\nspring-boot-project(pom.xml)èµ·åˆ°èšåˆmoduleçš„ä½œç”¨ï¼Œå…¶å­æ¨¡å—å¹¶ä¸ç»§æ‰¿äºå®ƒï¼Œè€Œæ˜¯ç»§æ‰¿äºspring-boot-parent(pom.xml)ï¼›\nspring-boot-parent(pom.xml)æ˜¯spring-boot-project(pom.xml)çš„å­moduleï¼Œä½†ç»§æ‰¿çš„çˆ¶pomä¸ºspring-boot-dependencies(pom.xml)ï¼Œå…¶å®šä¹‰äº†ä¸€äº›propertiesç­‰ç›¸å…³çš„ä¸œè¥¿ã€‚å…¶å­pomä¸ºspring-boot-project(pom.xml)çš„å­moduleï¼ˆæ³¨æ„é™¤å»spring-boot-dependencies(pom.xml)ï¼‰ï¼Œæ¯”å¦‚æœ‰spring-boot(pom.xml),spring-boot-starters(pom.xml)å’Œspring-boot-actuator(pom.xml)ç­‰ï¼›\nspring-boot-starters(pom.xml)æ˜¯æ‰€æœ‰å…·ä½“èµ·æ­¥ä¾èµ–çš„çˆ¶pomï¼Œå…¶å­pomæœ‰spring-boot-starter-data-jdbc(pom.xml)å’Œspring-boot-starter-data-redis(pom.xml)ç­‰ã€‚\nspring-boot-starter-parent(pom.xml)ï¼Œæ˜¯æˆ‘ä»¬çš„æ‰€æœ‰å…·ä½“SpringBooté¡¹ç›®çš„çˆ¶pomï¼Œæ¯”å¦‚SpringBootè‡ªå¸¦çš„æ ·ä¾‹çš„spring-boot-samples(pom.xml)æ˜¯ç»§æ‰¿äºå®ƒçš„ã€‚\n\nSpringBootçš„å„æ¨¡å—ä¹‹é—´çš„pomå…³ç³»æœ‰ç‚¹å¤æ‚ï¼Œç¡®å®æœ‰ç‚¹ç»•ï¼Œå¦‚æœçœ‹å®Œä¸Šé¢çš„å›¾ç‰‡å’Œè§£é‡Šè¿˜æ˜¯ä¸å¤ªæ¸…æ¥šçš„è¯ï¼Œå»ºè®®å°ä¼™ä¼´ä»¬è‡ªå·±æ‰“å¼€ideaçš„é¡¹ç›®ï¼Œé€ä¸ªå»æ‹ä¸€ä¸‹ã€‚æ€»ä¹‹è®°å¾—SpringBootçš„ä¸€äº›çˆ¶pomæ— éæ˜¯åšäº†ä¸€äº›ç‰ˆæœ¬ç®¡ç†ï¼Œèšåˆæ¨¡å—ä¹‹é—´çš„äº‹æƒ…ã€‚\n6 å°ç»“å¥½äº†ï¼Œå‰é¢å·²ç»æŠŠSpringBootæºç é¡¹ç›®çš„å„ä¸ªæ¨¡å—çš„åŠŸèƒ½å’Œæ¨¡å—pomä¹‹é—´çš„å…³ç³»ç»™æ‹æ¸…æ¥šäº†ï¼Œæ€»ä¹‹åˆšå¼€å§‹åˆ†æé¡¹ç›®æºç ï¼Œæœ‰ä¸€ä¸ªæ•´ä½“çš„å¤§å±€è§‚å¾ˆé‡è¦ã€‚\næœ¬æ¥ä¸‹èŠ‚æƒ³å…ˆå†™SpringBootçš„å¯åŠ¨æµç¨‹åˆ†æçš„ï¼Œä½†ç”±äºä¹‹å‰ç ”ç©¶è¿‡å¯åŠ¨æµç¨‹ï¼Œæ‰€ä»¥å°±æŠŠå¯åŠ¨æµç¨‹åˆ†ææ”¾åç‚¹å†™äº†ã€‚ä¸‹ä¸€èŠ‚å…ˆå¯¹SpringBootçš„æ–°ç‰¹æ€§â€“è‡ªåŠ¨é…ç½®çš„æºç æ’¸èµ·æ¥ï¼Œå› æ­¤ä¸‹ä¸€èŠ‚è®©æˆ‘ä»¬å…ˆæ¥æ­å¼€SpringBootè‡ªåŠ¨é…ç½®èƒŒåç¥ç§˜çš„é¢çº±å§ï¼Œå˜¿å˜¿ğŸ¤­ã€‚\nå‚è€ƒï¼š\n\nhttps://github.com/spring-projects/spring-boot/tree/v2.1.0.RELEASE\nhttps://docs.spring.io/spring-boot/docs/1.5.2.RELEASE/reference/htmlsingle/#cli\n\n3 SpringBootè‡ªåŠ¨é…ç½®çš„æ¡ä»¶æ³¨è§£åŸç†\n1 å‰è¨€ä¸Šä¸€ç¯‡ï¼Œæˆ‘ä»¬åˆ†æäº† SpringBoot æºç ç»“æ„åŠå„ä¸ªæ¨¡å— pom ä¹‹é—´çš„å…³ç³»åï¼Œé‚£ä¹ˆæ­¤ç¯‡å¼€å§‹å°±å¼€å§‹è§£å¼€ SpringBoot æ–°ç‰¹æ€§ä¹‹ä¸€â€“è‡ªåŠ¨é…ç½®çš„ç¥ç§˜é¢çº±äº†ã€‚å› ä¸º SpringBoot è‡ªåŠ¨é…ç½®åŸç†æ˜¯åŸºäºå…¶å¤§é‡çš„æ¡ä»¶æ³¨è§£ConditionalOnXXXï¼Œå› æ­¤ï¼Œæœ¬èŠ‚æˆ‘ä»¬å…ˆæ¥æ’¸ä¸‹ Spring çš„æ¡ä»¶æ³¨è§£çš„ç›¸å…³æºç ã€‚\n\n2 SpringBoot çš„æ´¾ç”Ÿæ¡ä»¶æ³¨è§£æˆ‘ä»¬éƒ½çŸ¥é“ï¼ŒSpringBoot è‡ªåŠ¨é…ç½®æ˜¯éœ€è¦æ»¡è¶³ç›¸åº”çš„æ¡ä»¶æ‰ä¼šè‡ªåŠ¨é…ç½®,å› æ­¤ SpringBoot çš„è‡ªåŠ¨é…ç½®å¤§é‡åº”ç”¨äº†æ¡ä»¶æ³¨è§£ConditionalOnXXXã€‚å¦‚ä¸‹å›¾ï¼š\n\né‚£ä¹ˆä¸Šå›¾çš„æ¡ä»¶æ³¨è§£å¦‚ä½•ä½¿ç”¨å‘¢ï¼Ÿ\n\n\n\n\n\n\n\n\n\nä¸¾ä¸ªæ —å­ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹å¦‚ä½•ä½¿ç”¨@ConditionalOnClasså’Œ@ConditionalOnPropertyè¿™ä¸¤ä¸ªæ³¨è§£ï¼Œå…ˆçœ‹ä¸‹å›¾ä»£ç ï¼š\n HelloWorldEnableAutoConfigurationè¿™ä¸ªè‡ªåŠ¨é…ç½®ç±»åº”ç”¨äº†@ConditionalOnClasså’ŒConditionalOnPropertyä¸¤ä¸ªæ¡ä»¶æ³¨è§£ï¼Œé‚£ä¹ˆåªæœ‰åœ¨æ»¡è¶³:classpathä¸­å­˜åœ¨HelloWorldComponent.classå’Œé…ç½®äº†hello.world.nameå’Œhello.world.ageå±æ€§è¿™ä¸¤ä¸ªæ¡ä»¶çš„æƒ…å†µä¸‹æ‰ä¼šåˆ›å»ºHelloWorldComponentè¿™ä¸ªbeanã€‚\nå…¶å® SpringBoot çš„@ConditionalOnXXXç­‰æ¡ä»¶æ³¨è§£éƒ½æ˜¯æ´¾ç”Ÿæ³¨è§£ï¼Œé‚£ä¹ˆä»€ä¹ˆæ˜¯æ´¾ç”Ÿæ³¨è§£å‘¢ï¼Ÿ å°±æ‹¿ä¸Šé¢çš„æ —å­æ¥è¯´ï¼Œä»¥@ConditionalOnClass(HelloWorldComponent.class)ä¸ºä¾‹ï¼Œæˆ‘ä»¬æ‰“å¼€ConditionalOnClassæ³¨è§£æºç ï¼Œå¦‚ä¸‹ï¼š\n@Target(&#123;\n    ElementType.TYPE,\n    ElementType.METHOD\n&#125;)\n@Retention(RetentionPolicy.RUNTIME)\n@Documented\n@Conditional(OnClassCondition.class)\npublic @interface ConditionalOnClass &#123;\n    Class &lt;&lt; ? > [] value() default &#123;&#125;;\n    String[] name() default &#123;&#125;;\n&#125;\n\nå¯ä»¥çœ‹åˆ°@ConditionalOnClassæ³¨è§£ä¸Šé¢åˆæ ‡æ³¨äº†@Conditional(OnClassCondition.class)æ³¨è§£ï¼Œå› æ­¤@ConditionalOnClassæ˜¯@Conditionalçš„æ´¾ç”Ÿæ³¨è§£ï¼Œ@Conditional(OnClassCondition.class)å’Œ@ConditionalOnClassæ³¨è§£æ˜¯ç­‰ä»·çš„ï¼Œå³è¿™ä¸¤ä¸ªæ³¨è§£æ ‡æ³¨åœ¨æŸä¸ªé…ç½®ç±»ä¸Šçš„æ•ˆæœæ˜¯ç­‰ä»·çš„ã€‚\nè€Œ SpringBoot çš„è‡ªåŠ¨é…ç½®åŸç†æ­£æ˜¯å»ºç«‹åœ¨è¿™äº›å¤§é‡çš„æ´¾ç”Ÿæ¡ä»¶æ³¨è§£@ConditionalOnXXXä¹‹ä¸Šï¼Œè€Œè¿™äº›æ¡ä»¶æ³¨è§£çš„åŸç†è·Ÿ Spring çš„ Condition æ¥å£æœ‰å…³ã€‚å› æ­¤æˆ‘ä»¬å…ˆæ¥ç ”ç©¶ä¸‹ Condition æ¥å£çš„ç›¸å…³æºç ã€‚\n\n3 Condition æ¥å£\n3.1 Condition æ¥å£æºç åˆ†æåˆ†æ Condition æ¥å£æºç å‰å…ˆçœ‹ä¸‹å¦‚ä½•è‡ªå®šä¹‰ConditionalOnXXXæ³¨è§£,ä¸¾ä¸ªæ —å­ï¼Œæ¯”å¦‚è‡ªå®šä¹‰ä¸€ä¸ª@ConditionalOnLinuxæ³¨è§£ï¼Œè¯¥æ³¨è§£åªæœ‰åœ¨å…¶å±æ€§environmentæ˜¯â€linuxâ€æ‰ä¼šåˆ›å»ºç›¸å…³çš„ beanã€‚å®šä¹‰äº†ä»¥ä¸‹ä»£ç ï¼š\n/**\n * å®ç°spring çš„Conditionæ¥å£ï¼Œå¹¶ä¸”é‡å†™matches()æ–¹æ³•ï¼Œå¦‚æœ@ConditionalOnLinuxçš„æ³¨è§£å±æ€§environmentæ˜¯linuxå°±è¿”å›true\n *\n */\npublic class LinuxCondition implements Condition &#123;\n\n    @Override\n    public boolean matches(ConditionContext context, AnnotatedTypeMetadata metadata) &#123;\n        // è·å¾—æ³¨è§£@ConditionalOnLinuxçš„æ‰€æœ‰å±æ€§\n        List &lt; AnnotationAttributes > allAnnotationAttributes = annotationAttributesFromMultiValueMap(\n            metadata.getAllAnnotationAttributes(\n                ConditionalOnLinux.class.getName()));\n        for (AnnotationAttributes annotationAttributes: allAnnotationAttributes) &#123;\n            // è·å¾—æ³¨è§£@ConditionalOnLinuxçš„environmentå±æ€§\n            String environment = annotationAttributes.getString(\"environment\");\n            // è‹¥environmentç­‰äºlinuxï¼Œåˆ™è¿”å›true\n            if (\"linux\".equals(environment)) &#123;\n                return true;\n            &#125;\n        &#125;\n        return false;\n    &#125;\n&#125;\n\n@Target(&#123;\n    ElementType.TYPE,\n    ElementType.METHOD\n&#125;)\n@Retention(RetentionPolicy.RUNTIME)\n@Documented\n@Conditional(LinuxCondition.class)\npublic @interface ConditionalOnLinux &#123;\n    // æ ‡æ³¨æ˜¯å“ªä¸ªç¯å¢ƒ\n    String environment() default \"\";\n\n&#125;\n\n@Configuration\npublic class ConditionConfig &#123;\n    // åªæœ‰`@ConditionalOnLinux`çš„æ³¨è§£å±æ€§`environment`æ˜¯\"linux\"æ—¶æ‰ä¼šåˆ›å»ºbean\n    @Bean\n    @ConditionalOnLinux(environment = \"linux\")\n    public Environment linuxEnvironment() &#123;\n        return new LinuxEnvironment();\n    &#125;\n&#125;\n\nä¸Šé¢çš„ä»£ç æˆ‘ä»¬æ‹ä¸€ä¸‹ï¼š\n\nLinuxConditionå®ç°äº†Conditionæ¥å£å¹¶å®ç°äº†matchesæ–¹æ³•ï¼Œè€Œmatchesæ–¹æ³•åˆ™åˆ¤æ–­@ConditionalOnLinuxçš„æ³¨è§£å±æ€§environmentæ˜¯å¦â€linuxâ€ï¼Œæ˜¯åˆ™è¿”å› trueï¼Œå¦åˆ™ falseã€‚\nç„¶åæˆ‘ä»¬å†å®šä¹‰äº†ä¸€ä¸ªæ³¨è§£@ConditionalOnLinuxï¼Œè¿™ä¸ªæ³¨è§£æ˜¯@Conditionalçš„æ´¾ç”Ÿæ³¨è§£ï¼Œä¸@Conditional(LinuxCondition.class)ç­‰ä»·ï¼Œæ³¨æ„@ConditionalOnLinuxæ³¨è§£å®šä¹‰äº†ä¸€ä¸ªå±æ€§environmentã€‚è€Œæˆ‘ä»¬æœ€ç»ˆå¯ä»¥åˆ©ç”¨LinuxConditionçš„matchesæ–¹æ³•ä¸­çš„å‚æ•°AnnotatedTypeMetadataæ¥è·å–@ConditionalOnLinuxçš„æ³¨è§£å±æ€§environmentçš„å€¼ï¼Œä»è€Œç”¨æ¥åˆ¤æ–­å€¼æ˜¯å¦ä¸º linuxâ€ã€‚\næœ€åæˆ‘ä»¬åˆå®šä¹‰äº†ä¸€ä¸ªé…ç½®ç±»ConditionConfigï¼Œåœ¨linuxEnvironmentæ–¹æ³•ä¸Šæ ‡æ³¨äº†@ConditionalOnLinux(environment = &quot;linux&quot;)ã€‚å› æ­¤ï¼Œè¿™é‡Œåªæœ‰ LinuxConditionçš„matchesæ–¹æ³•è¿”å› true æ‰ä¼šåˆ›å»ºbeanã€‚\n\nå­¦ä¼šäº†å¦‚ä½•è‡ªå®šä¹‰@ConditionalOnXXXæ³¨è§£åï¼Œæˆ‘ä»¬ç°åœ¨å†æ¥çœ‹ä¸‹Conditionæ¥å£çš„æºç ï¼š\n@FunctionalInterface\npublic interface Condition &#123;\n\tboolean matches(ConditionContext context, AnnotatedTypeMetadata metadata);\n&#125;\n\nCondition æ¥å£ä¸»è¦æœ‰ä¸€ä¸ªmatchesæ–¹æ³•ï¼Œè¯¥æ–¹æ³•å†³å®šäº†æ˜¯å¦è¦æ³¨å†Œç›¸åº”çš„beanå¯¹è±¡ã€‚å…¶ä¸­matchesæ–¹æ³•ä¸­æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œå‚æ•°ç±»å‹åˆ†åˆ«æ˜¯ConditionContextå’ŒAnnotatedTypeMetadataï¼Œè¿™ä¸¤ä¸ªå‚æ•°éå¸¸é‡è¦ã€‚å®ƒä»¬åˆ†åˆ«ç”¨æ¥è·å–ä¸€äº›ç¯å¢ƒä¿¡æ¯å’Œæ³¨è§£å…ƒæ•°æ®ä»è€Œç”¨åœ¨matchesæ–¹æ³•ä¸­åˆ¤æ–­æ˜¯å¦ç¬¦åˆæ¡ä»¶ã€‚\n\n\n\n\n\n\n\n\n\nConditionContextï¼Œé¡¾åæ€ä¹‰ï¼Œä¸»è¦æ˜¯è·ŸConditionçš„ä¸Šä¸‹æ–‡æœ‰å…³ï¼Œä¸»è¦ç”¨æ¥è·å–Registry,BeanFactory,Environment,ResourceLoaderå’ŒClassLoaderç­‰ã€‚é‚£ä¹ˆè·å–è¿™äº›ç”¨æ¥å¹²ä»€ä¹ˆå‘¢ï¼Ÿä¸¾ä¸ªæ —å­ï¼Œæ¯”å¦‚OnResourceConditionéœ€è¦é ConditionContextæ¥è·å–ResourceLoaderæ¥åŠ è½½æŒ‡å®šèµ„æºï¼ŒOnClassConditionéœ€è¦é ConditionContextæ¥è·å–ClassLoaderæ¥åŠ è½½æŒ‡å®šç±»ç­‰ï¼Œä¸‹é¢çœ‹ä¸‹å…¶æºç ï¼š\npublic interface ConditionContext &#123;\n    BeanDefinitionRegistry getRegistry();\n    @Nullable\n    ConfigurableListableBeanFactory getBeanFactory();\n    Environment getEnvironment();\n    ResourceLoader getResourceLoader();\n    @Nullable\n    ClassLoader getClassLoader();\n&#125;\n\n\n\n\n\n\n\n\n\n\nAnnotatedTypeMetadataï¼Œè¿™ä¸ªè·Ÿæ³¨è§£å…ƒæ•°æ®æœ‰å…³ï¼Œåˆ©ç”¨AnnotatedTypeMetadataå¯ä»¥æ‹¿åˆ°æŸä¸ªæ³¨è§£çš„ä¸€äº›å…ƒæ•°æ®ï¼Œè€Œè¿™äº›å…ƒæ•°æ®å°±åŒ…å«äº†æŸä¸ªæ³¨è§£é‡Œé¢çš„å±æ€§ï¼Œæ¯”å¦‚å‰é¢çš„æ —å­ï¼Œåˆ©ç”¨AnnotatedTypeMetadataå¯ä»¥æ‹¿åˆ°@ConditionalOnLinuxçš„æ³¨è§£å±æ€§environmentçš„å€¼ã€‚ä¸‹é¢çœ‹ä¸‹å…¶æºç ï¼š\npublic interface AnnotatedTypeMetadata &#123;\n\tboolean isAnnotated(String annotationName);\n\tMap&lt;String, Object> getAnnotationAttributes(String annotationName);\n\tMap&lt;String, Object> getAnnotationAttributes(String annotationName, boolean classValuesAsString);\n\tMultiValueMap&lt;String, Object> getAllAnnotationAttributes(String annotationName);\n\tMultiValueMap&lt;String, Object> getAllAnnotationAttributes(String annotationName, boolean classValuesAsString);\n&#125;\n\nå›åˆ°åˆšæ‰çš„æ —å­ï¼Œæˆ‘ä»¬çŸ¥é“@ConditionalOnLinuxæ³¨è§£çœŸæ­£èµ·ä½œç”¨çš„æ˜¯Conditionæ¥å£çš„å…·ä½“å®ç°ç±»LinuxConditionçš„matchesæ–¹æ³•ï¼Œé‚£ä¹ˆè¿™ä¸ªmatchesæ–¹æ³•æ˜¯åœ¨ä½•æ—¶è¢«è°ƒç”¨çš„å‘¢ï¼Ÿ\né€šè¿‡ idea è°ƒè¯•çœ‹è°ƒç”¨çš„æ ˆå¸§ï¼Œå¦‚ä¸‹å›¾ï¼š\n\nå‘ç°æ˜¯åœ¨ConditionEvaluatorçš„shouldSkipæ–¹æ³•ä¸­è°ƒç”¨äº†LinuxConditionçš„matchesæ–¹æ³•ï¼Œè‡ªç„¶æˆ‘ä»¬å†å»çœ‹çœ‹ConditionEvaluatorçš„shouldSkipçš„æ–¹æ³•æ‰§è¡Œäº†ä»€ä¹ˆé€»è¾‘ã€‚\n// è¿™ä¸ªæ–¹æ³•ä¸»è¦æ˜¯å¦‚æœæ˜¯è§£æé˜¶æ®µåˆ™è·³è¿‡ï¼Œå¦‚æœæ˜¯æ³¨å†Œé˜¶æ®µåˆ™ä¸è·³è¿‡\npublic boolean shouldSkip(@Nullable AnnotatedTypeMetadata metadata, @Nullable ConfigurationPhase phase) &#123;\n\t// è‹¥æ²¡æœ‰è¢«@Conditionalæˆ–å…¶æ´¾ç”Ÿæ³¨è§£æ‰€æ ‡æ³¨ï¼Œåˆ™ä¸ä¼šè·³è¿‡\n\tif (metadata == null || !metadata.isAnnotated(Conditional.class.getName())) &#123;\n\t\treturn false;\n\t&#125;\n\t// æ²¡æœ‰æŒ‡å®šphaseï¼Œæ³¨æ„phaseå¯ä»¥åˆ†ä¸ºPARSE_CONFIGURATIONæˆ–REGISTER_BEANç±»å‹\n\tif (phase == null) &#123;\n\t\t// è‹¥æ ‡æœ‰@Componentï¼Œ@Importï¼Œ@Beanæˆ–@Configurationç­‰æ³¨è§£çš„è¯ï¼Œåˆ™è¯´æ˜æ˜¯PARSE_CONFIGURATIONç±»å‹\n\t\tif (metadata instanceof AnnotationMetadata &amp;&amp;\n\t\t\t\tConfigurationClassUtils.isConfigurationCandidate((AnnotationMetadata) metadata)) &#123;\n\t\t\treturn shouldSkip(metadata, ConfigurationPhase.PARSE_CONFIGURATION);\n\t\t&#125;\n\t\t// å¦åˆ™æ˜¯REGISTER_BEANç±»å‹\n\t\treturn shouldSkip(metadata, ConfigurationPhase.REGISTER_BEAN);\n\t&#125;\n\n\tList&lt;Condition> conditions = new ArrayList&lt;>();\n\t// TODO è·å¾—æ‰€æœ‰æ ‡æœ‰@Conditionalæ³¨è§£æˆ–å…¶æ´¾ç”Ÿæ³¨è§£é‡Œé¢çš„Conditionæ¥å£å®ç°ç±»å¹¶å®ä¾‹åŒ–æˆå¯¹è±¡ã€‚\n\t// æ¯”å¦‚@Conditional(OnBeanCondition.class)åˆ™è·å¾—OnBeanCondition.classï¼ŒOnBeanCondition.classå¾€å¾€å®ç°äº†Conditionæ¥å£\n\tfor (String[] conditionClasses : getConditionClasses(metadata)) &#123;\n\t\t// å°†ç±»å®ä¾‹åŒ–æˆå¯¹è±¡\n\t\tfor (String conditionClass : conditionClasses) &#123;\n\t\t\tCondition condition = getCondition(conditionClass, this.context.getClassLoader());\n\t\t\tconditions.add(condition);\n\t\t&#125;\n\t&#125;\n\t// æ’åºï¼Œå³æŒ‰ç…§Conditionçš„ä¼˜å…ˆçº§è¿›è¡Œæ’åº\n\tAnnotationAwareOrderComparator.sort(conditions);\n\n\tfor (Condition condition : conditions) &#123;\n\t\tConfigurationPhase requiredPhase = null;\n\t\tif (condition instanceof ConfigurationCondition) &#123;\n\t\t\t// ä»conditionä¸­è·å¾—å¯¹beanæ˜¯è§£æè¿˜æ˜¯æ³¨å†Œ\n\t\t\trequiredPhase = ((ConfigurationCondition) condition).getConfigurationPhase();\n\t\t&#125;\n\t\t// è‹¥requiredPhaseä¸ºnullæˆ–è·å–çš„é˜¶æ®µç±»å‹æ­£æ˜¯å½“å‰é˜¶æ®µç±»å‹ä¸”ä¸ç¬¦åˆconditionçš„matchesæ¡ä»¶ï¼Œåˆ™è·³è¿‡\n\t\tif ((requiredPhase == null || requiredPhase == phase) &amp;&amp; !condition.matches(this.context, metadata)) &#123;\n\t\t\treturn true;\n\t\t&#125;\n\t&#125;\n\n\treturn false;\n&#125;\n\nshouldSkipè¿™ä¸ªæ–¹æ³•æ‰§è¡Œçš„é€»è¾‘ä¸»è¦æ˜¯å¦‚æœæ˜¯è§£æé˜¶æ®µåˆ™è·³è¿‡ï¼Œå¦‚æœæ˜¯æ³¨å†Œé˜¶æ®µåˆ™ä¸è·³è¿‡ï¼›å¦‚æœæ˜¯åœ¨æ³¨å†Œé˜¶æ®µå³REGISTER_BEANé˜¶æ®µçš„è¯ï¼Œæ­¤æ—¶ä¼šå¾—åˆ°æ‰€æœ‰çš„Conditionæ¥å£çš„å…·ä½“å®ç°ç±»å¹¶å®ä¾‹åŒ–è¿™äº›å®ç°ç±»ï¼Œç„¶åå†æ‰§è¡Œä¸‹é¢å…³é”®çš„ä»£ç è¿›è¡Œåˆ¤æ–­æ˜¯å¦éœ€è¦è·³è¿‡ã€‚\nif ((requiredPhase == null || requiredPhase == phase) &amp;&amp; !condition.matches(this.context, metadata)) &#123;\n    return true;\n&#125;\n\nä¸Šé¢ä»£ç æœ€é‡è¦çš„é€»è¾‘æ˜¯è°ƒç”¨äº†Conditionæ¥å£çš„å…·ä½“å®ç°ç±»çš„matchesæ–¹æ³•ï¼Œè‹¥matchesè¿”å›falseï¼Œåˆ™è·³è¿‡ï¼Œä¸è¿›è¡Œæ³¨å†Œbeançš„æ“ä½œï¼›è‹¥matchesè¿”å›trueï¼Œåˆ™ä¸è·³è¿‡ï¼Œè¿›è¡Œæ³¨å†Œbeançš„æ“ä½œï¼›\nå¥½äº†ï¼ŒConditionçš„æºç åˆ†æå°±åˆ°æ­¤ä¸ºæ­¢ï¼Œå†å¾€ä¸Šç¿»è°ƒç”¨æ–¹æ³•çš„è¯åº”è¯¥å°±æ˜¯ Spring åŠ è½½beanå®šä¹‰çš„ç›¸å…³æºç äº†ï¼Œä¸å±äºè¿™é‡Œçš„åˆ†æèŒƒå›´ã€‚\n\n3.2 Spring çš„å†…ç½® Condition æ¥å£å®ç°ç±»å‰é¢æˆ‘ä»¬å­¦ä¼šäº†å¦‚ä½•è‡ªå®šä¹‰æ¡ä»¶æ³¨è§£åŠConditionçš„æºç åˆ†æï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸ç¦å¥½å¥‡ï¼ŒSpring ç©¶ç«Ÿå†…ç½®äº†å“ªäº›Conditionæ¥å£çš„å®ç°ç±»å‘¢ï¼Ÿ\né‚£ä¹ˆçœ‹ä¸‹ Spring çš„Conditionæ¥å£çš„å…·ä½“å®ç°ç±»çš„ç±»å›¾ï¼š\n\nå‘ç° Spring å†…ç½®çš„Conditionæ¥å£çš„å…·ä½“å®ç°ç±»è™½ç„¶æœ‰å¤šä¸ªï¼Œä½†åªæœ‰ProfileConditionä¸æ˜¯æµ‹è¯•ç›¸å…³çš„ï¼Œå› æ­¤å¯ä»¥è¯´çœŸæ­£çš„å†…ç½®çš„Conditionæ¥å£çš„å…·ä½“å®ç°ç±»åªæœ‰ProfileConditionä¸€ä¸ªï¼Œéå¸¸éå¸¸å°‘,è¿™è·Ÿ SpringBoot çš„å¤§é‡æ´¾ç”Ÿæ¡ä»¶æ³¨è§£å½¢æˆäº†é²œæ˜çš„å¯¹æ¯”ã€‚ProfileConditionå¤§å®¶éƒ½çŸ¥é“ï¼Œæ˜¯è·Ÿç¯å¢ƒæœ‰å…³ï¼Œæ¯”å¦‚æˆ‘ä»¬å¹³æ—¶ä¸€èˆ¬æœ‰dev,testå’Œprodç¯å¢ƒï¼Œè€ŒProfileConditionå°±æ˜¯åˆ¤æ–­æˆ‘ä»¬é¡¹ç›®é…ç½®äº†å“ªä¸ªç¯å¢ƒçš„ã€‚ä¸‹é¢æ˜¯ProfileConditionçš„æºç ï¼Œå¾ˆç®€å•ï¼Œè¿™é‡Œå°±ä¸åˆ†æäº†ã€‚\nclass ProfileCondition implements Condition &#123;\n\t@Override\n\tpublic boolean matches(ConditionContext context, AnnotatedTypeMetadata metadata) &#123;\n\t\tMultiValueMap&lt;String, Object> attrs = metadata.getAllAnnotationAttributes(Profile.class.getName());\n\t\tif (attrs != null) &#123;\n\t\t\tfor (Object value : attrs.get(\"value\")) &#123;\n\t\t\t\tif (context.getEnvironment().acceptsProfiles(Profiles.of((String[]) value))) &#123;\n\t\t\t\t\treturn true;\n\t\t\t\t&#125;\n\t\t\t&#125;\n\t\t\treturn false;\n\t\t&#125;\n\t\treturn true;\n\t&#125;\n&#125;\n\n\n4 SpringBootCondition æºç è§£æå‰é¢çœ‹åˆ° Spring å¯¹Conditionçš„å†…ç½®æ³¨è§£å¯ä»¥è¯´åªæœ‰ProfileConditionä¸€ä¸ªï¼Œä½†æ˜¯æˆ‘ä»¬éƒ½çŸ¥é“ï¼ŒSpringBoot åˆ™å†…ç½®äº†å¤§é‡çš„æ¡ä»¶æ³¨è§£ConditionalOnXXXã€‚åœ¨åˆ†æå‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹SpringBootConditionçš„æ•´ä½“ç±»å›¾æ¥ä¸ªæ•´ä½“çš„ç†è§£ï¼Œå¦‚ä¸‹å›¾ï¼š\n\nå¯ä»¥çœ‹åˆ°SpringBootConditionä½œä¸º SpringBoot æ¡ä»¶æ³¨è§£çš„åŸºç±»ï¼Œå¤„äºæ•´ä¸ªç±»å›¾çš„ä¸­å¿ƒï¼Œå®ƒå®ç°äº†Conditionæ¥å£ï¼Œç„¶ååˆæœ‰å¾ˆå¤šå…·ä½“çš„å­ç±»OnXXXCondition,è¿™äº›OnXXXConditionå…¶å®å°±æ˜¯@ConditionalOnXXXçš„æ¡ä»¶ç±»ã€‚\næˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹SpringBootConditionè¿™ä¸ªçˆ¶ç±»æ˜¯ä¸»è¦åšäº†å“ªäº›äº‹æƒ…ï¼ŒæŠ½è±¡äº†å“ªäº›å…±æœ‰çš„é€»è¾‘ï¼Ÿ\nSpringBootConditonå®ç°äº†Conditionæ¥å£ï¼Œä½œä¸º SpringBoot ä¼—å¤šæ¡ä»¶æ³¨è§£OnXXXCondtionçš„çˆ¶ç±»ï¼Œå®ƒçš„ä½œç”¨ä¸»è¦å°±æ˜¯æ‰“å°ä¸€äº›æ¡ä»¶æ³¨è§£è¯„ä¼°æŠ¥å‘Šçš„æ—¥å¿—ï¼Œæ¯”å¦‚æ‰“å°å“ªäº›é…ç½®ç±»æ˜¯ç¬¦åˆæ¡ä»¶æ³¨è§£çš„ï¼Œå“ªäº›æ˜¯ä¸ç¬¦åˆçš„ã€‚æ‰“å°çš„æ—¥å¿—å½¢å¼å¦‚ä¸‹å›¾ï¼š\n\n å› ä¸ºSpringBootConditonå®ç°äº†Conditionæ¥å£ï¼Œä¹Ÿå®ç°äº†matchesæ–¹æ³•ï¼Œå› æ­¤è¯¥æ–¹æ³•åŒæ ·ä¹Ÿæ˜¯è¢«ConditionEvaluatorçš„shouldSkipæ–¹æ³•ä¸­è°ƒç”¨ï¼Œå› æ­¤æˆ‘ä»¬å°±ä»¥SpringBootConditonçš„matchesæ–¹æ³•ä¸ºå…¥å£å»è¿›è¡Œåˆ†æã€‚ç›´æ¥ä¸Šä»£ç ï¼š\n// SpringBootCondition.java\npublic final boolean matches(ConditionContext context,\n\t\t\tAnnotatedTypeMetadata metadata) &#123;\n\t\t// å¾—åˆ°metadataçš„ç±»åæˆ–æ–¹æ³•å\n\t\tString classOrMethodName = getClassOrMethodName(metadata);\n\t\ttry &#123;\n\t\t\t// åˆ¤æ–­æ¯ä¸ªé…ç½®ç±»çš„æ¯ä¸ªæ¡ä»¶æ³¨è§£@ConditionalOnXXXæ˜¯å¦æ»¡è¶³æ¡ä»¶ï¼Œç„¶åè®°å½•åˆ°ConditionOutcomeç»“æœä¸­\n\t\t\t// æ³¨æ„getMatchOutcomeæ˜¯ä¸€ä¸ªæŠ½è±¡æ¨¡æ¿æ–¹æ³•ï¼Œäº¤ç»™OnXXXConditionå­ç±»å»å®ç°\n\t\t\tConditionOutcome outcome = getMatchOutcome(context, metadata);\n\t\t\t// æ‰“å°conditionè¯„ä¼°çš„æ—¥å¿—ï¼Œå“ªäº›æ¡ä»¶æ³¨è§£@ConditionalOnXXXæ˜¯æ»¡è¶³æ¡ä»¶çš„ï¼Œå“ªäº›æ˜¯ä¸æ»¡è¶³æ¡ä»¶çš„ï¼Œè¿™äº›æ—¥å¿—éƒ½æ‰“å°å‡ºæ¥\n\t\t\tlogOutcome(classOrMethodName, outcome);\n\t\t\t// é™¤äº†æ‰“å°æ—¥å¿—å¤–ï¼Œè¿™äº›æ˜¯å¦åŒ¹é…çš„ä¿¡æ¯è¿˜è¦è®°å½•åˆ°ConditionEvaluationReportä¸­\n\t\t\trecordEvaluation(context, classOrMethodName, outcome);\n\t\t\t// æœ€åè¿”å›@ConditionalOnXXXæ˜¯å¦æ»¡è¶³æ¡ä»¶\n\t\t\treturn outcome.isMatch();\n\t\t&#125;\n\t\tcatch (NoClassDefFoundError ex) &#123;\n\t\t\tthrow new IllegalStateException(\n\t\t\t\t\t\"Could not evaluate condition on \" + classOrMethodName + \" due to \"\n\t\t\t\t\t\t\t+ ex.getMessage() + \" not \"\n\t\t\t\t\t\t\t+ \"found. Make sure your own configuration does not rely on \"\n\t\t\t\t\t\t\t+ \"that class. This can also happen if you are \"\n\t\t\t\t\t\t\t+ \"@ComponentScanning a springframework package (e.g. if you \"\n\t\t\t\t\t\t\t+ \"put a @ComponentScan in the default package by mistake)\",\n\t\t\t\t\tex);\n\t\t&#125;\n\t\tcatch (RuntimeException ex) &#123;\n\t\t\tthrow new IllegalStateException(\n\t\t\t\t\t\"Error processing condition on \" + getName(metadata), ex);\n\t\t&#125;\n\t&#125;\n\nä¸Šé¢ä»£ç çš„æ³¨é‡Šå·²ç»éå¸¸è¯¦ç»†ï¼Œæˆ‘ä»¬çŸ¥é“äº†SpringBootConditionæŠ½è±¡äº†æ‰€æœ‰å…¶å…·ä½“å®ç°ç±»OnXXXConditionçš„å…±æœ‰é€»è¾‘â€“conditionè¯„ä¼°ä¿¡æ¯æ‰“å°ï¼Œæœ€é‡è¦çš„æ˜¯å°è£…äº†ä¸€ä¸ªæ¨¡æ¿æ–¹æ³•getMatchOutcome(context, metadata)ï¼Œç•™ç»™å„ä¸ªOnXXXConditionå…·ä½“å­ç±»å»è¦†ç›–å®ç°å±äºè‡ªå·±çš„åˆ¤æ–­é€»è¾‘ï¼Œç„¶åå†è¿”å›ç›¸åº”çš„åŒ¹é…ç»“æœç»™SpringBootConditionç”¨äºæ—¥å¿—æ‰“å°ã€‚\nå› æ­¤æˆ‘ä»¬çŸ¥é“äº†SpringBootConditionå…¶å®å°±æ˜¯ç”¨æ¥æ‰“å°conditionè¯„ä¼°ä¿¡æ¯çš„ï¼Œå¯¹äºå…¶ä»–æèŠ‚æ–¹æ³•æˆ‘ä»¬ä¸å¿…è¿½ç©¶è¿‡æ·±ï¼Œå…å¾—ä¸¢äº†ä¸»çº¿ã€‚æˆ‘ä»¬ç°åœ¨çš„é‡ç‚¹æ˜¯æ”¾åœ¨äº¤ç»™OnXXXConditionå­ç±»å®ç°çš„æ¨¡æ¿æ–¹æ³•ä¸ŠgetMatchOutcome(context, metadata);ï¼Œå› ä¸ºè¿™ä¸ªæ–¹æ³•å°†ä¼šç”±å¾ˆå¤šOnXXXConditionè¦†ç›–é‡å†™åˆ¤æ–­é€»è¾‘ï¼Œè¿™é‡Œæ˜¯æˆ‘ä»¬æ¥ä¸‹æ¥åˆ†æçš„é‡ç‚¹ã€‚\nå› ä¸ºSpringBootConditionæœ‰ä¼—å¤šå…·ä½“å®ç°ç±»ï¼Œä¸‹é¢åªæŒ‘OnResourceConditionï¼ŒOnBeanConditionå’ŒOnWebApplicationConditionè¿›è¡Œè®²è§£ï¼Œè€ŒAutoConfigurationImportFilterè·Ÿè‡ªåŠ¨é…ç½®æœ‰å…³ï¼Œåˆ™ç•™åˆ°è‡ªåŠ¨é…ç½®æºç è§£æçš„æ—¶å€™å†è¿›è¡Œåˆ†æã€‚\n\n4.1 OnResourceCondition æºç åˆ†æç°åœ¨å…ˆæ¥çœ‹ä¸‹ä¸€ä¸ªé€»è¾‘åŠå…¶ç®€å•çš„æ³¨è§£æ¡ä»¶ç±»OnResourceConditionï¼ŒOnResourceConditionç»§æ‰¿äº†SpringBootConditionçˆ¶ç±»ï¼Œè¦†ç›–äº†å…¶getMatchOutcomeæ–¹æ³•ï¼Œç”¨äº@ConditionalOnResourceæ³¨è§£æŒ‡å®šçš„èµ„æºå­˜åœ¨ä¸å¦ã€‚OnResourceConditionçš„åˆ¤æ–­é€»è¾‘éå¸¸ç®€å•ï¼Œä¸»è¦æ‹¿åˆ°@ConditionalOnResourceæ³¨è§£æŒ‡å®šçš„èµ„æºè·¯å¾„åï¼Œç„¶åç”¨ResourceLoaderæ ¹æ®æŒ‡å®šè·¯å¾„å»åŠ è½½çœ‹èµ„æºå­˜ä¸å­˜åœ¨ã€‚ä¸‹é¢ç›´æ¥çœ‹ä»£ç :\nå…ˆæ¥çœ‹ä¸‹@ConditionalOnResourceçš„ä»£ç ï¼Œ\n@Target(&#123; ElementType.TYPE, ElementType.METHOD &#125;)\n@Retention(RetentionPolicy.RUNTIME)\n@Documented\n@Conditional(OnResourceCondition.class)\npublic @interface ConditionalOnResource &#123;\n\n\t/**\n\t * The resources that must be present.\n\t * @return the resource paths that must be present.\n\t */\n\tString[] resources() default &#123;&#125;;\n\n&#125;\n\nå†æ¥çœ‹OnResourceConditionçš„ä»£ç ï¼š\n@Order(Ordered.HIGHEST_PRECEDENCE + 20)\nclass OnResourceCondition extends SpringBootCondition &#123;\n\n\tprivate final ResourceLoader defaultResourceLoader = new DefaultResourceLoader();\n\n\t@Override\n\tpublic ConditionOutcome getMatchOutcome(ConditionContext context,\n\t\t\tAnnotatedTypeMetadata metadata) &#123;\n\t\t// è·å¾—@ConditionalOnResourceæ³¨è§£çš„å±æ€§å…ƒæ•°æ®\n\t\tMultiValueMap&lt;String, Object> attributes = metadata\n\t\t\t\t.getAllAnnotationAttributes(ConditionalOnResource.class.getName(), true);\n\t\t// è·å¾—èµ„æºåŠ è½½å™¨ï¼Œè‹¥ConditionContextä¸­æœ‰ResourceLoaderåˆ™ç”¨ConditionContextä¸­çš„ï¼Œæ²¡æœ‰åˆ™ç”¨é»˜è®¤çš„\n\t\tResourceLoader loader = (context.getResourceLoader() != null)\n\t\t\t\t? context.getResourceLoader() : this.defaultResourceLoader;\n\t\tList&lt;String> locations = new ArrayList&lt;>();\n\t\t// å°†@ConditionalOnResourceä¸­å®šä¹‰çš„resourceså±æ€§å€¼å–å‡ºæ¥è£…è¿›locationsé›†åˆ\n\t\tcollectValues(locations, attributes.get(\"resources\"));\n\t\tAssert.isTrue(!locations.isEmpty(),\n\t\t\t\t\"@ConditionalOnResource annotations must specify at \"\n\t\t\t\t\t\t+ \"least one resource location\");\n\t\t// missingé›†åˆæ˜¯è£…ä¸å­˜åœ¨æŒ‡å®šèµ„æºçš„èµ„æºè·¯å¾„çš„\n\t\tList&lt;String> missing = new ArrayList&lt;>();\n\t\t// éå†æ‰€æœ‰çš„èµ„æºè·¯å¾„ï¼Œè‹¥æŒ‡å®šçš„è·¯å¾„çš„èµ„æºä¸å­˜åœ¨åˆ™å°†å…¶èµ„æºè·¯å¾„å­˜è¿›missingé›†åˆä¸­\n\t\tfor (String location : locations) &#123;\n\t\t\t// è¿™é‡Œé’ˆå¯¹æœ‰äº›èµ„æºè·¯å¾„æ˜¯Placeholdersçš„æƒ…å†µï¼Œå³å¤„ç† $&#123;&#125;\n\t\t\tString resource = context.getEnvironment().resolvePlaceholders(location);\n\t\t\tif (!loader.getResource(resource).exists()) &#123;\n\t\t\t\tmissing.add(location);\n\t\t\t&#125;\n\t\t&#125;\n\t\t// å¦‚æœå­˜åœ¨æŸä¸ªèµ„æºä¸å­˜åœ¨ï¼Œé‚£ä¹ˆåˆ™æŠ¥é”™\n\t\tif (!missing.isEmpty()) &#123;\n\t\t\treturn ConditionOutcome.noMatch(ConditionMessage\n\t\t\t\t\t.forCondition(ConditionalOnResource.class)\n\t\t\t\t\t.didNotFind(\"resource\", \"resources\").items(Style.QUOTE, missing));\n\t\t&#125;\n\t\t// æ‰€æœ‰èµ„æºéƒ½å­˜åœ¨ï¼Œé‚£ä¹ˆåˆ™è¿”å›èƒ½æ‰¾åˆ°å°±æçš„èµ„æº\n\t\treturn ConditionOutcome\n\t\t\t\t.match(ConditionMessage.forCondition(ConditionalOnResource.class)\n\t\t\t\t\t\t.found(\"location\", \"locations\").items(locations));\n\t&#125;\n\n\t// å°†@ConditionalOnResourceä¸­å®šä¹‰çš„resourceså±æ€§å€¼å–å‡ºæ¥è£…è¿›locationsé›†åˆ\n\tprivate void collectValues(List&lt;String> names, List&lt;Object> values) &#123;\n\t\tfor (Object value : values) &#123;\n\t\t\tfor (Object item : (Object[]) value) &#123;\n\t\t\t\tnames.add((String) item);\n\t\t\t&#125;\n\t\t&#125;\n\t&#125;\n&#125;\n\nå¯ä»¥çœ‹åˆ°OnResourceConditionçš„getMatchOutcomeæ–¹æ³•éå¸¸ç®€å•ï¼Œè¿™é‡Œä¸å†è¯¦è¿°ã€‚\n\n4.2 OnBeanCondition æºç åˆ†æOnBeanConditionåŒæ ·ç»§æ‰¿äº†FilteringSpringBootConditionçˆ¶ç±»ï¼Œè¦†ç›–äº†çˆ¶ç±»FilteringSpringBootConditionçš„getOutcomesæ–¹æ³•ã€‚è€ŒFilteringSpringBootConditionåˆæ˜¯SpringBootConditionçš„å­ç±»ï¼ŒFilteringSpringBootConditionè·Ÿè‡ªåŠ¨é…ç½®ç±»è¿‡æ»¤æœ‰å…³ï¼Œè¿™é‡Œå…ˆä¸åˆ†æã€‚å€¼å¾—æ³¨æ„çš„æ˜¯**OnBeanCondition**åŒæ ·é‡å†™äº†**SpringBootCondition**çš„**getMatchOutcome**æ–¹æ³•ï¼Œç”¨æ¥åˆ¤æ–­ Spring å®¹å™¨ä¸­æ˜¯å¦å­˜åœ¨æŒ‡å®šæ¡ä»¶çš„beanã€‚åŒæ—¶æ˜¯OnBeanConditionæ˜¯@ConditionalOnBean,@ConditionalOnSingleCandidateå’ŒConditionalOnMissingBeançš„æ¡ä»¶ç±»ã€‚\nåŒæ ·ï¼Œå…ˆæ¥çœ‹OnBeanConditionå¤å†™çˆ¶ç±»SpringBootConditionçš„getMatchOutcomeæ–¹æ³•çš„ä»£ç ï¼š\n@Override\n\tpublic ConditionOutcome getMatchOutcome(ConditionContext context,\n\t\t\tAnnotatedTypeMetadata metadata) &#123;\n\t\tConditionMessage matchMessage = ConditionMessage.empty();\n\t\t// (1)ï¼Œé…ç½®ç±»ï¼ˆmetadataï¼‰æ ‡æ³¨@ConditionalOnBeanæ³¨è§£çš„æƒ…å†µ\n\t\tif (metadata.isAnnotated(ConditionalOnBean.class.getName())) &#123;\n\t\t\t// å°†@ConditionalOnBeanæ³¨è§£å±æ€§å°è£…è¿›BeanSearchSpecå¯¹è±¡ä¸­\n\t\t\t// æ³¨æ„BeanSearchSpecæ˜¯ä¸€ä¸ªé™æ€å†…éƒ¨ç±»ï¼Œç”¨æ¥å­˜å‚¨@ConditionalOnBeanå’Œ@ConditionalOnMissingBeanæ³¨è§£çš„å±æ€§å€¼\n\t\t\tBeanSearchSpec spec = new BeanSearchSpec(context, metadata,\n\t\t\t\t\tConditionalOnBean.class);\n\t\t\t// è°ƒç”¨getMatchingBeanså¾—åˆ°ç¬¦åˆæ¡ä»¶çš„bean\n\t\t\tMatchResult matchResult = getMatchingBeans(context, spec);\n\t\t\t// å¦‚æœä¸åŒ¹é…\n\t\t\tif (!matchResult.isAllMatched()) &#123;\n\t\t\t\tString reason = createOnBeanNoMatchReason(matchResult);\n\t\t\t\treturn ConditionOutcome.noMatch(ConditionMessage\n\t\t\t\t\t\t.forCondition(ConditionalOnBean.class, spec).because(reason));\n\t\t\t&#125;\n\t\t\t// å¦‚æœåŒ¹é…\n\t\t\tmatchMessage = matchMessage.andCondition(ConditionalOnBean.class, spec)\n\t\t\t\t\t.found(\"bean\", \"beans\")\n\t\t\t\t\t.items(Style.QUOTE, matchResult.getNamesOfAllMatches());\n\t\t&#125;\n\t\t// (2)ï¼Œé…ç½®ç±»ï¼ˆmetadataï¼‰æ ‡æ³¨@ConditionalOnSingleCandidateæ³¨è§£çš„æƒ…å†µ\n\t\tif (metadata.isAnnotated(ConditionalOnSingleCandidate.class.getName())) &#123;\n\t\t\tBeanSearchSpec spec = new SingleCandidateBeanSearchSpec(context, metadata,\n\t\t\t\t\tConditionalOnSingleCandidate.class);\n\t\t\tMatchResult matchResult = getMatchingBeans(context, spec);\n\t\t\tif (!matchResult.isAllMatched()) &#123;\n\t\t\t\treturn ConditionOutcome.noMatch(ConditionMessage\n\t\t\t\t\t\t.forCondition(ConditionalOnSingleCandidate.class, spec)\n\t\t\t\t\t\t.didNotFind(\"any beans\").atAll());\n\t\t\t&#125;\n\t\t\telse if (!hasSingleAutowireCandidate(context.getBeanFactory(),\n\t\t\t\t\tmatchResult.getNamesOfAllMatches(),\n\t\t\t\t\tspec.getStrategy() == SearchStrategy.ALL)) &#123;\n\t\t\t\treturn ConditionOutcome.noMatch(ConditionMessage\n\t\t\t\t\t\t.forCondition(ConditionalOnSingleCandidate.class, spec)\n\t\t\t\t\t\t.didNotFind(\"a primary bean from beans\")\n\t\t\t\t\t\t.items(Style.QUOTE, matchResult.getNamesOfAllMatches()));\n\t\t\t&#125;\n\t\t\tmatchMessage = matchMessage\n\t\t\t\t\t.andCondition(ConditionalOnSingleCandidate.class, spec)\n\t\t\t\t\t.found(\"a primary bean from beans\")\n\t\t\t\t\t.items(Style.QUOTE, matchResult.getNamesOfAllMatches());\n\t\t&#125;\n\t\t// (3)ï¼Œé…ç½®ç±»ï¼ˆmetadataï¼‰æ ‡æ³¨@ConditionalOnMissingBeanæ³¨è§£çš„æƒ…å†µ\n\t\tif (metadata.isAnnotated(ConditionalOnMissingBean.class.getName())) &#123;\n\t\t\tBeanSearchSpec spec = new BeanSearchSpec(context, metadata,\n\t\t\t\t\tConditionalOnMissingBean.class);\n\t\t\tMatchResult matchResult = getMatchingBeans(context, spec);\n\t\t\tif (matchResult.isAnyMatched()) &#123;\n\t\t\t\tString reason = createOnMissingBeanNoMatchReason(matchResult);\n\t\t\t\treturn ConditionOutcome.noMatch(ConditionMessage\n\t\t\t\t\t\t.forCondition(ConditionalOnMissingBean.class, spec)\n\t\t\t\t\t\t.because(reason));\n\t\t\t&#125;\n\t\t\tmatchMessage = matchMessage.andCondition(ConditionalOnMissingBean.class, spec)\n\t\t\t\t\t.didNotFind(\"any beans\").atAll();\n\t\t&#125;\n\t\t// æœ€ç»ˆè¿”å›matchMessage\n\t\treturn ConditionOutcome.match(matchMessage);\n\t&#125;\n\næˆ‘ä»¬å¯ä»¥çœ‹åˆ°OnBeanConditionç±»è¦†ç›–çš„getMatchOutcomeæ–¹æ³•åˆ†åˆ«å¤„ç†äº†æ ‡æ³¨@ConditionalOnBean,@ConditionalOnSingleCandidateå’Œ@ConditionalOnMissingBeanæ³¨è§£çš„æƒ…å†µï¼Œåˆ†åˆ«å¯¹åº”ä¸Šé¢ä»£ç æ³¨é‡Šçš„(1),(2)å’Œ(3)å¤„ã€‚\nç°åœ¨æˆ‘ä»¬åªçœ‹é’ˆå¯¹@ConditionalOnBeanæ³¨è§£çš„å¤„ç†é€»è¾‘ï¼Œä»ä¸Šé¢ä»£ç ä¸­å¯ä»¥çœ‹åˆ°è‹¥é…ç½®ç±»ï¼ˆmetadataï¼‰æ ‡æ³¨@ConditionalOnBeanæ³¨è§£çš„è¯ï¼Œä¸»è¦åšäº†ä»¥ä¸‹äº‹æƒ…ï¼š\n\nå°†è¯¥æ³¨è§£å±æ€§æå–å‡ºæ¥å°è£…è¿›BeanSearchSpecå¯¹è±¡ä¸­;\nç„¶åè°ƒç”¨getMatchingBeans(context, spec)æ–¹æ³•æ¥è·å–æ˜¯å¦æœ‰åŒ¹é…çš„beanï¼›\næœ€åè¿”å›beançš„åŒ¹é…æƒ…å†µï¼›\n\nå¯ä»¥çœ‹åˆ°æœ€é‡è¦çš„é€»è¾‘æ˜¯ç¬¬ 2 æ­¥ï¼Œé‚£ä¹ˆæˆ‘ä»¬å†æ¥çœ‹ä¸‹getMatchingBeansæ–¹æ³•ï¼Œç›´æ¥ä¸Šä»£ç ï¼š\nprotected final MatchResult getMatchingBeans(ConditionContext context,\n\t\t\tBeanSearchSpec beans) &#123;\n\t\t// è·å¾—Springå®¹å™¨çš„beanFactory\n\t\tConfigurableListableBeanFactory beanFactory = context.getBeanFactory();\n\t\t// åˆ¤æ–­beançš„æœç´¢ç­–ç•¥æ˜¯å¦æ˜¯SearchStrategy.ANCESTORSç­–ç•¥\n\t\tif (beans.getStrategy() == SearchStrategy.ANCESTORS) &#123;\n\t\t\tBeanFactory parent = beanFactory.getParentBeanFactory();\n\t\t\tAssert.isInstanceOf(ConfigurableListableBeanFactory.class, parent,\n\t\t\t\t\t\"Unable to use SearchStrategy.PARENTS\");\n\t\t\tbeanFactory = (ConfigurableListableBeanFactory) parent;\n\t\t&#125;\n\t\t// MatchResultç”¨æ¥å­˜å‚¨beançš„åŒ¹é…ç»“æœ\n\t\tMatchResult matchResult = new MatchResult();\n\t\t// å¦‚æœbeançš„æœç´¢ç­–ç•¥ä¸æ˜¯SearchStrategy.CURRENTçš„è¯ï¼Œåˆ™ç½®considerHierarchyä¸ºtrue\n\t\tboolean considerHierarchy = beans.getStrategy() != SearchStrategy.CURRENT;\n\t\t// è·å–TypeExtractorï¼ŒTypeExtractoræ˜¯ç”¨æ¥åˆ¤æ–­beançš„ç±»å‹çš„\n\t\tTypeExtractor typeExtractor = beans.getTypeExtractor(context.getClassLoader());\n\t\t// è·å–æ˜¯å¦æœ‰è¢«å¿½ç•¥beanç±»å‹ï¼Œè‹¥æœ‰çš„è¯å°†è¯¥beanç±»å‹çš„åç§°è£…è¿›beansIgnoredByTypeé›†åˆ\n\t\t// è¿™é‡Œä¸»è¦æ˜¯é’ˆå¯¹@ConditionalOnMissingBeançš„ignoredå±æ€§\n\t\tList&lt;String> beansIgnoredByType = getNamesOfBeansIgnoredByType(\n\t\t\t\tbeans.getIgnoredTypes(), typeExtractor, beanFactory, context,\n\t\t\t\tconsiderHierarchy);\n\t\t// éå†beançš„æ‰€æœ‰ç±»å‹\n\t\tfor (String type : beans.getTypes()) &#123;\n\t\t\t// è°ƒç”¨getBeanNamesForTypeæ–¹æ³•æ ¹æ®beanç±»å‹å¾—åˆ°æ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„beanç±»å‹ï¼Œå¹¶æ”¾åˆ°typeMatchesé›†åˆ\n\t\t\tCollection&lt;String> typeMatches = getBeanNamesForType(beanFactory, type,\n\t\t\t\t\ttypeExtractor, context.getClassLoader(), considerHierarchy);\n\t\t\t// ç§»é™¤æ‰Ignoredçš„ç±»å‹\n\t\t\ttypeMatches.removeAll(beansIgnoredByType);\n\t\t\t// è‹¥typeMatchesä¸ºç©ºï¼Œé‚£ä¹ˆåˆ™è¯´æ˜æ­£åœ¨éå†çš„è¿™ä¸ªtypeç±»å‹ä¸ç¬¦åˆåŒ¹é…æ¡ä»¶ï¼Œæ­¤æ—¶ç”¨matchResultè®°å½•ä¸€ä¸‹è¿™ä¸ªä¸ç¬¦åˆæ¡ä»¶çš„ç±»å‹\n\t\t\tif (typeMatches.isEmpty()) &#123;\n\t\t\t\tmatchResult.recordUnmatchedType(type);\n\t\t\t&#125;\n\t\t\t// è‹¥typeMatchesä¸ä¸ºç©ºï¼Œé‚£ä¹ˆåˆ™è¯´æ˜æ­£åœ¨éå†çš„è¿™ä¸ªtypeç±»å‹ç¬¦åˆåŒ¹é…æ¡ä»¶ï¼Œæ­¤æ—¶ç”¨matchResultè®°å½•ä¸€ä¸‹è¿™ä¸ªç¬¦åˆæ¡ä»¶çš„ç±»å‹\n\t\t\telse &#123;\n\t\t\t\tmatchResult.recordMatchedType(type, typeMatches);\n\t\t\t&#125;\n\t\t&#125;\n\t\t// è¿™é‡Œé’ˆå¯¹@ConditionalOnBeanç­‰æ³¨è§£çš„annotationå±æ€§çš„å¤„ç†\n\t\tfor (String annotation : beans.getAnnotations()) &#123;\n\t\t\tList&lt;String> annotationMatches = Arrays\n\t\t\t\t\t.asList(getBeanNamesForAnnotation(beanFactory, annotation,\n\t\t\t\t\t\t\tcontext.getClassLoader(), considerHierarchy));\n\t\t\tannotationMatches.removeAll(beansIgnoredByType);\n\t\t\tif (annotationMatches.isEmpty()) &#123;\n\t\t\t\tmatchResult.recordUnmatchedAnnotation(annotation);\n\t\t\t&#125;\n\t\t\telse &#123;\n\t\t\t\tmatchResult.recordMatchedAnnotation(annotation, annotationMatches);\n\t\t\t&#125;\n\t\t&#125;\n\t\t// è¿™é‡Œé’ˆå¯¹@ConditionalOnBeanç­‰æ³¨è§£çš„nameå±æ€§çš„å¤„ç†\n\t\tfor (String beanName : beans.getNames()) &#123;\n\t\t\t// beansIgnoredByTypeé›†åˆä¸åŒ…å«beanNameä¸”beanFactoryåŒ…å«è¿™ä¸ªbeanï¼Œåˆ™åŒ¹é…\n\t\t\tif (!beansIgnoredByType.contains(beanName)\n\t\t\t\t\t&amp;&amp; containsBean(beanFactory, beanName, considerHierarchy)) &#123;\n\t\t\t\tmatchResult.recordMatchedName(beanName);\n\t\t\t&#125;\n\t\t\t// å¦åˆ™ï¼Œä¸åŒ¹é…\n\t\t\telse &#123;\n\t\t\t\tmatchResult.recordUnmatchedName(beanName);\n\t\t\t&#125;\n\t\t&#125;\n\t\t// æœ€åè¿”å›åŒ¹é…ç»“æœ\n\t\treturn matchResult;\n\t&#125;\n\nä¸Šé¢çš„é€»è¾‘ä¸»è¦æ˜¯ä» spring å®¹å™¨ä¸­æœç´¢æœ‰æ— æŒ‡å®šæ¡ä»¶çš„beanï¼Œæœç´¢ Spring å®¹å™¨æœç´¢ bean çš„è¯æœ‰ä¸‰ç§æœç´¢ç­–ç•¥ï¼Œåˆ†åˆ«æ˜¯CURRENT,ANCESTORSå’ŒALLï¼Œåˆ†è¡¨è¡¨ç¤ºåªä»å½“å‰çš„contextä¸­æœç´¢beanï¼Œåªä»çˆ¶contextä¸­æœç´¢beanå’Œä»æ•´ä¸ªcontextä¸­æœç´¢beanï¼›å®šä¹‰äº†æœç´¢ç­–ç•¥åï¼Œç„¶åå†æ ¹æ®BeanSearchSpecå¯¹è±¡å°è£…çš„æ³¨è§£å±æ€§åˆ†åˆ«å–æŒ‡å®šçš„å®¹å™¨ä¸­æŸ¥æ‰¾æœ‰æ— ç¬¦åˆæ¡ä»¶çš„beanï¼Œç„¶åå†è¿›è¡Œä¸€äº›è¿‡æ»¤ã€‚æ¯”å¦‚@ConditionalOnMissingBeanæ³¨è§£æœ‰å®šä¹‰ignoredå±æ€§å€¼ï¼Œé‚£ä¹ˆä»å®¹å™¨ä¸­æœç´¢åˆ°æœ‰ç¬¦åˆæ¡ä»¶çš„beanæ—¶ï¼Œæ­¤æ—¶è¿˜è¦ç§»é™¤æ‰ignoredæŒ‡å®šçš„beanã€‚\nå¥½äº†ï¼Œä¸Šé¢å°±å·²ç»åˆ†æäº†OnBeanConditionè¿™ä¸ªæ¡ä»¶ç±»äº†ï¼Œæˆ‘ä»¬åšæŒä¸»çº¿ä¼˜å…ˆçš„åŸåˆ™ï¼Œå…·ä½“çš„ç»†èŠ‚ä»£ç ä¸ä¼šæ·±ç©¶ã€‚\n\n4.3 OnWebApplicationConditionOnWebApplicationConditionåŒæ ·ç»§æ‰¿äº†FilteringSpringBootConditionçˆ¶ç±»ï¼Œè¦†ç›–äº†çˆ¶ç±»FilteringSpringBootConditionçš„getOutcomesæ–¹æ³•ã€‚è€ŒFilteringSpringBootConditionåˆæ˜¯SpringBootConditionçš„å­ç±»ï¼ŒFilteringSpringBootConditionè·Ÿè‡ªåŠ¨é…ç½®ç±»è¿‡æ»¤æœ‰å…³ï¼Œè¿™é‡Œå…ˆä¸åˆ†æã€‚å€¼å¾—æ³¨æ„çš„æ˜¯**OnWebApplicationCondition**åŒæ ·é‡å†™äº†**SpringBootCondition**çš„**getMatchOutcome**æ–¹æ³•ï¼Œç”¨æ¥åˆ¤æ–­å½“å‰åº”ç”¨æ˜¯å¦ web åº”ç”¨ã€‚åŒæ—¶æ˜¯OnWebApplicationConditionæ˜¯@ConditionalOnWebApplicationçš„æ¡ä»¶ç±»ã€‚\nåŒæ ·ï¼Œå…ˆæ¥çœ‹OnWebApplicationConditioné‡å†™SpringBootConditionçš„getMatchOutcomeæ–¹æ³•ï¼š\npublic ConditionOutcome getMatchOutcome(ConditionContext context,\n\t\t\tAnnotatedTypeMetadata metadata) &#123;\n\t\t// é…ç½®ç±»æ˜¯å¦æ ‡æ³¨æœ‰@ConditionalOnWebApplicationæ³¨è§£\n\t\tboolean required = metadata\n\t\t\t\t.isAnnotated(ConditionalOnWebApplication.class.getName());\n\t\t// è°ƒç”¨isWebApplicationæ–¹æ³•è¿”å›åŒ¹é…ç»“æœ\n\t\tConditionOutcome outcome = isWebApplication(context, metadata, required);\n\t\t// è‹¥æœ‰æ ‡æ³¨@ConditionalOnWebApplicationä½†ä¸ç¬¦åˆæ¡ä»¶ï¼Œåˆ™è¿”å›ä¸åŒ¹é…\n\t\tif (required &amp;&amp; !outcome.isMatch()) &#123;\n\t\t\treturn ConditionOutcome.noMatch(outcome.getConditionMessage());\n\t\t&#125;\n\t\t// è‹¥æ²¡æœ‰æ ‡æ³¨@ConditionalOnWebApplicationä½†ç¬¦åˆæ¡ä»¶ï¼Œåˆ™è¿”å›ä¸åŒ¹é…\n\t\tif (!required &amp;&amp; outcome.isMatch()) &#123;\n\t\t\treturn ConditionOutcome.noMatch(outcome.getConditionMessage());\n\t\t&#125;\n\t\t// è¿™é‡Œè¿”å›åŒ¹é…çš„æƒ…å†µï¼ŒTODO ä¸è¿‡æœ‰ä¸ªç–‘é—®ï¼šå¦‚æœæ²¡æœ‰æ ‡æ³¨@ConditionalOnWebApplicationæ³¨è§£ï¼Œåˆä¸ç¬¦åˆæ¡ä»¶çš„è¯ï¼Œä¹Ÿä¼šæ‰§è¡Œåˆ°è¿™é‡Œï¼Œè¿”å›åŒ¹é…ï¼Ÿ\n\t\treturn ConditionOutcome.match(outcome.getConditionMessage());\n\t&#125;\n\nä¸Šé¢ä»£ç çš„é€»è¾‘å¾ˆç®€å•ï¼Œä¸»è¦æ˜¯è°ƒç”¨isWebApplicationæ–¹æ³•æ¥åˆ¤æ–­å½“å‰åº”ç”¨æ˜¯å¦æ˜¯ web åº”ç”¨ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸‹isWebApplicationæ–¹æ³•:\nprivate ConditionOutcome isWebApplication(ConditionContext context,\n\t\t\tAnnotatedTypeMetadata metadata, boolean required) &#123;\n\t\t// è°ƒç”¨deduceTypeæ–¹æ³•åˆ¤æ–­æ˜¯å“ªç§ç±»å‹ï¼Œå…¶ä¸­æœ‰SERVLETï¼ŒREACTIVEå’ŒANYç±»å‹ï¼Œå…¶ä¸­ANYè¡¨ç¤ºäº†SERVLETæˆ–REACTIVEç±»å‹\n\t\tswitch (deduceType(metadata)) &#123;\n\t\t// SERVLETç±»å‹\n\t\tcase SERVLET:\n\t\t\treturn isServletWebApplication(context);\n\t\t// REACTIVEç±»å‹\n\t\tcase REACTIVE:\n\t\t\treturn isReactiveWebApplication(context);\n\t\tdefault:\n\t\t\treturn isAnyWebApplication(context, required);\n\t\t&#125;\n\t&#125;\n\nåœ¨isWebApplicationæ–¹æ³•ä¸­ï¼Œé¦–å…ˆä»@ConditionalOnWebApplicationæ³¨è§£ä¸­è·å–å…¶å®šä¹‰äº†ä»€ä¹ˆç±»å‹ï¼Œç„¶åæ ¹æ®ä¸åŒçš„ç±»å‹è¿›å…¥ä¸åŒçš„åˆ¤æ–­é€»è¾‘ã€‚è¿™é‡Œæˆ‘ä»¬åªçœ‹ä¸‹SERVLETçš„æƒ…å†µåˆ¤æ–­å¤„ç†ï¼Œçœ‹ä»£ç ï¼š\nprivate ConditionOutcome isServletWebApplication(ConditionContext context) &#123;\n\t\tConditionMessage.Builder message = ConditionMessage.forCondition(\"\");\n\t\t// è‹¥classpathä¸­ä¸å­˜åœ¨org.springframework.web.context.support.GenericWebApplicationContext.classï¼Œåˆ™è¿”å›ä¸åŒ¹é…\n\t\tif (!ClassNameFilter.isPresent(SERVLET_WEB_APPLICATION_CLASS,\n\t\t\t\tcontext.getClassLoader())) &#123;\n\t\t\treturn ConditionOutcome.noMatch(\n\t\t\t\t\tmessage.didNotFind(\"servlet web application classes\").atAll());\n\t\t&#125;\n\t\t// è‹¥classpathä¸­å­˜åœ¨org.springframework.web.context.support.GenericWebApplicationContext.classï¼Œé‚£ä¹ˆåˆåˆ†ä¸ºä»¥ä¸‹å‡ ç§åŒ¹é…çš„æƒ…å†µ\n\t\t// session\n\t\tif (context.getBeanFactory() != null) &#123;\n\t\t\tString[] scopes = context.getBeanFactory().getRegisteredScopeNames();\n\t\t\tif (ObjectUtils.containsElement(scopes, \"session\")) &#123;\n\t\t\t\treturn ConditionOutcome.match(message.foundExactly(\"'session' scope\"));\n\t\t\t&#125;\n\t\t&#125;\n\t\t// ConfigurableWebEnvironment\n\t\tif (context.getEnvironment() instanceof ConfigurableWebEnvironment) &#123;\n\t\t\treturn ConditionOutcome\n\t\t\t\t\t.match(message.foundExactly(\"ConfigurableWebEnvironment\"));\n\t\t&#125;\n\t\t// WebApplicationContext\n\t\tif (context.getResourceLoader() instanceof WebApplicationContext) &#123;\n\t\t\treturn ConditionOutcome.match(message.foundExactly(\"WebApplicationContext\"));\n\t\t&#125;\n\t\t// è‹¥ä»¥ä¸Šä¸‰ç§éƒ½ä¸åŒ¹é…çš„è¯ï¼Œåˆ™è¯´æ˜ä¸æ˜¯ä¸€ä¸ªservlet web application\n\t\treturn ConditionOutcome.noMatch(message.because(\"not a servlet web application\"));\n\t&#125;\n\nå¯¹äºæ˜¯SERVLETçš„æƒ…å†µï¼Œé¦–å…ˆæ ¹æ®classpathä¸­æ˜¯å¦å­˜åœ¨org.springframework.web.context.support.GenericWebApplicationContext.classï¼Œå¦‚æœä¸å­˜åœ¨è¯¥ç±»ï¼Œåˆ™ç›´æ¥è¿”å›ä¸åŒ¹é…ï¼›è‹¥å­˜åœ¨çš„è¯é‚£ä¹ˆåˆåˆ†ä¸ºä»¥ä¸‹å‡ ç§åŒ¹é…çš„æƒ…å†µï¼š\n\nsession\nConfigurableWebEnvironment\nWebApplicationContext\n\nè‹¥ä¸Šé¢ä¸‰ç§æƒ…å†µéƒ½ä¸åŒ¹é…ï¼Œåˆ™è¯´æ˜ä¸æ˜¯ä¸€ä¸ª servlet web applicationã€‚\n\n4.4 å…¶ä»–ç”±äº springboot çš„OnXXXConditionç±»å®ç°å¤ªå¤šï¼Œä¸å¯èƒ½æ¯ä¸ªæ¡ä»¶ç±»éƒ½åˆ†æä¸€éï¼Œå› æ­¤ä¸Šé¢åªåˆ†æäº†OnResourceCondition,OnBeanConditionå’ŒonWebApplicationConditionçš„æºç ã€‚æˆ‘ä»¬åˆ†ææºç ä¸å¯èƒ½æŠŠæ‰€æœ‰ä»£ç éƒ½é€šè¯»ä¸€éçš„ï¼Œé˜…è¯»æºç çš„è¯ï¼Œåªè¦ç†è§£äº†æŸä¸ªæ¨¡å—çš„ç±»ä¹‹é—´çš„å…³ç³»åŠæŒ‘å‡ ä¸ªæœ‰ä»£è¡¨æ€§çš„ç±»åˆ†æä¸‹å°±è¡Œï¼Œä¸å¯èƒ½ä¸€ç½‘æ‰“å°½ã€‚\nè‹¥æœ‰æ—¶é—´çš„è¯ï¼Œæ¨èçœ‹ä¸‹å‡ ä¸ªæˆ‘ä»¬å¸¸ç”¨çš„æ¡ä»¶ç±»çš„æºç ï¼šOnPropertyCondition,OnClassConditionå’ŒOnExpressionConditionç­‰ã€‚\n\n5 å¦‚ä½•æ‰©å±• SpringBootConditionå‰æ–‡æˆ‘ä»¬çŸ¥é“äº†å¦‚ä½•æ‰©å±• Spring çš„Conditionæ¥å£ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¯¥å¦‚ä½•æ‰©å±• SpringBoot çš„SpringBootConditionç±»å‘¢ï¼Ÿ\næ¨èé˜…è¯»springboot ä¹‹ä½¿ç”¨ SpringBootConditionè·å¾—ç­”æ¡ˆ\n4 SpringBootæ˜¯å¦‚ä½•å®ç°è‡ªåŠ¨é…ç½®çš„ï¼Ÿ\n1 å‰è¨€æ¸©æ•…è€ŒçŸ¥æ–°ï¼Œæˆ‘ä»¬æ¥ç®€å•å›é¡¾ä¸€ä¸‹ä¸Šç¯‡çš„å†…å®¹ï¼Œä¸Šä¸€ç¯‡æˆ‘ä»¬åˆ†æäº† SpringBoot çš„æ¡ä»¶æ³¨è§£@ConditionalOnXxx çš„ç›¸å…³æºç ï¼Œç°æŒ‘é‡ç‚¹æ€»ç»“å¦‚ä¸‹ï¼š\n\nSpringBoot çš„æ‰€æœ‰@ConditionalOnXxxçš„æ¡ä»¶ç±»OnXxxConditionéƒ½æ˜¯ç»§æ‰¿äºSpringBootConditionåŸºç±»ï¼Œè€ŒSpringBootConditionåˆå®ç°äº†Conditionæ¥å£ã€‚\nSpringBootConditionåŸºç±»ä¸»è¦ç”¨æ¥æ‰“å°ä¸€äº›æ¡ä»¶æ³¨è§£è¯„ä¼°æŠ¥å‘Šçš„æ—¥å¿—,è¿™äº›æ¡ä»¶è¯„ä¼°ä¿¡æ¯å…¨éƒ¨æ¥æºäºå…¶å­ç±»æ³¨è§£æ¡ä»¶ç±»OnXxxConditionï¼Œå› æ­¤å…¶ä¹ŸæŠ½è±¡äº†ä¸€ä¸ªæ¨¡æ¿æ–¹æ³•getMatchOutcomeç•™ç»™å­ç±»å»å®ç°æ¥è¯„ä¼°å…¶æ¡ä»¶æ³¨è§£æ˜¯å¦ç¬¦åˆæ¡ä»¶ã€‚\nå‰ä¸€ç¯‡æˆ‘ä»¬ä¹Ÿè¿˜æœ‰ä¸€ä¸ªé‡è¦çš„çŸ¥è¯†ç‚¹è¿˜æ²¡åˆ†æï¼Œé‚£å°±æ˜¯è·Ÿè¿‡æ»¤è‡ªåŠ¨é…ç½®ç±»é€»è¾‘æœ‰å…³çš„AutoConfigurationImportFilteræ¥å£ï¼Œè¿™ç¯‡æ–‡ç« æˆ‘ä»¬æ¥å¡«ä¸€ä¸‹è¿™ä¸ªå‘ã€‚\n\nå‰é¢æˆ‘ä»¬åˆ†æäº†è·Ÿ SpringBoot çš„è‡ªåŠ¨é…ç½®æ¯æ¯ç›¸å…³å†…ç½®æ¡ä»¶æ³¨è§£@ConditionalOnXxxåï¼Œç°åœ¨æˆ‘ä»¬å°±å¼€å§‹æ¥æ’¸ SpringBoot è‡ªåŠ¨é…ç½®çš„ç›¸å…³æºç äº†ã€‚\n\n2 @SpringBootApplication æ³¨è§£åœ¨å¼€å§‹å‰ï¼Œæˆ‘ä»¬å…ˆæƒ³ä¸€ä¸‹ï¼ŒSpringBoot ä¸ºä½•ä¸€ä¸ªæ ‡æ³¨æœ‰@SpringBootApplicationæ³¨è§£çš„å¯åŠ¨ç±»é€šè¿‡æ‰§è¡Œä¸€ä¸ªç®€å•çš„runæ–¹æ³•å°±èƒ½å®ç° SpringBoot å¤§é‡Starterçš„è‡ªåŠ¨é…ç½®å‘¢ï¼Ÿ å…¶å® SpringBoot çš„è‡ªåŠ¨é…ç½®å°±è·Ÿ@SpringBootApplicationè¿™ä¸ªæ³¨è§£æœ‰å…³ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹å…¶è¿™ä¸ªæ³¨è§£çš„æºç ï¼š\n@Target(ElementType.TYPE)\n@Retention(RetentionPolicy.RUNTIME)\n@Documented\n@Inherited\n@SpringBootConfiguration\n@EnableAutoConfiguration\n@ComponentScan(excludeFilters = &#123;\n    @Filter(type = FilterType.CUSTOM, classes = TypeExcludeFilter.class),\n    @Filter(type = FilterType.CUSTOM, classes = AutoConfigurationExcludeFilter.class)\n&#125;)\npublic @interface SpringBootApplication &#123;\n    // ...çœç•¥éå…³é”®ä»£ç \n&#125;\n\n@SpringBootApplicationæ ‡æ³¨äº†å¾ˆå¤šæ³¨è§£ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å…¶ä¸­è·Ÿ SpringBoot è‡ªåŠ¨é…ç½®æœ‰å…³çš„æ³¨è§£å°±æœ‰ä¸€ä¸ªå³@EnableAutoConfigurationï¼Œå› æ­¤ï¼Œå¯ä»¥è‚¯å®šçš„æ˜¯ SpringBoot çš„è‡ªåŠ¨é…ç½®è‚¯å®šè·Ÿ@EnableAutoConfigurationæ¯æ¯ç›¸å…³(å…¶ä¸­@ComponentScanæ³¨è§£çš„excludeFilterså±æ€§ä¹Ÿæœ‰ä¸€ä¸ªç±»AutoConfigurationExcludeFilter,è¿™ä¸ªç±»è·Ÿè‡ªåŠ¨é…ç½®ä¹Ÿæœ‰ç‚¹å…³ç³»ï¼Œä½†ä¸æ˜¯æˆ‘ä»¬å…³æ³¨çš„é‡ç‚¹)ã€‚ ç°åœ¨æˆ‘ä»¬æ¥æ‰“å¼€@EnableAutoConfigurationæ³¨è§£çš„æºç ï¼š\n@Target(ElementType.TYPE)\n@Retention(RetentionPolicy.RUNTIME)\n@Documented\n@Inherited\n@AutoConfigurationPackage\n@Import(AutoConfigurationImportSelector.class)\npublic @interface EnableAutoConfiguration &#123;\n\tString ENABLED_OVERRIDE_PROPERTY = \"spring.boot.enableautoconfiguration\";\n\tClass&lt;?>[] exclude() default &#123;&#125;;\n\tString[] excludeName() default &#123;&#125;;\n&#125;\n\nçœ‹åˆ°@EnableAutoConfigurationæ³¨è§£åˆæ ‡æœ‰@AutoConfigurationPackageå’Œ@Import(AutoConfigurationImportSelector.class)ä¸¤ä¸ªæ³¨è§£ï¼Œé¡¾åæ€ä¹‰ï¼Œ@AutoConfigurationPackageæ³¨è§£è‚¯å®šè·Ÿè‡ªåŠ¨é…ç½®çš„åŒ…æœ‰å…³ï¼Œè€ŒAutoConfigurationImportSelectoråˆ™æ˜¯è·Ÿ SpringBoot çš„è‡ªåŠ¨é…ç½®é€‰æ‹©å¯¼å…¥æœ‰å…³ï¼ˆSpring ä¸­çš„ImportSelectoræ˜¯ç”¨æ¥å¯¼å…¥é…ç½®ç±»çš„ï¼Œé€šå¸¸æ˜¯åŸºäºæŸäº›æ¡ä»¶æ³¨è§£@ConditionalOnXxxxæ¥å†³å®šæ˜¯å¦å¯¼å…¥æŸä¸ªé…ç½®ç±»ï¼‰ã€‚\nå› æ­¤ï¼Œå¯ä»¥çœ‹å‡ºAutoConfigurationImportSelectorç±»æ˜¯æˆ‘ä»¬æœ¬ç¯‡çš„é‡ç‚¹ï¼Œå› ä¸º SpringBoot çš„è‡ªåŠ¨é…ç½®è‚¯å®šæœ‰ä¸€ä¸ªé…ç½®ç±»ï¼Œè€Œè¿™ä¸ªé…ç½®ç±»çš„å¯¼å…¥åˆ™éœ€è¦é AutoConfigurationImportSelectorè¿™ä¸ªå“¥ä»¬æ¥å®ç°ã€‚\næ¥ä¸‹æ¥æˆ‘ä»¬é‡ç‚¹æ¥çœ‹AutoConfigurationImportSelectorè¿™ä¸ªç±»ï¼Œå®Œäº†æˆ‘ä»¬å†ç®€å•åˆ†æä¸‹@AutoConfigurationPackageè¿™ä¸ªæ³¨è§£çš„é€»è¾‘ã€‚\n\n3 å¦‚ä½•å»æ‰¾ SpringBoot è‡ªåŠ¨é…ç½®å®ç°é€»è¾‘çš„å…¥å£æ–¹æ³•ï¼Ÿå¯ä»¥è‚¯å®šçš„æ˜¯ SpringBoot çš„è‡ªåŠ¨é…ç½®çš„é€»è¾‘è‚¯å®šä¸ AutoConfigurationImportSelector è¿™ä¸ªç±»æœ‰å…³ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¯¥å¦‚ä½•å»æ‰¾åˆ° SpringBoot è‡ªåŠ¨é…ç½®å®ç°é€»è¾‘çš„å…¥å£æ–¹æ³•å‘¢ï¼Ÿ\nåœ¨æ‰¾ SpringBoot è‡ªåŠ¨é…ç½®å®ç°é€»è¾‘çš„å…¥å£æ–¹æ³•å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹AutoConfigurationImportSelectorçš„ç›¸å…³ç±»å›¾ï¼Œå¥½æœ‰ä¸ªæ•´ä½“çš„ç†è§£ã€‚çœ‹ä¸‹å›¾ï¼š\n\nå¯ä»¥çœ‹åˆ°AutoConfigurationImportSelectoré‡ç‚¹æ˜¯å®ç°äº†DeferredImportSelectoræ¥å£å’Œå„ç§Awareæ¥å£ï¼Œç„¶åDeferredImportSelectoræ¥å£åˆç»§æ‰¿äº†ImportSelectoræ¥å£ã€‚\nè‡ªç„¶è€Œç„¶çš„ï¼Œæˆ‘ä»¬ä¼šå»å…³æ³¨AutoConfigurationImportSelectorå¤å†™DeferredImportSelectoræ¥å£çš„å®ç°æ–¹æ³•selectImportsæ–¹æ³•ï¼Œå› ä¸ºselectImportsæ–¹æ³•è·Ÿå¯¼å…¥è‡ªåŠ¨é…ç½®ç±»æœ‰å…³ï¼Œè€Œè¿™ä¸ªæ–¹æ³•å¾€å¾€æ˜¯ç¨‹åºæ‰§è¡Œçš„å…¥å£æ–¹æ³•ã€‚ç»è¿‡è°ƒè¯•å‘ç°selectImportsæ–¹æ³•å¾ˆå…·æœ‰è¿·æƒ‘æ€§ï¼ŒselectImportsæ–¹æ³•è·Ÿè‡ªåŠ¨é…ç½®ç›¸å…³çš„é€»è¾‘æœ‰ç‚¹å…³ç³»ï¼Œä½†å®è´¨å…³ç³»ä¸å¤§ã€‚\næ­¤æ—¶å‰§æƒ…çš„å‘å±•å¥½åƒä¸å¤ªç¬¦åˆå¸¸ç†ï¼Œæ­¤æ—¶æˆ‘ä»¬åˆè¯¥å¦‚ä½•æ¥æ‰¾åˆ°è‡ªåŠ¨é…ç½®é€»è¾‘æœ‰å…³çš„å…¥å£æ–¹æ³•å‘¢ï¼Ÿ\næœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯åœ¨AutoConfigurationImportSelectorç±»çš„æ¯ä¸ªæ–¹æ³•éƒ½æ‰“ä¸Šæ–­ç‚¹ï¼Œç„¶åè°ƒè¯•çœ‹å…ˆæ‰§è¡Œåˆ°å“ªä¸ªæ–¹æ³•ã€‚ä½†æ˜¯æˆ‘ä»¬å¯ä»¥ä¸è¿™ä¹ˆåšï¼Œæˆ‘ä»¬å›æƒ³ä¸‹ï¼Œè‡ªå®šä¹‰ä¸€ä¸ªStarterçš„æ—¶å€™æˆ‘ä»¬æ˜¯ä¸æ˜¯è¦åœ¨spring.factoriesé…ç½®æ–‡ä»¶ä¸­é…ç½®\nEnableAutoConfiguration=XxxAutoConfiguration\n\nå› æ­¤å¯ä»¥æ¨æ–­ï¼ŒSpringBoot çš„è‡ªåŠ¨é…ç½®åŸç†è‚¯å®šè·Ÿä»spring.factoriesé…ç½®æ–‡ä»¶ä¸­åŠ è½½è‡ªåŠ¨é…ç½®ç±»æœ‰å…³ï¼Œäºæ˜¯ç»“åˆAutoConfigurationImportSelectorçš„æ–¹æ³•æ³¨é‡Šï¼Œæˆ‘ä»¬æ‰¾åˆ°äº†getAutoConfigurationEntryæ–¹æ³•ã€‚äºæ˜¯æˆ‘ä»¬åœ¨è¿™ä¸ªæ–¹æ³•é‡Œé¢æ‰“ä¸Šä¸€ä¸ªæ–­ç‚¹ï¼Œæ­¤æ—¶é€šè¿‡è°ƒç”¨æ ˆå¸§æ¥çœ‹ä¸‹æ›´ä¸Šå±‚çš„å…¥å£æ–¹æ³•åœ¨å“ªé‡Œï¼Œç„¶åæˆ‘ä»¬å†ä»è·Ÿè‡ªåŠ¨é…ç½®ç›¸å…³çš„æ›´ä¸Šå±‚çš„å…¥å£æ–¹æ³•å¼€å§‹åˆ†æã€‚\n\né€šè¿‡å›¾ 1 æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè·Ÿè‡ªåŠ¨é…ç½®é€»è¾‘ç›¸å…³çš„å…¥å£æ–¹æ³•åœ¨DeferredImportSelectorGroupingç±»çš„getImportsæ–¹æ³•å¤„ï¼Œå› æ­¤æˆ‘ä»¬å°±ä»DeferredImportSelectorGroupingç±»çš„getImportsæ–¹æ³•æ¥å¼€å§‹åˆ†æ SpringBoot çš„è‡ªåŠ¨é…ç½®æºç å¥½äº†ã€‚\n\n4 åˆ†æ SpringBoot è‡ªåŠ¨é…ç½®åŸç†æ—¢ç„¶æ‰¾åˆ°ConfigurationClassParser.getImports()æ–¹æ³•æ˜¯è‡ªåŠ¨é…ç½®ç›¸å…³çš„å…¥å£æ–¹æ³•ï¼Œé‚£ä¹ˆä¸‹é¢æˆ‘ä»¬å°±æ¥çœŸæ­£åˆ†æ SpringBoot è‡ªåŠ¨é…ç½®çš„æºç äº†ã€‚\nå…ˆçœ‹ä¸€ä¸‹getImportsæ–¹æ³•ä»£ç ï¼š\n// ConfigurationClassParser.java\npublic Iterable&lt;Group.Entry> getImports() &#123;\n    // éå†DeferredImportSelectorHolderå¯¹è±¡é›†åˆdeferredImportsï¼ŒdeferredImportsé›†åˆè£…äº†å„ç§ImportSelectorï¼Œå½“ç„¶è¿™é‡Œè£…çš„æ˜¯AutoConfigurationImportSelector\n    for (DeferredImportSelectorHolder deferredImport : this.deferredImports) &#123;\n    \t// ã€1ã€‘ï¼Œåˆ©ç”¨AutoConfigurationGroupçš„processæ–¹æ³•æ¥å¤„ç†è‡ªåŠ¨é…ç½®çš„ç›¸å…³é€»è¾‘ï¼Œå†³å®šå¯¼å…¥å“ªäº›é…ç½®ç±»ï¼ˆè¿™ä¸ªæ˜¯æˆ‘ä»¬åˆ†æçš„é‡ç‚¹ï¼Œè‡ªåŠ¨é…ç½®çš„é€»è¾‘å…¨åœ¨è¿™äº†ï¼‰\n    \tthis.group.process(deferredImport.getConfigurationClass().getMetadata(),\n    \t\t\tdeferredImport.getImportSelector());\n    &#125;\n    // ã€2ã€‘ï¼Œç»è¿‡ä¸Šé¢çš„å¤„ç†åï¼Œç„¶åå†è¿›è¡Œé€‰æ‹©å¯¼å…¥å“ªäº›é…ç½®ç±»\n    return this.group.selectImports();\n&#125;\n\næ ‡ã€1ã€‘å¤„çš„çš„ä»£ç æ˜¯æˆ‘ä»¬åˆ†æçš„é‡ä¸­ä¹‹é‡ï¼Œè‡ªåŠ¨é…ç½®çš„ç›¸å…³çš„ç»å¤§éƒ¨åˆ†é€»è¾‘å…¨åœ¨è¿™é‡Œäº†ï¼Œå°†åœ¨ 4.1 åˆ†æè‡ªåŠ¨é…ç½®çš„ä¸»è¦é€»è¾‘æ·±å…¥åˆ†æã€‚é‚£ä¹ˆthis.group.process(deferredImport.getConfigurationClass().getMetadata(), deferredImport.getImportSelector())ï¼›ä¸»è¦åšçš„äº‹æƒ…å°±æ˜¯åœ¨this.groupå³AutoConfigurationGroupå¯¹è±¡çš„processæ–¹æ³•ä¸­ï¼Œä¼ å…¥çš„AutoConfigurationImportSelectorå¯¹è±¡æ¥é€‰æ‹©ä¸€äº›ç¬¦åˆæ¡ä»¶çš„è‡ªåŠ¨é…ç½®ç±»ï¼Œè¿‡æ»¤æ‰ä¸€äº›ä¸ç¬¦åˆæ¡ä»¶çš„è‡ªåŠ¨é…ç½®ç±»ï¼Œå°±æ˜¯è¿™ä¹ˆä¸ªäº‹æƒ…ï¼Œæ— ä»–ã€‚\næ³¨ï¼š\n\nAutoConfigurationGroupï¼šæ˜¯AutoConfigurationImportSelectorçš„å†…éƒ¨ç±»ï¼Œä¸»è¦ç”¨æ¥å¤„ç†è‡ªåŠ¨é…ç½®ç›¸å…³çš„é€»è¾‘ï¼Œæ‹¥æœ‰processå’ŒselectImportsæ–¹æ³•ï¼Œç„¶åæ‹¥æœ‰entrieså’ŒautoConfigurationEntriesé›†åˆå±æ€§ï¼Œè¿™ä¸¤ä¸ªé›†åˆåˆ†åˆ«å­˜å‚¨è¢«å¤„ç†åçš„ç¬¦åˆæ¡ä»¶çš„è‡ªåŠ¨é…ç½®ç±»ï¼Œæˆ‘ä»¬çŸ¥é“è¿™äº›å°±è¶³å¤Ÿäº†ï¼›\nAutoConfigurationImportSelectorï¼šæ‰¿æ‹…è‡ªåŠ¨é…ç½®çš„ç»å¤§éƒ¨åˆ†é€»è¾‘ï¼Œè´Ÿè´£é€‰æ‹©ä¸€äº›ç¬¦åˆæ¡ä»¶çš„è‡ªåŠ¨é…ç½®ç±»ï¼›\nmetadata:æ ‡æ³¨åœ¨ SpringBoot å¯åŠ¨ç±»ä¸Šçš„@SpringBootApplicationæ³¨è§£å…ƒæ•°æ®\n\næ ‡ã€2ã€‘çš„this.group.selectImportsçš„æ–¹æ³•ä¸»è¦æ˜¯é’ˆå¯¹å‰é¢çš„processæ–¹æ³•å¤„ç†åçš„è‡ªåŠ¨é…ç½®ç±»å†è¿›ä¸€æ­¥æœ‰é€‰æ‹©çš„é€‰æ‹©å¯¼å…¥ï¼Œå°†åœ¨ 4.2 æœ‰é€‰æ‹©çš„å¯¼å…¥è‡ªåŠ¨é…ç½®ç±»è¿™å°èŠ‚æ·±å…¥åˆ†æã€‚\n\n4.1 åˆ†æè‡ªåŠ¨é…ç½®çš„ä¸»è¦é€»è¾‘è¿™é‡Œç»§ç»­æ·±ç©¶å‰é¢ 4 åˆ†æ SpringBoot è‡ªåŠ¨é…ç½®åŸç†è¿™èŠ‚æ ‡ã€1ã€‘å¤„çš„ this.group.processæ–¹æ³•æ˜¯å¦‚ä½•å¤„ç†è‡ªåŠ¨é…ç½®ç›¸å…³é€»è¾‘çš„ã€‚\n// AutoConfigurationImportSelector$AutoConfigurationGroup.java\n\n// è¿™é‡Œç”¨æ¥å¤„ç†è‡ªåŠ¨é…ç½®ç±»ï¼Œæ¯”å¦‚è¿‡æ»¤æ‰ä¸ç¬¦åˆåŒ¹é…æ¡ä»¶çš„è‡ªåŠ¨é…ç½®ç±»\npublic void process(AnnotationMetadata annotationMetadata,\n\t\tDeferredImportSelector deferredImportSelector) &#123;\n\tAssert.state(\n\t\t\tdeferredImportSelector instanceof AutoConfigurationImportSelector,\n\t\t\t() -> String.format(\"Only %s implementations are supported, got %s\",\n\t\t\t\t\tAutoConfigurationImportSelector.class.getSimpleName(),\n\t\t\t\t\tdeferredImportSelector.getClass().getName()));\n\t// ã€1ã€‘,è°ƒç”¨getAutoConfigurationEntryæ–¹æ³•å¾—åˆ°è‡ªåŠ¨é…ç½®ç±»æ”¾å…¥autoConfigurationEntryå¯¹è±¡ä¸­\n\tAutoConfigurationEntry autoConfigurationEntry = ((AutoConfigurationImportSelector) deferredImportSelector)\n\t\t\t.getAutoConfigurationEntry(getAutoConfigurationMetadata(),\n\t\t\t\t\tannotationMetadata);\n\t// ã€2ã€‘ï¼Œåˆå°†å°è£…äº†è‡ªåŠ¨é…ç½®ç±»çš„autoConfigurationEntryå¯¹è±¡è£…è¿›autoConfigurationEntriesé›†åˆ\n\tthis.autoConfigurationEntries.add(autoConfigurationEntry);\n\t// ã€3ã€‘ï¼Œéå†åˆšè·å–çš„è‡ªåŠ¨é…ç½®ç±»\n\tfor (String importClassName : autoConfigurationEntry.getConfigurations()) &#123;\n\t\t// è¿™é‡Œç¬¦åˆæ¡ä»¶çš„è‡ªåŠ¨é…ç½®ç±»ä½œä¸ºkeyï¼ŒannotationMetadataä½œä¸ºå€¼æ”¾è¿›entriesé›†åˆ\n\t\tthis.entries.putIfAbsent(importClassName, annotationMetadata);\n\t&#125;\n&#125;\n\nä¸Šé¢ä»£ç ä¸­æˆ‘ä»¬å†æ¥çœ‹æ ‡ã€1ã€‘çš„æ–¹æ³•getAutoConfigurationEntryï¼Œè¿™ä¸ªæ–¹æ³•ä¸»è¦æ˜¯ç”¨æ¥è·å–è‡ªåŠ¨é…ç½®ç±»æœ‰å…³ï¼Œæ‰¿æ‹…äº†è‡ªåŠ¨é…ç½®çš„ä¸»è¦é€»è¾‘ã€‚ç›´æ¥ä¸Šä»£ç ï¼š\n// AutoConfigurationImportSelector.java\n\n// è·å–ç¬¦åˆæ¡ä»¶çš„è‡ªåŠ¨é…ç½®ç±»ï¼Œé¿å…åŠ è½½ä¸å¿…è¦çš„è‡ªåŠ¨é…ç½®ç±»ä»è€Œé€ æˆå†…å­˜æµªè´¹\nprotected AutoConfigurationEntry getAutoConfigurationEntry(\n\t\tAutoConfigurationMetadata autoConfigurationMetadata,\n\t\tAnnotationMetadata annotationMetadata) &#123;\n\t// è·å–æ˜¯å¦æœ‰é…ç½®spring.boot.enableautoconfigurationå±æ€§ï¼Œé»˜è®¤è¿”å›true\n\tif (!isEnabled(annotationMetadata)) &#123;\n\t\treturn EMPTY_ENTRY;\n\t&#125;\n\t// è·å¾—@Congigurationæ ‡æ³¨çš„Configurationç±»å³è¢«å®¡è§†introspectedClassçš„æ³¨è§£æ•°æ®ï¼Œ\n\t// æ¯”å¦‚ï¼š@SpringBootApplication(exclude = FreeMarkerAutoConfiguration.class)\n\t// å°†ä¼šè·å–åˆ°exclude = FreeMarkerAutoConfiguration.classå’ŒexcludeName=\"\"çš„æ³¨è§£æ•°æ®\n\tAnnotationAttributes attributes = getAttributes(annotationMetadata);\n\t// ã€1ã€‘å¾—åˆ°spring.factoriesæ–‡ä»¶é…ç½®çš„æ‰€æœ‰è‡ªåŠ¨é…ç½®ç±»\n\tList&lt;String> configurations = getCandidateConfigurations(annotationMetadata,\n\t\t\tattributes);\n\t// åˆ©ç”¨LinkedHashSetç§»é™¤é‡å¤çš„é…ç½®ç±»\n\tconfigurations = removeDuplicates(configurations);\n\t// å¾—åˆ°è¦æ’é™¤çš„è‡ªåŠ¨é…ç½®ç±»ï¼Œæ¯”å¦‚æ³¨è§£å±æ€§excludeçš„é…ç½®ç±»\n\t// æ¯”å¦‚ï¼š@SpringBootApplication(exclude = FreeMarkerAutoConfiguration.class)\n\t// å°†ä¼šè·å–åˆ°exclude = FreeMarkerAutoConfiguration.classçš„æ³¨è§£æ•°æ®\n\tSet&lt;String> exclusions = getExclusions(annotationMetadata, attributes);\n\t// æ£€æŸ¥è¦è¢«æ’é™¤çš„é…ç½®ç±»ï¼Œå› ä¸ºæœ‰äº›ä¸æ˜¯è‡ªåŠ¨é…ç½®ç±»ï¼Œæ•…è¦æŠ›å‡ºå¼‚å¸¸\n\tcheckExcludedClasses(configurations, exclusions);\n\t// ã€2ã€‘å°†è¦æ’é™¤çš„é…ç½®ç±»ç§»é™¤\n\tconfigurations.removeAll(exclusions);\n\t// ã€3ã€‘å› ä¸ºä»spring.factoriesæ–‡ä»¶è·å–çš„è‡ªåŠ¨é…ç½®ç±»å¤ªå¤šï¼Œå¦‚æœæœ‰äº›ä¸å¿…è¦çš„è‡ªåŠ¨é…ç½®ç±»éƒ½åŠ è½½è¿›å†…å­˜ï¼Œä¼šé€ æˆå†…å­˜æµªè´¹ï¼Œå› æ­¤è¿™é‡Œéœ€è¦è¿›è¡Œè¿‡æ»¤\n\t// æ³¨æ„è¿™é‡Œä¼šè°ƒç”¨AutoConfigurationImportFilterçš„matchæ–¹æ³•æ¥åˆ¤æ–­æ˜¯å¦ç¬¦åˆ@ConditionalOnBean,@ConditionalOnClassæˆ–@ConditionalOnWebApplicationï¼Œåé¢ä¼šé‡ç‚¹åˆ†æä¸€ä¸‹\n\tconfigurations = filter(configurations, autoConfigurationMetadata);\n\t// ã€4ã€‘è·å–äº†ç¬¦åˆæ¡ä»¶çš„è‡ªåŠ¨é…ç½®ç±»åï¼Œæ­¤æ—¶è§¦å‘AutoConfigurationImportEventäº‹ä»¶ï¼Œ\n\t// ç›®çš„æ˜¯å‘Šè¯‰ConditionEvaluationReportæ¡ä»¶è¯„ä¼°æŠ¥å‘Šå™¨å¯¹è±¡æ¥è®°å½•ç¬¦åˆæ¡ä»¶çš„è‡ªåŠ¨é…ç½®ç±»\n\t// è¯¥äº‹ä»¶ä»€ä¹ˆæ—¶å€™ä¼šè¢«è§¦å‘ï¼Ÿ--> åœ¨åˆ·æ–°å®¹å™¨æ—¶è°ƒç”¨invokeBeanFactoryPostProcessorsåç½®å¤„ç†å™¨æ—¶è§¦å‘\n\tfireAutoConfigurationImportEvents(configurations, exclusions);\n\t// ã€5ã€‘å°†ç¬¦åˆæ¡ä»¶å’Œè¦æ’é™¤çš„è‡ªåŠ¨é…ç½®ç±»å°è£…è¿›AutoConfigurationEntryå¯¹è±¡ï¼Œå¹¶è¿”å›\n\treturn new AutoConfigurationEntry(configurations, exclusions);\n&#125;\n\nAutoConfigurationEntryæ–¹æ³•ä¸»è¦åšçš„äº‹æƒ…å°±æ˜¯è·å–ç¬¦åˆæ¡ä»¶çš„è‡ªåŠ¨é…ç½®ç±»ï¼Œé¿å…åŠ è½½ä¸å¿…è¦çš„è‡ªåŠ¨é…ç½®ç±»ä»è€Œé€ æˆå†…å­˜æµªè´¹ã€‚æˆ‘ä»¬ä¸‹é¢æ€»ç»“ä¸‹AutoConfigurationEntryæ–¹æ³•ä¸»è¦åšçš„äº‹æƒ…ï¼š\nã€1ã€‘ä»spring.factoriesé…ç½®æ–‡ä»¶ä¸­åŠ è½½EnableAutoConfigurationè‡ªåŠ¨é…ç½®ç±»ï¼ˆæ³¨æ„æ­¤æ—¶æ˜¯ä»ç¼“å­˜ä¸­æ‹¿åˆ°çš„å“ˆï¼‰,è·å–çš„è‡ªåŠ¨é…ç½®ç±»å¦‚å›¾ 3 æ‰€ç¤ºã€‚è¿™é‡Œæˆ‘ä»¬çŸ¥é“è¯¥æ–¹æ³•åšäº†ä»€ä¹ˆäº‹æƒ…å°±è¡Œäº†ï¼Œåé¢è¿˜ä¼šæœ‰ä¸€ç¯‡æ–‡ç« è¯¦è¿°spring.factoriesçš„åŸç†ï¼›\nã€2ã€‘è‹¥@EnableAutoConfigurationç­‰æ³¨è§£æ ‡æœ‰è¦excludeçš„è‡ªåŠ¨é…ç½®ç±»ï¼Œé‚£ä¹ˆå†å°†è¿™ä¸ªè‡ªåŠ¨é…ç½®ç±»æ’é™¤æ‰ï¼›\nã€3ã€‘æ’é™¤æ‰è¦excludeçš„è‡ªåŠ¨é…ç½®ç±»åï¼Œç„¶åå†è°ƒç”¨filteræ–¹æ³•è¿›è¡Œè¿›ä¸€æ­¥çš„è¿‡æ»¤ï¼Œå†æ¬¡æ’é™¤ä¸€äº›ä¸ç¬¦åˆæ¡ä»¶çš„è‡ªåŠ¨é…ç½®ç±»ï¼›è¿™ä¸ªåœ¨ç¨åä¼šè¯¦ç»†åˆ†æã€‚\nã€4ã€‘ç»è¿‡é‡é‡è¿‡æ»¤åï¼Œæ­¤æ—¶å†è§¦å‘AutoConfigurationImportEventäº‹ä»¶ï¼Œå‘Šè¯‰ConditionEvaluationReportæ¡ä»¶è¯„ä¼°æŠ¥å‘Šå™¨å¯¹è±¡æ¥è®°å½•ç¬¦åˆæ¡ä»¶çš„è‡ªåŠ¨é…ç½®ç±»ï¼›ï¼ˆè¿™ä¸ªåœ¨ 6 AutoConfigurationImportListener è¿™å°èŠ‚è¯¦ç»†åˆ†æã€‚ï¼‰\nã€5ã€‘ æœ€åå†å°†ç¬¦åˆæ¡ä»¶çš„è‡ªåŠ¨é…ç½®ç±»è¿”å›ã€‚\n\næ€»ç»“äº†AutoConfigurationEntryæ–¹æ³•ä¸»è¦çš„é€»è¾‘åï¼Œæˆ‘ä»¬å†æ¥ç»†çœ‹ä¸€ä¸‹AutoConfigurationImportSelectorçš„filteræ–¹æ³•ï¼š\n// AutoConfigurationImportSelector.java\n\nprivate List&lt;String> filter(List&lt;String> configurations,\n\t\t\tAutoConfigurationMetadata autoConfigurationMetadata) &#123;\n\tlong startTime = System.nanoTime();\n\t// å°†ä»spring.factoriesä¸­è·å–çš„è‡ªåŠ¨é…ç½®ç±»è½¬å‡ºå­—ç¬¦ä¸²æ•°ç»„\n\tString[] candidates = StringUtils.toStringArray(configurations);\n\t// å®šä¹‰skipæ•°ç»„ï¼Œæ˜¯å¦éœ€è¦è·³è¿‡ã€‚æ³¨æ„skipæ•°ç»„ä¸candidatesæ•°ç»„é¡ºåºä¸€ä¸€å¯¹åº”\n\tboolean[] skip = new boolean[candidates.length];\n\tboolean skipped = false;\n\t// getAutoConfigurationImportFiltersæ–¹æ³•ï¼šæ‹¿åˆ°OnBeanConditionï¼ŒOnClassConditionå’ŒOnWebApplicationCondition\n\t// ç„¶åéå†è¿™ä¸‰ä¸ªæ¡ä»¶ç±»å»è¿‡æ»¤ä»spring.factoriesåŠ è½½çš„å¤§é‡é…ç½®ç±»\n\tfor (AutoConfigurationImportFilter filter : getAutoConfigurationImportFilters()) &#123;\n\t\t// è°ƒç”¨å„ç§awareæ–¹æ³•ï¼Œå°†beanClassLoader,beanFactoryç­‰æ³¨å…¥åˆ°filterå¯¹è±¡ä¸­ï¼Œ\n\t\t// è¿™é‡Œçš„filterå¯¹è±¡å³OnBeanConditionï¼ŒOnClassConditionæˆ–OnWebApplicationCondition\n\t\tinvokeAwareMethods(filter);\n\t\t// åˆ¤æ–­å„ç§filteræ¥åˆ¤æ–­æ¯ä¸ªcandidateï¼ˆè¿™é‡Œå®è´¨è¦é€šè¿‡candidate(è‡ªåŠ¨é…ç½®ç±»)æ‹¿åˆ°å…¶æ ‡æ³¨çš„\n\t\t// @ConditionalOnClass,@ConditionalOnBeanå’Œ@ConditionalOnWebApplicationé‡Œé¢çš„æ³¨è§£å€¼ï¼‰æ˜¯å¦åŒ¹é…ï¼Œ\n\t\t// æ³¨æ„candidatesæ•°ç»„ä¸matchæ•°ç»„ä¸€ä¸€å¯¹åº”\n\t\t/**********************ã€ä¸»çº¿ï¼Œé‡ç‚¹å…³æ³¨ã€‘********************************/\n\t\tboolean[] match = filter.match(candidates, autoConfigurationMetadata);\n\t\t// éå†matchæ•°ç»„ï¼Œæ³¨æ„matché¡ºåºè·Ÿcandidatesçš„è‡ªåŠ¨é…ç½®ç±»ä¸€ä¸€å¯¹åº”\n\t\tfor (int i = 0; i &lt; match.length; i++) &#123;\n\t\t\t// è‹¥æœ‰ä¸åŒ¹é…çš„è¯\n\t\t\tif (!match[i]) &#123;\n\t\t\t\t// ä¸åŒ¹é…çš„å°†è®°å½•åœ¨skipæ•°ç»„ï¼Œæ ‡å¿—skip[i]ä¸ºtrueï¼Œä¹Ÿä¸candidatesæ•°ç»„ä¸€ä¸€å¯¹åº”\n\t\t\t\tskip[i] = true;\n\t\t\t\t// å› ä¸ºä¸åŒ¹é…ï¼Œå°†ç›¸åº”çš„è‡ªåŠ¨é…ç½®ç±»ç½®ç©º\n\t\t\t\tcandidates[i] = null;\n\t\t\t\t// æ ‡æ³¨skippedä¸ºtrue\n\t\t\t\tskipped = true;\n\t\t\t&#125;\n\t\t&#125;\n\t&#125;\n\t// è¿™é‡Œè¡¨ç¤ºè‹¥æ‰€æœ‰è‡ªåŠ¨é…ç½®ç±»ç»è¿‡OnBeanConditionï¼ŒOnClassConditionå’ŒOnWebApplicationConditionè¿‡æ»¤åï¼Œå…¨éƒ¨éƒ½åŒ¹é…çš„è¯ï¼Œåˆ™å…¨éƒ¨åŸæ ·è¿”å›\n\tif (!skipped) &#123;\n\t\treturn configurations;\n\t&#125;\n\t// å»ºç«‹resulté›†åˆæ¥è£…åŒ¹é…çš„è‡ªåŠ¨é…ç½®ç±»\n\tList&lt;String> result = new ArrayList&lt;>(candidates.length);\n\tfor (int i = 0; i &lt; candidates.length; i++) &#123;\n\t\t// è‹¥skip[i]ä¸ºfalseï¼Œåˆ™è¯´æ˜æ˜¯ç¬¦åˆæ¡ä»¶çš„è‡ªåŠ¨é…ç½®ç±»ï¼Œæ­¤æ—¶æ·»åŠ åˆ°resulté›†åˆä¸­\n\t\tif (!skip[i]) &#123;\n\t\t\tresult.add(candidates[i]);\n\t\t&#125;\n\t&#125;\n\t// æ‰“å°æ—¥å¿—\n\tif (logger.isTraceEnabled()) &#123;\n\t\tint numberFiltered = configurations.size() - result.size();\n\t\tlogger.trace(\"Filtered \" + numberFiltered + \" auto configuration class in \"\n\t\t\t\t+ TimeUnit.NANOSECONDS.toMillis(System.nanoTime() - startTime)\n\t\t\t\t+ \" ms\");\n\t&#125;\n\t// æœ€åè¿”å›ç¬¦åˆæ¡ä»¶çš„è‡ªåŠ¨é…ç½®ç±»\n\treturn new ArrayList&lt;>(result);\n&#125;\n\nAutoConfigurationImportSelectorçš„filteræ–¹æ³•ä¸»è¦åšçš„äº‹æƒ…å°±æ˜¯è°ƒç”¨AutoConfigurationImportFilteræ¥å£çš„matchæ–¹æ³•æ¥åˆ¤æ–­æ¯ä¸€ä¸ªè‡ªåŠ¨é…ç½®ç±»ä¸Šçš„æ¡ä»¶æ³¨è§£ï¼ˆè‹¥æœ‰çš„è¯ï¼‰@ConditionalOnClass,@ConditionalOnBeanæˆ–@ConditionalOnWebApplicationæ˜¯å¦æ»¡è¶³æ¡ä»¶ï¼Œè‹¥æ»¡è¶³ï¼Œåˆ™è¿”å› trueï¼Œè¯´æ˜åŒ¹é…ï¼Œè‹¥ä¸æ»¡è¶³ï¼Œåˆ™è¿”å› false è¯´æ˜ä¸åŒ¹é…ã€‚\næˆ‘ä»¬ç°åœ¨çŸ¥é“AutoConfigurationImportSelectorçš„filteræ–¹æ³•ä¸»è¦åšäº†ä»€ä¹ˆäº‹æƒ…å°±è¡Œäº†ï¼Œç°åœ¨å…ˆä¸ç”¨ç ”ç©¶çš„è¿‡æ·±ï¼Œè‡³äºAutoConfigurationImportFilteræ¥å£çš„matchæ–¹æ³•å°†åœ¨ 5 AutoConfigurationImportFilter è¿™å°èŠ‚å†è¯¦ç»†åˆ†æï¼Œå¡«è¡¥ä¸€ä¸‹æˆ‘ä»¬å‰ä¸€ç¯‡æ¡ä»¶æ³¨è§£æºç åˆ†æä¸­ç•™ä¸‹çš„å‘ã€‚\næ³¨æ„ï¼šæˆ‘ä»¬åšæŒä¸»çº¿ä¼˜å…ˆçš„åŸåˆ™ï¼Œå…¶ä»–æèŠ‚ä»£ç è¿™é‡Œä¸æ·±ç©¶ï¼Œä»¥å…ä¸¢äº†ä¸»çº¿å“ˆã€‚\n\n4.2 æœ‰é€‰æ‹©çš„å¯¼å…¥è‡ªåŠ¨é…ç½®ç±»è¿™é‡Œç»§ç»­æ·±ç©¶å‰é¢ 4 åˆ†æ SpringBoot è‡ªåŠ¨é…ç½®åŸç†è¿™èŠ‚æ ‡ã€2ã€‘å¤„çš„ this.group.selectImportsæ–¹æ³•æ˜¯å¦‚ä½•è¿›ä¸€æ­¥æœ‰é€‰æ‹©çš„å¯¼å…¥è‡ªåŠ¨é…ç½®ç±»çš„ã€‚ç›´æ¥çœ‹ä»£ç ï¼š\n// AutoConfigurationImportSelector$AutoConfigurationGroup.java\n\npublic Iterable&lt;Entry> selectImports() &#123;\n\tif (this.autoConfigurationEntries.isEmpty()) &#123;\n\t\treturn Collections.emptyList();\n\t&#125;\n\t// è¿™é‡Œå¾—åˆ°æ‰€æœ‰è¦æ’é™¤çš„è‡ªåŠ¨é…ç½®ç±»çš„seté›†åˆ\n\tSet&lt;String> allExclusions = this.autoConfigurationEntries.stream()\n\t\t\t.map(AutoConfigurationEntry::getExclusions)\n\t\t\t.flatMap(Collection::stream).collect(Collectors.toSet());\n\t// è¿™é‡Œå¾—åˆ°ç»è¿‡æ»¤åæ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„è‡ªåŠ¨é…ç½®ç±»çš„seté›†åˆ\n\tSet&lt;String> processedConfigurations = this.autoConfigurationEntries.stream()\n\t\t\t.map(AutoConfigurationEntry::getConfigurations)\n\t\t\t.flatMap(Collection::stream)\n\t\t\t.collect(Collectors.toCollection(LinkedHashSet::new));\n\t// ç§»é™¤æ‰è¦æ’é™¤çš„è‡ªåŠ¨é…ç½®ç±»\n\tprocessedConfigurations.removeAll(allExclusions);\n\t// å¯¹æ ‡æ³¨æœ‰@Orderæ³¨è§£çš„è‡ªåŠ¨é…ç½®ç±»è¿›è¡Œæ’åºï¼Œ\n\treturn sortAutoConfigurations(processedConfigurations,\n\t\t\tgetAutoConfigurationMetadata())\n\t\t\t\t\t.stream()\n\t\t\t\t\t.map((importClassName) -> new Entry(\n\t\t\t\t\t\t\tthis.entries.get(importClassName), importClassName))\n\t\t\t\t\t.collect(Collectors.toList());\n&#125;\nå¤åˆ¶ä»£ç \n\nå¯ä»¥çœ‹åˆ°ï¼ŒselectImportsæ–¹æ³•ä¸»è¦æ˜¯é’ˆå¯¹ç»è¿‡æ’é™¤æ‰excludeçš„å’Œè¢«AutoConfigurationImportFilteræ¥å£è¿‡æ»¤åçš„æ»¡è¶³æ¡ä»¶çš„è‡ªåŠ¨é…ç½®ç±»å†è¿›ä¸€æ­¥æ’é™¤excludeçš„è‡ªåŠ¨é…ç½®ç±»ï¼Œç„¶åå†æ’åºã€‚é€»è¾‘å¾ˆç®€å•ï¼Œä¸å†è¯¦è¿°ã€‚\nä¸è¿‡æœ‰ä¸ªç–‘é—®ï¼Œå‰é¢å·²ç»excludeè¿‡ä¸€æ¬¡äº†ï¼Œä¸ºä½•è¿™é‡Œè¿˜è¦å†excludeä¸€æ¬¡ï¼Ÿ\n\n5 AutoConfigurationImportFilterè¿™é‡Œç»§ç»­æ·±ç©¶å‰é¢ 4.1 èŠ‚çš„ AutoConfigurationImportSelector.filteræ–¹æ³•çš„è¿‡æ»¤è‡ªåŠ¨é…ç½®ç±»çš„boolean[] match = filter.match(candidates, autoConfigurationMetadata);è¿™å¥ä»£ç ã€‚\nå› æ­¤æˆ‘ä»¬ç»§ç»­åˆ†æAutoConfigurationImportFilteræ¥å£ï¼Œåˆ†æå…¶matchæ–¹æ³•ï¼ŒåŒæ—¶ä¹Ÿæ˜¯å¯¹å‰ä¸€ç¯‡@ConditionalOnXxxçš„æºç åˆ†ææ–‡ç« ä¸­ç•™ä¸‹çš„å‘è¿›è¡Œå¡«è¡¥ã€‚\nAutoConfigurationImportFilteræ¥å£åªæœ‰ä¸€ä¸ªmatchæ–¹æ³•ç”¨æ¥è¿‡æ»¤ä¸ç¬¦åˆæ¡ä»¶çš„è‡ªåŠ¨é…ç½®ç±»ã€‚\n@FunctionalInterface\npublic interface AutoConfigurationImportFilter &#123;\n    boolean[] match(String[] autoConfigurationClasses,\n    \t\tAutoConfigurationMetadata autoConfigurationMetadata);\n&#125;\n\nåŒæ ·ï¼Œåœ¨åˆ†æAutoConfigurationImportFilteræ¥å£çš„matchæ–¹æ³•å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹å…¶ç±»å…³ç³»å›¾ï¼š\n\nå¯ä»¥çœ‹åˆ°,AutoConfigurationImportFilteræ¥å£æœ‰ä¸€ä¸ªå…·ä½“çš„å®ç°ç±»FilteringSpringBootConditionï¼ŒFilteringSpringBootConditionåˆæœ‰ä¸‰ä¸ªå…·ä½“çš„å­ç±»ï¼šOnClassCondition,OnBeanCondtitionå’ŒOnWebApplicationConditionã€‚\né‚£ä¹ˆè¿™å‡ ä¸ªç±»ä¹‹é—´çš„å…³ç³»æ˜¯æ€æ ·çš„å‘¢ï¼Ÿ\nFilteringSpringBootConditionå®ç°äº†AutoConfigurationImportFilteræ¥å£çš„matchæ–¹æ³•ï¼Œç„¶ååœ¨FilteringSpringBootConditionçš„matchæ–¹æ³•è°ƒç”¨getOutcomesè¿™ä¸ªæŠ½è±¡æ¨¡æ¿æ–¹æ³•è¿”å›è‡ªåŠ¨é…ç½®ç±»çš„åŒ¹é…ä¸å¦çš„ä¿¡æ¯ã€‚åŒæ—¶ï¼Œæœ€é‡è¦çš„æ˜¯FilteringSpringBootConditionçš„ä¸‰ä¸ªå­ç±»OnClassCondition,OnBeanCondtitionå’ŒOnWebApplicationConditionå°†ä¼šå¤å†™è¿™ä¸ªæ¨¡æ¿æ–¹æ³•å®ç°è‡ªå·±çš„åŒ¹é…åˆ¤æ–­é€»è¾‘ã€‚\nå¥½äº†ï¼ŒAutoConfigurationImportFilteræ¥å£çš„æ•´ä½“å…³ç³»å·²ç»æ¸…æ¥šäº†ï¼Œç°åœ¨æˆ‘ä»¬å†è¿›å…¥å…¶å…·ä½“å®ç°ç±»FilteringSpringBootConditionçš„matchæ–¹æ³•çœ‹çœ‹æ˜¯å…¶å¦‚ä½•æ ¹æ®æ¡ä»¶è¿‡æ»¤è‡ªåŠ¨é…ç½®ç±»çš„ã€‚\n// FilteringSpringBootCondition.java\n\n@Override\npublic boolean[] match(String[] autoConfigurationClasses,\n\t\tAutoConfigurationMetadata autoConfigurationMetadata) &#123;\n\t// åˆ›å»ºè¯„ä¼°æŠ¥å‘Š\n\tConditionEvaluationReport report = ConditionEvaluationReport\n\t\t\t.find(this.beanFactory);\n\t// æ³¨æ„getOutcomesæ˜¯æ¨¡æ¿æ–¹æ³•ï¼Œå°†spring.factoriesæ–‡ä»¶ç§åŠ è½½çš„æ‰€æœ‰è‡ªåŠ¨é…ç½®ç±»ä¼ å…¥\n\t// å­ç±»ï¼ˆè¿™é‡ŒæŒ‡çš„æ˜¯OnClassCondition,OnBeanConditionå’ŒOnWebApplicationConditionç±»ï¼‰å»è¿‡æ»¤\n\t// æ³¨æ„outcomesæ•°ç»„å­˜å‚¨çš„æ˜¯ä¸åŒ¹é…çš„ç»“æœï¼Œè·ŸautoConfigurationClassesæ•°ç»„ä¸€ä¸€å¯¹åº”\n\t/*****************************ã€ä¸»çº¿ï¼Œé‡ç‚¹å…³æ³¨ã€‘*********************************************/\n\tConditionOutcome[] outcomes = getOutcomes(autoConfigurationClasses,\n\t\t\tautoConfigurationMetadata);\n\tboolean[] match = new boolean[outcomes.length];\n\t// éå†outcomes,è¿™é‡Œoutcomesä¸ºnullåˆ™è¡¨ç¤ºåŒ¹é…ï¼Œä¸ä¸ºnullåˆ™è¡¨ç¤ºä¸åŒ¹é…\n\tfor (int i = 0; i &lt; outcomes.length; i++) &#123;\n\t\tConditionOutcome outcome = outcomes[i];\n\t\tmatch[i] = (outcome == null || outcome.isMatch());\n\t\tif (!match[i] &amp;&amp; outcomes[i] != null) &#123;\n\t\t\t// è¿™é‡Œè‹¥æœ‰æŸä¸ªç±»ä¸åŒ¹é…çš„è¯ï¼Œæ­¤æ—¶è°ƒç”¨çˆ¶ç±»SpringBootConditionçš„logOutcomeæ–¹æ³•æ‰“å°æ—¥å¿—\n\t\t\tlogOutcome(autoConfigurationClasses[i], outcomes[i]);\n\t\t\t// å¹¶å°†ä¸åŒ¹é…æƒ…å†µè®°å½•åˆ°report\n\t\t\tif (report != null) &#123;\n\t\t\t\treport.recordConditionEvaluation(autoConfigurationClasses[i], this,\n\t\t\t\t\t\toutcomes[i]);\n\t\t\t&#125;\n\t\t&#125;\n\t&#125;\n\treturn match;\n&#125;\n\nFilteringSpringBootConditionçš„matchæ–¹æ³•ä¸»è¦åšçš„äº‹æƒ…è¿˜æ˜¯è°ƒç”¨æŠ½è±¡æ¨¡æ¿æ–¹æ³•getOutcomesæ¥æ ¹æ®æ¡ä»¶æ¥è¿‡æ»¤è‡ªåŠ¨é…ç½®ç±»ï¼Œè€Œå¤å†™getOutcomesæ¨¡æ¿æ–¹æ³•çš„æœ‰ä¸‰ä¸ªå­ç±»ï¼Œè¿™é‡Œä¸å†ä¸€ä¸€åˆ†æï¼ŒåªæŒ‘é€‰**OnClassCondition**å¤å†™çš„**getOutcomes**æ–¹æ³•è¿›è¡Œåˆ†æã€‚\n\n5.1 OnClassConditionå…ˆç›´æ¥ä¸ŠOnClassConditionå¤å†™çš„getOutcomesæ–¹æ³•çš„ä»£ç ï¼š\n// OnClassCondition.java\n\nprotected final ConditionOutcome[] getOutcomes(String[] autoConfigurationClasses,\n\t\tAutoConfigurationMetadata autoConfigurationMetadata) &#123;\n\t// Split the work and perform half in a background thread. Using a single\n\t// additional thread seems to offer the best performance. More threads make\n\t// things worse\n\t// è¿™é‡Œç»è¿‡æµ‹è¯•ç”¨ä¸¤ä¸ªçº¿ç¨‹å»è·‘çš„è¯æ€§èƒ½æ˜¯æœ€å¥½çš„ï¼Œå¤§äºä¸¤ä¸ªçº¿ç¨‹æ€§èƒ½åè€Œå˜å·®\n\tint split = autoConfigurationClasses.length / 2;\n\t// ã€1ã€‘å¼€å¯ä¸€ä¸ªæ–°çº¿ç¨‹å»æ‰«æåˆ¤æ–­å·²ç»åŠ è½½çš„ä¸€åŠè‡ªåŠ¨é…ç½®ç±»\n\tOutcomesResolver firstHalfResolver = createOutcomesResolver(\n\t\t\tautoConfigurationClasses, 0, split, autoConfigurationMetadata);\n\t// ã€2ã€‘è¿™é‡Œç”¨ä¸»çº¿ç¨‹å»æ‰«æåˆ¤æ–­å·²ç»åŠ è½½çš„ä¸€åŠè‡ªåŠ¨é…ç½®ç±»\n\tOutcomesResolver secondHalfResolver = new StandardOutcomesResolver(\n\t\t\tautoConfigurationClasses, split, autoConfigurationClasses.length,\n\t\t\tautoConfigurationMetadata, getBeanClassLoader());\n\t// ã€3ã€‘å…ˆè®©ä¸»çº¿ç¨‹å»æ‰§è¡Œè§£æä¸€åŠè‡ªåŠ¨é…ç½®ç±»æ˜¯å¦åŒ¹é…æ¡ä»¶\n\tConditionOutcome[] secondHalf = secondHalfResolver.resolveOutcomes();\n\t// ã€4ã€‘è¿™é‡Œç”¨æ–°å¼€å¯çš„çº¿ç¨‹å–è§£æå¦ä¸€åŠè‡ªåŠ¨é…ç½®ç±»æ˜¯å¦åŒ¹é…\n\t// æ³¨æ„ä¸ºäº†é˜²æ­¢ä¸»çº¿ç¨‹æ‰§è¡Œè¿‡å¿«ç»“æŸï¼ŒresolveOutcomesæ–¹æ³•é‡Œé¢è°ƒç”¨äº†thread.join()æ¥\n\t// è®©ä¸»çº¿ç¨‹ç­‰å¾…æ–°çº¿ç¨‹æ‰§è¡Œç»“æŸï¼Œå› ä¸ºåé¢è¦åˆå¹¶ä¸¤ä¸ªçº¿ç¨‹çš„è§£æç»“æœ\n\tConditionOutcome[] firstHalf = firstHalfResolver.resolveOutcomes();\n\t// æ–°å»ºä¸€ä¸ªConditionOutcomeæ•°ç»„æ¥å­˜å‚¨è‡ªåŠ¨é…ç½®ç±»çš„ç­›é€‰ç»“æœ\n\tConditionOutcome[] outcomes = new ConditionOutcome[autoConfigurationClasses.length];\n\t// å°†å‰é¢ä¸¤ä¸ªçº¿ç¨‹çš„ç­›é€‰ç»“æœåˆ†åˆ«æ‹·è´è¿›outcomesæ•°ç»„\n\tSystem.arraycopy(firstHalf, 0, outcomes, 0, firstHalf.length);\n\tSystem.arraycopy(secondHalf, 0, outcomes, split, secondHalf.length);\n\t// è¿”å›è‡ªåŠ¨é…ç½®ç±»çš„ç­›é€‰ç»“æœ\n\treturn outcomes;\n&#125;\n\nå¯ä»¥çœ‹åˆ°ï¼ŒOnClassConditionçš„getOutcomesæ–¹æ³•ä¸»è¦è§£æè‡ªåŠ¨é…ç½®ç±»æ˜¯å¦ç¬¦åˆåŒ¹é…æ¡ä»¶ï¼Œå½“ç„¶è¿™ä¸ªåŒ¹é…æ¡ä»¶æŒ‡è‡ªåŠ¨é…ç½®ç±»ä¸Šçš„æ³¨è§£@ConditionalOnClassæŒ‡å®šçš„ç±»å­˜ä¸å­˜åœ¨äºclasspathä¸­ï¼Œå­˜åœ¨åˆ™è¿”å›åŒ¹é…ï¼Œä¸å­˜åœ¨åˆ™è¿”å›ä¸åŒ¹é…ã€‚\nç”±äºè§£æè‡ªåŠ¨é…ç½®ç±»æ˜¯å¦åŒ¹é…æ¯”è¾ƒè€—æ—¶ï¼Œå› æ­¤ä»ä¸Šé¢ä»£ç ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°åˆ†åˆ«åˆ›å»ºäº†firstHalfResolverå’ŒsecondHalfResolverä¸¤ä¸ªè§£æå¯¹è±¡ï¼Œè¿™ä¸¤ä¸ªè§£æå¯¹è±¡ä¸ªåˆ†åˆ«å¯¹åº”ä¸€ä¸ªçº¿ç¨‹å»è§£æåŠ è½½çš„è‡ªåŠ¨é…ç½®ç±»æ˜¯å¦ç¬¦åˆæ¡ä»¶ï¼Œæœ€ç»ˆå°†ä¸¤ä¸ªçº¿ç¨‹çš„è§£æè‡ªåŠ¨é…ç½®ç±»çš„åŒ¹é…ç»“æœåˆå¹¶åè¿”å›ã€‚\né‚£ä¹ˆè‡ªåŠ¨é…ç½®ç±»æ˜¯å¦ç¬¦åˆæ¡ä»¶çš„è§£æåˆ¤æ–­è¿‡ç¨‹åˆæ˜¯æ€æ ·çš„å‘¢ï¼Ÿç°åœ¨æˆ‘ä»¬åˆ†åˆ«æ¥çœ‹ä¸€ä¸‹ä¸Šé¢ä»£ç æ³¨é‡Šæ ‡æ³¨çš„ã€1ã€‘ï¼Œã€2ã€‘ï¼Œã€3ã€‘å’Œã€4ã€‘å¤„ã€‚\n\n5.1.1 createOutcomesResolverè¿™é‡Œå¯¹åº”å‰é¢ 5.1 èŠ‚çš„ä»£ç æ³¨é‡Šæ ‡æ³¨ã€1ã€‘å¤„çš„OutcomesResolver firstHalfResolver = createOutcomesResolver(...);çš„æ–¹æ³•ï¼š\n// OnClassCondition.java\n\nprivate OutcomesResolver createOutcomesResolver(String[] autoConfigurationClasses,\n\t\tint start, int end, AutoConfigurationMetadata autoConfigurationMetadata) &#123;\n\t// æ–°å»ºä¸€ä¸ªStandardOutcomesResolverå¯¹è±¡\n\tOutcomesResolver outcomesResolver = new StandardOutcomesResolver(\n\t\t\tautoConfigurationClasses, start, end, autoConfigurationMetadata,\n\t\t\tgetBeanClassLoader());\n\ttry &#123;\n\t\t// newä¸€ä¸ªThreadedOutcomesResolverå¯¹è±¡ï¼Œå¹¶å°†StandardOutcomesResolverç±»å‹çš„outcomesResolverå¯¹è±¡ä½œä¸ºæ„é€ å™¨å‚æ•°ä¼ å…¥\n\t\treturn new ThreadedOutcomesResolver(outcomesResolver);\n\t&#125;\n\t// è‹¥ä¸Šé¢å¼€å¯çš„çº¿ç¨‹æŠ›å‡ºAccessControlExceptionå¼‚å¸¸ï¼Œåˆ™è¿”å›StandardOutcomesResolverå¯¹è±¡\n\tcatch (AccessControlException ex) &#123;\n\t\treturn outcomesResolver;\n\t&#125;\n&#125;\nå¤åˆ¶ä»£ç \n\nå¯ä»¥çœ‹åˆ°createOutcomesResolveræ–¹æ³•åˆ›å»ºäº†ä¸€ä¸ªå°è£…äº†StandardOutcomesResolverç±»çš„ThreadedOutcomesResolverè§£æå¯¹è±¡ã€‚ æˆ‘ä»¬å†æ¥çœ‹ä¸‹ThreadedOutcomesResolverè¿™ä¸ªçº¿ç¨‹è§£æç±»å°è£…StandardOutcomesResolverè¿™ä¸ªå¯¹è±¡çš„ç›®çš„æ˜¯ä»€ä¹ˆï¼Ÿæˆ‘ä»¬ç»§ç»­è·Ÿè¿›ä»£ç ï¼š\n// OnClassCondtion.java\n\nprivate ThreadedOutcomesResolver(OutcomesResolver outcomesResolver) &#123;\n\t// è¿™é‡Œå¼€å¯ä¸€ä¸ªæ–°çš„çº¿ç¨‹ï¼Œè¿™ä¸ªçº¿ç¨‹å…¶å®è¿˜æ˜¯åˆ©ç”¨StandardOutcomesResolverçš„resolveOutcomesæ–¹æ³•\n\t// å¯¹è‡ªåŠ¨é…ç½®ç±»è¿›è¡Œè§£æåˆ¤æ–­æ˜¯å¦åŒ¹é…\n\tthis.thread = new Thread(\n\t\t\t() -> this.outcomes = outcomesResolver.resolveOutcomes());\n\t// å¼€å¯çº¿ç¨‹\n\tthis.thread.start();\n&#125;\nå¤åˆ¶ä»£ç \n\nå¯ä»¥çœ‹åˆ°åœ¨æ„é€ ThreadedOutcomesResolverå¯¹è±¡æ—¶å€™ï¼ŒåŸæ¥æ˜¯å¼€å¯äº†ä¸€ä¸ªçº¿ç¨‹ï¼Œç„¶åè¿™ä¸ªçº¿ç¨‹å…¶å®è¿˜æ˜¯è°ƒç”¨äº†åˆšä¼ è¿›æ¥çš„StandardOutcomesResolverå¯¹è±¡çš„resolveOutcomesæ–¹æ³•å»è§£æè‡ªåŠ¨é…ç½®ç±»ã€‚å…·ä½“å¦‚ä½•è§£æå‘¢ï¼Ÿç¨åæˆ‘ä»¬åœ¨åˆ†æã€3ã€‘å¤„ä»£ç secondHalfResolver.resolveOutcomes();çš„æ—¶å€™å†æ·±ç©¶ã€‚\n\n5.1.2 new StandardOutcomesResolverè¿™é‡Œå¯¹åº”å‰é¢ 5.1 èŠ‚çš„ã€2ã€‘å¤„çš„ä»£ç OutcomesResolver secondHalfResolver = new StandardOutcomesResolver(...);ï¼Œé€»è¾‘å¾ˆç®€å•ï¼Œå°±æ˜¯åˆ›å»ºäº†ä¸€ä¸ªStandardOutcomesResolverå¯¹è±¡ï¼Œç”¨äºåé¢è§£æè‡ªåŠ¨é…ç½®ç±»æ˜¯å¦åŒ¹é…ï¼ŒåŒæ—¶ï¼Œæ–°å»ºçš„ä¸€ä¸ªçº¿ç¨‹ä¹Ÿæ˜¯åˆ©ç”¨å®ƒæ¥å®Œæˆè‡ªåŠ¨é…ç½®ç±»çš„è§£æçš„ã€‚\n\n5.1.3 StandardOutcomesResolver.resolveOutcomes æ–¹æ³•è¿™é‡Œå¯¹åº”å‰é¢ 5.1 èŠ‚æ ‡æ³¨çš„ã€3ã€‘çš„ä»£ç ConditionOutcome[] secondHalf = secondHalfResolver.resolveOutcomes();ã€‚\nè¿™é‡ŒStandardOutcomesResolver.resolveOutcomesæ–¹æ³•æ‰¿æ‹…äº†è§£æè‡ªåŠ¨é…ç½®ç±»åŒ¹é…ä¸å¦çš„å…¨éƒ¨é€»è¾‘ï¼Œæ˜¯æˆ‘ä»¬è¦é‡ç‚¹åˆ†æçš„æ–¹æ³•ï¼ŒresolveOutcomesæ–¹æ³•æœ€ç»ˆæŠŠè§£æçš„è‡ªåŠ¨é…ç½®ç±»çš„ç»“æœèµ‹ç»™secondHalfæ•°ç»„ã€‚é‚£ä¹ˆå®ƒæ˜¯å¦‚ä½•è§£æè‡ªåŠ¨é…ç½®ç±»æ˜¯å¦åŒ¹é…æ¡ä»¶çš„å‘¢ï¼Ÿ\n// OnClassCondition$StandardOutcomesResolver.java\n\npublic ConditionOutcome[] resolveOutcomes() &#123;\n\t// å†è°ƒç”¨getOutcomesæ–¹æ³•æ¥è§£æ\n\treturn getOutcomes(this.autoConfigurationClasses, this.start, this.end,\n\t\t\tthis.autoConfigurationMetadata);\n&#125;\n\nprivate ConditionOutcome[] getOutcomes(String[] autoConfigurationClasses,\n\t\tint start, int end, AutoConfigurationMetadata autoConfigurationMetadata) &#123; // åªè¦autoConfigurationMetadataæ²¡æœ‰å­˜å‚¨ç›¸å…³è‡ªåŠ¨é…ç½®ç±»ï¼Œé‚£ä¹ˆoutcomeé»˜è®¤ä¸ºnullï¼Œåˆ™è¯´æ˜åŒ¹é…\n\tConditionOutcome[] outcomes = new ConditionOutcome[end - start];\n\t// éå†æ¯ä¸€ä¸ªè‡ªåŠ¨é…ç½®ç±»\n\tfor (int i = start; i &lt; end; i++) &#123;\n\t\tString autoConfigurationClass = autoConfigurationClasses[i];\n\t\t// TODO å¯¹äºautoConfigurationMetadataæœ‰ä¸ªç–‘é—®ï¼šä¸ºä½•æœ‰äº›è‡ªåŠ¨é…ç½®ç±»çš„æ¡ä»¶æ³¨è§£èƒ½è¢«åŠ è½½åˆ°autoConfigurationMetadataï¼Œè€Œæœ‰äº›åˆä¸èƒ½ï¼Œæ¯”å¦‚è‡ªå·±å®šä¹‰çš„ä¸€ä¸ªè‡ªåŠ¨é…ç½®ç±»HelloWorldEnableAutoConfigurationå°±æ²¡æœ‰è¢«å­˜åˆ°autoConfigurationMetadataä¸­\n\t\tif (autoConfigurationClass != null) &#123;\n\t\t\t// è¿™é‡Œå–å‡ºæ³¨è§£åœ¨AutoConfigurationè‡ªåŠ¨é…ç½®ç±»ç±»çš„@ConditionalOnClassæ³¨è§£çš„æŒ‡å®šç±»çš„å…¨é™å®šåï¼Œ\n\t\t\t// ä¸¾ä¸ªæ —å­ï¼Œçœ‹ä¸‹é¢çš„KafkaStreamsAnnotationDrivenConfigurationè¿™ä¸ªè‡ªåŠ¨é…ç½®ç±»\n\t\t\t/**\n\t\t\t * @ConditionalOnClass(StreamsBuilder.class)\n\t\t\t * class KafkaStreamsAnnotationDrivenConfiguration &#123;\n\t\t\t * // çœç•¥æ— å…³ä»£ç \n\t\t\t * &#125;\n\t\t\t */\n\t\t\t// é‚£ä¹ˆå–å‡ºçš„å°±æ˜¯StreamsBuilderç±»çš„å…¨é™å®šåå³candidates = org.apache.kafka.streams.StreamsBuilder\n\t\t\tString candidates = autoConfigurationMetadata\n\t\t\t\t\t.get(autoConfigurationClass, \"ConditionalOnClass\"); // å› ä¸ºè¿™é‡Œæ˜¯å¤„ç†æŸä¸ªç±»æ˜¯å¦å­˜åœ¨äºclasspathä¸­ï¼Œæ‰€ä»¥ä¼ å…¥çš„keyæ˜¯ConditionalOnClass\n\t\t\t// è‹¥è‡ªåŠ¨é…ç½®ç±»æ ‡æœ‰ConditionalOnClassæ³¨è§£ä¸”æœ‰å€¼ï¼Œæ­¤æ—¶è°ƒç”¨getOutcomeåˆ¤æ–­æ˜¯å¦å­˜åœ¨äºç±»è·¯å¾„ä¸­\n\t\t\tif (candidates != null) &#123;\n\t\t\t\t// æ‹¿åˆ°è‡ªåŠ¨é…ç½®ç±»æ³¨è§£@ConditionalOnClassçš„å€¼åï¼Œå†è°ƒç”¨getOutcomeæ–¹æ³•å»åˆ¤æ–­åŒ¹é…ç»“æœ,è‹¥è¯¥ç±»å­˜åœ¨äºç±»è·¯å¾„ï¼Œåˆ™getOutcomeè¿”å›nullï¼Œå¦åˆ™énull\n\t\t\t\t/*******************ã€ä¸»çº¿ï¼Œé‡ç‚¹å…³æ³¨ã€‘******************/\n\t\t\t\toutcomes[i - start] = getOutcome(candidates);\n\t\t\t&#125;\n\t\t&#125;\n\t&#125;\n\treturn outcomes;\n&#125;\nå¤åˆ¶ä»£ç \n\nå¯ä»¥çœ‹åˆ°StandardOutcomesResolver.resolveOutcomesçš„æ–¹æ³•ä¸­å†æ¬¡è°ƒç”¨getOutcomesæ–¹æ³•ï¼Œä¸»è¦æ˜¯ä»autoConfigurationMetadataå¯¹è±¡ä¸­è·å–åˆ°è‡ªåŠ¨é…ç½®ç±»ä¸Šçš„æ³¨è§£@ConditionalOnClassæŒ‡å®šçš„ç±»çš„å…¨é™å®šåï¼Œç„¶åä½œä¸ºå‚æ•°ä¼ å…¥getOutcomeæ–¹æ³•ç”¨äºå»ç±»è·¯å¾„åŠ è½½è¯¥ç±»ï¼Œè‹¥èƒ½åŠ è½½åˆ°åˆ™è¯´æ˜æ³¨è§£@ConditionalOnClassæ»¡è¶³æ¡ä»¶ï¼Œæ­¤æ—¶è¯´æ˜è‡ªåŠ¨é…ç½®ç±»åŒ¹é…æˆåŠŸã€‚\nä½†æ˜¯åˆ«å¿˜äº†ï¼Œè¿™é‡Œåªæ˜¯è¿‡äº†@ConditionalOnClassæ³¨è§£è¿™ä¸€å…³ï¼Œè‹¥è‡ªåŠ¨é…ç½®ç±»è¿˜æœ‰å…¶ä»–æ³¨è§£æ¯”å¦‚@ConditionalOnBeanï¼Œè‹¥è¯¥@ConditionalOnBeanæ³¨è§£ä¸æ»¡è¶³æ¡ä»¶çš„è¯ï¼ŒåŒæ ·æœ€ç»ˆç»“æœæ˜¯ä¸åŒ¹é…çš„ã€‚è¿™é‡Œæ‰¯çš„æœ‰ç‚¹è¿œï¼Œæˆ‘ä»¬å›åˆ°OnClassCondtionçš„åˆ¤æ–­é€»è¾‘ï¼Œç»§ç»­è¿›å…¥getOutcomeæ–¹æ³•çœ‹å®ƒæ˜¯å¦‚ä½•å»åˆ¤æ–­@ConditionalOnClassæ³¨è§£æ»¡ä¸æ»¡è¶³æ¡ä»¶çš„ã€‚\n// OnClassCondition$StandardOutcomesResolver.java\n\n// è¿”å›çš„outcomeè®°å½•çš„æ˜¯ä¸åŒ¹é…çš„æƒ…å†µï¼Œä¸ä¸ºnullï¼Œåˆ™è¯´æ˜ä¸åŒ¹é…ï¼›ä¸ºnullï¼Œåˆ™è¯´æ˜åŒ¹é…\nprivate ConditionOutcome getOutcome(String candidates) &#123;\n\t// candidatesçš„å½¢å¼ä¸ºâ€œorg.springframework.boot.autoconfigure.aop.AopAutoConfiguration.ConditionalOnClass=org.aspectj.lang.annotation.Aspect,org.aspectj.lang.reflect.Advice,org.aspectj.weaver.AnnotatedElementâ€\n\ttry &#123;// è‡ªåŠ¨é…ç½®ç±»ä¸Š@ConditionalOnClassçš„å€¼åªæœ‰ä¸€ä¸ªçš„è¯ï¼Œç›´æ¥è°ƒç”¨getOutcomeæ–¹æ³•åˆ¤æ–­æ˜¯å¦åŒ¹é…\n\t\tif (!candidates.contains(\",\")) &#123;\n\t\t\t// çœ‹åˆ°å› ä¸ºä¼ å…¥çš„å‚æ•°æ˜¯ ClassNameFilter.MISSINGï¼Œå› æ­¤å¯ä»¥çŒœæµ‹è¿™é‡Œåº”è¯¥æ˜¯å¾—åˆ°ä¸åŒ¹é…çš„ç»“æœ\n\t\t\t/******************ã€ä¸»çº¿ï¼Œé‡ç‚¹å…³æ³¨ã€‘********************/\n\t\t\treturn getOutcome(candidates, ClassNameFilter.MISSING,\n\t\t\t\t\tthis.beanClassLoader);\n\t\t&#125;\n\t\t// è‡ªåŠ¨é…ç½®ç±»ä¸Š@ConditionalOnClassçš„å€¼æœ‰å¤šä¸ªçš„è¯ï¼Œåˆ™éå†æ¯ä¸ªå€¼ï¼ˆå…¶å€¼ä»¥é€—å·ï¼Œåˆ†éš”ï¼‰\n\t\tfor (String candidate : StringUtils\n\t\t\t\t.commaDelimitedListToStringArray(candidates)) &#123;\n\t\t\tConditionOutcome outcome = getOutcome(candidate,\n\t\t\t\t\tClassNameFilter.MISSING, this.beanClassLoader);\n\t\t\t// å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œåªè¦æœ‰ä¸€ä¸ªä¸åŒ¹é…çš„è¯ï¼Œåˆ™è¿”å›ä¸åŒ¹é…ç»“æœ\n\t\t\tif (outcome != null) &#123;\n\t\t\t\treturn outcome;\n\t\t\t&#125;\n\t\t&#125;\n\t&#125;\n\tcatch (Exception ex) &#123;\n\t\t// We'll get another chance later\n\t&#125;\n\treturn null;\n&#125;\nå¤åˆ¶ä»£ç \n\nå¯ä»¥çœ‹åˆ°ï¼ŒgetOutcomeæ–¹æ³•å†æ¬¡è°ƒç”¨é‡è½½æ–¹æ³•getOutcomeè¿›ä¸€æ­¥å»åˆ¤æ–­æ³¨è§£@ConditionalOnClassæŒ‡å®šçš„ç±»å­˜ä¸å­˜åœ¨ç±»è·¯å¾„ä¸­ï¼Œè·Ÿç€ä¸»çº¿ç»§ç»­è·Ÿè¿›å»ï¼š\n// OnClassCondition$StandardOutcomesResolver.java\n\nprivate ConditionOutcome getOutcome(String className,\n\t\tClassNameFilter classNameFilter, ClassLoader classLoader) &#123;\n\t// è°ƒç”¨classNameFilterçš„matchesæ–¹æ³•æ¥åˆ¤æ–­`@ConditionalOnClass`æŒ‡å®šçš„ç±»å­˜ä¸å­˜åœ¨ç±»è·¯å¾„ä¸­\n\t/******************ã€ä¸»çº¿ï¼Œé‡ç‚¹å…³æ³¨ã€‘********************/\n\tif (classNameFilter.matches(className, classLoader)) &#123; // è¿™é‡Œè°ƒç”¨classNameFilterå»åˆ¤æ–­classNameæ˜¯å¦å­˜åœ¨äºç±»è·¯å¾„ä¸­ï¼Œå…¶ä¸­ClassNameFilteråˆåˆ†ä¸ºPRESENTå’ŒMISSINGä¸¤ç§;ç›®å‰åªçœ‹åˆ°ClassNameFilterä¸ºMISSINGçš„è°ƒç”¨æƒ…å†µï¼Œæ‰€ä»¥é»˜è®¤ä¸ºtrueçš„è¯è®°å½•ä¸åŒ¹é…ä¿¡æ¯ï¼›è‹¥ä¼ å…¥ClassNameFilterä¸ºPRESENTçš„è¯ï¼Œä¼°è®¡è¿˜è¦å†å†™ä¸€ä¸ªelseåˆ†æ”¯\n\t\treturn ConditionOutcome.noMatch(ConditionMessage\n\t\t\t\t.forCondition(ConditionalOnClass.class)\n\t\t\t\t.didNotFind(\"required class\").items(Style.QUOTE, className));\n\t&#125;\n\treturn null;\n&#125;\nå¤åˆ¶ä»£ç \n\næˆ‘ä»¬ä¸€å±‚ä¸€å±‚çš„å‰¥ï¼Œæœ€ç»ˆå‰¥åˆ°äº†æœ€åº•å±‚äº†ï¼Œè¿™ä¸ªçœŸçš„éœ€è¦è¶³å¤Ÿè€å¿ƒï¼Œæ²¡åŠæ³•ï¼Œæºç åªèƒ½ä¸€ç‚¹ä¸€ç‚¹çš„å•ƒï¼Œå˜¿å˜¿ã€‚å¯ä»¥çœ‹åˆ°æœ€ç»ˆæ˜¯è°ƒç”¨ClassNameFilterçš„matchesæ–¹æ³•æ¥åˆ¤æ–­@ConditionalOnClassæŒ‡å®šçš„ç±»å­˜ä¸å­˜åœ¨ç±»è·¯å¾„ä¸­,è‹¥ä¸å­˜åœ¨çš„è¯ï¼Œåˆ™è¿”å›ä¸åŒ¹é…ã€‚\næˆ‘ä»¬ç»§ç»­è·Ÿè¿›ClassNameFilterçš„æºç ï¼š\n// FilteringSpringBootCondition.java\n\nprotected enum ClassNameFilter &#123;\n\t// è¿™é‡Œè¡¨ç¤ºæŒ‡å®šçš„ç±»å­˜åœ¨äºç±»è·¯å¾„ä¸­ï¼Œåˆ™è¿”å›true\n\tPRESENT &#123;\n\n\t\t@Override\n\t\tpublic boolean matches(String className, ClassLoader classLoader) &#123;\n\t\t\treturn isPresent(className, classLoader);\n\t\t&#125;\n\n\t&#125;,\n\t// è¿™é‡Œè¡¨ç¤ºæŒ‡å®šçš„ç±»ä¸å­˜åœ¨äºç±»è·¯å¾„ä¸­ï¼Œåˆ™è¿”å›true\n\tMISSING &#123;\n\n\t\t@Override\n\t\tpublic boolean matches(String className, ClassLoader classLoader) &#123;\n\t\t\treturn !isPresent(className, classLoader); // è‹¥classpathä¸å­˜åœ¨classNameè¿™ä¸ªç±»ï¼Œåˆ™è¿”å›true\n\t\t&#125;\n\n\t&#125;;\n\t// è¿™åˆæ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œåˆ†åˆ«è¢«PRESENTå’ŒMISSINGæšä¸¾ç±»å®ç°\n\tpublic abstract boolean matches(String className, ClassLoader classLoader);\n\t// æ£€æŸ¥æŒ‡å®šçš„ç±»æ˜¯å¦å­˜åœ¨äºç±»è·¯å¾„ä¸­\n\tpublic static boolean isPresent(String className, ClassLoader classLoader) &#123;\n\t\tif (classLoader == null) &#123;\n\t\t\tclassLoader = ClassUtils.getDefaultClassLoader();\n\t\t&#125;\n\t\t// åˆ©ç”¨ç±»åŠ è½½å™¨å»åŠ è½½ç›¸åº”ç±»ï¼Œè‹¥æ²¡æœ‰æŠ›å‡ºå¼‚å¸¸åˆ™è¯´æ˜ç±»è·¯å¾„ä¸­å­˜åœ¨è¯¥ç±»ï¼Œæ­¤æ—¶è¿”å›true\n\t\ttry &#123;\n\t\t\tforName(className, classLoader);\n\t\t\treturn true;\n\t\t&#125;// è‹¥ä¸å­˜åœ¨äºç±»è·¯å¾„ä¸­ï¼Œæ­¤æ—¶æŠ›å‡ºçš„å¼‚å¸¸å°†catchä½ï¼Œè¿”å›falseã€‚\n\t\tcatch (Throwable ex) &#123;\n\t\t\treturn false;\n\t\t&#125;\n\t&#125;\n\t// åˆ©ç”¨ç±»åŠ è½½å™¨å»åŠ è½½æŒ‡å®šçš„ç±»\n\tprivate static Class&lt;?> forName(String className, ClassLoader classLoader)\n\t\t\tthrows ClassNotFoundException &#123;\n\t\tif (classLoader != null) &#123;\n\t\t\treturn classLoader.loadClass(className);\n\t\t&#125;\n\t\treturn Class.forName(className);\n\t&#125;\n\n&#125;\nå¤åˆ¶ä»£ç \n\n\nå¯ä»¥çœ‹åˆ°ClassNameFilteråŸæ¥æ˜¯FilteringSpringBootConditionçš„ä¸€ä¸ªå†…éƒ¨æšä¸¾ç±»ï¼Œå…¶å®ç°äº†åˆ¤æ–­æŒ‡å®šç±»æ˜¯å¦å­˜åœ¨äºclasspathä¸­çš„é€»è¾‘ï¼Œè¿™ä¸ªç±»å¾ˆç®€å•ï¼Œè¿™é‡Œä¸å†è¯¦è¿°ã€‚\n\n5.1.4 ThreadedOutcomesResolver.resolveOutcomes æ–¹æ³•è¿™é‡Œå¯¹åº”å‰é¢ 5.1 èŠ‚çš„æ ‡æ³¨çš„ã€4ã€‘çš„ä»£ç ConditionOutcome[] firstHalf = firstHalfResolver.resolveOutcomes()ã€‚\nå‰é¢åˆ†æ 5.1.3 StandardOutcomesResolver.resolveOutcomes æ–¹æ³•å·²ç»åˆ¨æ ¹è¿½åº•ï¼Œé™·å…¥ç»†èŠ‚æ¯”è¾ƒæ·±ï¼Œç°åœ¨æˆ‘ä»¬éœ€è¦è·³å‡ºæ¥ç»§ç»­çœ‹å‰é¢æ ‡æ³¨çš„ã€4ã€‘çš„ä»£ç ConditionOutcome[] firstHalf = firstHalfResolver.resolveOutcomes()çš„æ–¹æ³•å“ˆã€‚\nè¿™é‡Œæ˜¯ç”¨æ–°å¼€å¯çš„çº¿ç¨‹å»è°ƒç”¨StandardOutcomesResolver.resolveOutcomesæ–¹æ³•è§£æå¦ä¸€åŠè‡ªåŠ¨é…ç½®ç±»æ˜¯å¦åŒ¹é…ï¼Œå› ä¸ºæ˜¯æ–°çº¿ç¨‹ï¼Œè¿™é‡Œå¾ˆå¯èƒ½ä¼šå‡ºç°è¿™ä¹ˆä¸€ç§æƒ…å†µï¼šä¸»çº¿ç¨‹è§£æå®Œå±äºè‡ªå·±è§£æçš„ä¸€åŠè‡ªåŠ¨é…ç½®ç±»åï¼Œé‚£ä¹ˆä¹…ç»§ç»­å¾€ä¸‹è·‘äº†ï¼Œæ­¤æ—¶ä¸ä¼šç­‰å¾…æ–°å¼€å¯çš„å­çº¿ç¨‹çš„ã€‚\nå› æ­¤ï¼Œä¸ºäº†è®©ä¸»çº¿ç¨‹è§£æå®Œåï¼Œæˆ‘ä»¬éœ€è¦è®©ä¸»çº¿ç¨‹ç»§ç»­ç­‰å¾…æ­£åœ¨è§£æçš„å­çº¿ç¨‹ï¼Œç›´åˆ°å­çº¿ç¨‹ç»“æŸã€‚é‚£ä¹ˆæˆ‘ä»¬ç»§ç»­è·Ÿè¿›ä»£ç åŒºçœ‹ä¸‹ThreadedOutcomesResolver.resolveOutcomesæ–¹æ³•æ˜¯æ€æ ·å®ç°è®©ä¸»çº¿ç¨‹ç­‰å¾…å­çº¿ç¨‹çš„ï¼š\n// OnClassCondition$ThreadedOutcomesResolver.java\n\npublic ConditionOutcome[] resolveOutcomes() &#123;\n\ttry &#123;\n\t\t// è°ƒç”¨å­çº¿ç¨‹çš„Joinæ–¹æ³•ï¼Œè®©ä¸»çº¿ç¨‹ç­‰å¾…\n\t\tthis.thread.join();\n\t&#125;\n\tcatch (InterruptedException ex) &#123;\n\t\tThread.currentThread().interrupt();\n\t&#125;\n\t// è‹¥å­çº¿ç¨‹ç»“æŸåï¼Œæ­¤æ—¶è¿”å›å­çº¿ç¨‹çš„è§£æç»“æœ\n\treturn this.outcomes;\n&#125;\nå¤åˆ¶ä»£ç \n\n\nå¯ä»¥çœ‹åˆ°ç”¨äº†Thread.join()æ–¹æ³•æ¥è®©ä¸»çº¿ç¨‹ç­‰å¾…æ­£åœ¨è§£æè‡ªåŠ¨é…ç½®ç±»çš„å­çº¿ç¨‹ï¼Œè¿™é‡Œåº”è¯¥ä¹Ÿå¯ä»¥ç”¨CountDownLatchæ¥è®©ä¸»çº¿ç¨‹ç­‰å¾…å­çº¿ç¨‹ç»“æŸã€‚æœ€ç»ˆå°†å­çº¿ç¨‹è§£æåçš„ç»“æœèµ‹ç»™firstHalfæ•°ç»„ã€‚\n\n5.2 OnBeanCondition å’Œ OnWebApplicationConditionå‰é¢ 5.1 OnClassCondition èŠ‚æ·±å…¥åˆ†æäº†OnClassConditionæ˜¯å¦‚ä½•è¿‡æ»¤è‡ªåŠ¨é…ç½®ç±»çš„ï¼Œé‚£ä¹ˆè‡ªåŠ¨é…ç½®ç±»é™¤äº†è¦ç»è¿‡OnClassConditionçš„è¿‡æ»¤ï¼Œè¿˜è¦ç»è¿‡OnBeanConditionå’ŒOnWebApplicationConditionè¿™ä¸¤ä¸ªæ¡ä»¶ç±»çš„è¿‡æ»¤ï¼Œè¿™é‡Œä¸å†è¯¦è¿°ï¼Œæœ‰å…´è¶£çš„å°ä¼™ä¼´å¯è‡ªè¡Œåˆ†æã€‚\n\n6 AutoConfigurationImportListenerè¿™é‡Œç»§ç»­æ·±ç©¶å‰é¢ 4.1 èŠ‚çš„ AutoConfigurationImportSelector.getAutoConfigurationEntryæ–¹æ³•çš„è§¦å‘è‡ªåŠ¨é…ç½®ç±»è¿‡æ»¤å®Œæ¯•çš„äº‹ä»¶fireAutoConfigurationImportEvents(configurations, exclusions);è¿™å¥ä»£ç ã€‚\næˆ‘ä»¬ç›´æ¥ç‚¹è¿›fireAutoConfigurationImportEventsæ–¹æ³•çœ‹çœ‹å…¶æ˜¯å¦‚ä½•è§¦å‘äº‹ä»¶çš„ï¼š\n// AutoConfigurationImportSelector.java\n\nprivate void fireAutoConfigurationImportEvents(List&lt;String> configurations,\n\t\tSet&lt;String> exclusions) &#123;\n\t// ä»spring.factoriesæ€»è·å–åˆ°AutoConfigurationImportListenerå³ConditionEvaluationReportAutoConfigurationImportListener\n\tList&lt;AutoConfigurationImportListener> listeners = getAutoConfigurationImportListeners();\n\tif (!listeners.isEmpty()) &#123;\n\t\t// æ–°å»ºä¸€ä¸ªAutoConfigurationImportEventäº‹ä»¶\n\t\tAutoConfigurationImportEvent event = new AutoConfigurationImportEvent(this,\n\t\t\t\tconfigurations, exclusions);\n\t\t// éå†åˆšè·å–åˆ°çš„AutoConfigurationImportListener\n\t\tfor (AutoConfigurationImportListener listener : listeners) &#123;\n\t\t\t// è¿™é‡Œè°ƒç”¨å„ç§Awareæ–¹æ³•ç”¨äºè§¦å‘äº‹ä»¶å‰èµ‹å€¼ï¼Œæ¯”å¦‚è®¾ç½®factory,environmentç­‰\n\t\t\tinvokeAwareMethods(listener);\n\t\t\t// çœŸæ­£è§¦å‘AutoConfigurationImportEventäº‹ä»¶å³å›è°ƒlistenerçš„onXXXEveentæ–¹æ³•ã€‚è¿™é‡Œç”¨äºè®°å½•è‡ªåŠ¨é…ç½®ç±»çš„è¯„ä¼°ä¿¡æ¯\n\t\t\tlistener.onAutoConfigurationImportEvent(event);\n\t\t&#125;\n\t&#125;\n&#125;\n\n\nå¦‚ä¸Šï¼ŒfireAutoConfigurationImportEventsæ–¹æ³•åšäº†ä»¥ä¸‹ä¸¤ä»¶äº‹æƒ…ï¼š\n1ã€è°ƒç”¨getAutoConfigurationImportListenersæ–¹æ³•ä»spring.factorisé…ç½®æ–‡ä»¶è·å–å®ç°AutoConfigurationImportListeneræ¥å£çš„äº‹ä»¶ç›‘å¬å™¨ï¼›å¦‚ä¸‹å›¾ï¼Œå¯ä»¥çœ‹åˆ°è·å–çš„æ˜¯ConditionEvaluationReportAutoConfigurationImportListenerï¼š\n\n2ã€éå†è·å–çš„å„ä¸ªäº‹ä»¶ç›‘å¬å™¨ï¼Œç„¶åè°ƒç”¨ç›‘å¬å™¨å„ç§Awareæ–¹æ³•ç»™ç›‘å¬å™¨èµ‹å€¼ï¼Œæœ€åå†ä¾æ¬¡å›è°ƒäº‹ä»¶ç›‘å¬å™¨çš„onAutoConfigurationImportEventæ–¹æ³•ï¼Œæ‰§è¡Œç›‘å¬äº‹ä»¶çš„é€»è¾‘ã€‚\næ­¤æ—¶æˆ‘ä»¬å†æ¥çœ‹ä¸‹ConditionEvaluationReportAutoConfigurationImportListenerç›‘å¬å™¨ç›‘å¬åˆ°äº‹ä»¶åï¼Œå®ƒçš„onAutoConfigurationImportEventæ–¹æ³•ç©¶ç«Ÿåšäº†å“ªäº›äº‹æƒ…ï¼š\n// ConditionEvaluationReportAutoConfigurationImportListener.java\n\npublic void onAutoConfigurationImportEvent(AutoConfigurationImportEvent event) &#123;\n\tif (this.beanFactory != null) &#123;\n\t\t// è·å–åˆ°æ¡ä»¶è¯„ä¼°æŠ¥å‘Šå™¨å¯¹è±¡\n\t\tConditionEvaluationReport report = ConditionEvaluationReport\n\t\t\t\t.get(this.beanFactory);\n\t\t// å°†ç¬¦åˆæ¡ä»¶çš„è‡ªåŠ¨é…ç½®ç±»è®°å½•åˆ°unconditionalClassesé›†åˆä¸­\n\t\treport.recordEvaluationCandidates(event.getCandidateConfigurations());\n\t\t// å°†è¦excludeçš„è‡ªåŠ¨é…ç½®ç±»è®°å½•åˆ°exclusionsé›†åˆä¸­\n\t\treport.recordExclusions(event.getExclusions());\n\t&#125;\n&#125;\n\n\nå¯ä»¥çœ‹åˆ°ï¼ŒConditionEvaluationReportAutoConfigurationImportListenerç›‘å¬å™¨ç›‘å¬åˆ°äº‹ä»¶åï¼Œåšçš„äº‹æƒ…å¾ˆç®€å•ï¼Œåªæ˜¯åˆ†åˆ«è®°å½•ä¸‹ç¬¦åˆæ¡ä»¶å’Œè¢«excludeçš„è‡ªåŠ¨é…ç½®ç±»ã€‚\n\n7 AutoConfigurationPackageså‰é¢å·²ç»è¯¦è¿°äº† SpringBoot çš„è‡ªåŠ¨é…ç½®åŸç†äº†ï¼Œæœ€åçš„æœ€åï¼Œè·Ÿ SpringBoot è‡ªåŠ¨é…ç½®æœ‰å…³çš„æ³¨è§£@AutoConfigurationPackageè¿˜æ²¡åˆ†æï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹è¿™ä¸ªæ³¨è§£çš„æºç ï¼š\n@Target(ElementType.TYPE)\n@Retention(RetentionPolicy.RUNTIME)\n@Documented\n@Inherited\n@Import(AutoConfigurationPackages.Registrar.class)\npublic @interface AutoConfigurationPackage &#123;\n&#125;\n\n\nå¯ä»¥çœ‹åˆ°@AutoConfigurationPackageæ³¨è§£æ˜¯è·Ÿ SpringBoot è‡ªåŠ¨é…ç½®æ‰€åœ¨çš„åŒ…ç›¸å…³çš„ï¼Œå³å°† æ·»åŠ è¯¥æ³¨è§£çš„ç±»æ‰€åœ¨çš„ package ä½œä¸º è‡ªåŠ¨é…ç½® package è¿›è¡Œç®¡ç†ã€‚\næ¥ä¸‹æ¥æˆ‘ä»¬å†çœ‹çœ‹AutoConfigurationPackages.Registrarç±»æ˜¯å¹²å˜›çš„ï¼Œç›´æ¥çœ‹æºç ï¼š\n//AutoConfigurationPackages.Registrar.java\n\nstatic class Registrar implements ImportBeanDefinitionRegistrar, DeterminableImports &#123;\n    @Override\n    public void registerBeanDefinitions(AnnotationMetadata metadata,\n    \t\tBeanDefinitionRegistry registry) &#123;\n    \tregister(registry, new PackageImport(metadata).getPackageName());\n    &#125;\n\n    @Override\n    public Set&lt;Object> determineImports(AnnotationMetadata metadata) &#123;\n    \treturn Collections.singleton(new PackageImport(metadata));\n    &#125;\n&#125;\n\n\nå¯ä»¥çœ‹åˆ°Registrarç±»æ˜¯AutoConfigurationPackagesçš„é™æ€å†…éƒ¨ç±»ï¼Œå®ç°äº†ImportBeanDefinitionRegistrarå’ŒDeterminableImportsä¸¤ä¸ªæ¥å£ã€‚ç°åœ¨æˆ‘ä»¬ä¸»è¦æ¥å…³æ³¨ä¸‹Registrarå®ç°çš„registerBeanDefinitionsæ–¹æ³•,é¡¾åæ€ä¹‰ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯æ³¨å†Œbeanå®šä¹‰çš„æ–¹æ³•ã€‚çœ‹åˆ°å®ƒåˆè°ƒç”¨äº†AutoConfigurationPackagesçš„registeræ–¹æ³•ï¼Œç»§ç»­è·Ÿè¿›æºç ï¼š\n// AutoConfigurationPackages.java\n\npublic static void register(BeanDefinitionRegistry registry, String... packageNames) &#123;\n\tif (registry.containsBeanDefinition(BEAN)) &#123;\n\t\tBeanDefinition beanDefinition = registry.getBeanDefinition(BEAN);\n\t\tConstructorArgumentValues constructorArguments = beanDefinition\n\t\t\t\t.getConstructorArgumentValues();\n\t\tconstructorArguments.addIndexedArgumentValue(0,\n\t\t\t\taddBasePackages(constructorArguments, packageNames));\n\t&#125;\n\telse &#123;\n\t\tGenericBeanDefinition beanDefinition = new GenericBeanDefinition();\n\t\tbeanDefinition.setBeanClass(BasePackages.class);\n\t\tbeanDefinition.getConstructorArgumentValues().addIndexedArgumentValue(0,\n\t\t\t\tpackageNames);\n\t\tbeanDefinition.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);\n\t\tregistry.registerBeanDefinition(BEAN, beanDefinition);\n\t&#125;\n&#125;\n\n\nå¦‚ä¸Šï¼Œå¯ä»¥çœ‹åˆ°registeræ–¹æ³•æ³¨å†Œäº†ä¸€ä¸ªpackageNameså³è‡ªåŠ¨é…ç½®ç±»æ³¨è§£@EnableAutoConfigurationæ‰€åœ¨çš„æ‰€åœ¨çš„åŒ…åç›¸å…³çš„beanã€‚é‚£ä¹ˆæ³¨å†Œè¿™ä¸ªbeançš„ç›®çš„æ˜¯ä¸ºäº†ä»€ä¹ˆå‘¢ï¼Ÿ ç»“åˆå®˜ç½‘æ³¨é‡ŠçŸ¥é“ï¼Œæ³¨å†Œè¿™ä¸ªè‡ªåŠ¨é…ç½®åŒ…åç›¸å…³çš„beanæ˜¯ä¸ºäº†è¢«å…¶ä»–åœ°æ–¹å¼•ç”¨ï¼Œæ¯”å¦‚JPA entity scannerï¼Œå…·ä½“æ‹¿æ¥å¹²ä»€ä¹ˆä¹…ä¸çŸ¥é“äº†ï¼Œè¿™é‡Œä¸å†æ·±ç©¶äº†ã€‚\n\n8 å°ç»“å¥½äº†ï¼ŒSpringBoot çš„è‡ªåŠ¨é…ç½®çš„æºç åˆ†æå°±åˆ°è¿™é‡Œäº†ï¼Œæ¯”è¾ƒé•¿ï¼Œæœ‰äº›åœ°æ–¹ä¹Ÿå¾ˆæ·±å…¥ç»†èŠ‚ï¼Œè¯»å®Œéœ€è¦ä¸€å®šçš„è€å¿ƒã€‚\næœ€åï¼Œæˆ‘ä»¬å†æ€»ç»“ä¸‹ SpringBoot è‡ªåŠ¨é…ç½®çš„åŸç†ï¼Œä¸»è¦åšäº†ä»¥ä¸‹äº‹æƒ…ï¼š\n\nä» spring.factories é…ç½®æ–‡ä»¶ä¸­åŠ è½½è‡ªåŠ¨é…ç½®ç±»ï¼›\nåŠ è½½çš„è‡ªåŠ¨é…ç½®ç±»ä¸­æ’é™¤æ‰@EnableAutoConfigurationæ³¨è§£çš„excludeå±æ€§æŒ‡å®šçš„è‡ªåŠ¨é…ç½®ç±»ï¼›\nç„¶åå†ç”¨AutoConfigurationImportFilteræ¥å£å»è¿‡æ»¤è‡ªåŠ¨é…ç½®ç±»æ˜¯å¦ç¬¦åˆå…¶æ ‡æ³¨æ³¨è§£ï¼ˆè‹¥æœ‰æ ‡æ³¨çš„è¯ï¼‰@ConditionalOnClass,@ConditionalOnBeanå’Œ@ConditionalOnWebApplicationçš„æ¡ä»¶ï¼Œè‹¥éƒ½ç¬¦åˆçš„è¯åˆ™è¿”å›åŒ¹é…ç»“æœï¼›\nç„¶åè§¦å‘AutoConfigurationImportEventäº‹ä»¶ï¼Œå‘Šè¯‰ConditionEvaluationReportæ¡ä»¶è¯„ä¼°æŠ¥å‘Šå™¨å¯¹è±¡æ¥åˆ†åˆ«è®°å½•ç¬¦åˆæ¡ä»¶å’Œexcludeçš„è‡ªåŠ¨é…ç½®ç±»ã€‚\næœ€å spring å†å°†æœ€åç­›é€‰åçš„è‡ªåŠ¨é…ç½®ç±»å¯¼å…¥ IOC å®¹å™¨ä¸­\n\næœ€åç•™ä¸ªè‡ªå·±çš„ç–‘é—®ï¼Œè¿˜æœ›çŸ¥é“ç­”æ¡ˆçš„å¤§ä½¬è§£ç­”ï¼Œè¿™é‡Œè¡¨ç¤ºæ„Ÿè°¢ï¼š\n\n\n\n\n\n\n\n\n\nä¸ºäº†é¿å…åŠ è½½ä¸å¿…è¦çš„è‡ªåŠ¨é…ç½®ç±»é€ æˆå†…å­˜æµªè´¹ï¼ŒFilteringSpringBootConditionç”¨äºè¿‡æ»¤spring.factoriesæ–‡ä»¶çš„è‡ªåŠ¨é…ç½®ç±»ï¼Œè€ŒFilteringSpringBootConditionä¸ºå•¥åªæœ‰OnOnBeanCondition,OnClassConditionå’ŒonWebApplicationConditionè¿™ä¸‰ä¸ªæ¡ä»¶ç±»ç”¨äºè¿‡æ»¤ï¼Œä¸ºå•¥æ²¡æœ‰onPropertyCondtionï¼ŒonResourceConditionç­‰æ¡ä»¶ç±»æ¥è¿‡æ»¤è‡ªåŠ¨é…ç½®ç±»å‘¢ï¼Ÿ\n5 SpringBootçš„é…ç½®å±æ€§å€¼æ˜¯å¦‚ä½•ç»‘å®šçš„ï¼Ÿ\n1 å‰è¨€æ¸©æ•…è€ŒçŸ¥æ–°ï¼Œæˆ‘ä»¬æ¥ç®€å•å›é¡¾ä¸€ä¸‹ä¸Šç¯‡çš„å†…å®¹ï¼Œä¸Šä¸€ç¯‡æˆ‘ä»¬åˆ†æäº† SpringBoot çš„è‡ªåŠ¨é…ç½®çš„ç›¸å…³æºç ï¼Œè‡ªåŠ¨é…ç½®ç›¸å…³æºç ä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªé‡è¦çš„æ­¥éª¤ï¼š\n\nä» spring.factories é…ç½®æ–‡ä»¶ä¸­åŠ è½½è‡ªåŠ¨é…ç½®ç±»ï¼›\nåŠ è½½çš„è‡ªåŠ¨é…ç½®ç±»ä¸­æ’é™¤æ‰@EnableAutoConfigurationæ³¨è§£çš„excludeå±æ€§æŒ‡å®šçš„è‡ªåŠ¨é…ç½®ç±»ï¼›\nç„¶åå†ç”¨AutoConfigurationImportFilteræ¥å£å»è¿‡æ»¤è‡ªåŠ¨é…ç½®ç±»æ˜¯å¦ç¬¦åˆå…¶æ ‡æ³¨æ³¨è§£ï¼ˆè‹¥æœ‰æ ‡æ³¨çš„è¯ï¼‰@ConditionalOnClass,@ConditionalOnBeanå’Œ@ConditionalOnWebApplicationçš„æ¡ä»¶ï¼Œè‹¥éƒ½ç¬¦åˆçš„è¯åˆ™è¿”å›åŒ¹é…ç»“æœï¼›\nç„¶åè§¦å‘AutoConfigurationImportEventäº‹ä»¶ï¼Œå‘Šè¯‰ConditionEvaluationReportæ¡ä»¶è¯„ä¼°æŠ¥å‘Šå™¨å¯¹è±¡æ¥åˆ†åˆ«è®°å½•ç¬¦åˆæ¡ä»¶å’Œexcludeçš„è‡ªåŠ¨é…ç½®ç±»ã€‚\næœ€å spring å†å°†æœ€åç­›é€‰åçš„è‡ªåŠ¨é…ç½®ç±»å¯¼å…¥ IOC å®¹å™¨ä¸­\n\næœ¬ç¯‡ç»§ç»­æ¥åˆ†æ SpringBoot çš„è‡ªåŠ¨é…ç½®çš„ç›¸å…³æºç ï¼Œæˆ‘ä»¬æ¥åˆ†æä¸‹@EnableConfigurationPropertieså’Œ@EnableConfigurationPropertiesè¿™ä¸¤ä¸ªæ³¨è§£ï¼Œæ¥æ¢ç©¶ä¸‹å¤–éƒ¨é…ç½®å±æ€§å€¼æ˜¯å¦‚ä½•è¢«ç»‘å®šåˆ° **@ConfigurationProperties** æ³¨è§£çš„ç±»å±æ€§ä¸­çš„ï¼Ÿ\n\n\n\n\n\n\n\n\n\nä¸¾ä¸ªæ —å­ï¼šä»¥é…ç½® web é¡¹ç›®çš„æœåŠ¡å™¨ç«¯å£ä¸ºä¾‹ï¼Œè‹¥æˆ‘ä»¬è¦å°†æœåŠ¡å™¨ç«¯å£é…ç½®ä¸º8081ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¼šåœ¨application.propertiesé…ç½®æ–‡ä»¶ä¸­é…ç½®server.port=8081ï¼Œæ­¤æ—¶è¯¥é…ç½®å€¼8081å°±å°†ä¼šç»‘å®šåˆ°è¢«@ConfigurationPropertiesæ³¨è§£çš„ç±»ServerPropertiesçš„å±æ€§portä¸Šï¼Œä»è€Œä½¿å¾—é…ç½®ç”Ÿæ•ˆã€‚\n\n2 @EnableConfigurationPropertiesæˆ‘ä»¬æ¥ç€å‰é¢çš„è®¾ç½®æœåŠ¡å™¨ç«¯å£çš„æ —å­æ¥åˆ†æï¼Œæˆ‘ä»¬å…ˆç›´æ¥æ¥çœ‹çœ‹ServerPropertiesçš„æºç ï¼Œåº”è¯¥èƒ½æ‰¾åˆ°æºç çš„å…¥å£ï¼š\n@ConfigurationProperties(prefix = \"server\", ignoreUnknownFields = true)\npublic class ServerProperties &#123;\n\t/**\n\t * Server HTTP port.\n\t */\n\tprivate Integer port;\n\t// ...çœç•¥éå…³é”®ä»£ç \n&#125;\n\nå¯ä»¥çœ‹åˆ°ï¼ŒServerPropertiesç±»ä¸Šæ ‡æ³¨äº†@ConfigurationPropertiesè¿™ä¸ªæ³¨è§£ï¼ŒæœåŠ¡å™¨å±æ€§é…ç½®å‰ç¼€ä¸ºserverï¼Œæ˜¯å¦å¿½ç•¥æœªçŸ¥çš„é…ç½®å€¼ï¼ˆignoreUnknownFieldsï¼‰è®¾ç½®ä¸ºtrueã€‚\né‚£ä¹ˆæˆ‘ä»¬å†æ¥çœ‹ä¸‹@ConfigurationPropertiesè¿™ä¸ªæ³¨è§£çš„æºç ï¼š\n@Target(&#123; ElementType.TYPE, ElementType.METHOD &#125;)\n@Retention(RetentionPolicy.RUNTIME)\n@Documented\npublic @interface ConfigurationProperties &#123;\n\n\t// å‰ç¼€åˆ«å\n\t@AliasFor(\"prefix\")\n\tString value() default \"\";\n\n\t// å‰ç¼€\n\t@AliasFor(\"value\")\n\tString prefix() default \"\";\n\n\t// å¿½ç•¥æ— æ•ˆçš„é…ç½®å±æ€§\n\tboolean ignoreInvalidFields() default false;\n\n\t// å¿½ç•¥æœªçŸ¥çš„é…ç½®å±æ€§\n\tboolean ignoreUnknownFields() default true;\n&#125;\n\n@ConfigurationPropertiesè¿™ä¸ªæ³¨è§£çš„ä½œç”¨å°±æ˜¯å°†å¤–éƒ¨é…ç½®çš„é…ç½®å€¼ç»‘å®šåˆ°å…¶æ³¨è§£çš„ç±»çš„å±æ€§ä¸Šï¼Œå¯ä»¥ä½œç”¨äºé…ç½®ç±»æˆ–é…ç½®ç±»çš„æ–¹æ³•ä¸Šã€‚å¯ä»¥çœ‹åˆ°@ConfigurationPropertiesæ³¨è§£é™¤äº†æœ‰è®¾ç½®å‰ç¼€ï¼Œæ˜¯å¦å¿½ç•¥ä¸€äº›ä¸å­˜åœ¨æˆ–æ— æ•ˆçš„é…ç½®ç­‰å±æ€§ç­‰å¤–ï¼Œè¿™ä¸ªæ³¨è§£æ²¡æœ‰å…¶ä»–ä»»ä½•çš„å¤„ç†é€»è¾‘ï¼Œå¯ä»¥çœ‹åˆ°@ConfigurationPropertiesæ˜¯ä¸€ä¸ªæ ‡å¿—æ€§çš„æ³¨è§£ï¼Œæºç å…¥å£ä¸åœ¨è¿™é‡Œã€‚\nè¿™é‡Œè®²çš„æ˜¯æœåŠ¡å™¨çš„è‡ªåŠ¨é…ç½®ï¼Œè‡ªç„¶è€Œç„¶çš„ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹è‡ªåŠ¨é…ç½®ç±»ServletWebServerFactoryAutoConfigurationçš„æºç ï¼š\n@Configuration\n@EnableConfigurationProperties(ServerProperties.class)\n// ...çœç•¥éå…³é”®æ³¨è§£\npublic class ServletWebServerFactoryAutoConfiguration &#123;\n\t// ...çœç•¥éå…³é”®ä»£ç \n&#125;\n\nä¸ºäº†çªå‡ºé‡ç‚¹ï¼Œæˆ‘å·²ç»æŠŠServletWebServerFactoryAutoConfigurationçš„éå…³é”®ä»£ç å’Œéå…³é”®æ³¨è§£çœç•¥æ‰äº†ã€‚å¯ä»¥çœ‹åˆ°ï¼ŒServletWebServerFactoryAutoConfigurationè‡ªåŠ¨é…ç½®ç±»ä¸­æœ‰ä¸€ä¸ª@EnableConfigurationPropertiesæ³¨è§£ï¼Œä¸”æ³¨è§£å€¼æ˜¯å‰é¢è®²çš„ServerProperties.classï¼Œå› æ­¤@EnableConfigurationPropertiesæ³¨è§£è‚¯å®šå°±æ˜¯æˆ‘ä»¬å…³æ³¨çš„é‡ç‚¹äº†ã€‚\nåŒæ ·ï¼Œå†æ¥çœ‹ä¸‹@EnableConfigurationPropertiesæ³¨è§£çš„æºç ï¼š\n@Target(ElementType.TYPE)\n@Retention(RetentionPolicy.RUNTIME)\n@Documented\n@Import(EnableConfigurationPropertiesImportSelector.class)\npublic @interface EnableConfigurationProperties &#123;\n\n\t// è¿™ä¸ªå€¼æŒ‡å®šçš„ç±»å°±æ˜¯@ConfigurationPropertiesæ³¨è§£æ ‡æ³¨çš„ç±»ï¼Œå…¶å°†ä¼šè¢«æ³¨å†Œåˆ°springå®¹å™¨ä¸­\n\tClass&lt;?>[] value() default &#123;&#125;;\n\n&#125;\n\n@EnableConfigurationPropertiesæ³¨è§£çš„ä¸»è¦ä½œç”¨å°±æ˜¯ä¸º@ConfigurationPropertiesæ³¨è§£æ ‡æ³¨çš„ç±»æä¾›æ”¯æŒï¼Œå³å¯¹å°†å¤–éƒ¨é…ç½®å±æ€§å€¼ï¼ˆæ¯”å¦‚ application.properties é…ç½®å€¼ï¼‰ç»‘å®šåˆ°@ConfigurationPropertiesæ ‡æ³¨çš„ç±»çš„å±æ€§ä¸­ã€‚\n\n\n\n\n\n\n\n\n\næ³¨æ„ï¼šSpringBoot æºç ä¸­è¿˜å­˜åœ¨äº†ConfigurationPropertiesAutoConfigurationè¿™ä¸ªè‡ªåŠ¨é…ç½®ç±»ï¼ŒåŒæ—¶spring.factoriesé…ç½®æ–‡ä»¶ä¸­çš„EnableAutoConfigurationæ¥å£ä¹Ÿé…ç½®äº†ConfigurationPropertiesAutoConfigurationï¼Œè¿™ä¸ªè‡ªåŠ¨é…ç½®ç±»ä¸Šä¹Ÿæœ‰@EnableConfigurationPropertiesè¿™ä¸ªæ³¨è§£ï¼Œå †å±æ€§ç»‘å®šè¿›è¡Œäº†é»˜è®¤å¼€å¯ã€‚\né‚£ä¹ˆï¼Œ**@EnableConfigurationProperties**è¿™ä¸ªæ³¨è§£å¯¹å±æ€§ç»‘å®šæä¾›æ€æ ·çš„æ”¯æŒå‘¢ï¼Ÿ\nå¯ä»¥çœ‹åˆ°@EnableConfigurationPropertiesè¿™ä¸ªæ³¨è§£ä¸Šè¿˜æ ‡æ³¨äº†@Import(EnableConfigurationPropertiesImportSelector.class)ï¼Œå…¶å¯¼å…¥äº†EnableConfigurationPropertiesImportSelectorï¼Œå› æ­¤å¯ä»¥è‚¯å®šçš„æ˜¯@EnableConfigurationPropertiesè¿™ä¸ªæ³¨è§£å¯¹å±æ€§ç»‘å®šæä¾›çš„æ”¯æŒå¿…å®šè·ŸEnableConfigurationPropertiesImportSelectoræœ‰å…³ã€‚\nåˆ°äº†è¿™é‡Œï¼ŒEnableConfigurationPropertiesImportSelectorè¿™ä¸ªå“¥ä»¬æ˜¯æˆ‘ä»¬æ¥ä¸‹æ¥è¦åˆ†æçš„å¯¹è±¡ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸‹é¢ç»§ç»­æ¥åˆ†æEnableConfigurationPropertiesImportSelectoræ˜¯å¦‚ä½•æ‰¿æ‹…å°†å¤–éƒ¨é…ç½®å±æ€§å€¼ç»‘å®šåˆ°@ConfigurationPropertiesæ ‡æ³¨çš„ç±»çš„å±æ€§ä¸­çš„ã€‚\n\n3 EnableConfigurationPropertiesImportSelectorEnableConfigurationPropertiesImportSelectorç±»çš„ä½œç”¨ä¸»è¦ç”¨æ¥å¤„ç†å¤–éƒ¨å±æ€§ç»‘å®šçš„ç›¸å…³é€»è¾‘ï¼Œå…¶å®ç°äº†ImportSelectoræ¥å£ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“ï¼Œå®ç°ImportSelectoræ¥å£çš„selectImportsæ–¹æ³•å¯ä»¥å‘å®¹å™¨ä¸­æ³¨å†Œ beanã€‚\né‚£ä¹ˆï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹EnableConfigurationPropertiesImportSelectorè¦†å†™çš„selectImportsæ–¹æ³•ï¼š\n// EnableConfigurationPropertiesImportSelector.java\n\nclass EnableConfigurationPropertiesImportSelector implements ImportSelector &#123;\n        // IMPORTSæ•°ç»„å³æ˜¯è¦å‘springå®¹å™¨ä¸­æ³¨å†Œçš„bean\n\tprivate static final String[] IMPORTS = &#123;\n\t\t\tConfigurationPropertiesBeanRegistrar.class.getName(),\n\t\t\tConfigurationPropertiesBindingPostProcessorRegistrar.class.getName() &#125;;\n\n\t@Override\n\tpublic String[] selectImports(AnnotationMetadata metadata) &#123;\n\t\t// è¿”å›ConfigurationPropertiesBeanRegistrarå’ŒConfigurationPropertiesBindingPostProcessorRegistrarçš„å…¨é™å®šå\n\t\t// å³ä¸Šé¢ä¸¤ä¸ªç±»å°†ä¼šè¢«æ³¨å†Œåˆ°Springå®¹å™¨ä¸­\n\t\treturn IMPORTS;\n\t&#125;\n\n&#125;\n\nå¯ä»¥çœ‹åˆ°EnableConfigurationPropertiesImportSelectorç±»ä¸­çš„selectImportsæ–¹æ³•ä¸­è¿”å›çš„æ˜¯IMPORTSæ•°ç»„ï¼Œè€Œè¿™ä¸ªIMPORTSæ˜¯ä¸€ä¸ªå¸¸é‡æ•°ç»„ï¼Œå€¼æ˜¯ConfigurationPropertiesBeanRegistrarå’ŒConfigurationPropertiesBindingPostProcessorRegistrarã€‚å³EnableConfigurationPropertiesImportSelectorçš„ä½œç”¨æ˜¯å‘ Spring å®¹å™¨ä¸­æ³¨å†Œäº†ConfigurationPropertiesBeanRegistrarå’ŒConfigurationPropertiesBindingPostProcessorRegistrarè¿™ä¸¤ä¸ªbeanã€‚\næˆ‘ä»¬åœ¨EnableConfigurationPropertiesImportSelectorç±»ä¸­æ²¡çœ‹åˆ°å¤„ç†å¤–éƒ¨å±æ€§ç»‘å®šçš„ç›¸å…³é€»è¾‘ï¼Œå…¶åªæ˜¯æ³¨å†Œäº†ConfigurationPropertiesBeanRegistrarå’ŒConfigurationPropertiesBindingPostProcessorRegistrarè¿™ä¸¤ä¸ªbean,æ¥ä¸‹æ¥æˆ‘ä»¬å†çœ‹ä¸‹æ³¨å†Œçš„è¿™ä¸¤ä¸ªbeanç±»ã€‚\n\n4 ConfigurationPropertiesBeanRegistraræˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹ConfigurationPropertiesBeanRegistrarè¿™ä¸ªç±»ã€‚\nConfigurationPropertiesBeanRegistraræ˜¯EnableConfigurationPropertiesImportSelectorçš„å†…éƒ¨ç±»ï¼Œå…¶å®ç°äº†ImportBeanDefinitionRegistraræ¥å£ï¼Œè¦†å†™äº†registerBeanDefinitionsæ–¹æ³•ã€‚å¯è§ï¼ŒConfigurationPropertiesBeanRegistraråˆæ˜¯ç”¨æ¥æ³¨å†Œä¸€äº›bean definitionçš„ï¼Œå³ä¹Ÿæ˜¯å‘Springå®¹å™¨ä¸­æ³¨å†Œä¸€äº› beanã€‚\nå…ˆçœ‹ä¸‹ConfigurationPropertiesBeanRegistrarçš„æºç ï¼š\n// ConfigurationPropertiesBeanRegistrar$ConfigurationPropertiesBeanRegistrar.java\n\npublic static class ConfigurationPropertiesBeanRegistrar\n\t\t\timplements ImportBeanDefinitionRegistrar &#123;\n\t@Override\n\tpublic void registerBeanDefinitions(AnnotationMetadata metadata,  // metadataæ˜¯AnnotationMetadataReadingVisitorå¯¹è±¡ï¼Œå­˜å‚¨äº†æŸä¸ªé…ç½®ç±»çš„å…ƒæ•°æ®\n\t\t\tBeanDefinitionRegistry registry) &#123;\n\t\t// ï¼ˆ1ï¼‰å¾—åˆ°@EnableConfigurationPropertiesæ³¨è§£çš„æ‰€æœ‰å±æ€§å€¼,\n\t\t// æ¯”å¦‚@EnableConfigurationProperties(ServerProperties.class),é‚£ä¹ˆå¾—åˆ°çš„å€¼æ˜¯ServerProperties.class\n\t\t// ï¼ˆ2ï¼‰ç„¶åå†å°†å¾—åˆ°çš„@EnableConfigurationPropertiesæ³¨è§£çš„æ‰€æœ‰å±æ€§å€¼æ³¨å†Œåˆ°å®¹å™¨ä¸­\n\t\tgetTypes(metadata).forEach((type) -> register(registry,\n\t\t\t\t(ConfigurableListableBeanFactory) registry, type));\n\t&#125;\n&#125;\n\nåœ¨ConfigurationPropertiesBeanRegistrarå®ç°çš„registerBeanDefinitionsä¸­ï¼Œå¯ä»¥çœ‹åˆ°ä¸»è¦åšäº†ä¸¤ä»¶äº‹ï¼š\n\nè°ƒç”¨getTypesæ–¹æ³•è·å–@EnableConfigurationPropertiesæ³¨è§£çš„å±æ€§å€¼XxxPropertiesï¼›\nè°ƒç”¨registeræ–¹æ³•å°†è·å–çš„å±æ€§å€¼XxxPropertiesæ³¨å†Œåˆ°Springå®¹å™¨ä¸­ï¼Œç”¨äºä»¥åå’Œå¤–éƒ¨å±æ€§ç»‘å®šæ—¶ä½¿ç”¨ã€‚\n\næˆ‘ä»¬æ¥çœ‹ä¸‹getTypesæ–¹æ³•çš„æºç ï¼š\n// ConfigurationPropertiesBeanRegistrar$ConfigurationPropertiesBeanRegistrar.java\n\nprivate List&lt;Class&lt;?>> getTypes(AnnotationMetadata metadata) &#123;\n\t// å¾—åˆ°@EnableConfigurationPropertiesæ³¨è§£çš„æ‰€æœ‰å±æ€§å€¼,\n\t// æ¯”å¦‚@EnableConfigurationProperties(ServerProperties.class),é‚£ä¹ˆå¾—åˆ°çš„å€¼æ˜¯ServerProperties.class\n\tMultiValueMap&lt;String, Object> attributes = metadata\n\t\t\t.getAllAnnotationAttributes(\n\t\t\t\t\tEnableConfigurationProperties.class.getName(), false);\n\t// å°†å±æ€§å€¼å–å‡ºè£…è¿›Listé›†åˆå¹¶è¿”å›\n\treturn collectClasses((attributes != null) ? attributes.get(\"value\")\n\t\t\t: Collections.emptyList());\n&#125;\n\ngetTypesæ–¹æ³•é‡Œé¢çš„é€»è¾‘å¾ˆç®€å•å³å°†@EnableConfigurationPropertiesæ³¨è§£é‡Œé¢çš„å±æ€§å€¼XxxPropertiesï¼ˆæ¯”å¦‚ServerProperties.classï¼‰å–å‡ºå¹¶è£…è¿›Listé›†åˆå¹¶è¿”å›ã€‚\nç”±getTypesæ–¹æ³•æ‹¿åˆ°@EnableConfigurationPropertiesæ³¨è§£é‡Œé¢çš„å±æ€§å€¼XxxPropertiesï¼ˆæ¯”å¦‚ServerProperties.classï¼‰åï¼Œæ­¤æ—¶å†éå†å°†XxxPropertiesé€ä¸ªæ³¨å†Œè¿›Springå®¹å™¨ä¸­ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹registeræ–¹æ³•ï¼š\n// ConfigurationPropertiesBeanRegistrar$ConfigurationPropertiesBeanRegistrar.java\n\nprivate void register(BeanDefinitionRegistry registry,\n\t\tConfigurableListableBeanFactory beanFactory, Class&lt;?> type) &#123;\n\t// å¾—åˆ°typeçš„åå­—ï¼Œä¸€èˆ¬ç”¨ç±»çš„å…¨é™å®šåä½œä¸ºbean name\n\tString name = getName(type);\n\t// æ ¹æ®bean nameåˆ¤æ–­beanFactoryå®¹å™¨ä¸­æ˜¯å¦åŒ…å«è¯¥bean\n\tif (!containsBeanDefinition(beanFactory, name)) &#123;\n\t\t// è‹¥ä¸åŒ…å«ï¼Œé‚£ä¹ˆæ³¨å†Œbean definition\n\t\tregisterBeanDefinition(registry, name, type);\n\t&#125;\n&#125;\n\næˆ‘ä»¬å†æ¥çœ‹ä¸‹ç”±EnableConfigurationPropertiesImportSelectorå¯¼å…¥çš„å¦ä¸€ä¸ªç±»ConfigurationPropertiesBindingPostProcessorRegistraråˆæ˜¯å¹²å˜›çš„å‘¢ï¼Ÿ\n\n5 ConfigurationPropertiesBindingPostProcessorRegistrarå¯ä»¥çœ‹åˆ°ConfigurationPropertiesBindingPostProcessorRegistrarç±»åå­—åˆæ˜¯ä»¥Registrarå•è¯ä¸ºç»“å°¾ï¼Œè¯´æ˜å…¶è‚¯å®šåˆæ˜¯å¯¼å…¥ä¸€äº›bean definitionçš„ã€‚ç›´æ¥çœ‹æºç ï¼š\n// ConfigurationPropertiesBindingPostProcessorRegistrar.java\n\npublic class ConfigurationPropertiesBindingPostProcessorRegistrar\n\t\timplements ImportBeanDefinitionRegistrar &#123;\n\n\t@Override\n\tpublic void registerBeanDefinitions(AnnotationMetadata importingClassMetadata,\n\t\t\tBeanDefinitionRegistry registry) &#123;\n\t\t// è‹¥å®¹å™¨ä¸­æ²¡æœ‰æ³¨å†ŒConfigurationPropertiesBindingPostProcessorè¿™ä¸ªå¤„ç†å±æ€§ç»‘å®šçš„åç½®å¤„ç†å™¨ï¼Œ\n\t\t// é‚£ä¹ˆå°†æ³¨å†ŒConfigurationPropertiesBindingPostProcessorå’ŒConfigurationBeanFactoryMetadataè¿™ä¸¤ä¸ªbean\n\t\t// æ³¨æ„onApplicationEnvironmentPreparedEventäº‹ä»¶åŠ è½½é…ç½®å±æ€§åœ¨å…ˆï¼Œç„¶åå†æ³¨å†Œä¸€äº›åç½®å¤„ç†å™¨ç”¨æ¥å¤„ç†è¿™äº›é…ç½®å±æ€§\n\t\tif (!registry.containsBeanDefinition(\n\t\t\t\tConfigurationPropertiesBindingPostProcessor.BEAN_NAME)) &#123;\n\t\t\t// (1)æ³¨å†ŒConfigurationPropertiesBindingPostProcessoråç½®å¤„ç†å™¨ï¼Œç”¨æ¥å¯¹é…ç½®å±æ€§è¿›è¡Œåç½®å¤„ç†\n\t\t\tregisterConfigurationPropertiesBindingPostProcessor(registry);\n\t\t\t// (2)æ³¨å†Œä¸€ä¸ªConfigurationBeanFactoryMetadataç±»å‹çš„beanï¼Œ\n\t\t\t// æ³¨æ„ConfigurationBeanFactoryMetadataå®ç°äº†BeanFactoryPostProcessorï¼Œç„¶åå…¶ä¼šåœ¨postProcessBeanFactoryä¸­æ³¨å†Œä¸€äº›å…ƒæ•°æ®\n\t\t\tregisterConfigurationBeanFactoryMetadata(registry);\n\t\t&#125;\n\t&#125;\n\t// æ³¨å†ŒConfigurationPropertiesBindingPostProcessoråç½®å¤„ç†å™¨\n\tprivate void registerConfigurationPropertiesBindingPostProcessor(\n\t\t\tBeanDefinitionRegistry registry) &#123;\n\t\tGenericBeanDefinition definition = new GenericBeanDefinition();\n\t\tdefinition.setBeanClass(ConfigurationPropertiesBindingPostProcessor.class);\n\t\tdefinition.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);\n\t\tregistry.registerBeanDefinition(\n\t\t\t\tConfigurationPropertiesBindingPostProcessor.BEAN_NAME, definition);\n\n\t&#125;\n\t// æ³¨å†ŒConfigurationBeanFactoryMetadataåç½®å¤„ç†å™¨\n\tprivate void registerConfigurationBeanFactoryMetadata(\n\t\t\tBeanDefinitionRegistry registry) &#123;\n\t\tGenericBeanDefinition definition = new GenericBeanDefinition();\n\t\tdefinition.setBeanClass(ConfigurationBeanFactoryMetadata.class);\n\t\tdefinition.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);\n\t\tregistry.registerBeanDefinition(ConfigurationBeanFactoryMetadata.BEAN_NAME,\n\t\t\t\tdefinition);\n\t&#125;\n\n&#125;\n\nConfigurationPropertiesBindingPostProcessorRegistrarç±»çš„é€»è¾‘éå¸¸ç®€å•ï¼Œä¸»è¦ç”¨æ¥æ³¨å†Œå¤–éƒ¨é…ç½®å±æ€§ç»‘å®šç›¸å…³çš„åç½®å¤„ç†å™¨å³ConfigurationBeanFactoryMetadataå’ŒConfigurationPropertiesBindingPostProcessorã€‚\né‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬å†æ¥æ¢ç©¶ä¸‹æ³¨å†Œçš„è¿™ä¸¤ä¸ªåç½®å¤„ç†å™¨åˆæ˜¯æ‰§è¡Œæ€æ ·çš„åç½®å¤„ç†é€»è¾‘å‘¢ï¼Ÿ\n\n6 ConfigurationBeanFactoryMetadataå…ˆæ¥çœ‹ConfigurationBeanFactoryMetadataè¿™ä¸ªåç½®å¤„ç†å™¨ï¼Œå…¶å®ç°äº†BeanFactoryPostProcessoræ¥å£çš„postProcessBeanFactoryæ–¹æ³•ï¼Œåœ¨åˆå§‹åŒ–bean factoryæ—¶å°†@Beanæ³¨è§£çš„å…ƒæ•°æ®å­˜å‚¨èµ·æ¥ï¼Œä»¥ä¾¿åœ¨åç»­çš„å¤–éƒ¨é…ç½®å±æ€§ç»‘å®šçš„ç›¸å…³é€»è¾‘ä¸­ä½¿ç”¨ã€‚\nå…ˆæ¥çœ‹ä¸‹ConfigurationBeanFactoryMetadataç±»å®ç°BeanFactoryPostProcessoræ¥å£çš„postProcessBeanFactoryæ–¹æ³•æºç ï¼š\n// ConfigurationBeanFactoryMetadata\n\npublic class ConfigurationBeanFactoryMetadata implements BeanFactoryPostProcessor &#123;\n\n\t/**\n\t * The bean name that this class is registered with.\n\t */\n\tpublic static final String BEAN_NAME = ConfigurationBeanFactoryMetadata.class\n\t\t\t.getName();\n\n\tprivate ConfigurableListableBeanFactory beanFactory;\n\t/**\n\t * beansFactoryMetadataé›†åˆå­˜å‚¨beansFactoryçš„å…ƒæ•°æ®\n\t * key:æŸä¸ªbeançš„åå­—  valueï¼šFactoryMetadataå¯¹è±¡ï¼ˆå°è£…äº†å·¥å‚beanåå’Œå·¥å‚æ–¹æ³•åï¼‰\n\t * æ¯”å¦‚ä¸‹é¢è¿™ä¸ªé…ç½®ç±»ï¼š\n\t *\n\t * @Configuration\n\t * public class ConfigA &#123;\n\t *      @Bean\n\t *      public BeanXXX methodBï¼ˆconfigA, ï¼‰ &#123;\n\t *          return new BeanXXX();\n\t *      &#125;\n\t * &#125;\n\t *\n\t * é‚£ä¹ˆï¼škeyå€¼ä¸º\"methodB\"ï¼Œvalueä¸ºFactoryMetadataï¼ˆconfigA, methodBï¼‰å¯¹è±¡ï¼Œå…¶beanå±æ€§å€¼ä¸º\"configA\",methodå±æ€§å€¼ä¸º\"methodB\"\n\t */\n\tprivate final Map&lt;String, FactoryMetadata> beansFactoryMetadata = new HashMap&lt;>();\n\n\t@Override\n\tpublic void postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory)\n\t\t\tthrows BeansException &#123;\n\t\tthis.beanFactory = beanFactory;\n\t\t// éå†beanFactoryçš„beanDefinitionNameï¼Œå³æ¯ä¸ªbeançš„åå­—ï¼ˆæ¯”å¦‚å·¥å‚æ–¹æ³•å¯¹åº”çš„beanåå­—ï¼‰\n\t\tfor (String name : beanFactory.getBeanDefinitionNames()) &#123;\n\t\t\t// æ ¹æ®nameå¾—åˆ°beanDefinition\n\t\t\tBeanDefinition definition = beanFactory.getBeanDefinition(name);\n\t\t\t// å·¥å‚æ–¹æ³•åï¼šä¸€èˆ¬æ˜¯æ³¨è§£@Beançš„æ–¹æ³•å\n\t\t\tString method = definition.getFactoryMethodName();\n\t\t\t// å·¥å‚beanåï¼šä¸€èˆ¬æ˜¯æ³¨è§£@Configurationçš„ç±»å\n\t\t\tString bean = definition.getFactoryBeanName();\n\t\t\tif (method != null &amp;&amp; bean != null) &#123;\n\t\t\t\t// å°†beanDefinitionNameä½œä¸ºKeyï¼Œå°è£…äº†å·¥å‚beanåå’Œå·¥å‚æ–¹æ³•åçš„FactoryMetadataå¯¹è±¡ä½œä¸ºvalueè£…å…¥beansFactoryMetadataä¸­\n\t\t\t\tthis.beansFactoryMetadata.put(name, new FactoryMetadata(bean, method));\n\t\t\t&#125;\n\t\t&#125;\n\t&#125;\n&#125;\n\nä»ä¸Šé¢ä»£ç å¯ä»¥çœ‹åˆ°ConfigurationBeanFactoryMetadataç±»è¦†å†™çš„postProcessBeanFactoryæ–¹æ³•åšçš„äº‹æƒ…å°±æ˜¯å°†å·¥å‚Beanï¼ˆå¯ä»¥ç†è§£ä¸º@Configurationæ³¨è§£çš„ç±»ï¼‰åŠå…¶@Beanæ³¨è§£çš„å·¥å‚æ–¹æ³•çš„ä¸€äº›å…ƒæ•°æ®ç¼“å­˜åˆ°beansFactoryMetadataé›†åˆä¸­ï¼Œä»¥ä¾¿åç»­ä½¿ç”¨ï¼Œè¿™ä¸ªåé¢ä¼šè¯¦è¿°ã€‚\nç”±ä¸Šä»£ç ä¸­æˆ‘ä»¬çœ‹åˆ°äº†ConfigurationBeanFactoryMetadataç±»çš„beansFactoryMetadataé›†åˆç±»å‹æ˜¯Map&lt;String, FactoryMetadata&gt;ï¼Œé‚£ä¹ˆæˆ‘ä»¬å†æ¥çœ‹ä¸‹å°è£…ç›¸å…³å·¥å‚å…ƒæ•°æ®çš„FactoryMetadataç±»ï¼š\n// ConfigurationBeanFactoryMetadata$FactoryMetadata.java\n\nprivate static class FactoryMetadata &#123;\n\t// @Configurationæ³¨è§£çš„é…ç½®ç±»çš„ç±»å\n\tprivate final String bean;\n\t// @Beanæ³¨è§£çš„æ–¹æ³•å\n\tprivate final String method;\n\n\tFactoryMetadata(String bean, String method) &#123;\n\t\tthis.bean = bean;\n\t\tthis.method = method;\n\t&#125;\n\n\tpublic String getBean() &#123;\n\t\treturn this.bean;\n\t&#125;\n\n\tpublic String getMethod() &#123;\n\t\treturn this.method;\n\t&#125;\n\n&#125;\n\nFactoryMetadataä»…æœ‰ä¸¤ä¸ªå±æ€§beanå’Œmethod,åˆ†åˆ«è¡¨ç¤º@Configurationæ³¨è§£çš„å·¥å‚beanå’Œ@Beanæ³¨è§£çš„å·¥å‚æ–¹æ³•ã€‚\nä¸Šé¢è¯´äº†é‚£ä¹ˆå¤šï¼Œç›´æ¥ä¸¾ä¸ªæ —å­ä¼šæ›´ç›´è§‚ï¼š\n/**\n * beansFactoryMetadataé›†åˆå­˜å‚¨beansFactoryçš„å…ƒæ•°æ®\n * key:æŸä¸ªbeançš„åå­—  valueï¼šFactoryMetadataå¯¹è±¡ï¼ˆå°è£…äº†å·¥å‚beanåå’Œå·¥å‚æ–¹æ³•åï¼‰\n * æ¯”å¦‚ä¸‹é¢è¿™ä¸ªé…ç½®ç±»ï¼š\n *\n * @Configuration\n * public class ConfigA &#123;\n *      @Bean\n *      public BeanXXX methodBï¼ˆconfigA, ï¼‰ &#123;\n *          return new BeanXXX();\n *      &#125;\n * &#125;\n *\n * é‚£ä¹ˆï¼škeyå€¼ä¸º\"methodB\"ï¼Œvalueä¸ºFactoryMetadataï¼ˆconfigA, methodBï¼‰å¯¹è±¡ï¼Œå…¶beanå±æ€§å€¼ä¸º\"configA\",methodå±æ€§å€¼ä¸º\"methodB\"\n */\n private final Map&lt;String, FactoryMetadata> beansFactoryMetadata = new HashMap&lt;>();\n\nä¸ºäº†æ›´å¥½ç†è§£ä¸Šé¢beansFactoryMetadataé›†åˆå­˜å‚¨çš„æ•°æ®æ˜¯å•¥ï¼Œå»ºè®®æœ€å¥½è‡ªå·±åŠ¨æ‰‹è°ƒè¯•çœ‹çœ‹å…¶é‡Œé¢è£…çš„æ˜¯ä»€ä¹ˆå“¦ã€‚æ€»ä¹‹è¿™é‡Œè®°ä½ä¸€ç‚¹å°±å¥½äº†ï¼šConfigurationBeanFactoryMetadataç±»çš„beansFactoryMetadataé›†åˆå­˜å‚¨çš„æ˜¯å·¥å‚beançš„ç›¸å…³å…ƒæ•°æ®ï¼Œä»¥ä¾¿åœ¨ConfigurationPropertiesBindingPostProcessoråç½®å¤„ç†å™¨ä¸­ä½¿ç”¨ã€‚\n\n7 ConfigurationPropertiesBindingPostProcessoræˆ‘ä»¬å†æ¥çœ‹ä¸‹ConfigurationPropertiesBindingPostProcessorRegistrarç±»æ³¨å†Œçš„å¦å¤–ä¸€ä¸ªåç½®å¤„ç†å™¨ConfigurationPropertiesBindingPostProcessorï¼Œè¿™ä¸ªåç½®å¤„ç†å™¨å°±å°¤å…¶é‡è¦äº†ï¼Œä¸»è¦æ‰¿æ‹…äº†å°†å¤–éƒ¨é…ç½®å±æ€§ç»‘å®šåˆ°**@ConfigurationProperties**æ³¨è§£æ ‡æ³¨çš„ XxxProperties ç±»çš„å±æ€§ä¸­ï¼ˆæ¯”å¦‚application.propertiesé…ç½®æ–‡ä»¶ä¸­è®¾ç½®äº†server.port=8081,é‚£ä¹ˆ8081å°†ä¼šç»‘å®šåˆ°ServerPropertiesç±»çš„portå±æ€§ä¸­ï¼‰çš„å®ç°é€»è¾‘ã€‚\nåŒæ ·ï¼Œå…ˆæ¥çœ‹ä¸‹ConfigurationPropertiesBindingPostProcessorçš„æºç ï¼š\n// ConfigurationPropertiesBindingPostProcessor.java\n\npublic class ConfigurationPropertiesBindingPostProcessor implements BeanPostProcessor,\n\tPriorityOrdered, ApplicationContextAware, InitializingBean &#123;\n\t@Override\n\tpublic void afterPropertiesSet() throws Exception &#123;\n\t    // ...è¿™é‡Œçœç•¥å®ç°ä»£ç å…ˆ\n\t&#125;\n\n\t@Override\n\tpublic Object postProcessBeforeInitialization(Object bean, String beanName) &#123;\n\t    // ...è¿™é‡Œçœç•¥å®ç°ä»£ç å…ˆ\n\t&#125;\n\n\t// ...çœç•¥éå…³é”®ä»£ç \n&#125;\n\nå¯ä»¥çœ‹åˆ°ConfigurationPropertiesBindingPostProcessoråç½®å¤„ç†å™¨å®ç°äº†ä¸¤ä¸ªé‡è¦çš„æ¥å£InitializingBeanå’ŒBeanPostProcessorã€‚\næˆ‘ä»¬éƒ½çŸ¥é“ï¼š\n\nInitializingBeanæ¥å£çš„afterPropertiesSetæ–¹æ³•ä¼šåœ¨beanå±æ€§èµ‹å€¼åè°ƒç”¨ï¼Œç”¨æ¥æ‰§è¡Œä¸€äº›è‡ªå®šä¹‰çš„åˆå§‹åŒ–é€»è¾‘æ¯”å¦‚æ£€æŸ¥æŸäº›å¼ºåˆ¶çš„å±æ€§æ˜¯å¦æœ‰è¢«èµ‹å€¼ï¼Œæ ¡éªŒæŸäº›é…ç½®æˆ–ç»™ä¸€äº›æœªè¢«èµ‹å€¼çš„å±æ€§èµ‹å€¼ã€‚\nBeanPostProcessoræ¥å£æ˜¯beançš„åç½®å¤„ç†å™¨ï¼Œå…¶æœ‰postProcessBeforeInitializationå’ŒpostProcessAfterInitializationä¸¤ä¸ªå‹¾å­æ–¹æ³•ï¼Œåˆ†åˆ«ä¼šåœ¨beanåˆå§‹åŒ–å‰åè¢«è°ƒç”¨æ¥æ‰§è¡Œä¸€äº›åç½®å¤„ç†é€»è¾‘ï¼Œæ¯”å¦‚æ£€æŸ¥æ ‡è®°æ¥å£æˆ–æ˜¯å¦ç”¨ä»£ç†åŒ…è£…äº†beanã€‚\n\nåŒæ—¶ç”±ä¸Šä»£ç å¯ä»¥çœ‹åˆ°ConfigurationPropertiesBindingPostProcessoråç½®å¤„ç†å™¨è¦†å†™äº†InitializingBeançš„afterPropertiesSetæ–¹æ³•å’ŒBeanPostProcessorçš„postProcessBeforeInitializationæ–¹æ³•ã€‚\næ¥ä¸‹æ¥æˆ‘ä»¬å†æ¥æ¢ç©¶ConfigurationPropertiesBindingPostProcessoråç½®å¤„ç†å™¨è¦†å†™çš„ä¸¤ä¸ªæ–¹æ³•çš„æºç ã€‚\n\n7.1 åœ¨æ‰§è¡Œå¤–éƒ¨å±æ€§ç»‘å®šé€»è¾‘å‰å…ˆå‡†å¤‡å¥½ç›¸å…³å…ƒæ•°æ®å’Œé…ç½®å±æ€§ç»‘å®šå™¨æˆ‘ä»¬å…ˆæ¥åˆ†æä¸‹ConfigurationPropertiesBindingPostProcessorè¦†å†™InitializingBeanæ¥å£çš„afterPropertiesSetæ–¹æ³•ï¼š\n// ConfigurationPropertiesBindingPostProcessor.java\n\n        /**\n\t * é…ç½®å±æ€§æ ¡éªŒå™¨åå­—\n\t */\n\tpublic static final String VALIDATOR_BEAN_NAME = \"configurationPropertiesValidator\";\n\t/**\n\t * å·¥å‚beanç›¸å…³å…ƒæ•°æ®\n\t */\n\tprivate ConfigurationBeanFactoryMetadata beanFactoryMetadata;\n\t/**\n\t * ä¸Šä¸‹æ–‡\n\t */\n\tprivate ApplicationContext applicationContext;\n\t/**\n\t * é…ç½®å±æ€§ç»‘å®šå™¨\n\t */\n\tprivate ConfigurationPropertiesBinder configurationPropertiesBinder;\n\n\n    // è¿™é‡Œä¸»è¦æ˜¯ç»™beanFactoryMetadataå’ŒconfigurationPropertiesBinderçš„å±æ€§èµ‹å€¼ï¼Œç”¨äºåé¢çš„åç½®å¤„ç†å™¨æ–¹æ³•å¤„ç†å±æ€§ç»‘å®šçš„æ—¶å€™ç”¨\n\t@Override\n\tpublic void afterPropertiesSet() throws Exception &#123;\n\t\t// We can't use constructor injection of the application context because\n\t\t// it causes eager factory bean initialization\n\t\t// ã€1ã€‘åˆ©ç”¨afterPropertiesSetè¿™ä¸ªå‹¾å­æ–¹æ³•ä»å®¹å™¨ä¸­è·å–ä¹‹å‰æ³¨å†Œçš„ConfigurationBeanFactoryMetadataå¯¹è±¡èµ‹ç»™beanFactoryMetadataå±æ€§\n\t\t// ï¼ˆé—®1ï¼‰beanFactoryMetadataè¿™ä¸ªbeanæ˜¯ä»€ä¹ˆæ—¶å€™æ³¨å†Œåˆ°å®¹å™¨ä¸­çš„ï¼Ÿ\n\t\t// ï¼ˆç­”1ï¼‰åœ¨ConfigurationPropertiesBindingPostProcessorRegistrarç±»çš„registerBeanDefinitionsæ–¹æ³•ä¸­å°†beanFactoryMetadataè¿™ä¸ªbeanæ³¨å†Œåˆ°å®¹å™¨ä¸­\n\t\t// ï¼ˆé—®2ï¼‰ä»å®¹å™¨ä¸­è·å–beanFactoryMetadataå¯¹è±¡åï¼Œä»€ä¹ˆæ—¶å€™ä¼šè¢«ç”¨åˆ°ï¼Ÿ\n\t\t// ï¼ˆç­”2ï¼‰beanFactoryMetadataå¯¹è±¡çš„beansFactoryMetadataé›†åˆä¿å­˜çš„å·¥å‚beanç›¸å…³çš„å…ƒæ•°æ®ï¼Œåœ¨ConfigurationPropertiesBindingPostProcessorç±»\n\t\t//        è¦åˆ¤æ–­æŸä¸ªbeanæ˜¯å¦æœ‰FactoryAnnotationæˆ–FactoryMethodæ—¶ä¼šæ ¹æ®è¿™ä¸ªbeanFactoryMetadataå¯¹è±¡çš„beansFactoryMetadataé›†åˆçš„å…ƒæ•°æ®æ¥æŸ¥æ‰¾\n\t\tthis.beanFactoryMetadata = this.applicationContext.getBean(\n\t\t\t\tConfigurationBeanFactoryMetadata.BEAN_NAME,\n\t\t\t\tConfigurationBeanFactoryMetadata.class);\n\t\t// ã€2ã€‘newä¸€ä¸ªConfigurationPropertiesBinderï¼Œç”¨äºåé¢çš„å¤–éƒ¨å±æ€§ç»‘å®šæ—¶ä½¿ç”¨\n\t\tthis.configurationPropertiesBinder = new ConfigurationPropertiesBinder(\n\t\t\t\tthis.applicationContext, VALIDATOR_BEAN_NAME); // VALIDATOR_BEAN_NAME=\"configurationPropertiesValidator\"\n\t&#125;\n\nå¯ä»¥çœ‹åˆ°ä»¥ä¸Šä»£ç ä¸»è¦é€»è¾‘å°±æ˜¯åœ¨æ‰§è¡Œå¤–éƒ¨å±æ€§ç»‘å®šé€»è¾‘å‰å…ˆå‡†å¤‡å¥½ç›¸å…³å…ƒæ•°æ®å’Œé…ç½®å±æ€§ç»‘å®šå™¨ï¼Œå³ä»Springå®¹å™¨ä¸­è·å–åˆ°ä¹‹å‰æ³¨å†Œçš„ConfigurationBeanFactoryMetadataå¯¹è±¡èµ‹ç»™ConfigurationPropertiesBindingPostProcessoråç½®å¤„ç†å™¨çš„beanFactoryMetadataå±æ€§,è¿˜æœ‰å°±æ˜¯æ–°å»ºä¸€ä¸ªConfigurationPropertiesBinderé…ç½®å±æ€§ç»‘å®šå™¨å¯¹è±¡å¹¶èµ‹å€¼ç»™configurationPropertiesBinderå±æ€§ã€‚\næˆ‘ä»¬å†æ¥çœ‹ä¸‹ConfigurationPropertiesBinderè¿™ä¸ªé…ç½®å±æ€§ç»‘å®šå™¨å¯¹è±¡æ˜¯å¦‚ä½•æ„é€ çš„ã€‚\n// ConfigurationPropertiesBinder.java\n\nConfigurationPropertiesBinder(ApplicationContext applicationContext,\n\t\tString validatorBeanName) &#123;\n\tthis.applicationContext = applicationContext;\n\t// å°†applicationContextå°è£…åˆ°PropertySourcesDeducerå¯¹è±¡ä¸­å¹¶è¿”å›\n\tthis.propertySources = new PropertySourcesDeducer(applicationContext)\n\t\t\t.getPropertySources(); // è·å–å±æ€§æºï¼Œä¸»è¦ç”¨äºåœ¨ConfigurableListableBeanFactoryçš„åç½®å¤„ç†æ–¹æ³•postProcessBeanFactoryä¸­å¤„ç†\n\t// å¦‚æœæ²¡æœ‰é…ç½®validatorçš„è¯ï¼Œè¿™é‡Œä¸€èˆ¬è¿”å›çš„æ˜¯null\n\tthis.configurationPropertiesValidator = getConfigurationPropertiesValidator(\n\t\t\tapplicationContext, validatorBeanName);\n\t// æ£€æŸ¥å®ç°JSR-303è§„èŒƒçš„beanæ ¡éªŒå™¨ç›¸å…³ç±»åœ¨classpathä¸­æ˜¯å¦å­˜åœ¨\n\tthis.jsr303Present = ConfigurationPropertiesJsr303Validator\n\t\t\t.isJsr303Present(applicationContext);\n&#125;\n\nå¯ä»¥çœ‹åˆ°åœ¨æ„é€ ConfigurationPropertiesBinderå¯¹è±¡æ—¶ä¸»è¦ç»™å…¶ç›¸å…³å±æ€§èµ‹å€¼ï¼ˆä¸€èˆ¬æ„é€ å™¨é€»è¾‘éƒ½æ˜¯è¿™æ ·ï¼‰ï¼š\n\nç»™applicationContextå±æ€§èµ‹å€¼æ³¨å…¥ä¸Šä¸‹æ–‡å¯¹è±¡ï¼›\nç»™propertySourceså±æ€§èµ‹å€¼ï¼Œå±æ€§æºå³å¤–éƒ¨é…ç½®å€¼æ¯”å¦‚application.propertiesé…ç½®çš„å±æ€§å€¼ï¼Œæ³¨æ„è¿™é‡Œçš„å±æ€§æºæ˜¯ç”±ConfigFileApplicationListenerè¿™ä¸ªç›‘å¬å™¨è´Ÿè´£è¯»å–çš„ï¼ŒConfigFileApplicationListenerå°†ä¼šåœ¨åé¢æºç åˆ†æç« èŠ‚ä¸­è¯¦è¿°ã€‚\nç»™configurationPropertiesValidatorå±æ€§èµ‹å€¼ï¼Œå€¼æ¥è‡ªSpringå®¹å™¨ä¸­åä¸ºconfigurationPropertiesValidatorçš„beanã€‚\nç»™jsr303Presentå±æ€§èµ‹å€¼ï¼Œå½“javax.validation.Validator,javax.validation.ValidatorFactoryå’Œjavax.validation.bootstrap.GenericBootstrap&quot;è¿™ä¸‰ä¸ªç±»åŒæ—¶å­˜åœ¨äºclasspathä¸­jsr303Presentå±æ€§å€¼æ‰ä¸ºtrueã€‚\n\n\n\n\n\n\n\n\n\n\nå…³äº JSR303ï¼šJSR-303æ˜¯ JAVA EE 6 ä¸­çš„ä¸€é¡¹å­è§„èŒƒï¼Œå«åšBean Validationï¼ŒHibernate Validatoræ˜¯Bean Validationçš„å‚è€ƒå®ç° ã€‚Hibernate Validatoræä¾›äº†JSR 303è§„èŒƒä¸­æ‰€æœ‰å†…ç½®constraint çš„å®ç°ï¼Œé™¤æ­¤ä¹‹å¤–è¿˜æœ‰ä¸€äº›é™„åŠ çš„constraintã€‚\n\n7.2 æ‰§è¡ŒçœŸæ­£çš„å¤–éƒ¨å±æ€§ç»‘å®šé€»è¾‘ã€ä¸»çº¿ã€‘å‰é¢åˆ†æäº†é‚£ä¹ˆå¤šï¼Œå‘ç°éƒ½è¿˜æ²¡åˆ°å¤–éƒ¨å±æ€§ç»‘å®šçš„çœŸæ­£å¤„ç†é€»è¾‘ï¼Œå‰é¢æ­¥éª¤éƒ½æ˜¯åœ¨åšä¸€äº›å‡†å¤‡æ€§å·¥ä½œï¼Œä¸ºå¤–éƒ¨å±æ€§ç»‘å®šåšé“ºå«ã€‚\nåœ¨æ‰§è¡Œå¤–éƒ¨å±æ€§ç»‘å®šé€»è¾‘å‰ï¼Œå‡†å¤‡å¥½äº†ç›¸å…³å…ƒæ•°æ®å’Œé…ç½®å±æ€§ç»‘å®šå™¨åï¼Œæ­¤æ—¶æˆ‘ä»¬å†æ¥çœ‹çœ‹ConfigurationPropertiesBindingPostProcessorå®ç°BeanPostProcessoræ¥å£çš„postProcessBeforeInitializationåç½®å¤„ç†æ–¹æ³•äº†ï¼Œå¤–éƒ¨å±æ€§ç»‘å®šé€»è¾‘éƒ½æ˜¯åœ¨è¿™ä¸ªåç½®å¤„ç†æ–¹æ³•é‡Œå®ç°ï¼Œæ˜¯æˆ‘ä»¬å…³æ³¨çš„é‡ä¸­ä¹‹é‡ã€‚\nç›´æ¥çœ‹ä»£ç ï¼š\n// ConfigurationPropertiesBindingPostProcessor.java\n\n// å› ä¸ºæ˜¯å¤–éƒ¨é…ç½®å±æ€§åç½®å¤„ç†å™¨ï¼Œå› æ­¤è¿™é‡Œå¯¹@ConfigurationPropertiesæ³¨è§£æ ‡æ³¨çš„XxxPropertiesç±»è¿›è¡Œåç½®å¤„ç†å®Œæˆå±æ€§ç»‘å®š\n@Override\npublic Object postProcessBeforeInitialization(Object bean, String beanName)\n\t\tthrows BeansException &#123;\n\t// æ³¨æ„ï¼ŒBeanPostProcessoråç½®å¤„ç†å™¨é»˜è®¤ä¼šå¯¹æ‰€æœ‰çš„beanè¿›è¡Œå¤„ç†ï¼Œå› æ­¤éœ€è¦æ ¹æ®beançš„ä¸€äº›æ¡ä»¶è¿›è¡Œè¿‡æ»¤å¾—åˆ°æœ€ç»ˆè¦å¤„ç†çš„ç›®çš„beanï¼Œ\n\t// è¿™é‡Œçš„è¿‡æ»¤æ¡ä»¶å°±æ˜¯åˆ¤æ–­æŸä¸ªbeanæ˜¯å¦æœ‰@ConfigurationPropertiesæ³¨è§£\n\t// ã€1ã€‘ä»beanä¸Šè·å–@ConfigurationPropertiesæ³¨è§£,è‹¥beanæœ‰æ ‡æ³¨ï¼Œé‚£ä¹ˆè¿”å›è¯¥æ³¨è§£ï¼›è‹¥æ²¡æœ‰ï¼Œåˆ™è¿”å›Nullã€‚æ¯”å¦‚ServerPropertyä¸Šæ ‡æ³¨äº†@ConfigurationPropertiesæ³¨è§£\n\tConfigurationProperties annotation = getAnnotation(bean, beanName,\n\t\t\tConfigurationProperties.class);\n\t// ã€2ã€‘è‹¥æ ‡æ³¨æœ‰@ConfigurationPropertiesæ³¨è§£çš„beanï¼Œé‚£ä¹ˆåˆ™è¿›è¡Œè¿›ä¸€æ­¥å¤„ç†ï¼šå°†é…ç½®æ–‡ä»¶çš„é…ç½®æ³¨å…¥åˆ°beançš„å±æ€§å€¼ä¸­\n\tif (annotation != null) &#123;\n\t\t/********ä¸»çº¿ï¼Œé‡ç‚¹å…³æ³¨ã€‘********/\n\t\tbind(bean, beanName, annotation);\n\t&#125;\n\t// ã€3ã€‘è¿”å›å¤–éƒ¨é…ç½®å±æ€§å€¼ç»‘å®šåçš„beanï¼ˆä¸€èˆ¬æ˜¯XxxPropertieså¯¹è±¡ï¼‰\n\treturn bean;\n&#125;\n\nConfigurationPropertiesBindingPostProcessorç±»è¦†å†™çš„postProcessBeforeInitializationæ–¹æ³•çš„åšçš„äº‹æƒ…å°±æ˜¯å°†å¤–éƒ¨å±æ€§é…ç½®ç»‘å®šåˆ°@ConfigurationPropertiesæ³¨è§£æ ‡æ³¨çš„XxxPropertiesç±»ä¸Šï¼Œç°å…³é”®æ­¥éª¤æ€»ç»“å¦‚ä¸‹ï¼š\n\nä»beanä¸Šè·å–@ConfigurationPropertiesæ³¨è§£ï¼›\nè‹¥æ ‡æ³¨æœ‰@ConfigurationPropertiesæ³¨è§£çš„beanï¼Œé‚£ä¹ˆåˆ™è¿›è¡Œè¿›ä¸€æ­¥çš„å¤„ç†ï¼šå°†å¤–éƒ¨é…ç½®å±æ€§å€¼ç»‘å®šåˆ° bean çš„å±æ€§å€¼ä¸­åå†è¿”å›beanï¼›è‹¥æ²¡æœ‰æ ‡æ³¨æœ‰@ConfigurationPropertiesæ³¨è§£çš„beanï¼Œé‚£ä¹ˆå°†ç›´æ¥åŸæ ·è¿”å›beanã€‚\n\n\n\n\n\n\n\n\n\n\næ³¨æ„ï¼šåç½®å¤„ç†å™¨é»˜è®¤ä¼šå¯¹æ¯ä¸ªå®¹å™¨ä¸­çš„beanè¿›è¡Œåç½®å¤„ç†ï¼Œå› ä¸ºè¿™é‡Œåªé’ˆå¯¹æ ‡æ³¨æœ‰@ConfigurationPropertiesæ³¨è§£çš„beanè¿›è¡Œå¤–éƒ¨å±æ€§ç»‘å®šï¼Œå› æ­¤æ²¡æœ‰æ ‡æ³¨@ConfigurationPropertiesæ³¨è§£çš„beanå°†ä¸ä¼šè¢«å¤„ç†ã€‚\næ¥ä¸‹æ¥æˆ‘ä»¬ç´§è·Ÿä¸»çº¿ï¼Œå†æ¥çœ‹ä¸‹å¤–éƒ¨é…ç½®å±æ€§æ˜¯å¦‚ä½•ç»‘å®šåˆ°**@ConfigurationProperties**æ³¨è§£çš„**XxxProperties**ç±»å±æ€§ä¸Šçš„å‘¢ï¼Ÿ\nç›´æ¥çœ‹ä»£ç ï¼š\n// ConfigurationPropertiesBindingPostProcessor.java\n\nprivate void bind(Object bean, String beanName, ConfigurationProperties annotation) &#123;\n\t// ã€1ã€‘å¾—åˆ°beançš„ç±»å‹ï¼Œæ¯”å¦‚ServerPropertieè¿™ä¸ªbeanå¾—åˆ°çš„ç±»å‹æ˜¯ï¼šorg.springframework.boot.autoconfigure.web.ServerProperties\n\tResolvableType type = getBeanType(bean, beanName);\n\t// ã€2ã€‘è·å–beanä¸Šæ ‡æ³¨çš„@Validatedæ³¨è§£\n\tValidated validated = getAnnotation(bean, beanName, Validated.class);\n\t// è‹¥æ ‡æ³¨æœ‰@Validatedæ³¨è§£çš„è¯åˆ™è·Ÿ@ConfigurationPropertiesæ³¨è§£ä¸€èµ·ç»„æˆä¸€ä¸ªAnnotationæ•°ç»„\n\tAnnotation[] annotations = (validated != null)\n\t\t\t? new Annotation[] &#123; annotation, validated &#125;\n\t\t\t: new Annotation[] &#123; annotation &#125;;\n\t// ã€3ã€‘è¿”å›ä¸€ä¸ªç»‘å®šäº†XxxPropertiesç±»çš„Bindableå¯¹è±¡targetï¼Œè¿™ä¸ªtargetå¯¹è±¡å³è¢«å¤–éƒ¨å±æ€§å€¼æ³¨å…¥çš„ç›®æ ‡å¯¹è±¡\n\t// ï¼ˆæ¯”å¦‚å°è£…äº†æ ‡æ³¨æœ‰@ConfigurationPropertiesæ³¨è§£çš„ServerPropertieså¯¹è±¡çš„Bindableå¯¹è±¡ï¼‰\n\tBindable&lt;?> target = Bindable.of(type).withExistingValue(bean)\n\t\t\t.withAnnotations(annotations); // è®¾ç½®annotationså±æ€§æ•°ç»„\n\ttry &#123;\n\t\t// ã€4ã€‘æ‰§è¡Œå¤–éƒ¨é…ç½®å±æ€§ç»‘å®šé€»è¾‘\n\t\t/********ã€ä¸»çº¿ï¼Œé‡ç‚¹å…³æ³¨ã€‘********/\n\t\tthis.configurationPropertiesBinder.bind(target);\n\t&#125;\n\tcatch (Exception ex) &#123;\n\t\tthrow new ConfigurationPropertiesBindException(beanName, bean, annotation,\n\t\t\t\tex);\n\t&#125;\n&#125;\n\n\nå…³é”®æ­¥éª¤ä¸Šé¢ä»£ç å·²ç»æ ‡æ³¨ã€xã€‘ï¼Œè¿™é‡Œåœ¨ç»§ç»­è®²è§£å¤–éƒ¨é…ç½®å±æ€§ç»‘å®šçš„ä¸»çº¿é€»è¾‘(åœ¨ 8 ConfigurationPropertiesBinder è¿™ä¸€å°èŠ‚åˆ†æ )å‰å…ˆç©¿æ’ä¸€ä¸ªçŸ¥è¯†ç‚¹ï¼Œè¿˜è®°å¾—ConfigurationBeanFactoryMetadataè¦†å†™çš„postProcessBeanFactoryæ–¹æ³•é‡Œå·²ç»å°†ç›¸å…³å·¥å‚beançš„å…ƒæ•°æ®å°è£…åˆ°ConfigurationBeanFactoryMetadataç±»çš„beansFactoryMetadataé›†åˆè¿™ä¸€å›äº‹å—ï¼Ÿ\næˆ‘ä»¬å†æ¥çœ‹ä¸‹ä¸Šé¢ä»£ç ä¸­çš„ã€1ã€‘getBeanTypeå’Œã€2ã€‘getAnnotationæ–¹æ³•æºç ï¼š\n// ConfigurationPropertiesBindingPostProcessor.java\n\nprivate ResolvableType getBeanType(Object bean, String beanName) &#123;\n\t// é¦–å…ˆè·å–æœ‰æ²¡æœ‰å·¥å‚æ–¹æ³•\n\tMethod factoryMethod = this.beanFactoryMetadata.findFactoryMethod(beanName);\n\t// è‹¥æœ‰å·¥å‚æ–¹æ³•\n\tif (factoryMethod != null) &#123;\n\t\treturn ResolvableType.forMethodReturnType(factoryMethod);\n\t&#125;\n\t// æ²¡æœ‰å·¥å‚æ–¹æ³•ï¼Œåˆ™è¯´æ˜æ˜¯æ™®é€šçš„é…ç½®ç±»\n\treturn ResolvableType.forClass(bean.getClass());\n&#125;\n\nprivate &lt;A extends Annotation> A getAnnotation(Object bean, String beanName,\n\t\tClass&lt;A> type) &#123;\n\tA annotation = this.beanFactoryMetadata.findFactoryAnnotation(beanName, type);\n\tif (annotation == null) &#123;\n\t\tannotation = AnnotationUtils.findAnnotation(bean.getClass(), type);\n\t&#125;\n\treturn annotation;\n&#125;\n\n\næ³¨æ„åˆ°ä¸Šé¢ä»£ç ä¸­çš„beanFactoryMetadataå¯¹è±¡æ²¡ï¼ŒConfigurationPropertiesBindingPostProcessoråç½®å¤„ç†å™¨çš„getBeanTypeå’ŒgetAnnotationæ–¹æ³•åˆ†åˆ«ä¼šè°ƒç”¨ConfigurationBeanFactoryMetadataçš„findFactoryMethodå’ŒfindFactoryAnnotationæ–¹æ³•ï¼Œè€ŒConfigurationBeanFactoryMetadataçš„findFactoryMethodå’ŒfindFactoryAnnotationæ–¹æ³•åˆä¼šä¾èµ–å­˜å‚¨å·¥å‚beanå…ƒæ•°æ®çš„beansFactoryMetadataé›†åˆæ¥å¯»æ‰¾æ˜¯å¦æœ‰FactoryMethodå’ŒFactoryAnnotationã€‚å› æ­¤ï¼Œåˆ°è¿™é‡Œæˆ‘ä»¬å°±çŸ¥é“ä¹‹ConfigurationBeanFactoryMetadataçš„beansFactoryMetadataé›†åˆå­˜å‚¨å·¥å‚beanå…ƒæ•°æ®çš„ä½œç”¨äº†ã€‚\n\n8 ConfigurationPropertiesBinderæˆ‘ä»¬å†ç»§ç»­ç´§è·Ÿå¤–éƒ¨é…ç½®å±æ€§ç»‘å®šçš„ä¸»çº¿ï¼Œç»§ç»­å‰é¢çœ‹ 7.2 æ‰§è¡ŒçœŸæ­£çš„å¤–éƒ¨å±æ€§ç»‘å®šé€»è¾‘ä¸­çš„this.configurationPropertiesBinder.bind(target);è¿™å¥ä»£ç ï¼š\n// ConfigurationPropertiesBinder.java\n\npublic void bind(Bindable&lt;?> target) &#123;\n\t//ã€1ã€‘å¾—åˆ°@ConfigurationPropertiesæ³¨è§£\n\tConfigurationProperties annotation = target\n\t\t\t.getAnnotation(ConfigurationProperties.class);\n\tAssert.state(annotation != null,\n\t\t\t() -> \"Missing @ConfigurationProperties on \" + target);\n\t// ã€2ã€‘å¾—åˆ°Validatorå¯¹è±¡é›†åˆï¼Œç”¨äºå±æ€§æ ¡éªŒ\n\tList&lt;Validator> validators = getValidators(target);\n\t// ã€3ã€‘å¾—åˆ°BindHandlerå¯¹è±¡ï¼ˆé»˜è®¤æ˜¯IgnoreTopLevelConverterNotFoundBindHandlerå¯¹è±¡ï¼‰ï¼Œ\n\t// ç”¨äºå¯¹ConfigurationPropertiesæ³¨è§£çš„ignoreUnknownFieldsç­‰å±æ€§çš„å¤„ç†\n\tBindHandler bindHandler = getBindHandler(annotation, validators);\n\t// ã€4ã€‘å¾—åˆ°ä¸€ä¸ªBinderå¯¹è±¡ï¼Œå¹¶åˆ©ç”¨å…¶bindæ–¹æ³•æ‰§è¡Œå¤–éƒ¨å±æ€§ç»‘å®šé€»è¾‘\n\t/********************ã€ä¸»çº¿ï¼Œé‡ç‚¹å…³æ³¨ã€‘********************/\n\tgetBinder().bind(annotation.prefix(), target, bindHandler);\n&#125;\n\n\nä¸Šé¢ä»£ç çš„ä¸»è¦é€»è¾‘æ˜¯ï¼š\n\nå…ˆè·å–targetå¯¹è±¡ï¼ˆå¯¹åº”XxxPropertiesç±»ï¼‰ä¸Šçš„@ConfigurationPropertiesæ³¨è§£å’Œæ ¡éªŒå™¨ï¼ˆè‹¥æœ‰ï¼‰;\nç„¶åå†æ ¹æ®è·å–çš„çš„@ConfigurationPropertiesæ³¨è§£å’Œæ ¡éªŒå™¨æ¥è·å¾—BindHandlerå¯¹è±¡ï¼ŒBindHandlerçš„ä½œç”¨æ˜¯ç”¨äºåœ¨å±æ€§ç»‘å®šæ—¶æ¥å¤„ç†ä¸€äº›é™„ä»¶é€»è¾‘;åœ¨ 8.1 èŠ‚åˆ†æ.\næœ€åå†è·å–ä¸€ä¸ªBinderå¯¹è±¡ï¼Œè°ƒç”¨å…¶bindæ–¹æ³•æ¥æ‰§è¡Œå¤–éƒ¨å±æ€§ç»‘å®šçš„é€»è¾‘,åœ¨ 8.2 èŠ‚åˆ†æ.\n\n\n8.1 è·å– BindHandler å¯¹è±¡ä»¥ä¾¿åœ¨å±æ€§ç»‘å®šæ—¶æ¥å¤„ç†ä¸€äº›é™„ä»¶é€»è¾‘æˆ‘ä»¬åœ¨çœ‹getBindHandleræ–¹æ³•çš„é€»è¾‘å‰å…ˆæ¥è®¤è¯†ä¸‹BindHandleræ˜¯å¹²å•¥çš„ã€‚\nBindHandleræ˜¯ä¸€ä¸ªçˆ¶ç±»æ¥å£ï¼Œç”¨äºåœ¨å±æ€§ç»‘å®šæ—¶æ¥å¤„ç†ä¸€äº›é™„ä»¶é€»è¾‘ã€‚æˆ‘ä»¬å…ˆçœ‹ä¸‹BindHandlerçš„ç±»å›¾ï¼Œå¥½æœ‰ä¸€ä¸ªæ•´ä½“çš„è®¤è¯†ï¼š\n\nå¯ä»¥çœ‹åˆ°AbstractBindHandlerä½œä¸ºæŠ½è±¡åŸºç±»å®ç°äº†BindHandleræ¥å£ï¼Œå…¶åˆæœ‰å››ä¸ªå…·ä½“çš„å­ç±»åˆ†åˆ«æ˜¯IgnoreTopLevelConverterNotFoundBindHandler,NoUnboundElementsBindHandler,IgnoreErrorsBindHandlerå’ŒValidationBindHandlerã€‚\n\nIgnoreTopLevelConverterNotFoundBindHandlerï¼šåœ¨å¤„ç†å¤–éƒ¨å±æ€§ç»‘å®šæ—¶çš„é»˜è®¤BindHandlerï¼Œå½“å±æ€§ç»‘å®šå¤±è´¥æ—¶ä¼šå¿½ç•¥æœ€é¡¶å±‚çš„ConverterNotFoundExceptionï¼›\nNoUnboundElementsBindHandlerï¼šç”¨æ¥å¤„ç†é…ç½®æ–‡ä»¶é…ç½®çš„æœªçŸ¥çš„å±æ€§ï¼›\nIgnoreErrorsBindHandlerï¼šç”¨æ¥å¿½ç•¥æ— æ•ˆçš„é…ç½®å±æ€§ä¾‹å¦‚ç±»å‹é”™è¯¯ï¼›\nValidationBindHandlerï¼šåˆ©ç”¨æ ¡éªŒå™¨å¯¹ç»‘å®šçš„ç»“æœå€¼è¿›è¡Œæ ¡éªŒã€‚\n\nåˆ†æå®Œç±»å…³ç³»åï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸‹BindHandleræ¥å£æä¾›äº†å“ªäº›æ–¹æ³•åœ¨å¤–éƒ¨å±æ€§ç»‘å®šæ—¶æä¾›ä¸€äº›é¢å¤–çš„é™„ä»¶é€»è¾‘ï¼Œç›´æ¥çœ‹ä»£ç ï¼š\n// BindHandler.java\n\npublic interface BindHandler &#123;\n\n\t/**\n\t * Default no-op bind handler.\n\t */\n\tBindHandler DEFAULT = new BindHandler() &#123;\n\n\t&#125;;\n\n\t// onStartæ–¹æ³•åœ¨å¤–éƒ¨å±æ€§ç»‘å®šå‰è¢«è°ƒç”¨\n\tdefault &lt;T> Bindable&lt;T> onStart(ConfigurationPropertyName name, Bindable&lt;T> target,\n\t\t\tBindContext context) &#123;\n\t\treturn target;\n\t&#125;\n\n\t// onSuccessæ–¹æ³•åœ¨å¤–éƒ¨å±æ€§æˆåŠŸç»‘å®šæ—¶è¢«è°ƒç”¨ï¼Œè¯¥æ–¹æ³•èƒ½å¤Ÿæ”¹å˜æœ€ç»ˆè¿”å›çš„å±æ€§å€¼æˆ–å¯¹å±æ€§å€¼è¿›è¡Œæ ¡éªŒ\n\tdefault Object onSuccess(ConfigurationPropertyName name, Bindable&lt;?> target,\n\t\t\tBindContext context, Object result) &#123;\n\t\treturn result;\n\t&#125;\n\n\t// onFailureæ–¹æ³•åœ¨å¤–éƒ¨å±æ€§ç»‘å®šå¤±è´¥ï¼ˆåŒ…æ‹¬onSuccessæ–¹æ³•é‡Œçš„é€»è¾‘æ‰§è¡Œå¤±è´¥ï¼‰æ—¶è¢«è°ƒç”¨ï¼Œ\n\t// è¯¥æ–¹æ³•å¯ä»¥ç”¨æ¥catchä½ç›¸å…³å¼‚å¸¸æˆ–è€…è¿”å›ä¸€ä¸ªæ›¿ä»£çš„ç»“æœï¼ˆè·Ÿå¾®æœåŠ¡çš„é™çº§ç»“æœæœ‰ç‚¹ç±»ä¼¼ï¼Œå˜¿å˜¿ï¼‰\n\tdefault Object onFailure(ConfigurationPropertyName name, Bindable&lt;?> target,\n\t\t\tBindContext context, Exception error) throws Exception &#123;\n\t\tthrow error;\n\t&#125;\n\n\t// å½“å¤–éƒ¨å±æ€§ç»‘å®šç»“æŸæ—¶ï¼ˆä¸ç®¡ç»‘å®šæˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼‰è¢«è°ƒç”¨\n\tdefault void onFinish(ConfigurationPropertyName name, Bindable&lt;?> target,\n\t\t\tBindContext context, Object result) throws Exception &#123;\n\t&#125;\n&#125;\n\n\nå¯ä»¥çœ‹åˆ°BindHandleræ¥å£å®šä¹‰äº†onStart,onSuccess,onFailureå’ŒonFinishæ–¹æ³•ï¼Œè¿™å››ä¸ªæ–¹æ³•åˆ†åˆ«ä¼šåœ¨æ‰§è¡Œå¤–éƒ¨å±æ€§ç»‘å®šæ—¶çš„ä¸åŒæ—¶æœºä¼šè¢«è°ƒç”¨ï¼Œåœ¨å±æ€§ç»‘å®šæ—¶ç”¨æ¥æ·»åŠ ä¸€äº›é¢å¤–çš„å¤„ç†é€»è¾‘ï¼Œæ¯”å¦‚åœ¨onSuccessæ–¹æ³•æ”¹å˜æœ€ç»ˆç»‘å®šçš„å±æ€§å€¼æˆ–å¯¹å±æ€§å€¼è¿›è¡Œæ ¡éªŒï¼Œåœ¨onFailureæ–¹æ³•catchä½ç›¸å…³å¼‚å¸¸æˆ–è€…è¿”å›ä¸€ä¸ªæ›¿ä»£çš„ç»‘å®šçš„å±æ€§å€¼ã€‚\nçŸ¥é“äº†BindHandleræ˜¯åœ¨å±æ€§ç»‘å®šæ—¶æ·»åŠ ä¸€äº›é¢å¤–çš„é™„ä»¶å¤„ç†é€»è¾‘åï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸‹getBindHandleræ–¹æ³•çš„é€»è¾‘ï¼Œç›´æ¥ä¸Šä»£ç ï¼š\n// ConfigurationPropertiesBinder.java\n\n// æ³¨æ„BindHandlerçš„è®¾è®¡æŠ€å·§ï¼Œåº”è¯¥æ˜¯è´£ä»»é“¾æ¨¡å¼ï¼Œéå¸¸å·§å¦™ï¼Œå€¼å¾—å€Ÿé‰´\nprivate BindHandler getBindHandler(ConfigurationProperties annotation,\n\t\tList&lt;Validator> validators) &#123;\n\t// æ–°å»ºä¸€ä¸ªIgnoreTopLevelConverterNotFoundBindHandlerå¯¹è±¡ï¼Œè¿™æ˜¯ä¸ªé»˜è®¤çš„BindHandlerå¯¹è±¡\n\tBindHandler handler = new IgnoreTopLevelConverterNotFoundBindHandler();\n\t// è‹¥æ³¨è§£@ConfigurationPropertiesçš„ignoreInvalidFieldså±æ€§è®¾ç½®ä¸ºtrueï¼Œ\n\t// åˆ™è¯´æ˜å¯ä»¥å¿½ç•¥æ— æ•ˆçš„é…ç½®å±æ€§ä¾‹å¦‚ç±»å‹é”™è¯¯ï¼Œæ­¤æ—¶æ–°å»ºä¸€ä¸ªIgnoreErrorsBindHandlerå¯¹è±¡\n\tif (annotation.ignoreInvalidFields()) &#123;\n\t\thandler = new IgnoreErrorsBindHandler(handler);\n\t&#125;\n\t// è‹¥æ³¨è§£@ConfigurationPropertiesçš„ignoreUnknownFieldså±æ€§è®¾ç½®ä¸ºtrueï¼Œ\n\t// åˆ™è¯´æ˜é…ç½®æ–‡ä»¶é…ç½®äº†ä¸€äº›æœªçŸ¥çš„å±æ€§é…ç½®ï¼Œæ­¤æ—¶æ–°å»ºä¸€ä¸ªignoreUnknownFieldså¯¹è±¡\n\tif (!annotation.ignoreUnknownFields()) &#123;\n\t\tUnboundElementsSourceFilter filter = new UnboundElementsSourceFilter();\n\t\thandler = new NoUnboundElementsBindHandler(handler, filter);\n\t&#125;\n\t// å¦‚æœ@Validæ³¨è§£ä¸ä¸ºç©ºï¼Œåˆ™åˆ›å»ºä¸€ä¸ªValidationBindHandlerå¯¹è±¡\n\tif (!validators.isEmpty()) &#123;\n\t\thandler = new ValidationBindHandler(handler,\n\t\t\t\tvalidators.toArray(new Validator[0]));\n\t&#125;\n\t// éå†è·å–çš„ConfigurationPropertiesBindHandlerAdvisoré›†åˆï¼Œ\n\t// ConfigurationPropertiesBindHandlerAdvisorç›®å‰åªåœ¨æµ‹è¯•ç±»ä¸­æœ‰ç”¨åˆ°\n\tfor (ConfigurationPropertiesBindHandlerAdvisor advisor : getBindHandlerAdvisors()) &#123;\n\t\t// å¯¹handlerè¿›ä¸€æ­¥å¤„ç†\n\t\thandler = advisor.apply(handler);\n\t&#125;\n\t// è¿”å›handler\n\treturn handler;\n&#125;\n\n\ngetBindHandleræ–¹æ³•çš„é€»è¾‘å¾ˆç®€å•ï¼Œä¸»è¦æ˜¯æ ¹æ®ä¼ å…¥çš„@ConfigurationPropertiesæ³¨è§£å’Œvalidatorsæ ¡éªŒå™¨æ¥åˆ›å»ºä¸åŒçš„BindHandlerå…·ä½“å®ç°ç±»ï¼š\n\né¦–å…ˆnewä¸€ä¸ªIgnoreTopLevelConverterNotFoundBindHandlerä½œä¸ºé»˜è®¤çš„BindHandler;\nè‹¥@ConfigurationPropertiesæ³¨è§£çš„å±æ€§ignoreInvalidFieldså€¼ä¸ºtrueï¼Œé‚£ä¹ˆå†newä¸€ä¸ªIgnoreErrorsBindHandlerå¯¹è±¡ï¼ŒæŠŠåˆšæ‰æ–°å»ºçš„IgnoreTopLevelConverterNotFoundBindHandlerå¯¹è±¡ä½œä¸ºæ„é€ å‚æ•°ä¼ å…¥èµ‹å€¼ç»™AbstractBindHandlerçˆ¶ç±»çš„parentå±æ€§ï¼›\nè‹¥@ConfigurationPropertiesæ³¨è§£çš„å±æ€§ignoreUnknownFieldså€¼ä¸ºfalseï¼Œé‚£ä¹ˆå†newä¸€ä¸ªUnboundElementsSourceFilterå¯¹è±¡ï¼ŒæŠŠä¹‹å‰æ„é€ çš„BindHandlerå¯¹è±¡ä½œä¸ºæ„é€ å‚æ•°ä¼ å…¥èµ‹å€¼ç»™AbstractBindHandlerçˆ¶ç±»çš„parentå±æ€§ï¼›\nâ€¦â€¦ä»¥æ­¤ç±»æ¨ï¼Œå‰ä¸€ä¸ªhandlerå¯¹è±¡ä½œä¸ºåä¸€ä¸ªhangdlerå¯¹è±¡çš„æ„é€ å‚æ•°ï¼Œå°±è¿™æ ·åˆ©ç”¨AbstractBindHandlerçˆ¶ç±»çš„parentå±æ€§å°†æ¯ä¸€ä¸ªhandleré“¾èµ·æ¥ï¼Œæœ€åå†å¾—åˆ°æœ€ç»ˆæ„é€ çš„handlerã€‚\n\n\n\n\n\n\n\n\n\n\nGET æŠ€å·§ï¼šä¸Šé¢çš„è¿™ä¸ªè®¾è®¡æ¨¡å¼æ˜¯ä¸æ˜¯å¾ˆç†Ÿæ‚‰ï¼Œè¿™ä¸ªå°±æ˜¯è´£ä»»é“¾æ¨¡å¼ã€‚æˆ‘ä»¬å­¦ä¹ æºç ï¼ŒåŒæ—¶ä¹Ÿæ˜¯å­¦ä¹ åˆ«äººæ€ä¹ˆç†Ÿç»ƒè¿ç”¨è®¾è®¡æ¨¡å¼ã€‚è´£ä»»é“¾æ¨¡å¼çš„åº”ç”¨æ¡ˆä¾‹æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚Dubboçš„å„ç§Filterä»¬ï¼ˆæ¯”å¦‚AccessLogFilteræ˜¯ç”¨æ¥è®°å½•æœåŠ¡çš„è®¿é—®æ—¥å¿—çš„ï¼ŒExceptionFilteræ˜¯ç”¨æ¥å¤„ç†å¼‚å¸¸çš„â€¦ï¼‰ï¼Œæˆ‘ä»¬ä¸€å¼€å§‹å­¦ä¹  java web æ—¶çš„Servletçš„Filter,MyBatisçš„Pluginä»¬ä»¥åŠNettyçš„Pipelineéƒ½é‡‡ç”¨äº†è´£ä»»é“¾æ¨¡å¼ã€‚\næˆ‘ä»¬äº†è§£äº†BindHandlerçš„ä½œç”¨åï¼Œå†æ¥ç´§è·Ÿä¸»çº¿ï¼Œçœ‹å±æ€§ç»‘å®šæ˜¯å¦‚ä½•ç»‘å®šçš„ï¼Ÿ\n\n8.2 è·å– Binder å¯¹è±¡ç”¨äºè¿›è¡Œå±æ€§ç»‘å®šã€ä¸»çº¿ã€‘è¿™é‡Œæ¥ 8 ConfigurationPropertiesBinder èŠ‚ä»£ç ä¸­æ ‡æ³¨ã€4ã€‘çš„ä¸»çº¿ä»£ç getBinder().bind(annotation.prefix(), target, bindHandler);.\nå¯ä»¥çœ‹åˆ°è¿™å¥ä»£ç ä¸»è¦åšäº†ä¸¤ä»¶äº‹ï¼š\n\nè°ƒç”¨getBinderæ–¹æ³•è·å–ç”¨äºå±æ€§ç»‘å®šçš„Binderå¯¹è±¡ï¼›\nè°ƒç”¨Binderå¯¹è±¡çš„bindæ–¹æ³•è¿›è¡Œå¤–éƒ¨å±æ€§ç»‘å®šåˆ°@ConfigurationPropertiesæ³¨è§£çš„XxxPropertiesç±»çš„å±æ€§ä¸Šã€‚\n\né‚£ä¹ˆæˆ‘ä»¬å…ˆçœ‹ä¸‹getBinderæ–¹æ³•æºç ï¼š\n// ConfigurationPropertiesBinder.java\n\nprivate Binder getBinder() &#123;\n\t// Binderæ˜¯ä¸€ä¸ªèƒ½ç»‘å®šConfigurationPropertySourceçš„å®¹å™¨å¯¹è±¡\n\tif (this.binder == null) &#123;\n\t\t// æ–°å»ºä¸€ä¸ªBinderå¯¹è±¡ï¼Œè¿™ä¸ªbinderå¯¹è±¡å°è£…äº†ConfigurationPropertySourcesï¼Œ\n\t\t// PropertySourcesPlaceholdersResolverï¼ŒConversionServiceå’ŒPropertyEditorInitializerå¯¹è±¡\n\t\tthis.binder = new Binder(getConfigurationPropertySources(), // å°†PropertySourceså¯¹è±¡å°è£…æˆSpringConfigurationPropertySourceså¯¹è±¡å¹¶è¿”å›\n\t\t\t\tgetPropertySourcesPlaceholdersResolver(), getConversionService(), // å°†PropertySourceså¯¹è±¡å°è£…æˆPropertySourcesPlaceholdersResolverå¯¹è±¡å¹¶è¿”å›ï¼Œä»å®¹å™¨ä¸­è·å–åˆ°ConversionServiceå¯¹è±¡\n\t\t\t\tgetPropertyEditorInitializer()); // å¾—åˆ°Consumer&lt;PropertyEditorRegistry>å¯¹è±¡ï¼Œè¿™äº›åˆå§‹åŒ–å™¨ç”¨æ¥é…ç½®property editorsï¼Œproperty editorsé€šå¸¸å¯ä»¥ç”¨æ¥è½¬æ¢å€¼\n\t&#125;\n\t// è¿”å›binder\n\treturn this.binder;\n&#125;\n\n\nå¯ä»¥çœ‹åˆ°Binderå¯¹è±¡å°è£…äº†ConfigurationPropertySources,PropertySourcesPlaceholdersResolver,ConversionServiceå’ŒPropertyEditorInitializerè¿™å››ä¸ªå¯¹è±¡ï¼ŒBinderå¯¹è±¡å°è£…äº†è¿™å››ä¸ªå“¥ä»¬è‚¯å®šæ˜¯åœ¨åé¢å±æ€§ç»‘å®šé€»è¾‘ä¸­ä¼šç”¨åˆ°ï¼Œå…ˆçœ‹ä¸‹è¿™å››ä¸ªå¯¹è±¡æ˜¯å¹²å˜›çš„ï¼š\n\nConfigurationPropertySources:å¤–éƒ¨é…ç½®æ–‡ä»¶çš„å±æ€§æºï¼Œç”±ConfigFileApplicationListenerç›‘å¬å™¨è´Ÿè´£è§¦å‘è¯»å–ï¼›\nPropertySourcesPlaceholdersResolver:è§£æå±æ€§æºä¸­çš„å ä½ç¬¦$&#123;&#125;ï¼›\nConversionService:å¯¹å±æ€§ç±»å‹è¿›è¡Œè½¬æ¢\nPropertyEditorInitializer:ç”¨æ¥é…ç½®property editors\n\né‚£ä¹ˆï¼Œæˆ‘ä»¬è·å–äº†Binderå±æ€§ç»‘å®šå™¨åï¼Œå†æ¥çœ‹ä¸‹å®ƒçš„bindæ–¹æ³•æ˜¯å¦‚ä½•æ‰§è¡Œå±æ€§ç»‘å®šçš„ã€‚\n// Binder.java\n\npublic &lt;T> BindResult&lt;T> bind(String name, Bindable&lt;T> target, BindHandler handler) &#123;\n\t// ConfigurationPropertyName.of(name)ï¼šå°†nameï¼ˆè¿™é‡ŒæŒ‡å±æ€§å‰ç¼€åï¼‰å°è£…åˆ°ConfigurationPropertyNameå¯¹è±¡ä¸­\n\t// å°†å¤–éƒ¨é…ç½®å±æ€§ç»‘å®šåˆ°ç›®æ ‡å¯¹è±¡targetä¸­\n\treturn bind(ConfigurationPropertyName.of(name), target, handler);\n&#125;\n\npublic &lt;T> BindResult&lt;T> bind(ConfigurationPropertyName name, Bindable&lt;T> target,\n\t\tBindHandler handler) &#123;\n\tAssert.notNull(name, \"Name must not be null\");\n\tAssert.notNull(target, \"Target must not be null\");\n\thandler = (handler != null) ? handler : BindHandler.DEFAULT;\n\t// Contextæ˜¯Binderçš„å†…éƒ¨ç±»ï¼Œå®ç°äº†BindContextï¼ŒContextå¯ä»¥ç†è§£ä¸ºBinderçš„ä¸Šä¸‹æ–‡ï¼Œå¯ä»¥ç”¨æ¥è·å–binderçš„å±æ€§æ¯”å¦‚Binderçš„sourceså±æ€§\n\tContext context = new Context();\n\t// è¿›è¡Œå±æ€§ç»‘å®šï¼Œå¹¶è¿”å›ç»‘å®šå±æ€§åçš„å¯¹è±¡boundï¼Œæ³¨æ„boundçš„å¯¹è±¡ç±»å‹æ˜¯Tï¼ŒTå°±æ˜¯@ConfigurationPropertiesæ³¨è§£çš„ç±»æ¯”å¦‚ServerProperties\n\t/********ã€ä¸»çº¿ï¼Œé‡ç‚¹å…³æ³¨ã€‘************/\n\tT bound = bind(name, target, handler, context, false);\n\t// å°†åˆšæ‰è¿”å›çš„boundå¯¹è±¡å°è£…åˆ°BindResultå¯¹è±¡ä¸­å¹¶è¿”å›\n\treturn BindResult.of(bound);\n&#125;\n\n\nä¸Šé¢ä»£ç ä¸­é¦–å…ˆåˆ›å»ºäº†ä¸€ä¸ªContextå¯¹è±¡ï¼ŒContextæ˜¯Binderçš„å†…éƒ¨ç±»ï¼Œä¸ºBinderçš„ä¸Šä¸‹æ–‡ï¼Œåˆ©ç”¨Contextä¸Šä¸‹æ–‡å¯ä»¥è·å–Binderçš„å±æ€§æ¯”å¦‚è·å–Binderçš„sourceså±æ€§å€¼å¹¶ç»‘å®šåˆ°XxxPropertieså±æ€§ä¸­ã€‚ç„¶åæˆ‘ä»¬å†ç´§è·Ÿä¸»çº¿çœ‹ä¸‹bind(name, target, handler, context, false)æ–¹æ³•æºç ï¼š\n// Binder.java\n\nprotected final &lt;T> T bind(ConfigurationPropertyName name, Bindable&lt;T> target,\n\t\tBindHandler handler, Context context, boolean allowRecursiveBinding) &#123;\n\t// æ¸…ç©ºBinderçš„configurationPropertyå±æ€§å€¼\n\tcontext.clearConfigurationProperty();\n\ttry &#123;\n\t\t// ã€1ã€‘è°ƒç”¨BindHandlerçš„onStartæ–¹æ³•ï¼Œæ‰§è¡Œä¸€ç³»åˆ—çš„è´£ä»»é“¾å¯¹è±¡çš„è¯¥æ–¹æ³•\n\t\ttarget = handler.onStart(name, target, context);\n\t\tif (target == null) &#123;\n\t\t\treturn null;\n\t\t&#125;// ã€2ã€‘è°ƒç”¨bindObjectæ–¹æ³•å¯¹Bindableå¯¹è±¡targetçš„å±æ€§è¿›è¡Œç»‘å®šå¤–éƒ¨é…ç½®çš„å€¼ï¼Œå¹¶è¿”å›èµ‹å€¼ç»™boundå¯¹è±¡ã€‚\n\t\t// ä¸¾ä¸ªæ —å­ï¼šæ¯”å¦‚è®¾ç½®äº†server.port=8888,é‚£ä¹ˆè¯¥æ–¹æ³•æœ€ç»ˆä¼šè°ƒç”¨Binder.bindPropertyæ–¹æ³•ï¼Œæœ€ç»ˆè¿”å›çš„boundçš„valueå€¼ä¸º8888\n\t\t/************ã€ä¸»çº¿ï¼šé‡ç‚¹å…³æ³¨ã€‘***********/\n\t\tObject bound = bindObject(name, target, handler, context,\n\t\t\t\tallowRecursiveBinding);\n\t\t// ã€3ã€‘å°è£…handleBindResultå¯¹è±¡å¹¶è¿”å›ï¼Œæ³¨æ„åœ¨handleBindResultçš„æ„é€ å‡½æ•°ä¸­ä¼šè°ƒç”¨BindHandlerçš„onSucessï¼ŒonFinishæ–¹æ³•\n\t\treturn handleBindResult(name, target, handler, context, bound);\n\t&#125;\n\tcatch (Exception ex) &#123;\n\t\treturn handleBindError(name, target, handler, context, ex);\n\t&#125;\n&#125;\n\n\nä¸Šé¢ä»£ç çš„æ³¨é‡Šå·²ç»éå¸¸è¯¦ç»†ï¼Œè¿™é‡Œä¸å†è¯¦è¿°ã€‚æˆ‘ä»¬æ¥ç€ç´§è·Ÿä¸»çº¿æ¥çœ‹çœ‹bindObjectæ–¹æ³•æºç :\n// Binder.java\n\nprivate &lt;T> Object bindObject(ConfigurationPropertyName name, Bindable&lt;T> target,\n\t\tBindHandler handler, Context context, boolean allowRecursiveBinding) &#123;\n\t// ä»propertySourceä¸­çš„é…ç½®å±æ€§ï¼Œè·å–ConfigurationPropertyå¯¹è±¡propertyå³application.propertiesé…ç½®æ–‡ä»¶ä¸­è‹¥æœ‰ç›¸å…³çš„é…ç½®çš„è¯ï¼Œ\n\t// é‚£ä¹ˆpropertyå°†ä¸ä¼šä¸ºnullã€‚ä¸¾ä¸ªæ —å­ï¼šå‡å¦‚ä½ åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®äº†spring.profiles.active=devï¼Œé‚£ä¹ˆç›¸åº”propertyå€¼ä¸ºdevï¼›å¦åˆ™ä¸ºnull\n\tConfigurationProperty property = findProperty(name, context);\n\t// è‹¥propertyä¸ºnullï¼Œåˆ™ä¸ä¼šæ‰§è¡Œåç»­çš„å±æ€§ç»‘å®šç›¸å…³é€»è¾‘\n\tif (property == null &amp;&amp; containsNoDescendantOf(context.getSources(), name)) &#123;\n\t\t// å¦‚æœproperty == nullï¼Œåˆ™è¿”å›null\n\t\treturn null;\n\t&#125;\n\t// æ ¹æ®targetç±»å‹è·å–ä¸åŒçš„Binderï¼Œå¯ä»¥æ˜¯nullï¼ˆæ™®é€šçš„ç±»å‹ä¸€èˆ¬æ˜¯Nullï¼‰,MapBinder,CollectionBinderæˆ–ArrayBinder\n\tAggregateBinder&lt;?> aggregateBinder = getAggregateBinder(target, context);\n\t// è‹¥aggregateBinderä¸ä¸ºnullæ¯”å¦‚é…ç½®äº†spring.profileså±æ€§ï¼ˆå½“ç„¶åŒ…æ‹¬å…¶å­å±æ€§æ¯”å¦‚spring.profiles.activeç­‰ï¼‰\n\tif (aggregateBinder != null) &#123;\n\t\t// è‹¥aggregateBinderä¸ä¸ºnullï¼Œåˆ™è°ƒç”¨bindAggregateå¹¶è¿”å›ç»‘å®šåçš„å¯¹è±¡\n\t\treturn bindAggregate(name, target, handler, context, aggregateBinder);\n\t&#125;\n\t// è‹¥propertyä¸ä¸ºnull\n\tif (property != null) &#123;\n\t\ttry &#123;\n\t\t\t// ç»‘å®šå±æ€§åˆ°å¯¹è±¡ä¸­ï¼Œæ¯”å¦‚é…ç½®æ–‡ä»¶ä¸­è®¾ç½®äº†server.port=8888ï¼Œé‚£ä¹ˆå°†ä¼šæœ€ç»ˆè°ƒç”¨bindPropertyæ–¹æ³•è¿›è¡Œå±æ€§è®¾ç½®\n\t\t\treturn bindProperty(target, context, property);\n\t\t&#125;\n\t\tcatch (ConverterNotFoundException ex) &#123;\n\t\t\t// We might still be able to bind it as a bean\n\t\t\tObject bean = bindBean(name, target, handler, context,\n\t\t\t\t\tallowRecursiveBinding);\n\t\t\tif (bean != null) &#123;\n\t\t\t\treturn bean;\n\t\t\t&#125;\n\t\t\tthrow ex;\n\t\t&#125;\n\t&#125;\n\t// åªæœ‰@ConfigurationPropertiesæ³¨è§£çš„ç±»è¿›è¡Œå¤–éƒ¨å±æ€§ç»‘å®šæ‰ä¼šèµ°è¿™é‡Œ\n\t/***********************ã€ä¸»çº¿ï¼Œé‡ç‚¹å…³æ³¨ã€‘****************************/\n\treturn bindBean(name, target, handler, context, allowRecursiveBinding);\n&#125;\n\n\nç”±ä¸Šä»£ç ä¸­å¯ä»¥çœ‹åˆ°bindObjectä¸­æ‰§è¡Œå±æ€§ç»‘å®šçš„é€»è¾‘ä¼šæ ¹æ®ä¸åŒçš„å±æ€§ç±»å‹è¿›å…¥ä¸åŒçš„ç»‘å®šé€»è¾‘ä¸­ï¼Œä¸¾ä¸ªæ —å­ï¼š\n\napplication.propertiesé…ç½®æ–‡ä»¶ä¸­é…ç½®äº†spring.profiles.active=devçš„è¯ï¼Œé‚£ä¹ˆå°†ä¼šè¿›å…¥return bindAggregate(name, target, handler, context, aggregateBinder);è¿™ä¸ªå±æ€§ç»‘å®šçš„ä»£ç é€»è¾‘ï¼›\napplication.propertiesé…ç½®æ–‡ä»¶ä¸­é…ç½®äº†server.port=8081çš„è¯ï¼Œé‚£ä¹ˆå°†ä¼šè¿›å…¥return bindBean(name, target, handler, context, allowRecursiveBinding);çš„å±æ€§ç»‘å®šçš„é€»è¾‘ã€‚\n\nå› æ­¤æˆ‘ä»¬å†æ¬¡ç´§è·Ÿä¸»çº¿ï¼Œè¿›å…¥@ConfigurationPropertiesæ³¨è§£çš„XxxPropertiesç±»çš„å±æ€§ç»‘å®šé€»è¾‘ä¸­çš„bindBeanæ–¹æ³•ä¸­ï¼š\n// Binder.java\n\nprivate Object bindBean(ConfigurationPropertyName name, Bindable&lt;?> target, // nameæŒ‡çš„æ˜¯ConfigurationPropertiesçš„å‰ç¼€å\n\t\tBindHandler handler, Context context, boolean allowRecursiveBinding) &#123;\n\t// è¿™é‡Œåšä¸€äº›ConfigurationPropertyStateçš„ç›¸å…³æ£€æŸ¥\n\tif (containsNoDescendantOf(context.getSources(), name)\n\t\t\t|| isUnbindableBean(name, target, context)) &#123;\n\t\treturn null;\n\t&#125;// è¿™é‡Œæ–°å»ºä¸€ä¸ªBeanPropertyBinderçš„å®ç°ç±»å¯¹è±¡ï¼Œæ³¨æ„è¿™ä¸ªå¯¹è±¡å®ç°äº†bindPropertyæ–¹æ³•\n\tBeanPropertyBinder propertyBinder = (propertyName, propertyTarget) -> bind(\n\t\t\tname.append(propertyName), propertyTarget, handler, context, false);\n\t/**\n\t * (propertyName, propertyTarget) -> bind(\n\t * \t\t\t\tname.append(propertyName), propertyTarget, handler, context, false);\n\t * \tç­‰ä»·äº\n\t * \tnew BeanPropertyBinder() &#123;\n\t *\t\tObject bindProperty(String propertyName, Bindable&lt;?> target)&#123;\n\t *\t\t\tbind(name.append(propertyName), propertyTarget, handler, context, false);\n\t *\t\t&#125;\n\t * \t&#125;\n\t */\n\t// typeç±»å‹å³@ConfigurationPropertiesæ³¨è§£æ ‡æ³¨çš„XxxPropertiesç±»\n\tClass&lt;?> type = target.getType().resolve(Object.class);\n\tif (!allowRecursiveBinding &amp;&amp; context.hasBoundBean(type)) &#123;\n\t\treturn null;\n\t&#125;\n\t// è¿™é‡Œåº”ç”¨äº†java8çš„lambdaè¯­æ³•ï¼Œä½œä¸ºæ²¡æ€ä¹ˆå­¦ä¹ java8çš„lambdaè¯­æ³•çš„æˆ‘ï¼Œä¸æ€ä¹ˆå¥½ç†è§£ä¸‹é¢çš„é€»è¾‘ï¼Œå“ˆå“ˆ\n\t// çœŸæ­£å®ç°å°†å¤–éƒ¨é…ç½®å±æ€§ç»‘å®šåˆ°@ConfigurationPropertiesæ³¨è§£çš„XxxPropertiesç±»çš„å±æ€§ä¸­çš„é€»è¾‘åº”è¯¥å°±æ˜¯åœ¨è¿™å¥lambdaä»£ç äº†\n\t/*******************ã€ä¸»çº¿ã€‘***************************/\n\treturn context.withBean(type, () -> &#123;\n\t\tStream&lt;?> boundBeans = BEAN_BINDERS.stream()\n\t\t\t\t.map((b) -> b.bind(name, target, context, propertyBinder));\n\t\treturn boundBeans.filter(Objects::nonNull).findFirst().orElse(null);\n\t&#125;);\n\t// æ ¹æ®ä¸Šé¢çš„lambdaè¯­å¥ç¿»è¯‘å¦‚ä¸‹ï¼š\n\t/** è¿™é‡Œçš„TæŒ‡çš„æ˜¯å„ç§å±æ€§ç»‘å®šå¯¹è±¡ï¼Œæ¯”å¦‚ServerProperties\n\t * return context.withBean(type, new Supplier&lt;T>() &#123;\n\t * \tT get() &#123;\n\t * \t\tStream&lt;?> boundBeans = BEAN_BINDERS.stream()\n\t * \t\t\t\t\t.map((b) -> b.bind(name, target, context, propertyBinder));\n\t * \t\t\treturn boundBeans.filter(Objects::nonNull).findFirst().orElse(null);\n\t *        &#125;\n\t *  &#125;);\n\t */\n&#125;\n\n\nä»ä¸Šé¢ä»£ç ä¸­ï¼Œæˆ‘ä»¬è¿½æ ¹ç©¶åº•æ¥åˆ°äº†å¤–éƒ¨é…ç½®å±æ€§ç»‘å®šåˆ°XxxPropertiesç±»å±æ€§ä¸­çš„æ¯”è¾ƒåº•å±‚çš„ä»£ç äº†ï¼Œå¯ä»¥çœ‹åˆ°å±æ€§ç»‘å®šçš„é€»è¾‘åº”è¯¥å°±åœ¨ä¸Šé¢ä»£ç æ ‡æ³¨ã€ä¸»çº¿ã€‘çš„lambdaä»£ç å¤„äº†ã€‚è¿™é‡Œå°±ä¸å†è¯¦è¿°äº†ï¼Œå› ä¸ºè¿™ä¸ªå±äº SpringBoot çš„å±æ€§ç»‘å®šBinderçš„èŒƒç•´ï¼ŒBinderç›¸å…³ç±»æ˜¯ SpringBoot2.0 æ‰å‡ºç°çš„ï¼Œå³å¯¹ä¹‹å‰çš„å±æ€§ç»‘å®šç›¸å…³ä»£ç è¿›è¡Œæ¨ç¿»é‡å†™äº†ã€‚å±æ€§ç»‘å®šç›¸å…³çš„æºç ä¹Ÿæ¯”è¾ƒå¤šï¼Œåç»­æœ‰éœ€è¦å†å¦å¼€ä¸€ç¯‡æ¥åˆ†ææ¢ç©¶å§ã€‚\n\n9 å°ç»“å¥½äº†ï¼Œå¤–éƒ¨é…ç½®å±æ€§å€¼æ˜¯å¦‚ä½•è¢«ç»‘å®šåˆ°XxxPropertiesç±»å±æ€§ä¸Šçš„æºç åˆ†æå°±åˆ°æ­¤ç»“æŸäº†ï¼Œåˆæ˜¯è›®é•¿çš„ä¸€ç¯‡æ–‡ç« ï¼Œä¸çŸ¥è‡ªå·±è¡¨è¿°æ¸…æ¥šæ²¡ï¼Œé‡è¦æ­¥éª¤ç°æ€»ç»“ä¸‹ï¼š\n\né¦–å…ˆæ˜¯@EnableConfigurationPropertiesæ³¨è§£importäº†EnableConfigurationPropertiesImportSelectoråç½®å¤„ç†å™¨ï¼›\nEnableConfigurationPropertiesImportSelectoråç½®å¤„ç†å™¨åˆå‘Springå®¹å™¨ä¸­æ³¨å†Œäº†ConfigurationPropertiesBeanRegistrarå’ŒConfigurationPropertiesBindingPostProcessorRegistrarè¿™ä¸¤ä¸ªbeanï¼›\nå…¶ä¸­ConfigurationPropertiesBeanRegistrarå‘Springå®¹å™¨ä¸­æ³¨å†Œäº†XxxPropertiesç±»å‹çš„beanï¼›ConfigurationPropertiesBindingPostProcessorRegistrarå‘Springå®¹å™¨ä¸­æ³¨å†Œäº†ConfigurationBeanFactoryMetadataå’ŒConfigurationPropertiesBindingPostProcessorä¸¤ä¸ªåç½®å¤„ç†å™¨ï¼›\nConfigurationBeanFactoryMetadataåç½®å¤„ç†å™¨åœ¨åˆå§‹åŒ–bean factoryæ—¶å°†@Beanæ³¨è§£çš„å…ƒæ•°æ®å­˜å‚¨èµ·æ¥ï¼Œä»¥ä¾¿åœ¨åç»­çš„å¤–éƒ¨é…ç½®å±æ€§ç»‘å®šçš„ç›¸å…³é€»è¾‘ä¸­ä½¿ç”¨ï¼›\nConfigurationPropertiesBindingPostProcessoråç½®å¤„ç†å™¨å°†å¤–éƒ¨é…ç½®å±æ€§å€¼ç»‘å®šåˆ°XxxPropertiesç±»å±æ€§çš„é€»è¾‘å§”æ‰˜ç»™ConfigurationPropertiesBinderå¯¹è±¡ï¼Œç„¶åConfigurationPropertiesBinderå¯¹è±¡åˆæœ€ç»ˆå°†å±æ€§ç»‘å®šçš„é€»è¾‘å§”æ‰˜ç»™Binderå¯¹è±¡æ¥å®Œæˆã€‚\n\nå¯è§ï¼Œé‡è¦çš„æ˜¯ä¸Šé¢çš„ç¬¬ 5 æ­¥ã€‚\nPSï¼šæœ¬æ¥æ‰“ç®—è¿™ç¯‡å¼€å§‹åˆ†æ SpringBoot çš„å¯åŠ¨æµç¨‹çš„ï¼Œä½†æ˜¯å›è¿‡å¤´å»çœ‹çœ‹è‡ªåŠ¨é…ç½®çš„ç›¸å…³æºç ï¼Œè¿˜æœ‰è›®å¤šæ²¡æœ‰åˆ†æçš„ï¼Œå› æ­¤å†æ¥ä¸€æ³¢è‡ªåŠ¨é…ç½®ç›¸å…³çš„æºç å…ˆã€‚\n6 SpringBootå†…ç½®çš„å„ç§Starteræ˜¯æ€æ ·æ„å»ºçš„\n1 æ¸©æ•…è€ŒçŸ¥æ–°æ¸©æ•…è€ŒçŸ¥æ–°ï¼Œæˆ‘ä»¬æ¥ç®€å•å›é¡¾ä¸€ä¸‹ä¸Šç¯‡çš„å†…å®¹ï¼Œä¸Šä¸€ç¯‡æˆ‘ä»¬åˆ†æäº†SpringBootå¤–éƒ¨é…ç½®å±æ€§å€¼æ˜¯å¦‚ä½•è¢«ç»‘å®šåˆ°XxxPropertiesç±»å±æ€§ä¸Šçš„ç›¸å…³æºç ï¼Œç°å°†å¤–éƒ¨å±æ€§ç»‘å®šçš„é‡è¦æ­¥éª¤æ€»ç»“å¦‚ä¸‹ï¼š\n\né¦–å…ˆæ˜¯@EnableConfigurationPropertiesæ³¨è§£importäº†EnableConfigurationPropertiesImportSelectoråç½®å¤„ç†å™¨ï¼›\nEnableConfigurationPropertiesImportSelectoråç½®å¤„ç†å™¨åˆå‘Springå®¹å™¨ä¸­æ³¨å†Œäº†ConfigurationPropertiesBeanRegistrarå’ŒConfigurationPropertiesBindingPostProcessorRegistrarè¿™ä¸¤ä¸ªbeanï¼›\nå…¶ä¸­ConfigurationPropertiesBeanRegistrarå‘Springå®¹å™¨ä¸­æ³¨å†Œäº†XxxPropertiesç±»å‹çš„beanï¼›ConfigurationPropertiesBindingPostProcessorRegistrarå‘Springå®¹å™¨ä¸­æ³¨å†Œäº†ConfigurationBeanFactoryMetadataå’ŒConfigurationPropertiesBindingPostProcessorä¸¤ä¸ªåç½®å¤„ç†å™¨ï¼›\nConfigurationBeanFactoryMetadataåç½®å¤„ç†å™¨åœ¨åˆå§‹åŒ–bean factoryæ—¶å°†@Beanæ³¨è§£çš„å…ƒæ•°æ®å­˜å‚¨èµ·æ¥ï¼Œä»¥ä¾¿åœ¨åç»­çš„å¤–éƒ¨é…ç½®å±æ€§ç»‘å®šçš„ç›¸å…³é€»è¾‘ä¸­ä½¿ç”¨ï¼›\nConfigurationPropertiesBindingPostProcessoråç½®å¤„ç†å™¨å°†å¤–éƒ¨é…ç½®å±æ€§å€¼ç»‘å®šåˆ°XxxPropertiesç±»å±æ€§çš„é€»è¾‘å§”æ‰˜ç»™ConfigurationPropertiesBinderå¯¹è±¡ï¼Œç„¶åConfigurationPropertiesBinderå¯¹è±¡åˆæœ€ç»ˆå°†å±æ€§ç»‘å®šçš„é€»è¾‘å§”æ‰˜ç»™Binderå¯¹è±¡æ¥å®Œæˆã€‚\n\nå¯è§ï¼Œé‡è¦çš„æ˜¯ä¸Šé¢çš„ç¬¬5æ­¥ã€‚\n\n2 å¼•è¨€æˆ‘ä»¬éƒ½çŸ¥é“ï¼ŒSpringBootå†…ç½®äº†å„ç§Starterèµ·æ­¥ä¾èµ–ï¼Œæˆ‘ä»¬ä½¿ç”¨éå¸¸æ–¹ä¾¿ï¼Œå¤§å¤§å‡è½»äº†æˆ‘ä»¬çš„å¼€å‘å·¥ä½œã€‚æœ‰äº†Starterèµ·æ­¥ä¾èµ–ï¼Œæˆ‘ä»¬ä¸ç”¨å»è€ƒè™‘è¿™ä¸ªé¡¹ç›®éœ€è¦ä»€ä¹ˆåº“ï¼Œè¿™ä¸ªåº“çš„groupIdå’ŒartifactIdæ˜¯ä»€ä¹ˆï¼Ÿæ›´ä¸ç”¨æ‹…å¿ƒå¼•å…¥è¿™ä¸ªç‰ˆæœ¬çš„åº“åä¼šä¸ä¼šè·Ÿå…¶ä»–ä¾èµ–æœ‰æ²¡æœ‰å†²çªã€‚\n\n\n\n\n\n\n\n\n\nä¸¾ä¸ªæ —å­ï¼šç°åœ¨æˆ‘ä»¬æƒ³å¼€å‘ä¸€ä¸ªwebé¡¹ç›®ï¼Œé‚£ä¹ˆåªè¦å¼•å…¥spring-boot-starter-webè¿™ä¸ªèµ·æ­¥ä¾èµ–å°±å¯ä»¥äº†ï¼Œä¸ç”¨è€ƒè™‘è¦å¼•å…¥å“ªäº›ç‰ˆæœ¬çš„å“ªäº›ä¾èµ–äº†ã€‚åƒä»¥å‰æˆ‘ä»¬è¿˜è¦è€ƒè™‘å¼•å…¥å“ªäº›ä¾èµ–åº“ï¼Œæ¯”å¦‚è¦å¼•å…¥spring-webå’Œspring-webmvcä¾èµ–ç­‰ï¼›æ­¤å¤–ï¼Œè¿˜è¦è€ƒè™‘å¼•å…¥è¿™äº›åº“çš„å“ªäº›ç‰ˆæœ¬æ‰ä¸ä¼šè·Ÿå…¶ä»–åº“å†²çªç­‰é—®é¢˜ã€‚\né‚£ä¹ˆæˆ‘ä»¬ä»Šå¤©æš‚æ—¶ä¸åˆ†æSpringBootè‡ªåŠ¨é…ç½®çš„æºç ï¼Œç”±äºèµ·æ­¥ä¾èµ–è·Ÿè‡ªåŠ¨é…ç½®çš„å…³ç³»æ˜¯å¦‚å½±éšå½¢çš„å…³ç³»ï¼Œå› æ­¤æœ¬ç¯‡å…ˆç«™åœ¨mavené¡¹ç›®æ„å»ºçš„è§’åº¦æ¥å®è§‚åˆ†æä¸‹æˆ‘ä»¬å¹³æ—¶ä½¿ç”¨çš„SpringBootå†…ç½®çš„å„ç§**Starter**æ˜¯æ€æ ·æ„å»ºçš„ï¼Ÿ\n\n3 Mavenä¼ é€’ä¾èµ–çš„optionalæ ‡ç­¾åœ¨åˆ†æSpringBootå†…ç½®çš„å„ç§Starteræ„å»ºåŸç†å‰ï¼Œæˆ‘ä»¬å…ˆæ¥è®¤è¯†ä¸‹Mavençš„optionalæ ‡ç­¾ï¼Œå› ä¸ºè¿™ä¸ªæ ‡ç­¾èµ·åˆ°è‡³å…³é‡è¦çš„ä½œç”¨ã€‚ Mavençš„optionalæ ‡ç­¾è¡¨ç¤ºå¯é€‰ä¾èµ–å³ä¸å¯ä¼ é€’çš„æ„æ€ï¼Œä¸‹é¢ç›´æ¥ä¸¾ä¸ªæ —å­æ¥è¯´æ˜ã€‚\næ¯”å¦‚æœ‰A,Bå’ŒCä¸‰ä¸ªåº“ï¼ŒCä¾èµ–Bï¼ŒBä¾èµ–Aã€‚ä¸‹é¢çœ‹ä¸‹è¿™ä¸‰ä¸ªåº“çš„pom.xmlæ–‡ä»¶ï¼š\n// Açš„pom.xml\n\n&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?>\n&lt;project xmlns=\"http://maven.apache.org/POM/4.0.0\"\n         xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n         xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n\n\t&lt;groupId>com.ymbj&lt;/groupId>\n        &lt;artifactId>A&lt;/artifactId>\n\t&lt;version>1.0-SNAPSHOT&lt;/version>\n\n&lt;/project>\nå¤åˆ¶ä»£ç \n&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?>\n&lt;project xmlns=\"http://maven.apache.org/POM/4.0.0\"\n         xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n         xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n\n\t&lt;groupId>com.ymbj&lt;/groupId>\n        &lt;artifactId>B&lt;/artifactId>\n\t&lt;version>1.0-SNAPSHOT&lt;/version>\n\n    &lt;!--æ³¨æ„æ˜¯å¯é€‰ä¾èµ–-->\n    &lt;dependencies>\n        &lt;dependency>\n            &lt;groupId>com.ymbj&lt;/groupId>\n            &lt;artifactId>A&lt;/artifactId>\n            &lt;version>1.0-SNAPSHOT&lt;/version>\n\t    &lt;optional>true&lt;/optional>\n        &lt;/dependency>\n    &lt;/dependencies>\n\n&lt;/project>\nå¤åˆ¶ä»£ç \n&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?>\n&lt;project xmlns=\"http://maven.apache.org/POM/4.0.0\"\n         xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n         xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n\n\t&lt;groupId>com.ymbj&lt;/groupId>\n        &lt;artifactId>C&lt;/artifactId>\n\t&lt;version>1.0-SNAPSHOT&lt;/version>\n\n    &lt;dependencies>\n        &lt;dependency>\n            &lt;groupId>com.ymbj&lt;/groupId>\n            &lt;artifactId>B&lt;/artifactId>\n            &lt;version>1.0-SNAPSHOT&lt;/version>\n        &lt;/dependency>\n    &lt;/dependencies>\n\n&lt;/project>\n\nä¸Šé¢ä¸‰ä¸ªA,Bå’ŒCåº“çš„pom.xmlå¯çŸ¥ï¼ŒBåº“ä¾èµ–Aåº“ï¼Œç„¶åCåº“åˆä¾èµ–äº†Båº“ï¼Œé‚£ä¹ˆè¯·æƒ³ä¸€ä¸‹ï¼ŒMavenæ‰“åŒ…æ„å»º**C**åº“åï¼Œ**A**åº“æœ‰æ²¡æœ‰è¢«å¼•è¿›æ¥ï¼Ÿ\nç­”æ¡ˆè‚¯å®šæ˜¯æ²¡æœ‰ï¼Œå› ä¸ºBåº“å¼•å…¥Aåº“ä¾èµ–æ—¶ä½¿ç”¨äº†&lt;optional&gt;true&lt;/optional&gt;ï¼Œå³å°†Mavençš„optionalæ ‡ç­¾å€¼è®¾ä¸ºäº†trueï¼Œæ­¤æ—¶Cåº“å†å¼•å…¥Båº“ä¾èµ–æ—¶ï¼ŒAåº“æ˜¯ä¸ä¼šè¢«å¼•å…¥åˆ°Cåº“çš„ã€‚\nåŒæ—¶è·ŸMavenä¼ é€’ä¾èµ–æœ‰å…³çš„è¿˜æœ‰ä¸€ä¸ªexclusionsæ ‡ç­¾ï¼Œè¿™ä¸ªè¡¨ç¤ºå°†æŸä¸ªåº“çš„æŸä¸ªå­ä¾èµ–æ’é™¤æ‰ï¼Œè¿™é‡Œä¸å†è¯¦è¿°ã€‚\n\n4 SpringBootå†…ç½®çš„å„ç§Starteræ˜¯æ€æ ·æ„å»ºçš„ï¼Ÿæˆ‘ä»¬ç°åœ¨æ¥æ¢ç©¶SpringBootå†…ç½®çš„å„ç§Starteråˆ°åº•æ˜¯æ€æ ·æ„å»ºçš„å‘¢ï¼Ÿ\nè¿˜è®°å¾—å¦‚ä½•åˆ†æSpringBootæºç æ¨¡å—åŠç»“æ„ï¼Ÿè¿™ç¯‡æ–‡ç« åˆ†æçš„SpringBootå†…éƒ¨çš„æ¨¡å—ä¹‹é—´çš„å…³ç³»å—ï¼Ÿå…ˆæ¥å›é¡¾ä¸€ä¸‹SpringBootæºç å†…éƒ¨æ¨¡å—å›¾ï¼š\nå›¾1\næˆ‘ä»¬éƒ½çŸ¥é“ï¼ŒSpringBootçš„Starterçš„æ„å»ºçš„åŸç†å®è´¨å°±æ˜¯è‡ªåŠ¨é…ç½®ï¼Œå› æ­¤ç”±å›¾1å¯ä»¥çœ‹åˆ°SpringBootæºç é¡¹ç›®å†…éƒ¨è·ŸStarteråŠå…¶è‡ªåŠ¨é…ç½®æœ‰å…³çš„æ¨¡å—æœ‰å››ä¸ªï¼šspring-boot-starters,spring-boot-actuator-autoconfigure,spring-boot-autoconfigureå’Œspring-boot-test-autoconfigureã€‚ æ¯ä¸ªæ¨¡å—çš„ä½œç”¨è¯·çœ‹å¦‚ä½•åˆ†æSpringBootæºç æ¨¡å—åŠç»“æ„ï¼Ÿè¿™ç¯‡æ–‡ç« ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚\né‚£ä¹ˆï¼Œspring-boot-startersæ¨¡å—è·Ÿåé¢ä¸‰ä¸ªè‡ªåŠ¨é…ç½®æœ‰å…³çš„æ¨¡å—xxx-autoconfigureæ¨¡å—çš„å…³ç³»æ˜¯æ€æ ·çš„å‘¢ï¼Ÿ\næ­¤æ—¶æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹spring-boot-startersæ¨¡å—é‡Œé¢çš„ç»“æ„æ˜¯æ€æ ·çš„ï¼Ÿ\nå›¾2\nç”±å›¾2å¯ä»¥çœ‹åˆ°spring-boot-startersæ¨¡å—åŒ…å«äº†SpringBootå†…ç½®çš„å„ç§starterï¼šspring-boot-starter-xxxã€‚ç”±äºSpringBootå†…ç½®çš„å„ç§starterå¤ªå¤šï¼Œä»¥æˆ‘ä»¬å¸¸ç”¨çš„spring-boot-starter-webèµ·æ­¥ä¾èµ–æ¥æ¢ç©¶å¥½äº†ã€‚\næˆ‘ä»¬é¦–å…ˆçœ‹ä¸‹spring-boot-starter-webæ¨¡å—å†…éƒ¨ç»“æ„ï¼š\nå›¾3\nå¯ä»¥çœ‹åˆ°spring-boot-starter-webæ¨¡å—é‡Œé¢åªæœ‰.flattened-pom.xmlå’Œpom.xmlæ–‡ä»¶ï¼Œè€Œæ²¡æœ‰ä»»ä½•ä»£ç ï¼æœ‰ç‚¹å‡ºä¹æˆ‘ä»¬æ„æ–™ã€‚æˆ‘ä»¬éƒ½çŸ¥é“è‹¥è¦ç”¨åˆ°SpringBootçš„webåŠŸèƒ½æ—¶å¼•å…¥spring-boot-starter-webèµ·æ­¥ä¾èµ–å³å¯ï¼Œè€Œç°åœ¨spring-boot-starter-webæ¨¡å—é‡Œé¢æ²¡æœ‰ä¸€è¡Œä»£ç ï¼Œé‚£ä¹ˆspring-boot-starter-webç©¶ç«Ÿæ˜¯å¦‚ä½•æ„å»ºçš„å‘¢ï¼Ÿä¼šä¸ä¼šè·Ÿå›¾1æ‰€ç¤ºçš„spring-boot-autoconfigureè‡ªåŠ¨é…ç½®æ¨¡å—æœ‰å…³ï¼Ÿ\næ­¤æ—¶æˆ‘ä»¬å°±éœ€è¦çœ‹ä¸‹spring-boot-starter-webæ¨¡å—çš„pom.xmlæ–‡ä»¶å†…å®¹ï¼š\nå›¾4\nç”±å›¾4å¯ä»¥çœ‹åˆ°ï¼Œspring-boot-starter-webæ¨¡å—ä¾èµ–äº†spring-boot-starter,spring-boot-starter-tomcat,spring-webå’Œspring-webmvcç­‰æ¨¡å—ï¼Œå±…ç„¶æ²¡æœ‰ä¾èµ–spring-boot-autoconfigureè‡ªåŠ¨é…ç½®æ¨¡å—!\nç”±äºspring-boot-starter-webæ¨¡å—è‚¯å®šè·Ÿspring-boot-autoconfigureè‡ªåŠ¨é…ç½®æ¨¡å—æœ‰å…³ï¼Œæ‰€ä»¥spring-boot-starter-webæ¨¡å—è‚¯å®šæ˜¯é—´æ¥ä¾èµ–äº†spring-boot-autoconfigureè‡ªåŠ¨é…ç½®æ¨¡å—ã€‚\nå›¾4æ ‡æœ‰æ ‡æ³¨â€é‡ç‚¹å…³æ³¨â€çš„spring-boot-starteræ¨¡å—æ˜¯ç»å¤§éƒ¨åˆ†spring-boot-starter-xxxæ¨¡å—ä¾èµ–çš„åŸºç¡€æ¨¡å—ï¼Œæ˜¯æ ¸å¿ƒçš„Starterï¼ŒåŒ…æ‹¬äº†è‡ªåŠ¨é…ç½®ï¼Œæ—¥å¿—å’ŒYAMLæ”¯æŒã€‚æˆ‘ä»¬æ­¤æ—¶æ¥å…³æ³¨ä¸‹spring-boot-starterçš„pom.xmlæ–‡ä»¶ï¼Œä¹Ÿè®¸å…¶ä¾èµ–äº†äº†spring-boot-autoconfigureè‡ªåŠ¨é…ç½®æ¨¡å—ã€‚\nå›¾5\nç”±å›¾5å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬å‰é¢çš„çŒœæƒ³æ²¡æœ‰é”™ï¼Œæ­£æ˜¯**spring-boot-starter**æ¨¡å—ä¾èµ–äº†**spring-boot-autoconfigure**è‡ªåŠ¨é…ç½®æ¨¡å—ï¼å› æ­¤ï¼Œåˆ°äº†è¿™é‡Œæˆ‘ä»¬å°±å¯ä»¥å¾—å‡ºç»“è®ºäº†ï¼š**_spring-boot-starter-web_**æ¨¡å—æ²¡æœ‰ä¸€è¡Œä»£ç ï¼Œä½†æ˜¯å…¶é€šè¿‡**_spring-boot-starter_****_æ¨¡å—_é—´æ¥**ä¾èµ–äº†spring-boot-autoconfigureè‡ªåŠ¨é…ç½®æ¨¡å—ï¼Œä»è€Œå®ç°äº†å…¶èµ·æ­¥ä¾èµ–çš„åŠŸèƒ½ã€‚\næ­¤æ—¶æˆ‘ä»¬å†æ¥çœ‹ä¸‹spring-boot-autoconfigureè‡ªåŠ¨é…ç½®æ¨¡å—çš„å†…éƒ¨åŒ…ç»“æ„ï¼š\nå›¾6\nç”±å›¾6çº¢æ¡†å¤„ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“spring-boot-starter-webèµ·æ­¥ä¾èµ–çš„è‡ªåŠ¨é…ç½®åŠŸèƒ½åŸæ¥æ˜¯ç”±spring-boot-autoconfigureæ¨¡å—çš„webåŒ…ä¸‹çš„ç±»å®ç°çš„ã€‚\nåˆ°äº†è¿™é‡Œspring-boot-starter-webèµ·æ­¥ä¾èµ–çš„æ„å»ºåŸºæœ¬åŸç†æˆ‘ä»¬å°±ææ¸…æ¥šäº†ï¼Œä½†æ˜¯è¿˜æœ‰ä¸€ä¸ªç‰¹åˆ«é‡è¦çš„å…³é”®ç‚¹æˆ‘ä»¬è¿˜æ²¡Getåˆ°ã€‚è¿™ä¸ªå…³é”®ç‚¹è·ŸMavençš„optionalæ ‡ç­¾æœ‰çš„ä½œç”¨æœ‰å…³ã€‚\nä¸ºäº†Getåˆ°è¿™ä¸ªç‚¹ï¼Œæˆ‘ä»¬å…ˆæ¥æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼šå¹³æ—¶æˆ‘ä»¬å¼€å‘webé¡¹ç›®ä¸ºä»€ä¹ˆå¼•å…¥äº†spring-boot-starter-webè¿™ä¸ªèµ·æ­¥ä¾èµ–åï¼Œspring-boot-autoconfigureæ¨¡å—çš„webç›¸å…³çš„è‡ªåŠ¨é…ç½®ç±»å°±ä¼šèµ·è‡ªåŠ¨èµ·ä½œç”¨å‘¢ï¼Ÿ\næˆ‘ä»¬åº”è¯¥çŸ¥é“ï¼ŒæŸä¸ªè‡ªåŠ¨é…ç½®ç±»èµ·ä½œç”¨å¾€å¾€æ˜¯ç”±äºclasspathä¸­å­˜åœ¨æŸä¸ªç±»ï¼Œè¿™é‡Œä»¥DispatcherServletAutoConfigurationè¿™ä¸ªè‡ªåŠ¨é…ç½®ç±»ä¸ºåˆ‡å…¥ç‚¹å»Getè¿™ä¸ªç‚¹å¥½äº†ã€‚ å…ˆçœ‹ä¸‹DispatcherServletAutoConfigurationèƒ½å¤Ÿè‡ªåŠ¨é…ç½®çš„æ¡ä»¶æ˜¯å•¥ï¼Ÿ\nå›¾7\nç”±å›¾7æ‰€ç¤ºï¼ŒDispatcherServletAutoConfigurationèƒ½å¤Ÿè‡ªåŠ¨é…ç½®çš„æ¡ä»¶ä¹‹ä¸€æ˜¯@ConditionalOnClass(DispatcherServlet.class)ï¼Œå³åªæœ‰classpathä¸­å­˜åœ¨DispatcherServlet.classè¿™ä¸ªç±»ï¼Œé‚£ä¹ˆDispatcherServletAutoConfigurationè‡ªåŠ¨é…ç½®ç›¸å…³é€»è¾‘æ‰èƒ½èµ·ä½œç”¨ã€‚\nè€ŒDispatcherServletè¿™ä¸ªç±»æ˜¯åœ¨spring-webmvcè¿™ä¸ªä¾èµ–åº“ä¸­çš„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nå›¾8\næ­¤æ—¶æˆ‘ä»¬å†çœ‹ä¸‹spring-boot-autoconfigureæ¨¡å—çš„pom.xmlæ–‡ä»¶å¼•å…¥spring-webmvcè¿™ä¸ªä¾èµ–çš„æƒ…å†µï¼š\nå›¾9\nç”±å›¾9æ‰€ç¤ºï¼Œspring-boot-autoconfigureæ¨¡å—å¼•å…¥çš„spring-webmvcè¿™ä¸ªä¾èµ–æ—¶optionalè¢«è®¾ç½®ä¸ºtrueï¼ŒåŸæ¥æ˜¯å¯é€‰ä¾èµ–ã€‚å³spring-webmvcè¿™ä¸ªä¾èµ–åº“åªä¼šè¢«å¯¼å…¥åˆ°spring-boot-autoconfigureæ¨¡å—ä¸­ï¼Œè€Œä¸ä¼šè¢«å¯¼å…¥åˆ°é—´æ¥ä¾èµ–spring-boot-autoconfigureæ¨¡å—çš„spring-boot-starter-webè¿™ä¸ªèµ·æ­¥ä¾èµ–ä¸­ã€‚\næ­¤æ—¶ï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹spring-boot-starter-webçš„pom.xmlæ–‡ä»¶çš„ä¾èµ–æƒ…å†µï¼š\nå›¾10\nç”±å›¾10æ‰€ç¤ºï¼Œspring-boot-starter-webèµ·æ­¥ä¾èµ–æ˜¾å¼å¼•å…¥äº†spring-webmvcè¿™ä¸ªä¾èµ–åº“ï¼Œå³å¼•å…¥spring-webmvc Â  æ—¶æ²¡æœ‰optionalè¿™ä¸ªæ ‡ç­¾ï¼Œåˆå› ä¸ºDispatcherServletè¿™ä¸ªç±»æ˜¯åœ¨spring-webmvcè¿™ä¸ªä¾èµ–åº“ä¸­çš„,ä»è€Œclasspathä¸­å­˜åœ¨DispatcherServletè¿™ä¸ªç±»ï¼Œå› æ­¤DispatcherServletAutoConfigurationè¿™ä¸ªè‡ªåŠ¨é…ç½®ç±»å°±ç”Ÿæ•ˆäº†ã€‚å½“ç„¶ï¼Œwebç›¸å…³çš„å…¶ä»–è‡ªåŠ¨é…ç½®ç±»ç”Ÿæ•ˆä¹Ÿæ˜¯è¿™ä¸ªåŸç†ã€‚\nè‡³æ­¤ï¼Œæˆ‘ä»¬ä¹Ÿæ˜ç™½äº†spring-boot-autoconfigureæ¨¡å—ä¸ºä»€ä¹ˆè¦æŠŠå¼•å…¥çš„spring-webmvcè¿™ä¸ªä¾èµ–ä½œä¸ºå¯é€‰ä¾èµ–äº†ï¼Œå…¶ç›®çš„å°±æ˜¯ä¸ºäº†åœ¨spring-boot-starter-webèµ·æ­¥ä¾èµ–ä¸­èƒ½æ˜¾å¼å¼•å…¥spring-webmvcè¿™ä¸ªä¾èµ–ï¼ˆè¿™ä¸ªèµ·å†³å®šæ€§ä½œç”¨ï¼‰ï¼Œä»è€Œæˆ‘ä»¬å¼€å‘webé¡¹ç›®åªè¦å¼•å…¥äº†spring-boot-starter-webèµ·æ­¥ä¾èµ–ï¼Œé‚£ä¹ˆwebç›¸å…³çš„è‡ªåŠ¨é…ç½®ç±»å°±ç”Ÿæ•ˆï¼Œä»è€Œå¯ä»¥å¼€ç®±å³ç”¨è¿™ä¸ªå°±æ˜¯spring-boot-starter-webè¿™ä¸ªèµ·æ­¥ä¾èµ–çš„æ„å»ºåŸç†äº†ã€‚\nå‰é¢æåˆ°çš„spring-boot-starter-actuator,spring-boot-starter-teståŠå…¶ä»–å†…ç½®çš„spring-boot-starter-xxxçš„èµ·æ­¥ä¾èµ–çš„æ„å»ºåŸç†ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œåªä¸è¿‡spring-boot-starter-actuatorä¾èµ–çš„æ˜¯spring-boot-actuator-autoconfigureï¼Œspring-boot-starter-testä¾èµ–çš„æ˜¯spring-boot-test-autoconfigureæ¨¡å—ç½¢äº†ï¼Œè¿™é‡Œä¸å†è¯¦è¿°ã€‚\n\n\n\n\n\n\n\n\n\næ€è€ƒï¼šspring-boot-actuator-autoconfigureçš„pom.xmlæ–‡ä»¶å¼•å…¥äº†20å¤šä¸ªå¯é€‰ä¾èµ–ï¼Œè€Œä¸ºä»€ä¹ˆspring-boot-starter-actuatorèµ·æ­¥ä¾èµ–åªå¼•å…¥äº†micrometer-coreè¿™ä¸ªä¾èµ–å‘¢ï¼Ÿ\n\n5 æ¨¡ä»¿SpringBootåŒ…ç»“æ„è‡ªå®šä¹‰ä¸€ä¸ªStarterå‰é¢åˆ†æäº†SpringBootå†…ç½®çš„å„ç§Starterçš„æ„å»ºåŸç†ï¼Œç†è®ºè”ç³»å®è·µï¼Œé‚£ä¹ˆå¦‚æœèƒ½å¤ŸåŠ¨æ‰‹å®è·µä¸€ä¸‹è‡ªå®šä¹‰Starteré‚£å°±æ›´å¥½äº†ã€‚\nä¸‹é¢æä¾›ä¸€ä¸ªè‡ªå®šä¹‰Starterçš„ä¸€ä¸ªç®€å•Demoï¼Œè¿™ä¸ªDemoå®Œå…¨æ¨¡ä»¿SpringBootå†…ç½®Starterçš„å†…éƒ¨åŒ…ç»“æ„æ¥ç¼–å†™ï¼Œå¯¹äºè¿›ä¸€æ­¥äº†è§£SpringBootå†…ç½®çš„å„ç§Starterçš„æ„å»ºåŸç†å¾ˆæœ‰å¸®åŠ©ã€‚\nä¸‹é¢æ˜¯è¿™ä¸ªDemoçš„githubåœ°å€ï¼Œæ¨èç»™æœ‰å…´è¶£çš„å°ä¼™ä¼´ä»¬ã€‚ æ¨¡ä»¿springbootå†…éƒ¨ç»“æ„è‡ªå®šä¹‰Starterã€‚æ­¤å¤–ï¼Œå¦‚ä½•è‡ªå®šä¹‰ä¸€ä¸ªStarterï¼Œå¯ä»¥å‚è€ƒä¸‹Mybatisçš„spring-boot-starteræ˜¯å¦‚ä½•ç¼–å†™çš„ã€‚\n\n6 å°ç»“å¥½äº†ï¼ŒSpringBootå†…ç½®çš„å„ç§Starterçš„æ„å»ºåŸç†åˆ†æå°±åˆ°æ­¤ç»“æŸäº†ï¼Œç°å°†å…³é”®ç‚¹æ€»ç»“ä¸‹ï¼š\n\nspring-boot-starter-xxxèµ·æ­¥ä¾èµ–æ²¡æœ‰ä¸€è¡Œä»£ç ï¼Œè€Œæ˜¯ç›´æ¥æˆ–é—´æ¥ä¾èµ–äº†xxx-autoconfigureæ¨¡å—ï¼Œè€Œxxx-autoconfigureæ¨¡å—æ‰¿æ‹…äº†spring-boot-starter-xxxèµ·æ­¥ä¾èµ–è‡ªåŠ¨é…ç½®çš„å®ç°ï¼›\nxxx-autoconfigureè‡ªåŠ¨é…ç½®æ¨¡å—å¼•å…¥äº†ä¸€äº›å¯é€‰ä¾èµ–ï¼Œè¿™äº›å¯é€‰ä¾èµ–ä¸ä¼šè¢«ä¼ é€’åˆ°spring-boot-starter-xxxèµ·æ­¥ä¾èµ–ä¸­ï¼Œè¿™æ˜¯èµ·æ­¥ä¾èµ–æ„å»ºçš„å…³é”®ç‚¹ï¼›\nspring-boot-starter-xxxèµ·æ­¥ä¾èµ–æ˜¾å¼å¼•å…¥äº†ä¸€äº›å¯¹è‡ªåŠ¨é…ç½®èµ·ä½œç”¨çš„å¯é€‰ä¾èµ–ï¼›\nç»è¿‡å‰é¢3æ­¥çš„å‡†å¤‡ï¼Œæˆ‘ä»¬é¡¹ç›®åªè¦å¼•å…¥äº†æŸä¸ªèµ·æ­¥ä¾èµ–åï¼Œå°±å¯ä»¥å¼€ç®±å³ç”¨äº†ï¼Œè€Œä¸ç”¨æ‰‹åŠ¨å»åˆ›å»ºä¸€äº›beanç­‰ã€‚\n\n7 SpringBootçš„å¯åŠ¨æµç¨‹\n1 æ¸©æ•…è€ŒçŸ¥æ–°æ¸©æ•…è€ŒçŸ¥æ–°ï¼Œæˆ‘ä»¬æ¥ç®€å•å›é¡¾ä¸€ä¸‹ä¸Šç¯‡çš„å†…å®¹ï¼Œä¸Šä¸€ç¯‡æˆ‘ä»¬åˆ†æäº†**SpringBootå†…ç½®çš„å„ç§Starteræ˜¯æ€æ ·æ„å»ºçš„?**ï¼Œç°å°†å…³é”®ç‚¹é‡æ–°å›é¡¾æ€»ç»“ä¸‹ï¼š\n\nspring-boot-starter-xxxèµ·æ­¥ä¾èµ–æ²¡æœ‰ä¸€è¡Œä»£ç ï¼Œè€Œæ˜¯ç›´æ¥æˆ–é—´æ¥ä¾èµ–äº†xxx-autoconfigureæ¨¡å—ï¼Œè€Œxxx-autoconfigureæ¨¡å—æ‰¿æ‹…äº†spring-boot-starter-xxxèµ·æ­¥ä¾èµ–è‡ªåŠ¨é…ç½®çš„å®ç°ï¼›\nxxx-autoconfigureè‡ªåŠ¨é…ç½®æ¨¡å—å¼•å…¥äº†ä¸€äº›å¯é€‰ä¾èµ–ï¼Œè¿™äº›å¯é€‰ä¾èµ–ä¸ä¼šè¢«ä¼ é€’åˆ°spring-boot-starter-xxxèµ·æ­¥ä¾èµ–ä¸­ï¼Œè¿™æ˜¯èµ·æ­¥ä¾èµ–æ„å»ºçš„å…³é”®ç‚¹ï¼›\nspring-boot-starter-xxxèµ·æ­¥ä¾èµ–æ˜¾å¼å¼•å…¥äº†ä¸€äº›å¯¹è‡ªåŠ¨é…ç½®èµ·ä½œç”¨çš„å¯é€‰ä¾èµ–ï¼Œå› æ­¤ä¼šè§¦å‘ xxx-autoconfigureè‡ªåŠ¨é…ç½®çš„é€»è¾‘ï¼ˆæ¯”å¦‚åˆ›å»ºæŸäº›ç¬¦åˆæ¡ä»¶çš„é…ç½®beanï¼‰ï¼›\nç»è¿‡å‰é¢3æ­¥çš„å‡†å¤‡ï¼Œæˆ‘ä»¬é¡¹ç›®åªè¦å¼•å…¥äº†æŸä¸ªèµ·æ­¥ä¾èµ–åï¼Œå°±å¯ä»¥å¼€ç®±å³ç”¨äº†ï¼Œè€Œä¸ç”¨æ‰‹åŠ¨å»åˆ›å»ºä¸€äº›beanç­‰ã€‚\n\n\n2 å¼•è¨€æœ¬æ¥è¿™ç¯‡æ–‡ç« ä¼šç»§ç»­SpringBootè‡ªåŠ¨é…ç½®çš„æºç åˆ†æçš„ï¼Œæƒ³åˆ†æä¸‹spring-boot-starter-webçš„è‡ªåŠ¨é…ç½®çš„æºç æ˜¯æ€æ ·çš„çš„ã€‚ä½†æ˜¯è€ƒè™‘åˆ°spring-boot-starter-webçš„è‡ªåŠ¨é…ç½®é€»è¾‘è·Ÿå†…ç½®Tomcatç­‰æœ‰å…³ï¼Œå› æ­¤æƒ³ä»¥åç­‰åˆ†æäº†SpringBootçš„å†…ç½®Tomcatçš„ç›¸å…³æºç åå†æ¥ç»§ç»­åˆ†æspring-boot-starter-webçš„è‡ªåŠ¨é…ç½®çš„æºç ã€‚\nå› æ­¤ï¼Œæœ¬ç¯‡æˆ‘ä»¬æ¥æ¢ç©¶ä¸‹SpringBootçš„å¯åŠ¨æµç¨‹æ˜¯æ€æ ·çš„ï¼Ÿ\n\n3 å¦‚ä½•ç¼–å†™ä¸€ä¸ªSpringBootå¯åŠ¨ç±»æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œæˆ‘ä»¬è¿è¡Œä¸€ä¸ªSpringBooté¡¹ç›®ï¼Œå¼•å…¥ç›¸å…³Starterså’Œç›¸å…³ä¾èµ–åï¼Œå†ç¼–å†™ä¸€ä¸ªå¯åŠ¨ç±»ï¼Œç„¶ååœ¨è¿™ä¸ªå¯åŠ¨ç±»æ ‡ä¸Š@SpringBootApplicationæ³¨è§£ï¼Œç„¶åå°±å¯ä»¥å¯åŠ¨è¿è¡Œé¡¹ç›®äº†ï¼Œå¦‚ä¸‹ä»£ç ï¼š\n//MainApplication.java\n\n@SpringBootApplication\npublic class MainApplication &#123;\n\tpublic static void main(String[] args) &#123;\n\t\tSpringApplication.run(MainApplication.class, args);\n\t&#125;\n&#125;\n\nå¦‚ä¸Šä»£ç ï¼Œæˆ‘ä»¬åœ¨MainApplicationå¯åŠ¨ç±»ä¸Šæ ‡æ³¨äº†@SpringBootApplicationæ³¨è§£ï¼Œç„¶ååœ¨mainå‡½æ•°ä¸­è°ƒç”¨SpringApplication.run(MainApplication.class, args);è¿™å¥ä»£ç å°±å®Œæˆäº†SpringBootçš„å¯åŠ¨æµç¨‹ï¼Œéå¸¸ç®€å•ã€‚\n\n4 @SpringBootApplicationç°åœ¨æˆ‘ä»¬æ¥åˆ†æä¸‹æ ‡æ³¨åœ¨å¯åŠ¨ç±»ä¸Šçš„@SpringBootApplicationæ³¨è§£ï¼Œç›´æ¥ä¸Šæºç ï¼š\n// SpringBootApplication.java \n\n@Target(ElementType.TYPE)\n@Retention(RetentionPolicy.RUNTIME)\n@Documented\n@Inherited\n@SpringBootConfiguration\n@EnableAutoConfiguration\n@ComponentScan(excludeFilters = &#123; // TODO è¿™ä¸¤ä¸ªæ’é™¤è¿‡æ»¤å™¨TypeExcludeFilterå’ŒAutoConfigurationExcludeFilteræš‚ä¸çŸ¥é“å•¥ä½œç”¨\n\t\t@Filter(type = FilterType.CUSTOM, classes = TypeExcludeFilter.class),\n\t\t@Filter(type = FilterType.CUSTOM, classes = AutoConfigurationExcludeFilter.class) &#125;)\npublic @interface SpringBootApplication &#123;\n        // ç­‰åŒäºEnableAutoConfigurationæ³¨è§£çš„excludeå±æ€§\n\t@AliasFor(annotation = EnableAutoConfiguration.class)\n\tClass&lt;?>[] exclude() default &#123;&#125;;\n        // ç­‰åŒäºEnableAutoConfigurationæ³¨è§£çš„excludeNameå±æ€§\n\t@AliasFor(annotation = EnableAutoConfiguration.class)\n\tString[] excludeName() default &#123;&#125;;\n        // ç­‰åŒäºComponentScanæ³¨è§£çš„basePackageså±æ€§\n\t@AliasFor(annotation = ComponentScan.class, attribute = \"basePackages\")\n\tString[] scanBasePackages() default &#123;&#125;;\n        // ç­‰åŒäºComponentScanæ³¨è§£çš„basePackageClasseså±æ€§\n\t@AliasFor(annotation = ComponentScan.class, attribute = \"basePackageClasses\")\n\tClass&lt;?>[] scanBasePackageClasses() default &#123;&#125;;\n&#125;\n\nå¯ä»¥çœ‹åˆ°ï¼Œ@SpringBootApplicationæ³¨è§£æ˜¯ä¸€ä¸ªç»„åˆæ³¨è§£ï¼Œä¸»è¦ç”±@SpringBootConfiguration,@EnableAutoConfigurationå’Œ@ComponentScanè¿™ä¸‰ä¸ªæ³¨è§£ç»„åˆè€Œæˆã€‚\nå› æ­¤@SpringBootApplicationæ³¨è§£ä¸»è¦ä½œä¸ºä¸€ä¸ªé…ç½®ç±»ï¼Œèƒ½å¤Ÿè§¦å‘åŒ…æ‰«æå’Œè‡ªåŠ¨é…ç½®çš„é€»è¾‘ï¼Œä»è€Œä½¿å¾—SpringBootçš„ç›¸å…³beanè¢«æ³¨å†Œè¿›Springå®¹å™¨ã€‚\n\n5 SpringBootçš„å¯åŠ¨æµç¨‹æ˜¯æ€æ ·çš„ï¼Ÿæ¥ä¸‹æ¥æ˜¯æœ¬ç¯‡çš„é‡ç‚¹ï¼Œæˆ‘ä»¬æ¥åˆ†æä¸‹SpringBootçš„å¯åŠ¨æµç¨‹æ˜¯æ€æ ·çš„ï¼Ÿ\næˆ‘ä»¬æ¥ç€æ¥çœ‹å‰é¢mainå‡½æ•°é‡Œçš„SpringApplication.run(MainApplication.class, args);è¿™å¥ä»£ç ï¼Œé‚£ä¹ˆSpringApplicationè¿™ä¸ªç±»æ˜¯å¹²å˜›çš„å‘¢ï¼Ÿ\nSpringApplicationç±»æ˜¯ç”¨æ¥å¯åŠ¨SpringBooté¡¹ç›®çš„ï¼Œå¯ä»¥åœ¨javaçš„mainæ–¹æ³•ä¸­å¯åŠ¨ï¼Œç›®å‰æˆ‘ä»¬çŸ¥é“è¿™äº›å°±è¶³å¤Ÿäº†ã€‚ä¸‹é¢çœ‹ä¸‹SpringApplication.run(MainApplication.class, args);è¿™å¥ä»£ç çš„æºç ï¼š\n// SpringApplication.java\n\n// runæ–¹æ³•æ˜¯ä¸€ä¸ªé™æ€æ–¹æ³•ï¼Œç”¨äºå¯åŠ¨SpringBoot\npublic static ConfigurableApplicationContext run(Class&lt;?> primarySource,\n\t\tString... args) &#123;\n\t// ç»§ç»­è°ƒç”¨é™æ€çš„runæ–¹æ³•\n\treturn run(new Class&lt;?>[] &#123; primarySource &#125;, args);\n&#125;\n\nåœ¨ä¸Šé¢çš„é™æ€runæ–¹æ³•é‡Œåˆç»§ç»­è°ƒç”¨å¦ä¸€ä¸ªé™æ€runæ–¹æ³•ï¼š\n// SpringApplication.java\n\n// runæ–¹æ³•æ˜¯ä¸€ä¸ªé™æ€æ–¹æ³•ï¼Œç”¨äºå¯åŠ¨SpringBoot\npublic static ConfigurableApplicationContext run(Class&lt;?>[] primarySources,\n\t\tString[] args) &#123;\n\t// æ„å»ºä¸€ä¸ªSpringApplicationå¯¹è±¡ï¼Œå¹¶è°ƒç”¨å…¶runæ–¹æ³•æ¥å¯åŠ¨\n\treturn new SpringApplication(primarySources).run(args);\n&#125;\n\nå¦‚ä¸Šä»£ç ï¼Œå¯ä»¥çœ‹åˆ°æ„å»ºäº†ä¸€ä¸ªSpringApplicationå¯¹è±¡ï¼Œç„¶åå†è°ƒç”¨å…¶runæ–¹æ³•æ¥å¯åŠ¨SpringBooté¡¹ç›®ã€‚å…³äºSpringApplicationå¯¹è±¡æ˜¯å¦‚ä½•æ„å»ºçš„ï¼Œæˆ‘ä»¬åé¢å†åˆ†æï¼Œç°åœ¨ç›´æ¥æ¥çœ‹ä¸‹å¯åŠ¨æµç¨‹çš„æºç ï¼š\n// SpringApplication.java\n\npublic ConfigurableApplicationContext run(String... args) &#123;\n\t// new ä¸€ä¸ªStopWatchç”¨äºç»Ÿè®¡runå¯åŠ¨è¿‡ç¨‹èŠ±äº†å¤šå°‘æ—¶é—´\n\tStopWatch stopWatch = new StopWatch();\n\t// å¼€å§‹è®¡æ—¶\n\tstopWatch.start();\n\tConfigurableApplicationContext context = null;\n\t// exceptionReportersé›†åˆç”¨æ¥å­˜å‚¨å¼‚å¸¸æŠ¥å‘Šå™¨ï¼Œç”¨æ¥æŠ¥å‘ŠSpringBootå¯åŠ¨è¿‡ç¨‹çš„å¼‚å¸¸\n\tCollection&lt;SpringBootExceptionReporter> exceptionReporters = new ArrayList&lt;>();\n\t// é…ç½®headlesså±æ€§ï¼Œå³â€œjava.awt.headlessâ€å±æ€§ï¼Œé»˜è®¤ä¸ºture\n\t// å…¶å®æ˜¯æƒ³è®¾ç½®è¯¥åº”ç”¨ç¨‹åº,å³ä½¿æ²¡æœ‰æ£€æµ‹åˆ°æ˜¾ç¤ºå™¨,ä¹Ÿå…è®¸å…¶å¯åŠ¨.å¯¹äºæœåŠ¡å™¨æ¥è¯´,æ˜¯ä¸éœ€è¦æ˜¾ç¤ºå™¨çš„,æ‰€ä»¥è¦è¿™æ ·è®¾ç½®.\n\tconfigureHeadlessProperty();\n\t// ã€1ã€‘ä»spring.factoriesé…ç½®æ–‡ä»¶ä¸­åŠ è½½åˆ°EventPublishingRunListenerå¯¹è±¡å¹¶èµ‹å€¼ç»™SpringApplicationRunListeners\n\t// EventPublishingRunListenerå¯¹è±¡ä¸»è¦ç”¨æ¥å‘å°„SpringBootå¯åŠ¨è¿‡ç¨‹ä¸­å†…ç½®çš„ä¸€äº›ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼Œæ ‡å¿—æ¯ä¸ªä¸åŒå¯åŠ¨é˜¶æ®µ\n\tSpringApplicationRunListeners listeners = getRunListeners(args);\n\t// å¯åŠ¨SpringApplicationRunListenerçš„ç›‘å¬ï¼Œè¡¨ç¤ºSpringApplicationå¼€å§‹å¯åŠ¨ã€‚\n\t// ã€‹ã€‹ã€‹ã€‹ã€‹å‘å°„ã€ApplicationStartingEventã€‘äº‹ä»¶\n\tlisteners.starting();\n\ttry &#123;\n\t\t// åˆ›å»ºApplicationArgumentså¯¹è±¡ï¼Œå°è£…äº†argså‚æ•°\n\t\tApplicationArguments applicationArguments = new DefaultApplicationArguments(\n\t\t\t\targs);\n\t\t// ã€2ã€‘å‡†å¤‡ç¯å¢ƒå˜é‡ï¼ŒåŒ…æ‹¬ç³»ç»Ÿå˜é‡ï¼Œç¯å¢ƒå˜é‡ï¼Œå‘½ä»¤è¡Œå‚æ•°ï¼Œé»˜è®¤å˜é‡ï¼Œservletç›¸å…³é…ç½®å˜é‡ï¼Œéšæœºå€¼ï¼Œ\n\t\t// JNDIå±æ€§å€¼ï¼Œä»¥åŠé…ç½®æ–‡ä»¶ï¼ˆæ¯”å¦‚application.propertiesï¼‰ç­‰ï¼Œæ³¨æ„è¿™äº›ç¯å¢ƒå˜é‡æ˜¯æœ‰ä¼˜å…ˆçº§çš„\n\t\t// ã€‹ã€‹ã€‹ã€‹ã€‹å‘å°„ã€ApplicationEnvironmentPreparedEventã€‘äº‹ä»¶\n\t\tConfigurableEnvironment environment = prepareEnvironment(listeners,\n\t\t\t\tapplicationArguments);\n\t\t// é…ç½®spring.beaninfo.ignoreå±æ€§ï¼Œé»˜è®¤ä¸ºtrueï¼Œå³è·³è¿‡æœç´¢BeanInfo classes.\n\t\tconfigureIgnoreBeanInfo(environment);\n\t\t// ã€3ã€‘æ§åˆ¶å°æ‰“å°SpringBootçš„bannneræ ‡å¿—\n\t\tBanner printedBanner = printBanner(environment);\n\t\t// ã€4ã€‘æ ¹æ®ä¸åŒç±»å‹åˆ›å»ºä¸åŒç±»å‹çš„spring applicationcontextå®¹å™¨\n\t\t// å› ä¸ºè¿™é‡Œæ˜¯servletç¯å¢ƒï¼Œæ‰€ä»¥åˆ›å»ºçš„æ˜¯AnnotationConfigServletWebServerApplicationContextå®¹å™¨å¯¹è±¡\n\t\tcontext = createApplicationContext();\n\t\t// ã€5ã€‘ä»spring.factoriesé…ç½®æ–‡ä»¶ä¸­åŠ è½½å¼‚å¸¸æŠ¥å‘ŠæœŸå®ä¾‹ï¼Œè¿™é‡ŒåŠ è½½çš„æ˜¯FailureAnalyzers\n\t\t// æ³¨æ„FailureAnalyzersçš„æ„é€ å™¨è¦ä¼ å…¥ConfigurableApplicationContextï¼Œå› ä¸ºè¦ä»contextä¸­è·å–beanFactoryå’Œenvironment\n\t\texceptionReporters = getSpringFactoriesInstances(\n\t\t\t\tSpringBootExceptionReporter.class,\n\t\t\t\tnew Class[] &#123; ConfigurableApplicationContext.class &#125;, context); // ConfigurableApplicationContextæ˜¯AnnotationConfigServletWebServerApplicationContextçš„çˆ¶æ¥å£\n\t\t// ã€6ã€‘ä¸ºåˆšåˆ›å»ºçš„AnnotationConfigServletWebServerApplicationContextå®¹å™¨å¯¹è±¡åšä¸€äº›åˆå§‹åŒ–å·¥ä½œï¼Œå‡†å¤‡ä¸€äº›å®¹å™¨å±æ€§å€¼ç­‰\n\t\t// 1ï¼‰ä¸ºAnnotationConfigServletWebServerApplicationContextçš„å±æ€§AnnotatedBeanDefinitionReaderå’ŒClassPathBeanDefinitionScannerè®¾ç½®environgmentå±æ€§\n\t\t// 2ï¼‰æ ¹æ®æƒ…å†µå¯¹ApplicationContextåº”ç”¨ä¸€äº›ç›¸å…³çš„åç½®å¤„ç†ï¼Œæ¯”å¦‚è®¾ç½®resourceLoaderå±æ€§ç­‰\n\t\t// 3ï¼‰åœ¨å®¹å™¨åˆ·æ–°å‰è°ƒç”¨å„ä¸ªApplicationContextInitializerçš„åˆå§‹åŒ–æ–¹æ³•ï¼ŒApplicationContextInitializeræ˜¯åœ¨æ„å»ºSpringApplicationå¯¹è±¡æ—¶ä»spring.factoriesä¸­åŠ è½½çš„\n\t\t// 4ï¼‰ã€‹ã€‹ã€‹ã€‹ã€‹å‘å°„ã€ApplicationContextInitializedEventã€‘äº‹ä»¶ï¼Œæ ‡å¿—contextå®¹å™¨è¢«åˆ›å»ºä¸”å·²å‡†å¤‡å¥½\n\t\t// 5ï¼‰ä»contextå®¹å™¨ä¸­è·å–beanFactoryï¼Œå¹¶å‘beanFactoryä¸­æ³¨å†Œä¸€äº›å•ä¾‹beanï¼Œæ¯”å¦‚applicationArgumentsï¼ŒprintedBanner\n\t\t// 6ï¼‰TODO åŠ è½½beanåˆ°application contextï¼Œæ³¨æ„è¿™é‡Œåªæ˜¯åŠ è½½äº†éƒ¨åˆ†beanæ¯”å¦‚mainApplicationè¿™ä¸ªbeanï¼Œå¤§éƒ¨åˆ†beanåº”è¯¥æ˜¯åœ¨AbstractApplicationContext.refreshæ–¹æ³•ä¸­è¢«åŠ è½½ï¼Ÿè¿™é‡Œç•™ä¸ªç–‘é—®å…ˆ\n\t\t// 7ï¼‰ã€‹ã€‹ã€‹ã€‹ã€‹å‘å°„ã€ApplicationPreparedEventã€‘äº‹ä»¶ï¼Œæ ‡å¿—Contextå®¹å™¨å·²ç»å‡†å¤‡å®Œæˆ\n\t\tprepareContext(context, environment, listeners, applicationArguments,\n\t\t\t\tprintedBanner);\n\t\t// ã€7ã€‘åˆ·æ–°å®¹å™¨ï¼Œè¿™ä¸€æ­¥è‡³å…³é‡è¦ï¼Œä»¥åä¼šåœ¨åˆ†æSpringæºç æ—¶è¯¦ç»†åˆ†æï¼Œä¸»è¦åšäº†ä»¥ä¸‹å·¥ä½œï¼š\n\t\t// 1ï¼‰åœ¨contextåˆ·æ–°å‰åšä¸€äº›å‡†å¤‡å·¥ä½œï¼Œæ¯”å¦‚åˆå§‹åŒ–ä¸€äº›å±æ€§è®¾ç½®ï¼Œå±æ€§åˆæ³•æ€§æ ¡éªŒå’Œä¿å­˜å®¹å™¨ä¸­çš„ä¸€äº›æ—©æœŸäº‹ä»¶ç­‰ï¼›\n\t\t// 2ï¼‰è®©å­ç±»åˆ·æ–°å…¶å†…éƒ¨bean factory,æ³¨æ„SpringBootå’ŒSpringå¯åŠ¨çš„æƒ…å†µæ‰§è¡Œé€»è¾‘ä¸ä¸€æ ·\n\t\t// 3ï¼‰å¯¹bean factoryè¿›è¡Œé…ç½®ï¼Œæ¯”å¦‚é…ç½®bean factoryçš„ç±»åŠ è½½å™¨ï¼Œåç½®å¤„ç†å™¨ç­‰\n\t\t// 4ï¼‰å®Œæˆbean factoryçš„å‡†å¤‡å·¥ä½œåï¼Œæ­¤æ—¶æ‰§è¡Œä¸€äº›åç½®å¤„ç†é€»è¾‘ï¼Œå­ç±»é€šè¿‡é‡å†™è¿™ä¸ªæ–¹æ³•æ¥åœ¨BeanFactoryåˆ›å»ºå¹¶é¢„å‡†å¤‡å®Œæˆä»¥ååšè¿›ä¸€æ­¥çš„è®¾ç½®\n\t\t// åœ¨è¿™ä¸€æ­¥ï¼Œæ‰€æœ‰çš„bean definitionså°†ä¼šè¢«åŠ è½½ï¼Œä½†æ­¤æ—¶beanè¿˜ä¸ä¼šè¢«å®ä¾‹åŒ–\n\t\t// 5ï¼‰æ‰§è¡ŒBeanFactoryPostProcessorçš„æ–¹æ³•å³è°ƒç”¨bean factoryçš„åç½®å¤„ç†å™¨ï¼š\n\t\t// BeanDefinitionRegistryPostProcessorï¼ˆè§¦å‘æ—¶æœºï¼šbeanå®šä¹‰æ³¨å†Œä¹‹å‰ï¼‰å’ŒBeanFactoryPostProcessorï¼ˆè§¦å‘æ—¶æœºï¼šbeanå®šä¹‰æ³¨å†Œä¹‹åbeanå®ä¾‹åŒ–ä¹‹å‰ï¼‰\n\t\t// 6ï¼‰æ³¨å†Œbeançš„åç½®å¤„ç†å™¨BeanPostProcessorï¼Œæ³¨æ„ä¸åŒæ¥å£ç±»å‹çš„BeanPostProcessorï¼›åœ¨Beanåˆ›å»ºå‰åçš„æ‰§è¡Œæ—¶æœºæ˜¯ä¸ä¸€æ ·çš„\n\t\t// 7ï¼‰åˆå§‹åŒ–å›½é™…åŒ–MessageSourceç›¸å…³çš„ç»„ä»¶ï¼Œæ¯”å¦‚æ¶ˆæ¯ç»‘å®šï¼Œæ¶ˆæ¯è§£æç­‰\n\t\t// 8ï¼‰åˆå§‹åŒ–äº‹ä»¶å¹¿æ’­å™¨ï¼Œå¦‚æœbean factoryæ²¡æœ‰åŒ…å«äº‹ä»¶å¹¿æ’­å™¨ï¼Œé‚£ä¹ˆnewä¸€ä¸ªSimpleApplicationEventMulticasterå¹¿æ’­å™¨å¯¹è±¡å¹¶æ³¨å†Œåˆ°bean factoryä¸­\n\t\t// 9ï¼‰AbstractApplicationContextå®šä¹‰äº†ä¸€ä¸ªæ¨¡æ¿æ–¹æ³•onRefreshï¼Œç•™ç»™å­ç±»è¦†å†™ï¼Œæ¯”å¦‚ServletWebServerApplicationContextè¦†å†™äº†è¯¥æ–¹æ³•æ¥åˆ›å»ºå†…åµŒçš„tomcatå®¹å™¨\n\t\t// 10ï¼‰æ³¨å†Œå®ç°äº†ApplicationListeneræ¥å£çš„ç›‘å¬å™¨ï¼Œä¹‹å‰å·²ç»æœ‰äº†äº‹ä»¶å¹¿æ’­å™¨ï¼Œæ­¤æ—¶å°±å¯ä»¥æ´¾å‘ä¸€äº›early application events\n\t\t// 11ï¼‰å®Œæˆå®¹å™¨bean factoryçš„åˆå§‹åŒ–ï¼Œå¹¶åˆå§‹åŒ–æ‰€æœ‰å‰©ä½™çš„å•ä¾‹beanã€‚è¿™ä¸€æ­¥éå¸¸é‡è¦ï¼Œä¸€äº›bean postprocessorä¼šåœ¨è¿™é‡Œè°ƒç”¨ã€‚\n\t\t// 12ï¼‰å®Œæˆå®¹å™¨çš„åˆ·æ–°å·¥ä½œï¼Œå¹¶ä¸”è°ƒç”¨ç”Ÿå‘½å‘¨æœŸå¤„ç†å™¨çš„onRefresh()æ–¹æ³•ï¼Œå¹¶ä¸”å‘å¸ƒContextRefreshedEventäº‹ä»¶\n\t\trefreshContext(context);\n\t\t// ã€8ã€‘æ‰§è¡Œåˆ·æ–°å®¹å™¨åçš„åç½®å¤„ç†é€»è¾‘ï¼Œæ³¨æ„è¿™é‡Œä¸ºç©ºæ–¹æ³•\n\t\tafterRefresh(context, applicationArguments);\n\t\t// åœæ­¢stopWatchè®¡æ—¶\n\t\tstopWatch.stop();\n\t\t// æ‰“å°æ—¥å¿—\n\t\tif (this.logStartupInfo) &#123;\n\t\t\tnew StartupInfoLogger(this.mainApplicationClass)\n\t\t\t\t\t.logStarted(getApplicationLog(), stopWatch);\n\t\t&#125;\n\t\t// ã€‹ã€‹ã€‹ã€‹ã€‹å‘å°„ã€ApplicationStartedEventã€‘äº‹ä»¶ï¼Œæ ‡å¿—springå®¹å™¨å·²ç»åˆ·æ–°ï¼Œæ­¤æ—¶æ‰€æœ‰çš„beanå®ä¾‹éƒ½å·²ç»åŠ è½½å®Œæ¯•\n\t\tlisteners.started(context);\n\t\t// ã€9ã€‘è°ƒç”¨ApplicationRunnerå’ŒCommandLineRunnerçš„runæ–¹æ³•ï¼Œå®ç°springå®¹å™¨å¯åŠ¨åéœ€è¦åšçš„ä¸€äº›ä¸œè¥¿æ¯”å¦‚åŠ è½½ä¸€äº›ä¸šåŠ¡æ•°æ®ç­‰\n\t\tcallRunners(context, applicationArguments);\n\t&#125;\n\t// ã€10ã€‘è‹¥å¯åŠ¨è¿‡ç¨‹ä¸­æŠ›å‡ºå¼‚å¸¸ï¼Œæ­¤æ—¶ç”¨FailureAnalyzersæ¥æŠ¥å‘Šå¼‚å¸¸\n\t// å¹¶ã€‹ã€‹ã€‹ã€‹ã€‹å‘å°„ã€ApplicationFailedEventã€‘äº‹ä»¶ï¼Œæ ‡å¿—SpringBootå¯åŠ¨å¤±è´¥\n\tcatch (Throwable ex) &#123;\n\t\thandleRunFailure(context, ex, exceptionReporters, listeners);\n\t\tthrow new IllegalStateException(ex);\n\t&#125;\n\n\ttry &#123;\n\t\t// ã€‹ã€‹ã€‹ã€‹ã€‹å‘å°„ã€ApplicationReadyEventã€‘äº‹ä»¶ï¼Œæ ‡å¿—SpringApplicationå·²ç»æ­£åœ¨è¿è¡Œå³å·²ç»æˆåŠŸå¯åŠ¨ï¼Œå¯ä»¥æ¥æ”¶æœåŠ¡è¯·æ±‚äº†ã€‚\n\t\tlisteners.running(context);\n\t&#125;\n\t// è‹¥å‡ºç°å¼‚å¸¸ï¼Œæ­¤æ—¶ä»…ä»…æŠ¥å‘Šå¼‚å¸¸ï¼Œè€Œä¸ä¼šå‘å°„ä»»ä½•äº‹ä»¶\n\tcatch (Throwable ex) &#123;\n\t\thandleRunFailure(context, ex, exceptionReporters, null);\n\t\tthrow new IllegalStateException(ex);\n\t&#125;\n\t// ã€11ã€‘æœ€ç»ˆè¿”å›å®¹å™¨\n\treturn context;\n&#125;\n\nå¦‚ä¸Šä»£ç å°±æ˜¯SpringBootçš„å¯åŠ¨æµç¨‹äº†ï¼Œå…¶ä¸­æ³¨é‡Šä¹Ÿéå¸¸è¯¦ç»†ï¼Œä¸»è¦æ­¥éª¤ä¹Ÿå·²ç»æ ‡æ³¨ã€xã€‘ï¼Œç°å°†ä¸»è¦æ­¥éª¤æ€»ç»“å¦‚ä¸‹ï¼š\n\nä»spring.factoriesé…ç½®æ–‡ä»¶ä¸­åŠ è½½**EventPublishingRunListener**å¯¹è±¡ï¼Œè¯¥å¯¹è±¡æ‹¥æœ‰SimpleApplicationEventMulticasterå±æ€§ï¼Œå³åœ¨SpringBootå¯åŠ¨è¿‡ç¨‹çš„ä¸åŒé˜¶æ®µç”¨æ¥å‘å°„å†…ç½®çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶;\nå‡†å¤‡ç¯å¢ƒå˜é‡ï¼ŒåŒ…æ‹¬ç³»ç»Ÿå˜é‡ï¼Œç¯å¢ƒå˜é‡ï¼Œå‘½ä»¤è¡Œå‚æ•°ï¼Œé»˜è®¤å˜é‡ï¼Œservletç›¸å…³é…ç½®å˜é‡ï¼Œéšæœºå€¼ä»¥åŠé…ç½®æ–‡ä»¶ï¼ˆæ¯”å¦‚application.propertiesï¼‰ç­‰;\næ§åˆ¶å°æ‰“å°SpringBootçš„**bannner**æ ‡å¿—ï¼›\næ ¹æ®ä¸åŒç±»å‹ç¯å¢ƒåˆ›å»ºä¸åŒç±»å‹çš„**applicationcontext**å®¹å™¨ï¼Œå› ä¸ºè¿™é‡Œæ˜¯servletç¯å¢ƒï¼Œæ‰€ä»¥åˆ›å»ºçš„æ˜¯AnnotationConfigServletWebServerApplicationContextå®¹å™¨å¯¹è±¡ï¼›\nä»spring.factoriesé…ç½®æ–‡ä»¶ä¸­åŠ è½½**FailureAnalyzers**å¯¹è±¡,ç”¨æ¥æŠ¥å‘ŠSpringBootå¯åŠ¨è¿‡ç¨‹ä¸­çš„å¼‚å¸¸ï¼›\nä¸ºåˆšåˆ›å»ºçš„å®¹å™¨å¯¹è±¡åšä¸€äº›åˆå§‹åŒ–å·¥ä½œï¼Œå‡†å¤‡ä¸€äº›å®¹å™¨å±æ€§å€¼ç­‰ï¼Œå¯¹ApplicationContextåº”ç”¨ä¸€äº›ç›¸å…³çš„åç½®å¤„ç†å’Œè°ƒç”¨å„ä¸ªApplicationContextInitializerçš„åˆå§‹åŒ–æ–¹æ³•æ¥æ‰§è¡Œä¸€äº›åˆå§‹åŒ–é€»è¾‘ç­‰ï¼›\nåˆ·æ–°å®¹å™¨ï¼Œè¿™ä¸€æ­¥è‡³å…³é‡è¦ã€‚æ¯”å¦‚è°ƒç”¨bean factoryçš„åç½®å¤„ç†å™¨ï¼Œæ³¨å†ŒBeanPostProcessoråç½®å¤„ç†å™¨ï¼Œåˆå§‹åŒ–äº‹ä»¶å¹¿æ’­å™¨ä¸”å¹¿æ’­äº‹ä»¶ï¼Œåˆå§‹åŒ–å‰©ä¸‹çš„å•ä¾‹beanå’ŒSpringBootåˆ›å»ºå†…åµŒçš„TomcatæœåŠ¡å™¨ç­‰ç­‰é‡è¦ä¸”å¤æ‚çš„é€»è¾‘éƒ½åœ¨è¿™é‡Œå®ç°ï¼Œä¸»è¦æ­¥éª¤å¯è§ä»£ç çš„æ³¨é‡Šï¼Œå…³äºè¿™é‡Œçš„é€»è¾‘ä¼šåœ¨ä»¥åçš„springæºç åˆ†æä¸“é¢˜è¯¦ç»†åˆ†æï¼›\næ‰§è¡Œåˆ·æ–°å®¹å™¨åçš„åç½®å¤„ç†é€»è¾‘ï¼Œæ³¨æ„è¿™é‡Œä¸ºç©ºæ–¹æ³•ï¼›\nè°ƒç”¨**ApplicationRunner**å’Œ**CommandLineRunner**çš„runæ–¹æ³•ï¼Œæˆ‘ä»¬å®ç°è¿™ä¸¤ä¸ªæ¥å£å¯ä»¥åœ¨springå®¹å™¨å¯åŠ¨åéœ€è¦çš„ä¸€äº›ä¸œè¥¿æ¯”å¦‚åŠ è½½ä¸€äº›ä¸šåŠ¡æ•°æ®ç­‰;\næŠ¥å‘Šå¯åŠ¨å¼‚å¸¸ï¼Œå³è‹¥å¯åŠ¨è¿‡ç¨‹ä¸­æŠ›å‡ºå¼‚å¸¸ï¼Œæ­¤æ—¶ç”¨FailureAnalyzersæ¥æŠ¥å‘Šå¼‚å¸¸;\næœ€ç»ˆè¿”å›å®¹å™¨å¯¹è±¡ï¼Œè¿™é‡Œè°ƒç”¨æ–¹æ³•æ²¡æœ‰å£°æ˜å¯¹è±¡æ¥æ¥æ”¶ã€‚\n\nå½“ç„¶åœ¨SpringBootå¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œæ¯ä¸ªä¸åŒçš„å¯åŠ¨é˜¶æ®µä¼šåˆ†åˆ«å‘å°„ä¸åŒçš„å†…ç½®ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼Œæ¯”å¦‚åœ¨å‡†å¤‡environmentå‰ä¼šå‘å°„ApplicationStartingEventäº‹ä»¶ï¼Œåœ¨environmentå‡†å¤‡å¥½åä¼šå‘å°„ApplicationEnvironmentPreparedEventäº‹ä»¶ï¼Œåœ¨åˆ·æ–°å®¹å™¨å‰ä¼šå‘å°„ApplicationPreparedEventäº‹ä»¶ç­‰ï¼Œæ€»ä¹‹SpringBootæ€»å…±å†…ç½®äº†7ä¸ªç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼Œé™¤äº†æ ‡å¿—SpringBootçš„ä¸åŒå¯åŠ¨é˜¶æ®µå¤–ï¼ŒåŒæ—¶ä¸€äº›ç›‘å¬å™¨ä¹Ÿä¼šç›‘å¬ç›¸åº”çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ä»è€Œæ‰§è¡Œä¸€äº›å¯åŠ¨åˆå§‹åŒ–é€»è¾‘ã€‚\n\n6 å°ç»“å¥½äº†ï¼ŒSpringBootçš„å¯åŠ¨æµç¨‹å°±å·²ç»åˆ†æå®Œäº†ï¼Œè¿™ç¯‡å†…å®¹ä¸»è¦è®©æˆ‘ä»¬å¯¹SpringBootçš„å¯åŠ¨æµç¨‹æœ‰ä¸€ä¸ªæ•´ä½“çš„è®¤è¯†ï¼Œç°åœ¨è¿˜æ²¡å¿…è¦å»æ·±ç©¶æ¯ä¸€ä¸ªç»†èŠ‚ï¼Œä»¥å…ä¸¢äº†ä¸»çº¿ï¼Œç°åœ¨æˆ‘ä»¬å¯¹SpringBootçš„å¯åŠ¨æµç¨‹æœ‰ä¸€ä¸ªæ•´ä½“çš„è®¤è¯†å³å¯ï¼Œå…³äºå¯åŠ¨æµç¨‹çš„ä¸€äº›é‡è¦æ­¥éª¤æˆ‘ä»¬ä¼šåœ¨ä»¥åçš„æºç åˆ†æä¸­æ¥æ·±ç©¶ã€‚\næ³¨ï¼šè¯¥æºç åˆ†æå¯¹åº”SpringBootç‰ˆæœ¬ä¸º2.1.0.RELEASEï¼Œæœ¬æ–‡å¯¹åº”çš„SpringBootæºç è§£æé¡¹ç›®githubåœ°å€ï¼šhttps://github.com/yuanmabiji/spring-boot-2.1.0.RELEASE\n8 SpringApplicationå¯¹è±¡æ˜¯å¦‚ä½•æ„å»ºçš„ï¼Ÿ\n1 æ¸©æ•…è€ŒçŸ¥æ–°æ¸©æ•…è€ŒçŸ¥æ–°ï¼Œæˆ‘ä»¬æ¥ç®€å•å›é¡¾ä¸€ä¸‹ä¸Šç¯‡çš„å†…å®¹ï¼Œä¸Šä¸€ç¯‡æˆ‘ä»¬åˆ†æäº†SpringBootçš„å¯åŠ¨æµç¨‹ï¼Œç°å°†å…³é”®æ­¥éª¤å†æµ“ç¼©æ€»ç»“ä¸‹ï¼š\n\næ„å»ºSpringApplicationå¯¹è±¡ï¼Œç”¨äºå¯åŠ¨SpringBootï¼›\nä»spring.factoriesé…ç½®æ–‡ä»¶ä¸­åŠ è½½EventPublishingRunListenerå¯¹è±¡ç”¨äºåœ¨ä¸åŒçš„å¯åŠ¨é˜¶æ®µå‘å°„ä¸åŒçš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼›\nå‡†å¤‡ç¯å¢ƒå˜é‡ï¼ŒåŒ…æ‹¬ç³»ç»Ÿå˜é‡ï¼Œç¯å¢ƒå˜é‡ï¼Œå‘½ä»¤è¡Œå‚æ•°åŠé…ç½®æ–‡ä»¶ï¼ˆæ¯”å¦‚application.propertiesï¼‰ç­‰ï¼›\nåˆ›å»ºå®¹å™¨ApplicationContext;\nä¸ºç¬¬4æ­¥åˆ›å»ºçš„å®¹å™¨å¯¹è±¡åšä¸€äº›åˆå§‹åŒ–å·¥ä½œï¼Œå‡†å¤‡ä¸€äº›å®¹å™¨å±æ€§å€¼ç­‰ï¼ŒåŒæ—¶è°ƒç”¨å„ä¸ªApplicationContextInitializerçš„åˆå§‹åŒ–æ–¹æ³•æ¥æ‰§è¡Œä¸€äº›åˆå§‹åŒ–é€»è¾‘ç­‰ï¼›\nåˆ·æ–°å®¹å™¨ï¼Œè¿™ä¸€æ­¥è‡³å…³é‡è¦ï¼Œæ˜¯é‡ç‚¹ä¸­çš„é‡ç‚¹ï¼Œå¤ªå¤šå¤æ‚é€»è¾‘åœ¨è¿™é‡Œå®ç°ï¼›\nè°ƒç”¨ApplicationRunnerå’ŒCommandLineRunnerçš„runæ–¹æ³•ï¼Œå¯ä»¥å®ç°è¿™ä¸¤ä¸ªæ¥å£åœ¨å®¹å™¨å¯åŠ¨åæ¥åŠ è½½ä¸€äº›ä¸šåŠ¡æ•°æ®ç­‰;\n\nåœ¨SpringBootå¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œæ¯ä¸ªä¸åŒçš„å¯åŠ¨é˜¶æ®µä¼šåˆ†åˆ«å‘å°„ä¸åŒçš„å†…ç½®ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼Œç„¶åç›¸åº”çš„ç›‘å¬å™¨ä¼šç›‘å¬è¿™äº›äº‹ä»¶æ¥æ‰§è¡Œä¸€äº›åˆå§‹åŒ–é€»è¾‘å·¥ä½œæ¯”å¦‚ConfigFileApplicationListenerä¼šç›‘å¬onApplicationEnvironmentPreparedEventäº‹ä»¶æ¥åŠ è½½ç¯å¢ƒå˜é‡ç­‰ã€‚\n\n2 å¼•è¨€ä¸Šç¯‡æ–‡ç« åœ¨è®²è§£SpringBootçš„å¯åŠ¨æµç¨‹ä¸­ï¼Œæˆ‘ä»¬æœ‰çœ‹åˆ°æ–°å»ºäº†ä¸€ä¸ªSpringApplicationå¯¹è±¡ç”¨æ¥å¯åŠ¨SpringBooté¡¹ç›®ã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬ä»Šå¤©å°±æ¥çœ‹çœ‹SpringApplicationå¯¹è±¡çš„æ„å»ºè¿‡ç¨‹ï¼ŒåŒæ—¶è®²è§£ä¸€ä¸‹SpringBootè‡ªå·±å®ç°çš„SPIæœºåˆ¶ã€‚\n\n3 SpringApplicationå¯¹è±¡çš„æ„å»ºè¿‡ç¨‹æœ¬å°èŠ‚å¼€å§‹è®²è§£SpringApplicationå¯¹è±¡çš„æ„é€ è¿‡ç¨‹ï¼Œå› ä¸ºä¸€ä¸ªå¯¹è±¡çš„æ„é€ æ— éå°±æ˜¯åœ¨å…¶æ„é€ å‡½æ•°é‡Œç»™å®ƒçš„ä¸€äº›æˆå‘˜å±æ€§èµ‹å€¼ï¼Œå¾ˆå°‘åŒ…å«å…¶ä»–é¢å¤–çš„ä¸šåŠ¡é€»è¾‘ï¼ˆå½“ç„¶æœ‰æ—¶å€™æˆ‘ä»¬å¯èƒ½ä¹Ÿä¼šåœ¨æ„é€ å‡½æ•°é‡Œå¼€å¯ä¸€äº›çº¿ç¨‹å•¥çš„ï¼‰ã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹æ„é€ SpringApplicationå¯¹è±¡æ—¶éœ€è¦ç”¨åˆ°çš„ä¸€äº›æˆå‘˜å±æ€§å“ˆï¼š\n// SpringApplication.java\n\n/**\n * SpringBootçš„å¯åŠ¨ç±»å³åŒ…å«mainå‡½æ•°çš„ä¸»ç±»\n */\nprivate Set&lt;Class&lt;?>> primarySources;\n/**\n * åŒ…å«mainå‡½æ•°çš„ä¸»ç±»\n */\nprivate Class&lt;?> mainApplicationClass;\n/**\n * èµ„æºåŠ è½½å™¨\n */\nprivate ResourceLoader resourceLoader;\n/**\n * åº”ç”¨ç±»å‹\n */\nprivate WebApplicationType webApplicationType;\n/**\n * åˆå§‹åŒ–å™¨\n */\nprivate List&lt;ApplicationContextInitializer&lt;?>> initializers;\n/**\n * ç›‘å¬å™¨\n */\nprivate List&lt;ApplicationListener&lt;?>> listeners;\n\nå¯ä»¥çœ‹åˆ°æ„å»ºSpringApplicationå¯¹è±¡æ—¶ä¸»è¦æ˜¯ç»™ä¸Šé¢ä»£ç ä¸­çš„å…­ä¸ªæˆå‘˜å±æ€§èµ‹å€¼ï¼Œç°åœ¨æˆ‘æ¥ç€æ¥çœ‹SpringApplicationå¯¹è±¡çš„æ„é€ è¿‡ç¨‹ã€‚\næˆ‘ä»¬å…ˆå›åˆ°ä¸Šä¸€ç¯‡æ–‡ç« è®²è§£çš„æ„å»ºSpringApplicationå¯¹è±¡çš„ä»£ç å¤„:\n// SpringApplication.java\n\n// runæ–¹æ³•æ˜¯ä¸€ä¸ªé™æ€æ–¹æ³•ï¼Œç”¨äºå¯åŠ¨SpringBoot\npublic static ConfigurableApplicationContext run(Class&lt;?>[] primarySources,\n\t\tString[] args) &#123;\n\t// æ„å»ºä¸€ä¸ªSpringApplicationå¯¹è±¡ï¼Œå¹¶è°ƒç”¨å…¶runæ–¹æ³•æ¥å¯åŠ¨\n\treturn new SpringApplication(primarySources).run(args);\n&#125;\n\nè·Ÿè¿›SpringApplicationçš„æ„é€ å‡½æ•°ä¸­ï¼š\n// SpringApplication.java\n\npublic SpringApplication(Class&lt;?>... primarySources) &#123;\n    // ç»§ç»­è°ƒç”¨SpringApplicationå¦ä¸€ä¸ªæ„é€ å‡½æ•°\n\tthis(null, primarySources);\n&#125;\n\nç»§ç»­è·Ÿè¿›SpringApplicationå¦ä¸€ä¸ªæ„é€ å‡½æ•°ï¼š\n// SpringApplication.java\n\npublic SpringApplication(ResourceLoader resourceLoader, Class&lt;?>... primarySources) &#123;\n\t// ã€1ã€‘ç»™resourceLoaderå±æ€§èµ‹å€¼ï¼Œæ³¨æ„ä¼ å…¥çš„resourceLoaderå‚æ•°ä¸ºnull\n\tthis.resourceLoader = resourceLoader;\n\tAssert.notNull(primarySources, \"PrimarySources must not be null\");\n\t// ã€2ã€‘ç»™primarySourceså±æ€§èµ‹å€¼ï¼Œä¼ å…¥çš„primarySourceså…¶å®å°±æ˜¯SpringApplication.run(MainApplication.class, args);ä¸­çš„MainApplication.class\n\tthis.primarySources = new LinkedHashSet&lt;>(Arrays.asList(primarySources));\n\t// ã€3ã€‘ç»™webApplicationTypeå±æ€§èµ‹å€¼ï¼Œæ ¹æ®classpathä¸­å­˜åœ¨å“ªç§ç±»å‹çš„ç±»æ¥ç¡®å®šæ˜¯å“ªç§åº”ç”¨ç±»å‹\n\tthis.webApplicationType = WebApplicationType.deduceFromClasspath();\n\t// ã€4ã€‘ç»™initializerså±æ€§èµ‹å€¼ï¼Œåˆ©ç”¨SpringBootè‡ªå®šä¹‰çš„SPIä»spring.factoriesä¸­åŠ è½½ApplicationContextInitializeræ¥å£çš„å®ç°ç±»å¹¶èµ‹å€¼ç»™initializerså±æ€§\n\tsetInitializers((Collection) getSpringFactoriesInstances(\n\t\t\tApplicationContextInitializer.class));\n\t// ã€5ã€‘ç»™listenerså±æ€§èµ‹å€¼ï¼Œåˆ©ç”¨SpringBootè‡ªå®šä¹‰çš„SPIä»spring.factoriesä¸­åŠ è½½ApplicationListeneræ¥å£çš„å®ç°ç±»å¹¶èµ‹å€¼ç»™listenerså±æ€§\n\tsetListeners((Collection) getSpringFactoriesInstances(ApplicationListener.class));\n\t// ã€6ã€‘ç»™mainApplicationClasså±æ€§èµ‹å€¼ï¼Œå³è¿™é‡Œè¦æ¨æ–­å“ªä¸ªç±»è°ƒç”¨äº†mainå‡½æ•°ï¼Œç„¶åå†èµ‹å€¼ç»™mainApplicationClasså±æ€§ï¼Œç”¨äºåé¢å¯åŠ¨æµç¨‹ä¸­æ‰“å°ä¸€äº›æ—¥å¿—ã€‚\n\tthis.mainApplicationClass = deduceMainApplicationClass();\n&#125;\n\nå¯ä»¥çœ‹åˆ°æ„å»ºSpringApplicationå¯¹è±¡æ—¶å…¶å®å°±æ˜¯ç»™å‰é¢è®²çš„6ä¸ªSpringApplicationç±»çš„æˆå‘˜å±æ€§èµ‹å€¼è€Œå·²ï¼Œåšä¸€äº›åˆå§‹åŒ–å·¥ä½œï¼š\n\nç»™**resourceLoader**å±æ€§èµ‹å€¼ï¼ŒresourceLoaderå±æ€§ï¼Œèµ„æºåŠ è½½å™¨ï¼Œæ­¤æ—¶ä¼ å…¥çš„resourceLoaderå‚æ•°ä¸ºnullï¼›\nç»™**primarySources**å±æ€§èµ‹å€¼ï¼ŒprimarySourceså±æ€§å³SpringApplication.run(MainApplication.class,args);ä¸­ä¼ å…¥çš„MainApplication.classï¼Œè¯¥ç±»ä¸ºSpringBooté¡¹ç›®çš„å¯åŠ¨ç±»ï¼Œä¸»è¦é€šè¿‡è¯¥ç±»æ¥æ‰«æConfigurationç±»åŠ è½½beanï¼›\nç»™**webApplicationType**å±æ€§èµ‹å€¼ï¼ŒwebApplicationTypeå±æ€§ï¼Œä»£è¡¨åº”ç”¨ç±»å‹ï¼Œæ ¹æ®classpathå­˜åœ¨çš„ç›¸åº”Applicationç±»æ¥åˆ¤æ–­ã€‚å› ä¸ºåé¢è¦æ ¹æ®webApplicationTypeæ¥ç¡®å®šåˆ›å»ºå“ªç§Environmentå¯¹è±¡å’Œåˆ›å»ºå“ªç§ApplicationContextï¼Œè¯¦ç»†åˆ†æè¯·è§åé¢çš„ç¬¬3.1å°èŠ‚ï¼›\nç»™**initializers**å±æ€§èµ‹å€¼ï¼Œinitializerså±æ€§ä¸ºList&lt;ApplicationContextInitializer&lt;?&gt;&gt;é›†åˆï¼Œåˆ©ç”¨SpringBootçš„SPIæœºåˆ¶ä»spring.factoriesé…ç½®æ–‡ä»¶ä¸­åŠ è½½ï¼Œåé¢åœ¨åˆå§‹åŒ–å®¹å™¨çš„æ—¶å€™ä¼šåº”ç”¨è¿™äº›åˆå§‹åŒ–å™¨æ¥æ‰§è¡Œä¸€äº›åˆå§‹åŒ–å·¥ä½œã€‚å› ä¸ºSpringBootè‡ªå·±å®ç°çš„SPIæœºåˆ¶æ¯”è¾ƒé‡è¦ï¼Œå› æ­¤ç‹¬ç«‹æˆä¸€å°èŠ‚æ¥åˆ†æï¼Œè¯¦ç»†åˆ†æè¯·è§åé¢çš„ç¬¬4å°èŠ‚ï¼›\nç»™**listeners**å±æ€§èµ‹å€¼ï¼Œlistenerså±æ€§ä¸ºList&lt;ApplicationListener&lt;?&gt;&gt;é›†åˆï¼ŒåŒæ ·åˆ©ç”¨åˆ©ç”¨SpringBootçš„SPIæœºåˆ¶ä»spring.factoriesé…ç½®æ–‡ä»¶ä¸­åŠ è½½ã€‚å› ä¸ºSpringBootå¯åŠ¨è¿‡ç¨‹ä¸­ä¼šåœ¨ä¸åŒçš„é˜¶æ®µå‘å°„ä¸€äº›äº‹ä»¶ï¼Œæ‰€ä»¥è¿™äº›åŠ è½½çš„ç›‘å¬å™¨ä»¬å°±æ˜¯æ¥ç›‘å¬SpringBootå¯åŠ¨è¿‡ç¨‹ä¸­çš„ä¸€äº›ç”Ÿå‘½å‘¨æœŸäº‹ä»¶çš„ï¼›\nç»™**mainApplicationClass**å±æ€§èµ‹å€¼ï¼ŒmainApplicationClasså±æ€§è¡¨ç¤ºåŒ…å«mainå‡½æ•°çš„ç±»ï¼Œå³è¿™é‡Œè¦æ¨æ–­å“ªä¸ªç±»è°ƒç”¨äº†mainå‡½æ•°ï¼Œç„¶åæŠŠè¿™ä¸ªç±»çš„å…¨é™å®šåèµ‹å€¼ç»™mainApplicationClasså±æ€§ï¼Œç”¨äºåé¢å¯åŠ¨æµç¨‹ä¸­æ‰“å°ä¸€äº›æ—¥å¿—ï¼Œè¯¦ç»†åˆ†æè§åé¢çš„ç¬¬3.2å°èŠ‚ã€‚\n\n\n3.1 æ¨æ–­é¡¹ç›®åº”ç”¨ç±»å‹æˆ‘ä»¬æ¥ç€åˆ†ææ„é€ SpringApplicationå¯¹è±¡çš„ç¬¬ã€3ã€‘æ­¥WebApplicationType.deduceFromClasspath();è¿™å¥ä»£ç ï¼š\n// WebApplicationType.java\n\npublic enum WebApplicationType &#123;\n        // æ™®é€šçš„åº”ç”¨\n\tNONE,\n\t// Servletç±»å‹çš„webåº”ç”¨\n\tSERVLET,\n\t// Reactiveç±»å‹çš„webåº”ç”¨\n\tREACTIVE;\n\n\tprivate static final String[] SERVLET_INDICATOR_CLASSES = &#123; \"javax.servlet.Servlet\",\n\t\t\t\"org.springframework.web.context.ConfigurableWebApplicationContext\" &#125;;\n\tprivate static final String WEBMVC_INDICATOR_CLASS = \"org.springframework.\"\n\t\t\t+ \"web.servlet.DispatcherServlet\";\n\tprivate static final String WEBFLUX_INDICATOR_CLASS = \"org.\"\n\t\t\t+ \"springframework.web.reactive.DispatcherHandler\";\n\tprivate static final String JERSEY_INDICATOR_CLASS = \"org.glassfish.jersey.servlet.ServletContainer\";\n\tprivate static final String SERVLET_APPLICATION_CONTEXT_CLASS = \"org.springframework.web.context.WebApplicationContext\";\n\tprivate static final String REACTIVE_APPLICATION_CONTEXT_CLASS = \"org.springframework.boot.web.reactive.context.ReactiveWebApplicationContext\";\n\n\tstatic WebApplicationType deduceFromClasspath() &#123;\n\t\t// è‹¥classpathä¸­ä¸å­˜åœ¨\"org.springframework.\" + \"web.servlet.DispatcherServlet\"å’Œ\"org.glassfish.jersey.servlet.ServletContainer\"\n\t\t// åˆ™è¿”å›WebApplicationType.REACTIVEï¼Œè¡¨æ˜æ˜¯reactiveåº”ç”¨\n\t\tif (ClassUtils.isPresent(WEBFLUX_INDICATOR_CLASS, null)\n\t\t\t\t&amp;&amp; !ClassUtils.isPresent(WEBMVC_INDICATOR_CLASS, null)\n\t\t\t\t&amp;&amp; !ClassUtils.isPresent(JERSEY_INDICATOR_CLASS, null)) &#123;\n\t\t\treturn WebApplicationType.REACTIVE;\n\t\t&#125;\n\t\t// è‹¥&#123; \"javax.servlet.Servlet\",\n\t\t//       \"org.springframework.web.context.ConfigurableWebApplicationContext\" &#125;\n\t\t// éƒ½ä¸å­˜åœ¨åœ¨classpathï¼Œåˆ™è¯´æ˜æ˜¯ä¸æ˜¯webåº”ç”¨\n\t\tfor (String className : SERVLET_INDICATOR_CLASSES) &#123;\n\t\t\tif (!ClassUtils.isPresent(className, null)) &#123;\n\t\t\t\treturn WebApplicationType.NONE;\n\t\t\t&#125;\n\t\t&#125;\n\t\t// æœ€ç»ˆè¿”å›æ™®é€šçš„webåº”ç”¨\n\t\treturn WebApplicationType.SERVLET;\n\t&#125;\n&#125;\n\nå¦‚ä¸Šä»£ç ï¼Œæ ¹æ®classpathåˆ¤æ–­åº”ç”¨ç±»å‹ï¼Œå³é€šè¿‡åå°„åŠ è½½classpathåˆ¤æ–­æŒ‡å®šçš„æ ‡å¿—ç±»å­˜åœ¨ä¸å¦æ¥åˆ†åˆ«åˆ¤æ–­æ˜¯Reactiveåº”ç”¨ï¼ŒServletç±»å‹çš„webåº”ç”¨è¿˜æ˜¯æ™®é€šçš„åº”ç”¨ã€‚\n\n3.2 æ¨æ–­å“ªä¸ªç±»è°ƒç”¨äº†mainå‡½æ•°æˆ‘ä»¬å…ˆè·³è¿‡æ„é€ SpringApplicationå¯¹è±¡çš„ç¬¬ã€4ã€‘æ­¥å’Œç¬¬ã€5ã€‘æ­¥ï¼Œå…ˆæ¥åˆ†ææ„é€ SpringApplicationå¯¹è±¡çš„ç¬¬ã€6ã€‘æ­¥this.mainApplicationClass = deduceMainApplicationClass();è¿™å¥ä»£ç ï¼š\n// SpringApplication.java\n\nprivate Class&lt;?> deduceMainApplicationClass() &#123;\n\ttry &#123;\n\t\t// è·å–StackTraceElementå¯¹è±¡æ•°ç»„stackTraceï¼ŒStackTraceElementå¯¹è±¡å­˜å‚¨äº†è°ƒç”¨æ ˆç›¸å…³ä¿¡æ¯ï¼ˆæ¯”å¦‚ç±»åï¼Œæ–¹æ³•åç­‰ï¼‰\n\t\tStackTraceElement[] stackTrace = new RuntimeException().getStackTrace();\n\t\t// éå†stackTraceæ•°ç»„\n\t\tfor (StackTraceElement stackTraceElement : stackTrace) &#123;\n\t\t\t// è‹¥stackTraceElementè®°å½•çš„è°ƒç”¨æ–¹æ³•åç­‰äºmain\n\t\t\tif (\"main\".equals(stackTraceElement.getMethodName())) &#123;\n\t\t\t\t// é‚£ä¹ˆå°±è¿”å›stackTraceElementè®°å½•çš„ç±»åå³åŒ…å«mainå‡½æ•°çš„ç±»å\n\t\t\t\treturn Class.forName(stackTraceElement.getClassName());\n\t\t\t&#125;\n\t\t&#125;\n\t&#125;\n\tcatch (ClassNotFoundException ex) &#123;\n\t\t// Swallow and continue\n\t&#125;\n\treturn null;\n&#125;\n\nå¯ä»¥çœ‹åˆ°deduceMainApplicationClassæ–¹æ³•çš„ä¸»è¦ä½œç”¨å°±æ˜¯ä»StackTraceElementè°ƒç”¨æ ˆæ•°ç»„ä¸­è·å–å“ªä¸ªç±»è°ƒç”¨äº†mainæ–¹æ³•ï¼Œç„¶åå†è¿”å›èµ‹å€¼ç»™mainApplicationClasså±æ€§ï¼Œç„¶åç”¨äºåé¢å¯åŠ¨æµç¨‹ä¸­æ‰“å°ä¸€äº›æ—¥å¿—ã€‚\n\n4 SpringBootçš„SPIæœºåˆ¶åŸç†è§£è¯»ç”±äºSpringBootçš„SPIæœºåˆ¶æ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„çŸ¥è¯†ç‚¹ï¼Œå› æ­¤è¿™é‡Œå•ç‹¬ä¸€å°èŠ‚æ¥åˆ†æã€‚æˆ‘ä»¬éƒ½çŸ¥é“ï¼ŒSpringBootæ²¡æœ‰ä½¿ç”¨Javaçš„SPIæœºåˆ¶(Javaçš„SPIæœºåˆ¶å¯ä»¥çœ‹çœ‹ç¬”è€…çš„Javaæ˜¯å¦‚ä½•å®ç°è‡ªå·±çš„SPIæœºåˆ¶çš„ï¼Ÿ,çœŸçš„æ˜¯å¹²è´§æ»¡æ»¡)ï¼Œè€Œæ˜¯è‡ªå®šä¹‰å®ç°äº†ä¸€å¥—è‡ªå·±çš„SPIæœºåˆ¶ã€‚SpringBootåˆ©ç”¨è‡ªå®šä¹‰å®ç°çš„SPIæœºåˆ¶å¯ä»¥åŠ è½½åˆå§‹åŒ–å™¨å®ç°ç±»ï¼Œç›‘å¬å™¨å®ç°ç±»å’Œè‡ªåŠ¨é…ç½®ç±»ç­‰ç­‰ã€‚å¦‚æœæˆ‘ä»¬è¦æ·»åŠ è‡ªåŠ¨é…ç½®ç±»æˆ–è‡ªå®šä¹‰ç›‘å¬å™¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¾ˆé‡è¦çš„ä¸€æ­¥å°±æ˜¯åœ¨spring.factoriesä¸­è¿›è¡Œé…ç½®ï¼Œç„¶åæ‰ä¼šè¢«SpringBootåŠ è½½ã€‚\nå¥½äº†ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥é‡ç‚¹åˆ†æä¸‹SpringBootæ˜¯å¦‚ä½•æ˜¯å®ç°è‡ªå·±çš„SPIæœºåˆ¶çš„ã€‚\nè¿™é‡Œæ¥ç¬¬3å°èŠ‚çš„æ„é€ SpringApplicationå¯¹è±¡çš„ç¬¬ã€4ã€‘æ­¥å’Œç¬¬ã€5ã€‘æ­¥ä»£ç ï¼Œå› ä¸ºç¬¬ã€4ã€‘æ­¥å’Œç¬¬ã€5ã€‘æ­¥éƒ½æ˜¯åˆ©ç”¨SpringBootçš„SPIæœºåˆ¶æ¥åŠ è½½æ‰©å±•å®ç°ç±»ï¼Œå› æ­¤è¿™é‡Œåªåˆ†æç¬¬ã€4ã€‘æ­¥çš„setInitializers((Collection) getSpringFactoriesInstances(ApplicationContextInitializer.class));è¿™å¥ä»£ç ï¼Œçœ‹çœ‹getSpringFactoriesInstancesæ–¹æ³•ä¸­SpringBootæ˜¯å¦‚ä½•å®ç°è‡ªå·±çš„ä¸€å¥—SPIæ¥åŠ è½½ApplicationContextInitializeråˆå§‹åŒ–å™¨æ¥å£çš„æ‰©å±•å®ç°ç±»çš„ï¼Ÿ\n// SpringApplication.java\n\nprivate &lt;T> Collection&lt;T> getSpringFactoriesInstances(Class&lt;T> type) &#123;\n    // ç»§ç»­è°ƒç”¨é‡è½½çš„getSpringFactoriesInstancesæ–¹æ³•è¿›è¡ŒåŠ è½½\n    return getSpringFactoriesInstances(type, new Class&lt;?>[] &#123;&#125;);\n&#125;\n\nç»§ç»­è·Ÿè¿›é‡è½½çš„getSpringFactoriesInstancesæ–¹æ³•ï¼š\n// SpringApplication.java\n\nprivate &lt;T> Collection&lt;T> getSpringFactoriesInstances(Class&lt;T> type,\n\t\tClass&lt;?>[] parameterTypes, Object... args) &#123;\n\t// ã€1ã€‘è·å¾—ç±»åŠ è½½å™¨\n\tClassLoader classLoader = getClassLoader();\n\t// Use names and ensure unique to protect against duplicates\n\t// ã€2ã€‘å°†æ¥å£ç±»å‹å’Œç±»åŠ è½½å™¨ä½œä¸ºå‚æ•°ä¼ å…¥loadFactoryNamesæ–¹æ³•ï¼Œä»spring.factoriesé…ç½®æ–‡ä»¶ä¸­è¿›è¡ŒåŠ è½½æ¥å£å®ç°ç±»\n\tSet&lt;String> names = new LinkedHashSet&lt;>(\n\t\t\tSpringFactoriesLoader.loadFactoryNames(type, classLoader));\n\t// ã€3ã€‘å®ä¾‹åŒ–ä»spring.factoriesä¸­åŠ è½½çš„æ¥å£å®ç°ç±»\n\tList&lt;T> instances = createSpringFactoriesInstances(type, parameterTypes,\n\t\t\tclassLoader, args, names);\n\t// ã€4ã€‘è¿›è¡Œæ’åº\n\tAnnotationAwareOrderComparator.sort(instances);\n\t// ã€5ã€‘è¿”å›åŠ è½½å¹¶å®ä¾‹åŒ–å¥½çš„æ¥å£å®ç°ç±»\n\treturn instances;\n&#125;\n\nå¯ä»¥çœ‹åˆ°ï¼ŒSpringBootè‡ªå®šä¹‰å®ç°çš„SPIæœºåˆ¶ä»£ç ä¸­æœ€é‡è¦çš„æ˜¯ä¸Šé¢ä»£ç çš„ã€1ã€‘,ã€2ã€‘,ã€3ã€‘æ­¥ï¼Œè¿™3æ­¥ä¸‹é¢åˆ†åˆ«è¿›è¡Œé‡ç‚¹åˆ†æã€‚\n\n4.1 è·å¾—ç±»åŠ è½½å™¨è¿˜è®°å¾—Javaæ˜¯å¦‚ä½•å®ç°è‡ªå·±çš„SPIæœºåˆ¶çš„ï¼Ÿè¿™ç¯‡æ–‡ç« ä¸­Javaçš„SPIæœºåˆ¶é»˜è®¤æ˜¯åˆ©ç”¨çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨å»åŠ è½½æ‰©å±•ç±»çš„ï¼Œé‚£ä¹ˆï¼ŒSpringBootè‡ªå·±å®ç°çš„SPIæœºåˆ¶åˆæ˜¯åˆ©ç”¨å“ªç§ç±»åŠ è½½å™¨å»åŠ è½½**spring.factories**é…ç½®æ–‡ä»¶ä¸­çš„æ‰©å±•å®ç°ç±»å‘¢ï¼Ÿ\næˆ‘ä»¬ç›´æ¥çœ‹ç¬¬ã€1ã€‘æ­¥çš„ClassLoader classLoader = getClassLoader();è¿™å¥ä»£ç ï¼Œå…ˆç¹ä¸ºå¿«ï¼š\n// SpringApplication.java\n\npublic ClassLoader getClassLoader() &#123;\n\t// å‰é¢åœ¨æ„é€ SpringApplicaitonå¯¹è±¡æ—¶ï¼Œä¼ å…¥çš„resourceLoaderå‚æ•°æ˜¯nullï¼Œå› æ­¤ä¸ä¼šæ‰§è¡Œifè¯­å¥é‡Œé¢çš„é€»è¾‘\n\tif (this.resourceLoader != null) &#123;\n\t\treturn this.resourceLoader.getClassLoader();\n\t&#125;\n\t// è·å–é»˜è®¤çš„ç±»åŠ è½½å™¨\n\treturn ClassUtils.getDefaultClassLoader();\n&#125;\n\nç»§ç»­è·Ÿè¿›getDefaultClassLoaderæ–¹æ³•ï¼š\n// ClassUtils.java\n\npublic static ClassLoader getDefaultClassLoader() &#123;\n\tClassLoader cl = null;\n\ttry &#123;\n\t        // ã€é‡ç‚¹ã€‘è·å–çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨\n\t\tcl = Thread.currentThread().getContextClassLoader();\n\t&#125;\n\tcatch (Throwable ex) &#123;\n\t\t// Cannot access thread context ClassLoader - falling back...\n\t&#125;\n\t// è¿™é‡Œçš„é€»è¾‘ä¸ä¼šæ‰§è¡Œ\n\tif (cl == null) &#123;\n\t\t// No thread context class loader -> use class loader of this class.\n\t\tcl = ClassUtils.class.getClassLoader();\n\t\tif (cl == null) &#123;\n\t\t\t// getClassLoader() returning null indicates the bootstrap ClassLoader\n\t\t\ttry &#123;\n\t\t\t\tcl = ClassLoader.getSystemClassLoader();\n\t\t\t&#125;\n\t\t\tcatch (Throwable ex) &#123;\n\t\t\t\t// Cannot access system ClassLoader - oh well, maybe the caller can live with null...\n\t\t\t&#125;\n\t\t&#125;\n\t&#125;\n\t// è¿”å›åˆšæ‰è·å–çš„çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨\n\treturn cl;\n&#125;\n\nå¯ä»¥çœ‹åˆ°ï¼ŒåŸæ¥SpringBootçš„SPIæœºåˆ¶ä¸­ä¹Ÿæ˜¯ç”¨çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨å»åŠ è½½spring.factoriesæ–‡ä»¶ä¸­çš„æ‰©å±•å®ç°ç±»çš„ï¼\n\n4.2 åŠ è½½spring.factoriesé…ç½®æ–‡ä»¶ä¸­çš„SPIæ‰©å±•ç±»æˆ‘ä»¬å†æ¥çœ‹ä¸‹ç¬¬ã€2ã€‘æ­¥ä¸­çš„SpringFactoriesLoader.loadFactoryNames(type, classLoader)è¿™å¥ä»£ç æ˜¯å¦‚ä½•åŠ è½½spring.factoriesé…ç½®æ–‡ä»¶ä¸­çš„SPIæ‰©å±•ç±»çš„ï¼Ÿ\n// SpringFactoriesLoader.java\n\npublic static List&lt;String> loadFactoryNames(Class&lt;?> factoryClass, @Nullable ClassLoader classLoader) &#123;\n        // factoryClasså³SPIæ¥å£ï¼Œæ¯”å¦‚ApplicationContextInitializer,EnableAutoConfigurationç­‰æ¥å£\n\tString factoryClassName = factoryClass.getName();\n\t// ã€ä¸»çº¿ï¼Œé‡ç‚¹å…³æ³¨ã€‘ç»§ç»­è°ƒç”¨loadSpringFactoriesæ–¹æ³•åŠ è½½SPIæ‰©å±•ç±»\n\treturn loadSpringFactories(classLoader).getOrDefault(factoryClassName, Collections.emptyList());\n&#125;\n\nç»§ç»­è·Ÿè¿›loadSpringFactoriesæ–¹æ³•ï¼š\n// SpringFactoriesLoader.java\n\n/**\n * The location to look for factories.\n * &lt;p>Can be present in multiple JAR files.\n */\npublic static final String FACTORIES_RESOURCE_LOCATION = \"META-INF/spring.factories\";\n\nprivate static Map&lt;String, List&lt;String>> loadSpringFactories(@Nullable ClassLoader classLoader) &#123;\n\t// ä»¥classLoaderä½œä¸ºé”®å…ˆä»ç¼“å­˜ä¸­å–ï¼Œè‹¥èƒ½å–åˆ°åˆ™ç›´æ¥è¿”å›\n\tMultiValueMap&lt;String, String> result = cache.get(classLoader);\n\tif (result != null) &#123;\n\t\treturn result;\n\t&#125;\n\t// è‹¥ç¼“å­˜ä¸­æ— è®°å½•ï¼Œåˆ™å»spring.factoriesé…ç½®æ–‡ä»¶ä¸­è·å–\n\ttry &#123;\n\t\t// è¿™é‡ŒåŠ è½½æ‰€æœ‰jaråŒ…ä¸­åŒ…å«\"MATF-INF/spring.factories\"æ–‡ä»¶çš„urlè·¯å¾„\n\t\tEnumeration&lt;URL> urls = (classLoader != null ?\n\t\t\t\tclassLoader.getResources(FACTORIES_RESOURCE_LOCATION) :\n\t\t\t\tClassLoader.getSystemResources(FACTORIES_RESOURCE_LOCATION));\n\t\tresult = new LinkedMultiValueMap&lt;>();\n\t\t// éå†urlsè·¯å¾„ï¼Œå°†æ‰€æœ‰spring.factoriesæ–‡ä»¶çš„é”®å€¼å¯¹ï¼ˆkey:SPIæ¥å£ç±»å value:SPIæ‰©å±•ç±»åï¼‰\n\t\t// åŠ è½½æ”¾åˆ° resulté›†åˆä¸­\n\t\twhile (urls.hasMoreElements()) &#123;\n\t\t\t// å–å‡ºä¸€æ¡url\n\t\t\tURL url = urls.nextElement();\n\t\t\t// å°†urlå°è£…åˆ°UrlResourceå¯¹è±¡ä¸­\n\t\t\tUrlResource resource = new UrlResource(url);\n\t\t\t// åˆ©ç”¨PropertiesLoaderUtilsçš„loadPropertiesæ–¹æ³•å°†spring.factoriesæ–‡ä»¶é”®å€¼å¯¹å†…å®¹åŠ è½½è¿›Propertieså¯¹è±¡ä¸­\n\t\t\tProperties properties = PropertiesLoaderUtils.loadProperties(resource);\n\t\t\t// éå†åˆšåŠ è½½çš„é”®å€¼å¯¹propertieså¯¹è±¡\n\t\t\tfor (Map.Entry&lt;?, ?> entry : properties.entrySet()) &#123;\n\t\t\t\t// å–å‡ºSPIæ¥å£å\n\t\t\t\tString factoryClassName = ((String) entry.getKey()).trim();\n\t\t\t\t// éå†SPIæ¥å£åå¯¹åº”çš„å®ç°ç±»å³SPIæ‰©å±•ç±»\n\t\t\t\tfor (String factoryName : StringUtils.commaDelimitedListToStringArray((String) entry.getValue())) &#123;\n\t\t\t\t\t// SPIæ¥å£åä½œä¸ºkeyï¼ŒSPIæ‰©å±•ç±»ä½œä¸ºvalueæ”¾å…¥resultä¸­\n\t\t\t\t\tresult.add(factoryClassName, factoryName.trim());\n\t\t\t\t&#125;\n\t\t\t&#125;\n\t\t&#125;\n\t\t// ä»¥classLoaderä½œä¸ºkeyï¼Œresultä½œä¸ºvalueæ”¾å…¥cacheç¼“å­˜\n\t\tcache.put(classLoader, result);\n\t\t// æœ€ç»ˆè¿”å›resultå¯¹è±¡\n\t\treturn result;\n\t&#125;\n\tcatch (IOException ex) &#123;\n\t\tthrow new IllegalArgumentException(\"Unable to load factories from location [\" +\n\t\t\t\tFACTORIES_RESOURCE_LOCATION + \"]\", ex);\n\t&#125;\n&#125;\n\nå¦‚ä¸Šä»£ç ï¼ŒloadSpringFactoriesæ–¹æ³•ä¸»è¦åšçš„äº‹æƒ…å°±æ˜¯åˆ©ç”¨ä¹‹å‰è·å–çš„çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨å°†classpathä¸­çš„æ‰€æœ‰spring.factoriesé…ç½®æ–‡ä»¶ä¸­æ‰€æœ‰SPIæ¥å£çš„æ‰€æœ‰æ‰©å±•å®ç°ç±»ç»™åŠ è½½å‡ºæ¥ï¼Œç„¶åæ”¾å…¥ç¼“å­˜ä¸­ã€‚æ³¨æ„ï¼Œè¿™é‡Œæ˜¯ä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰çš„SPIæ‰©å±•å®ç°ç±»å“ˆï¼Œæ‰€ä»¥ä¹‹åæ ¹æ®SPIæ¥å£å°±ç›´æ¥ä»ç¼“å­˜ä¸­è·å–SPIæ‰©å±•ç±»äº†ï¼Œå°±ä¸ç”¨å†æ¬¡å»spring.factoriesé…ç½®æ–‡ä»¶ä¸­è·å–SPIæ¥å£å¯¹åº”çš„æ‰©å±•å®ç°ç±»äº†ã€‚æ¯”å¦‚ä¹‹åçš„è·å–ApplicationListener,FailureAnalyzerå’ŒEnableAutoConfigurationæ¥å£çš„æ‰©å±•å®ç°ç±»éƒ½ç›´æ¥ä»ç¼“å­˜ä¸­è·å–å³å¯ã€‚\n\n\n\n\n\n\n\n\n\næ€è€ƒ1ï¼š è¿™é‡Œä¸ºå•¥è¦ä¸€æ¬¡æ€§ä»spring.factoriesé…ç½®æ–‡ä»¶ä¸­è·å–æ‰€æœ‰çš„æ‰©å±•ç±»æ”¾å…¥ç¼“å­˜ä¸­å‘¢ï¼Ÿè€Œä¸æ˜¯æ¯æ¬¡éƒ½æ˜¯æ ¹æ®SPIæ¥å£å»spring.factoriesé…ç½®æ–‡ä»¶ä¸­è·å–å‘¢ï¼Ÿ\n\n\n\n\n\n\n\n\n\næ€è€ƒ2ï¼š è¿˜è®°å¾—ä¹‹å‰è®²çš„SpringBootçš„è‡ªåŠ¨é…ç½®æºç æ—¶æåˆ°çš„AutoConfigurationImportFilterè¿™ä¸ªæ¥å£çš„ä½œç”¨å—ï¼Ÿç°åœ¨æˆ‘ä»¬åº”è¯¥èƒ½æ›´æ¸…æ¥šçš„ç†è§£è¿™ä¸ªæ¥å£çš„ä½œç”¨äº†å§ã€‚\nå°†æ‰€æœ‰çš„SPIæ‰©å±•å®ç°ç±»åŠ è½½å‡ºæ¥åï¼Œæ­¤æ—¶å†è°ƒç”¨getOrDefault(factoryClassName, Collections.emptyList())æ–¹æ³•æ ¹æ®SPIæ¥å£åå»ç­›é€‰å½“å‰å¯¹åº”çš„æ‰©å±•å®ç°ç±»ï¼Œæ¯”å¦‚è¿™é‡Œä¼ å…¥çš„factoryClassNameå‚æ•°åä¸ºApplicationContextInitializeræ¥å£ï¼Œé‚£ä¹ˆè¿™ä¸ªæ¥å£å°†ä¼šä½œä¸ºkeyä»åˆšæ‰ç¼“å­˜æ•°æ®ä¸­å–å‡ºApplicationContextInitializeræ¥å£å¯¹åº”çš„SPIæ‰©å±•å®ç°ç±»ã€‚å…¶ä¸­ä»spring.factoriesä¸­è·å–çš„ApplicationContextInitializeræ¥å£å¯¹åº”çš„æ‰€æœ‰SPIæ‰©å±•å®ç°ç±»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\n\n\n4.3 å®ä¾‹åŒ–ä»spring.factoriesä¸­åŠ è½½çš„SPIæ‰©å±•ç±»å‰é¢ä»spring.factoriesä¸­è·å–åˆ°ApplicationContextInitializeræ¥å£å¯¹åº”çš„æ‰€æœ‰SPIæ‰©å±•å®ç°ç±»åï¼Œæ­¤æ—¶ä¼šå°†è¿™äº›SPIæ‰©å±•ç±»è¿›è¡Œå®ä¾‹åŒ–ã€‚\næ­¤æ—¶æˆ‘ä»¬å†æ¥çœ‹ä¸‹å‰é¢çš„ç¬¬ã€3ã€‘æ­¥çš„å®ä¾‹åŒ–ä»£ç ï¼šList&lt;T&gt; instances = createSpringFactoriesInstances(type, parameterTypes, \t\t\t\tclassLoader, args, names);ã€‚\n// SpringApplication.java\n\nprivate &lt;T> List&lt;T> createSpringFactoriesInstances(Class&lt;T> type,\n\t\tClass&lt;?>[] parameterTypes, ClassLoader classLoader, Object[] args,\n\t\tSet&lt;String> names) &#123;\n\t// æ–°å»ºinstancesé›†åˆï¼Œç”¨äºå­˜å‚¨ç¨åå®ä¾‹åŒ–åçš„SPIæ‰©å±•ç±»å¯¹è±¡\n\tList&lt;T> instances = new ArrayList&lt;>(names.size());\n\t// éå†nameé›†åˆï¼Œnamesé›†åˆå­˜å‚¨äº†æ‰€æœ‰SPIæ‰©å±•ç±»çš„å…¨é™å®šå\n\tfor (String name : names) &#123;\n\t\ttry &#123;\n\t\t\t// æ ¹æ®å…¨é™å®šååˆ©ç”¨åå°„åŠ è½½ç±»\n\t\t\tClass&lt;?> instanceClass = ClassUtils.forName(name, classLoader);\n\t\t\t// æ–­è¨€åˆšæ‰åŠ è½½çš„SPIæ‰©å±•ç±»æ˜¯å¦å±äºSPIæ¥å£ç±»å‹\n\t\t\tAssert.isAssignable(type, instanceClass);\n\t\t\t// è·å¾—SPIæ‰©å±•ç±»çš„æ„é€ å™¨\n\t\t\tConstructor&lt;?> constructor = instanceClass\n\t\t\t\t\t.getDeclaredConstructor(parameterTypes);\n\t\t\t// å®ä¾‹åŒ–SPIæ‰©å±•ç±»\n\t\t\tT instance = (T) BeanUtils.instantiateClass(constructor, args);\n\t\t\t// æ·»åŠ è¿›instancesé›†åˆ\n\t\t\tinstances.add(instance);\n\t\t&#125;\n\t\tcatch (Throwable ex) &#123;\n\t\t\tthrow new IllegalArgumentException(\n\t\t\t\t\t\"Cannot instantiate \" + type + \" : \" + name, ex);\n\t\t&#125;\n\t&#125;\n\t// è¿”å›\n\treturn instances;\n&#125;\n\nä¸Šé¢ä»£ç å¾ˆç®€å•ï¼Œä¸»è¦åšçš„äº‹æƒ…å°±æ˜¯å®ä¾‹åŒ–SPIæ‰©å±•ç±»ã€‚å¥½äº†ï¼ŒSpringBootè‡ªå®šä¹‰çš„SPIæœºåˆ¶å°±å·²ç»åˆ†æå®Œäº†ã€‚\n\n\n\n\n\n\n\n\n\næ€è€ƒ3ï¼š SpringBootä¸ºä½•å¼ƒç”¨Javaçš„SPIè€Œè‡ªå®šä¹‰äº†ä¸€å¥—SPIï¼Ÿ\n\n5 å°ç»“å¥½äº†ï¼Œæœ¬ç‰‡å°±åˆ°æ­¤ç»“æŸäº†ï¼Œå…ˆå°†å‰é¢çš„çŸ¥è¯†ç‚¹å†æ€»ç»“ä¸‹ï¼š\n\nåˆ†æäº†SpringApplicationå¯¹è±¡çš„æ„é€ è¿‡ç¨‹ï¼›\nåˆ†æäº†SpringBootè‡ªå·±å®ç°çš„ä¸€å¥—SPIæœºåˆ¶ã€‚\n\n9 SpringBootäº‹ä»¶ç›‘å¬æœºåˆ¶\n1 æ¸©æ•…è€ŒçŸ¥æ–°æ¸©æ•…è€ŒçŸ¥æ–°ï¼Œæˆ‘ä»¬æ¥ç®€å•å›é¡¾ä¸€ä¸‹ä¸Šç¯‡çš„å†…å®¹ï¼Œä¸Šä¸€ç¯‡æˆ‘ä»¬åˆ†æäº†SpringApplication å¯¹è±¡çš„æ„å»ºè¿‡ç¨‹åŠ SpringBoot è‡ªå·±å®ç°çš„ä¸€å¥— SPI æœºåˆ¶ï¼Œç°å°†å…³é”®æ­¥éª¤å†æµ“ç¼©æ€»ç»“ä¸‹ï¼š\n\nSpringApplicationå¯¹è±¡çš„æ„é€ è¿‡ç¨‹å…¶å®å°±æ˜¯ç»™SpringApplicationç±»çš„6ä¸ªæˆå‘˜å˜é‡èµ‹å€¼ï¼›\nSpringBoot é€šè¿‡ä»¥ä¸‹æ­¥éª¤å®ç°è‡ªå·±çš„ SPI æœºåˆ¶ï¼š\n\n\n1)é¦–å…ˆè·å–çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨;\n2)ç„¶ååˆ©ç”¨ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ä»spring.factoriesé…ç½®æ–‡ä»¶ä¸­åŠ è½½æ‰€æœ‰çš„ SPI æ‰©å±•å®ç°ç±»å¹¶æ”¾å…¥ç¼“å­˜ä¸­;\n3)æ ¹æ® SPI æ¥å£ä»ç¼“å­˜ä¸­å–å‡ºç›¸åº”çš„ SPI æ‰©å±•å®ç°ç±»;\n4)å®ä¾‹åŒ–ä»ç¼“å­˜ä¸­å–å‡ºçš„ SPI æ‰©å±•å®ç°ç±»å¹¶è¿”å›ã€‚\n\n\n2 å¼•è¨€åœ¨ SpringBoot å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œæ¯ä¸ªä¸åŒçš„å¯åŠ¨é˜¶æ®µä¼šåˆ†åˆ«å¹¿æ’­ä¸åŒçš„å†…ç½®ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼Œç„¶åç›¸åº”çš„ç›‘å¬å™¨ä¼šç›‘å¬è¿™äº›äº‹ä»¶æ¥æ‰§è¡Œä¸€äº›åˆå§‹åŒ–é€»è¾‘å·¥ä½œæ¯”å¦‚ConfigFileApplicationListenerä¼šç›‘å¬onApplicationEnvironmentPreparedEventäº‹ä»¶æ¥åŠ è½½é…ç½®æ–‡ä»¶application.propertiesçš„ç¯å¢ƒå˜é‡ç­‰ã€‚\nå› æ­¤æœ¬ç¯‡å†…å®¹å°†æ¥åˆ†æä¸‹ SpringBoot çš„äº‹ä»¶ç›‘å¬æœºåˆ¶çš„æºç ã€‚\n\n3 SpringBoot å¹¿æ’­å†…ç½®ç”Ÿå‘½å‘¨æœŸäº‹ä»¶æµç¨‹åˆ†æä¸ºäº†æ¢ç©¶ SpringBoot å¹¿æ’­å†…ç½®ç”Ÿå‘½å‘¨æœŸäº‹ä»¶æµç¨‹ï¼Œæˆ‘ä»¬å†æ¥å›é¡¾ä¸€ä¸‹ SpringBoot çš„å¯åŠ¨æµç¨‹ä»£ç ï¼š\n// SpringApplication.java\n\npublic ConfigurableApplicationContext run(String... args) &#123;\n\tStopWatch stopWatch = new StopWatch();\n\tstopWatch.start();\n\tConfigurableApplicationContext context = null;\n\tCollection&lt;SpringBootExceptionReporter> exceptionReporters = new ArrayList&lt;>();\n\tconfigureHeadlessProperty();\n\t// ã€0ã€‘æ–°å»ºä¸€ä¸ªSpringApplicationRunListenerså¯¹è±¡ç”¨äºå‘å°„SpringBootå¯åŠ¨è¿‡ç¨‹ä¸­çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶\n\tSpringApplicationRunListeners listeners = getRunListeners(args);\n\t// ã€1ã€‘ã€‹ã€‹ã€‹ã€‹ã€‹å‘å°„ã€ApplicationStartingEventã€‘äº‹ä»¶ï¼Œæ ‡å¿—SpringApplicationå¼€å§‹å¯åŠ¨\n\tlisteners.starting();\n\ttry &#123;\n\t\tApplicationArguments applicationArguments = new DefaultApplicationArguments(\n\t\t\t\targs);\n\t\t// ã€2ã€‘ã€‹ã€‹ã€‹ã€‹ã€‹å‘å°„ã€ApplicationEnvironmentPreparedEventã€‘äº‹ä»¶ï¼Œæ­¤æ—¶ä¼šå»åŠ è½½application.propertiesç­‰é…ç½®æ–‡ä»¶çš„ç¯å¢ƒå˜é‡ï¼ŒåŒæ—¶ä¹Ÿæœ‰æ ‡å¿—ç¯å¢ƒå˜é‡å·²ç»å‡†å¤‡å¥½çš„æ„æ€\n\t\tConfigurableEnvironment environment = prepareEnvironment(listeners,\n\t\t\t\tapplicationArguments);\n\t\tconfigureIgnoreBeanInfo(environment);\n\t\tBanner printedBanner = printBanner(environment);\n\t\tcontext = createApplicationContext();\n\t\texceptionReporters = getSpringFactoriesInstances(\n\t\t\t\tSpringBootExceptionReporter.class,\n\t\t\t\tnew Class[] &#123; ConfigurableApplicationContext.class &#125;, context);\n\t\t// ã€3ã€‘ã€‹ã€‹ã€‹ã€‹ã€‹å‘å°„ã€ApplicationContextInitializedEventã€‘äº‹ä»¶ï¼Œæ ‡å¿—contextå®¹å™¨è¢«åˆ›å»ºä¸”å·²å‡†å¤‡å¥½\n\t\t// ã€4ã€‘ã€‹ã€‹ã€‹ã€‹ã€‹å‘å°„ã€ApplicationPreparedEventã€‘äº‹ä»¶ï¼Œæ ‡å¿—Contextå®¹å™¨å·²ç»å‡†å¤‡å®Œæˆ\n\t\tprepareContext(context, environment, listeners, applicationArguments,\n\t\t\t\tprintedBanner);\n\t\trefreshContext(context);\n\t\tafterRefresh(context, applicationArguments);\n\t\tstopWatch.stop();\n\t\tif (this.logStartupInfo) &#123;\n\t\t\tnew StartupInfoLogger(this.mainApplicationClass)\n\t\t\t\t\t.logStarted(getApplicationLog(), stopWatch);\n\t\t&#125;\n\t\t// ã€5ã€‘ã€‹ã€‹ã€‹ã€‹ã€‹å‘å°„ã€ApplicationStartedEventã€‘äº‹ä»¶ï¼Œæ ‡å¿—springå®¹å™¨å·²ç»åˆ·æ–°ï¼Œæ­¤æ—¶æ‰€æœ‰çš„beanå®ä¾‹éƒ½å·²ç»åŠ è½½å®Œæ¯•\n\t\tlisteners.started(context);\n\t\tcallRunners(context, applicationArguments);\n\t&#125;\n\t// ã€6ã€‘ã€‹ã€‹ã€‹ã€‹ã€‹å‘å°„ã€ApplicationFailedEventã€‘äº‹ä»¶ï¼Œæ ‡å¿—SpringBootå¯åŠ¨å¤±è´¥\n\tcatch (Throwable ex) &#123;\n\t\thandleRunFailure(context, ex, exceptionReporters, listeners);\n\t\tthrow new IllegalStateException(ex);\n\t&#125;\n\ttry &#123;\n\t\t// ã€7ã€‘ã€‹ã€‹ã€‹ã€‹ã€‹å‘å°„ã€ApplicationReadyEventã€‘äº‹ä»¶ï¼Œæ ‡å¿—SpringApplicationå·²ç»æ­£åœ¨è¿è¡Œå³å·²ç»æˆåŠŸå¯åŠ¨ï¼Œå¯ä»¥æ¥æ”¶æœåŠ¡è¯·æ±‚äº†ã€‚\n\t\tlisteners.running(context);\n\t&#125;\n\tcatch (Throwable ex) &#123;\n\t\thandleRunFailure(context, ex, exceptionReporters, null);\n\t\tthrow new IllegalStateException(ex);\n\t&#125;\n\treturn context;\n&#125;\n\nå¯ä»¥çœ‹åˆ° SpringBoot åœ¨å¯åŠ¨è¿‡ç¨‹ä¸­é¦–å…ˆä¼šå…ˆæ–°å»ºä¸€ä¸ªSpringApplicationRunListenerså¯¹è±¡ç”¨äºå‘å°„ SpringBoot å¯åŠ¨è¿‡ç¨‹ä¸­çš„å„ç§ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼Œæ¯”å¦‚å‘å°„ApplicationStartingEvent,ApplicationEnvironmentPreparedEventå’ŒApplicationContextInitializedEventç­‰äº‹ä»¶ï¼Œç„¶åç›¸åº”çš„ç›‘å¬å™¨ä¼šæ‰§è¡Œä¸€äº› SpringBoot å¯åŠ¨è¿‡ç¨‹ä¸­çš„åˆå§‹åŒ–é€»è¾‘ã€‚é‚£ä¹ˆï¼Œç›‘å¬è¿™äº› SpringBoot çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶çš„ç›‘å¬å™¨ä»¬æ˜¯ä½•æ—¶è¢«åŠ è½½å®ä¾‹åŒ–çš„å‘¢ï¼Ÿè¿˜è®°å¾—ä¸Šç¯‡æ–‡ç« åœ¨åˆ†æSpringApplicationçš„æ„å»ºè¿‡ç¨‹å—ï¼Ÿæ²¡é”™ï¼Œè¿™äº›æ‰§è¡Œåˆå§‹åŒ–é€»è¾‘çš„ç›‘å¬å™¨ä»¬æ­£æ˜¯åœ¨SpringApplicationçš„æ„å»ºè¿‡ç¨‹ä¸­æ ¹æ®ApplicationListeneræ¥å£å»spring.factoriesé…ç½®æ–‡ä»¶ä¸­åŠ è½½å¹¶å®ä¾‹åŒ–çš„ã€‚\n\n3.1 ä¸ºå¹¿æ’­ SpringBoot å†…ç½®ç”Ÿå‘½å‘¨æœŸäº‹ä»¶åšå‰æœŸå‡†å¤‡\n3.1.1 åŠ è½½ ApplicationListener ç›‘å¬å™¨å®ç°ç±»æˆ‘ä»¬å†æ¥å›é¡¾ä¸‹SpringApplication å¯¹è±¡æ˜¯å¦‚ä½•æ„å»ºçš„ï¼Ÿ SpringBoot æºç ï¼ˆå…«ï¼‰ä¸€æ–‡ä¸­è®²åˆ°åœ¨æ„å»ºSpringApplicationå¯¹è±¡æ—¶çš„setListeners((Collection) getSpringFactoriesInstances(ApplicationListener.class));è¿™å¥ä»£ç ã€‚\nè¿™å¥ä»£ç åšçš„äº‹æƒ…å°±æ˜¯ä»spring.factoriesä¸­åŠ è½½å‡ºApplicationListeneräº‹ä»¶ç›‘å¬æ¥å£çš„ SPI æ‰©å±•å®ç°ç±»ç„¶åæ·»åŠ åˆ°SpringApplicationå¯¹è±¡çš„listenersé›†åˆä¸­ï¼Œç”¨äºåç»­ç›‘å¬ SpringBoot å¯åŠ¨è¿‡ç¨‹ä¸­çš„äº‹ä»¶ï¼Œæ¥æ‰§è¡Œä¸€äº›åˆå§‹åŒ–é€»è¾‘å·¥ä½œã€‚\nSpringBoot å¯åŠ¨æ—¶çš„å…·ä½“ç›‘å¬å™¨ä»¬éƒ½å®ç°äº†ApplicationListeneræ¥å£ï¼Œå…¶åœ¨spring.factorieséƒ¨åˆ†é…ç½®å¦‚ä¸‹ï¼š\n\nä¸è¿‡åœ¨è°ƒè¯•æ—¶ï¼Œä¼šä»æ‰€æœ‰çš„ spring.factories é…ç½®æ–‡ä»¶ä¸­åŠ è½½ç›‘å¬å™¨ï¼Œæœ€ç»ˆåŠ è½½äº† 10 ä¸ªç›‘å¬å™¨ã€‚å¦‚ä¸‹å›¾ï¼š\n\n\n3.1.2 åŠ è½½ SPI æ‰©å±•ç±» EventPublishingRunListenerå‰é¢è®²åˆ°ï¼Œåœ¨ SpringBoot çš„å¯åŠ¨è¿‡ç¨‹ä¸­é¦–å…ˆä¼šå…ˆæ–°å»ºä¸€ä¸ªSpringApplicationRunListenerså¯¹è±¡ç”¨äºå‘å°„ SpringBoot å¯åŠ¨è¿‡ç¨‹ä¸­çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼Œå³æˆ‘ä»¬ç°åœ¨æ¥çœ‹ä¸‹SpringApplicationRunListeners listeners = getRunListeners(args);è¿™å¥ä»£ç ï¼š\n// SpringApplication.java\n\nprivate SpringApplicationRunListeners getRunListeners(String[] args) &#123;\n\t// æ„é€ ä¸€ä¸ªç”±SpringApplication.classå’ŒString[].classç»„æˆçš„types\n\tClass&lt;?>[] types = new Class&lt;?>[] &#123; SpringApplication.class, String[].class &#125;;\n\t// 1) æ ¹æ®SpringApplicationRunListeneræ¥å£å»spring.factoriesé…ç½®æ–‡ä»¶ä¸­åŠ è½½å…¶SPIæ‰©å±•å®ç°ç±»\n\t// 2) æ„å»ºä¸€ä¸ªSpringApplicationRunListenerså¯¹è±¡å¹¶è¿”å›\n\treturn new SpringApplicationRunListeners(logger, getSpringFactoriesInstances(\n\t\t\tSpringApplicationRunListener.class, types, this, args));\n&#125;\n\næˆ‘ä»¬å°†é‡ç‚¹æ”¾åˆ°getSpringFactoriesInstances( SpringApplicationRunListener.class, types, this, args)è¿™å¥ä»£ç ï¼ŒgetSpringFactoriesInstancesè¿™ä¸ªæ–¹æ³•æˆ‘ä»¬å·²ç»å¾ˆç†Ÿæ‚‰ï¼Œåœ¨ä¸Šä¸€ç¯‡åˆ†æ SpringBoot çš„ SPI æœºåˆ¶æ—¶å·²ç»è¯¦ç»†åˆ†æè¿‡è¿™ä¸ªæ–¹æ³•ã€‚å¯ä»¥çœ‹åˆ° SpringBoot æ­¤æ—¶åˆæ˜¯æ ¹æ®SpringApplicationRunListenerè¿™ä¸ª SPI æ¥å£å»spring.factoriesä¸­åŠ è½½ç›¸åº”çš„ SPI æ‰©å±•å®ç°ç±»ï¼Œæˆ‘ä»¬ç›´æ¥å»spring.factoriesä¸­çœ‹çœ‹SpringApplicationRunListeneræœ‰å“ªäº› SPI å®ç°ç±»ï¼š\nç”±ä¸Šå›¾å¯ä»¥çœ‹åˆ°ï¼ŒSpringApplicationRunListeneråªæœ‰EventPublishingRunListenerè¿™ä¸ª SPI å®ç°ç±»EventPublishingRunListenerè¿™ä¸ªå“¥ä»¬åœ¨ SpringBoot çš„å¯åŠ¨è¿‡ç¨‹ä¸­å°¤å…¶é‡è¦ï¼Œç”±å…¶åœ¨ SpringBoot å¯åŠ¨è¿‡ç¨‹çš„ä¸åŒé˜¶æ®µå‘å°„ä¸åŒçš„ SpringBoot çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼Œå³**SpringApplicationRunListeners**å¯¹è±¡æ²¡æœ‰æ‰¿æ‹…å¹¿æ’­äº‹ä»¶çš„èŒè´£ï¼Œè€Œæœ€ç»ˆæ˜¯å§”æ‰˜**EventPublishingRunListener**è¿™ä¸ªå“¥ä»¬æ¥å¹¿æ’­äº‹ä»¶çš„ã€‚\nå› ä¸ºä»spring.factoriesä¸­åŠ è½½EventPublishingRunListenerç±»åè¿˜ä¼šå®ä¾‹åŒ–è¯¥ç±»ï¼Œé‚£ä¹ˆæˆ‘ä»¬å†è·Ÿè¿›EventPublishingRunListenerçš„æºç ï¼Œçœ‹çœ‹å…¶æ˜¯å¦‚ä½•æ‰¿æ‹…å‘å°„ SpringBoot ç”Ÿå‘½å‘¨æœŸäº‹ä»¶è¿™ä¸€èŒè´£çš„ï¼Ÿ\n// EventPublishingRunListener.java\n\npublic class EventPublishingRunListener implements SpringApplicationRunListener, Ordered &#123;\n\n\tprivate final SpringApplication application;\n\n\tprivate final String[] args;\n\t/**\n\t * æ‹¥æœ‰ä¸€ä¸ªSimpleApplicationEventMulticasteräº‹ä»¶å¹¿æ’­å™¨æ¥å¹¿æ’­äº‹ä»¶\n\t */\n\tprivate final SimpleApplicationEventMulticaster initialMulticaster;\n\n\tpublic EventPublishingRunListener(SpringApplication application, String[] args) &#123;\n\t\tthis.application = application;\n\t\tthis.args = args;\n\t\t// æ–°å»ºä¸€ä¸ªäº‹ä»¶å¹¿æ’­å™¨SimpleApplicationEventMulticasterå¯¹è±¡\n\t\tthis.initialMulticaster = new SimpleApplicationEventMulticaster();\n\t\t// éå†åœ¨æ„é€ SpringApplicationå¯¹è±¡æ—¶ä»spring.factoriesé…ç½®æ–‡ä»¶ä¸­è·å–çš„äº‹ä»¶ç›‘å¬å™¨\n\t\tfor (ApplicationListener&lt;?> listener : application.getListeners()) &#123;\n\t\t\t// å°†ä»spring.factoriesé…ç½®æ–‡ä»¶ä¸­è·å–çš„äº‹ä»¶ç›‘å¬å™¨ä»¬æ·»åŠ åˆ°äº‹ä»¶å¹¿æ’­å™¨initialMulticasterå¯¹è±¡çš„ç›¸å…³é›†åˆä¸­\n\t\t\tthis.initialMulticaster.addApplicationListener(listener);\n\t\t&#125;\n\t&#125;\n\n\t@Override\n\tpublic int getOrder() &#123;\n\t\treturn 0;\n\t&#125;\n\t// ã€‹ã€‹ã€‹ã€‹ã€‹å‘å°„ã€ApplicationStartingEventã€‘äº‹ä»¶\n\t@Override\n\tpublic void starting() &#123;\n\t\tthis.initialMulticaster.multicastEvent(\n\t\t\t\tnew ApplicationStartingEvent(this.application, this.args));\n\t&#125;\n\t// ã€‹ã€‹ã€‹ã€‹ã€‹å‘å°„ã€ApplicationEnvironmentPreparedEventã€‘äº‹ä»¶\n\t@Override\n\tpublic void environmentPrepared(ConfigurableEnvironment environment) &#123;\n\t\tthis.initialMulticaster.multicastEvent(new ApplicationEnvironmentPreparedEvent(\n\t\t\t\tthis.application, this.args, environment));\n\t&#125;\n\t// ã€‹ã€‹ã€‹ã€‹ã€‹å‘å°„ã€ApplicationContextInitializedEventã€‘äº‹ä»¶\n\t@Override\n\tpublic void contextPrepared(ConfigurableApplicationContext context) &#123;\n\t\tthis.initialMulticaster.multicastEvent(new ApplicationContextInitializedEvent(\n\t\t\t\tthis.application, this.args, context));\n\t&#125;\n\t// ã€‹ã€‹ã€‹ã€‹ã€‹å‘å°„ã€ApplicationPreparedEventã€‘äº‹ä»¶\n\t@Override\n\tpublic void contextLoaded(ConfigurableApplicationContext context) &#123;\n\t\tfor (ApplicationListener&lt;?> listener : this.application.getListeners()) &#123;\n\t\t\tif (listener instanceof ApplicationContextAware) &#123;\n\t\t\t\t((ApplicationContextAware) listener).setApplicationContext(context);\n\t\t\t&#125;\n\t\t\tcontext.addApplicationListener(listener);\n\t\t&#125;\n\t\tthis.initialMulticaster.multicastEvent(\n\t\t\t\tnew ApplicationPreparedEvent(this.application, this.args, context));\n\t&#125;\n\t// ã€‹ã€‹ã€‹ã€‹ã€‹å‘å°„ã€ApplicationStartedEventã€‘äº‹ä»¶\n\t@Override\n\tpublic void started(ConfigurableApplicationContext context) &#123;\n\t\tcontext.publishEvent(\n\t\t\t\tnew ApplicationStartedEvent(this.application, this.args, context));\n\t&#125;\n\t// ã€‹ã€‹ã€‹ã€‹ã€‹å‘å°„ã€ApplicationReadyEventã€‘äº‹ä»¶\n\t@Override\n\tpublic void running(ConfigurableApplicationContext context) &#123;\n\t\tcontext.publishEvent(\n\t\t\t\tnew ApplicationReadyEvent(this.application, this.args, context));\n\t&#125;\n\t// ã€‹ã€‹ã€‹ã€‹ã€‹å‘å°„ã€ApplicationFailedEventã€‘äº‹ä»¶\n\t@Override\n\tpublic void failed(ConfigurableApplicationContext context, Throwable exception) &#123;\n\t\tApplicationFailedEvent event = new ApplicationFailedEvent(this.application,\n\t\t\t\tthis.args, context, exception);\n\t\tif (context != null &amp;&amp; context.isActive()) &#123;\n\t\t\t// Listeners have been registered to the application context so we should\n\t\t\t// use it at this point if we can\n\t\t\tcontext.publishEvent(event);\n\t\t&#125;\n\t\telse &#123;\n\t\t\t// An inactive context may not have a multicaster so we use our multicaster to\n\t\t\t// call all of the context's listeners instead\n\t\t\tif (context instanceof AbstractApplicationContext) &#123;\n\t\t\t\tfor (ApplicationListener&lt;?> listener : ((AbstractApplicationContext) context)\n\t\t\t\t\t\t.getApplicationListeners()) &#123;\n\t\t\t\t\tthis.initialMulticaster.addApplicationListener(listener);\n\t\t\t\t&#125;\n\t\t\t&#125;\n\t\t\tthis.initialMulticaster.setErrorHandler(new LoggingErrorHandler());\n\t\t\tthis.initialMulticaster.multicastEvent(event);\n\t\t&#125;\n\t&#125;\n\n\t// ...çœç•¥éå…³é”®ä»£ç \n&#125;\n\nå¯ä»¥çœ‹åˆ°EventPublishingRunListenerç±»å®ç°äº†SpringApplicationRunListeneræ¥å£ï¼ŒSpringApplicationRunListeneræ¥å£å®šä¹‰äº† SpringBoot å¯åŠ¨æ—¶å‘å°„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶çš„æ¥å£æ–¹æ³•ï¼Œè€ŒEventPublishingRunListenerç±»æ­£æ˜¯é€šè¿‡å®ç°SpringApplicationRunListeneræ¥å£çš„starting,environmentPreparedå’ŒcontextPreparedç­‰æ–¹æ³•æ¥å¹¿æ’­ SpringBoot ä¸åŒçš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼Œæˆ‘ä»¬ç›´æ¥çœ‹ä¸‹SpringApplicationRunListeneræ¥å£æºç å¥½äº†ï¼š\n// SpringApplicationRunListener.java\n\npublic interface SpringApplicationRunListener &#123;\n\n\tvoid starting();\n\n\tvoid environmentPrepared(ConfigurableEnvironment environment);\n\n\tvoid contextPrepared(ConfigurableApplicationContext context);\n\n\tvoid contextLoaded(ConfigurableApplicationContext context);\n\n\tvoid started(ConfigurableApplicationContext context);\n\n\tvoid running(ConfigurableApplicationContext context);\n\n\tvoid failed(ConfigurableApplicationContext context, Throwable exception);\n&#125;\n\næˆ‘ä»¬å†æ¥ç€åˆ†æEventPublishingRunListenerè¿™ä¸ªç±»ï¼Œå¯ä»¥çœ‹åˆ°å…¶æœ‰ä¸€ä¸ªé‡è¦çš„æˆå‘˜å±æ€§initialMulticasterï¼Œè¯¥æˆå‘˜å±æ€§æ˜¯SimpleApplicationEventMulticasterç±»å¯¹è±¡ï¼Œè¯¥ç±»æ­£æ˜¯æ‰¿æ‹…äº†å¹¿æ’­ SpringBoot å¯åŠ¨æ—¶ç”Ÿå‘½å‘¨æœŸäº‹ä»¶çš„èŒè´£,å³**EventPublishingRunListener**å¯¹è±¡æ²¡æœ‰æ‰¿æ‹…å¹¿æ’­äº‹ä»¶çš„èŒè´£ï¼Œè€Œæœ€ç»ˆæ˜¯å§”æ‰˜**SimpleApplicationEventMulticaster**è¿™ä¸ªå“¥ä»¬æ¥å¹¿æ’­äº‹ä»¶çš„ã€‚ ä»EventPublishingRunListenerçš„æºç ä¸­ä¹Ÿå¯ä»¥çœ‹åˆ°åœ¨starting,environmentPreparedå’ŒcontextPreparedç­‰æ–¹æ³•ä¸­ä¹Ÿæ­£æ˜¯é€šè¿‡è°ƒç”¨SimpleApplicationEventMulticasterç±»å¯¹è±¡çš„multicastEventæ–¹æ³•æ¥å¹¿æ’­äº‹ä»¶çš„ã€‚\n\n\n\n\n\n\n\n\n\næ€è€ƒ SpringBoot å¯åŠ¨è¿‡ç¨‹ä¸­å‘å°„äº‹ä»¶æ—¶äº‹ä»¶å¹¿æ’­è€…æ˜¯å±‚å±‚å§”æ‰˜èŒè´£çš„ï¼Œèµ·åˆç”±SpringApplicationRunListenerså¯¹è±¡æ‰¿æ‹…ï¼Œç„¶åSpringApplicationRunListenerså¯¹è±¡å°†å¹¿æ’­äº‹ä»¶èŒè´£å§”æ‰˜ç»™EventPublishingRunListenerå¯¹è±¡ï¼Œæœ€ç»ˆEventPublishingRunListenerå¯¹è±¡å°†å¹¿æ’­äº‹ä»¶çš„èŒè´£å§”æ‰˜ç»™SimpleApplicationEventMulticasterå¯¹è±¡ã€‚ä¸ºä»€ä¹ˆè¦å±‚å±‚å§”æ‰˜è¿™ä¹ˆåšå‘¢ï¼Ÿ è¿™ä¸ªå€¼å¾—å¤§å®¶æ€è€ƒã€‚\nå‰é¢è®²åˆ°ä»spring.factoriesä¸­åŠ è½½å‡ºEventPublishingRunListenerç±»åä¼šå®ä¾‹åŒ–ï¼Œè€Œå®ä¾‹åŒ–å¿…ç„¶ä¼šé€šè¿‡EventPublishingRunListenerçš„æ„é€ å‡½æ•°æ¥è¿›è¡Œå®ä¾‹åŒ–ï¼Œå› æ­¤æˆ‘ä»¬æ¥ä¸‹æ¥åˆ†æä¸‹EventPublishingRunListenerçš„æ„é€ å‡½æ•°æºç ï¼š\n// EventPublishingRunListener.java\n\npublic EventPublishingRunListener(SpringApplication application, String[] args) &#123;\n\tthis.application = application;\n\tthis.args = args;\n\t// æ–°å»ºä¸€ä¸ªäº‹ä»¶å¹¿æ’­å™¨SimpleApplicationEventMulticasterå¯¹è±¡\n\tthis.initialMulticaster = new SimpleApplicationEventMulticaster();\n\t// éå†åœ¨æ„é€ SpringApplicationå¯¹è±¡æ—¶ä»spring.factoriesé…ç½®æ–‡ä»¶ä¸­è·å–çš„äº‹ä»¶ç›‘å¬å™¨\n\tfor (ApplicationListener&lt;?> listener : application.getListeners()) &#123;\n\t\t// å°†ä»spring.factoriesé…ç½®æ–‡ä»¶ä¸­è·å–çš„äº‹ä»¶ç›‘å¬å™¨ä»¬æ·»åŠ åˆ°äº‹ä»¶å¹¿æ’­å™¨initialMulticasterå¯¹è±¡çš„ç›¸å…³é›†åˆä¸­\n\t\tthis.initialMulticaster.addApplicationListener(listener);\n\t&#125;\n&#125;\n\nå¯ä»¥çœ‹åˆ°åœ¨EventPublishingRunListenerçš„æ„é€ å‡½æ•°ä¸­æœ‰ä¸€ä¸ªforå¾ªç¯ä¼šéå†ä¹‹å‰ä»spring.factoriesä¸­åŠ è½½çš„ç›‘å¬å™¨ä»¬ï¼Œç„¶åæ·»åŠ åˆ°é›†åˆä¸­ç¼“å­˜èµ·æ¥ï¼Œç”¨äºä»¥åå¹¿æ’­å„ç§äº‹ä»¶æ—¶ç›´æ¥ä»è¿™ä¸ªé›†åˆä¸­å–å‡ºæ¥å³å¯ï¼Œè€Œä¸ç”¨å†å»spring.factoriesä¸­åŠ è½½ï¼Œæé«˜æ•ˆç‡ã€‚\n\n3.2 å¹¿æ’­ SpringBoot çš„å†…ç½®ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ä»spring.factoriesé…ç½®æ–‡ä»¶ä¸­åŠ è½½å¹¶å®ä¾‹åŒ–EventPublishingRunListenerå¯¹è±¡åï¼Œé‚£ä¹ˆåœ¨åœ¨ SpringBoot çš„å¯åŠ¨è¿‡ç¨‹ä¸­ä¼šå‘å°„ä¸€ç³»åˆ— SpringBoot å†…ç½®çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼Œæˆ‘ä»¬å†æ¥å›é¡¾ä¸‹ SpringBoot å¯åŠ¨è¿‡ç¨‹ä¸­çš„æºç ï¼š\n// SpringApplication.java\n\npublic ConfigurableApplicationContext run(String... args) &#123;\n\tStopWatch stopWatch = new StopWatch();\n\tstopWatch.start();\n\tConfigurableApplicationContext context = null;\n\tCollection&lt;SpringBootExceptionReporter> exceptionReporters = new ArrayList&lt;>();\n\tconfigureHeadlessProperty();\n\t// ã€0ã€‘æ–°å»ºä¸€ä¸ªSpringApplicationRunListenerså¯¹è±¡ç”¨äºå‘å°„SpringBootå¯åŠ¨è¿‡ç¨‹ä¸­çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶\n\tSpringApplicationRunListeners listeners = getRunListeners(args);\n\t// ã€1ã€‘ã€‹ã€‹ã€‹ã€‹ã€‹å‘å°„ã€ApplicationStartingEventã€‘äº‹ä»¶ï¼Œæ ‡å¿—SpringApplicationå¼€å§‹å¯åŠ¨\n\tlisteners.starting();\n\ttry &#123;\n\t\tApplicationArguments applicationArguments = new DefaultApplicationArguments(\n\t\t\t\targs);\n\t\t// ã€2ã€‘ã€‹ã€‹ã€‹ã€‹ã€‹å‘å°„ã€ApplicationEnvironmentPreparedEventã€‘äº‹ä»¶ï¼Œæ­¤æ—¶ä¼šå»åŠ è½½application.propertiesç­‰é…ç½®æ–‡ä»¶çš„ç¯å¢ƒå˜é‡ï¼ŒåŒæ—¶ä¹Ÿæœ‰æ ‡å¿—ç¯å¢ƒå˜é‡å·²ç»å‡†å¤‡å¥½çš„æ„æ€\n\t\tConfigurableEnvironment environment = prepareEnvironment(listeners,\n\t\t\t\tapplicationArguments);\n\t\tconfigureIgnoreBeanInfo(environment);\n\t\tBanner printedBanner = printBanner(environment);\n\t\tcontext = createApplicationContext();\n\t\texceptionReporters = getSpringFactoriesInstances(\n\t\t\t\tSpringBootExceptionReporter.class,\n\t\t\t\tnew Class[] &#123; ConfigurableApplicationContext.class &#125;, context);\n\t\t// ã€3ã€‘ã€‹ã€‹ã€‹ã€‹ã€‹å‘å°„ã€ApplicationContextInitializedEventã€‘äº‹ä»¶ï¼Œæ ‡å¿—contextå®¹å™¨è¢«åˆ›å»ºä¸”å·²å‡†å¤‡å¥½\n\t\t// ã€4ã€‘ã€‹ã€‹ã€‹ã€‹ã€‹å‘å°„ã€ApplicationPreparedEventã€‘äº‹ä»¶ï¼Œæ ‡å¿—Contextå®¹å™¨å·²ç»å‡†å¤‡å®Œæˆ\n\t\tprepareContext(context, environment, listeners, applicationArguments,\n\t\t\t\tprintedBanner);\n\t\trefreshContext(context);\n\t\tafterRefresh(context, applicationArguments);\n\t\tstopWatch.stop();\n\t\tif (this.logStartupInfo) &#123;\n\t\t\tnew StartupInfoLogger(this.mainApplicationClass)\n\t\t\t\t\t.logStarted(getApplicationLog(), stopWatch);\n\t\t&#125;\n\t\t// ã€5ã€‘ã€‹ã€‹ã€‹ã€‹ã€‹å‘å°„ã€ApplicationStartedEventã€‘äº‹ä»¶ï¼Œæ ‡å¿—springå®¹å™¨å·²ç»åˆ·æ–°ï¼Œæ­¤æ—¶æ‰€æœ‰çš„beanå®ä¾‹éƒ½å·²ç»åŠ è½½å®Œæ¯•\n\t\tlisteners.started(context);\n\t\tcallRunners(context, applicationArguments);\n\t&#125;\n\t// ã€6ã€‘ã€‹ã€‹ã€‹ã€‹ã€‹å‘å°„ã€ApplicationFailedEventã€‘äº‹ä»¶ï¼Œæ ‡å¿—SpringBootå¯åŠ¨å¤±è´¥\n\tcatch (Throwable ex) &#123;\n\t\thandleRunFailure(context, ex, exceptionReporters, listeners);\n\t\tthrow new IllegalStateException(ex);\n\t&#125;\n\ttry &#123;\n\t\t// ã€7ã€‘ã€‹ã€‹ã€‹ã€‹ã€‹å‘å°„ã€ApplicationReadyEventã€‘äº‹ä»¶ï¼Œæ ‡å¿—SpringApplicationå·²ç»æ­£åœ¨è¿è¡Œå³å·²ç»æˆåŠŸå¯åŠ¨ï¼Œå¯ä»¥æ¥æ”¶æœåŠ¡è¯·æ±‚äº†ã€‚\n\t\tlisteners.running(context);\n\t&#125;\n\tcatch (Throwable ex) &#123;\n\t\thandleRunFailure(context, ex, exceptionReporters, null);\n\t\tthrow new IllegalStateException(ex);\n\t&#125;\n\treturn context;\n&#125;\n\nå¯ä»¥çœ‹åˆ°åœ¨ SpringBoot çš„å¯åŠ¨è¿‡ç¨‹ä¸­æ€»å…±ä¼šå‘å°„ 7 ç§ä¸åŒç±»å‹çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼Œæ¥æ ‡å¿— SpringBoot çš„ä¸åŒå¯åŠ¨é˜¶æ®µï¼ŒåŒæ—¶ï¼Œè¿™äº›ç”Ÿå‘½å‘¨æœŸäº‹ä»¶çš„ç›‘å¬å™¨ä»¬ä¹Ÿä¼šæ‰§è¡Œä¸€äº›å¯åŠ¨è¿‡ç¨‹ä¸­çš„åˆå§‹åŒ–é€»è¾‘ï¼Œå…³äºè¿™äº›ç›‘å¬å™¨çš„åˆå§‹åŒ–é€»è¾‘å°†åœ¨ä¸‹ä¸€ç¯‡å†…å®¹ä¸­ä¼šåˆ†æã€‚ä»¥ä¸‹æ˜¯ SpringBoot å¯åŠ¨è¿‡ç¨‹ä¸­è¦å‘å°„çš„äº‹ä»¶ç±»å‹ï¼Œå…¶ä¸­ApplicationFailedEventåœ¨ SpringBoot å¯åŠ¨è¿‡ç¨‹ä¸­é‡åˆ°å¼‚å¸¸æ‰ä¼šå‘å°„ï¼š\n\nApplicationStartingEvent\nApplicationEnvironmentPreparedEvent\nApplicationContextInitializedEvent\nApplicationPreparedEvent\nApplicationStartedEvent\nApplicationFailedEvent\nApplicationReadyEvent\n\næˆ‘ä»¬ä»¥listeners.starting();è¿™å¥ä»£ç ä¸ºä¾‹ï¼Œçœ‹çœ‹EventPublishingRunListenerå¯¹è±¡å‘å°„äº‹ä»¶çš„æºç ï¼š\n// SpringApplicationRunListeners.java\n\npublic void starting() &#123;\n\t// éå†listenersé›†åˆï¼Œè¿™é‡Œå®è´¨å–å‡ºçš„å°±æ˜¯åˆšæ‰ä»spring.factoriesä¸­å–å‡ºçš„SPIå®ç°ç±»EventPublishingRunListener\n\t// è€ŒEventPublishingRunListenerå¯¹è±¡æ‰¿æ‹…äº†SpringBootå¯åŠ¨è¿‡ç¨‹ä¸­è´Ÿè´£å¹¿æ’­ä¸åŒçš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶\n\tfor (SpringApplicationRunListener listener : this.listeners) &#123;\n\t        // è°ƒç”¨EventPublishingRunListenerçš„startingæ–¹æ³•æ¥å¹¿æ’­ApplicationStartingEventäº‹ä»¶\n\t\tlistener.starting();\n\t&#125;\n&#125;\n\nç»§ç»­è·Ÿè¿›listener.starting();çš„æºç :\nEventPublishingRunListener.java\n\n// ã€‹ã€‹ã€‹ã€‹ã€‹å‘å°„ã€ApplicationStartingEventã€‘äº‹ä»¶\npublic void starting() &#123;\n\t// EventPublishingRunListenerå¯¹è±¡å°†å‘å¸ƒApplicationStartingEventè¿™ä»¶äº‹æƒ…å§”æ‰˜ç»™äº†initialMulticasterå¯¹è±¡\n\t// è°ƒç”¨initialMulticasterçš„multicastEventæ–¹æ³•æ¥å‘å°„ApplicationStartingEventäº‹ä»¶\n\tthis.initialMulticaster.multicastEvent(\n\t\t\tnew ApplicationStartingEvent(this.application, this.args));\n&#125;\n\nå¯ä»¥çœ‹åˆ°ï¼ŒEventPublishingRunListenerå¯¹è±¡å°†å‘å¸ƒApplicationStartingEventè¿™ä»¶äº‹æƒ…å§”æ‰˜ç»™äº†SimpleApplicationEventMulticasterå¯¹è±¡initialMulticaster,,è€ŒinitialMulticasterå¯¹è±¡æœ€ç»ˆä¼šè°ƒç”¨å…¶multicastEventæ–¹æ³•æ¥å‘å°„ApplicationStartingEventäº‹ä»¶ã€‚å…³äºSimpleApplicationEventMulticasterç±»å¦‚ä½•å¹¿æ’­äº‹ä»¶ï¼Œç¬”è€…å·²ç»åœ¨Spring æ˜¯å¦‚ä½•å®ç°äº‹ä»¶ç›‘å¬æœºåˆ¶çš„ï¼Ÿ Spring æºç ï¼ˆäºŒï¼‰è¿™ç¯‡æ–‡ç« å·²ç»è¯¦ç»†åˆ†æï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚\nå…³äº SpringBoot å¯åŠ¨è¿‡ç¨‹ä¸­å‘å°„å…¶ä»–ç”Ÿå‘½å‘¨æœŸäº‹ä»¶çš„æºç è¿™é‡Œä¸å†åˆ†æ\n\n4 SpringBoot çš„å†…ç½®ç”Ÿå‘½å‘¨æœŸäº‹ä»¶æ€»ç»“å¥½äº†ï¼Œå‰é¢å·²ç»åˆ†æäº† SpringBoot å¯åŠ¨è¿‡ç¨‹ä¸­è¦å‘å°„çš„å„ç§ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼Œä¸‹é¢åˆ—ä¸€ä¸ªè¡¨æ ¼æ€»ç»“ä¸‹ï¼š\n\n\n5 å°ç»“SpringBoot å¯åŠ¨è¿‡ç¨‹ä¸­å¹¿æ’­ç”Ÿå‘½å‘¨æœŸäº‹ä»¶çš„æºç åˆ†æå°±åˆ°æ­¤ç»“æŸäº†ï¼Œä¸‹ä¸€ç¯‡ä¼šç»§ç»­ä»‹ç»ç›‘å¬è¿™äº›ç”Ÿå‘½å‘¨æœŸäº‹ä»¶çš„ç›‘å¬å™¨ä»¬ã€‚æˆ‘ä»¬å†å›é¡¾æœ¬ç¯‡å†…å®¹æ€»ç»“ä¸‹å…³é”®ç‚¹ï¼š\nSpringBoot å¯åŠ¨è¿‡ç¨‹ä¸­ä¼šå‘å°„ 7 ç§ç±»å‹çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼Œæ ‡å¿—ä¸åŒçš„å¯åŠ¨é˜¶æ®µï¼Œç„¶åç›¸åº”çš„ç›‘å¬å™¨ä¼šç›‘å¬è¿™äº›äº‹ä»¶æ¥æ‰§è¡Œä¸€äº›åˆå§‹åŒ–é€»è¾‘å·¥ä½œã€‚\n\n\n10 SpringBootå†…ç½®ç”Ÿå‘½å‘¨æœŸäº‹ä»¶è¯¦è§£\n1 æ¸©æ•…è€ŒçŸ¥æ–°æ¸©æ•…è€ŒçŸ¥æ–°ï¼Œæˆ‘ä»¬æ¥ç®€å•å›é¡¾ä¸€ä¸‹ä¸Šç¯‡çš„å†…å®¹ï¼Œä¸Šä¸€ç¯‡æˆ‘ä»¬åˆ†æäº†SpringBoot å¯åŠ¨æ—¶å¹¿æ’­ç”Ÿå‘½å‘¨æœŸäº‹ä»¶çš„åŸç†ï¼Œç°å°†å…³é”®æ­¥éª¤å†æµ“ç¼©æ€»ç»“ä¸‹ï¼š\n\nä¸ºå¹¿æ’­ SpringBoot å†…ç½®ç”Ÿå‘½å‘¨æœŸäº‹ä»¶åšå‰æœŸå‡†å¤‡ï¼š1ï¼‰é¦–å…ˆåŠ è½½ApplicationListenerç›‘å¬å™¨å®ç°ç±»ï¼›2ï¼‰å…¶æ¬¡åŠ è½½ SPI æ‰©å±•ç±»EventPublishingRunListenerã€‚\nSpringBoot å¯åŠ¨æ—¶åˆ©ç”¨EventPublishingRunListenerå¹¿æ’­ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼Œç„¶åApplicationListenerç›‘å¬å™¨å®ç°ç±»ç›‘å¬ç›¸åº”çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶æ‰§è¡Œä¸€äº›åˆå§‹åŒ–é€»è¾‘çš„å·¥ä½œã€‚\n\n\n2 å¼•è¨€ä¸Šç¯‡æ–‡ç« çš„ä¾§é‡ç‚¹æ˜¯åˆ†æäº† SpringBoot å¯åŠ¨æ—¶å¹¿æ’­ç”Ÿå‘½å‘¨æœŸäº‹ä»¶çš„åŸç†ï¼Œæ­¤ç¯‡æ–‡ç« æˆ‘ä»¬å†æ¥è¯¦ç»†åˆ†æ SpringBoot å†…ç½®çš„ 7 ç§ç”Ÿå‘½å‘¨æœŸäº‹ä»¶çš„æºç ã€‚\n\n3 SpringBoot ç”Ÿå‘½å‘¨æœŸäº‹ä»¶æºç åˆ†æåˆ†æ SpringBoot çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€å¼ ç±»ç»“æ„å›¾ï¼š\n\nç”±ä¸Šå›¾å¯ä»¥çœ‹åˆ°äº‹ä»¶ç±»ä¹‹é—´çš„å…³ç³»ï¼š\n\næœ€é¡¶çº§çš„çˆ¶ç±»æ˜¯ JDK çš„äº‹ä»¶åŸºç±»EventObjectï¼›\nç„¶å Spring çš„äº‹ä»¶åŸºç±»ApplicationEventç»§æ‰¿äº† JDK çš„äº‹ä»¶åŸºç±»EventObjectï¼›\nå…¶æ¬¡ SpringBoot çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶åŸºç±»SpringApplicationEventç»§æ‰¿äº† Spring çš„äº‹ä»¶åŸºç±»ApplicationEventï¼›\næœ€å SpringBoot å…·ä½“çš„ 7 ä¸ªç”Ÿå‘½å‘¨æœŸäº‹ä»¶ç±»å†ç»§æ‰¿äº† SpringBoot çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶åŸºç±»SpringApplicationEventã€‚\n\n\n3.1 JDK çš„äº‹ä»¶åŸºç±» EventObjectEventObjectç±»æ˜¯ JDK çš„äº‹ä»¶åŸºç±»ï¼Œå¯ä»¥è¯´æ˜¯æ‰€æœ‰ Java äº‹ä»¶ç±»çš„åŸºæœ¬ï¼Œå³æ‰€æœ‰çš„ Java äº‹ä»¶ç±»éƒ½ç›´æ¥æˆ–é—´æ¥ç»§æ‰¿äºè¯¥ç±»ï¼Œæºç å¦‚ä¸‹ï¼š\n// EventObject.java\n\npublic class EventObject implements java.io.Serializable &#123;\n\n    private static final long serialVersionUID = 5516075349620653480L;\n\n    /**\n     * The object on which the Event initially occurred.\n     */\n    protected transient Object  source;\n    /**\n     * Constructs a prototypical Event.\n     *\n     * @param    source    The object on which the Event initially occurred.\n     * @exception  IllegalArgumentException  if source is null.\n     */\n    public EventObject(Object source) &#123;\n        if (source == null)\n            throw new IllegalArgumentException(\"null source\");\n        this.source = source;\n    &#125;\n    /**\n     * The object on which the Event initially occurred.\n     *\n     * @return   The object on which the Event initially occurred.\n     */\n    public Object getSource() &#123;\n        return source;\n    &#125;\n    /**\n     * Returns a String representation of this EventObject.\n     *\n     * @return  A a String representation of this EventObject.\n     */\n    public String toString() &#123;\n        return getClass().getName() + \"[source=\" + source + \"]\";\n    &#125;\n&#125;\n\nå¯ä»¥çœ‹åˆ°EventObjectç±»åªæœ‰ä¸€ä¸ªå±æ€§sourceï¼Œè¿™ä¸ªå±æ€§æ˜¯ç”¨æ¥è®°å½•æœ€åˆäº‹ä»¶æ˜¯å‘ç”Ÿåœ¨å“ªä¸ªç±»ï¼Œä¸¾ä¸ªæ —å­ï¼Œæ¯”å¦‚åœ¨ SpringBoot å¯åŠ¨è¿‡ç¨‹ä¸­ä¼šå‘å°„ApplicationStartingEventäº‹ä»¶ï¼Œè€Œè¿™ä¸ªäº‹ä»¶æœ€åˆæ˜¯åœ¨SpringApplicationç±»ä¸­å‘å°„çš„ï¼Œå› æ­¤sourceå°±æ˜¯SpringApplicationå¯¹è±¡ã€‚\n\n3.2 Spring çš„äº‹ä»¶åŸºç±» ApplicationEventApplicationEventç»§æ‰¿äº† DK çš„äº‹ä»¶åŸºç±»EventObjectç±»ï¼Œæ˜¯ Spring çš„äº‹ä»¶åŸºç±»ï¼Œè¢«æ‰€æœ‰ Spring çš„å…·ä½“äº‹ä»¶ç±»ç»§æ‰¿ï¼Œæºç å¦‚ä¸‹ï¼š\n// ApplicationEvent.java\n\n/**\n * Class to be extended by all application events. Abstract as it\n * doesn't make sense for generic events to be published directly.\n *\n * @author Rod Johnson\n * @author Juergen Hoeller\n */\npublic abstract class ApplicationEvent extends EventObject &#123;\n\t/** use serialVersionUID from Spring 1.2 for interoperability. */\n\tprivate static final long serialVersionUID = 7099057708183571937L;\n\t/** System time when the event happened. */\n\tprivate final long timestamp;\n\t/**\n\t * Create a new ApplicationEvent.\n\t * @param source the object on which the event initially occurred (never &#123;@code null&#125;)\n\t */\n\tpublic ApplicationEvent(Object source) &#123;\n\t\tsuper(source);\n\t\tthis.timestamp = System.currentTimeMillis();\n\t&#125;\n\t/**\n\t * Return the system time in milliseconds when the event happened.\n\t */\n\tpublic final long getTimestamp() &#123;\n\t\treturn this.timestamp;\n\t&#125;\n&#125;\n\nå¯ä»¥çœ‹åˆ°ApplicationEventæœ‰ä¸”ä»…æœ‰ä¸€ä¸ªå±æ€§timestampï¼Œè¯¥å±æ€§æ˜¯ç”¨æ¥è®°å½•äº‹ä»¶å‘ç”Ÿçš„æ—¶é—´ã€‚\n\n3.3 SpringBoot çš„äº‹ä»¶åŸºç±» SpringApplicationEventSpringApplicationEventç±»ç»§æ‰¿äº† Spring çš„äº‹ä»¶åŸºç±»ApplicationEventï¼Œæ˜¯æ‰€æœ‰ SpringBoot å†…ç½®ç”Ÿå‘½å‘¨æœŸäº‹ä»¶çš„çˆ¶ç±»ï¼Œæºç å¦‚ä¸‹ï¼š\n/**\n * Base class for &#123;@link ApplicationEvent&#125; related to a &#123;@link SpringApplication&#125;.\n *\n * @author Phillip Webb\n */\n@SuppressWarnings(\"serial\")\npublic abstract class SpringApplicationEvent extends ApplicationEvent &#123;\n\tprivate final String[] args;\n\tpublic SpringApplicationEvent(SpringApplication application, String[] args) &#123;\n\t\tsuper(application);\n\t\tthis.args = args;\n\t&#125;\n\tpublic SpringApplication getSpringApplication() &#123;\n\t\treturn (SpringApplication) getSource();\n\t&#125;\n\tpublic final String[] getArgs() &#123;\n\t\treturn this.args;\n\t&#125;\n&#125;\n\nå¯ä»¥çœ‹åˆ°SpringApplicationEventæœ‰ä¸”ä»…æœ‰ä¸€ä¸ªå±æ€§argsï¼Œè¯¥å±æ€§å°±æ˜¯ SpringBoot å¯åŠ¨æ—¶çš„å‘½ä»¤è¡Œå‚æ•°å³æ ‡æ³¨@SpringBootApplicationå¯åŠ¨ç±»ä¸­mainå‡½æ•°çš„å‚æ•°ã€‚\n\n3.4 SpringBoot å…·ä½“çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ç±»æ¥ä¸‹æ¥æˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹SpringBootå†…ç½®ç”Ÿå‘½å‘¨æœŸäº‹ä»¶å³SpringApplicationEventçš„å…·ä½“å­ç±»ä»¬ã€‚\n\n3.4.1 ApplicationStartingEvent// ApplicationStartingEvent.java\n\npublic class ApplicationStartingEvent extends SpringApplicationEvent &#123;\n\tpublic ApplicationStartingEvent(SpringApplication application, String[] args) &#123;\n\t\tsuper(application, args);\n\t&#125;\n&#125;\n\nSpringBoot å¼€å§‹å¯åŠ¨æ—¶ä¾¿ä¼šå‘å¸ƒApplicationStartingEventäº‹ä»¶ï¼Œå…¶å‘å¸ƒæ—¶æœºåœ¨ç¯å¢ƒå˜é‡ Environment æˆ–å®¹å™¨ ApplicationContext åˆ›å»ºå‰ä½†åœ¨æ³¨å†ŒApplicationListenerå…·ä½“ç›‘å¬å™¨ä¹‹åï¼Œæ ‡å¿—æ ‡å¿—SpringApplicationå¼€å§‹å¯åŠ¨ã€‚\n\n3.4.2 ApplicationEnvironmentPreparedEvent// ApplicationEnvironmentPreparedEvent.java\n\npublic class ApplicationEnvironmentPreparedEvent extends SpringApplicationEvent &#123;\n\tprivate final ConfigurableEnvironment environment;\n\t/**\n\t * Create a new &#123;@link ApplicationEnvironmentPreparedEvent&#125; instance.\n\t * @param application the current application\n\t * @param args the arguments the application is running with\n\t * @param environment the environment that was just created\n\t */\n\tpublic ApplicationEnvironmentPreparedEvent(SpringApplication application,\n\t\t\tString[] args, ConfigurableEnvironment environment) &#123;\n\t\tsuper(application, args);\n\t\tthis.environment = environment;\n\t&#125;\n\t/**\n\t * Return the environment.\n\t * @return the environment\n\t */\n\tpublic ConfigurableEnvironment getEnvironment() &#123;\n\t\treturn this.environment;\n\t&#125;\n&#125;\n\nå¯ä»¥çœ‹åˆ°ApplicationEnvironmentPreparedEventäº‹ä»¶å¤šäº†ä¸€ä¸ªenvironmentå±æ€§ï¼Œæˆ‘ä»¬ä¸å¦¨æƒ³ä¸€ä¸‹ï¼Œå¤šäº†environmentå±æ€§çš„ä½œç”¨æ˜¯å•¥ï¼Ÿ ç­”æ¡ˆå°±æ˜¯ApplicationEnvironmentPreparedEventäº‹ä»¶çš„environmentå±æ€§ä½œç”¨æ˜¯åˆ©ç”¨äº‹ä»¶å‘å¸ƒè®¢é˜…æœºåˆ¶ï¼Œç›¸åº”ç›‘å¬å™¨ä»¬å¯ä»¥ä»ApplicationEnvironmentPreparedEventäº‹ä»¶ä¸­å–å‡ºenvironmentå˜é‡ï¼Œç„¶åæˆ‘ä»¬å¯ä»¥ä¸ºenvironmentå±æ€§å¢åŠ å±æ€§å€¼æˆ–è¯»å‡ºenvironmentå˜é‡ä¸­çš„å€¼ã€‚\n\n\n\n\n\n\n\n\n\nä¸¾ä¸ªæ —å­ï¼š ConfigFileApplicationListenerç›‘å¬å™¨å°±æ˜¯ç›‘å¬äº†ApplicationEnvironmentPreparedEventäº‹ä»¶ï¼Œç„¶åå–å‡ºApplicationEnvironmentPreparedEventäº‹ä»¶çš„environmentå±æ€§ï¼Œç„¶åå†ä¸ºenvironmentå±æ€§å¢åŠ application.propertiesé…ç½®æ–‡ä»¶ä¸­çš„ç¯å¢ƒå˜é‡å€¼ã€‚\nå½“ SpringApplication å·²ç»å¼€å§‹å¯åŠ¨ä¸”ç¯å¢ƒå˜é‡Environmentå·²ç»åˆ›å»ºåï¼Œå¹¶ä¸”ä¸ºç¯å¢ƒå˜é‡Environmenté…ç½®äº†å‘½ä»¤è¡Œå’ŒServletç­‰ç±»å‹çš„ç¯å¢ƒå˜é‡åï¼Œæ­¤æ—¶ä¼šå‘å¸ƒApplicationEnvironmentPreparedEventäº‹ä»¶ã€‚\nç›‘å¬ApplicationEnvironmentPreparedEventäº‹ä»¶çš„ç¬¬ä¸€ä¸ªç›‘å¬å™¨æ˜¯ConfigFileApplicationListenerï¼Œå› ä¸ºæ˜¯ConfigFileApplicationListenerç›‘å¬å™¨è¿˜è¦ä¸ºç¯å¢ƒå˜é‡Environmentå¢åŠ application.propertiesé…ç½®æ–‡ä»¶ä¸­çš„ç¯å¢ƒå˜é‡ï¼›æ­¤åè¿˜æœ‰ä¸€äº›ä¹Ÿæ˜¯ç›‘å¬ApplicationEnvironmentPreparedEventäº‹ä»¶çš„å…¶ä»–ç›‘å¬å™¨ç›‘å¬åˆ°æ­¤äº‹ä»¶æ—¶ï¼Œæ­¤æ—¶å¯ä»¥è¯´ç¯å¢ƒå˜é‡Environmentå‡ ä¹å·²ç»å®Œå…¨å‡†å¤‡å¥½äº†ã€‚\n\n\n\n\n\n\n\n\n\næ€è€ƒï¼š ç›‘å¬åŒä¸€äº‹ä»¶çš„ç›‘å¬å™¨ä»¬æ‰§è¡Œç›‘å¬é€»è¾‘æ—¶æ˜¯æœ‰é¡ºåºçš„ï¼Œæˆ‘ä»¬å¯ä»¥æƒ³ä¸€ä¸‹è¿™ä¸ªæ’åºé€»è¾‘æ˜¯ä»€ä¹ˆæ—¶å€™æ’åºçš„ï¼Ÿè¿˜æœ‰ä¸ºä»€ä¹ˆè¦è¿™æ ·æ’åºå‘¢ï¼Ÿ\n\n3.4.3 ApplicationContextInitializedEvent// ApplicationContextInitializedEvent.java\n\npublic class ApplicationContextInitializedEvent extends SpringApplicationEvent &#123;\n\tprivate final ConfigurableApplicationContext context;\n\t/**\n\t * Create a new &#123;@link ApplicationContextInitializedEvent&#125; instance.\n\t * @param application the current application\n\t * @param args the arguments the application is running with\n\t * @param context the context that has been initialized\n\t */\n\tpublic ApplicationContextInitializedEvent(SpringApplication application,\n\t\t\tString[] args, ConfigurableApplicationContext context) &#123;\n\t\tsuper(application, args);\n\t\tthis.context = context;\n\t&#125;\n\t/**\n\t * Return the application context.\n\t * @return the context\n\t */\n\tpublic ConfigurableApplicationContext getApplicationContext() &#123;\n\t\treturn this.context;\n\t&#125;\n&#125;\n\nå¯ä»¥çœ‹åˆ°ApplicationContextInitializedEventäº‹ä»¶å¤šäº†ä¸ªConfigurableApplicationContextç±»å‹çš„contextå±æ€§ï¼Œcontextå±æ€§çš„ä½œç”¨åŒæ ·æ˜¯ä¸ºäº†ç›¸åº”ç›‘å¬å™¨å¯ä»¥æ‹¿åˆ°è¿™ä¸ªcontextå±æ€§æ‰§è¡Œä¸€äº›é€»è¾‘ï¼Œå…·ä½“ä½œç”¨å°†åœ¨3.4.4è¯¦è¿°ã€‚\nApplicationContextInitializedEventäº‹ä»¶åœ¨ApplicationContextå®¹å™¨åˆ›å»ºåï¼Œä¸”ä¸ºApplicationContextå®¹å™¨è®¾ç½®äº†environmentå˜é‡å’Œæ‰§è¡Œäº†ApplicationContextInitializersçš„åˆå§‹åŒ–æ–¹æ³•åä½†åœ¨ bean å®šä¹‰åŠ è½½å‰è§¦å‘ï¼Œæ ‡å¿— ApplicationContext å·²ç»åˆå§‹åŒ–å®Œæ¯•ã€‚\n\n\n\n\n\n\n\n\n\næ‰©å±•ï¼š å¯ä»¥çœ‹åˆ°ApplicationContextInitializedEventæ˜¯åœ¨ä¸ºcontextå®¹å™¨é…ç½®environmentå˜é‡åè§¦å‘ï¼Œæ­¤æ—¶ApplicationContextInitializedEventç­‰äº‹ä»¶åªè¦æœ‰contextå®¹å™¨çš„è¯ï¼Œé‚£ä¹ˆå…¶ä»–éœ€è¦environmentç¯å¢ƒå˜é‡çš„ç›‘å¬å™¨åªéœ€è¦ä»contextä¸­å–å‡ºenvironmentå˜é‡å³å¯ï¼Œä»è€ŒApplicationContextInitializedEventç­‰äº‹ä»¶æ²¡å¿…è¦å†é…ç½®environmentå±æ€§ã€‚\n\n3.4.4 ApplicationPreparedEvent// ApplicationPreparedEvent.java\n\npublic class ApplicationPreparedEvent extends SpringApplicationEvent &#123;\n\tprivate final ConfigurableApplicationContext context;\n\t/**\n\t * Create a new &#123;@link ApplicationPreparedEvent&#125; instance.\n\t * @param application the current application\n\t * @param args the arguments the application is running with\n\t * @param context the ApplicationContext about to be refreshed\n\t */\n\tpublic ApplicationPreparedEvent(SpringApplication application, String[] args,\n\t\t\tConfigurableApplicationContext context) &#123;\n\t\tsuper(application, args);\n\t\tthis.context = context;\n\t&#125;\n\t/**\n\t * Return the application context.\n\t * @return the context\n\t */\n\tpublic ConfigurableApplicationContext getApplicationContext() &#123;\n\t\treturn this.context;\n\t&#125;\n&#125;\n\nåŒæ ·å¯ä»¥çœ‹åˆ°ApplicationPreparedEventäº‹ä»¶å¤šäº†ä¸ªConfigurableApplicationContextç±»å‹çš„contextå±æ€§ï¼Œå¤šäº†contextå±æ€§çš„ä½œç”¨æ˜¯èƒ½è®©ç›‘å¬è¯¥äº‹ä»¶çš„ç›‘å¬å™¨ä»¬èƒ½æ‹¿åˆ°contextå±æ€§ï¼Œç›‘å¬å™¨æ‹¿åˆ°contextå±æ€§ä¸€èˆ¬æœ‰å¦‚ä¸‹ä½œç”¨ï¼š\n\nä»äº‹ä»¶ä¸­å–å‡ºcontextå±æ€§ï¼Œç„¶åå¯ä»¥å¢åŠ ä¸€äº›åç½®å¤„ç†å™¨ï¼Œæ¯”å¦‚ConfigFileApplicationListenerç›‘å¬å™¨ç›‘å¬åˆ°ApplicationPreparedEventäº‹ä»¶åï¼Œç„¶åå–å‡ºcontextå˜é‡ï¼Œé€šè¿‡contextå˜é‡å¢åŠ äº†PropertySourceOrderingPostProcessorè¿™ä¸ªåç½®å¤„ç†å™¨ï¼›\né€šè¿‡contextå±æ€§å–å‡ºbeanFactoryå®¹å™¨ï¼Œç„¶åæ³¨å†Œä¸€äº›beanï¼Œæ¯”å¦‚LoggingApplicationListenerç›‘å¬å™¨é€šè¿‡ApplicationPreparedEventäº‹ä»¶çš„contextå±æ€§å–å‡ºbeanFactoryå®¹å™¨,ç„¶åæ³¨å†Œäº†springBootLoggingSystemè¿™ä¸ªå•ä¾‹beanï¼›\né€šè¿‡contextå±æ€§å–å‡ºEnvironmentç¯å¢ƒå˜é‡ï¼Œç„¶åå°±å¯ä»¥æ“ä½œç¯å¢ƒå˜é‡ï¼Œæ¯”å¦‚PropertiesMigrationListenerã€‚\n\nApplicationPreparedEventäº‹ä»¶åœ¨ApplicationContextå®¹å™¨å·²ç»å®Œå…¨å‡†å¤‡å¥½æ—¶ä½†åœ¨å®¹å™¨åˆ·æ–°å‰è§¦å‘ï¼Œåœ¨è¿™ä¸ªé˜¶æ®µbeanå®šä¹‰å·²ç»åŠ è½½å®Œæ¯•è¿˜æœ‰environmentå·²ç»å‡†å¤‡å¥½å¯ä»¥ç”¨äº†ã€‚\n\n3.4.5 ApplicationStartedEvent// ApplicationStartedEvent.java\n\npublic class ApplicationStartedEvent extends SpringApplicationEvent &#123;\n\tprivate final ConfigurableApplicationContext context;\n\t/**\n\t * Create a new &#123;@link ApplicationStartedEvent&#125; instance.\n\t * @param application the current application\n\t * @param args the arguments the application is running with\n\t * @param context the context that was being created\n\t */\n\tpublic ApplicationStartedEvent(SpringApplication application, String[] args,\n\t\t\tConfigurableApplicationContext context) &#123;\n\t\tsuper(application, args);\n\t\tthis.context = context;\n\t&#125;\n\t/**\n\t * Return the application context.\n\t * @return the context\n\t */\n\tpublic ConfigurableApplicationContext getApplicationContext() &#123;\n\t\treturn this.context;\n\t&#125;\n&#125;\n\nApplicationStartedEventäº‹ä»¶å°†åœ¨å®¹å™¨åˆ·æ–°åä½†ApplicationRunnerå’ŒCommandLineRunnerçš„runæ–¹æ³•æ‰§è¡Œå‰è§¦å‘ï¼Œæ ‡å¿—Springå®¹å™¨å·²ç»åˆ·æ–°ï¼Œæ­¤æ—¶å®¹å™¨å·²ç»å‡†å¤‡å®Œæ¯•äº†ã€‚\n\n\n\n\n\n\n\n\n\næ‰©å±•ï¼š è¿™é‡Œæåˆ°äº†ApplicationRunnerå’ŒCommandLineRunneræ¥å£æœ‰å•¥ä½œç”¨å‘¢ï¼Ÿæˆ‘ä»¬ä¸€èˆ¬ä¼šåœ¨Springå®¹å™¨åˆ·æ–°å®Œæ¯•åï¼Œæ­¤æ—¶å¯èƒ½æœ‰ä¸€äº›ç³»ç»Ÿå‚æ•°ç­‰é™æ€æ•°æ®éœ€è¦åŠ è½½ï¼Œæ­¤æ—¶æˆ‘ä»¬å°±å¯ä»¥å®ç°äº†ApplicationRunneræˆ–CommandLineRunneræ¥å£æ¥å®ç°é™æ€æ•°æ®çš„åŠ è½½ã€‚\n\n3.4.6 ApplicationReadyEvent// ApplicationReadyEvent.java\n\npublic class ApplicationReadyEvent extends SpringApplicationEvent &#123;\n\tprivate final ConfigurableApplicationContext context;\n\t/**\n\t * Create a new &#123;@link ApplicationReadyEvent&#125; instance.\n\t * @param application the current application\n\t * @param args the arguments the application is running with\n\t * @param context the context that was being created\n\t */\n\tpublic ApplicationReadyEvent(SpringApplication application, String[] args,\n\t\t\tConfigurableApplicationContext context) &#123;\n\t\tsuper(application, args);\n\t\tthis.context = context;\n\t&#125;\n\t/**\n\t * Return the application context.\n\t * @return the context\n\t */\n\tpublic ConfigurableApplicationContext getApplicationContext() &#123;\n\t\treturn this.context;\n\t&#125;\n&#125;\n\nApplicationReadyEventäº‹ä»¶åœ¨è°ƒç”¨å®ŒApplicationRunnerå’ŒCommandLineRunnerçš„runæ–¹æ³•åè§¦å‘ï¼Œæ­¤æ—¶æ ‡å¿—SpringApplicationå·²ç»æ­£åœ¨è¿è¡Œã€‚\n\n3.4.7 ApplicationFailedEvent// ApplicationFailedEvent.java\n\npublic class ApplicationFailedEvent extends SpringApplicationEvent &#123;\n\tprivate final ConfigurableApplicationContext context;\n\tprivate final Throwable exception;\n\t/**\n\t * Create a new &#123;@link ApplicationFailedEvent&#125; instance.\n\t * @param application the current application\n\t * @param args the arguments the application was running with\n\t * @param context the context that was being created (maybe null)\n\t * @param exception the exception that caused the error\n\t */\n\tpublic ApplicationFailedEvent(SpringApplication application, String[] args,\n\t\t\tConfigurableApplicationContext context, Throwable exception) &#123;\n\t\tsuper(application, args);\n\t\tthis.context = context;\n\t\tthis.exception = exception;\n\t&#125;\n\t/**\n\t * Return the application context.\n\t * @return the context\n\t */\n\tpublic ConfigurableApplicationContext getApplicationContext() &#123;\n\t\treturn this.context;\n\t&#125;\n\t/**\n\t * Return the exception that caused the failure.\n\t * @return the exception\n\t */\n\tpublic Throwable getException() &#123;\n\t\treturn this.exception;\n\t&#125;\n&#125;\nå¤åˆ¶ä»£ç \n\nå¯ä»¥çœ‹åˆ°ApplicationFailedEventäº‹ä»¶é™¤äº†å¤šäº†ä¸€ä¸ªcontextå±æ€§å¤–ï¼Œè¿˜å¤šäº†ä¸€ä¸ªThrowableç±»å‹çš„exceptionå±æ€§ç”¨æ¥è®°å½• SpringBoot å¯åŠ¨å¤±è´¥æ—¶çš„å¼‚å¸¸ã€‚\nApplicationFailedEventäº‹ä»¶åœ¨ SpringBoot å¯åŠ¨å¤±è´¥æ—¶è§¦å‘ï¼Œæ ‡å¿— SpringBoot å¯åŠ¨å¤±è´¥ã€‚\n\n4 å°ç»“æ­¤ç¯‡æ–‡ç« ç›¸å¯¹ç®€å•ï¼Œå¯¹ SpringBoot å†…ç½®çš„ 7 ç§ç”Ÿå‘½å‘¨æœŸäº‹ä»¶è¿›è¡Œäº†è¯¦ç»†åˆ†æã€‚æˆ‘ä»¬è¿˜æ˜¯å¼•ç”¨ä¸Šç¯‡æ–‡ç« çš„ä¸€å¼ å›¾æ¥å›é¡¾ä¸€ä¸‹è¿™äº›ç”Ÿå‘½å‘¨æœŸäº‹ä»¶åŠå…¶ç”¨é€”ï¼š\n\n","slug":"SpringBootæºç åˆ†æ","date":"2022-06-11T09:02:18.830Z","categories_index":"SpringBoot","tags_index":"Spring,SpringBoot,æºç åˆ†æ","author_index":"å°æä¸åœ¨_"},{"id":"f63fd983001a548ddde94851f2bab33a","title":"Nettyæºç åˆ†æ","content":"æœ¬æ–‡å°†ä»‹ç» Nettyï¼ŒJava å¹³å°ä¸Šä½¿ç”¨æœ€å¹¿æ³›çš„ NIO åŒ…ï¼Œå®ƒæ˜¯å¯¹ JDK ä¸­çš„ NIO å®ç°çš„ä¸€å±‚å°è£…ï¼Œè®©æˆ‘ä»¬èƒ½æ›´æ–¹ä¾¿åœ°å¼€å‘ NIO ç¨‹åºã€‚å…¶å®ï¼ŒNetty ä¸ä»…ä»…æ˜¯ NIO å§ï¼Œä½†æ˜¯ï¼ŒåŸºæœ¬ä¸Šå¤§å®¶éƒ½å†²ç€ NIO æ¥çš„ã€‚\n\næœ¬æ–‡åªä»‹ç» TCP ç›¸å…³çš„å†…å®¹ï¼ŒNetty å¯¹äºå…¶ä»–åè®®çš„æ”¯æŒï¼Œä¸åœ¨æœ¬æ–‡çš„è®¨è®ºèŒƒå›´å†…ã€‚\nå’Œå¹¶å‘åŒ…çš„æºç åˆ†æä¸ä¸€æ ·ï¼Œæˆ‘ä¸å¯èƒ½ä¸€è¡Œä¸€è¡Œæºç è¯´ï¼Œæ‰€ä»¥æœ‰äº›å¼‚å¸¸åˆ†æ”¯æ˜¯ä¼šç›´æ¥ç•¥è¿‡ï¼Œé™¤éæˆ‘è§‰å¾—éœ€è¦ä»‹ç»ã€‚\nNetty æºç ä¸€ç›´åœ¨æ›´æ–°ï¼Œå„ç‰ˆæœ¬ä¹‹é—´æœ‰äº›å·®å¼‚ï¼Œæˆ‘æ˜¯æŒ‰ç…§ 4.1.25.Final ç‰ˆæœ¬æ¥è¿›è¡Œä»‹ç»çš„ã€‚\n\nå»ºè®®åˆå­¦è€…åœ¨çœ‹å®Œæœ¬æ–‡ä»¥åï¼Œå¯ä»¥å»ç¿»ç¿»ã€ŠNetty In Actionã€‹ï¼Œç½‘ä¸Šä¹Ÿå¯ä»¥æ‰¾åˆ°ä¸­æ–‡æ–‡å­—ç‰ˆçš„ã€‚\nå‡†å¤‡å­¦ä¹ æºç ï¼Œä¸€å¼€å§‹è‚¯å®šæ˜¯å‡†å¤‡ç¯å¢ƒã€‚\næˆ‘å–œæ¬¢ç”¨ mavenï¼Œä¹Ÿå–œæ¬¢ Spring Bootï¼Œæ‰€ä»¥æˆ‘ä¸€èˆ¬å…ˆåˆ° https://start.spring.io/ å‡†å¤‡ä¸€ä¸ªæœ€ç®€å•çš„è„šæ‰‹æ¶ã€‚\n10 ç§’æå®šè„šæ‰‹æ¶ï¼Œç„¶åå°±æ˜¯å¯¼å…¥åˆ° Intellij ä¸­ï¼Œå¦‚æœç”¨æ–°ç‰ˆæœ¬çš„ Spring Bootï¼Œå¯èƒ½è¿˜éœ€è¦ç­‰å¾…ä¸‹è½½ä¾èµ–ï¼ŒæœŸé—´æ‰“å¼€ https://mvnrepository.com/ æœç´¢é©¬ä¸Šè¦ç”¨åˆ°çš„ maven ä¾èµ–ã€‚\nNetty åˆ†ä¸ºå¥½äº›æ¨¡å—ï¼Œæœ‰ netty-handlerã€netty-bufferã€netty-transportã€netty-common ç­‰ç­‰ï¼Œä¹Ÿæœ‰ä¸€ä¸ª netty-allï¼Œå®ƒåŒ…å«äº†æ‰€æœ‰çš„æ¨¡å—ã€‚\næ—¢ç„¶æˆ‘ä»¬æ˜¯æºç åˆ†æï¼Œé‚£ä¹ˆè‡ªç„¶æ˜¯ç”¨ä¸€ä¸ªæœ€ç®€å•çš„ã€‚netty-all ä¸æ˜¯æœ€å¥½çš„é€‰æ‹©ï¼Œnetty-example æ‰æ˜¯ï¼š\n&lt;dependency>\n   &lt;groupId>io.netty&lt;/groupId>\n   &lt;artifactId>netty-example&lt;/artifactId>\n   &lt;version>4.1.25.Final&lt;/version>\n&lt;/dependency>\n\nå®ƒä¸ä»…å¯ä»¥è§£å†³æˆ‘ä»¬çš„ä¾èµ–ï¼Œè€Œä¸” example é‡Œé¢çš„ç¤ºä¾‹éå¸¸é€‚åˆæˆ‘ä»¬å­¦ä¹ ä½¿ç”¨ã€‚\n\nEcho ä¾‹å­Netty ä½œä¸º NIO çš„åº“ï¼Œè‡ªç„¶æ—¢å¯ä»¥ä½œä¸ºæœåŠ¡ç«¯æ¥å—è¯·æ±‚ï¼Œä¹Ÿå¯ä»¥ä½œä¸ºå®¢æˆ·ç«¯å‘èµ·è¯·æ±‚ã€‚ä½¿ç”¨ Netty å¼€å‘å®¢æˆ·ç«¯æˆ–æœåŠ¡ç«¯éƒ½æ˜¯éå¸¸ç®€å•çš„ï¼ŒNetty åšäº†å¾ˆå¥½çš„å°è£…ï¼Œæˆ‘ä»¬é€šå¸¸åªè¦å¼€å‘ä¸€ä¸ªæˆ–å¤šä¸ª handler ç”¨æ¥å¤„ç†æˆ‘ä»¬çš„è‡ªå®šä¹‰é€»è¾‘å°±å¯ä»¥äº†ã€‚\nä¸‹é¢ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªç»å¸¸ä¼šè§åˆ°çš„ä¾‹å­ï¼Œå®ƒå« Echoï¼Œä¹Ÿå°±æ˜¯å›å£°ï¼Œå®¢æˆ·ç«¯ä¼ è¿‡å»ä»€ä¹ˆå€¼ï¼ŒæœåŠ¡ç«¯åŸæ ·è¿”å›ä»€ä¹ˆå€¼ã€‚\n\n\n\n\n\n\n\n\n\næ‰“å¼€ netty-example çš„æºç ï¼ŒæŠŠ echo åŒ…ä¸‹é¢çš„ä»£ç å¤åˆ¶å‡ºæ¥ç©ä¸€ç©ã€‚\n\n\n\n\n\n\n\n\n\n\nå·¦è¾¹æ˜¯æœåŠ¡ç«¯ä»£ç ï¼Œå³è¾¹æ˜¯å®¢æˆ·ç«¯ä»£ç ã€‚\nä¸Šé¢çš„ä»£ç åŸºæœ¬å°±æ˜¯æ¨¡æ¿ä»£ç ï¼Œæ¯æ¬¡ä½¿ç”¨éƒ½æ˜¯è¿™ä¸€ä¸ªå¥—è·¯ï¼Œå”¯ä¸€éœ€è¦æˆ‘ä»¬å¼€å‘çš„éƒ¨åˆ†æ˜¯ handler(â€¦) å’Œ childHandler(â€¦) æ–¹æ³•ä¸­æŒ‡å®šçš„å„ä¸ª handlerï¼Œå¦‚ **EchoServerHandler** å’Œ **EchoClientHandler**ï¼Œå½“ç„¶ Netty æºç ä¹Ÿç»™æˆ‘ä»¬æä¾›äº†å¾ˆå¤šçš„ handlerï¼Œæ¯”å¦‚ä¸Šé¢çš„ LoggingHandlerï¼Œå®ƒå°±æ˜¯ Netty æºç ä¸­ä¸ºæˆ‘ä»¬æä¾›çš„ï¼Œéœ€è¦çš„æ—¶å€™ç›´æ¥æ‹¿è¿‡æ¥ç”¨å°±å¥½äº†ã€‚\næˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹ä¸Šè¿°ä»£ç ä¸­æ¶‰åŠåˆ°çš„ä¸€äº›å†…å®¹ï¼š\n\nServerBootstrap ç±»ç”¨äºåˆ›å»ºæœåŠ¡ç«¯å®ä¾‹ï¼ŒBootstrap ç”¨äºåˆ›å»ºå®¢æˆ·ç«¯å®ä¾‹ã€‚ \n\nä¸¤ä¸ª EventLoopGroup ï¼šbossGroup å’Œ workerGroupï¼Œå®ƒä»¬æ¶‰åŠçš„æ˜¯ Netty çš„çº¿ç¨‹æ¨¡å‹ï¼Œå¯ä»¥çœ‹åˆ°æœåŠ¡ç«¯æœ‰ä¸¤ä¸ª groupï¼Œè€Œå®¢æˆ·ç«¯åªæœ‰ä¸€ä¸ªï¼Œå®ƒä»¬å°±æ˜¯ Netty ä¸­çš„çº¿ç¨‹æ± ã€‚ \n\nNetty ä¸­çš„ Channelï¼Œæ²¡æœ‰ç›´æ¥ä½¿ç”¨ Java åŸç”Ÿçš„ ServerSocketChannel å’Œ SocketChannelï¼Œè€Œæ˜¯åŒ…è£…äº† NioServerSocketChannel å’Œ NioSocketChannel ä¸ä¹‹å¯¹åº”ã€‚  \n\n\n\n\n\n\n\n\n\nå½“ç„¶ï¼Œä¹Ÿæœ‰å¯¹å…¶ä»–åè®®çš„æ”¯æŒï¼Œå¦‚æ”¯æŒ UDP åè®®çš„ NioDatagramChannelï¼Œæœ¬æ–‡åªå…³å¿ƒ TCP ç›¸å…³çš„ã€‚\n\nå·¦è¾¹ handler(â€¦) æ–¹æ³•æŒ‡å®šäº†ä¸€ä¸ª handlerï¼ˆLoggingHandlerï¼‰ï¼Œè¿™ä¸ª handler æ˜¯ç»™æœåŠ¡ç«¯æ”¶åˆ°æ–°çš„è¯·æ±‚çš„æ—¶å€™å¤„ç†ç”¨çš„ã€‚å³è¾¹ handler(...) æ–¹æ³•æŒ‡å®šäº†å®¢æˆ·ç«¯å¤„ç†è¯·æ±‚è¿‡ç¨‹ä¸­éœ€è¦ä½¿ç”¨çš„ handlersã€‚  \n\n\n\n\n\n\n\n\n\nå¦‚æœä½ æƒ³åœ¨ EchoServer ä¸­ä¹ŸæŒ‡å®šå¤šä¸ª handlerï¼Œä¹Ÿå¯ä»¥åƒå³è¾¹çš„ EchoClient ä¸€æ ·ä½¿ç”¨ ChannelInitializer\n\nå·¦è¾¹ childHandler(â€¦) æŒ‡å®šäº† childHandlerï¼Œè¿™è¾¹çš„ handlers æ˜¯ç»™æ–°åˆ›å»ºçš„è¿æ¥ç”¨çš„ï¼Œæˆ‘ä»¬çŸ¥é“æœåŠ¡ç«¯ ServerSocketChannel åœ¨ accept ä¸€ä¸ªè¿æ¥ä»¥åï¼Œéœ€è¦åˆ›å»º SocketChannel çš„å®ä¾‹ï¼ŒchildHandler(â€¦) ä¸­è®¾ç½®çš„ handler å°±æ˜¯ç”¨äºå¤„ç†æ–°åˆ›å»ºçš„ SocketChannel çš„ï¼Œè€Œä¸æ˜¯ç”¨æ¥å¤„ç† ServerSocketChannel å®ä¾‹çš„ã€‚ \n\npipelineï¼šhandler å¯ä»¥æŒ‡å®šå¤šä¸ªï¼ˆéœ€è¦ä¸Šé¢çš„ ChannelInitializer ç±»è¾…åŠ©ï¼‰ï¼Œå®ƒä»¬ä¼šç»„æˆäº†ä¸€ä¸ª pipelineï¼Œå®ƒä»¬å…¶å®å°±ç±»ä¼¼æ‹¦æˆªå™¨çš„æ¦‚å¿µï¼Œç°åœ¨åªè¦è®°ä½ä¸€ç‚¹ï¼Œæ¯ä¸ª NioSocketChannel æˆ– NioServerSocketChannel å®ä¾‹å†…éƒ¨éƒ½ä¼šæœ‰ä¸€ä¸ª pipeline å®ä¾‹ã€‚pipeline ä¸­è¿˜æ¶‰åŠåˆ° handler çš„æ‰§è¡Œé¡ºåºã€‚ \n\nChannelFutureï¼šè¿™ä¸ªæ¶‰åŠåˆ° Netty ä¸­çš„å¼‚æ­¥ç¼–ç¨‹ï¼Œå’Œ JDK ä¸­çš„ Future æ¥å£ç±»ä¼¼ã€‚\n\n\nå¯¹äºä¸äº†è§£ Netty çš„è¯»è€…ï¼Œä¹Ÿä¸è¦æœ‰ä»€ä¹ˆå‹åŠ›ï¼Œæˆ‘ä¼šä¸€ä¸€ä»‹ç»å®ƒä»¬ï¼Œæœ¬æ–‡ä¸»è¦é¢å‘æ–°æ‰‹ï¼Œæˆ‘è§‰å¾—æ¯”è¾ƒéš¾ç†è§£æˆ–æ¯”è¾ƒé‡è¦çš„éƒ¨åˆ†ï¼Œä¼šèŠ±æ¯”è¾ƒå¤§çš„ç¯‡å¹…æ¥ä»‹ç»æ¸…æ¥šã€‚\nä¸Šé¢çš„æºç ä¸­æ²¡æœ‰å±•ç¤ºæ¶ˆæ¯å‘é€å’Œæ¶ˆæ¯æ¥æ”¶çš„å¤„ç†ï¼Œæ­¤éƒ¨åˆ†æˆ‘ä¼šåœ¨ä»‹ç»å®Œä¸Šé¢çš„è¿™äº›å†…å®¹ä»¥åå†è¿›è¡Œä»‹ç»ã€‚\n\næºç åˆ†æ1.ç½‘ç»œæ“ä½œæŠ½è±¡ç±»ï¼š Channelåˆå§‹åŒ– ChannelChannel æ¥å£æ˜¯ Netty å¯¹ç½‘ç»œæ“ä½œæŠ½è±¡ç±»ã€‚é€šè¿‡ Channel æˆ‘ä»¬å¯ä»¥è¿›è¡Œ I&#x2F;O æ“ä½œã€‚\nä¸€æ—¦å®¢æˆ·ç«¯æˆåŠŸè¿æ¥æœåŠ¡ç«¯ï¼Œå°±ä¼šæ–°å»ºä¸€ä¸ª Channel åŒè¯¥ç”¨æˆ·ç«¯è¿›è¡Œç»‘å®šï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š\n//  é€šè¿‡ Bootstrap çš„ connect æ–¹æ³•è¿æ¥åˆ°æœåŠ¡ç«¯\npublic Channel doConnect(InetSocketAddress inetSocketAddress) &#123;\n     CompletableFuture&lt;Channel> completableFuture = new CompletableFuture&lt;>();\n     bootstrap.connect(inetSocketAddress).addListener((ChannelFutureListener) future -> &#123;\n         if (future.isSuccess()) &#123;\n             completableFuture.complete(future.channel());\n         &#125; else &#123;\n             throw new IllegalStateException();\n         &#125;\n     &#125;);\n     return completableFuture.get();\n &#125;\n\næ¯”è¾ƒå¸¸ç”¨çš„Channelæ¥å£å®ç°ç±»æ˜¯ ï¼š\n\nNioServerSocketChannelï¼ˆæœåŠ¡ç«¯ï¼‰\nNioSocketChannelï¼ˆå®¢æˆ·ç«¯ï¼‰\n\nè¿™ä¸¤ä¸ª Channel å¯ä»¥å’Œ BIO ç¼–ç¨‹æ¨¡å‹ä¸­çš„ServerSocketä»¥åŠSocketä¸¤ä¸ªæ¦‚å¿µå¯¹åº”ä¸Šã€‚\nè¿™èŠ‚æˆ‘ä»¬æ¥çœ‹çœ‹ NioSocketChannel æ˜¯æ€ä¹ˆå’Œ JDK åº•å±‚çš„ SocketChannel è”ç³»åœ¨ä¸€èµ·çš„ï¼Œå®ƒä»¬æ˜¯ä¸€å¯¹ä¸€çš„å…³ç³»ã€‚NioServerSocketChannel å’Œ ServerSocketChannel åŒç†ï¼Œä¹Ÿæ˜¯ä¸€å¯¹ä¸€çš„å…³ç³»ã€‚\n\nåœ¨ Bootstrapï¼ˆå®¢æˆ·ç«¯ï¼‰ å’Œ ServerBootstrapï¼ˆæœåŠ¡ç«¯ï¼‰ çš„å¯åŠ¨è¿‡ç¨‹ä¸­éƒ½ä¼šè°ƒç”¨ channel(â€¦) æ–¹æ³•ï¼š\n\nä¸‹é¢ï¼Œæˆ‘ä»¬æ¥çœ‹ channel(â€¦) æ–¹æ³•çš„æºç ï¼š\n// AbstractBootstrap\npublic B channel(Class&lt;? extends C> channelClass) &#123;\n    if (channelClass == null) &#123;\n        throw new NullPointerException(\"channelClass\");\n    &#125;\n    return channelFactory(new ReflectiveChannelFactory&lt;C>(channelClass));\n&#125;\n\næˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªæ–¹æ³•åªæ˜¯è®¾ç½®äº† channelFactory ä¸º ReflectiveChannelFactory çš„ä¸€ä¸ªå®ä¾‹ï¼Œç„¶åæˆ‘ä»¬çœ‹ä¸‹è¿™é‡Œçš„ ReflectiveChannelFactory åˆ°åº•æ˜¯ä»€ä¹ˆï¼š\n\n**newChannel()** æ–¹æ³•æ˜¯ ChannelFactory æ¥å£ä¸­çš„å”¯ä¸€æ–¹æ³•ï¼Œå·¥å‚æ¨¡å¼ å¤§å®¶éƒ½å¾ˆç†Ÿæ‚‰ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒReflectiveChannelFactory#newChannel() æ–¹æ³•ä¸­ä½¿ç”¨äº†åå°„è°ƒç”¨ Channel çš„æ— å‚æ„é€ æ–¹æ³•æ¥åˆ›å»º Channelï¼Œæˆ‘ä»¬åªè¦çŸ¥é“ï¼ŒChannelFactory çš„ newChannel() æ–¹æ³•ä»€ä¹ˆæ—¶å€™ä¼šè¢«è°ƒç”¨å°±å¯ä»¥äº†ã€‚\n\nå¯¹äº NioSocketChannelï¼Œç”±äºå®ƒå……å½“å®¢æˆ·ç«¯çš„åŠŸèƒ½ï¼Œå®ƒçš„åˆ›å»ºæ—¶æœºåœ¨ connect(â€¦) çš„æ—¶å€™ï¼›\nå¯¹äº NioServerSocketChannel æ¥è¯´ï¼Œå®ƒå……å½“æœåŠ¡ç«¯åŠŸèƒ½ï¼Œå®ƒçš„åˆ›å»ºæ—¶æœºåœ¨ç»‘å®šç«¯å£ bind(â€¦) çš„æ—¶å€™ã€‚\n\næ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥ç®€å•è¿½è¸ªä¸‹å……å½“å®¢æˆ·ç«¯çš„ Bootstrap ä¸­ NioSocketChannel çš„åˆ›å»ºè¿‡ç¨‹ï¼Œçœ‹çœ‹ NioSocketChannel æ˜¯æ€ä¹ˆå’Œ JDK ä¸­çš„ SocketChannel å…³è”åœ¨ä¸€èµ·çš„ï¼š\n// Bootstrap\npublic ChannelFuture connect(String inetHost, int inetPort) &#123;\n    return connect(InetSocketAddress.createUnresolved(inetHost, inetPort));\n&#125;\n\nç„¶åå†å¾€é‡Œçœ‹ï¼Œåˆ°è¿™ä¸ªæ–¹æ³•ï¼š\npublic ChannelFuture connect(SocketAddress remoteAddress) &#123;\n    if (remoteAddress == null) &#123;\n        throw new NullPointerException(\"remoteAddress\");\n    // validate åªæ˜¯æ ¡éªŒä¸€ä¸‹å„ä¸ªå‚æ•°æ˜¯ä¸æ˜¯æ­£ç¡®è®¾ç½®äº†\n    validate();\n    return doResolveAndConnect(remoteAddress, config.localAddress());\n&#125;\n\nç»§ç»­ï¼š\n// å†å¾€é‡Œå°±åˆ°è¿™é‡Œäº†\nprivate ChannelFuture doResolveAndConnect(final SocketAddress remoteAddress, final SocketAddress localAddress) &#123;\n    // æˆ‘ä»¬è¦è¯´çš„éƒ¨åˆ†åœ¨è¿™é‡Œ\n    final ChannelFuture regFuture = initAndRegister();\n    final Channel channel = regFuture.channel();\n    ......\n&#125;\n\nç„¶åï¼Œæˆ‘ä»¬çœ‹ initAndRegister() æ–¹æ³•ï¼š\nfinal ChannelFuture initAndRegister() &#123;\n    Channel channel = null;\n    try &#123;\n        // å‰é¢æˆ‘ä»¬è¯´è¿‡ï¼Œè¿™é‡Œä¼šè¿›è¡Œ Channel çš„å®ä¾‹åŒ–\n        channel = channelFactory.newChannel();\n        init(channel);\n    &#125; catch (Throwable t) &#123;\n        ...\n    &#125;\n    ...\n    return regFuture;\n&#125;\n\næˆ‘ä»¬æ‰¾åˆ°äº† channel = channelFactory.newChannel() è¿™è¡Œä»£ç ï¼Œæ ¹æ®å‰é¢è¯´çš„ï¼Œè¿™é‡Œä¼šè°ƒç”¨ç›¸åº” Channel çš„æ— å‚æ„é€ æ–¹æ³•ã€‚\nç„¶åæˆ‘ä»¬å°±å¯ä»¥å»çœ‹ NioSocketChannel çš„æ„é€ æ–¹æ³•äº†ï¼š\npublic NioSocketChannel() &#123;\n    // SelectorProvider å®ä¾‹ç”¨äºåˆ›å»º JDK çš„ SocketChannel å®ä¾‹\n    this(DEFAULT_SELECTOR_PROVIDER);\n&#125;\n\npublic NioSocketChannel(SelectorProvider provider) &#123;\n    // çœ‹è¿™é‡Œï¼ŒnewSocket(provider) æ–¹æ³•ä¼šåˆ›å»º JDK çš„ SocketChannel\n    this(newSocket(provider));\n&#125;\n\næˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è°ƒç”¨ newSocket(provider) çš„æ—¶å€™ï¼Œä¼šåˆ›å»º JDK NIO çš„ä¸€ä¸ª SocketChannel å®ä¾‹ï¼š\nprivate static SocketChannel newSocket(SelectorProvider provider) &#123;\n    try &#123;\n        // åˆ›å»º SocketChannel å®ä¾‹\n        return provider.openSocketChannel();\n    &#125; catch (IOException e) &#123;\n        throw new ChannelException(\"Failed to open a socket.\", e);\n    &#125;\n&#125;\n\nNioServerSocketChannel åŒç†ï¼Œä¹Ÿéå¸¸ç®€å•ï¼Œä» ServerBootstrap#bind(...) æ–¹æ³•ä¸€è·¯ç‚¹è¿›å»å°±æ¸…æ¥šäº†ã€‚\næ‰€ä»¥æˆ‘ä»¬çŸ¥é“äº†ï¼ŒNioSocketChannel åœ¨å®ä¾‹åŒ–è¿‡ç¨‹ä¸­ï¼Œä¼šå…ˆå®ä¾‹åŒ– JDK åº•å±‚çš„ SocketChannelï¼ŒNioServerSocketChannel ä¹Ÿä¸€æ ·ï¼Œä¼šå…ˆå®ä¾‹åŒ– ServerSocketChannel å®ä¾‹ï¼š\n\nè¯´åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬é¡ºä¾¿å†ç»§ç»­å¾€é‡Œçœ‹ä¸€ä¸‹ NioSocketChannel çš„æ„é€ æ–¹æ³•ï¼š\npublic NioSocketChannel(SelectorProvider provider) &#123;\n    this(newSocket(provider));\n&#125;\n\nåˆšæ‰æˆ‘ä»¬çœ‹åˆ°è¿™é‡Œï¼ŒnewSocket(provider) åˆ›å»ºäº†åº•å±‚çš„ SocketChannel å®ä¾‹ï¼Œæˆ‘ä»¬ç»§ç»­å¾€ä¸‹çœ‹æ„é€ æ–¹æ³•ï¼š\npublic NioSocketChannel(Channel parent, SocketChannel socket) &#123;\n    super(parent, socket);\n    config = new NioSocketChannelConfig(this, socket.socket());\n&#125;\n\nä¸Šé¢æœ‰ä¸¤è¡Œä»£ç ï¼Œç¬¬äºŒè¡Œä»£ç å¾ˆç®€å•ï¼Œå®ä¾‹åŒ–äº†å†…éƒ¨çš„ NioSocketChannelConfig å®ä¾‹ï¼Œå®ƒç”¨äºä¿å­˜ channel çš„é…ç½®ä¿¡æ¯ï¼Œè¿™é‡Œæ²¡æœ‰æˆ‘ä»¬ç°åœ¨éœ€è¦å…³å¿ƒçš„å†…å®¹ï¼Œç›´æ¥è·³è¿‡ã€‚\nç¬¬ä¸€è¡Œè°ƒç”¨çˆ¶ç±»æ„é€ å™¨ï¼Œé™¤äº†è®¾ç½®å±æ€§å¤–ï¼Œè¿˜è®¾ç½®äº† SocketChannel çš„éé˜»å¡æ¨¡å¼ï¼š\nprotected AbstractNioByteChannel(Channel parent, SelectableChannel ch) &#123;\n    // æ¯«æ— ç–‘é—®ï¼Œå®¢æˆ·ç«¯å…³å¿ƒçš„æ˜¯ OP_READ äº‹ä»¶ï¼Œç­‰å¾…è¯»å–æœåŠ¡ç«¯è¿”å›æ•°æ®\n    super(parent, ch, SelectionKey.OP_READ);\n&#125;\n\n// ç„¶åæ˜¯åˆ°è¿™é‡Œ\nprotected AbstractNioChannel(Channel parent, SelectableChannel ch, int readInterestOp) &#123;\n    super(parent);\n    this.ch = ch;\n    // æˆ‘ä»¬çœ‹åˆ°è¿™é‡Œåªæ˜¯ä¿å­˜äº† SelectionKey.OP_READ è¿™ä¸ªä¿¡æ¯ï¼Œåœ¨åé¢çš„æ—¶å€™ä¼šç”¨åˆ°\n    this.readInterestOp = readInterestOp;\n    try &#123;\n        // ******è®¾ç½® channel çš„éé˜»å¡æ¨¡å¼******\n        ch.configureBlocking(false);\n    &#125; catch (IOException e) &#123;\n        ......\n    &#125;\n&#125;\n\nNioServerSocketChannel çš„æ„é€ æ–¹æ³•ç±»ä¼¼ï¼Œä¹Ÿè®¾ç½®äº†éé˜»å¡ï¼Œç„¶åè®¾ç½®æœåŠ¡ç«¯å…³å¿ƒçš„ SelectionKey.OP_ACCEPT äº‹ä»¶ï¼š\npublic NioServerSocketChannel(ServerSocketChannel channel) &#123;\n    // å¯¹äºæœåŠ¡ç«¯æ¥è¯´ï¼Œå…³å¿ƒçš„æ˜¯ SelectionKey.OP_ACCEPT äº‹ä»¶ï¼Œç­‰å¾…å®¢æˆ·ç«¯è¿æ¥\n    super(null, channel, SelectionKey.OP_ACCEPT);\n    config = new NioServerSocketChannelConfig(this, javaChannel().socket());\n&#125;\n\nè¿™èŠ‚å…³äº Channel çš„å†…å®¹æˆ‘ä»¬å…ˆä»‹ç»è¿™ä¹ˆå¤šï¼Œä¸»è¦å°±æ˜¯å®ä¾‹åŒ–äº† JDK å±‚çš„ SocketChannel æˆ– ServerSocketChannelï¼Œç„¶åè®¾ç½®äº†éé˜»å¡æ¨¡å¼ï¼Œæˆ‘ä»¬åé¢å†ç»§ç»­æ·±å…¥ä¸‹å»ã€‚\n\nChannel çš„ register æ“ä½œç»è¿‡å‰é¢çš„é“ºå«ï¼Œæˆ‘ä»¬å·²ç»å…·å¤‡ä¸€å®šçš„åŸºç¡€äº†ï¼Œæˆ‘ä»¬å¼€å§‹æ¥æŠŠå‰é¢å­¦åˆ°çš„å†…å®¹æ‰åœ¨ä¸€èµ·ã€‚è¿™èŠ‚ï¼Œæˆ‘ä»¬ä¼šä»‹ç» register æ“ä½œï¼Œè¿™ä¸€æ­¥å…¶å®æ˜¯éå¸¸å…³é”®çš„ï¼Œå¯¹äºæˆ‘ä»¬æºç åˆ†æéå¸¸é‡è¦ã€‚\næˆ‘ä»¬ä» EchoClient ä¸­çš„ connect() æ–¹æ³•å‡ºå‘ï¼Œæˆ–è€… EchoServer çš„ bind(port) æ–¹æ³•å‡ºå‘ï¼Œéƒ½ä¼šèµ°åˆ° initAndRegister() è¿™ä¸ªæ–¹æ³•ï¼š\nfinal ChannelFuture initAndRegister() &#123;\n    Channel channel = null;\n    try &#123;\n        // 1\n        channel = channelFactory.newChannel();\n        // 2 å¯¹äº Bootstrap å’Œ ServerBootstrapï¼Œè¿™é‡Œé¢æœ‰äº›ä¸ä¸€æ ·\n        init(channel);\n    &#125; catch (Throwable t) &#123;\n        ...\n    &#125;\n    // 3 æˆ‘ä»¬è¿™é‡Œè¦è¯´çš„æ˜¯è¿™è¡Œ\n    ChannelFuture regFuture = config().group().register(channel);\n    if (regFuture.cause() != null) &#123;\n        if (channel.isRegistered()) &#123;\n            channel.close();\n        &#125; else &#123;\n            channel.unsafe().closeForcibly();\n        &#125;\n    &#125;\n    return regFuture;\n&#125;\n\ninitAndRegister() è¿™ä¸ªæ–¹æ³•æˆ‘ä»¬å·²ç»æ¥è§¦è¿‡ä¸¤æ¬¡äº†ï¼Œå‰é¢ä»‹ç»äº†:\n\nChannel çš„å®ä¾‹åŒ–ï¼Œå®ä¾‹åŒ–è¿‡ç¨‹ä¸­ï¼Œä¼šæ‰§è¡Œ Channel å†…éƒ¨ Unsafe å’Œ Pipeline çš„å®ä¾‹åŒ–ï¼›\ninit(channel) æ–¹æ³•ä¸­ï¼Œä¼šå¾€ pipeline ä¸­æ·»åŠ  handlerï¼ˆpipeline æ­¤æ—¶æ˜¯ head+channelnitializer+tailï¼‰ã€‚\n\n\n\n\n\n\n\n\n\n\næˆ‘ä»¬ç»ˆäºè¦æ­ç§˜ ChannelInitializer ä¸­çš„ initChannel æ–¹æ³•äº†~~~\nç°åœ¨ï¼Œæˆ‘ä»¬ç»§ç»­å¾€ä¸‹èµ°ï¼Œçœ‹çœ‹ç¬¬ 3 æ­¥ **register** ï¼š\nChannelFuture regFuture = config().group().register(channel);\n\n\n\n\n\n\n\n\n\n\næˆ‘ä»¬è¯´äº†ï¼Œregister è¿™ä¸€æ­¥æ˜¯éå¸¸å…³é”®çš„ï¼Œå®ƒå‘ç”Ÿåœ¨ channel å®ä¾‹åŒ–ä»¥åï¼Œå¤§å®¶å›å¿†ä¸€ä¸‹å½“å‰ channel ä¸­çš„ä¸€äº›æƒ…å†µï¼š\nå®ä¾‹åŒ–äº† JDK åº•å±‚çš„ Channelï¼Œè®¾ç½®äº†éé˜»å¡ï¼Œå®ä¾‹åŒ–äº† Unsafeï¼Œå®ä¾‹åŒ–äº† Pipelineï¼ŒåŒæ—¶å¾€ pipeline ä¸­æ·»åŠ äº† headã€tail ä»¥åŠä¸€ä¸ª ChannelInitializer å®ä¾‹ã€‚\nä¸Šé¢çš„ config().group() æ–¹æ³•ä¼šè¿”å›å‰é¢å®ä¾‹åŒ–çš„ NioEventLoopGroup çš„å®ä¾‹ï¼Œç„¶åè°ƒç”¨å…¶ register(channel) æ–¹æ³•ï¼š\nio.netty.channel.MultithreadEventLoopGroup\n@Override\npublic ChannelFuture register(Channel channel) &#123;\n    return next().register(channel);\n&#125;\n\nnext() æ–¹æ³•å¾ˆç®€å•ï¼Œå°±æ˜¯é€‰æ‹©çº¿ç¨‹æ± ä¸­çš„ä¸€ä¸ªçº¿ç¨‹ï¼ˆè¿˜è®°å¾— chooserFactory å—?ï¼‰ï¼Œä¹Ÿå°±æ˜¯é€‰æ‹©ä¸€ä¸ª NioEventLoop å®ä¾‹ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±è¿›å…¥åˆ° NioEventLoop äº†ã€‚\nNioEventLoop çš„ register(channel) æ–¹æ³•å®ç°åœ¨å®ƒçš„çˆ¶ç±» **SingleThreadEventLoop** ä¸­ï¼š\n@Override\npublic ChannelFuture register(Channel channel) &#123;\n    return register(new DefaultChannelPromise(channel, this));\n&#125;\n\nä¸Šé¢çš„ä»£ç å®ä¾‹åŒ–äº†ä¸€ä¸ª Promiseï¼Œå°†å½“å‰ channel å¸¦äº†è¿›å»ï¼š\n@Override\npublic ChannelFuture register(final ChannelPromise promise) &#123;\n    ObjectUtil.checkNotNull(promise, \"promise\");\n    // promise å…³è”äº† channelï¼Œchannel æŒæœ‰ Unsafe å®ä¾‹ï¼Œregister æ“ä½œå°±å°è£…åœ¨ Unsafe ä¸­\n    promise.channel().unsafe().register(this, promise);\n    return promise;\n&#125;\n\n\næ‹¿åˆ° channel ä¸­å…³è”çš„ Unsafe å®ä¾‹ï¼Œç„¶åè°ƒç”¨å®ƒçš„ register æ–¹æ³•ï¼š\n\n\n\n\n\n\n\n\n\næˆ‘ä»¬è¯´è¿‡ï¼ŒUnsafe ä¸“é—¨ç”¨æ¥å°è£…åº•å±‚å®ç°ï¼Œå½“ç„¶è¿™é‡Œä¹Ÿæ²¡é‚£ä¹ˆâ€œåº•å±‚â€\nio.netty.channel.AbstractChannel#AbstractUnsafe\n@Override\npublic final void register(EventLoop eventLoop, final ChannelPromise promise) &#123;\n    ...\n    // å°†è¿™ä¸ª eventLoop å®ä¾‹è®¾ç½®ç»™è¿™ä¸ª channelï¼Œä»æ­¤è¿™ä¸ª channel å°±æ˜¯æœ‰ eventLoop çš„äº†\n    // æˆ‘è§‰å¾—è¿™ä¸€æ­¥å…¶å®æŒºå…³é”®çš„ï¼Œå› ä¸ºåç»­è¯¥ channel ä¸­çš„æ‰€æœ‰å¼‚æ­¥æ“ä½œï¼Œéƒ½è¦æäº¤ç»™è¿™ä¸ª eventLoop æ¥æ‰§è¡Œ\n    AbstractChannel.this.eventLoop = eventLoop;\n\n    // å¦‚æœå‘èµ· register åŠ¨ä½œçš„çº¿ç¨‹å°±æ˜¯ eventLoop å®ä¾‹ä¸­çš„çº¿ç¨‹ï¼Œé‚£ä¹ˆç›´æ¥è°ƒç”¨ register0(promise)\n    // å¯¹äºæˆ‘ä»¬æ¥è¯´ï¼Œå®ƒä¸ä¼šè¿›å…¥åˆ°è¿™ä¸ªåˆ†æ”¯ï¼Œ\n    //     ä¹‹æ‰€ä»¥æœ‰è¿™ä¸ªåˆ†æ”¯ï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬æ˜¯å¯ä»¥ unregisterï¼Œç„¶åå† register çš„ï¼Œåé¢å†ä»”ç»†çœ‹\n    if (eventLoop.inEventLoop()) &#123;\n        register0(promise);\n    &#125; else &#123;\n        try &#123;\n            // å¦åˆ™ï¼Œæäº¤ä»»åŠ¡ç»™ eventLoopï¼ŒeventLoop ä¸­çš„çº¿ç¨‹ä¼šè´Ÿè´£è°ƒç”¨ register0(promise)\n            eventLoop.execute(new Runnable() &#123;\n                @Override\n                public void run() &#123;\n                    register0(promise);\n                &#125;\n            &#125;);\n        &#125; catch (Throwable t) &#123;\n            ...\n        &#125;\n    &#125;\n&#125;\n\n\n\n\n\n\n\n\n\n\n\nåˆ°è¿™é‡Œï¼Œæˆ‘ä»¬è¦æ˜ç™½ï¼ŒNioEventLoop ä¸­æ˜¯è¿˜æ²¡æœ‰å®ä¾‹åŒ– Thread å®ä¾‹çš„ã€‚\nè¿™å‡ æ­¥æ¶‰åŠåˆ°äº†å¥½å‡ ä¸ªç±»ï¼šNioEventLoopã€Promiseã€Channelã€Unsafe ç­‰ï¼Œå¤§å®¶è¦ä»”ç»†ç†æ¸…æ¥šå®ƒä»¬çš„å…³ç³»ã€‚\nå¯¹äºæˆ‘ä»¬å‰é¢è¿‡æ¥çš„ register æ“ä½œï¼Œå…¶å®æäº¤åˆ° eventLoop ä»¥åï¼Œå°±ç›´æ¥è¿”å› promise å®ä¾‹äº†ï¼Œå‰©ä¸‹çš„ register0 æ˜¯å¼‚æ­¥æ“ä½œï¼Œå®ƒç”± NioEventLoop å®ä¾‹æ¥å®Œæˆã€‚\n\n\n\n\n\n\n\n\n\nChannel å®ä¾‹ä¸€æ—¦ register åˆ°äº† NioEventLoopGroup å®ä¾‹ä¸­çš„æŸä¸ª NioEventLoop å®ä¾‹ï¼Œé‚£ä¹ˆåç»­è¯¥ Channel çš„æ‰€æœ‰æ“ä½œï¼Œéƒ½æ˜¯ç”±è¯¥ NioEventLoop å®ä¾‹æ¥å®Œæˆçš„ã€‚\nè¿™ä¸ªä¹Ÿéå¸¸ç®€å•ï¼Œå› ä¸º Selector å®ä¾‹æ˜¯åœ¨ NioEventLoop å®ä¾‹ä¸­çš„ï¼ŒChannel å®ä¾‹ä¸€æ—¦æ³¨å†Œåˆ°æŸä¸ª Selector å®ä¾‹ä¸­ï¼Œå½“ç„¶ä¹Ÿåªèƒ½åœ¨è¿™ä¸ªå®ä¾‹ä¸­å¤„ç† NIO äº‹ä»¶ã€‚\næˆ‘ä»¬æ¥çœ‹ register0(promise) æ–¹æ³•ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œè¿™ä¸ª register ä»»åŠ¡è¿›å…¥åˆ°äº† NioEventLoop çš„ taskQueue ä¸­ï¼Œç„¶åä¼šå¯åŠ¨ NioEventLoop ä¸­çš„çº¿ç¨‹ï¼Œè¯¥çº¿ç¨‹ä¼šè½®è¯¢è¿™ä¸ª taskQueueï¼Œç„¶åæ‰§è¡Œè¿™ä¸ª register ä»»åŠ¡ã€‚\næ³¨æ„ï¼Œæ­¤æ—¶æ‰§è¡Œè¯¥æ–¹æ³•çš„æ˜¯ eventLoop ä¸­çš„çº¿ç¨‹ï¼š\nio.netty.channel.AbstractChannel#register0\nprivate void register0(ChannelPromise promise) &#123;\n    try &#123;\n        ...\n        boolean firstRegistration = neverRegistered;\n        // *** è¿›è¡Œ JDK åº•å±‚çš„æ“ä½œï¼šChannel æ³¨å†Œåˆ° Selector ä¸Š ***\n        doRegister();\n\n        neverRegistered = false;\n        registered = true;\n        // åˆ°è¿™é‡Œï¼Œå°±ç®—æ˜¯ registered äº†\n\n        // è¿™ä¸€æ­¥ä¹Ÿå¾ˆå…³é”®ï¼Œå› ä¸ºè¿™æ¶‰åŠåˆ°äº† ChannelInitializer çš„ init(channel)\n        // æˆ‘ä»¬ä¹‹å‰è¯´è¿‡ï¼Œinit æ–¹æ³•ä¼šå°† ChannelInitializer å†…éƒ¨æ·»åŠ çš„ handlers æ·»åŠ åˆ° pipeline ä¸­\n        pipeline.invokeHandlerAddedIfNeeded();\n\n        // è®¾ç½®å½“å‰ promise çš„çŠ¶æ€ä¸º success\n        //   å› ä¸ºå½“å‰ register æ–¹æ³•æ˜¯åœ¨ eventLoop ä¸­çš„çº¿ç¨‹ä¸­æ‰§è¡Œçš„ï¼Œéœ€è¦é€šçŸ¥æäº¤ register æ“ä½œçš„çº¿ç¨‹\n        safeSetSuccess(promise);\n\n        // å½“å‰çš„ register æ“ä½œå·²ç»æˆåŠŸï¼Œè¯¥äº‹ä»¶åº”è¯¥è¢« pipeline ä¸Š\n        //   æ‰€æœ‰å…³å¿ƒ register äº‹ä»¶çš„ handler æ„ŸçŸ¥åˆ°ï¼Œå¾€ pipeline ä¸­æ‰”ä¸€ä¸ªäº‹ä»¶\n        pipeline.fireChannelRegistered();\n\n        // è¿™é‡Œ active æŒ‡çš„æ˜¯ channel å·²ç»æ‰“å¼€\n        if (isActive()) &#123;\n            // å¦‚æœè¯¥ channel æ˜¯ç¬¬ä¸€æ¬¡æ‰§è¡Œ registerï¼Œé‚£ä¹ˆ fire ChannelActive äº‹ä»¶\n            if (firstRegistration) &#123;\n                pipeline.fireChannelActive();\n            &#125; else if (config().isAutoRead()) &#123;\n                // è¯¥ channel ä¹‹å‰å·²ç» register è¿‡äº†ï¼Œ\n                // è¿™é‡Œè®©è¯¥ channel ç«‹é©¬å»ç›‘å¬é€šé“ä¸­çš„ OP_READ äº‹ä»¶\n                beginRead();\n            &#125;\n        &#125;\n    &#125; catch (Throwable t) &#123;\n        ...\n    &#125;\n&#125;\n\n\næˆ‘ä»¬å…ˆè¯´æ‰ä¸Šé¢çš„ doRegister() æ–¹æ³•ï¼Œç„¶åå†è¯´ pipelineã€‚\n@Override\nprotected void doRegister() throws Exception &#123;\n    boolean selected = false;\n    for (;;) &#123;\n        try &#123;\n            // é™„ JDK ä¸­ Channel çš„ register æ–¹æ³•ï¼š\n            // public final SelectionKey register(Selector sel, int ops, Object att) &#123;...&#125;\n            selectionKey = javaChannel().register(eventLoop().unwrappedSelector(), 0, this);\n            return;\n        &#125; catch (CancelledKeyException e) &#123;\n            ...\n        &#125;\n    &#125;\n&#125;\n\n\næˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œåšäº† JDK åº•å±‚çš„ register æ“ä½œï¼Œå°† SocketChannel(æˆ– ServerSocketChannel) æ³¨å†Œåˆ° Selector ä¸­ï¼Œå¹¶ä¸”å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œçš„ç›‘å¬é›†åˆè®¾ç½®ä¸ºäº† 0ï¼Œä¹Ÿå°±æ˜¯ä»€ä¹ˆéƒ½ä¸ç›‘å¬ã€‚\n\n\n\n\n\n\n\n\n\nå½“ç„¶ï¼Œä¹Ÿå°±æ„å‘³ç€ï¼Œåç»­ä¸€å®šæœ‰æŸä¸ªåœ°æ–¹ä¼šéœ€è¦ä¿®æ”¹è¿™ä¸ª selectionKey çš„ç›‘å¬é›†åˆï¼Œä¸ç„¶å•¥éƒ½å¹²ä¸äº†\næˆ‘ä»¬é‡ç‚¹æ¥è¯´è¯´ **pipeline** æ“ä½œï¼Œæˆ‘ä»¬ä¹‹å‰åœ¨ä»‹ç» NioSocketChannel çš„ pipeline çš„æ—¶å€™ä»‹ç»åˆ°ï¼Œæˆ‘ä»¬çš„ pipeline ç°åœ¨é•¿è¿™ä¸ªæ ·å­ï¼š\n\n\n\n\n\n\n\n\n\n\nç°åœ¨ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°è¿™é‡Œä¼šæŠŠ LoggingHandler å’Œ EchoClientHandler æ·»åŠ åˆ° pipelineã€‚\næˆ‘ä»¬ç»§ç»­çœ‹ä»£ç ï¼Œregister æˆåŠŸä»¥åï¼Œæ‰§è¡Œäº†ä»¥ä¸‹æ“ä½œï¼š\npipeline.invokeHandlerAddedIfNeeded();\n\n\nå¤§å®¶å¯ä»¥è·Ÿè¸ªä¸€ä¸‹ï¼Œè¿™ä¸€æ­¥ä¼šæ‰§è¡Œåˆ° pipeline ä¸­ ChannelInitializer å®ä¾‹çš„ handlerAdded æ–¹æ³•ï¼Œåœ¨è¿™é‡Œä¼šæ‰§è¡Œå®ƒçš„ init(context) æ–¹æ³•ï¼š\n@Override\npublic void handlerAdded(ChannelHandlerContext ctx) throws Exception &#123;\n    if (ctx.channel().isRegistered()) &#123;\n        initChannel(ctx);\n    &#125;\n&#125;\n\n\nç„¶åæˆ‘ä»¬çœ‹ä¸‹ initChannel(ctx)ï¼Œè¿™é‡Œç»ˆäºæ¥äº†æˆ‘ä»¬ä¹‹å‰ä»‹ç»è¿‡çš„ init(channel) æ–¹æ³•ï¼š\nprivate boolean initChannel(ChannelHandlerContext ctx) throws Exception &#123;\n    if (initMap.putIfAbsent(ctx, Boolean.TRUE) == null) &#123; // Guard against re-entrance.\n        try &#123;\n            // 1. å°†æŠŠæˆ‘ä»¬è‡ªå®šä¹‰çš„ handlers æ·»åŠ åˆ° pipeline ä¸­\n            initChannel((C) ctx.channel());\n        &#125; catch (Throwable cause) &#123;\n            ...\n        &#125; finally &#123;\n            // 2. å°† ChannelInitializer å®ä¾‹ä» pipeline ä¸­åˆ é™¤\n            remove(ctx);\n        &#125;\n        return true;\n    &#125;\n    return false;\n&#125;\n\n\næˆ‘ä»¬å‰é¢ä¹Ÿè¯´è¿‡ï¼ŒChannelInitializer çš„ init(channel) è¢«æ‰§è¡Œä»¥åï¼Œé‚£ä¹ˆå…¶å†…éƒ¨æ·»åŠ çš„ handlers ä¼šè¿›å…¥åˆ° pipeline ä¸­ï¼Œç„¶åä¸Šé¢çš„ finally å—ä¸­å°† ChannelInitializer çš„å®ä¾‹ä» pipeline ä¸­åˆ é™¤ï¼Œé‚£ä¹ˆæ­¤æ—¶ pipeline å°±ç®—å»ºç«‹èµ·æ¥äº†ï¼Œå¦‚ä¸‹å›¾ï¼š\n\n\n\n\n\n\n\n\n\n\nå…¶å®è¿™é‡Œè¿˜æœ‰ä¸ªé—®é¢˜ï¼Œå¦‚æœæˆ‘ä»¬åœ¨ ChannelInitializer ä¸­æ·»åŠ çš„æ˜¯ä¸€ä¸ª ChannelInitializer å®ä¾‹å‘¢ï¼Ÿå¤§å®¶å¯ä»¥è€ƒè™‘ä¸‹è¿™ä¸ªæƒ…å†µã€‚\npipeline å»ºç«‹äº†ä»¥åï¼Œç„¶åæˆ‘ä»¬ç»§ç»­å¾€ä¸‹èµ°ï¼Œä¼šæ‰§è¡Œåˆ°è¿™ä¸€å¥ï¼š\npipeline.fireChannelRegistered();\n\n\næˆ‘ä»¬åªè¦æ‘¸æ¸…æ¥šäº† fireChannelRegistered() æ–¹æ³•ï¼Œä»¥åç¢°åˆ°å…¶ä»–åƒ fireChannelActive()ã€fireXxx() ç­‰å°±çŸ¥é“æ€ä¹ˆå›äº‹äº†ï¼Œå®ƒä»¬éƒ½æ˜¯ç±»ä¼¼çš„ã€‚æˆ‘ä»¬æ¥çœ‹çœ‹è¿™å¥ä»£ç ä¼šå‘ç”Ÿä»€ä¹ˆï¼š\nio.netty.channel.DefaultChannelPipeline#fireChannelRegistered\n@Override\npublic final ChannelPipeline fireChannelRegistered() &#123;\n    // æ³¨æ„è¿™é‡Œçš„ä¼ å‚æ˜¯ head\n    AbstractChannelHandlerContext.invokeChannelRegistered(head);\n    return this;\n&#125;\n\n\nä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å¾€ pipeline ä¸­æ‰”äº†ä¸€ä¸ª **channelRegistered** äº‹ä»¶ï¼Œè¿™é‡Œçš„ register å±äº Inbound äº‹ä»¶ï¼Œpipeline æ¥ä¸‹æ¥è¦åšçš„å°±æ˜¯æ‰§è¡Œ pipeline ä¸­çš„ Inbound ç±»å‹çš„ handlers ä¸­çš„ channelRegistered() æ–¹æ³•ã€‚\nä»ä¸Šé¢çš„ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œå¾€ pipeline ä¸­æ‰”å‡º channelRegistered äº‹ä»¶ä»¥åï¼Œç¬¬ä¸€ä¸ªå¤„ç†çš„ handler æ˜¯ **head**ã€‚\næ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¿˜æ˜¯è·Ÿç€ä»£ç èµ°ï¼Œæ­¤æ—¶æˆ‘ä»¬æ¥åˆ°äº† pipeline çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ **head** çš„å¤„ç†ä¸­ï¼š\nio.netty.channel.AbstractChannelHandlerContext#invokeChannelRegistered\n// next æ­¤æ—¶æ˜¯ head\nstatic void invokeChannelRegistered(final AbstractChannelHandlerContext next) &#123;\n\n    EventExecutor executor = next.executor();\n    // æ‰§è¡Œ head çš„ invokeChannelRegistered()\n    if (executor.inEventLoop()) &#123;\n        next.invokeChannelRegistered();\n    &#125; else &#123;\n        executor.execute(new Runnable() &#123;\n            @Override\n            public void run() &#123;\n                next.invokeChannelRegistered();\n            &#125;\n        &#125;);\n    &#125;\n&#125;\n\n\nä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™é‡Œä¼šå…ˆæ‰§è¡Œ head.invokeChannelRegistered() æ–¹æ³•ï¼Œè€Œä¸”æ˜¯æ”¾åˆ° NioEventLoop ä¸­çš„ taskQueue ä¸­æ‰§è¡Œçš„ï¼š\nio.netty.channel.AbstractChannelHandlerContext#invokeChannelRegistered\nprivate void invokeChannelRegistered() &#123;\n    if (invokeHandler()) &#123;\n        try &#123;\n            // handler() æ–¹æ³•æ­¤æ—¶ä¼šè¿”å› head\n            ((ChannelInboundHandler) handler()).channelRegistered(this);\n        &#125; catch (Throwable t) &#123;\n            notifyHandlerException(t);\n        &#125;\n    &#125; else &#123;\n        fireChannelRegistered();\n    &#125;\n&#125;\n\n\næˆ‘ä»¬å»çœ‹ head çš„ channelRegistered æ–¹æ³•ã€‚\nHeadContext æ˜¯ DefaultChannelPipeline çš„å†…éƒ¨ç±»ï¼š\n\nio.netty.channel.DefaultChannelPipeline.HeadContext#channelRegistered\n@Override\npublic void channelRegistered(ChannelHandlerContext ctx) throws Exception &#123;\n    // 1. è¿™ä¸€æ­¥æ˜¯ head å¯¹äº channelRegistered äº‹ä»¶çš„å¤„ç†ã€‚æ²¡æœ‰æˆ‘ä»¬è¦å…³å¿ƒçš„\n    invokeHandlerAddedIfNeeded();\n    // 2. å‘åä¼ æ’­ Inbound äº‹ä»¶\n    ctx.fireChannelRegistered();\n&#125;\n\n\nç„¶å head ä¼šæ‰§è¡Œ fireChannelRegister() æ–¹æ³•ï¼š\nio.netty.channel.AbstractChannelHandlerContext#fireChannelRegistered\n@Override\npublic ChannelHandlerContext fireChannelRegistered() &#123;\n    // è¿™é‡Œå¾ˆå…³é”®\n    // findContextInbound() æ–¹æ³•ä¼šæ²¿ç€ pipeline æ‰¾åˆ°ä¸‹ä¸€ä¸ª Inbound ç±»å‹çš„ handler\n    invokeChannelRegistered(findContextInbound());\n    return this;\n&#125;\n\n\n\n\n\n\n\n\n\n\n\næ³¨æ„ï¼špipeline.fireChannelRegistered() æ˜¯å°† channelRegistered äº‹ä»¶æŠ›åˆ° pipeline ä¸­ï¼Œpipeline ä¸­çš„ handlers å‡†å¤‡å¤„ç†è¯¥äº‹ä»¶ã€‚è€Œ context.fireChannelRegistered() æ˜¯ä¸€ä¸ª handler å¤„ç†å®Œäº†ä»¥åï¼Œå‘åä¼ æ’­ç»™ä¸‹ä¸€ä¸ª handlerã€‚\nå®ƒä»¬ä¸¤ä¸ªçš„æ–¹æ³•åå­—æ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯æ¥è‡ªäºä¸åŒçš„ç±»ã€‚\nfindContextInbound() å°†æ‰¾åˆ°ä¸‹ä¸€ä¸ª Inbound ç±»å‹çš„ handlerï¼Œç„¶ååˆæ˜¯é‡å¤ä¸Šé¢çš„å‡ ä¸ªæ–¹æ³•ã€‚\n\n\n\n\n\n\n\n\n\næˆ‘è§‰å¾—ä¸Šé¢è¿™å—ä»£ç æ²¡å¿…è¦å¤ªçº ç»“ï¼Œæ€»ä¹‹å°±æ˜¯ä» head ä¸­å¼€å§‹ï¼Œä¾æ¬¡å¾€ä¸‹å¯»æ‰¾æ‰€æœ‰ Inbound handlerï¼Œæ‰§è¡Œå…¶ channelRegistered(ctx) æ“ä½œã€‚\nè¯´äº†è¿™ä¹ˆå¤šï¼Œæˆ‘ä»¬çš„ register æ“ä½œç®—æ˜¯çœŸæ­£å®Œæˆäº†ã€‚\nä¸‹é¢ï¼Œæˆ‘ä»¬å›åˆ° initAndRegister è¿™ä¸ªæ–¹æ³•ï¼š\nfinal ChannelFuture initAndRegister() &#123;\n    Channel channel = null;\n    try &#123;\n        channel = channelFactory.newChannel();\n        init(channel);\n    &#125; catch (Throwable t) &#123;\n        ...\n    &#125;\n\n    // æˆ‘ä»¬ä¸Šé¢è¯´å®Œäº†è¿™è¡Œ\n    ChannelFuture regFuture = config().group().register(channel);\n\n    // å¦‚æœåœ¨ register çš„è¿‡ç¨‹ä¸­ï¼Œå‘ç”Ÿäº†é”™è¯¯\n    if (regFuture.cause() != null) &#123;\n        if (channel.isRegistered()) &#123;\n            channel.close();\n        &#125; else &#123;\n            channel.unsafe().closeForcibly();\n        &#125;\n    &#125;\n\n    // æºç ä¸­è¯´å¾—å¾ˆæ¸…æ¥šï¼Œå¦‚æœåˆ°è¿™é‡Œï¼Œè¯´æ˜åç»­å¯ä»¥è¿›è¡Œ connect() æˆ– bind() äº†ï¼Œå› ä¸ºä¸¤ç§æƒ…å†µï¼š\n    // 1. å¦‚æœ register åŠ¨ä½œæ˜¯åœ¨ eventLoop ä¸­å‘èµ·çš„ï¼Œé‚£ä¹ˆåˆ°è¿™é‡Œçš„æ—¶å€™ï¼Œregister ä¸€å®šå·²ç»å®Œæˆ\n    // 2. å¦‚æœ register ä»»åŠ¡å·²ç»æäº¤åˆ° eventLoop ä¸­ï¼Œä¹Ÿå°±æ˜¯è¿›åˆ°äº† eventLoop ä¸­çš„ taskQueue ä¸­ï¼Œ\n    //    ç”±äºåç»­çš„ connect æˆ– bind ä¹Ÿä¼šè¿›å…¥åˆ°åŒä¸€ä¸ª eventLoop çš„ queue ä¸­ï¼Œæ‰€ä»¥ä¸€å®šæ˜¯ä¼šå…ˆ register æˆåŠŸï¼Œæ‰ä¼šæ‰§è¡Œ connect æˆ– bind\n    return regFuture;\n&#125;\n\n\næˆ‘ä»¬è¦çŸ¥é“ï¼Œä¸ç®¡æ˜¯æœåŠ¡ç«¯çš„ NioServerSocketChannel è¿˜æ˜¯å®¢æˆ·ç«¯çš„ NioSocketChannelï¼Œåœ¨ bind æˆ– connect æ—¶ï¼Œéƒ½ä¼šå…ˆè¿›å…¥ initAndRegister è¿™ä¸ªæ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸Šé¢è¯´çš„é‚£äº›ï¼Œå¯¹äºä¸¤è€…éƒ½æ˜¯é€šç”¨çš„ã€‚\nå¤§å®¶è¦è®°ä½ï¼Œregister æ“ä½œæ˜¯éå¸¸é‡è¦çš„ï¼Œè¦çŸ¥é“è¿™ä¸€æ­¥å¤§æ¦‚åšäº†å“ªäº›äº‹æƒ…ï¼Œregister æ“ä½œä»¥åï¼Œå°†è¿›å…¥åˆ° bind æˆ– connect æ“ä½œä¸­ã€‚\n\nconnect è¿‡ç¨‹å’Œ bind è¿‡ç¨‹åˆ†æä¸Šé¢æˆ‘ä»¬ä»‹ç»çš„ register æ“ä½œéå¸¸å…³é”®ï¼Œå®ƒå»ºç«‹èµ·æ¥äº†å¾ˆå¤šçš„ä¸œè¥¿ï¼Œå®ƒæ˜¯ Netty ä¸­ NioSocketChannel å’Œ NioServerSocketChannel å¼€å§‹å·¥ä½œçš„èµ·ç‚¹ã€‚\nè¿™ä¸€èŠ‚ï¼Œæˆ‘ä»¬æ¥è¯´è¯´ register ä¹‹åçš„ connect æ“ä½œå’Œ bind æ“ä½œã€‚è¿™èŠ‚éå¸¸ç®€å•ã€‚\n\nconnect è¿‡ç¨‹åˆ†æå¯¹äºå®¢æˆ·ç«¯ NioSocketChannel æ¥è¯´ï¼Œå‰é¢ register å®Œæˆä»¥åï¼Œå°±è¦å¼€å§‹ connect äº†ï¼Œè¿™ä¸€æ­¥å°†è¿æ¥åˆ°æœåŠ¡ç«¯ã€‚\nprivate ChannelFuture doResolveAndConnect(final SocketAddress remoteAddress, final SocketAddress localAddress) &#123;\n    // è¿™é‡Œå®Œæˆäº† register æ“ä½œ\n    final ChannelFuture regFuture = initAndRegister();\n    final Channel channel = regFuture.channel();\n\n    // è¿™é‡Œæˆ‘ä»¬ä¸å»çº ç»“ register æ“ä½œæ˜¯å¦ isDone()\n    if (regFuture.isDone()) &#123;\n        if (!regFuture.isSuccess()) &#123;\n            return regFuture;\n        &#125;\n        // çœ‹è¿™é‡Œ\n        return doResolveAndConnect0(channel, remoteAddress, localAddress, channel.newPromise());\n    &#125; else &#123;\n        ....\n    &#125;\n&#125;\n\n\nè¿™é‡Œå¤§å®¶è‡ªå·±ä¸€è·¯ç‚¹è¿›å»ï¼Œæˆ‘å°±ä¸æµªè´¹ç¯‡å¹…äº†ã€‚æœ€åï¼Œæˆ‘ä»¬ä¼šæ¥åˆ° AbstractChannel çš„ connect æ–¹æ³•ï¼š\n@Override\npublic ChannelFuture connect(SocketAddress remoteAddress, ChannelPromise promise) &#123;\n    return pipeline.connect(remoteAddress, promise);\n&#125;\n\n\næˆ‘ä»¬çœ‹åˆ°ï¼Œconnect æ“ä½œæ˜¯äº¤ç»™ pipeline æ¥æ‰§è¡Œçš„ã€‚è¿›å…¥ pipeline ä¸­ï¼Œæˆ‘ä»¬ä¼šå‘ç°ï¼Œconnect è¿™ç§ Outbound ç±»å‹çš„æ“ä½œï¼Œæ˜¯ä» pipeline çš„ tail å¼€å§‹çš„ï¼š\n\n\n\n\n\n\n\n\n\nå‰é¢æˆ‘ä»¬ä»‹ç»çš„ register æ“ä½œæ˜¯ Inbound çš„ï¼Œæ˜¯ä» head å¼€å§‹çš„\n@Override\npublic final ChannelFuture connect(SocketAddress remoteAddress, ChannelPromise promise) &#123;\n    return tail.connect(remoteAddress, promise);\n&#125;\n\n\næ¥ä¸‹æ¥å°±æ˜¯ pipeline çš„æ“ä½œäº†ï¼Œä» tail å¼€å§‹ï¼Œæ‰§è¡Œ pipeline ä¸Šçš„ Outbound ç±»å‹çš„ handlers çš„ connect(...) æ–¹æ³•ï¼Œé‚£ä¹ˆçœŸæ­£çš„åº•å±‚çš„ connect çš„æ“ä½œå‘ç”Ÿåœ¨å“ªé‡Œå‘¢ï¼Ÿè¿˜è®°å¾—æˆ‘ä»¬çš„ pipeline çš„å›¾å—ï¼Ÿ\n\nä» tail å¼€å§‹å¾€å‰æ‰¾ out ç±»å‹çš„ handlersï¼Œæ¯ç»è¿‡ä¸€ä¸ª handlerï¼Œéƒ½æ‰§è¡Œé‡Œé¢çš„ connect() æ–¹æ³•ï¼Œæœ€åä¼šåˆ° head ä¸­ï¼Œå› ä¸º head ä¹Ÿæ˜¯ Outbound ç±»å‹çš„ï¼Œæˆ‘ä»¬éœ€è¦çš„ connect æ“ä½œå°±åœ¨ head ä¸­ï¼Œå®ƒä¼šè´Ÿè´£è°ƒç”¨ unsafe ä¸­æä¾›çš„ connect æ–¹æ³•ï¼š\n// HeadContext\npublic void connect(\n        ChannelHandlerContext ctx,\n        SocketAddress remoteAddress, SocketAddress localAddress,\n        ChannelPromise promise) throws Exception &#123;\n    unsafe.connect(remoteAddress, localAddress, promise);\n&#125;\n\n\næ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€çœ‹ connect åœ¨ unsafe ç±»ä¸­æ‰€è°“çš„åº•å±‚æ“ä½œï¼š\n// AbstractNioChannel.AbstractNioUnsafe\n@Override\npublic final void connect(\n        final SocketAddress remoteAddress, final SocketAddress localAddress, final ChannelPromise promise) &#123;\n        ......\n\n        boolean wasActive = isActive();\n        // å¤§å®¶è‡ªå·±ç‚¹è¿›å»çœ‹ doConnect æ–¹æ³•\n        // è¿™ä¸€æ­¥ä¼šåš JDK åº•å±‚çš„ SocketChannel connectï¼Œç„¶åè®¾ç½® interestOps ä¸º SelectionKey.OP_CONNECT\n        // è¿”å›å€¼ä»£è¡¨æ˜¯å¦å·²ç»è¿æ¥æˆåŠŸ\n        if (doConnect(remoteAddress, localAddress)) &#123;\n            // å¤„ç†è¿æ¥æˆåŠŸçš„æƒ…å†µ\n            fulfillConnectPromise(promise, wasActive);\n        &#125; else &#123;\n            connectPromise = promise;\n            requestedRemoteAddress = remoteAddress;\n\n            // ä¸‹é¢è¿™å—ä»£ç ï¼Œåœ¨å¤„ç†è¿æ¥è¶…æ—¶çš„æƒ…å†µï¼Œä»£ç å¾ˆç®€å•\n            // è¿™é‡Œç”¨åˆ°äº† NioEventLoop çš„å®šæ—¶ä»»åŠ¡çš„åŠŸèƒ½ï¼Œè¿™ä¸ªæˆ‘ä»¬ä¹‹å‰ä¸€ç›´éƒ½æ²¡æœ‰ä»‹ç»è¿‡ï¼Œå› ä¸ºæˆ‘è§‰å¾—ä¹Ÿä¸å¤ªé‡è¦\n            int connectTimeoutMillis = config().getConnectTimeoutMillis();\n            if (connectTimeoutMillis > 0) &#123;\n                connectTimeoutFuture = eventLoop().schedule(new Runnable() &#123;\n                    @Override\n                    public void run() &#123;\n                        ChannelPromise connectPromise = AbstractNioChannel.this.connectPromise;\n                        ConnectTimeoutException cause =\n                                new ConnectTimeoutException(\"connection timed out: \" + remoteAddress);\n                        if (connectPromise != null &amp;&amp; connectPromise.tryFailure(cause)) &#123;\n                            close(voidPromise());\n                        &#125;\n                    &#125;\n                &#125;, connectTimeoutMillis, TimeUnit.MILLISECONDS);\n            &#125;\n\n            promise.addListener(new ChannelFutureListener() &#123;\n                @Override\n                public void operationComplete(ChannelFuture future) throws Exception &#123;\n                    if (future.isCancelled()) &#123;\n                        if (connectTimeoutFuture != null) &#123;\n                            connectTimeoutFuture.cancel(false);\n                        &#125;\n                        connectPromise = null;\n                        close(voidPromise());\n                    &#125;\n                &#125;\n            &#125;);\n        &#125;\n    &#125; catch (Throwable t) &#123;\n        promise.tryFailure(annotateConnectException(t, remoteAddress));\n        closeIfClosed();\n    &#125;\n&#125;\n\n\nå¦‚æœä¸Šé¢çš„ doConnect æ–¹æ³•è¿”å› falseï¼Œé‚£ä¹ˆåç»­æ˜¯æ€ä¹ˆå¤„ç†çš„å‘¢ï¼Ÿ\nåœ¨ä¸Šä¸€èŠ‚ä»‹ç»çš„ register æ“ä½œä¸­ï¼Œchannel å·²ç» register åˆ°äº† selector ä¸Šï¼Œåªä¸è¿‡å°† interestOps è®¾ç½®ä¸ºäº† 0ï¼Œä¹Ÿå°±æ˜¯ä»€ä¹ˆéƒ½ä¸ç›‘å¬ã€‚\nè€Œåœ¨ä¸Šé¢çš„ doConnect æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°å®ƒåœ¨è°ƒç”¨åº•å±‚çš„ connect æ–¹æ³•åï¼Œä¼šè®¾ç½® interestOps ä¸º SelectionKey.OP_CONNECTã€‚\nå‰©ä¸‹çš„å°±æ˜¯ NioEventLoop çš„äº‹æƒ…äº†ï¼Œè¿˜è®°å¾— NioEventLoop çš„ run() æ–¹æ³•å—ï¼Ÿä¹Ÿå°±æ˜¯è¯´è¿™é‡Œçš„ connect æˆåŠŸä»¥åï¼Œè¿™ä¸ª TCP è¿æ¥å°±å»ºç«‹èµ·æ¥äº†ï¼Œåç»­çš„æ“ä½œä¼šåœ¨ NioEventLoop.run() æ–¹æ³•ä¸­è¢« processSelectedKeys() æ–¹æ³•å¤„ç†æ‰ã€‚\n\nbind è¿‡ç¨‹åˆ†æè¯´å®Œ connect è¿‡ç¨‹ï¼Œæˆ‘ä»¬å†æ¥ç®€å•çœ‹ä¸‹ bind è¿‡ç¨‹ï¼š\nprivate ChannelFuture doBind(final SocketAddress localAddress) &#123;\n    // **å‰é¢è¯´çš„ initAndRegister**\n    final ChannelFuture regFuture = initAndRegister();\n\n    final Channel channel = regFuture.channel();\n    if (regFuture.cause() != null) &#123;\n        return regFuture;\n    &#125;\n\n    if (regFuture.isDone()) &#123;\n        // register åŠ¨ä½œå·²ç»å®Œæˆï¼Œé‚£ä¹ˆæ‰§è¡Œ bind æ“ä½œ\n        ChannelPromise promise = channel.newPromise();\n        doBind0(regFuture, channel, localAddress, promise);\n        return promise;\n    &#125; else &#123;\n        ......\n    &#125;\n&#125;\n\n\nç„¶åä¸€ç›´å¾€é‡Œçœ‹ï¼Œä¼šçœ‹åˆ°ï¼Œbind æ“ä½œä¹Ÿæ˜¯è¦ç”± pipeline æ¥å®Œæˆçš„ï¼š\nio.netty.channel.AbstractChannel#bind\n@Override\npublic ChannelFuture bind(SocketAddress localAddress, ChannelPromise promise) &#123;\n    return pipeline.bind(localAddress, promise);\n&#125;\n\n\nbind æ“ä½œå’Œ connect ä¸€æ ·ï¼Œéƒ½æ˜¯ Outbound ç±»å‹çš„ï¼Œæ‰€ä»¥éƒ½æ˜¯ tail å¼€å§‹ï¼š\n@Override\npublic final ChannelFuture bind(SocketAddress localAddress, ChannelPromise promise) &#123;\n    return tail.bind(localAddress, promise);\n&#125;\n\n\næœ€åçš„ bind æ“ä½œåˆåˆ°äº† head ä¸­ï¼Œç”± head æ¥è°ƒç”¨ unsafe æä¾›çš„ bind æ–¹æ³•ï¼š\n@Override\npublic void bind(\n        ChannelHandlerContext ctx, SocketAddress localAddress, ChannelPromise promise)\n        throws Exception &#123;\n    unsafe.bind(localAddress, promise);\n&#125;\n\n\næ„Ÿå…´è¶£çš„è¯»è€…è‡ªå·±å»çœ‹ä¸€ä¸‹ unsafe ä¸­çš„ bind æ–¹æ³•ï¼Œéå¸¸ç®€å•ï¼Œbind æ“ä½œä¹Ÿä¸æ˜¯ä»€ä¹ˆå¼‚æ­¥æ–¹æ³•ï¼Œæˆ‘ä»¬å°±ä»‹ç»åˆ°è¿™é‡Œäº†ã€‚\nChannelHandler æ˜¯æ¶ˆæ¯çš„å…·ä½“å¤„ç†å™¨ï¼Œä¸»è¦è´Ÿè´£å¤„ç†å®¢æˆ·ç«¯&#x2F;æœåŠ¡ç«¯æ¥æ”¶å’Œå‘é€çš„æ•°æ®ã€‚ChannelPipeline åˆ™æ˜¯åŒ…å«äº†ä¸€ä¸ªæˆ–å¤šä¸ª ChannelHandler çš„é“¾è¡¨ã€‚\n\n2.æ¶ˆæ¯å¤„ç†å™¨é“¾è¡¨ï¼šChannelPipelineChannelPipelineï¼šæ¶ˆæ¯å¤„ç†å™¨é“¾è¡¨æˆ‘æƒ³å¾ˆå¤šè¯»è€…åº”è¯¥æˆ–å¤šæˆ–å°‘éƒ½æœ‰ Netty ä¸­ pipeline çš„æ¦‚å¿µã€‚å‰é¢æˆ‘ä»¬è¯´äº†ï¼Œä½¿ç”¨ Netty çš„æ—¶å€™ï¼Œæˆ‘ä»¬é€šå¸¸å°±åªè¦å†™ä¸€äº›è‡ªå®šä¹‰çš„ handler å°±å¯ä»¥äº†ï¼Œæˆ‘ä»¬å®šä¹‰çš„è¿™äº› handler ä¼šç»„æˆä¸€ä¸ª pipelineï¼Œç”¨äºå¤„ç† IO äº‹ä»¶ï¼Œè¿™ä¸ªå’Œæˆ‘ä»¬å¹³æ—¶æ¥è§¦çš„ Filter æˆ– Interceptor è¡¨è¾¾çš„å·®ä¸å¤šæ˜¯ä¸€ä¸ªæ„æ€ã€‚\næ¯ä¸ª Channel å†…éƒ¨éƒ½æœ‰ä¸€ä¸ª pipelineï¼Œpipeline ç”±å¤šä¸ª handler ç»„æˆï¼Œhandler ä¹‹é—´çš„é¡ºåºæ˜¯å¾ˆé‡è¦çš„ï¼Œå› ä¸º IO äº‹ä»¶å°†æŒ‰ç…§é¡ºåºé¡ºæ¬¡ç»è¿‡ pipeline ä¸Šçš„ handlerï¼Œè¿™æ ·æ¯ä¸ª handler å¯ä»¥ä¸“æ³¨äºåšä¸€ç‚¹ç‚¹å°äº‹ï¼Œç”±å¤šä¸ª handler ç»„åˆæ¥å®Œæˆä¸€äº›å¤æ‚çš„é€»è¾‘ã€‚\n\nä»å›¾ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“è¿™æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ã€‚\n\nIO äº‹ä»¶ï¼šInbound &amp; Outboundé¦–å…ˆï¼Œæˆ‘ä»¬çœ‹ä¸¤ä¸ªé‡è¦çš„æ¦‚å¿µï¼šInbound å’Œ Outboundã€‚åœ¨ Netty ä¸­ï¼ŒIO äº‹ä»¶è¢«åˆ†ä¸º Inbound äº‹ä»¶å’Œ Outbound äº‹ä»¶ã€‚\nOutbound çš„ out æŒ‡çš„æ˜¯ å‡ºå»ï¼Œæœ‰å“ªäº› IO äº‹ä»¶å±äºæ­¤ç±»å‘¢ï¼Ÿæ¯”å¦‚ connectã€writeã€flush è¿™äº› IO æ“ä½œæ˜¯å¾€å¤–éƒ¨æ–¹å‘è¿›è¡Œçš„ï¼Œå®ƒä»¬å°±å±äº Outbound äº‹ä»¶ã€‚\nå…¶ä»–çš„ï¼Œè¯¸å¦‚ acceptã€read è¿™ç§å°±å±äº Inbound äº‹ä»¶ã€‚\næ¯”å¦‚å®¢æˆ·ç«¯åœ¨å‘èµ·è¯·æ±‚çš„æ—¶å€™ï¼Œéœ€è¦ä¸‹é¢å‡ æ­¥ï¼š\n\nconnect åˆ°æœåŠ¡å™¨;\nwrite æ•°æ®ä¼ åˆ°æœåŠ¡å™¨\nread æœåŠ¡å™¨è¿”å›çš„æ•°æ®\n\nconnect å’Œ write å°±æ˜¯ out äº‹ä»¶ï¼Œåé¢çš„ read å°±æ˜¯ in äº‹ä»¶ã€‚\næ¯”å¦‚å¾ˆå¤šåˆå­¦è€…çœ‹ä¸æ‡‚ä¸‹é¢çš„è¿™æ®µä»£ç ï¼Œè¿™æ®µä»£ç ç”¨äºæœåŠ¡ç«¯çš„ childHandler ä¸­ï¼š\n1. pipeline.addLast(new StringDecoder());\n2. pipeline.addLast(new StringEncoder());\n3. pipeline.addLast(new BizHandler());\n\nåˆå­¦è€…è‚¯å®šéƒ½çº³é—·ï¼Œä»¥ä¸ºè¿™ä¸ªé¡ºåºå†™é”™äº†ï¼Œåº”è¯¥æ˜¯å…ˆ decode å®¢æˆ·ç«¯è¿‡æ¥çš„æ•°æ®ï¼Œç„¶åç”¨ BizHandler å¤„ç†ä¸šåŠ¡é€»è¾‘ï¼Œæœ€åå† encode æ•°æ®ç„¶åè¿”å›ç»™å®¢æˆ·ç«¯ï¼Œæ‰€ä»¥æ·»åŠ çš„é¡ºåºåº”è¯¥æ˜¯ 1 -&gt; 3 -&gt; 2 æ‰å¯¹ã€‚\nå…¶å®è¿™é‡Œçš„ä¸‰ä¸ª handler æ˜¯åˆ†ç»„çš„ï¼Œåˆ†ä¸º Inboundï¼ˆ1 å’Œ 3ï¼‰ å’Œ Outboundï¼ˆ2ï¼‰ï¼š\n1. pipeline.addLast(new StringDecoder());\n2. pipeline.addLast(new StringEncoder());\n3. pipeline.addLast(new BizHandler());\n\n\nå®¢æˆ·ç«¯è¿æ¥è¿›æ¥çš„æ—¶å€™ï¼Œè¯»å–ï¼ˆreadï¼‰å®¢æˆ·ç«¯è¯·æ±‚æ•°æ®çš„æ“ä½œæ˜¯ Inbound çš„ï¼Œæ‰€ä»¥ä¼šå…ˆä½¿ç”¨ 1ï¼Œç„¶åæ˜¯ 3 å¯¹å¤„ç†è¿›è¡Œå¤„ç†ï¼›\nå¤„ç†å®Œæ•°æ®åï¼Œè¿”å›ç»™å®¢æˆ·ç«¯æ•°æ®çš„ write æ“ä½œæ˜¯ Outbound çš„ï¼Œæ­¤æ—¶ä½¿ç”¨çš„æ˜¯ 2ã€‚\n\næ‰€ä»¥è™½ç„¶æ·»åŠ é¡ºåºæœ‰ç‚¹æ€ªï¼Œä½†æ˜¯æ‰§è¡Œé¡ºåºå…¶å®æ˜¯æŒ‰ç…§ 1 -&gt; 3 -&gt; 2 è¿›è¡Œçš„ã€‚\n\n\n\n\n\n\n\n\n\nå¦‚æœæˆ‘ä»¬åœ¨ä¸Šé¢çš„åŸºç¡€ä¸Šï¼ŒåŠ ä¸Šä¸‹é¢çš„ç¬¬å››è¡Œï¼Œè¿™æ˜¯ä¸€ä¸ª OutboundHandlerï¼š\né‚£ä¹ˆæ‰§è¡Œé¡ºåºæ˜¯ä¸æ˜¯å°±æ˜¯ 1 -&gt; 3 -&gt; 2 -&gt; 4 å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ï¼šä¸æ˜¯çš„ã€‚\n**å¯¹äº Inbound æ“ä½œï¼ŒæŒ‰ç…§æ·»åŠ é¡ºåºæ‰§è¡Œæ¯ä¸ª Inbound ç±»å‹çš„ ****handler****ï¼›è€Œå¯¹äº Outbound æ“ä½œï¼Œæ˜¯åç€æ¥çš„ï¼Œä»åå¾€å‰ï¼Œé¡ºæ¬¡æ‰§è¡Œ Outbound ç±»å‹çš„ ****handler**ã€‚\næ‰€ä»¥ï¼Œä¸Šé¢çš„é¡ºåºåº”è¯¥æ˜¯å…ˆ 1 å 3ï¼Œå®ƒä»¬æ˜¯ Inbound çš„ï¼Œç„¶åæ˜¯ 4ï¼Œæœ€åæ‰æ˜¯ 2ï¼Œå®ƒä»¬ä¸¤ä¸ªæ˜¯ Outbound çš„ã€‚è¯´å®è¯ï¼Œè¿™ç§ç»„ç»‡æ–¹å¼å¯¹æ–°æ‰‹åº”è¯¥å¾ˆæ˜¯å¤´ç–¼ã€‚\né‚£æˆ‘ä»¬åœ¨å¼€å‘çš„æ—¶å€™æ€ä¹ˆå†™å‘¢ï¼Ÿå…¶å®ä¹Ÿå¾ˆç®€å•ï¼Œä»æœ€å¤–å±‚å¼€å§‹å†™ï¼Œä¸€æ­¥æ­¥å†™åˆ°ä¸šåŠ¡å¤„ç†å±‚ï¼ŒæŠŠ Inbound å’Œ Outbound æ··å†™åœ¨ä¸€èµ·ã€‚æ¯”å¦‚ encode å’Œ decode æ˜¯å±äºæœ€å¤–å±‚çš„å¤„ç†é€»è¾‘ï¼Œå…ˆå†™å®ƒä»¬ã€‚å‡è®¾ decode ä»¥åæ˜¯å­—ç¬¦ä¸²ï¼Œé‚£å†è¿›æ¥ä¸€å±‚åº”è¯¥å¯ä»¥å†™è¿›æ¥å’Œå‡ºå»çš„æ—¥å¿—ã€‚å†è¿›æ¥ä¸€å±‚å¯ä»¥å†™ å­—ç¬¦ä¸² &lt;&#x3D;&gt; å¯¹è±¡ çš„ç›¸äº’è½¬æ¢ã€‚ç„¶åå°±åº”è¯¥å†™ä¸šåŠ¡å±‚äº†ã€‚\n4. pipeline.addLast(new OutboundHandlerA());\n\nåˆ°è¿™é‡Œï¼Œæˆ‘æƒ³å¤§å®¶åº”è¯¥éƒ½çŸ¥é“ Inbound å’Œ Outbound äº†å§ï¼Ÿä¸‹é¢æˆ‘ä»¬æ¥ä»‹ç»å®ƒä»¬çš„æ¥å£ä½¿ç”¨ã€‚\n\nå®šä¹‰å¤„ç† Inbound äº‹ä»¶çš„ handler éœ€è¦å®ç° ChannelInboundHandlerï¼Œå®šä¹‰å¤„ç† Outbound äº‹ä»¶çš„ handler éœ€è¦å®ç° ChannelOutboundHandlerã€‚æœ€ä¸‹é¢çš„ä¸‰ä¸ªç±»ï¼Œæ˜¯ Netty æä¾›çš„é€‚é…å™¨ï¼Œç‰¹åˆ«çš„ï¼Œå¦‚æœæˆ‘ä»¬å¸Œæœ›å®šä¹‰ä¸€ä¸ª handler èƒ½åŒæ—¶å¤„ç† Inbound å’Œ Outbound äº‹ä»¶ï¼Œå¯ä»¥é€šè¿‡ç»§æ‰¿ä¸­é—´çš„ **ChannelDuplexHandler** çš„æ–¹å¼ï¼Œæ¯”å¦‚ **LoggingHandler** è¿™ç§æ—¢å¯ä»¥ç”¨æ¥å¤„ç† Inbound ä¹Ÿå¯ä»¥ç”¨æ¥å¤„ç† Outbound äº‹ä»¶çš„ handlerã€‚\nä¸‹å›¾æ¥æºäº Netty ChannelPipeline ã€‚\n\næœ‰äº† Inbound å’Œ Outbound çš„æ¦‚å¿µä»¥åï¼Œæˆ‘ä»¬æ¥å¼€å§‹ä»‹ç» Pipeline çš„æºç ã€‚\n\nChannelPipeline æºç è§£è¯»æˆ‘ä»¬è¯´è¿‡ï¼Œä¸€ä¸ª Channel å…³è”ä¸€ä¸ª pipelineï¼ŒNioSocketChannel å’Œ NioServerSocketChannel åœ¨æ‰§è¡Œæ„é€ æ–¹æ³•çš„æ—¶å€™ï¼Œéƒ½ä¼šèµ°åˆ°å®ƒä»¬çš„çˆ¶ç±» AbstractChannel çš„æ„é€ æ–¹æ³•ä¸­ï¼š\nprotected AbstractChannel(Channel parent) &#123;\n    this.parent = parent;\n    // ç»™æ¯ä¸ª channel åˆ†é…ä¸€ä¸ªå”¯ä¸€ id\n    id = newId();\n    // æ¯ä¸ª channel å†…éƒ¨éœ€è¦ä¸€ä¸ª Unsafe çš„å®ä¾‹\n    unsafe = newUnsafe();\n    // æ¯ä¸ª channel å†…éƒ¨éƒ½ä¼šåˆ›å»ºä¸€ä¸ª pipeline\n    pipeline = newChannelPipeline();\n&#125;\n\nä¸Šé¢çš„ä¸‰è¡Œä»£ç ä¸­ï¼Œid æ¯”è¾ƒä¸é‡è¦ï¼ŒNetty ä¸­çš„ Unsafe å®ä¾‹å…¶å®æŒºé‡è¦çš„ï¼Œè¿™é‡Œç®€å•ä»‹ç»ä¸€ä¸‹ã€‚\nåœ¨ JDK çš„æºç ä¸­ï¼Œsun.misc.Unsafe ç±»æä¾›äº†ä¸€äº›åº•å±‚æ“ä½œçš„èƒ½åŠ›ï¼Œå®ƒè®¾è®¡å‡ºæ¥æ˜¯ç»™ JDK ä¸­çš„æºç ä½¿ç”¨çš„ï¼Œæ¯”å¦‚ AQSã€ConcurrentHashMap ç­‰ï¼Œæˆ‘ä»¬åœ¨ä¹‹å‰çš„å¹¶å‘åŒ…çš„æºç åˆ†æä¸­ä¹Ÿçœ‹åˆ°äº†å¾ˆå¤šå®ƒä»¬ä½¿ç”¨ Unsafe çš„åœºæ™¯ï¼Œè¿™ä¸ª Unsafe ç±»ä¸æ˜¯ç»™æˆ‘ä»¬çš„ä»£ç ä½¿ç”¨çš„ï¼Œæ˜¯ç»™ JDK æºç ä½¿ç”¨çš„ï¼ˆéœ€è¦çš„è¯ï¼Œæˆ‘ä»¬ä¹Ÿæ˜¯å¯ä»¥è·å–å®ƒçš„å®ä¾‹çš„ï¼‰ã€‚\n\n\n\n\n\n\n\n\n\nUnsafe ç±»çš„æ„é€ æ–¹æ³•æ˜¯ private çš„ï¼Œä½†æ˜¯å®ƒæä¾›äº† getUnsafe() è¿™ä¸ªé™æ€æ–¹æ³•ï¼š\nå¤§å®¶å¯ä»¥è¯•ä¸€ä¸‹ï¼Œä¸Šé¢è¿™è¡Œä»£ç ç¼–è¯‘æ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯æ‰§è¡Œçš„æ—¶å€™ä¼šæŠ› java.lang.SecurityException å¼‚å¸¸ï¼Œå› ä¸ºå®ƒå°±ä¸æ˜¯ç»™æˆ‘ä»¬çš„ä»£ç ç”¨çš„ã€‚\nä½†æ˜¯å¦‚æœä½ å°±æ˜¯æƒ³è·å– Unsafe çš„å®ä¾‹ï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢è¿™ä¸ªä»£ç è·å–åˆ°:\nUnsafe unsafe = Unsafe.getUnsafe();\n\nField f = Unsafe.class.getDeclaredField(\"theUnsafe\");\nf.setAccessible(true);\nUnsafe unsafe = (Unsafe) f.get(null);\n\nNetty ä¸­çš„ Unsafe ä¹Ÿæ˜¯åŒæ ·çš„æ„æ€ï¼Œå®ƒå°è£…äº† Netty ä¸­ä¼šä½¿ç”¨åˆ°çš„ JDK æä¾›çš„ NIO æ¥å£ï¼Œæ¯”å¦‚å°† channel æ³¨å†Œåˆ° selector ä¸Šï¼Œæ¯”å¦‚ bind æ“ä½œï¼Œæ¯”å¦‚ connect æ“ä½œç­‰ï¼Œè¿™äº›æ“ä½œéƒ½æ˜¯ç¨å¾®ååº•å±‚ä¸€äº›ã€‚Netty åŒæ ·ä¹Ÿæ˜¯ä¸å¸Œæœ›æˆ‘ä»¬çš„ä¸šåŠ¡ä»£ç ä½¿ç”¨ Unsafe çš„å®ä¾‹ï¼Œå®ƒæ˜¯æä¾›ç»™ Netty ä¸­çš„æºç ä½¿ç”¨çš„ã€‚\n\n\n\n\n\n\n\n\n\nä¸è¿‡ï¼Œå¯¹äºæˆ‘ä»¬æºç åˆ†ææ¥è¯´ï¼Œæˆ‘ä»¬è¿˜æ˜¯ä¼šæœ‰å¾ˆå¤šæ—¶å€™éœ€è¦åˆ†æ Unsafe ä¸­çš„æºç çš„\nå…³äº Unsafeï¼Œæˆ‘ä»¬åé¢ç”¨åˆ°äº†å†è¯´ï¼Œè¿™é‡Œåªè¦çŸ¥é“ï¼Œå®ƒå°è£…äº†å¤§éƒ¨åˆ†éœ€è¦è®¿é—® JDK çš„ NIO æ¥å£çš„æ“ä½œå°±å¥½äº†ã€‚è¿™é‡Œæˆ‘ä»¬ç»§ç»­å°†ç„¦ç‚¹æ”¾åœ¨å®ä¾‹åŒ– pipeline ä¸Šï¼š\nprotected DefaultChannelPipeline newChannelPipeline() &#123;\n    return new DefaultChannelPipeline(this);\n&#125;\n\nè¿™é‡Œå¼€å§‹è°ƒç”¨ DefaultChannelPipeline çš„æ„é€ æ–¹æ³•ï¼Œå¹¶æŠŠå½“å‰ channel çš„å¼•ç”¨ä¼ å…¥ï¼š\nprotected DefaultChannelPipeline(Channel channel) &#123;\n    this.channel = ObjectUtil.checkNotNull(channel, \"channel\");\n    succeededFuture = new SucceededChannelFuture(channel, null);\n    voidPromise =  new VoidChannelPromise(channel, true);\n\n    tail = new TailContext(this);\n    head = new HeadContext(this);\n\n    head.next = tail;\n    tail.prev = head;\n&#125;\n\nè¿™é‡Œå®ä¾‹åŒ–äº† tail å’Œ head è¿™ä¸¤ä¸ª handlerã€‚tail å®ç°äº† ChannelInboundHandler æ¥å£ï¼Œè€Œ head å®ç°äº† ChannelOutboundHandler å’Œ ChannelInboundHandler ä¸¤ä¸ªæ¥å£ï¼Œå¹¶ä¸”æœ€åä¸¤è¡Œä»£ç å°† tail å’Œ head è¿æ¥èµ·æ¥:\n\n\n\n\n\n\n\n\n\n\næ³¨æ„ï¼Œåœ¨ä¸åŒçš„ç‰ˆæœ¬ä¸­ï¼Œæºç ä¹Ÿç•¥æœ‰å·®å¼‚ï¼Œhead ä¸ä¸€å®šæ˜¯ in + outï¼Œå¤§å®¶çŸ¥é“è¿™ç‚¹å°±å¥½äº†ã€‚\nè¿˜æœ‰ï¼Œä»ä¸Šé¢çš„ head å’Œ tail æˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œå…¶å® pipeline ä¸­çš„æ¯ä¸ªå…ƒç´ æ˜¯ **ChannelHandlerContext** çš„å®ä¾‹ï¼Œè€Œä¸æ˜¯ ChannelHandler çš„å®ä¾‹ï¼Œcontext åŒ…è£…äº†ä¸€ä¸‹ handlerï¼Œä½†æ˜¯ï¼Œåé¢æˆ‘ä»¬éƒ½ä¼šç”¨ handler æ¥æè¿°ä¸€ä¸ª pipeline ä¸Šçš„èŠ‚ç‚¹ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ contextï¼Œå¸Œæœ›è¯»è€…çŸ¥é“è¿™ä¸€ç‚¹ã€‚\nChannelHandlerContext å¯ä»¥è¯´æ˜¯ ChannelPipeline çš„æ ¸å¿ƒï¼Œå®ƒä»£è¡¨äº† ChannelHandler å’Œ ChannelPipeline ä¹‹é—´çš„å…³è”ï¼Œæˆ‘ä»¬é¦–å…ˆè¦çŸ¥é“ä¸€ä¸ª ChannelPipeline å†…éƒ¨ä¼šç»´æŠ¤ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œæ¯å½“ä¸€ä¸ª ChannelHandler è¢«æ·»åŠ åˆ° ChannelPipeline ä¸­æ—¶ï¼Œå®ƒéƒ½ä¼šè¢«åŒ…è£…æˆä¸ºä¸€ä¸ª ChannelHandlerContextï¼Œç»„æˆé“¾è¡¨çš„å„ä¸ªèŠ‚ç‚¹ã€‚\n\nè¿™é‡Œåªæ˜¯æ„é€ äº† pipelineï¼Œå¹¶ä¸”æ·»åŠ äº†ä¸¤ä¸ªå›ºå®šçš„ handler åˆ°å…¶ä¸­ï¼ˆhead + tailï¼‰ï¼Œè¿˜ä¸æ¶‰åŠåˆ°è‡ªå®šä¹‰çš„ handler ä»£ç æ‰§è¡Œã€‚æˆ‘ä»¬å›è¿‡å¤´æ¥çœ‹ä¸‹é¢è¿™æ®µä»£ç ï¼š\n\n\n\n\n\n\n\n\n\n\næˆ‘ä»¬è¯´è¿‡ childHandler ä¸­æŒ‡å®šçš„ handler ä¸æ˜¯ç»™ NioServerSocketChannel ä½¿ç”¨çš„ï¼Œæ˜¯ç»™ NioSocketChannel ä½¿ç”¨çš„ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬ä¸çœ‹å®ƒã€‚\nè¿™é‡Œè°ƒç”¨ handler(â€¦) æ–¹æ³•æŒ‡å®šäº†ä¸€ä¸ª LoggingHandler çš„å®ä¾‹ï¼Œç„¶åæˆ‘ä»¬å†è¿›å»ä¸‹é¢çš„ bind(â€¦) æ–¹æ³•ä¸­çœ‹çœ‹è¿™ä¸ª LoggingHandler å®ä¾‹æ˜¯æ€ä¹ˆè¿›å…¥åˆ°æˆ‘ä»¬ä¹‹å‰æ„é€ çš„ pipeline å†…çš„ã€‚\né¡ºç€ bind() ä¸€ç›´å¾€å‰èµ°ï¼Œbind() -&gt; doBind() -&gt; initAndRegister()ï¼š\nfinal ChannelFuture initAndRegister() &#123;\n    Channel channel = null;\n    try &#123;\n        // 1. æ„é€  channel å®ä¾‹ï¼ŒåŒæ—¶ä¼šæ„é€  pipeline å®ä¾‹ï¼Œ\n        // ç°åœ¨ pipeline ä¸­æœ‰ head å’Œ tail ä¸¤ä¸ª handler äº†\n        channel = channelFactory.newChannel();\n        // 2. çœ‹è¿™é‡Œ\n        init(channel);\n    &#125; catch (Throwable t) &#123;\n    ......\n&#125;\n\nä¸Šé¢çš„ä¸¤è¡Œä»£ç ï¼Œç¬¬ä¸€è¡Œå®ç°äº†æ„é€  channel å’Œ channel å†…éƒ¨çš„ pipelineï¼Œæˆ‘ä»¬æ¥çœ‹ç¬¬äºŒè¡Œ init ä»£ç ï¼š\nServerBootstrapï¼š\n@Override\nvoid init(Channel channel) throws Exception &#123;\n    ......\n    // æ‹¿åˆ°åˆšåˆšåˆ›å»ºçš„ channel å†…éƒ¨çš„ pipeline å®ä¾‹\n    ChannelPipeline p = channel.pipeline();\n    ...\n    // å¼€å§‹å¾€ pipeline ä¸­æ·»åŠ ä¸€ä¸ª handlerï¼Œè¿™ä¸ª handler æ˜¯ ChannelInitializer çš„å®ä¾‹\n    p.addLast(new ChannelInitializer&lt;Channel>() &#123;\n\n        // æˆ‘ä»¬ä»¥åä¼šçœ‹åˆ°ï¼Œä¸‹é¢è¿™ä¸ª initChannel æ–¹æ³•ä½•æ—¶ä¼šè¢«è°ƒç”¨\n        @Override\n        public void initChannel(final Channel ch) throws Exception &#123;\n            final ChannelPipeline pipeline = ch.pipeline();\n            // è¿™ä¸ªæ–¹æ³•è¿”å›æˆ‘ä»¬æœ€å¼€å§‹æŒ‡å®šçš„ LoggingHandler å®ä¾‹\n            ChannelHandler handler = config.handler();\n            if (handler != null) &#123;\n                // æ·»åŠ  LoggingHandler\n                pipeline.addLast(handler);\n            &#125;\n\n            // å…ˆä¸ç”¨ç®¡è¿™é‡Œçš„ eventLoop\n            ch.eventLoop().execute(new Runnable() &#123;\n                @Override\n                public void run() &#123;\n                    // æ·»åŠ ä¸€ä¸ª handler åˆ° pipeline ä¸­ï¼šServerBootstrapAcceptor\n                    // ä»åå­—å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ª handler çš„ç›®çš„æ˜¯ç”¨äºæ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚\n                    pipeline.addLast(new ServerBootstrapAcceptor(\n                            ch, currentChildGroup, currentChildHandler, currentChildOptions, currentChildAttrs));\n                &#125;\n            &#125;);\n        &#125;\n    &#125;);\n&#125;\n\nè¿™é‡Œæ¶‰åŠåˆ° pipeline ä¸­çš„è¾…åŠ©ç±» ChannelInitializerï¼Œæˆ‘ä»¬çœ‹åˆ°ï¼Œå®ƒæœ¬èº«æ˜¯ä¸€ä¸ª handlerï¼ˆInbound ç±»å‹ï¼‰ï¼Œä½†æ˜¯å®ƒçš„ä½œç”¨å’Œæ™®é€š handler æœ‰ç‚¹ä¸ä¸€æ ·ï¼Œå®ƒçº¯ç¢æ˜¯ç”¨æ¥è¾…åŠ©å°†å…¶ä»–çš„ handler åŠ å…¥åˆ° pipeline ä¸­çš„ã€‚\nå¤§å®¶å¯ä»¥ç¨å¾®çœ‹ä¸€ä¸‹ ChannelInitializer çš„ initChannel æ–¹æ³•ï¼Œæœ‰ä¸ªç®€å•çš„è®¤è¯†å°±å¥½ï¼Œæ­¤æ—¶çš„ pipeline åº”è¯¥æ˜¯è¿™æ ·çš„ï¼š\n\nChannelInitializer çš„ initChannel(channel) æ–¹æ³•è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œä¼šå¾€ pipeline ä¸­æ·»åŠ æˆ‘ä»¬æœ€å¼€å§‹æŒ‡å®šçš„ **LoggingHandler** å’Œæ·»åŠ ä¸€ä¸ª **ServerBootstrapAcceptor**ã€‚ä½†æ˜¯æˆ‘ä»¬ç°åœ¨è¿˜ä¸çŸ¥é“è¿™ä¸ª initChannel æ–¹æ³•ä½•æ—¶ä¼šè¢«è°ƒç”¨ã€‚\nä¸Šé¢æˆ‘ä»¬è¯´çš„æ˜¯ä½œä¸ºæœåŠ¡ç«¯çš„ NioServerSocketChannel çš„ pipelineï¼ŒNioSocketChannel ä¹Ÿæ˜¯å·®ä¸å¤šçš„ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹ Bootstrap ç±»çš„ init(channel) æ–¹æ³•ï¼š\nvoid init(Channel channel) throws Exception &#123;\n    ChannelPipeline p = channel.pipeline();\n    p.addLast(config.handler());\n    ...\n&#125;\n\n\nå®ƒå’ŒæœåŠ¡ç«¯ ServerBootstrap è¦æ·»åŠ  ServerBootstrapAcceptor ä¸ä¸€æ ·ï¼Œå®ƒåªéœ€è¦å°† EchoClient ç±»ä¸­çš„ ChannelInitializer å®ä¾‹åŠ è¿›æ¥å°±å¯ä»¥äº†ï¼Œå®ƒçš„ ChannelInitializer ä¸­æ·»åŠ äº†ä¸¤ä¸ª handlerï¼ŒLoggingHandler å’Œ EchoClientHandlerï¼š\n\nå¾ˆæ˜¾ç„¶ï¼Œæˆ‘ä»¬éœ€è¦çš„æ˜¯åƒ LoggingHandler å’Œ EchoClientHandler è¿™æ ·çš„ handlerï¼Œä½†æ˜¯ï¼Œå®ƒä»¬ç°åœ¨è¿˜ä¸åœ¨ pipeline ä¸­ï¼Œé‚£ä¹ˆå®ƒä»¬ä»€ä¹ˆæ—¶å€™ä¼šçœŸæ­£è¿›å…¥åˆ° pipeline ä¸­å‘¢ï¼Ÿä»¥åæˆ‘ä»¬å†æ­æ™“ã€‚\nè¿˜æœ‰ï¼Œä¸ºä»€ä¹ˆ Server ç«¯æˆ‘ä»¬æŒ‡å®šçš„æ˜¯ä¸€ä¸ª handler å®ä¾‹ï¼Œè€Œ Client æŒ‡å®šçš„æ˜¯ä¸€ä¸ª ChannelInitializer å®ä¾‹ï¼Ÿå…¶å®å®ƒä»¬æ˜¯å¯ä»¥éšæ„æ­é…ä½¿ç”¨çš„ï¼Œä½ ç”šè‡³å¯ä»¥åœ¨ ChannelInitializer å®ä¾‹ä¸­æ·»åŠ  ChannelInitializer çš„å®ä¾‹ã€‚\nå¤§å®¶è¦è®°ä½ pipeline ç°åœ¨çš„æ ·å­ï¼Œhead + channelInitializer + tailã€‚\næœ¬èŠ‚æ²¡æœ‰ä»‹ç» handler çš„å‘åä¼ æ’­ï¼Œå°±æ˜¯ä¸€ä¸ª handler å¤„ç†å®Œäº†ä»¥åï¼Œæ€ä¹ˆä¼ é€’ç»™ä¸‹ä¸€ä¸ª handler æ¥å¤„ç†ï¼Ÿæ¯”å¦‚æˆ‘ä»¬ç†Ÿæ‚‰çš„ JavaEE ä¸­çš„ Filter æ˜¯é‡‡ç”¨åœ¨ä¸€ä¸ª Filter å®ä¾‹ä¸­è°ƒç”¨ chain.doFilter(request, response) æ¥ä¼ é€’ç»™ä¸‹ä¸€ä¸ª Filter è¿™ç§æ–¹å¼çš„ã€‚\næˆ‘ä»¬ç”¨ä¸‹é¢è¿™å¼ å›¾ç»“æŸæœ¬èŠ‚ã€‚ä¸‹å›¾å±•ç¤ºäº†ä¼ æ’­çš„æ–¹æ³•ï¼Œä½†æˆ‘å…¶å®æ˜¯æ›´æƒ³è®©å¤§å®¶çœ‹ä¸€ä¸‹ï¼Œå“ªäº›äº‹ä»¶æ˜¯ Inbound ç±»å‹çš„ï¼Œå“ªäº›æ˜¯ Outbound ç±»å‹çš„ï¼š\n\nOutbound ç±»å‹çš„å‡ ä¸ªäº‹ä»¶å¤§å®¶åº”è¯¥æ¯”è¾ƒå¥½è®¤ï¼Œæ³¨æ„ bind ä¹Ÿæ˜¯ Outbound ç±»å‹çš„ã€‚\n3.å¼‚æ­¥æ“ä½œï¼šFuture å’Œ PromiseNetty ä¸­éå¸¸å¤šçš„å¼‚æ­¥è°ƒç”¨ï¼Œæ‰€ä»¥åœ¨ä»‹ç»æ›´å¤š NIO ç›¸å…³çš„å†…å®¹ä¹‹å‰ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹å®ƒçš„å¼‚æ­¥æ¥å£æ˜¯æ€ä¹ˆä½¿ç”¨çš„ã€‚\nå‰é¢æˆ‘ä»¬åœ¨ä»‹ç» Echo ä¾‹å­çš„æ—¶å€™ï¼Œå·²ç»ç”¨è¿‡äº† ChannelFuture è¿™ä¸ªæ¥å£äº†ï¼š\n\näº‰å–åœ¨çœ‹å®Œæœ¬èŠ‚åï¼Œè¯»è€…èƒ½ææ¸…æ¥šä¸Šé¢çš„è¿™å‡ è¡Œåˆ’çº¿éƒ¨åˆ†æ˜¯æ€ä¹ˆèµ°çš„ã€‚\nå…³äº Future æ¥å£ï¼Œæˆ‘æƒ³å¤§å®¶åº”è¯¥éƒ½å¾ˆç†Ÿæ‚‰ï¼Œç”¨å¾—æœ€å¤šçš„å°±æ˜¯åœ¨ä½¿ç”¨ Java çš„çº¿ç¨‹æ±  ThreadPoolExecutor çš„æ—¶å€™äº†ã€‚åœ¨ submit ä¸€ä¸ªä»»åŠ¡åˆ°çº¿ç¨‹æ± ä¸­çš„æ—¶å€™ï¼Œè¿”å›çš„å°±æ˜¯ä¸€ä¸ª **Future** å®ä¾‹ï¼Œé€šè¿‡å®ƒæ¥è·å–æäº¤çš„ä»»åŠ¡çš„æ‰§è¡ŒçŠ¶æ€å’Œæœ€ç»ˆçš„æ‰§è¡Œç»“æœï¼Œæˆ‘ä»¬æœ€å¸¸ç”¨å®ƒçš„ isDone() å’Œ get() æ–¹æ³•ã€‚\nä¸‹é¢æ˜¯ JDK Â ä¸­çš„ Future æ¥å£ java.util.concurrent.Future ï¼š\npublic interface Future&lt;V> &#123;\n    // å–æ¶ˆè¯¥ä»»åŠ¡\n    boolean cancel(boolean mayInterruptIfRunning);\n    // ä»»åŠ¡æ˜¯å¦å·²å–æ¶ˆ\n    boolean isCancelled();\n    // ä»»åŠ¡æ˜¯å¦å·²å®Œæˆ\n    boolean isDone();\n    // é˜»å¡è·å–ä»»åŠ¡æ‰§è¡Œç»“æœ\n    V get() throws InterruptedException, ExecutionException;\n    // å¸¦è¶…æ—¶å‚æ•°çš„è·å–ä»»åŠ¡æ‰§è¡Œç»“æœ\n    V get(long timeout, TimeUnit unit)\n        throws InterruptedException, ExecutionException, TimeoutException;\n&#125;\n\nNetty ä¸­çš„ Future æ¥å£ï¼ˆåŒåï¼‰ç»§æ‰¿äº† JDK ä¸­çš„ Future æ¥å£ï¼Œç„¶åæ·»åŠ äº†ä¸€äº›æ–¹æ³•ï¼š\nio.netty.util.concurrent.Future\npublic interface Future&lt;V> extends java.util.concurrent.Future&lt;V> &#123;\n\n    // æ˜¯å¦æˆåŠŸ\n    boolean isSuccess();\n\n    // æ˜¯å¦å¯å–æ¶ˆ\n    boolean isCancellable();\n\n    // å¦‚æœä»»åŠ¡æ‰§è¡Œå¤±è´¥ï¼Œè¿™ä¸ªæ–¹æ³•è¿”å›å¼‚å¸¸ä¿¡æ¯\n    Throwable cause();\n\n    // æ·»åŠ  Listener æ¥è¿›è¡Œå›è°ƒ\n    Future&lt;V> addListener(GenericFutureListener&lt;? extends Future&lt;? super V>> listener);\n    Future&lt;V> addListeners(GenericFutureListener&lt;? extends Future&lt;? super V>>... listeners);\n\n    Future&lt;V> removeListener(GenericFutureListener&lt;? extends Future&lt;? super V>> listener);\n    Future&lt;V> removeListeners(GenericFutureListener&lt;? extends Future&lt;? super V>>... listeners);\n\n    // é˜»å¡ç­‰å¾…ä»»åŠ¡ç»“æŸï¼Œå¦‚æœä»»åŠ¡å¤±è´¥ï¼Œå°†â€œå¯¼è‡´å¤±è´¥çš„å¼‚å¸¸â€é‡æ–°æŠ›å‡ºæ¥\n    Future&lt;V> sync() throws InterruptedException;\n    // ä¸å“åº”ä¸­æ–­çš„ sync()ï¼Œè¿™ä¸ªå¤§å®¶åº”è¯¥éƒ½å¾ˆç†Ÿäº†\n    Future&lt;V> syncUninterruptibly();\n\n    // é˜»å¡ç­‰å¾…ä»»åŠ¡ç»“æŸï¼Œå’Œ sync() åŠŸèƒ½æ˜¯ä¸€æ ·çš„ï¼Œä¸è¿‡å¦‚æœä»»åŠ¡å¤±è´¥ï¼Œå®ƒä¸ä¼šæŠ›å‡ºæ‰§è¡Œè¿‡ç¨‹ä¸­çš„å¼‚å¸¸\n    Future&lt;V> await() throws InterruptedException;\n    Future&lt;V> awaitUninterruptibly();\n    boolean await(long timeout, TimeUnit unit) throws InterruptedException;\n    boolean await(long timeoutMillis) throws InterruptedException;\n    boolean awaitUninterruptibly(long timeout, TimeUnit unit);\n    boolean awaitUninterruptibly(long timeoutMillis);\n\n    // è·å–æ‰§è¡Œç»“æœï¼Œä¸é˜»å¡ã€‚æˆ‘ä»¬éƒ½çŸ¥é“ java.util.concurrent.Future ä¸­çš„ get() æ˜¯é˜»å¡çš„\n    V getNow();\n\n    // å–æ¶ˆä»»åŠ¡æ‰§è¡Œï¼Œå¦‚æœå–æ¶ˆæˆåŠŸï¼Œä»»åŠ¡ä¼šå› ä¸º CancellationException å¼‚å¸¸è€Œå¯¼è‡´å¤±è´¥\n    //      ä¹Ÿå°±æ˜¯ isSuccess()==falseï¼ŒåŒæ—¶ä¸Šé¢çš„ cause() æ–¹æ³•è¿”å› CancellationException çš„å®ä¾‹ã€‚\n    // mayInterruptIfRunning è¯´çš„æ˜¯ï¼šæ˜¯å¦å¯¹æ­£åœ¨æ‰§è¡Œè¯¥ä»»åŠ¡çš„çº¿ç¨‹è¿›è¡Œä¸­æ–­(è¿™æ ·æ‰èƒ½åœæ­¢è¯¥ä»»åŠ¡çš„æ‰§è¡Œ)ï¼Œ\n    //       ä¼¼ä¹ Netty ä¸­ Future æ¥å£çš„å„ä¸ªå®ç°ç±»ï¼Œéƒ½æ²¡æœ‰ä½¿ç”¨è¿™ä¸ªå‚æ•°\n    @Override\n    boolean cancel(boolean mayInterruptIfRunning);\n&#125;\n\nçœ‹å®Œä¸Šé¢çš„ Netty çš„ Future æ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œå®ƒåŠ äº† sync() å’Œ await() ç”¨äºé˜»å¡ç­‰å¾…ï¼Œè¿˜åŠ äº† Listenersï¼Œåªè¦ä»»åŠ¡ç»“æŸå»å›è°ƒ Listener ä»¬å°±å¯ä»¥äº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±ä¸ä¸€å®šè¦ä¸»åŠ¨è°ƒç”¨ isDone() æ¥è·å–çŠ¶æ€ï¼Œæˆ–é€šè¿‡ get() é˜»å¡æ–¹æ³•æ¥è·å–å€¼ã€‚\n\n\n\n\n\n\n\n\n\næ‰€ä»¥å®ƒå…¶å®æœ‰ä¸¤ç§ä½¿ç”¨èŒƒå¼\né¡ºä¾¿è¯´ä¸‹ sync() å’Œ await() çš„åŒºåˆ«ï¼šsync() å†…éƒ¨ä¼šå…ˆè°ƒç”¨ await() æ–¹æ³•ï¼Œç­‰ await() æ–¹æ³•è¿”å›åï¼Œä¼šæ£€æŸ¥ä¸‹è¿™ä¸ªä»»åŠ¡æ˜¯å¦å¤±è´¥ï¼Œå¦‚æœå¤±è´¥ï¼Œé‡æ–°å°†å¯¼è‡´å¤±è´¥çš„å¼‚å¸¸æŠ›å‡ºæ¥ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœä½¿ç”¨ await()ï¼Œä»»åŠ¡æŠ›å‡ºå¼‚å¸¸åï¼Œawait() æ–¹æ³•ä¼šè¿”å›ï¼Œä½†æ˜¯ä¸ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œè€Œ sync() æ–¹æ³•è¿”å›çš„åŒæ—¶ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚\n\n\n\n\n\n\n\n\n\næˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼ŒFuture æ¥å£æ²¡æœ‰å’Œ IO æ“ä½œå…³è”åœ¨ä¸€èµ·ï¼Œè¿˜æ˜¯æ¯”è¾ƒ_çº¯å‡€_çš„æ¥å£ã€‚\næ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹ Future æ¥å£çš„å­æ¥å£ ChannelFutureï¼Œè¿™ä¸ªæ¥å£ç”¨å¾—æœ€å¤šï¼Œå®ƒå°†å’Œ IO æ“ä½œä¸­çš„ Channel å…³è”åœ¨ä¸€èµ·äº†ï¼Œç”¨äºå¼‚æ­¥å¤„ç† Channel ä¸­çš„äº‹ä»¶ã€‚\npublic interface ChannelFuture extends Future&lt;Void> &#123;\n\n    // ChannelFuture å…³è”çš„ Channel\n    Channel channel();\n\n    // è¦†å†™ä»¥ä¸‹å‡ ä¸ªæ–¹æ³•ï¼Œä½¿å¾—å®ƒä»¬è¿”å›å€¼ä¸º ChannelFuture ç±»å‹ \n    @Override\n    ChannelFuture addListener(GenericFutureListener&lt;? extends Future&lt;? super Void>> listener);\n    @Override\n    ChannelFuture addListeners(GenericFutureListener&lt;? extends Future&lt;? super Void>>... listeners);\n    @Override\n    ChannelFuture removeListener(GenericFutureListener&lt;? extends Future&lt;? super Void>> listener);\n    @Override\n    ChannelFuture removeListeners(GenericFutureListener&lt;? extends Future&lt;? super Void>>... listeners);\n\n    @Override\n    ChannelFuture sync() throws InterruptedException;\n    @Override\n    ChannelFuture syncUninterruptibly();\n\n    @Override\n    ChannelFuture await() throws InterruptedException;\n    @Override\n    ChannelFuture awaitUninterruptibly();\n\n    // ç”¨æ¥æ ‡è®°è¯¥ future æ˜¯ void çš„ï¼Œ\n    // è¿™æ ·å°±ä¸å…è®¸ä½¿ç”¨ addListener(...), sync(), await() ä»¥åŠå®ƒä»¬çš„å‡ ä¸ªé‡è½½æ–¹æ³•\n    boolean isVoid();\n&#125;\n\næˆ‘ä»¬çœ‹åˆ°ï¼ŒChannelFuture æ¥å£ç›¸å¯¹äº Future æ¥å£ï¼Œé™¤äº†å°† channel å…³è”è¿›æ¥ï¼Œæ²¡æœ‰å¢åŠ ä»€ä¹ˆä¸œè¥¿ã€‚è¿˜æœ‰ä¸ª isVoid() æ–¹æ³•ç®—æ˜¯ä¸é‚£ä¹ˆé‡è¦çš„å­˜åœ¨å§ã€‚å…¶ä»–å‡ ä¸ªéƒ½æ˜¯æ–¹æ³•è¦†å†™ï¼Œä¸ºäº†è®©è¿”å›å€¼ç±»å‹å˜ä¸º ChannelFutureï¼Œè€Œä¸æ˜¯åŸæ¥çš„ Futureã€‚\nè¿™é‡Œæœ‰ç‚¹è·³ï¼Œæˆ‘ä»¬æ¥ä»‹ç»ä¸‹ Promise æ¥å£ï¼Œå®ƒå’Œ ChannelFuture æ¥å£æ— å…³ï¼Œè€Œæ˜¯å’Œå‰é¢çš„ Future æ¥å£ç›¸å…³ï¼ŒPromise è¿™ä¸ªæ¥å£éå¸¸é‡è¦ã€‚\nPromise æ¥å£å’Œ ChannelFuture ä¸€æ ·ï¼Œä¹Ÿç»§æ‰¿äº† Netty çš„ Future æ¥å£ï¼Œç„¶ååŠ äº†ä¸€äº› Promise çš„å†…å®¹ï¼š\npublic interface Promise&lt;V> extends Future&lt;V> &#123;\n\n    // æ ‡è®°è¯¥ future æˆåŠŸåŠè®¾ç½®å…¶æ‰§è¡Œç»“æœï¼Œå¹¶ä¸”ä¼šé€šçŸ¥æ‰€æœ‰çš„ listenersã€‚\n    // å¦‚æœè¯¥æ“ä½œå¤±è´¥ï¼Œå°†æŠ›å‡ºå¼‚å¸¸(å¤±è´¥æŒ‡çš„æ˜¯è¯¥ future å·²ç»æœ‰äº†ç»“æœäº†ï¼ŒæˆåŠŸçš„ç»“æœï¼Œæˆ–è€…å¤±è´¥çš„ç»“æœ)\n    Promise&lt;V> setSuccess(V result);\n\n    // å’Œ setSuccess æ–¹æ³•ä¸€æ ·ï¼Œåªä¸è¿‡å¦‚æœå¤±è´¥ï¼Œå®ƒä¸æŠ›å¼‚å¸¸ï¼Œè¿”å› false\n    boolean trySuccess(V result);\n\n    // æ ‡è®°è¯¥ future å¤±è´¥ï¼ŒåŠå…¶å¤±è´¥åŸå› ã€‚\n    // å¦‚æœå¤±è´¥ï¼Œå°†æŠ›å‡ºå¼‚å¸¸(å¤±è´¥æŒ‡çš„æ˜¯å·²ç»æœ‰äº†ç»“æœäº†)\n    Promise&lt;V> setFailure(Throwable cause);\n\n    // æ ‡è®°è¯¥ future å¤±è´¥ï¼ŒåŠå…¶å¤±è´¥åŸå› ã€‚\n    // å¦‚æœå·²ç»æœ‰ç»“æœï¼Œè¿”å› falseï¼Œä¸æŠ›å‡ºå¼‚å¸¸\n    boolean tryFailure(Throwable cause);\n\n    // æ ‡è®°è¯¥ future ä¸å¯ä»¥è¢«å–æ¶ˆ\n    boolean setUncancellable();\n\n    // è¿™é‡Œå’Œ ChannelFuture ä¸€æ ·ï¼Œå¯¹è¿™å‡ ä¸ªæ–¹æ³•è¿›è¡Œè¦†å†™ï¼Œç›®çš„æ˜¯ä¸ºäº†è¿”å› Promise ç±»å‹çš„å®ä¾‹\n    @Override\n    Promise&lt;V> addListener(GenericFutureListener&lt;? extends Future&lt;? super V>> listener);\n    @Override\n    Promise&lt;V> addListeners(GenericFutureListener&lt;? extends Future&lt;? super V>>... listeners);\n\n    @Override\n    Promise&lt;V> removeListener(GenericFutureListener&lt;? extends Future&lt;? super V>> listener);\n    @Override\n    Promise&lt;V> removeListeners(GenericFutureListener&lt;? extends Future&lt;? super V>>... listeners);\n\n    @Override\n    Promise&lt;V> await() throws InterruptedException;\n    @Override\n    Promise&lt;V> awaitUninterruptibly();\n\n    @Override\n    Promise&lt;V> sync() throws InterruptedException;\n    @Override\n    Promise&lt;V> syncUninterruptibly();\n&#125;\n\nå¯èƒ½æœ‰äº›è¯»è€…å¯¹ Promise çš„æ¦‚å¿µä¸æ˜¯å¾ˆç†Ÿæ‚‰ï¼Œè¿™é‡Œç®€å•è¯´ä¸¤å¥ã€‚\næˆ‘è§‰å¾—åªè¦æ˜ç™½ä¸€ç‚¹ï¼ŒPromise å®ä¾‹å†…éƒ¨æ˜¯ä¸€ä¸ªä»»åŠ¡ï¼Œä»»åŠ¡çš„æ‰§è¡Œå¾€å¾€æ˜¯å¼‚æ­¥çš„ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªçº¿ç¨‹æ± æ¥å¤„ç†ä»»åŠ¡ã€‚Promise æä¾›çš„ setSuccess(V result) æˆ– setFailure(Throwable t)å°†æ¥ä¼šè¢«æŸä¸ªæ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹åœ¨æ‰§è¡Œå®Œæˆä»¥åè°ƒç”¨ï¼ŒåŒæ—¶é‚£ä¸ªçº¿ç¨‹åœ¨è°ƒç”¨ setSuccess(result) æˆ– setFailure(t) åä¼šå›è°ƒ listeners çš„å›è°ƒå‡½æ•°ï¼ˆå½“ç„¶ï¼Œå›è°ƒçš„å…·ä½“å†…å®¹ä¸ä¸€å®šè¦ç”±æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹è‡ªå·±æ¥æ‰§è¡Œï¼Œå®ƒå¯ä»¥åˆ›å»ºæ–°çš„çº¿ç¨‹æ¥æ‰§è¡Œï¼Œä¹Ÿå¯ä»¥å°†å›è°ƒä»»åŠ¡æäº¤åˆ°æŸä¸ªçº¿ç¨‹æ± æ¥æ‰§è¡Œï¼‰ã€‚è€Œä¸”ï¼Œä¸€æ—¦ setSuccess(...) æˆ– setFailure(...) åï¼Œé‚£äº› await() æˆ– sync() çš„çº¿ç¨‹å°±ä¼šä»ç­‰å¾…ä¸­è¿”å›ã€‚\n**æ‰€ä»¥è¿™é‡Œå°±æœ‰ä¸¤ç§ç¼–ç¨‹æ–¹å¼ï¼Œä¸€ç§æ˜¯ç”¨ ****await()**ï¼Œç­‰ **await()** æ–¹æ³•è¿”å›åï¼Œå¾—åˆ° **promise** çš„æ‰§è¡Œç»“æœï¼Œç„¶åå¤„ç†å®ƒï¼›å¦ä¸€ç§å°±æ˜¯æä¾› **Listener** å®ä¾‹ï¼Œæˆ‘ä»¬ä¸å¤ªå…³å¿ƒä»»åŠ¡ä»€ä¹ˆæ—¶å€™ä¼šæ‰§è¡Œå®Œï¼Œåªè¦å®ƒæ‰§è¡Œå®Œäº†ä»¥åä¼šå»æ‰§è¡Œ listener ä¸­çš„å¤„ç†æ–¹æ³•å°±è¡Œã€‚\næ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸‹ **ChannelPromise**ï¼Œå®ƒç»§æ‰¿äº†å‰é¢ä»‹ç»çš„ ChannelFuture å’Œ Promise æ¥å£ã€‚\n\nChannelPromise æ¥å£åœ¨ Netty ä¸­ä½¿ç”¨å¾—æ¯”è¾ƒå¤šï¼Œå› ä¸ºå®ƒç»¼åˆäº† ChannelFuture å’Œ Promise ä¸¤ä¸ªæ¥å£ï¼š\n/**\n * Special &#123;@link ChannelFuture&#125; which is writable.\n */\npublic interface ChannelPromise extends ChannelFuture, Promise&lt;Void> &#123;\n\n    // è¦†å†™ ChannelFuture ä¸­çš„ channel() æ–¹æ³•ï¼Œå…¶å®è¿™ä¸ªæ–¹æ³•ä¸€ç‚¹æ²¡å˜\n    @Override\n    Channel channel();\n\n    // ä¸‹é¢å‡ ä¸ªæ–¹æ³•æ˜¯è¦†å†™ Promise ä¸­çš„æ¥å£ï¼Œä¸ºäº†è¿”å›å€¼ç±»å‹æ˜¯ ChannelPromise\n    @Override\n    ChannelPromise setSuccess(Void result);\n    ChannelPromise setSuccess();\n    boolean trySuccess();\n    @Override\n    ChannelPromise setFailure(Throwable cause);\n\n    // åˆ°è¿™é‡Œå¤§å®¶åº”è¯¥éƒ½ç†Ÿæ‚‰äº†ï¼Œä¸‹é¢å‡ ä¸ªæ–¹æ³•çš„è¦†å†™ä¹Ÿæ˜¯ä¸ºäº†å¾—åˆ° ChannelPromise ç±»å‹çš„å®ä¾‹\n    @Override\n    ChannelPromise addListener(GenericFutureListener&lt;? extends Future&lt;? super Void>> listener);\n    @Override\n    ChannelPromise addListeners(GenericFutureListener&lt;? extends Future&lt;? super Void>>... listeners);\n    @Override\n    ChannelPromise removeListener(GenericFutureListener&lt;? extends Future&lt;? super Void>> listener);\n    @Override\n    ChannelPromise removeListeners(GenericFutureListener&lt;? extends Future&lt;? super Void>>... listeners);\n\n    @Override\n    ChannelPromise sync() throws InterruptedException;\n    @Override\n    ChannelPromise syncUninterruptibly();\n    @Override\n    ChannelPromise await() throws InterruptedException;\n    @Override\n    ChannelPromise awaitUninterruptibly();\n\n    /**\n     * Returns a new &#123;@link ChannelPromise&#125; if &#123;@link #isVoid()&#125; returns &#123;@code true&#125; otherwise itself.\n     */\n    // æˆ‘ä»¬å¿½ç•¥è¿™ä¸ªæ–¹æ³•å§ã€‚\n    ChannelPromise unvoid();\n&#125;\n\næˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå®ƒç»¼åˆäº† ChannelFuture å’Œ Promise ä¸­çš„æ–¹æ³•ï¼Œåªä¸è¿‡é€šè¿‡è¦†å†™å°†è¿”å›å€¼éƒ½å˜ä¸º ChannelPromise äº†è€Œå·²ï¼Œæ²¡æœ‰å¢åŠ ä»€ä¹ˆæ–°çš„åŠŸèƒ½ã€‚\nå°ç»“ä¸€ä¸‹ï¼Œæˆ‘ä»¬ä¸Šé¢ä»‹ç»äº†å‡ ä¸ªæ¥å£ï¼ŒFuture ä»¥åŠå®ƒçš„å­æ¥å£ ChannelFuture å’Œ Promiseï¼Œç„¶åæ˜¯ ChannelPromise æ¥å£åŒæ—¶ç»§æ‰¿äº† ChannelFuture å’Œ Promiseã€‚\næˆ‘æŠŠè¿™å‡ ä¸ªæ¥å£çš„ä¸»è¦æ–¹æ³•åˆ—åœ¨ä¸€èµ·ï¼Œè¿™æ ·å¤§å®¶çœ‹å¾—æ¸…æ™°äº›ï¼š\n\næ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦æ¥ä¸€ä¸ªå®ç°ç±»ï¼Œè¿™æ ·æ‰èƒ½æ¯”è¾ƒç›´è§‚åœ°çœ‹å‡ºå®ƒä»¬æ˜¯æ€ä¹ˆä½¿ç”¨çš„ï¼Œå› ä¸ºä¸Šé¢çš„è¿™äº›éƒ½æ˜¯æ¥å£å®šä¹‰ï¼Œå…·ä½“è¿˜å¾—çœ‹å®ç°ç±»æ˜¯æ€ä¹ˆå·¥ä½œçš„ã€‚\nä¸‹é¢ï¼Œæˆ‘ä»¬æ¥ä»‹ç»ä¸‹ DefaultPromise è¿™ä¸ªå®ç°ç±»ï¼Œè¿™ä¸ªç±»å¾ˆå¸¸ç”¨ï¼Œå®ƒçš„æºç ä¹Ÿä¸çŸ­ï¼Œæˆ‘ä»¬å…ˆä»‹ç»å‡ ä¸ªå…³é”®çš„å†…å®¹ï¼Œç„¶åä»‹ç»ä¸€ä¸ªç¤ºä¾‹ä½¿ç”¨ã€‚\né¦–å…ˆï¼Œæˆ‘ä»¬çœ‹ä¸‹å®ƒæœ‰å“ªäº›å±æ€§ï¼š\npublic class DefaultPromise&lt;V> extends AbstractFuture&lt;V> implements Promise&lt;V> &#123;\n      // ä¿å­˜æ‰§è¡Œç»“æœ\n    private volatile Object result;\n    // æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹æ± ï¼Œpromise æŒæœ‰ executor çš„å¼•ç”¨ï¼Œè¿™ä¸ªå…¶å®æœ‰ç‚¹å¥‡æ€ªäº†\n    // å› ä¸ºâ€œä»»åŠ¡â€å…¶å®æ²¡å¿…è¦çŸ¥é“è‡ªå·±åœ¨å“ªé‡Œè¢«æ‰§è¡Œçš„\n    private final EventExecutor executor;\n      // ç›‘å¬è€…ï¼Œå›è°ƒå‡½æ•°ï¼Œä»»åŠ¡ç»“æŸåï¼ˆæ­£å¸¸æˆ–å¼‚å¸¸ç»“æŸï¼‰æ‰§è¡Œ\n    private Object listeners;\n\n    // ç­‰å¾…è¿™ä¸ª promise çš„çº¿ç¨‹æ•°(è°ƒç”¨sync()/await()è¿›è¡Œç­‰å¾…çš„çº¿ç¨‹æ•°é‡)\n    private short waiters;\n\n    // æ˜¯å¦æ­£åœ¨å”¤é†’ç­‰å¾…çº¿ç¨‹ï¼Œç”¨äºé˜²æ­¢é‡å¤æ‰§è¡Œå”¤é†’ï¼Œä¸ç„¶ä¼šé‡å¤æ‰§è¡Œ listeners çš„å›è°ƒæ–¹æ³•\n    private boolean notifyingListeners;\n    ......\n&#125;\n\n\n\n\n\n\n\n\n\n\nå¯ä»¥çœ‹å‡ºï¼Œæ­¤ç±»å®ç°äº† Promiseï¼Œä½†æ˜¯æ²¡æœ‰å®ç° ChannelFutureï¼Œæ‰€ä»¥å®ƒå’Œ Channel è”ç³»ä¸èµ·æ¥ã€‚\nåˆ«æ€¥ï¼Œæˆ‘ä»¬åé¢ä¼šç¢°åˆ°å¦ä¸€ä¸ªç±» DefaultChannelPromise çš„ä½¿ç”¨ï¼Œè¿™ä¸ªç±»æ˜¯ç»¼åˆäº† ChannelFuture å’Œ Promise çš„ï¼Œä½†æ˜¯å®ƒçš„å®ç°å…¶å®å¤§éƒ¨åˆ†éƒ½æ˜¯ç»§æ‰¿è‡ªè¿™é‡Œçš„ DefaultPromise ç±»çš„ã€‚\nè¯´å®Œä¸Šé¢çš„å±æ€§ä»¥åï¼Œå¤§å®¶å¯ä»¥çœ‹ä¸‹ setSuccess(V result) ã€trySuccess(V result) å’Œ setFailure(Throwable cause) ã€ tryFailure(Throwable cause) è¿™å‡ ä¸ªæ–¹æ³•ï¼š\n\n\n\n\n\n\n\n\n\n\nçœ‹å‡º setSuccess(result) å’Œ trySuccess(result) çš„åŒºåˆ«äº†å—ï¼Ÿ\nä¸Šé¢å‡ ä¸ªæ–¹æ³•éƒ½éå¸¸ç®€å•ï¼Œå…ˆè®¾ç½®å¥½å€¼ï¼Œç„¶åæ‰§è¡Œç›‘å¬è€…ä»¬çš„å›è°ƒæ–¹æ³•ã€‚notifyListeners() æ–¹æ³•æ„Ÿå…´è¶£çš„è¯»è€…ä¹Ÿå¯ä»¥çœ‹ä¸€çœ‹ï¼Œä¸è¿‡å®ƒè¿˜æ¶‰åŠåˆ° Netty çº¿ç¨‹æ± çš„ä¸€äº›å†…å®¹ï¼Œæˆ‘ä»¬è¿˜æ²¡æœ‰ä»‹ç»åˆ°çº¿ç¨‹æ± ï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ã€‚ä¸Šé¢çš„ä»£ç ï¼Œåœ¨ setSuccess0 æˆ– setFailure0 æ–¹æ³•ä¸­éƒ½ä¼šå”¤é†’é˜»å¡åœ¨ sync() æˆ– await() çš„çº¿ç¨‹\nå¦å¤–ï¼Œå°±æ˜¯å¯ä»¥çœ‹ä¸‹ sync() å’Œ await() çš„åŒºåˆ«ï¼Œå…¶ä»–çš„æˆ‘è§‰å¾—éšä¾¿çœ‹çœ‹å°±å¥½äº†ã€‚\n@Override\npublic Promise&lt;V> sync() throws InterruptedException &#123;\n    await();\n    // å¦‚æœä»»åŠ¡æ˜¯å¤±è´¥çš„ï¼Œé‡æ–°æŠ›å‡ºç›¸åº”çš„å¼‚å¸¸\n    rethrowIfFailed();\n    return this;\n&#125;\n\næ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥å†™ä¸ªå®ä¾‹ä»£ç å§ï¼š\npublic static void main(String[] args) &#123;\n\n    // æ„é€ çº¿ç¨‹æ± \n    EventExecutor executor = new DefaultEventExecutor();\n\n    // åˆ›å»º DefaultPromise å®ä¾‹\n    Promise promise = new DefaultPromise(executor);\n\n    // ä¸‹é¢ç»™è¿™ä¸ª promise æ·»åŠ ä¸¤ä¸ª listener\n    promise.addListener(new GenericFutureListener&lt;Future&lt;Integer>>() &#123;\n        @Override\n        public void operationComplete(Future future) throws Exception &#123;\n            if (future.isSuccess()) &#123;\n                System.out.println(\"ä»»åŠ¡ç»“æŸï¼Œç»“æœï¼š\" + future.get());\n            &#125; else &#123;\n                System.out.println(\"ä»»åŠ¡å¤±è´¥ï¼Œå¼‚å¸¸ï¼š\" + future.cause());\n            &#125;\n        &#125;\n    &#125;).addListener(new GenericFutureListener&lt;Future&lt;Integer>>() &#123;\n        @Override\n        public void operationComplete(Future future) throws Exception &#123;\n            System.out.println(\"ä»»åŠ¡ç»“æŸï¼Œbalabala...\");\n        &#125;\n    &#125;);\n\n    // æäº¤ä»»åŠ¡åˆ°çº¿ç¨‹æ± ï¼Œäº”ç§’åæ‰§è¡Œç»“æŸï¼Œè®¾ç½®æ‰§è¡Œ promise çš„ç»“æœ\n    executor.submit(new Runnable() &#123;\n        @Override\n        public void run() &#123;\n            try &#123;\n                Thread.sleep(5000);\n            &#125; catch (InterruptedException e) &#123;\n            &#125;\n            // è®¾ç½® promise çš„ç»“æœ\n            // promise.setFailure(new RuntimeException());\n            promise.setSuccess(123456);\n        &#125;\n    &#125;);\n\n    // main çº¿ç¨‹é˜»å¡ç­‰å¾…æ‰§è¡Œç»“æœ\n    try &#123;\n        promise.sync();\n    &#125; catch (InterruptedException e) &#123;\n    &#125;\n&#125;\n\nè¿è¡Œä»£ç ï¼Œä¸¤ä¸ª listener å°†åœ¨ 5 ç§’åå°†è¾“å‡ºï¼š\nä»»åŠ¡ç»“æŸï¼Œç»“æœï¼š123456\nä»»åŠ¡ç»“æŸï¼Œbalabala...\n\n\n\n\n\n\n\n\n\n\nè¯»è€…è¿™é‡Œå¯ä»¥è¯•ä¸€ä¸‹ sync() å’Œ await() çš„åŒºåˆ«ï¼Œåœ¨ä»»åŠ¡ä¸­è°ƒç”¨ promise.setFailure(new RuntimeException()) è¯•è¯•çœ‹ã€‚\nä¸Šé¢çš„ä»£ç ä¸­ï¼Œå¤§å®¶å¯èƒ½ä¼šå¯¹çº¿ç¨‹æ±  executor å’Œ promise ä¹‹é—´çš„å…³ç³»æ„Ÿåˆ°æœ‰ç‚¹è¿·æƒ‘ã€‚è¯»è€…åº”è¯¥ä¹Ÿè¦æ¸…æ¥šï¼Œå…·ä½“çš„ä»»åŠ¡ä¸ä¸€å®šå°±è¦åœ¨è¿™ä¸ª executor ä¸­è¢«æ‰§è¡Œã€‚ä»»åŠ¡ç»“æŸä»¥åï¼Œéœ€è¦è°ƒç”¨ promise.setSuccess(result) ä½œä¸ºé€šçŸ¥ã€‚\né€šå¸¸æ¥è¯´ï¼Œpromise ä»£è¡¨çš„ future æ˜¯ä¸éœ€è¦å’Œçº¿ç¨‹æ± æ…åœ¨ä¸€èµ·çš„ï¼Œfuture åªå…³å¿ƒä»»åŠ¡æ˜¯å¦ç»“æŸä»¥åŠä»»åŠ¡çš„æ‰§è¡Œç»“æœï¼Œè‡³äºæ˜¯å“ªä¸ªçº¿ç¨‹æˆ–å“ªä¸ªçº¿ç¨‹æ± æ‰§è¡Œçš„ä»»åŠ¡ï¼Œfuture å…¶å®æ˜¯ä¸å…³å¿ƒçš„ã€‚\nä¸è¿‡ Netty æ¯•ç«Ÿä¸æ˜¯è¦åˆ›å»ºä¸€ä¸ªé€šç”¨çš„çº¿ç¨‹æ± å®ç°ï¼Œè€Œæ˜¯å’Œå®ƒè¦å¤„ç†çš„ IO æ¯æ¯ç›¸å…³çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åªä¸è¿‡è¦ç†è§£å®ƒå°±å¥½äº†ã€‚\nè¿™èŠ‚å°±è¯´è¿™ä¹ˆå¤šå§ï¼Œæˆ‘ä»¬å›è¿‡å¤´æ¥å†çœ‹ä¸€ä¸‹è¿™å¼ å›¾ï¼Œçœ‹çœ‹å¤§å®¶æ˜¯ä¸æ˜¯çœ‹æ‡‚äº†è¿™èŠ‚å†…å®¹ï¼š\n\næˆ‘ä»¬å°±è¯´è¯´ä¸Šå›¾å·¦è¾¹çš„éƒ¨åˆ†å§ï¼Œè™½ç„¶æˆ‘ä»¬è¿˜ä¸çŸ¥é“ bind() æ“ä½œä¸­å…·ä½“ä¼šåšä»€ä¹ˆå·¥ä½œï¼Œä½†æ˜¯æˆ‘ä»¬åº”è¯¥å¯ä»¥çŒœå‡ºä¸€äºŒã€‚\næ˜¾ç„¶ï¼Œmain çº¿ç¨‹è°ƒç”¨ b.bind(port) è¿™ä¸ªæ–¹æ³•ä¼šè¿”å›ä¸€ä¸ª ChannelFutureï¼Œbind() æ˜¯ä¸€ä¸ªå¼‚æ­¥æ–¹æ³•ï¼Œå½“æŸä¸ªæ‰§è¡Œçº¿ç¨‹æ‰§è¡Œäº†çœŸæ­£çš„ç»‘å®šæ“ä½œåï¼Œé‚£ä¸ªæ‰§è¡Œçº¿ç¨‹ä¸€å®šä¼šæ ‡è®°è¿™ä¸ª future ä¸ºæˆåŠŸï¼ˆæˆ‘ä»¬å‡å®š bind ä¼šæˆåŠŸï¼‰ï¼Œç„¶åè¿™é‡Œçš„ sync() æ–¹æ³•ï¼ˆmain çº¿ç¨‹ï¼‰å°±ä¼šè¿”å›äº†ã€‚\n\n\n\n\n\n\n\n\n\nå¦‚æœ bind(port) å¤±è´¥ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œsync() æ–¹æ³•ä¼šå°†å¼‚å¸¸æŠ›å‡ºæ¥ï¼Œç„¶åå°±ä¼šæ‰§è¡Œåˆ° finally å—äº†ã€‚\nä¸€æ—¦ç»‘å®šç«¯å£ bind æˆåŠŸï¼Œè¿›å…¥ä¸‹é¢ä¸€è¡Œï¼Œf.channel() æ–¹æ³•ä¼šè¿”å›è¯¥ future å…³è”çš„ channelã€‚\nchannel.closeFuture() ä¹Ÿä¼šè¿”å›ä¸€ä¸ª ChannelFutureï¼Œç„¶åè°ƒç”¨äº† sync() æ–¹æ³•ï¼Œè¿™ä¸ª sync() æ–¹æ³•è¿”å›çš„æ¡ä»¶æ˜¯ï¼š**æœ‰å…¶ä»–çš„çº¿ç¨‹å…³é—­äº† ****NioServerSocketChannel**ï¼Œå¾€å¾€æ˜¯å› ä¸ºéœ€è¦åœæ‰æœåŠ¡äº†ï¼Œç„¶åé‚£ä¸ªçº¿ç¨‹ä¼šè®¾ç½® future çš„çŠ¶æ€ï¼ˆ setSuccess(result) æˆ– setFailure(cause) ï¼‰ï¼Œè¿™ä¸ª sync() æ–¹æ³•æ‰ä¼šè¿”å›ã€‚\n4.çº¿ç¨‹æ± ï¼šEventLoopGroupæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥åˆ†æ Netty ä¸­çš„çº¿ç¨‹æ± ã€‚Netty ä¸­çš„çº¿ç¨‹æ± æ¯”è¾ƒä¸å¥½ç†è§£ï¼Œå› ä¸ºå®ƒçš„ç±»æ¯”è¾ƒå¤šï¼Œè€Œä¸”å®ƒä»¬ä¹‹é—´çš„å…³ç³»é”™ç»¼å¤æ‚ã€‚çœ‹ä¸‹å›¾ï¼Œæ„Ÿå—ä¸‹ NioEventLoop ç±»å’Œ NioEventLoopGroup ç±»çš„ç»§æ‰¿ç»“æ„ï¼š\n\nè¿™å¼ å›¾æˆ‘æŒ‰ç…§ç»§æ‰¿å…³ç³»æ•´ç†è€Œæ¥ï¼Œå¤§å®¶ä»”ç»†çœ‹ä¸€ä¸‹å°±ä¼šå‘ç°ï¼Œæ¶‰åŠåˆ°çš„ç±»ç¡®å®æŒºå¤šçš„ã€‚æœ¬èŠ‚æ¥ç»™å¤§å®¶ç†ç†æ¸…æ¥šè¿™éƒ¨åˆ†å†…å®¹ã€‚\né¦–å…ˆï¼Œæˆ‘ä»¬è¯´çš„ Netty çš„çº¿ç¨‹æ± ï¼ŒæŒ‡çš„å°±æ˜¯ **NioEventLoopGroup** çš„å®ä¾‹ï¼›çº¿ç¨‹æ± ä¸­çš„å•ä¸ªçº¿ç¨‹ï¼ŒæŒ‡çš„æ˜¯å³è¾¹ **NioEventLoop** çš„å®ä¾‹ã€‚\nå›é¡¾ä¸‹æˆ‘ä»¬ç¬¬ä¸€èŠ‚ä»‹ç»çš„ Echo ä¾‹å­ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„å¯åŠ¨ä»£ç ä¸­ï¼Œæœ€å¼€å§‹æˆ‘ä»¬æ€»æ˜¯å…ˆå®ä¾‹åŒ– NioEventLoopGroupï¼š\n// EchoClient ä»£ç æœ€å¼€å§‹ï¼š\nEventLoopGroup group = new NioEventLoopGroup();\n\n// EchoServer ä»£ç æœ€å¼€å§‹ï¼š\nEventLoopGroup bossGroup = new NioEventLoopGroup(1);\nEventLoopGroup workerGroup = new NioEventLoopGroup();\n\nä¸‹é¢ï¼Œæˆ‘ä»¬å°±ä» NioEventLoopGroup çš„æºç å¼€å§‹è¿›è¡Œåˆ†æã€‚\n\nNioEventLoopGroup çš„åˆ›å»ºæˆ‘ä»¬æ‰“å¼€ NioEventLoopGroup çš„æºç ï¼Œå¯ä»¥çœ‹åˆ°ï¼ŒNioEventLoopGroup æœ‰å¤šä¸ªæ„é€ æ–¹æ³•ç”¨äºå‚æ•°è®¾ç½®ï¼Œæœ€ç®€å•åœ°ï¼Œæˆ‘ä»¬é‡‡ç”¨æ— å‚æ„é€ å‡½æ•°ï¼Œæˆ–ä»…ä»…è®¾ç½®çº¿ç¨‹æ•°é‡å°±å¯ä»¥äº†ï¼Œå…¶ä»–çš„å‚æ•°é‡‡ç”¨é»˜è®¤å€¼ã€‚\n\n\n\n\n\n\n\n\n\næ¯”å¦‚ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬åªåœ¨å®ä¾‹åŒ– bossGroup çš„æ—¶å€™æŒ‡å®šäº†å‚æ•°ï¼Œä»£è¡¨è¯¥çº¿ç¨‹æ± éœ€è¦ä¸€ä¸ªçº¿ç¨‹ã€‚\npublic NioEventLoopGroup() &#123;\n    this(0);\n&#125;\npublic NioEventLoopGroup(int nThreads) &#123;\n    this(nThreads, (Executor) null);\n&#125;\n\n...\n\n// å‚æ•°æœ€å…¨çš„æ„é€ æ–¹æ³•\npublic NioEventLoopGroup(int nThreads, Executor executor, EventExecutorChooserFactory chooserFactory,\n                         final SelectorProvider selectorProvider,\n                         final SelectStrategyFactory selectStrategyFactory,\n                         final RejectedExecutionHandler rejectedExecutionHandler) &#123;\n    // è°ƒç”¨çˆ¶ç±»çš„æ„é€ æ–¹æ³•\n    super(nThreads, executor, chooserFactory, selectorProvider, selectStrategyFactory, rejectedExecutionHandler);\n&#125;\n\næˆ‘ä»¬æ¥ç¨å¾®çœ‹ä¸€ä¸‹æ„é€ æ–¹æ³•ä¸­çš„å„ä¸ªå‚æ•°ï¼š\n\nnThreadsï¼šè¿™ä¸ªæœ€ç®€å•ï¼Œå°±æ˜¯çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°ï¼Œä¹Ÿå°±æ˜¯ NioEventLoop çš„å®ä¾‹æ•°é‡ã€‚\nexecutorï¼šæˆ‘ä»¬çŸ¥é“ï¼Œæˆ‘ä»¬æœ¬èº«å°±æ˜¯è¦æ„é€ ä¸€ä¸ªçº¿ç¨‹æ± ï¼ˆExecutorï¼‰ï¼Œä¸ºä»€ä¹ˆè¿™é‡Œä¼ ä¸€ä¸ª executor å®ä¾‹å‘¢ï¼Ÿå®ƒå…¶å®ä¸æ˜¯ç»™çº¿ç¨‹æ± ç”¨çš„ï¼Œè€Œæ˜¯ç»™ NioEventLoop ç”¨çš„ï¼Œä»¥åå†è¯´ã€‚\nchooserFactoryï¼šå½“æˆ‘ä»¬æäº¤ä¸€ä¸ªä»»åŠ¡åˆ°çº¿ç¨‹æ± çš„æ—¶å€™ï¼Œçº¿ç¨‹æ± éœ€è¦é€‰æ‹©ï¼ˆchooseï¼‰å…¶ä¸­çš„ä¸€ä¸ªçº¿ç¨‹æ¥æ‰§è¡Œè¿™ä¸ªä»»åŠ¡ï¼Œè¿™ä¸ªå°±æ˜¯ç”¨æ¥å®ç°é€‰æ‹©ç­–ç•¥çš„ã€‚\nselectorProviderï¼šè¿™ä¸ªç®€å•ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡å®ƒæ¥å®ä¾‹åŒ– JDK çš„ Selectorï¼Œå¯ä»¥çœ‹åˆ°æ¯ä¸ªçº¿ç¨‹æ± éƒ½æŒæœ‰ä¸€ä¸ª selectorProvider å®ä¾‹ã€‚\nselectStrategyFactoryï¼šè¿™ä¸ªæ¶‰åŠåˆ°çš„æ˜¯çº¿ç¨‹æ± ä¸­çº¿ç¨‹çš„å·¥ä½œæµç¨‹ï¼Œåœ¨ä»‹ç» NioEventLoop çš„æ—¶å€™ä¼šè¯´ã€‚\nrejectedExecutionHandlerï¼šè¿™ä¸ªä¹Ÿæ˜¯çº¿ç¨‹æ± çš„å¥½æœ‹å‹äº†ï¼Œç”¨äºå¤„ç†çº¿ç¨‹æ± ä¸­æ²¡æœ‰å¯ç”¨çš„çº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡çš„æƒ…å†µã€‚åœ¨ Netty ä¸­ç¨å¾®æœ‰ä¸€ç‚¹ç‚¹ä¸ä¸€æ ·ï¼Œè¿™ä¸ªæ˜¯ç»™ NioEventLoop å®ä¾‹ç”¨çš„ï¼Œä»¥åæˆ‘ä»¬å†è¯¦ç»†ä»‹ç»ã€‚\n\nè¿™é‡Œä»‹ç»è¿™äº›å‚æ•°æ˜¯å¸Œæœ›å¤§å®¶æœ‰ä¸ªå°è±¡è€Œå·²ï¼Œå¤§å®¶å‘ç°æ²¡æœ‰ï¼Œåœ¨æ„é€  NioEventLoopGroup å®ä¾‹æ—¶çš„å¥½å‡ ä¸ªå‚æ•°ï¼Œéƒ½æ˜¯ç”¨æ¥æ„é€  NioEventLoop ç”¨çš„ã€‚\nä¸‹é¢ï¼Œæˆ‘ä»¬ä» NioEventLoopGroup çš„æ— å‚æ„é€ æ–¹æ³•å¼€å§‹ï¼Œè·Ÿç€æºç èµ°ï¼š\npublic NioEventLoopGroup() &#123;\n    this(0);\n&#125;\n\nç„¶åä¸€æ­¥æ­¥èµ°ä¸‹å»ï¼Œåˆ°è¿™ä¸ªæ„é€ æ–¹æ³•ï¼š\npublic NioEventLoopGroup(int nThreads, ThreadFactory threadFactory, final SelectorProvider selectorProvider, final SelectStrategyFactory selectStrategyFactory) &#123;\n\n    super(nThreads, threadFactory, selectorProvider, selectStrategyFactory, RejectedExecutionHandlers.reject());\n&#125;\n\nå¤§å®¶è‡ªå·±è¦å»è·Ÿä¸€ä¸‹æºç ï¼Œè¿™æ ·æ‰çŸ¥é“ä¸­é—´è®¾ç½®äº†å“ªäº›é»˜è®¤å€¼ï¼Œä¸‹é¢è¿™å‡ ä¸ªå‚æ•°éƒ½è¢«è®¾ç½®äº†é»˜è®¤å€¼ï¼š\n\nselectorProvider = SelectorProvider.provider()\n\n\n\n\n\n\n\n\n\n\nè¿™ä¸ªæ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œè°ƒç”¨äº† JDK æä¾›çš„æ–¹æ³•\n\nselectStrategyFactory = DefaultSelectStrategyFactory.INSTANCE\n\n\n\n\n\n\n\n\n\n\nè¿™ä¸ªæ¶‰åŠåˆ°çš„æ˜¯çº¿ç¨‹åœ¨åš select æ“ä½œå’Œæ‰§è¡Œä»»åŠ¡è¿‡ç¨‹ä¸­çš„ç­–ç•¥é€‰æ‹©é—®é¢˜ï¼Œåœ¨ä»‹ç» NioEventLoop çš„æ—¶å€™ä¼šç”¨åˆ°ã€‚\n\nrejectedExecutionHandler = RejectedExecutionHandlers.reject()\n\n\n\n\n\n\n\n\n\n\nå¤§å®¶è¿›å»çœ‹ä¸€ä¸‹ reject() æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒNetty é€‰æ‹©çš„é»˜è®¤æ‹’ç»ç­–ç•¥æ˜¯ï¼šæŠ›å‡ºå¼‚å¸¸\nè·Ÿç€æºç èµ°ï¼Œæˆ‘ä»¬ä¼šæ¥åˆ°çˆ¶ç±» MultithreadEventLoopGroup çš„æ„é€ æ–¹æ³•ä¸­ï¼š\nprotected MultithreadEventLoopGroup(int nThreads, ThreadFactory threadFactory, Object... args) &#123;\n    super(nThreads == 0 ? DEFAULT_EVENT_LOOP_THREADS : nThreads, threadFactory, args);\n&#125;\n\nè¿™é‡Œæˆ‘ä»¬å‘ç°ï¼Œå¦‚æœé‡‡ç”¨æ— å‚æ„é€ å‡½æ•°ï¼Œé‚£ä¹ˆåˆ°è¿™é‡Œçš„æ—¶å€™ï¼Œé»˜è®¤åœ° nThreads ä¼šè¢«è®¾ç½®ä¸º **CPU æ ¸å¿ƒæ•° *2**ã€‚å¤§å®¶å¯ä»¥çœ‹ä¸‹ DEFAULT_EVENT_LOOP_THREADS çš„é»˜è®¤å€¼ï¼Œä»¥åŠ static ä»£ç å—çš„è®¾å€¼é€»è¾‘ã€‚\næˆ‘ä»¬ç»§ç»­å¾€ä¸‹èµ°ï¼š\nprotected MultithreadEventExecutorGroup(int nThreads, ThreadFactory threadFactory, Object...args) &#123;\n    this(nThreads, threadFactory == null ? null : new ThreadPerTaskExecutor(threadFactory), args);\n&#125;\n\nåˆ°è¿™ä¸€æ­¥çš„æ—¶å€™ï¼Œnew ThreadPerTaskExecutor(threadFactory) ä¼šæ„é€ ä¸€ä¸ª executorã€‚\n\n\n\n\n\n\n\n\n\næˆ‘ä»¬ç°åœ¨è¿˜ä¸çŸ¥é“è¿™ä¸ª executor æ€ä¹ˆç”¨ã€‚è¿™é‡Œæˆ‘ä»¬å…ˆçœ‹ä¸‹å®ƒçš„æºç ï¼š\nExecutor ä½œä¸ºçº¿ç¨‹æ± çš„æœ€é¡¶å±‚æ¥å£ï¼Œ æˆ‘ä»¬çŸ¥é“ï¼Œå®ƒåªæœ‰ä¸€ä¸ª execute(runnable) æ–¹æ³•ï¼Œä»ä¸Šé¢æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå®ç°ç±» ThreadPerTaskExecutor çš„é€»è¾‘å°±æ˜¯æ¯æ¥ä¸€ä¸ªä»»åŠ¡ï¼Œæ–°å»ºä¸€ä¸ªçº¿ç¨‹ã€‚\næˆ‘ä»¬å…ˆè®°ä½è¿™ä¸ªï¼Œå‰é¢ä¹Ÿè¯´äº†ï¼Œå®ƒæ˜¯ç»™ NioEventLoop ç”¨çš„ï¼Œä¸æ˜¯ç»™ NioEventLoopGroup ç”¨çš„ã€‚\npublic final class ThreadPerTaskExecutor implements Executor &#123;\n     private final ThreadFactory threadFactory;\n\n     public ThreadPerTaskExecutor(ThreadFactory threadFactory) &#123;\n           if (threadFactory == null) &#123;\n               throw new NullPointerException(\"threadFactory\");\n           &#125;\n           this.threadFactory = threadFactory;\n     &#125;\n\n     @Override\n     public void execute(Runnable command) &#123;\n           // ä¸ºæ¯ä¸ªä»»åŠ¡æ–°å»ºä¸€ä¸ªçº¿ç¨‹\n           threadFactory.newThread(command).start();\n     &#125;\n&#125;\n\nä¸Šä¸€æ­¥è®¾ç½®å®Œäº† executorï¼Œæˆ‘ä»¬ç»§ç»­å¾€ä¸‹çœ‹ï¼š\nprotected MultithreadEventExecutorGroup(int nThreads, Executor executor, Object...args) &#123;\n    this(nThreads, executor, DefaultEventExecutorChooserFactory.INSTANCE, args);\n&#125;\n\nè¿™ä¸€æ­¥è®¾ç½®äº† chooserFactoryï¼Œç”¨æ¥å®ç°ä»çº¿ç¨‹æ± ä¸­é€‰æ‹©ä¸€ä¸ªçº¿ç¨‹çš„é€‰æ‹©ç­–ç•¥ã€‚\n\n\n\n\n\n\n\n\n\nChooserFactory çš„é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œæˆ‘ä»¬çœ‹ä¸‹ DefaultEventExecutorChooserFactory çš„å®ç°ï¼š\nè¿™é‡Œè®¾ç½®çš„ç­–ç•¥ä¹Ÿå¾ˆç®€å•ï¼š\n1ã€å¦‚æœçº¿ç¨‹æ± çš„çº¿ç¨‹æ•°é‡æ˜¯ 2^nï¼Œé‡‡ç”¨ä¸‹é¢çš„æ–¹å¼ä¼šé«˜æ•ˆä¸€äº›ï¼š\n2ã€å¦‚æœä¸æ˜¯ï¼Œç”¨å–æ¨¡çš„æ–¹å¼ï¼š\n@Override\npublic EventExecutorChooser newChooser(EventExecutor[] executors) &#123;\n     if (isPowerOfTwo(executors.length)) &#123;\n           return new PowerOfTwoEventExecutorChooser(executors);\n     &#125; else &#123;\n           return new GenericEventExecutorChooser(executors);\n     &#125;\n&#125;\n\n@Override\npublic EventExecutor next() &#123;\n     return executors[idx.getAndIncrement() &amp; executors.length - 1];\n&#125;\n\n@Override\npublic EventExecutor next() &#123;\n     return executors[Math.abs(idx.getAndIncrement() % executors.length)];\n&#125;\n\nèµ°äº†è¿™ä¹ˆä¹…ï¼Œæˆ‘ä»¬ç»ˆäºåˆ°äº†ä¸€ä¸ªå¹²å®äº‹çš„æ„é€ æ–¹æ³•ä¸­äº†ã€‚\nio.netty.util.concurrent.MultithreadEventExecutorGroup\nprotected MultithreadEventExecutorGroup(int nThreads, Executor executor,\n                                        EventExecutorChooserFactory chooserFactory, Object... args) &#123;\n    if (nThreads &lt;= 0) &#123;\n        throw new IllegalArgumentException(String.format(\"nThreads: %d (expected: > 0)\", nThreads));\n    &#125;\n\n    // executor å¦‚æœæ˜¯ nullï¼Œåšä¸€æ¬¡å’Œå‰é¢ä¸€æ ·çš„é»˜è®¤è®¾ç½®ã€‚\n    if (executor == null) &#123;\n        executor = new ThreadPerTaskExecutor(newDefaultThreadFactory());\n    &#125;\n\n    // è¿™é‡Œçš„ children æ•°ç»„éå¸¸é‡è¦ï¼Œå®ƒå°±æ˜¯çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°ç»„ï¼Œè¿™ä¹ˆè¯´ä¸å¤ªä¸¥è°¨ï¼Œä½†æ˜¯å°±å¤§æ¦‚è¿™ä¸ªæ„æ€\n    children = new EventExecutor[nThreads];\n\n    // ä¸‹é¢è¿™ä¸ª for å¾ªç¯å°†å®ä¾‹åŒ– children æ•°ç»„ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ \n    for (int i = 0; i &lt; nThreads; i ++) &#123;\n        boolean success = false;\n        try &#123;\n            // å®ä¾‹åŒ–ï¼ï¼ï¼ï¼ï¼ï¼\n            children[i] = newChild(executor, args);\n            success = true;\n        &#125; catch (Exception e) &#123;\n            // TODO: Think about if this is a good exception type\n            throw new IllegalStateException(\"failed to create a child event loop\", e);\n        &#125; finally &#123;\n            // å¦‚æœæœ‰ä¸€ä¸ª child å®ä¾‹åŒ–å¤±è´¥ï¼Œé‚£ä¹ˆ success å°±ä¼šä¸º falseï¼Œç„¶åè¿›å…¥ä¸‹é¢çš„å¤±è´¥å¤„ç†é€»è¾‘\n            if (!success) &#123;\n                // æŠŠå·²ç»æˆåŠŸå®ä¾‹åŒ–çš„â€œçº¿ç¨‹â€ shutdownï¼Œshutdown æ˜¯å¼‚æ­¥æ“ä½œ\n                for (int j = 0; j &lt; i; j ++) &#123;\n                    children[j].shutdownGracefully();\n                &#125;\n\n                // ç­‰å¾…è¿™äº›çº¿ç¨‹æˆåŠŸ shutdown\n                for (int j = 0; j &lt; i; j ++) &#123;\n                    EventExecutor e = children[j];\n                    try &#123;\n                        while (!e.isTerminated()) &#123;\n                            e.awaitTermination(Integer.MAX_VALUE, TimeUnit.SECONDS);\n                        &#125;\n                    &#125; catch (InterruptedException interrupted) &#123;\n                        // æŠŠä¸­æ–­çŠ¶æ€è®¾ç½®å›å»ï¼Œäº¤ç»™å…³å¿ƒçš„çº¿ç¨‹æ¥å¤„ç†.\n                        Thread.currentThread().interrupt();\n                        break;\n                    &#125;\n                &#125;\n            &#125;\n        &#125;\n    &#125;\n    // ================================================\n    // === åˆ°è¿™é‡Œï¼Œå°±æ˜¯ä»£è¡¨ä¸Šé¢çš„å®ä¾‹åŒ–æ‰€æœ‰çº¿ç¨‹å·²ç»æˆåŠŸç»“æŸ ===\n    // ================================================\n\n    // é€šè¿‡ä¹‹å‰è®¾ç½®çš„ chooserFactory æ¥å®ä¾‹åŒ– Chooserï¼ŒæŠŠçº¿ç¨‹æ± æ•°ç»„ä¼ è¿›å»ï¼Œ\n    //     è¿™å°±ä¸å¿…å†è¯´äº†å§ï¼Œå®ç°çº¿ç¨‹é€‰æ‹©ç­–ç•¥\n    chooser = chooserFactory.newChooser(children);\n\n    // è®¾ç½®ä¸€ä¸ª Listener ç”¨æ¥ç›‘å¬è¯¥çº¿ç¨‹æ± çš„ termination äº‹ä»¶\n    // ä¸‹é¢çš„ä»£ç é€»è¾‘æ˜¯ï¼šç»™æ± ä¸­æ¯ä¸€ä¸ªçº¿ç¨‹éƒ½è®¾ç½®è¿™ä¸ª listenerï¼Œå½“ç›‘å¬åˆ°æ‰€æœ‰çº¿ç¨‹éƒ½ terminate ä»¥åï¼Œè¿™ä¸ªçº¿ç¨‹æ± å°±ç®—çœŸæ­£çš„ terminate äº†ã€‚\n    final FutureListener&lt;Object> terminationListener = new FutureListener&lt;Object>() &#123;\n        @Override\n        public void operationComplete(Future&lt;Object> future) throws Exception &#123;\n            if (terminatedChildren.incrementAndGet() == children.length) &#123;\n                terminationFuture.setSuccess(null);\n            &#125;\n        &#125;\n    &#125;;\n    for (EventExecutor e: children) &#123;\n        e.terminationFuture().addListener(terminationListener);\n    &#125;\n\n    // è®¾ç½® readonlyChildrenï¼Œå®ƒæ˜¯åªè¯»é›†åˆï¼Œä»¥åç”¨åˆ°å†è¯´\n    Set&lt;EventExecutor> childrenSet = new LinkedHashSet&lt;EventExecutor>(children.length);\n    Collections.addAll(childrenSet, children);\n    readonlyChildren = Collections.unmodifiableSet(childrenSet);\n&#125;\n\nä¸Šé¢çš„ä»£ç éå¸¸ç®€å•å§ï¼Œæ²¡æœ‰ä»€ä¹ˆéœ€è¦ç‰¹åˆ«è¯´çš„ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ newChild() è¿™ä¸ªæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•éå¸¸é‡è¦ï¼Œå®ƒå°†åˆ›å»ºçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹ã€‚\n\n\n\n\n\n\n\n\n\næˆ‘ä¸Šé¢å·²ç»ç”¨è¿‡å¾ˆå¤šæ¬¡â€çº¿ç¨‹â€è¿™ä¸ªè¯äº†ï¼Œå®ƒå¯ä¸æ˜¯ Thread çš„æ„æ€ï¼Œè€Œæ˜¯æŒ‡æ± ä¸­çš„ä¸ªä½“ï¼Œåé¢æˆ‘ä»¬ä¼šçœ‹åˆ°æ¯ä¸ªâ€çº¿ç¨‹â€åœ¨ä»€ä¹ˆæ—¶å€™ä¼šçœŸæ­£åˆ›å»º Thread å®ä¾‹ã€‚åæ­£æ¯ä¸ª NioEventLoop å®ä¾‹å†…éƒ¨éƒ½ä¼šæœ‰ä¸€ä¸ªè‡ªå·±çš„ Thread å®ä¾‹ï¼Œæ‰€ä»¥æŠŠè¿™ä¸¤ä¸ªæ¦‚å¿µæ··åœ¨ä¸€èµ·ä¹Ÿæ— æ‰€è°“å§ã€‚\nnewChild(â€¦) æ–¹æ³•åœ¨ NioEventLoopGroup ä¸­è¦†å†™äº†ï¼Œä¸Šé¢è¯´çš„â€çº¿ç¨‹â€å…¶å®å°±æ˜¯ NioEventLoopï¼š\n@Override\nprotected EventLoop newChild(Executor executor, Object... args) throws Exception &#123;\n    return new NioEventLoop(this, executor, (SelectorProvider) args[0],\n        ((SelectStrategyFactory) args[1]).newSelectStrategy(), (RejectedExecutionHandler) args[2]);\n&#125;\n\nå®ƒè°ƒç”¨äº† NioEventLoop çš„æ„é€ æ–¹æ³•ï¼š\nNioEventLoop(NioEventLoopGroup parent, Executor executor, SelectorProvider selectorProvider,\n             SelectStrategy strategy, RejectedExecutionHandler rejectedExecutionHandler) &#123;\n    // è°ƒç”¨çˆ¶ç±»æ„é€ å™¨\n    super(parent, executor, false, DEFAULT_MAX_PENDING_TASKS, rejectedExecutionHandler);\n    if (selectorProvider == null) &#123;\n        throw new NullPointerException(\"selectorProvider\");\n    &#125;\n    if (strategy == null) &#123;\n        throw new NullPointerException(\"selectStrategy\");\n    &#125;\n    provider = selectorProvider;\n    // å¼€å¯ NIO ä¸­æœ€é‡è¦çš„ç»„ä»¶ï¼šSelector\n    final SelectorTuple selectorTuple = openSelector();\n    selector = selectorTuple.selector;\n    unwrappedSelector = selectorTuple.unwrappedSelector;\n    selectStrategy = strategy;\n&#125;\n\næˆ‘ä»¬å…ˆç²—ç•¥è§‚å¯Ÿä¸€ä¸‹ï¼Œç„¶åå†å¾€ä¸‹çœ‹ï¼š\n\nåœ¨ Netty ä¸­ï¼ŒNioEventLoopGroup ä»£è¡¨çº¿ç¨‹æ± ï¼ŒNioEventLoop å°±æ˜¯å…¶ä¸­çš„çº¿ç¨‹ã€‚\nçº¿ç¨‹æ±  NioEventLoopGroup æ˜¯æ± ä¸­çš„çº¿ç¨‹ NioEventLoop çš„ parentï¼Œä»ä¸Šé¢çš„ä»£ç ä¸­çš„å–åå¯ä»¥çœ‹å‡ºã€‚\næ¯ä¸ª NioEventLoop éƒ½æœ‰è‡ªå·±çš„ Selectorï¼Œä¸Šé¢çš„ä»£ç ä¹Ÿååº”äº†è¿™ä¸€ç‚¹ï¼Œè¿™å’Œ Tomcat ä¸­çš„ NIO æ¨¡å‹æœ‰ç‚¹åŒºåˆ«ã€‚\nexecutorã€selectStrategy å’Œ rejectedExecutionHandler ä» NioEventLoopGroup ä¸­ä¸€è·¯ä¼ åˆ°äº† NioEventLoop ä¸­ã€‚\n\nè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ NioEventLoop ç±»çš„å±æ€§éƒ½æœ‰å“ªäº›ï¼Œæˆ‘ä»¬å…ˆå¿½ç•¥å®ƒç»§æ‰¿è‡ªçˆ¶ç±»çš„å±æ€§ï¼Œå•å•çœ‹å®ƒè‡ªå·±çš„ï¼š\nprivate Selector selector;\nprivate Selector unwrappedSelector;\nprivate SelectedSelectionKeySet selectedKeys;\n\nprivate final SelectorProvider provider;\n\nprivate final AtomicBoolean wakenUp = new AtomicBoolean();\n\nprivate final SelectStrategy selectStrategy;\n\nprivate volatile int ioRatio = 50;\nprivate int cancelledKeys;\nprivate boolean needsToSelectAgain;\n\nç»“åˆå®ƒçš„æ„é€ æ–¹æ³•æˆ‘ä»¬æ¥æ€»ç»“ä¸€ä¸‹ï¼š\n\nproviderï¼šå®ƒç”± NioEventLoopGroup ä¼ è¿›æ¥ï¼Œå‰é¢æˆ‘ä»¬è¯´äº†ä¸€ä¸ªçº¿ç¨‹æ± æœ‰ä¸€ä¸ª selectorProviderï¼Œç”¨äºåˆ›å»º Selector å®ä¾‹ \nselectorï¼šè™½ç„¶æˆ‘ä»¬è¿˜æ²¡çœ‹åˆ›å»º selector çš„ä»£ç ï¼Œä½†æˆ‘ä»¬å·²ç»çŸ¥é“ï¼Œåœ¨ Netty ä¸­ Selector æ˜¯è·Ÿç€çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹èµ°çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¹¶éä¸€ä¸ªçº¿ç¨‹æ± ä¸€ä¸ª Selector å®ä¾‹ï¼Œè€Œæ˜¯çº¿ç¨‹æ± ä¸­æ¯ä¸€ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ª Selector å®ä¾‹ã€‚\n\n\n\n\n\n\n\n\n\n\nåœ¨æ— å‚æ„é€ è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å‘ç°ï¼ŒNetty è®¾ç½®çº¿ç¨‹ä¸ªæ•°æ˜¯ CPU æ ¸å¿ƒæ•°çš„ä¸¤å€ï¼Œå‡è®¾æˆ‘ä»¬çš„æœºå™¨ CPU æ˜¯ 4 æ ¸ï¼Œé‚£ä¹ˆå¯¹åº”çš„å°±ä¼šæœ‰ 8 ä¸ª Selector å®ä¾‹ã€‚\n\nselectStrategyï¼šselect æ“ä½œçš„ç­–ç•¥ï¼Œè¿™ä¸ªä¸æ€¥ã€‚ \nioRatioï¼šè¿™æ˜¯ IO ä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´æ¯”ä¾‹ï¼Œå› ä¸ºæ¯ä¸ªçº¿ç¨‹æ—¢æœ‰ IO ä»»åŠ¡æ‰§è¡Œï¼Œä¹Ÿæœ‰é IO ä»»åŠ¡éœ€è¦æ‰§è¡Œï¼Œæ‰€ä»¥è¯¥å‚æ•°ä¸ºäº†ä¿è¯æœ‰è¶³å¤Ÿæ—¶é—´æ˜¯ç»™ IO çš„ã€‚è¿™é‡Œä¹Ÿä¸éœ€è¦æ€¥ç€å»ç†è§£ä»€ä¹ˆ IO ä»»åŠ¡ã€ä»€ä¹ˆé IO ä»»åŠ¡ã€‚\n\nç„¶åæˆ‘ä»¬ç»§ç»­èµ°å®ƒçš„æ„é€ æ–¹æ³•ï¼Œæˆ‘ä»¬çœ‹åˆ°ä¸Šé¢çš„æ„é€ æ–¹æ³•è°ƒç”¨äº†çˆ¶ç±»çš„æ„é€ å™¨ï¼Œå®ƒçš„çˆ¶ç±»æ˜¯ SingleThreadEventLoopã€‚\nio.netty.channel.SingleThreadEventLoop :\nprotected static final int DEFAULT_MAX_PENDING_TASKS = Math.max(16,\n        SystemPropertyUtil.getInt(\"io.netty.eventLoop.maxPendingTasks\", Integer.MAX_VALUE));\n\nprotected SingleThreadEventLoop(EventLoopGroup parent, ThreadFactory threadFactory,\n                                boolean addTaskWakesUp, int maxPendingTasks,\n                                RejectedExecutionHandler rejectedExecutionHandler) &#123;\n    super(parent, threadFactory, addTaskWakesUp, maxPendingTasks, rejectedExecutionHandler);\n    tailTasks = newTaskQueue(maxPendingTasks);\n&#125;\n\nSingleThreadEventLoop è¿™ä¸ªåå­—å¾ˆè¯¡å¼‚æœ‰æ²¡æœ‰ï¼Ÿç„¶åå®ƒçš„æ„é€ æ–¹æ³•åˆè°ƒç”¨äº†çˆ¶ç±» SingleThreadEventExecutor çš„æ„é€ æ–¹æ³•ã€‚\nio.netty.util.concurrent.SingleThreadEventExecutor ï¼š\nprotected SingleThreadEventExecutor(EventExecutorGroup parent, Executor executor,\n                                    boolean addTaskWakesUp, int maxPendingTasks,\n                                    RejectedExecutionHandler rejectedHandler) &#123;\n    super(parent);\n    this.addTaskWakesUp = addTaskWakesUp;\n    this.maxPendingTasks = Math.max(16, maxPendingTasks);\n    this.executor = ObjectUtil.checkNotNull(executor, \"executor\");\n    // taskQueueï¼Œè¿™ä¸ªä¸œè¥¿å¾ˆé‡è¦ï¼Œæäº¤ç»™ NioEventLoop çš„ä»»åŠ¡éƒ½ä¼šè¿›å…¥åˆ°è¿™ä¸ª taskQueue ä¸­ç­‰å¾…è¢«æ‰§è¡Œ\n    // è¿™ä¸ª queue çš„é»˜è®¤å®¹é‡æ˜¯ 16\n    taskQueue = newTaskQueue(this.maxPendingTasks);\n    rejectedExecutionHandler = ObjectUtil.checkNotNull(rejectedHandler, \"rejectedHandler\");\n&#125;\n\nprotected Queue&lt;Runnable> newTaskQueue(int maxPendingTasks) &#123;\n  \treturn new LinkedBlockingQueue&lt;Runnable>(maxPendingTasks);\n&#125;\n\n\nåˆ°è¿™é‡Œå°±æ›´åŠ è¯¡å¼‚äº†ï¼ŒNioEventLoop çš„çˆ¶ç±»æ˜¯ SingleThreadEventLoopï¼Œè€Œ SingleThreadEventLoop çš„çˆ¶ç±»æ˜¯ **SingleThreadEventExecutor**ï¼Œå®ƒçš„åå­—å‘Šè¯‰æˆ‘ä»¬ï¼Œå®ƒæ˜¯ä¸€ä¸ª Executorï¼Œæ˜¯ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œè€Œä¸”æ˜¯ Single Thread å•çº¿ç¨‹çš„ã€‚\nä¹Ÿå°±æ˜¯è¯´ï¼Œçº¿ç¨‹æ±  NioEventLoopGroup ä¸­çš„æ¯ä¸€ä¸ªçº¿ç¨‹ NioEventLoop ä¹Ÿå¯ä»¥å½“åšä¸€ä¸ªçº¿ç¨‹æ± æ¥ç”¨ï¼Œåªä¸è¿‡å®ƒåªæœ‰ä¸€ä¸ªçº¿ç¨‹ã€‚è¿™ç§è®¾è®¡è™½ç„¶çœ‹ä¸Šå»å¾ˆå·§å¦™ï¼Œä¸è¿‡æœ‰ç‚¹åäººç±»çš„æ ·å­ã€‚\nä¸Šé¢è¿™ä¸ªæ„é€ å‡½æ•°æ¯”è¾ƒç®€å•ï¼š\n\nè®¾ç½®äº† parentï¼Œä¹Ÿå°±æ˜¯ä¹‹å‰åˆ›å»ºçš„çº¿ç¨‹æ±  NioEventLoopGroup å®ä¾‹ \nexecutorï¼šå®ƒæ˜¯æˆ‘ä»¬ä¹‹å‰å®ä¾‹åŒ–çš„ ThreadPerTaskExecutorï¼Œæˆ‘ä»¬è¯´è¿‡ï¼Œè¿™ä¸ªä¸œè¥¿åœ¨çº¿ç¨‹æ± ä¸­æ²¡æœ‰ç”¨ï¼Œå®ƒæ˜¯ç»™ NioEventLoop ç”¨çš„ï¼Œé©¬ä¸Šæˆ‘ä»¬å°±è¦çœ‹åˆ°å®ƒäº†ã€‚æå‰é€éœ²ä¸€ä¸‹ï¼Œå®ƒç”¨æ¥å¼€å¯ NioEventLoop ä¸­çš„çº¿ç¨‹ï¼ˆThread å®ä¾‹ï¼‰ã€‚ \ntaskQueueï¼šè¿™ç®—æ˜¯è¯¥æ„é€ æ–¹æ³•ä¸­æ–°çš„ä¸œè¥¿ï¼Œå®ƒæ˜¯ä»»åŠ¡é˜Ÿåˆ—ã€‚æˆ‘ä»¬å‰é¢è¯´è¿‡ï¼ŒNioEventLoop éœ€è¦è´Ÿè´£ IO äº‹ä»¶å’Œé IO äº‹ä»¶ï¼Œé€šå¸¸å®ƒéƒ½åœ¨æ‰§è¡Œ selector çš„ select æ–¹æ³•æˆ–è€…æ­£åœ¨å¤„ç† selectedKeysï¼Œå¦‚æœæˆ‘ä»¬è¦ submit ä¸€ä¸ªä»»åŠ¡ç»™å®ƒï¼Œä»»åŠ¡å°±ä¼šè¢«æ”¾åˆ° taskQueue ä¸­ï¼Œç­‰å®ƒæ¥è½®è¯¢ã€‚ \nrejectedExecutionHandlerï¼štaskQueue çš„é»˜è®¤å®¹é‡æ˜¯ 16ï¼Œæ‰€ä»¥ï¼Œå¦‚æœ submit çš„ä»»åŠ¡å †ç§¯äº†åˆ°äº† 16ï¼Œå†å¾€é‡Œé¢æäº¤ä»»åŠ¡ä¼šè§¦å‘ rejectedExecutionHandler çš„æ‰§è¡Œç­–ç•¥ã€‚\n\n\n\n\n\n\n\n\n\n\nè¿˜è®°å¾—é»˜è®¤ç­–ç•¥å—ï¼šæŠ›å‡º RejectedExecutionException å¼‚å¸¸ã€‚\nåœ¨ NioEventLoopGroup çš„é»˜è®¤æ„é€ ä¸­ï¼Œå®ƒçš„å®ç°æ˜¯è¿™æ ·çš„ï¼š\nprivate static final RejectedExecutionHandler REJECT = new RejectedExecutionHandler() &#123;\n    @Override\n    public void rejected(Runnable task, SingleThreadEventExecutor executor) &#123;\n        throw new RejectedExecutionException();\n    &#125;\n&#125;;\n\n\nç„¶åï¼Œæˆ‘ä»¬å†å›åˆ° NioEventLoop çš„æ„é€ æ–¹æ³•ï¼š\nNioEventLoop(NioEventLoopGroup parent, Executor executor, SelectorProvider selectorProvider,\n             SelectStrategy strategy, RejectedExecutionHandler rejectedExecutionHandler) &#123;\n    // æˆ‘ä»¬åˆšåˆšè¯´å®Œäº†è¿™ä¸ª\n    super(parent, executor, false, DEFAULT_MAX_PENDING_TASKS, rejectedExecutionHandler);\n    if (selectorProvider == null) &#123;\n        throw new NullPointerException(\"selectorProvider\");\n    &#125;\n    if (strategy == null) &#123;\n        throw new NullPointerException(\"selectStrategy\");\n    &#125;\n    provider = selectorProvider;\n    // åˆ›å»º selector å®ä¾‹\n    final SelectorTuple selectorTuple = openSelector();\n    selector = selectorTuple.selector;\n    unwrappedSelector = selectorTuple.unwrappedSelector;\n\n    selectStrategy = strategy;\n&#125;\n\n\nå¯ä»¥çœ‹åˆ°ï¼Œæœ€é‡è¦çš„æ–¹æ³•å…¶å®å°±æ˜¯ openSelector() æ–¹æ³•ï¼Œå®ƒå°†åˆ›å»º NIO ä¸­æœ€é‡è¦çš„ä¸€ä¸ªç»„ä»¶ **Selector**ã€‚åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼ŒNetty ä¹Ÿåšäº†ä¸€äº›ä¼˜åŒ–ï¼Œè¿™éƒ¨åˆ†æˆ‘ä»¬å°±ä¸å»åˆ†æå®ƒäº†ã€‚\nåˆ°è¿™é‡Œï¼Œæˆ‘ä»¬çš„çº¿ç¨‹æ±  NioEventLoopGroup åˆ›å»ºå®Œæˆäº†ï¼Œå¹¶ä¸”å®ä¾‹åŒ–äº†æ± ä¸­çš„æ‰€æœ‰ NioEventLoop å®ä¾‹ã€‚\nåŒæ—¶ï¼Œå¤§å®¶åº”è¯¥å·²ç»çœ‹åˆ°ï¼Œä¸Šé¢å¹¶æ²¡æœ‰çœŸæ­£åˆ›å»º NioEventLoop ä¸­çš„çº¿ç¨‹ï¼ˆæ²¡æœ‰åˆ›å»º Thread å®ä¾‹ï¼‰ã€‚\næå‰é€éœ²ä¸€ä¸‹ï¼Œåˆ›å»ºçº¿ç¨‹çš„æ—¶æœºåœ¨ç¬¬ä¸€ä¸ªä»»åŠ¡æäº¤è¿‡æ¥çš„æ—¶å€™ï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªä»»åŠ¡æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå°±æ˜¯æˆ‘ä»¬å‰é¢è¯´çš„ channel çš„ **register** æ“ä½œã€‚\n\nNioEventLoop çš„å·¥ä½œæµç¨‹å‰é¢ï¼Œæˆ‘ä»¬åœ¨åˆ†æçº¿ç¨‹æ± çš„å®ä¾‹åŒ–çš„æ—¶å€™è¯´è¿‡ï¼ŒNioEventLoop ä¸­å¹¶æ²¡æœ‰å¯åŠ¨ Java çº¿ç¨‹ã€‚è¿™é‡Œæˆ‘ä»¬æ¥ä»”ç»†åˆ†æä¸‹åœ¨ register è¿‡ç¨‹ä¸­è°ƒç”¨çš„ **eventLoop.execute(runnable)** è¿™ä¸ªæ–¹æ³•ï¼Œè¿™ä¸ªä»£ç åœ¨çˆ¶ç±» SingleThreadEventExecutor ä¸­ã€‚\nio.netty.util.concurrent.SingleThreadEventExecutor#execute\n@Override\npublic void execute(Runnable task) &#123;\n    if (task == null) &#123;\n        throw new NullPointerException(\"task\");\n    &#125;\n    // åˆ¤æ–­æ·»åŠ ä»»åŠ¡çš„çº¿ç¨‹æ˜¯å¦å°±æ˜¯å½“å‰ EventLoop ä¸­çš„çº¿ç¨‹\n    boolean inEventLoop = inEventLoop();\n\n    // æ·»åŠ ä»»åŠ¡åˆ°ä¹‹å‰ä»‹ç»çš„ taskQueue ä¸­ï¼Œ\n    //     å¦‚æœ taskQueue æ»¡äº†(é»˜è®¤å¤§å° 16)ï¼Œæ ¹æ®æˆ‘ä»¬ä¹‹å‰è¯´çš„ï¼Œé»˜è®¤çš„ç­–ç•¥æ˜¯æŠ›å‡ºå¼‚å¸¸\n    addTask(task);\n\n    if (!inEventLoop) &#123;\n        // å¦‚æœä¸æ˜¯ NioEventLoop å†…éƒ¨çº¿ç¨‹æäº¤çš„ taskï¼Œé‚£ä¹ˆåˆ¤æ–­ä¸‹çº¿ç¨‹æ˜¯å¦å·²ç»å¯åŠ¨ï¼Œæ²¡æœ‰çš„è¯ï¼Œå°±å¯åŠ¨çº¿ç¨‹\n        startThread();\n        if (isShutdown() &amp;&amp; removeTask(task)) &#123;\n            reject();\n        &#125;\n    &#125;\n\n    if (!addTaskWakesUp &amp;&amp; wakesUpForTask(task)) &#123;\n        wakeup(inEventLoop);\n    &#125;\n&#125;\n\n\n\n\n\n\n\n\n\n\n\nåŸæ¥å¯åŠ¨ NioEventLoop ä¸­çš„çº¿ç¨‹çš„æ–¹æ³•åœ¨è¿™é‡Œã€‚\nå¦å¤–ï¼Œä¸ŠèŠ‚æˆ‘ä»¬è¯´çš„ register æ“ä½œè¿›åˆ°äº† taskQueue ä¸­ï¼Œæ‰€ä»¥å®ƒå…¶å®æ˜¯è¢«å½’ç±»åˆ°äº†é IO æ“ä½œçš„èŒƒç•´ã€‚\nä¸‹é¢æ˜¯ startThread çš„æºç ï¼Œåˆ¤æ–­çº¿ç¨‹æ˜¯å¦å·²ç»å¯åŠ¨æ¥å†³å®šæ˜¯å¦è¦è¿›è¡Œå¯åŠ¨æ“ä½œã€‚\nio.netty.util.concurrent.SingleThreadEventExecutor#startThread\nprivate void startThread() &#123;\n    if (state == ST_NOT_STARTED) &#123;\n        if (STATE_UPDATER.compareAndSet(this, ST_NOT_STARTED, ST_STARTED)) &#123;\n            try &#123;\n                doStartThread();\n            &#125; catch (Throwable cause) &#123;\n                STATE_UPDATER.set(this, ST_NOT_STARTED);\n                PlatformDependent.throwException(cause);\n            &#125;\n        &#125;\n    &#125;\n&#125;\n\n\næˆ‘ä»¬æŒ‰ç…§å‰é¢çš„æ€è·¯ï¼Œæ ¹æ®çº¿ç¨‹æ²¡æœ‰å¯åŠ¨çš„æƒ…å†µï¼Œæ¥çœ‹çœ‹ doStartThread() æ–¹æ³•ï¼š\nio.netty.util.concurrent.SingleThreadEventExecutor#doStartThread\nprivate void doStartThread() &#123;\n    assert thread == null;\n    // è¿™é‡Œçš„ executor å¤§å®¶æ˜¯ä¸æ˜¯æœ‰ç‚¹ç†Ÿæ‚‰çš„æ„Ÿè§‰ï¼Œå®ƒå°±æ˜¯ä¸€å¼€å§‹æˆ‘ä»¬å®ä¾‹åŒ– NioEventLoop çš„æ—¶å€™ä¼ è¿›æ¥çš„ ThreadPerTaskExecutor çš„å®ä¾‹ã€‚å®ƒæ˜¯æ¯æ¬¡æ¥ä¸€ä¸ªä»»åŠ¡ï¼Œåˆ›å»ºä¸€ä¸ªçº¿ç¨‹çš„é‚£ç§ executorã€‚\n    // ä¸€æ—¦æˆ‘ä»¬è°ƒç”¨å®ƒçš„ execute æ–¹æ³•ï¼Œå®ƒå°±ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹ï¼Œæ‰€ä»¥è¿™é‡Œç»ˆäºä¼šåˆ›å»º Thread å®ä¾‹\n    executor.execute(new Runnable() &#123;\n        @Override\n        public void run() &#123;\n            // çœ‹è¿™é‡Œï¼Œå°† â€œexecutorâ€ ä¸­åˆ›å»ºçš„è¿™ä¸ªçº¿ç¨‹è®¾ç½®ä¸º NioEventLoop çš„çº¿ç¨‹ï¼ï¼ï¼\n            thread = Thread.currentThread();\n\n            if (interrupted) &#123;\n                thread.interrupt();\n            &#125;\n\n            boolean success = false;\n            updateLastExecutionTime();\n            try &#123;\n                // æ‰§è¡Œ SingleThreadEventExecutor çš„ run() æ–¹æ³•ï¼Œå®ƒåœ¨ NioEventLoop ä¸­å®ç°äº†\n                SingleThreadEventExecutor.this.run();\n                success = true;\n            &#125; catch (Throwable t) &#123;\n                logger.warn(\"Unexpected exception from an event executor: \", t);\n            &#125; finally &#123;\n                // ... æˆ‘ä»¬ç›´æ¥å¿½ç•¥æ‰è¿™é‡Œçš„ä»£ç \n            &#125;\n        &#125;\n    &#125;);\n&#125;\n\n\nä¸Šé¢çº¿ç¨‹å¯åŠ¨ä»¥åï¼Œä¼šæ‰§è¡Œ NioEventLoop ä¸­çš„ run() æ–¹æ³•ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•è‚¯å®šæ˜¯æ²¡é‚£ä¹ˆå®¹æ˜“ç»“æŸçš„ï¼Œå¿…ç„¶æ˜¯åƒ JDK çº¿ç¨‹æ± çš„ Worker é‚£æ ·ï¼Œä¸æ–­åœ°å¾ªç¯è·å–æ–°çš„ä»»åŠ¡çš„ã€‚å®ƒéœ€è¦ä¸æ–­åœ°åš select æ“ä½œå’Œè½®è¯¢ taskQueue è¿™ä¸ªé˜Ÿåˆ—ã€‚\næˆ‘ä»¬å…ˆæ¥ç®€å•åœ°çœ‹ä¸€ä¸‹å®ƒçš„æºç ï¼Œè¿™é‡Œå…ˆä¸åšæ·±å…¥åœ°ä»‹ç»ã€‚\nio.netty.channel.nio.NioEventLoop#run\n@Override\nprotected void run() &#123;\n    // ä»£ç åµŒå¥—åœ¨ for å¾ªç¯ä¸­\n    for (;;) &#123;\n        try &#123;\n            // selectStrategy ç»ˆäºè¦æ´¾ä¸Šç”¨åœºäº†\n            // å®ƒæœ‰ä¸¤ä¸ªå€¼ï¼Œä¸€ä¸ªæ˜¯ CONTINUE ä¸€ä¸ªæ˜¯ SELECT\n            // é’ˆå¯¹è¿™å—ä»£ç ï¼Œæˆ‘ä»¬åˆ†æä¸€ä¸‹ã€‚\n            // 1. å¦‚æœ taskQueue ä¸ä¸ºç©ºï¼Œä¹Ÿå°±æ˜¯ hasTasks() è¿”å› trueï¼Œ\n            //         é‚£ä¹ˆæ‰§è¡Œä¸€æ¬¡ selectNow()ï¼Œè¯¥æ–¹æ³•ä¸ä¼šé˜»å¡\n            // 2. å¦‚æœ hasTasks() è¿”å› falseï¼Œé‚£ä¹ˆæ‰§è¡Œ SelectStrategy.SELECT åˆ†æ”¯ï¼Œ\n            //    è¿›è¡Œ select(...)ï¼Œè¿™å—æ˜¯å¸¦é˜»å¡çš„\n            // è¿™ä¸ªå¾ˆå¥½ç†è§£ï¼Œå°±æ˜¯æŒ‰ç…§æ˜¯å¦æœ‰ä»»åŠ¡åœ¨æ’é˜Ÿæ¥å†³å®šæ˜¯å¦å¯ä»¥è¿›è¡Œé˜»å¡\n            switch (selectStrategy.calculateStrategy(selectNowSupplier, hasTasks())) &#123;\n                case SelectStrategy.CONTINUE:\n                    continue;\n                case SelectStrategy.SELECT:\n                    // å¦‚æœ !hasTasks()ï¼Œé‚£ä¹ˆè¿›åˆ°è¿™ä¸ª select åˆ†æ”¯ï¼Œè¿™é‡Œ select å¸¦é˜»å¡çš„\n                    select(wakenUp.getAndSet(false));\n                    if (wakenUp.get()) &#123;\n                        selector.wakeup();\n                    &#125;\n                default:\n            &#125;\n\n\n            cancelledKeys = 0;\n            needsToSelectAgain = false;\n            // é»˜è®¤åœ°ï¼ŒioRatio çš„å€¼æ˜¯ 50\n            final int ioRatio = this.ioRatio;\n\n            if (ioRatio == 100) &#123;\n                // å¦‚æœ ioRatio è®¾ç½®ä¸º 100ï¼Œé‚£ä¹ˆå…ˆæ‰§è¡Œ IO æ“ä½œï¼Œç„¶ååœ¨ finally å—ä¸­æ‰§è¡Œ taskQueue ä¸­çš„ä»»åŠ¡\n                try &#123;\n                    // 1. æ‰§è¡Œ IO æ“ä½œã€‚å› ä¸ºå‰é¢ select ä»¥åï¼Œå¯èƒ½æœ‰äº› channel æ˜¯éœ€è¦å¤„ç†çš„ã€‚\n                    processSelectedKeys();\n                &#125; finally &#123;\n                    // 2. æ‰§è¡Œé IO ä»»åŠ¡ï¼Œä¹Ÿå°±æ˜¯ taskQueue ä¸­çš„ä»»åŠ¡\n                    runAllTasks();\n                &#125;\n            &#125; else &#123;\n                // å¦‚æœ ioRatio ä¸æ˜¯ 100ï¼Œé‚£ä¹ˆæ ¹æ® IO æ“ä½œè€—æ—¶ï¼Œé™åˆ¶é IO æ“ä½œè€—æ—¶\n                final long ioStartTime = System.nanoTime();\n                try &#123;\n                    // æ‰§è¡Œ IO æ“ä½œ\n                    processSelectedKeys();\n                &#125; finally &#123;\n                    // æ ¹æ® IO æ“ä½œæ¶ˆè€—çš„æ—¶é—´ï¼Œè®¡ç®—æ‰§è¡Œé IO æ“ä½œï¼ˆrunAllTasksï¼‰å¯ä»¥ç”¨å¤šå°‘æ—¶é—´.\n                    final long ioTime = System.nanoTime() - ioStartTime;\n                    runAllTasks(ioTime * (100 - ioRatio) / ioRatio);\n                &#125;\n            &#125;\n        &#125; catch (Throwable t) &#123;\n            handleLoopException(t);\n        &#125;\n        // Always handle shutdown even if the loop processing threw an exception.\n        try &#123;\n            if (isShuttingDown()) &#123;\n                closeAll();\n                if (confirmShutdown()) &#123;\n                    return;\n                &#125;\n            &#125;\n        &#125; catch (Throwable t) &#123;\n            handleLoopException(t);\n        &#125;\n    &#125;\n&#125;\n\n\nä¸Šé¢è¿™æ®µä»£ç æ˜¯ NioEventLoop çš„æ ¸å¿ƒï¼Œè¿™é‡Œä»‹ç»ä¸¤ç‚¹ï¼š\n\né¦–å…ˆï¼Œä¼šæ ¹æ® hasTasks() çš„ç»“æœæ¥å†³å®šæ˜¯æ‰§è¡Œ selectNow() è¿˜æ˜¯ select(oldWakenUp)ï¼Œè¿™ä¸ªåº”è¯¥å¥½ç†è§£ã€‚å¦‚æœæœ‰ä»»åŠ¡æ­£åœ¨ç­‰å¾…ï¼Œé‚£ä¹ˆåº”è¯¥ä½¿ç”¨æ— é˜»å¡çš„ selectNow()ï¼Œå¦‚æœæ²¡æœ‰ä»»åŠ¡åœ¨ç­‰å¾…ï¼Œé‚£ä¹ˆå°±å¯ä»¥ä½¿ç”¨å¸¦é˜»å¡çš„ select æ“ä½œã€‚\nioRatio æ§åˆ¶ IO æ“ä½œæ‰€å çš„æ—¶é—´æ¯”é‡ï¼š \nå¦‚æœè®¾ç½®ä¸º 100%ï¼Œé‚£ä¹ˆå…ˆæ‰§è¡Œ IO æ“ä½œï¼Œç„¶åå†æ‰§è¡Œä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚\nå¦‚æœä¸æ˜¯ 100%ï¼Œé‚£ä¹ˆå…ˆæ‰§è¡Œ IO æ“ä½œï¼Œç„¶åæ‰§è¡Œ taskQueue ä¸­çš„ä»»åŠ¡ï¼Œä½†æ˜¯éœ€è¦æ§åˆ¶æ‰§è¡Œä»»åŠ¡çš„æ€»æ—¶é—´ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œé IO æ“ä½œå¯ä»¥å ç”¨çš„æ—¶é—´ï¼Œé€šè¿‡ ioRatio ä»¥åŠè¿™æ¬¡ IO æ“ä½œè€—æ—¶è®¡ç®—å¾—å‡ºã€‚\n\n\n\næˆ‘ä»¬è¿™é‡Œå…ˆä¸è¦å»å…³å¿ƒ select(oldWakenUp) ã€processSelectedKeys() æ–¹æ³•å’Œ runAllTasks(â€¦) æ–¹æ³•çš„ç»†èŠ‚ï¼Œåªè¦å…ˆç†è§£å®ƒä»¬åˆ†åˆ«åšä»€ä¹ˆäº‹æƒ…å°±å¯ä»¥äº†ã€‚\nå›è¿‡ç¥æ¥ï¼Œæˆ‘ä»¬å‰é¢åœ¨ register çš„æ—¶å€™æäº¤äº† register ä»»åŠ¡ç»™ NioEventLoopï¼Œè¿™æ˜¯ NioEventLoop æ¥æ”¶åˆ°çš„ç¬¬ä¸€ä¸ªä»»åŠ¡ï¼Œæ‰€ä»¥è¿™é‡Œä¼šå®ä¾‹åŒ– Thread å¹¶ä¸”å¯åŠ¨ï¼Œç„¶åè¿›å…¥åˆ° NioEventLoop ä¸­çš„ run æ–¹æ³•ã€‚\n\n\n\n\n\n\n\n\n\nå½“ç„¶äº†ï¼Œå®é™…æƒ…å†µå¯èƒ½æ˜¯ï¼ŒChannel å®ä¾‹è¢« register åˆ°ä¸€ä¸ªå·²ç»å¯åŠ¨çº¿ç¨‹çš„ NioEventLoop å®ä¾‹ä¸­ã€‚\n","slug":"Nettyæºç åˆ†æ","date":"2022-06-11T08:38:37.855Z","categories_index":"æºç ","tags_index":"java,æºç ,Netty","author_index":"å°æä¸åœ¨_"},{"id":"fceed54d2b78e915f81cbddb878dcc7f","title":"SpringSecurity","content":"\n\n\n0. ç®€ä»‹Spring Security æ˜¯ Spring å®¶æ—ä¸­çš„ä¸€ä¸ªå®‰å…¨ç®¡ç†æ¡†æ¶ã€‚ç›¸æ¯”ä¸å¦å¤–ä¸€ä¸ªå®‰å…¨æ¡†æ¶Shiroï¼Œå®ƒæä¾›äº†æ›´ä¸°å¯Œçš„åŠŸèƒ½ï¼Œç¤¾åŒºèµ„æºä¹Ÿæ¯”Shiroä¸°å¯Œã€‚\n\nä¸€èˆ¬æ¥è¯´ä¸­å¤§å‹çš„é¡¹ç›®éƒ½æ˜¯ä½¿ç”¨SpringSecurity æ¥åšå®‰å…¨æ¡†æ¶ã€‚å°é¡¹ç›®æœ‰Shiroçš„æ¯”è¾ƒå¤šï¼Œå› ä¸ºç›¸æ¯”ä¸SpringSecurityï¼ŒShiroçš„ä¸Šæ‰‹æ›´åŠ çš„ç®€å•ã€‚\n\n ä¸€èˆ¬Webåº”ç”¨çš„éœ€è¦è¿›è¡Œè®¤è¯å’Œæˆæƒã€‚\n\n    è®¤è¯ï¼šéªŒè¯å½“å‰è®¿é—®ç³»ç»Ÿçš„æ˜¯ä¸æ˜¯æœ¬ç³»ç»Ÿçš„ç”¨æˆ·ï¼Œå¹¶ä¸”è¦ç¡®è®¤å…·ä½“æ˜¯å“ªä¸ªç”¨æˆ·\n\n    æˆæƒï¼šç»è¿‡è®¤è¯ååˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦æœ‰æƒé™è¿›è¡ŒæŸä¸ªæ“ä½œ\n\nè€Œè®¤è¯å’Œæˆæƒä¹Ÿæ˜¯SpringSecurityä½œä¸ºå®‰å…¨æ¡†æ¶çš„æ ¸å¿ƒåŠŸèƒ½ã€‚\n\n\n1. å¿«é€Ÿå…¥é—¨\n1.1 å‡†å¤‡å·¥ä½œæˆ‘ä»¬å…ˆè¦æ­å»ºä¸€ä¸ªç®€å•çš„SpringBootå·¥ç¨‹\n\nâ‘  è®¾ç½®çˆ¶å·¥ç¨‹ æ·»åŠ ä¾èµ–\n&lt;parent>\n    &lt;groupId>org.springframework.boot&lt;/groupId>\n    &lt;artifactId>spring-boot-starter-parent&lt;/artifactId>\n    &lt;version>2.5.0&lt;/version>\n&lt;/parent>\n&lt;dependencies>\n    &lt;dependency>\n        &lt;groupId>org.springframework.boot&lt;/groupId>\n        &lt;artifactId>spring-boot-starter-web&lt;/artifactId>\n    &lt;/dependency>\n    &lt;dependency>\n        &lt;groupId>org.projectlombok&lt;/groupId>\n        &lt;artifactId>lombok&lt;/artifactId>\n        &lt;optional>true&lt;/optional>\n    &lt;/dependency>\n&lt;/dependencies>\n\nâ‘¡ åˆ›å»ºå¯åŠ¨ç±»\n@SpringBootApplication\npublic class SecurityApplication &#123;\n\n    public static void main(String[] args) &#123;\n        SpringApplication.run(SecurityApplication.class,args);\n    &#125;\n&#125;\n\nâ‘¢ åˆ›å»ºController\n\nimport org.springframework.web.bind.annotation.RequestMapping;\nimport org.springframework.web.bind.annotation.RestController;\n\n@RestController\npublic class HelloController &#123;\n\n    @RequestMapping(\"/hello\")\n    public String hello()&#123;\n        return \"hello\";\n    &#125;\n&#125;\n\n\n1.2 å¼•å…¥SpringSecurityåœ¨SpringBooté¡¹ç›®ä¸­ä½¿ç”¨SpringSecurityæˆ‘ä»¬åªéœ€è¦å¼•å…¥ä¾èµ–å³å¯å®ç°å…¥é—¨æ¡ˆä¾‹ã€‚\n\n&lt;dependency>\n    &lt;groupId>org.springframework.boot&lt;/groupId>\n    &lt;artifactId>spring-boot-starter-security&lt;/artifactId>\n&lt;/dependency>\n\nå¼•å…¥ä¾èµ–åæˆ‘ä»¬åœ¨å°è¯•å»è®¿é—®ä¹‹å‰çš„æ¥å£å°±ä¼šè‡ªåŠ¨è·³è½¬åˆ°ä¸€ä¸ªSpringSecurityçš„é»˜è®¤ç™»é™†é¡µé¢ï¼Œé»˜è®¤ç”¨æˆ·åæ˜¯user,å¯†ç ä¼šè¾“å‡ºåœ¨æ§åˆ¶å°ã€‚\n\nå¿…é¡»ç™»é™†ä¹‹åæ‰èƒ½å¯¹æ¥å£è¿›è¡Œè®¿é—®ã€‚\n\n\n2. è®¤è¯\n2.1 ç™»é™†æ ¡éªŒæµç¨‹\n\n2.2 åŸç†åˆæ¢æƒ³è¦çŸ¥é“å¦‚ä½•å®ç°è‡ªå·±çš„ç™»é™†æµç¨‹å°±å¿…é¡»è¦å…ˆçŸ¥é“å…¥é—¨æ¡ˆä¾‹ä¸­SpringSecurityçš„æµç¨‹ã€‚\n\n\n2.2.1 SpringSecurityå®Œæ•´æµç¨‹SpringSecurityçš„åŸç†å…¶å®å°±æ˜¯ä¸€ä¸ªè¿‡æ»¤å™¨é“¾ï¼Œå†…éƒ¨åŒ…å«äº†æä¾›å„ç§åŠŸèƒ½çš„è¿‡æ»¤å™¨ã€‚è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹çœ‹å…¥é—¨æ¡ˆä¾‹ä¸­çš„è¿‡æ»¤å™¨ã€‚\n\n\nå›¾ä¸­åªå±•ç¤ºäº†æ ¸å¿ƒè¿‡æ»¤å™¨ï¼Œå…¶å®ƒçš„éæ ¸å¿ƒè¿‡æ»¤å™¨å¹¶æ²¡æœ‰åœ¨å›¾ä¸­å±•ç¤ºã€‚\n\nUsernamePasswordAuthenticationFilter:è´Ÿè´£å¤„ç†æˆ‘ä»¬åœ¨ç™»é™†é¡µé¢å¡«å†™äº†ç”¨æˆ·åå¯†ç åçš„ç™»é™†è¯·æ±‚ã€‚å…¥é—¨æ¡ˆä¾‹çš„è®¤è¯å·¥ä½œä¸»è¦æœ‰å®ƒè´Ÿè´£ã€‚\nExceptionTranslationFilterï¼šå¤„ç†è¿‡æ»¤å™¨é“¾ä¸­æŠ›å‡ºçš„ä»»ä½•AccessDeniedExceptionå’ŒAuthenticationException ã€‚\nFilterSecurityInterceptorï¼šè´Ÿè´£æƒé™æ ¡éªŒçš„è¿‡æ»¤å™¨ã€‚\næˆ‘ä»¬å¯ä»¥é€šè¿‡DebugæŸ¥çœ‹å½“å‰ç³»ç»Ÿä¸­SpringSecurityè¿‡æ»¤å™¨é“¾ä¸­æœ‰å“ªäº›è¿‡æ»¤å™¨åŠå®ƒä»¬çš„é¡ºåºã€‚\n\n\n\n2.2.2 è®¤è¯æµç¨‹è¯¦è§£\næ¦‚å¿µé€ŸæŸ¥:\nAuthenticationæ¥å£: å®ƒçš„å®ç°ç±»ï¼Œè¡¨ç¤ºå½“å‰è®¿é—®ç³»ç»Ÿçš„ç”¨æˆ·ï¼Œå°è£…äº†ç”¨æˆ·ç›¸å…³ä¿¡æ¯ã€‚\nAuthenticationManageræ¥å£ï¼šå®šä¹‰äº†è®¤è¯Authenticationçš„æ–¹æ³•\nUserDetailsServiceæ¥å£ï¼šåŠ è½½ç”¨æˆ·ç‰¹å®šæ•°æ®çš„æ ¸å¿ƒæ¥å£ã€‚é‡Œé¢å®šä¹‰äº†ä¸€ä¸ªæ ¹æ®ç”¨æˆ·åæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯çš„æ–¹æ³•ã€‚\nUserDetailsæ¥å£ï¼šæä¾›æ ¸å¿ƒç”¨æˆ·ä¿¡æ¯ã€‚é€šè¿‡UserDetailsServiceæ ¹æ®ç”¨æˆ·åè·å–å¤„ç†çš„ç”¨æˆ·ä¿¡æ¯è¦å°è£…æˆUserDetailså¯¹è±¡è¿”å›ã€‚ç„¶åå°†è¿™äº›ä¿¡æ¯å°è£…åˆ°Authenticationå¯¹è±¡ä¸­ã€‚\n\n2.3 è§£å†³é—®é¢˜\n2.3.1 æ€è·¯åˆ†æç™»å½•\nâ‘ è‡ªå®šä¹‰ç™»å½•æ¥å£\n\n            è°ƒç”¨ProviderManagerçš„æ–¹æ³•è¿›è¡Œè®¤è¯ å¦‚æœè®¤è¯é€šè¿‡ç”Ÿæˆjwt\n\n            æŠŠç”¨æˆ·ä¿¡æ¯å­˜å…¥redisä¸­\n\nâ‘¡è‡ªå®šä¹‰UserDetailsService\n\n            åœ¨è¿™ä¸ªå®ç°ç±»ä¸­å»æŸ¥è¯¢æ•°æ®åº“\n\næ ¡éªŒï¼š\nâ‘ å®šä¹‰Jwtè®¤è¯è¿‡æ»¤å™¨\n\n            è·å–token\n\n            è§£ætokenè·å–å…¶ä¸­çš„userid\n\n            ä»redisä¸­è·å–ç”¨æˆ·ä¿¡æ¯\n\n            å­˜å…¥SecurityContextHolder\n\n\n2.3.2 å‡†å¤‡å·¥ä½œâ‘ æ·»åŠ ä¾èµ–\n&lt;!--redisä¾èµ–-->\n&lt;dependency>\n    &lt;groupId>org.springframework.boot&lt;/groupId>\n    &lt;artifactId>spring-boot-starter-data-redis&lt;/artifactId>\n&lt;/dependency>\n&lt;!--fastjsonä¾èµ–-->\n&lt;dependency>\n    &lt;groupId>com.alibaba&lt;/groupId>\n    &lt;artifactId>fastjson&lt;/artifactId>\n    &lt;version>1.2.33&lt;/version>\n&lt;/dependency>\n&lt;!--jwtä¾èµ–-->\n&lt;dependency>\n    &lt;groupId>io.jsonwebtoken&lt;/groupId>\n    &lt;artifactId>jjwt&lt;/artifactId>\n    &lt;version>0.9.0&lt;/version>\n&lt;/dependency>\n\nâ‘¡ æ·»åŠ Redisç›¸å…³é…ç½®\n\nimport com.alibaba.fastjson.JSON;\nimport com.alibaba.fastjson.serializer.SerializerFeature;\nimport com.fasterxml.jackson.databind.JavaType;\nimport com.fasterxml.jackson.databind.ObjectMapper;\nimport com.fasterxml.jackson.databind.type.TypeFactory;\nimport org.springframework.data.redis.serializer.RedisSerializer;\nimport org.springframework.data.redis.serializer.SerializationException;\nimport com.alibaba.fastjson.parser.ParserConfig;\nimport org.springframework.util.Assert;\nimport java.nio.charset.Charset;\n\n/**\n * Redisä½¿ç”¨FastJsonåºåˆ—åŒ–\n * \n * @author sg\n */\npublic class FastJsonRedisSerializer&lt;T> implements RedisSerializer&lt;T>\n&#123;\n\n    public static final Charset DEFAULT_CHARSET = Charset.forName(\"UTF-8\");\n\n    private Class&lt;T> clazz;\n\n    static\n    &#123;\n        ParserConfig.getGlobalInstance().setAutoTypeSupport(true);\n    &#125;\n\n    public FastJsonRedisSerializer(Class&lt;T> clazz)\n    &#123;\n        super();\n        this.clazz = clazz;\n    &#125;\n\n    @Override\n    public byte[] serialize(T t) throws SerializationException\n    &#123;\n        if (t == null)\n        &#123;\n            return new byte[0];\n        &#125;\n        return JSON.toJSONString(t, SerializerFeature.WriteClassName).getBytes(DEFAULT_CHARSET);\n    &#125;\n\n    @Override\n    public T deserialize(byte[] bytes) throws SerializationException\n    &#123;\n        if (bytes == null || bytes.length &lt;= 0)\n        &#123;\n            return null;\n        &#125;\n        String str = new String(bytes, DEFAULT_CHARSET);\n\n        return JSON.parseObject(str, clazz);\n    &#125;\n\n\n    protected JavaType getJavaType(Class&lt;?> clazz)\n    &#123;\n        return TypeFactory.defaultInstance().constructType(clazz);\n    &#125;\n&#125;\n\n\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.data.redis.connection.RedisConnectionFactory;\nimport org.springframework.data.redis.core.RedisTemplate;\nimport org.springframework.data.redis.serializer.StringRedisSerializer;\n\n@Configuration\npublic class RedisConfig &#123;\n\n    @Bean\n    @SuppressWarnings(value = &#123; \"unchecked\", \"rawtypes\" &#125;)\n    public RedisTemplate&lt;Object, Object> redisTemplate(RedisConnectionFactory connectionFactory)\n    &#123;\n        RedisTemplate&lt;Object, Object> template = new RedisTemplate&lt;>();\n        template.setConnectionFactory(connectionFactory);\n\n        FastJsonRedisSerializer serializer = new FastJsonRedisSerializer(Object.class);\n\n        // ä½¿ç”¨StringRedisSerializeræ¥åºåˆ—åŒ–å’Œååºåˆ—åŒ–redisçš„keyå€¼\n        template.setKeySerializer(new StringRedisSerializer());\n        template.setValueSerializer(serializer);\n\n        // Hashçš„keyä¹Ÿé‡‡ç”¨StringRedisSerializerçš„åºåˆ—åŒ–æ–¹å¼\n        template.setHashKeySerializer(new StringRedisSerializer());\n        template.setHashValueSerializer(serializer);\n\n        template.afterPropertiesSet();\n        return template;\n    &#125;\n&#125;\n\nâ‘¢ å“åº”ç±»\n\nimport com.fasterxml.jackson.annotation.JsonInclude;\n\n/**\n * @Author ä¸‰æ›´  Bç«™ï¼š https://space.bilibili.com/663528522\n */\n@JsonInclude(JsonInclude.Include.NON_NULL)\npublic class ResponseResult&lt;T> &#123;\n    /**\n     * çŠ¶æ€ç \n     */\n    private Integer code;\n    /**\n     * æç¤ºä¿¡æ¯ï¼Œå¦‚æœæœ‰é”™è¯¯æ—¶ï¼Œå‰ç«¯å¯ä»¥è·å–è¯¥å­—æ®µè¿›è¡Œæç¤º\n     */\n    private String msg;\n    /**\n     * æŸ¥è¯¢åˆ°çš„ç»“æœæ•°æ®ï¼Œ\n     */\n    private T data;\n\n    public ResponseResult(Integer code, String msg) &#123;\n        this.code = code;\n        this.msg = msg;\n    &#125;\n\n    public ResponseResult(Integer code, T data) &#123;\n        this.code = code;\n        this.data = data;\n    &#125;\n\n    public Integer getCode() &#123;\n        return code;\n    &#125;\n\n    public void setCode(Integer code) &#123;\n        this.code = code;\n    &#125;\n\n    public String getMsg() &#123;\n        return msg;\n    &#125;\n\n    public void setMsg(String msg) &#123;\n        this.msg = msg;\n    &#125;\n\n    public T getData() &#123;\n        return data;\n    &#125;\n\n    public void setData(T data) &#123;\n        this.data = data;\n    &#125;\n\n    public ResponseResult(Integer code, String msg, T data) &#123;\n        this.code = code;\n        this.msg = msg;\n        this.data = data;\n    &#125;\n&#125;\n\nâ‘£å·¥å…·ç±»\n\nimport io.jsonwebtoken.Claims;\nimport io.jsonwebtoken.JwtBuilder;\nimport io.jsonwebtoken.Jwts;\nimport io.jsonwebtoken.SignatureAlgorithm;\n\nimport javax.crypto.SecretKey;\nimport javax.crypto.spec.SecretKeySpec;\nimport java.util.Base64;\nimport java.util.Date;\nimport java.util.UUID;\n\n/**\n * JWTå·¥å…·ç±»\n */\npublic class JwtUtil &#123;\n\n    //æœ‰æ•ˆæœŸä¸º\n    public static final Long JWT_TTL = 60 * 60 *1000L;// 60 * 60 *1000  ä¸€ä¸ªå°æ—¶\n    //è®¾ç½®ç§˜é’¥æ˜æ–‡\n    public static final String JWT_KEY = \"sangeng\";\n\n    public static String getUUID()&#123;\n        String token = UUID.randomUUID().toString().replaceAll(\"-\", \"\");\n        return token;\n    &#125;\n    \n    /**\n     * ç”Ÿæˆjtw\n     * @param subject tokenä¸­è¦å­˜æ”¾çš„æ•°æ®ï¼ˆjsonæ ¼å¼ï¼‰\n     * @return\n     */\n    public static String createJWT(String subject) &#123;\n        JwtBuilder builder = getJwtBuilder(subject, null, getUUID());// è®¾ç½®è¿‡æœŸæ—¶é—´\n        return builder.compact();\n    &#125;\n\n    /**\n     * ç”Ÿæˆjtw\n     * @param subject tokenä¸­è¦å­˜æ”¾çš„æ•°æ®ï¼ˆjsonæ ¼å¼ï¼‰\n     * @param ttlMillis tokenè¶…æ—¶æ—¶é—´\n     * @return\n     */\n    public static String createJWT(String subject, Long ttlMillis) &#123;\n        JwtBuilder builder = getJwtBuilder(subject, ttlMillis, getUUID());// è®¾ç½®è¿‡æœŸæ—¶é—´\n        return builder.compact();\n    &#125;\n\n    private static JwtBuilder getJwtBuilder(String subject, Long ttlMillis, String uuid) &#123;\n        SignatureAlgorithm signatureAlgorithm = SignatureAlgorithm.HS256;\n        SecretKey secretKey = generalKey();\n        long nowMillis = System.currentTimeMillis();\n        Date now = new Date(nowMillis);\n        if(ttlMillis==null)&#123;\n            ttlMillis=JwtUtil.JWT_TTL;\n        &#125;\n        long expMillis = nowMillis + ttlMillis;\n        Date expDate = new Date(expMillis);\n        return Jwts.builder()\n                .setId(uuid)              //å”¯ä¸€çš„ID\n                .setSubject(subject)   // ä¸»é¢˜  å¯ä»¥æ˜¯JSONæ•°æ®\n                .setIssuer(\"sg\")     // ç­¾å‘è€…\n                .setIssuedAt(now)      // ç­¾å‘æ—¶é—´\n                .signWith(signatureAlgorithm, secretKey) //ä½¿ç”¨HS256å¯¹ç§°åŠ å¯†ç®—æ³•ç­¾å, ç¬¬äºŒä¸ªå‚æ•°ä¸ºç§˜é’¥\n                .setExpiration(expDate);\n    &#125;\n\n    /**\n     * åˆ›å»ºtoken\n     * @param id\n     * @param subject\n     * @param ttlMillis\n     * @return\n     */\n    public static String createJWT(String id, String subject, Long ttlMillis) &#123;\n        JwtBuilder builder = getJwtBuilder(subject, ttlMillis, id);// è®¾ç½®è¿‡æœŸæ—¶é—´\n        return builder.compact();\n    &#125;\n\n    public static void main(String[] args) throws Exception &#123;\n        String token = \"eyJhbGciOiJIUzI1NiJ9.eyJqdGkiOiJjYWM2ZDVhZi1mNjVlLTQ0MDAtYjcxMi0zYWEwOGIyOTIwYjQiLCJzdWIiOiJzZyIsImlzcyI6InNnIiwiaWF0IjoxNjM4MTA2NzEyLCJleHAiOjE2MzgxMTAzMTJ9.JVsSbkP94wuczb4QryQbAke3ysBDIL5ou8fWsbt_ebg\";\n        Claims claims = parseJWT(token);\n        System.out.println(claims);\n    &#125;\n\n    /**\n     * ç”ŸæˆåŠ å¯†åçš„ç§˜é’¥ secretKey\n     * @return\n     */\n    public static SecretKey generalKey() &#123;\n        byte[] encodedKey = Base64.getDecoder().decode(JwtUtil.JWT_KEY);\n        SecretKey key = new SecretKeySpec(encodedKey, 0, encodedKey.length, \"AES\");\n        return key;\n    &#125;\n    \n    /**\n     * è§£æ\n     *\n     * @param jwt\n     * @return\n     * @throws Exception\n     */\n    public static Claims parseJWT(String jwt) throws Exception &#123;\n        SecretKey secretKey = generalKey();\n        return Jwts.parser()\n                .setSigningKey(secretKey)\n                .parseClaimsJws(jwt)\n                .getBody();\n    &#125;\n\n\n&#125;\n\n\nimport java.util.*;\nimport java.util.concurrent.TimeUnit;\n\n@SuppressWarnings(value = &#123; \"unchecked\", \"rawtypes\" &#125;)\n@Component\npublic class RedisCache\n&#123;\n    @Autowired\n    public RedisTemplate redisTemplate;\n\n    /**\n     * ç¼“å­˜åŸºæœ¬çš„å¯¹è±¡ï¼ŒIntegerã€Stringã€å®ä½“ç±»ç­‰\n     *\n     * @param key ç¼“å­˜çš„é”®å€¼\n     * @param value ç¼“å­˜çš„å€¼\n     */\n    public &lt;T> void setCacheObject(final String key, final T value)\n    &#123;\n        redisTemplate.opsForValue().set(key, value);\n    &#125;\n\n    /**\n     * ç¼“å­˜åŸºæœ¬çš„å¯¹è±¡ï¼ŒIntegerã€Stringã€å®ä½“ç±»ç­‰\n     *\n     * @param key ç¼“å­˜çš„é”®å€¼\n     * @param value ç¼“å­˜çš„å€¼\n     * @param timeout æ—¶é—´\n     * @param timeUnit æ—¶é—´é¢—ç²’åº¦\n     */\n    public &lt;T> void setCacheObject(final String key, final T value, final Integer timeout, final TimeUnit timeUnit)\n    &#123;\n        redisTemplate.opsForValue().set(key, value, timeout, timeUnit);\n    &#125;\n\n    /**\n     * è®¾ç½®æœ‰æ•ˆæ—¶é—´\n     *\n     * @param key Redisé”®\n     * @param timeout è¶…æ—¶æ—¶é—´\n     * @return true=è®¾ç½®æˆåŠŸï¼›false=è®¾ç½®å¤±è´¥\n     */\n    public boolean expire(final String key, final long timeout)\n    &#123;\n        return expire(key, timeout, TimeUnit.SECONDS);\n    &#125;\n\n    /**\n     * è®¾ç½®æœ‰æ•ˆæ—¶é—´\n     *\n     * @param key Redisé”®\n     * @param timeout è¶…æ—¶æ—¶é—´\n     * @param unit æ—¶é—´å•ä½\n     * @return true=è®¾ç½®æˆåŠŸï¼›false=è®¾ç½®å¤±è´¥\n     */\n    public boolean expire(final String key, final long timeout, final TimeUnit unit)\n    &#123;\n        return redisTemplate.expire(key, timeout, unit);\n    &#125;\n\n    /**\n     * è·å¾—ç¼“å­˜çš„åŸºæœ¬å¯¹è±¡ã€‚\n     *\n     * @param key ç¼“å­˜é”®å€¼\n     * @return ç¼“å­˜é”®å€¼å¯¹åº”çš„æ•°æ®\n     */\n    public &lt;T> T getCacheObject(final String key)\n    &#123;\n        ValueOperations&lt;String, T> operation = redisTemplate.opsForValue();\n        return operation.get(key);\n    &#125;\n\n    /**\n     * åˆ é™¤å•ä¸ªå¯¹è±¡\n     *\n     * @param key\n     */\n    public boolean deleteObject(final String key)\n    &#123;\n        return redisTemplate.delete(key);\n    &#125;\n\n    /**\n     * åˆ é™¤é›†åˆå¯¹è±¡\n     *\n     * @param collection å¤šä¸ªå¯¹è±¡\n     * @return\n     */\n    public long deleteObject(final Collection collection)\n    &#123;\n        return redisTemplate.delete(collection);\n    &#125;\n\n    /**\n     * ç¼“å­˜Listæ•°æ®\n     *\n     * @param key ç¼“å­˜çš„é”®å€¼\n     * @param dataList å¾…ç¼“å­˜çš„Listæ•°æ®\n     * @return ç¼“å­˜çš„å¯¹è±¡\n     */\n    public &lt;T> long setCacheList(final String key, final List&lt;T> dataList)\n    &#123;\n        Long count = redisTemplate.opsForList().rightPushAll(key, dataList);\n        return count == null ? 0 : count;\n    &#125;\n\n    /**\n     * è·å¾—ç¼“å­˜çš„listå¯¹è±¡\n     *\n     * @param key ç¼“å­˜çš„é”®å€¼\n     * @return ç¼“å­˜é”®å€¼å¯¹åº”çš„æ•°æ®\n     */\n    public &lt;T> List&lt;T> getCacheList(final String key)\n    &#123;\n        return redisTemplate.opsForList().range(key, 0, -1);\n    &#125;\n\n    /**\n     * ç¼“å­˜Set\n     *\n     * @param key ç¼“å­˜é”®å€¼\n     * @param dataSet ç¼“å­˜çš„æ•°æ®\n     * @return ç¼“å­˜æ•°æ®çš„å¯¹è±¡\n     */\n    public &lt;T> BoundSetOperations&lt;String, T> setCacheSet(final String key, final Set&lt;T> dataSet)\n    &#123;\n        BoundSetOperations&lt;String, T> setOperation = redisTemplate.boundSetOps(key);\n        Iterator&lt;T> it = dataSet.iterator();\n        while (it.hasNext())\n        &#123;\n            setOperation.add(it.next());\n        &#125;\n        return setOperation;\n    &#125;\n\n    /**\n     * è·å¾—ç¼“å­˜çš„set\n     *\n     * @param key\n     * @return\n     */\n    public &lt;T> Set&lt;T> getCacheSet(final String key)\n    &#123;\n        return redisTemplate.opsForSet().members(key);\n    &#125;\n\n    /**\n     * ç¼“å­˜Map\n     *\n     * @param key\n     * @param dataMap\n     */\n    public &lt;T> void setCacheMap(final String key, final Map&lt;String, T> dataMap)\n    &#123;\n        if (dataMap != null) &#123;\n            redisTemplate.opsForHash().putAll(key, dataMap);\n        &#125;\n    &#125;\n\n    /**\n     * è·å¾—ç¼“å­˜çš„Map\n     *\n     * @param key\n     * @return\n     */\n    public &lt;T> Map&lt;String, T> getCacheMap(final String key)\n    &#123;\n        return redisTemplate.opsForHash().entries(key);\n    &#125;\n\n    /**\n     * å¾€Hashä¸­å­˜å…¥æ•°æ®\n     *\n     * @param key Redisé”®\n     * @param hKey Hashé”®\n     * @param value å€¼\n     */\n    public &lt;T> void setCacheMapValue(final String key, final String hKey, final T value)\n    &#123;\n        redisTemplate.opsForHash().put(key, hKey, value);\n    &#125;\n\n    /**\n     * è·å–Hashä¸­çš„æ•°æ®\n     *\n     * @param key Redisé”®\n     * @param hKey Hashé”®\n     * @return Hashä¸­çš„å¯¹è±¡\n     */\n    public &lt;T> T getCacheMapValue(final String key, final String hKey)\n    &#123;\n        HashOperations&lt;String, String, T> opsForHash = redisTemplate.opsForHash();\n        return opsForHash.get(key, hKey);\n    &#125;\n\n    /**\n     * åˆ é™¤Hashä¸­çš„æ•°æ®\n     * \n     * @param key\n     * @param hkey\n     */\n    public void delCacheMapValue(final String key, final String hkey)\n    &#123;\n        HashOperations hashOperations = redisTemplate.opsForHash();\n        hashOperations.delete(key, hkey);\n    &#125;\n\n    /**\n     * è·å–å¤šä¸ªHashä¸­çš„æ•°æ®\n     *\n     * @param key Redisé”®\n     * @param hKeys Hashé”®é›†åˆ\n     * @return Hashå¯¹è±¡é›†åˆ\n     */\n    public &lt;T> List&lt;T> getMultiCacheMapValue(final String key, final Collection&lt;Object> hKeys)\n    &#123;\n        return redisTemplate.opsForHash().multiGet(key, hKeys);\n    &#125;\n\n    /**\n     * è·å¾—ç¼“å­˜çš„åŸºæœ¬å¯¹è±¡åˆ—è¡¨\n     *\n     * @param pattern å­—ç¬¦ä¸²å‰ç¼€\n     * @return å¯¹è±¡åˆ—è¡¨\n     */\n    public Collection&lt;String> keys(final String pattern)\n    &#123;\n        return redisTemplate.keys(pattern);\n    &#125;\n&#125;\n\n\nimport javax.servlet.http.HttpServletResponse;\nimport java.io.IOException;\n\npublic class WebUtils\n&#123;\n    /**\n     * å°†å­—ç¬¦ä¸²æ¸²æŸ“åˆ°å®¢æˆ·ç«¯\n     * \n     * @param response æ¸²æŸ“å¯¹è±¡\n     * @param string å¾…æ¸²æŸ“çš„å­—ç¬¦ä¸²\n     * @return null\n     */\n    public static String renderString(HttpServletResponse response, String string) &#123;\n        try\n        &#123;\n            response.setStatus(200);\n            response.setContentType(\"application/json\");\n            response.setCharacterEncoding(\"utf-8\");\n            response.getWriter().print(string);\n        &#125;\n        catch (IOException e)\n        &#123;\n            e.printStackTrace();\n        &#125;\n        return null;\n    &#125;\n&#125;\n\nâ‘¤å®ä½“ç±»\nimport java.io.Serializable;\nimport java.util.Date;\n\n\n/**\n * ç”¨æˆ·è¡¨(User)å®ä½“ç±»\n *\n * @author ä¸‰æ›´\n */\n@Data\n@AllArgsConstructor\n@NoArgsConstructor\npublic class User implements Serializable &#123;\n    private static final long serialVersionUID = -40356785423868312L;\n    \n    /**\n    * ä¸»é”®\n    */\n    private Long id;\n    /**\n    * ç”¨æˆ·å\n    */\n    private String userName;\n    /**\n    * æ˜µç§°\n    */\n    private String nickName;\n    /**\n    * å¯†ç \n    */\n    private String password;\n    /**\n    * è´¦å·çŠ¶æ€ï¼ˆ0æ­£å¸¸ 1åœç”¨ï¼‰\n    */\n    private String status;\n    /**\n    * é‚®ç®±\n    */\n    private String email;\n    /**\n    * æ‰‹æœºå·\n    */\n    private String phonenumber;\n    /**\n    * ç”¨æˆ·æ€§åˆ«ï¼ˆ0ç”·ï¼Œ1å¥³ï¼Œ2æœªçŸ¥ï¼‰\n    */\n    private String sex;\n    /**\n    * å¤´åƒ\n    */\n    private String avatar;\n    /**\n    * ç”¨æˆ·ç±»å‹ï¼ˆ0ç®¡ç†å‘˜ï¼Œ1æ™®é€šç”¨æˆ·ï¼‰\n    */\n    private String userType;\n    /**\n    * åˆ›å»ºäººçš„ç”¨æˆ·id\n    */\n    private Long createBy;\n    /**\n    * åˆ›å»ºæ—¶é—´\n    */\n    private Date createTime;\n    /**\n    * æ›´æ–°äºº\n    */\n    private Long updateBy;\n    /**\n    * æ›´æ–°æ—¶é—´\n    */\n    private Date updateTime;\n    /**\n    * åˆ é™¤æ ‡å¿—ï¼ˆ0ä»£è¡¨æœªåˆ é™¤ï¼Œ1ä»£è¡¨å·²åˆ é™¤ï¼‰\n    */\n    private Integer delFlag;\n&#125;\n\n\n2.3.3 å®ç°\n2.3.3.1 æ•°æ®åº“æ ¡éªŒç”¨æˆ·ä»ä¹‹å‰çš„åˆ†ææˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ªUserDetailsService,è®©SpringSecurityä½¿ç”¨æˆ‘ä»¬çš„UserDetailsServiceã€‚æˆ‘ä»¬è‡ªå·±çš„UserDetailsServiceå¯ä»¥ä»æ•°æ®åº“ä¸­æŸ¥è¯¢ç”¨æˆ·åå’Œå¯†ç ã€‚\n\n\nå‡†å¤‡å·¥ä½œæˆ‘ä»¬å…ˆåˆ›å»ºä¸€ä¸ªç”¨æˆ·è¡¨ï¼Œ å»ºè¡¨è¯­å¥å¦‚ä¸‹ï¼š\n\nCREATE TABLE &#96;sys_user&#96; (\n  &#96;id&#96; BIGINT(20) NOT NULL AUTO_INCREMENT COMMENT &#39;ä¸»é”®&#39;,\n  &#96;user_name&#96; VARCHAR(64) NOT NULL DEFAULT &#39;NULL&#39; COMMENT &#39;ç”¨æˆ·å&#39;,\n  &#96;nick_name&#96; VARCHAR(64) NOT NULL DEFAULT &#39;NULL&#39; COMMENT &#39;æ˜µç§°&#39;,\n  &#96;password&#96; VARCHAR(64) NOT NULL DEFAULT &#39;NULL&#39; COMMENT &#39;å¯†ç &#39;,\n  &#96;status&#96; CHAR(1) DEFAULT &#39;0&#39; COMMENT &#39;è´¦å·çŠ¶æ€ï¼ˆ0æ­£å¸¸ 1åœç”¨ï¼‰&#39;,\n  &#96;email&#96; VARCHAR(64) DEFAULT NULL COMMENT &#39;é‚®ç®±&#39;,\n  &#96;phonenumber&#96; VARCHAR(32) DEFAULT NULL COMMENT &#39;æ‰‹æœºå·&#39;,\n  &#96;sex&#96; CHAR(1) DEFAULT NULL COMMENT &#39;ç”¨æˆ·æ€§åˆ«ï¼ˆ0ç”·ï¼Œ1å¥³ï¼Œ2æœªçŸ¥ï¼‰&#39;,\n  &#96;avatar&#96; VARCHAR(128) DEFAULT NULL COMMENT &#39;å¤´åƒ&#39;,\n  &#96;user_type&#96; CHAR(1) NOT NULL DEFAULT &#39;1&#39; COMMENT &#39;ç”¨æˆ·ç±»å‹ï¼ˆ0ç®¡ç†å‘˜ï¼Œ1æ™®é€šç”¨æˆ·ï¼‰&#39;,\n  &#96;create_by&#96; BIGINT(20) DEFAULT NULL COMMENT &#39;åˆ›å»ºäººçš„ç”¨æˆ·id&#39;,\n  &#96;create_time&#96; DATETIME DEFAULT NULL COMMENT &#39;åˆ›å»ºæ—¶é—´&#39;,\n  &#96;update_by&#96; BIGINT(20) DEFAULT NULL COMMENT &#39;æ›´æ–°äºº&#39;,\n  &#96;update_time&#96; DATETIME DEFAULT NULL COMMENT &#39;æ›´æ–°æ—¶é—´&#39;,\n  &#96;del_flag&#96; INT(11) DEFAULT &#39;0&#39; COMMENT &#39;åˆ é™¤æ ‡å¿—ï¼ˆ0ä»£è¡¨æœªåˆ é™¤ï¼Œ1ä»£è¡¨å·²åˆ é™¤ï¼‰&#39;,\n  PRIMARY KEY (&#96;id&#96;)\n) ENGINE&#x3D;INNODB AUTO_INCREMENT&#x3D;2 DEFAULT CHARSET&#x3D;utf8mb4 COMMENT&#x3D;&#39;ç”¨æˆ·è¡¨&#39;\n\n    å¼•å…¥MybatisPulså’Œmysqlé©±åŠ¨çš„ä¾èµ–\n\n&lt;dependency>\n    &lt;groupId>com.baomidou&lt;/groupId>\n    &lt;artifactId>mybatis-plus-boot-starter&lt;/artifactId>\n    &lt;version>3.4.3&lt;/version>\n&lt;/dependency>\n&lt;dependency>\n    &lt;groupId>mysql&lt;/groupId>\n    &lt;artifactId>mysql-connector-java&lt;/artifactId>\n&lt;/dependency>\n\n    é…ç½®æ•°æ®åº“ä¿¡æ¯\n\nspring:\n  datasource:\n    url: jdbc:mysql://localhost:3306/sg_security?characterEncoding=utf-8&amp;serverTimezone=UTC\n    username: root\n    password: root\n    driver-class-name: com.mysql.cj.jdbc.Driver\n\n    å®šä¹‰Mapperæ¥å£\n\npublic interface UserMapper extends BaseMapper&lt;User> &#123;\n&#125;\n\n    ä¿®æ”¹Userå®ä½“ç±»\n\nç±»åä¸ŠåŠ @TableName(value = \"sys_user\") ,idå­—æ®µä¸ŠåŠ  @TableId\n\n    é…ç½®Mapperæ‰«æ\n\n@SpringBootApplication\n@MapperScan(\"com.sangeng.mapper\")\npublic class SimpleSecurityApplication &#123;\n    public static void main(String[] args) &#123;\n        ConfigurableApplicationContext run = SpringApplication.run(SimpleSecurityApplication.class);\n        System.out.println(run);\n    &#125;\n&#125;\n\n    æ·»åŠ junitä¾èµ–\n\n&lt;dependency>\n    &lt;groupId>org.springframework.boot&lt;/groupId>\n    &lt;artifactId>spring-boot-starter-test&lt;/artifactId>\n&lt;/dependency>\n\n Â  æµ‹è¯•MPæ˜¯å¦èƒ½æ­£å¸¸ä½¿ç”¨\n\n/**\n * @Author ä¸‰æ›´  Bç«™ï¼š https://space.bilibili.com/663528522\n */\n@SpringBootTest\npublic class MapperTest &#123;\n\n    @Autowired\n    private UserMapper userMapper;\n\n    @Test\n    public void testUserMapper()&#123;\n        List&lt;User> users = userMapper.selectList(null);\n        System.out.println(users);\n    &#125;\n&#125;\n\n\næ ¸å¿ƒä»£ç å®ç°åˆ›å»ºä¸€ä¸ªç±»å®ç°UserDetailsServiceæ¥å£ï¼Œé‡å†™å…¶ä¸­çš„æ–¹æ³•ã€‚æ›´åŠ ç”¨æˆ·åä»æ•°æ®åº“ä¸­æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯\n/**\n * @Author ä¸‰æ›´  Bç«™ï¼š https://space.bilibili.com/663528522\n */\n@Service\npublic class UserDetailsServiceImpl implements UserDetailsService &#123;\n\n    @Autowired\n    private UserMapper userMapper;\n\n    @Override\n    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException &#123;\n        //æ ¹æ®ç”¨æˆ·åæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯\n        LambdaQueryWrapper&lt;User> wrapper = new LambdaQueryWrapper&lt;>();\n        wrapper.eq(User::getUserName,username);\n        User user = userMapper.selectOne(wrapper);\n        //å¦‚æœæŸ¥è¯¢ä¸åˆ°æ•°æ®å°±é€šè¿‡æŠ›å‡ºå¼‚å¸¸æ¥ç»™å‡ºæç¤º\n        if(Objects.isNull(user))&#123;\n            throw new RuntimeException(\"ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯\");\n        &#125;\n        //TODO æ ¹æ®ç”¨æˆ·æŸ¥è¯¢æƒé™ä¿¡æ¯ æ·»åŠ åˆ°LoginUserä¸­\n        \n        //å°è£…æˆUserDetailså¯¹è±¡è¿”å› \n        return new LoginUser(user);\n    &#125;\n&#125;\n\nå› ä¸ºUserDetailsServiceæ–¹æ³•çš„è¿”å›å€¼æ˜¯UserDetailsç±»å‹ï¼Œæ‰€ä»¥éœ€è¦å®šä¹‰ä¸€ä¸ªç±»ï¼Œå®ç°è¯¥æ¥å£ï¼ŒæŠŠç”¨æˆ·ä¿¡æ¯å°è£…åœ¨å…¶ä¸­ã€‚\n/**\n * @Author ä¸‰æ›´  Bç«™ï¼š https://space.bilibili.com/663528522\n */\n@Data\n@NoArgsConstructor\n@AllArgsConstructor\npublic class LoginUser implements UserDetails &#123;\n\n    private User user;\n\n\n    @Override\n    public Collection&lt;? extends GrantedAuthority> getAuthorities() &#123;\n        return null;\n    &#125;\n\n    @Override\n    public String getPassword() &#123;\n        return user.getPassword();\n    &#125;\n\n    @Override\n    public String getUsername() &#123;\n        return user.getUserName();\n    &#125;\n\n    @Override\n    public boolean isAccountNonExpired() &#123;\n        return true;\n    &#125;\n\n    @Override\n    public boolean isAccountNonLocked() &#123;\n        return true;\n    &#125;\n\n    @Override\n    public boolean isCredentialsNonExpired() &#123;\n        return true;\n    &#125;\n\n    @Override\n    public boolean isEnabled() &#123;\n        return true;\n    &#125;\n&#125;\n\næ³¨æ„ï¼šå¦‚æœè¦æµ‹è¯•ï¼Œéœ€è¦å¾€ç”¨æˆ·è¡¨ä¸­å†™å…¥ç”¨æˆ·æ•°æ®ï¼Œå¹¶ä¸”å¦‚æœä½ æƒ³è®©ç”¨æˆ·çš„å¯†ç æ˜¯æ˜æ–‡å­˜å‚¨ï¼Œéœ€è¦åœ¨å¯†ç å‰åŠ {noop}ã€‚ä¾‹å¦‚\n\nè¿™æ ·ç™»é™†çš„æ—¶å€™å°±å¯ä»¥ç”¨sgä½œä¸ºç”¨æˆ·åï¼Œ1234ä½œä¸ºå¯†ç æ¥ç™»é™†äº†ã€‚\n\n2.3.3.2 å¯†ç åŠ å¯†å­˜å‚¨å®é™…é¡¹ç›®ä¸­æˆ‘ä»¬ä¸ä¼šæŠŠå¯†ç æ˜æ–‡å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ã€‚\n\né»˜è®¤ä½¿ç”¨çš„PasswordEncoderè¦æ±‚æ•°æ®åº“ä¸­çš„å¯†ç æ ¼å¼ä¸ºï¼š&#123;id&#125;password ã€‚å®ƒä¼šæ ¹æ®idå»åˆ¤æ–­å¯†ç çš„åŠ å¯†æ–¹å¼ã€‚ä½†æ˜¯æˆ‘ä»¬ä¸€èˆ¬ä¸ä¼šé‡‡ç”¨è¿™ç§æ–¹å¼ã€‚æ‰€ä»¥å°±éœ€è¦æ›¿æ¢PasswordEncoderã€‚\n\næˆ‘ä»¬ä¸€èˆ¬ä½¿ç”¨SpringSecurityä¸ºæˆ‘ä»¬æä¾›çš„BCryptPasswordEncoderã€‚\n\næˆ‘ä»¬åªéœ€è¦ä½¿ç”¨æŠŠBCryptPasswordEncoderå¯¹è±¡æ³¨å…¥Springå®¹å™¨ä¸­ï¼ŒSpringSecurityå°±ä¼šä½¿ç”¨è¯¥PasswordEncoderæ¥è¿›è¡Œå¯†ç æ ¡éªŒã€‚\n\næˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªSpringSecurityçš„é…ç½®ç±»ï¼ŒSpringSecurityè¦æ±‚è¿™ä¸ªé…ç½®ç±»è¦ç»§æ‰¿WebSecurityConfigurerAdapterã€‚\n\n/**\n * @Author ä¸‰æ›´  Bç«™ï¼š https://space.bilibili.com/663528522\n */\n@Configuration\npublic class SecurityConfig extends WebSecurityConfigurerAdapter &#123;\n\n\n    @Bean\n    public PasswordEncoder passwordEncoder()&#123;\n        return new BCryptPasswordEncoder();\n    &#125;\n\n&#125;\n\n\n2.3.3.3 ç™»é™†æ¥å£æ¥ä¸‹æˆ‘ä»¬éœ€è¦è‡ªå®šä¹‰ç™»é™†æ¥å£ï¼Œç„¶åè®©SpringSecurityå¯¹è¿™ä¸ªæ¥å£æ”¾è¡Œ,è®©ç”¨æˆ·è®¿é—®è¿™ä¸ªæ¥å£çš„æ—¶å€™ä¸ç”¨ç™»å½•ä¹Ÿèƒ½è®¿é—®ã€‚\n\nåœ¨æ¥å£ä¸­æˆ‘ä»¬é€šè¿‡AuthenticationManagerçš„authenticateæ–¹æ³•æ¥è¿›è¡Œç”¨æˆ·è®¤è¯,æ‰€ä»¥éœ€è¦åœ¨SecurityConfigä¸­é…ç½®æŠŠAuthenticationManageræ³¨å…¥å®¹å™¨ã€‚\n\nè®¤è¯æˆåŠŸçš„è¯è¦ç”Ÿæˆä¸€ä¸ªjwtï¼Œæ”¾å…¥å“åº”ä¸­è¿”å›ã€‚å¹¶ä¸”ä¸ºäº†è®©ç”¨æˆ·ä¸‹å›è¯·æ±‚æ—¶èƒ½é€šè¿‡jwtè¯†åˆ«å‡ºå…·ä½“çš„æ˜¯å“ªä¸ªç”¨æˆ·ï¼Œæˆ‘ä»¬éœ€è¦æŠŠç”¨æˆ·ä¿¡æ¯å­˜å…¥redisï¼Œå¯ä»¥æŠŠç”¨æˆ·idä½œä¸ºkeyã€‚\n\n@RestController\npublic class LoginController &#123;\n\n    @Autowired\n    private LoginServcie loginServcie;\n\n    @PostMapping(\"/user/login\")\n    public ResponseResult login(@RequestBody User user)&#123;\n        return loginServcie.login(user);\n    &#125;\n&#125;\n\n/**\n * @Author ä¸‰æ›´  Bç«™ï¼š https://space.bilibili.com/663528522\n */\n@Configuration\npublic class SecurityConfig extends WebSecurityConfigurerAdapter &#123;\n\n\n    @Bean\n    public PasswordEncoder passwordEncoder()&#123;\n        return new BCryptPasswordEncoder();\n    &#125;\n\n    @Override\n    protected void configure(HttpSecurity http) throws Exception &#123;\n        http\n                //å…³é—­csrf\n                .csrf().disable()\n                //ä¸é€šè¿‡Sessionè·å–SecurityContext\n                .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS)\n                .and()\n                .authorizeRequests()\n                // å¯¹äºç™»å½•æ¥å£ å…è®¸åŒ¿åè®¿é—®\n                .antMatchers(\"/user/login\").anonymous()\n                // é™¤ä¸Šé¢å¤–çš„æ‰€æœ‰è¯·æ±‚å…¨éƒ¨éœ€è¦é‰´æƒè®¤è¯\n                .anyRequest().authenticated();\n    &#125;\n\n    @Bean\n    @Override\n    public AuthenticationManager authenticationManagerBean() throws Exception &#123;\n        return super.authenticationManagerBean();\n    &#125;\n&#125;\n\n\n\n@Service\npublic class LoginServiceImpl implements LoginServcie &#123;\n\n    @Autowired\n    private AuthenticationManager authenticationManager;\n    @Autowired\n    private RedisCache redisCache;\n\n    @Override\n    public ResponseResult login(User user) &#123;\n        UsernamePasswordAuthenticationToken authenticationToken = new UsernamePasswordAuthenticationToken(user.getUserName(),user.getPassword());\n        Authentication authenticate = authenticationManager.authenticate(authenticationToken);\n        if(Objects.isNull(authenticate))&#123;\n            throw new RuntimeException(\"ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯\");\n        &#125;\n        //ä½¿ç”¨useridç”Ÿæˆtoken\n        LoginUser loginUser = (LoginUser) authenticate.getPrincipal();\n        String userId = loginUser.getUser().getId().toString();\n        String jwt = JwtUtil.createJWT(userId);\n        //authenticateå­˜å…¥redis\n        redisCache.setCacheObject(\"login:\"+userId,loginUser);\n        //æŠŠtokenå“åº”ç»™å‰ç«¯\n        HashMap&lt;String,String> map = new HashMap&lt;>();\n        map.put(\"token\",jwt);\n        return new ResponseResult(200,\"ç™»é™†æˆåŠŸ\",map);\n    &#125;\n&#125;\n\n\n2.3.3.4 è®¤è¯è¿‡æ»¤å™¨æˆ‘ä»¬éœ€è¦è‡ªå®šä¹‰ä¸€ä¸ªè¿‡æ»¤å™¨ï¼Œè¿™ä¸ªè¿‡æ»¤å™¨ä¼šå»è·å–è¯·æ±‚å¤´ä¸­çš„tokenï¼Œå¯¹tokenè¿›è¡Œè§£æå–å‡ºå…¶ä¸­çš„useridã€‚\n\nä½¿ç”¨useridå»redisä¸­è·å–å¯¹åº”çš„LoginUserå¯¹è±¡ã€‚\n\nç„¶åå°è£…Authenticationå¯¹è±¡å­˜å…¥SecurityContextHolder\n\n@Component\npublic class JwtAuthenticationTokenFilter extends OncePerRequestFilter &#123;\n\n    @Autowired\n    private RedisCache redisCache;\n\n    @Override\n    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException &#123;\n        //è·å–token\n        String token = request.getHeader(\"token\");\n        if (!StringUtils.hasText(token)) &#123;\n            //æ”¾è¡Œ\n            filterChain.doFilter(request, response);\n            return;\n        &#125;\n        //è§£ætoken\n        String userid;\n        try &#123;\n            Claims claims = JwtUtil.parseJWT(token);\n            userid = claims.getSubject();\n        &#125; catch (Exception e) &#123;\n            e.printStackTrace();\n            throw new RuntimeException(\"tokenéæ³•\");\n        &#125;\n        //ä»redisä¸­è·å–ç”¨æˆ·ä¿¡æ¯\n        String redisKey = \"login:\" + userid;\n        LoginUser loginUser = redisCache.getCacheObject(redisKey);\n        if(Objects.isNull(loginUser))&#123;\n            throw new RuntimeException(\"ç”¨æˆ·æœªç™»å½•\");\n        &#125;\n        //å­˜å…¥SecurityContextHolder\n        //TODO è·å–æƒé™ä¿¡æ¯å°è£…åˆ°Authenticationä¸­\n        UsernamePasswordAuthenticationToken authenticationToken =\n                new UsernamePasswordAuthenticationToken(loginUser,null,null);\n        SecurityContextHolder.getContext().setAuthentication(authenticationToken);\n        //æ”¾è¡Œ\n        filterChain.doFilter(request, response);\n    &#125;\n&#125;\n\n/**\n * @Author ä¸‰æ›´  Bç«™ï¼š https://space.bilibili.com/663528522\n */\n@Configuration\npublic class SecurityConfig extends WebSecurityConfigurerAdapter &#123;\n\n\n    @Bean\n    public PasswordEncoder passwordEncoder()&#123;\n        return new BCryptPasswordEncoder();\n    &#125;\n\n\n    @Autowired\n    JwtAuthenticationTokenFilter jwtAuthenticationTokenFilter;\n\n    @Override\n    protected void configure(HttpSecurity http) throws Exception &#123;\n        http\n                //å…³é—­csrf\n                .csrf().disable()\n                //ä¸é€šè¿‡Sessionè·å–SecurityContext\n                .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS)\n                .and()\n                .authorizeRequests()\n                // å¯¹äºç™»å½•æ¥å£ å…è®¸åŒ¿åè®¿é—®\n                .antMatchers(\"/user/login\").anonymous()\n                // é™¤ä¸Šé¢å¤–çš„æ‰€æœ‰è¯·æ±‚å…¨éƒ¨éœ€è¦é‰´æƒè®¤è¯\n                .anyRequest().authenticated();\n\n        //æŠŠtokenæ ¡éªŒè¿‡æ»¤å™¨æ·»åŠ åˆ°è¿‡æ»¤å™¨é“¾ä¸­\n        http.addFilterBefore(jwtAuthenticationTokenFilter, UsernamePasswordAuthenticationFilter.class);\n    &#125;\n\n    @Bean\n    @Override\n    public AuthenticationManager authenticationManagerBean() throws Exception &#123;\n        return super.authenticationManagerBean();\n    &#125;\n&#125;\n\n\n2.3.3.5 é€€å‡ºç™»é™†æˆ‘ä»¬åªéœ€è¦å®šä¹‰ä¸€ä¸ªç™»é™†æ¥å£ï¼Œç„¶åè·å–SecurityContextHolderä¸­çš„è®¤è¯ä¿¡æ¯ï¼Œåˆ é™¤redisä¸­å¯¹åº”çš„æ•°æ®å³å¯ã€‚\n\n/**\n * @Author ä¸‰æ›´  Bç«™ï¼š https://space.bilibili.com/663528522\n */\n@Service\npublic class LoginServiceImpl implements LoginServcie &#123;\n\n    @Autowired\n    private AuthenticationManager authenticationManager;\n    @Autowired\n    private RedisCache redisCache;\n\n    @Override\n    public ResponseResult login(User user) &#123;\n        UsernamePasswordAuthenticationToken authenticationToken = new UsernamePasswordAuthenticationToken(user.getUserName(),user.getPassword());\n        Authentication authenticate = authenticationManager.authenticate(authenticationToken);\n        if(Objects.isNull(authenticate))&#123;\n            throw new RuntimeException(\"ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯\");\n        &#125;\n        //ä½¿ç”¨useridç”Ÿæˆtoken\n        LoginUser loginUser = (LoginUser) authenticate.getPrincipal();\n        String userId = loginUser.getUser().getId().toString();\n        String jwt = JwtUtil.createJWT(userId);\n        //authenticateå­˜å…¥redis\n        redisCache.setCacheObject(\"login:\"+userId,loginUser);\n        //æŠŠtokenå“åº”ç»™å‰ç«¯\n        HashMap&lt;String,String> map = new HashMap&lt;>();\n        map.put(\"token\",jwt);\n        return new ResponseResult(200,\"ç™»é™†æˆåŠŸ\",map);\n    &#125;\n\n    @Override\n    public ResponseResult logout() &#123;\n        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();\n        LoginUser loginUser = (LoginUser) authentication.getPrincipal();\n        Long userid = loginUser.getUser().getId();\n        redisCache.deleteObject(\"login:\"+userid);\n        return new ResponseResult(200,\"é€€å‡ºæˆåŠŸ\");\n    &#125;\n&#125;\n\n\n3. æˆæƒ\n3.0 æƒé™ç³»ç»Ÿçš„ä½œç”¨ä¾‹å¦‚ä¸€ä¸ªå­¦æ ¡å›¾ä¹¦é¦†çš„ç®¡ç†ç³»ç»Ÿï¼Œå¦‚æœæ˜¯æ™®é€šå­¦ç”Ÿç™»å½•å°±èƒ½çœ‹åˆ°å€Ÿä¹¦è¿˜ä¹¦ç›¸å…³çš„åŠŸèƒ½ï¼Œä¸å¯èƒ½è®©ä»–çœ‹åˆ°å¹¶ä¸”å»ä½¿ç”¨æ·»åŠ ä¹¦ç±ä¿¡æ¯ï¼Œåˆ é™¤ä¹¦ç±ä¿¡æ¯ç­‰åŠŸèƒ½ã€‚ä½†æ˜¯å¦‚æœæ˜¯ä¸€ä¸ªå›¾ä¹¦é¦†ç®¡ç†å‘˜çš„è´¦å·ç™»å½•äº†ï¼Œåº”è¯¥å°±èƒ½çœ‹åˆ°å¹¶ä½¿ç”¨æ·»åŠ ä¹¦ç±ä¿¡æ¯ï¼Œåˆ é™¤ä¹¦ç±ä¿¡æ¯ç­‰åŠŸèƒ½ã€‚\n\næ€»ç»“èµ·æ¥å°±æ˜¯**ä¸åŒçš„ç”¨æˆ·å¯ä»¥ä½¿ç”¨ä¸åŒçš„åŠŸèƒ½**ã€‚è¿™å°±æ˜¯æƒé™ç³»ç»Ÿè¦å»å®ç°çš„æ•ˆæœã€‚\n\næˆ‘ä»¬ä¸èƒ½åªä¾èµ–å‰ç«¯å»åˆ¤æ–­ç”¨æˆ·çš„æƒé™æ¥é€‰æ‹©æ˜¾ç¤ºå“ªäº›èœå•å“ªäº›æŒ‰é’®ã€‚å› ä¸ºå¦‚æœåªæ˜¯è¿™æ ·ï¼Œå¦‚æœæœ‰äººçŸ¥é“äº†å¯¹åº”åŠŸèƒ½çš„æ¥å£åœ°å€å°±å¯ä»¥ä¸é€šè¿‡å‰ç«¯ï¼Œç›´æ¥å»å‘é€è¯·æ±‚æ¥å®ç°ç›¸å…³åŠŸèƒ½æ“ä½œã€‚\n\næ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦åœ¨åå°è¿›è¡Œç”¨æˆ·æƒé™çš„åˆ¤æ–­ï¼Œåˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦æœ‰ç›¸åº”çš„æƒé™ï¼Œå¿…é¡»å…·æœ‰æ‰€éœ€æƒé™æ‰èƒ½è¿›è¡Œç›¸åº”çš„æ“ä½œã€‚\n\n\n3.1 æˆæƒåŸºæœ¬æµç¨‹åœ¨SpringSecurityä¸­ï¼Œä¼šä½¿ç”¨é»˜è®¤çš„FilterSecurityInterceptoræ¥è¿›è¡Œæƒé™æ ¡éªŒã€‚åœ¨FilterSecurityInterceptorä¸­ä¼šä»SecurityContextHolderè·å–å…¶ä¸­çš„Authenticationï¼Œç„¶åè·å–å…¶ä¸­çš„æƒé™ä¿¡æ¯ã€‚å½“å‰ç”¨æˆ·æ˜¯å¦æ‹¥æœ‰è®¿é—®å½“å‰èµ„æºæ‰€éœ€çš„æƒé™ã€‚\n\næ‰€ä»¥æˆ‘ä»¬åœ¨é¡¹ç›®ä¸­åªéœ€è¦æŠŠå½“å‰ç™»å½•ç”¨æˆ·çš„æƒé™ä¿¡æ¯ä¹Ÿå­˜å…¥Authenticationã€‚\n\nç„¶åè®¾ç½®æˆ‘ä»¬çš„èµ„æºæ‰€éœ€è¦çš„æƒé™å³å¯ã€‚\n\n\n3.2 æˆæƒå®ç°\n3.2.1 é™åˆ¶è®¿é—®èµ„æºæ‰€éœ€æƒé™SpringSecurityä¸ºæˆ‘ä»¬æä¾›äº†åŸºäºæ³¨è§£çš„æƒé™æ§åˆ¶æ–¹æ¡ˆï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬é¡¹ç›®ä¸­ä¸»è¦é‡‡ç”¨çš„æ–¹å¼ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ³¨è§£å»æŒ‡å®šè®¿é—®å¯¹åº”çš„èµ„æºæ‰€éœ€çš„æƒé™ã€‚\n\nä½†æ˜¯è¦ä½¿ç”¨å®ƒæˆ‘ä»¬éœ€è¦å…ˆå¼€å¯ç›¸å…³é…ç½®ã€‚\n\n@EnableGlobalMethodSecurity(prePostEnabled = true)\n\nç„¶åå°±å¯ä»¥ä½¿ç”¨å¯¹åº”çš„æ³¨è§£ã€‚[@PreAuthorize ](/PreAuthorize ) \n\n@RestController\npublic class HelloController &#123;\n\n    @RequestMapping(\"/hello\")\n    @PreAuthorize(\"hasAuthority('test')\")\n    public String hello()&#123;\n        return \"hello\";\n    &#125;\n&#125;\n\n\n3.2.2 å°è£…æƒé™ä¿¡æ¯æˆ‘ä»¬å‰é¢åœ¨å†™UserDetailsServiceImplçš„æ—¶å€™è¯´è¿‡ï¼Œåœ¨æŸ¥è¯¢å‡ºç”¨æˆ·åè¿˜è¦è·å–å¯¹åº”çš„æƒé™ä¿¡æ¯ï¼Œå°è£…åˆ°UserDetailsä¸­è¿”å›ã€‚\n\næˆ‘ä»¬å…ˆç›´æ¥æŠŠæƒé™ä¿¡æ¯å†™æ­»å°è£…åˆ°UserDetailsä¸­è¿›è¡Œæµ‹è¯•ã€‚\n\næˆ‘ä»¬ä¹‹å‰å®šä¹‰äº†UserDetailsçš„å®ç°ç±»LoginUserï¼Œæƒ³è¦è®©å…¶èƒ½å°è£…æƒé™ä¿¡æ¯å°±è¦å¯¹å…¶è¿›è¡Œä¿®æ”¹ã€‚\n\npackage com.sangeng.domain;\n\nimport com.alibaba.fastjson.annotation.JSONField;\nimport lombok.AllArgsConstructor;\nimport lombok.Data;\nimport lombok.NoArgsConstructor;\nimport org.springframework.security.core.GrantedAuthority;\nimport org.springframework.security.core.authority.SimpleGrantedAuthority;\nimport org.springframework.security.core.userdetails.UserDetails;\n\nimport java.util.Collection;\nimport java.util.List;\nimport java.util.stream.Collectors;\n\n/**\n * @Author ä¸‰æ›´  Bç«™ï¼š https://space.bilibili.com/663528522\n */\n@Data\n@NoArgsConstructor\npublic class LoginUser implements UserDetails &#123;\n\n    private User user;\n        \n    //å­˜å‚¨æƒé™ä¿¡æ¯\n    private List&lt;String> permissions;\n    \n    \n    public LoginUser(User user,List&lt;String> permissions) &#123;\n        this.user = user;\n        this.permissions = permissions;\n    &#125;\n\n\n    //å­˜å‚¨SpringSecurityæ‰€éœ€è¦çš„æƒé™ä¿¡æ¯çš„é›†åˆ\n    @JSONField(serialize = false)\n    private List&lt;GrantedAuthority> authorities;\n\n    @Override\n    public  Collection&lt;? extends GrantedAuthority> getAuthorities() &#123;\n        if(authorities!=null)&#123;\n            return authorities;\n        &#125;\n        //æŠŠpermissionsä¸­å­—ç¬¦ä¸²ç±»å‹çš„æƒé™ä¿¡æ¯è½¬æ¢æˆGrantedAuthorityå¯¹è±¡å­˜å…¥authoritiesä¸­\n        authorities = permissions.stream().\n                map(SimpleGrantedAuthority::new)\n                .collect(Collectors.toList());\n        return authorities;\n    &#125;\n\n    @Override\n    public String getPassword() &#123;\n        return user.getPassword();\n    &#125;\n\n    @Override\n    public String getUsername() &#123;\n        return user.getUserName();\n    &#125;\n\n    @Override\n    public boolean isAccountNonExpired() &#123;\n        return true;\n    &#125;\n\n    @Override\n    public boolean isAccountNonLocked() &#123;\n        return true;\n    &#125;\n\n    @Override\n    public boolean isCredentialsNonExpired() &#123;\n        return true;\n    &#125;\n\n    @Override\n    public boolean isEnabled() &#123;\n        return true;\n    &#125;\n&#125;\n\n    LoginUserä¿®æ”¹å®Œåæˆ‘ä»¬å°±å¯ä»¥åœ¨UserDetailsServiceImplä¸­å»æŠŠæƒé™ä¿¡æ¯å°è£…åˆ°LoginUserä¸­äº†ã€‚æˆ‘ä»¬å†™æ­»æƒé™è¿›è¡Œæµ‹è¯•ï¼Œåé¢æˆ‘ä»¬å†ä»æ•°æ®åº“ä¸­æŸ¥è¯¢æƒé™ä¿¡æ¯ã€‚\n\npackage com.sangeng.service.impl;\n\nimport com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;\nimport com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;\nimport com.baomidou.mybatisplus.extension.conditions.query.LambdaQueryChainWrapper;\nimport com.sangeng.domain.LoginUser;\nimport com.sangeng.domain.User;\nimport com.sangeng.mapper.UserMapper;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.security.core.userdetails.UserDetails;\nimport org.springframework.security.core.userdetails.UserDetailsService;\nimport org.springframework.security.core.userdetails.UsernameNotFoundException;\nimport org.springframework.stereotype.Service;\n\nimport java.util.ArrayList;\nimport java.util.Arrays;\nimport java.util.List;\nimport java.util.Objects;\n\n/**\n * @Author ä¸‰æ›´  Bç«™ï¼š https://space.bilibili.com/663528522\n */\n@Service\npublic class UserDetailsServiceImpl implements UserDetailsService &#123;\n\n    @Autowired\n    private UserMapper userMapper;\n\n    @Override\n    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException &#123;\n        LambdaQueryWrapper&lt;User> wrapper = new LambdaQueryWrapper&lt;>();\n        wrapper.eq(User::getUserName,username);\n        User user = userMapper.selectOne(wrapper);\n        if(Objects.isNull(user))&#123;\n            throw new RuntimeException(\"ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯\");\n        &#125;\n        //TODO æ ¹æ®ç”¨æˆ·æŸ¥è¯¢æƒé™ä¿¡æ¯ æ·»åŠ åˆ°LoginUserä¸­\n        List&lt;String> list = new ArrayList&lt;>(Arrays.asList(\"test\"));\n        return new LoginUser(user,list);\n    &#125;\n&#125;\n\n\n3.2.3 ä»æ•°æ®åº“æŸ¥è¯¢æƒé™ä¿¡æ¯\n3.2.3.1 RBACæƒé™æ¨¡å‹RBACæƒé™æ¨¡å‹ï¼ˆRole-Based Access Controlï¼‰å³ï¼šåŸºäºè§’è‰²çš„æƒé™æ§åˆ¶ã€‚è¿™æ˜¯ç›®å‰æœ€å¸¸è¢«å¼€å‘è€…ä½¿ç”¨ä¹Ÿæ˜¯ç›¸å¯¹æ˜“ç”¨ã€é€šç”¨æƒé™æ¨¡å‹ã€‚\n\n![image-20211222110249727.png](https://cdn.nlark.com/yuque/0/2022/png/26737039/1654678998174-ddf9e502-0eb7-46de-8f1e-b21c87914758.png#clientId=u30b1fcc0-d450-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=drop&amp;id=u8ac9a782&amp;name=image-20211222110249727.png&amp;originHeight=716&amp;originWidth=1187&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=59299&amp;status=done&amp;style=none&amp;taskId=ucc024657-450e-4d8f-936a-42ecaee0d1f&amp;title=)\n\n\n3.2.3.2 å‡†å¤‡å·¥ä½œ\nCREATE DATABASE /*!32312 IF NOT EXISTS*/`sg_security` /*!40100 DEFAULT CHARACTER SET utf8mb4 */;\n\nUSE `sg_security`;\n\n/*Table structure for table `sys_menu` */\n\nDROP TABLE IF EXISTS `sys_menu`;\n\nCREATE TABLE `sys_menu` (\n  `id` bigint(20) NOT NULL AUTO_INCREMENT,\n  `menu_name` varchar(64) NOT NULL DEFAULT 'NULL' COMMENT 'èœå•å',\n  `path` varchar(200) DEFAULT NULL COMMENT 'è·¯ç”±åœ°å€',\n  `component` varchar(255) DEFAULT NULL COMMENT 'ç»„ä»¶è·¯å¾„',\n  `visible` char(1) DEFAULT '0' COMMENT 'èœå•çŠ¶æ€ï¼ˆ0æ˜¾ç¤º 1éšè—ï¼‰',\n  `status` char(1) DEFAULT '0' COMMENT 'èœå•çŠ¶æ€ï¼ˆ0æ­£å¸¸ 1åœç”¨ï¼‰',\n  `perms` varchar(100) DEFAULT NULL COMMENT 'æƒé™æ ‡è¯†',\n  `icon` varchar(100) DEFAULT '#' COMMENT 'èœå•å›¾æ ‡',\n  `create_by` bigint(20) DEFAULT NULL,\n  `create_time` datetime DEFAULT NULL,\n  `update_by` bigint(20) DEFAULT NULL,\n  `update_time` datetime DEFAULT NULL,\n  `del_flag` int(11) DEFAULT '0' COMMENT 'æ˜¯å¦åˆ é™¤ï¼ˆ0æœªåˆ é™¤ 1å·²åˆ é™¤ï¼‰',\n  `remark` varchar(500) DEFAULT NULL COMMENT 'å¤‡æ³¨',\n  PRIMARY KEY (`id`)\n) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8mb4 COMMENT='èœå•è¡¨';\n\n/*Table structure for table `sys_role` */\n\nDROP TABLE IF EXISTS `sys_role`;\n\nCREATE TABLE `sys_role` (\n  `id` bigint(20) NOT NULL AUTO_INCREMENT,\n  `name` varchar(128) DEFAULT NULL,\n  `role_key` varchar(100) DEFAULT NULL COMMENT 'è§’è‰²æƒé™å­—ç¬¦ä¸²',\n  `status` char(1) DEFAULT '0' COMMENT 'è§’è‰²çŠ¶æ€ï¼ˆ0æ­£å¸¸ 1åœç”¨ï¼‰',\n  `del_flag` int(1) DEFAULT '0' COMMENT 'del_flag',\n  `create_by` bigint(200) DEFAULT NULL,\n  `create_time` datetime DEFAULT NULL,\n  `update_by` bigint(200) DEFAULT NULL,\n  `update_time` datetime DEFAULT NULL,\n  `remark` varchar(500) DEFAULT NULL COMMENT 'å¤‡æ³¨',\n  PRIMARY KEY (`id`)\n) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=utf8mb4 COMMENT='è§’è‰²è¡¨';\n\n/*Table structure for table `sys_role_menu` */\n\nDROP TABLE IF EXISTS `sys_role_menu`;\n\nCREATE TABLE `sys_role_menu` (\n  `role_id` bigint(200) NOT NULL AUTO_INCREMENT COMMENT 'è§’è‰²ID',\n  `menu_id` bigint(200) NOT NULL DEFAULT '0' COMMENT 'èœå•id',\n  PRIMARY KEY (`role_id`,`menu_id`)\n) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8mb4;\n\n/*Table structure for table `sys_user` */\n\nDROP TABLE IF EXISTS `sys_user`;\n\nCREATE TABLE `sys_user` (\n  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®',\n  `user_name` varchar(64) NOT NULL DEFAULT 'NULL' COMMENT 'ç”¨æˆ·å',\n  `nick_name` varchar(64) NOT NULL DEFAULT 'NULL' COMMENT 'æ˜µç§°',\n  `password` varchar(64) NOT NULL DEFAULT 'NULL' COMMENT 'å¯†ç ',\n  `status` char(1) DEFAULT '0' COMMENT 'è´¦å·çŠ¶æ€ï¼ˆ0æ­£å¸¸ 1åœç”¨ï¼‰',\n  `email` varchar(64) DEFAULT NULL COMMENT 'é‚®ç®±',\n  `phonenumber` varchar(32) DEFAULT NULL COMMENT 'æ‰‹æœºå·',\n  `sex` char(1) DEFAULT NULL COMMENT 'ç”¨æˆ·æ€§åˆ«ï¼ˆ0ç”·ï¼Œ1å¥³ï¼Œ2æœªçŸ¥ï¼‰',\n  `avatar` varchar(128) DEFAULT NULL COMMENT 'å¤´åƒ',\n  `user_type` char(1) NOT NULL DEFAULT '1' COMMENT 'ç”¨æˆ·ç±»å‹ï¼ˆ0ç®¡ç†å‘˜ï¼Œ1æ™®é€šç”¨æˆ·ï¼‰',\n  `create_by` bigint(20) DEFAULT NULL COMMENT 'åˆ›å»ºäººçš„ç”¨æˆ·id',\n  `create_time` datetime DEFAULT NULL COMMENT 'åˆ›å»ºæ—¶é—´',\n  `update_by` bigint(20) DEFAULT NULL COMMENT 'æ›´æ–°äºº',\n  `update_time` datetime DEFAULT NULL COMMENT 'æ›´æ–°æ—¶é—´',\n  `del_flag` int(11) DEFAULT '0' COMMENT 'åˆ é™¤æ ‡å¿—ï¼ˆ0ä»£è¡¨æœªåˆ é™¤ï¼Œ1ä»£è¡¨å·²åˆ é™¤ï¼‰',\n  PRIMARY KEY (`id`)\n) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=utf8mb4 COMMENT='ç”¨æˆ·è¡¨';\n\n/*Table structure for table `sys_user_role` */\n\nDROP TABLE IF EXISTS `sys_user_role`;\n\nCREATE TABLE `sys_user_role` (\n  `user_id` bigint(200) NOT NULL AUTO_INCREMENT COMMENT 'ç”¨æˆ·id',\n  `role_id` bigint(200) NOT NULL DEFAULT '0' COMMENT 'è§’è‰²id',\n  PRIMARY KEY (`user_id`,`role_id`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\n\nSELECT \n\tDISTINCT m.&#96;perms&#96;\nFROM\n\tsys_user_role ur\n\tLEFT JOIN &#96;sys_role&#96; r ON ur.&#96;role_id&#96; &#x3D; r.&#96;id&#96;\n\tLEFT JOIN &#96;sys_role_menu&#96; rm ON ur.&#96;role_id&#96; &#x3D; rm.&#96;role_id&#96;\n\tLEFT JOIN &#96;sys_menu&#96; m ON m.&#96;id&#96; &#x3D; rm.&#96;menu_id&#96;\nWHERE\n\tuser_id &#x3D; 2\n\tAND r.&#96;status&#96; &#x3D; 0\n\tAND m.&#96;status&#96; &#x3D; 0\n\npackage com.sangeng.domain;\n\nimport com.baomidou.mybatisplus.annotation.TableId;\nimport com.baomidou.mybatisplus.annotation.TableName;\nimport com.fasterxml.jackson.annotation.JsonInclude;\nimport lombok.AllArgsConstructor;\nimport lombok.Data;\nimport lombok.NoArgsConstructor;\n\nimport java.io.Serializable;\nimport java.util.Date;\n\n/**\n * èœå•è¡¨(Menu)å®ä½“ç±»\n *\n * @author makejava\n * @since 2021-11-24 15:30:08\n */\n@TableName(value=\"sys_menu\")\n@Data\n@AllArgsConstructor\n@NoArgsConstructor\n@JsonInclude(JsonInclude.Include.NON_NULL)\npublic class Menu implements Serializable &#123;\n    private static final long serialVersionUID = -54979041104113736L;\n    \n        @TableId\n    private Long id;\n    /**\n    * èœå•å\n    */\n    private String menuName;\n    /**\n    * è·¯ç”±åœ°å€\n    */\n    private String path;\n    /**\n    * ç»„ä»¶è·¯å¾„\n    */\n    private String component;\n    /**\n    * èœå•çŠ¶æ€ï¼ˆ0æ˜¾ç¤º 1éšè—ï¼‰\n    */\n    private String visible;\n    /**\n    * èœå•çŠ¶æ€ï¼ˆ0æ­£å¸¸ 1åœç”¨ï¼‰\n    */\n    private String status;\n    /**\n    * æƒé™æ ‡è¯†\n    */\n    private String perms;\n    /**\n    * èœå•å›¾æ ‡\n    */\n    private String icon;\n    \n    private Long createBy;\n    \n    private Date createTime;\n    \n    private Long updateBy;\n    \n    private Date updateTime;\n    /**\n    * æ˜¯å¦åˆ é™¤ï¼ˆ0æœªåˆ é™¤ 1å·²åˆ é™¤ï¼‰\n    */\n    private Integer delFlag;\n    /**\n    * å¤‡æ³¨\n    */\n    private String remark;\n&#125;\n\n\n3.2.3.3 ä»£ç å®ç°æˆ‘ä»¬åªéœ€è¦æ ¹æ®ç”¨æˆ·idå»æŸ¥è¯¢åˆ°å…¶æ‰€å¯¹åº”çš„æƒé™ä¿¡æ¯å³å¯ã€‚\n\næ‰€ä»¥æˆ‘ä»¬å¯ä»¥å…ˆå®šä¹‰ä¸ªmapperï¼Œå…¶ä¸­æä¾›ä¸€ä¸ªæ–¹æ³•å¯ä»¥æ ¹æ®useridæŸ¥è¯¢æƒé™ä¿¡æ¯ã€‚\n\nimport com.baomidou.mybatisplus.core.mapper.BaseMapper;\nimport com.sangeng.domain.Menu;\n\nimport java.util.List;\n\n/**\n * @Author ä¸‰æ›´  Bç«™ï¼š https://space.bilibili.com/663528522\n */\npublic interface MenuMapper extends BaseMapper&lt;Menu> &#123;\n    List&lt;String> selectPermsByUserId(Long id);\n&#125;\n\nå°¤å…¶æ˜¯è‡ªå®šä¹‰æ–¹æ³•ï¼Œæ‰€ä»¥éœ€è¦åˆ›å»ºå¯¹åº”çš„mapperæ–‡ä»¶ï¼Œå®šä¹‰å¯¹åº”çš„sqlè¯­å¥\n\n&lt;?xml version=\"1.0\" encoding=\"UTF-8\" ?>\n&lt;!DOCTYPE mapper PUBLIC \"-//mybatis.org//DTD Mapper 3.0//EN\" \"http://mybatis.org/dtd/mybatis-3-mapper.dtd\" >\n&lt;mapper namespace=\"com.sangeng.mapper.MenuMapper\">\n\n\n    &lt;select id=\"selectPermsByUserId\" resultType=\"java.lang.String\">\n        SELECT\n            DISTINCT m.`perms`\n        FROM\n            sys_user_role ur\n            LEFT JOIN `sys_role` r ON ur.`role_id` = r.`id`\n            LEFT JOIN `sys_role_menu` rm ON ur.`role_id` = rm.`role_id`\n            LEFT JOIN `sys_menu` m ON m.`id` = rm.`menu_id`\n        WHERE\n            user_id = #&#123;userid&#125;\n            AND r.`status` = 0\n            AND m.`status` = 0\n    &lt;/select>\n&lt;/mapper>\n\nåœ¨application.ymlä¸­é…ç½®mapperXMLæ–‡ä»¶çš„ä½ç½®\n\nspring:\n  datasource:\n    url: jdbc:mysql://localhost:3306/sg_security?characterEncoding=utf-8&amp;serverTimezone=UTC\n    username: root\n    password: root\n    driver-class-name: com.mysql.cj.jdbc.Driver\n  redis:\n    host: localhost\n    port: 6379\nmybatis-plus:\n  mapper-locations: classpath*:/mapper/**/*.xml\n\nç„¶åæˆ‘ä»¬å¯ä»¥åœ¨UserDetailsServiceImplä¸­å»è°ƒç”¨è¯¥mapperçš„æ–¹æ³•æŸ¥è¯¢æƒé™ä¿¡æ¯å°è£…åˆ°LoginUserå¯¹è±¡ä¸­å³å¯ã€‚\n\n/**\n * @Author ä¸‰æ›´  Bç«™ï¼š https://space.bilibili.com/663528522\n */\n@Service\npublic class UserDetailsServiceImpl implements UserDetailsService &#123;\n\n    @Autowired\n    private UserMapper userMapper;\n\n    @Autowired\n    private MenuMapper menuMapper;\n\n    @Override\n    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException &#123;\n        LambdaQueryWrapper&lt;User> wrapper = new LambdaQueryWrapper&lt;>();\n        wrapper.eq(User::getUserName,username);\n        User user = userMapper.selectOne(wrapper);\n        if(Objects.isNull(user))&#123;\n            throw new RuntimeException(\"ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯\");\n        &#125;\n        List&lt;String> permissionKeyList =  menuMapper.selectPermsByUserId(user.getId());\n//        //æµ‹è¯•å†™æ³•\n//        List&lt;String> list = new ArrayList&lt;>(Arrays.asList(\"test\"));\n        return new LoginUser(user,permissionKeyList);\n    &#125;\n&#125;\n\n\n4. è‡ªå®šä¹‰å¤±è´¥å¤„ç†æˆ‘ä»¬è¿˜å¸Œæœ›åœ¨è®¤è¯å¤±è´¥æˆ–è€…æ˜¯æˆæƒå¤±è´¥çš„æƒ…å†µä¸‹ä¹Ÿèƒ½å’Œæˆ‘ä»¬çš„æ¥å£ä¸€æ ·è¿”å›ç›¸åŒç»“æ„çš„jsonï¼Œè¿™æ ·å¯ä»¥è®©å‰ç«¯èƒ½å¯¹å“åº”è¿›è¡Œç»Ÿä¸€çš„å¤„ç†ã€‚è¦å®ç°è¿™ä¸ªåŠŸèƒ½æˆ‘ä»¬éœ€è¦çŸ¥é“SpringSecurityçš„å¼‚å¸¸å¤„ç†æœºåˆ¶ã€‚\n\nåœ¨SpringSecurityä¸­ï¼Œå¦‚æœæˆ‘ä»¬åœ¨è®¤è¯æˆ–è€…æˆæƒçš„è¿‡ç¨‹ä¸­å‡ºç°äº†å¼‚å¸¸ä¼šè¢«ExceptionTranslationFilteræ•è·åˆ°ã€‚åœ¨ExceptionTranslationFilterä¸­ä¼šå»åˆ¤æ–­æ˜¯è®¤è¯å¤±è´¥è¿˜æ˜¯æˆæƒå¤±è´¥å‡ºç°çš„å¼‚å¸¸ã€‚\n\nå¦‚æœæ˜¯è®¤è¯è¿‡ç¨‹ä¸­å‡ºç°çš„å¼‚å¸¸ä¼šè¢«å°è£…æˆAuthenticationExceptionç„¶åè°ƒç”¨**AuthenticationEntryPoint**å¯¹è±¡çš„æ–¹æ³•å»è¿›è¡Œå¼‚å¸¸å¤„ç†ã€‚\n\nå¦‚æœæ˜¯æˆæƒè¿‡ç¨‹ä¸­å‡ºç°çš„å¼‚å¸¸ä¼šè¢«å°è£…æˆAccessDeniedExceptionç„¶åè°ƒç”¨**AccessDeniedHandler**å¯¹è±¡çš„æ–¹æ³•å»è¿›è¡Œå¼‚å¸¸å¤„ç†ã€‚\n\næ‰€ä»¥å¦‚æœæˆ‘ä»¬éœ€è¦è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†ï¼Œæˆ‘ä»¬åªéœ€è¦è‡ªå®šä¹‰AuthenticationEntryPointå’ŒAccessDeniedHandlerç„¶åé…ç½®ç»™SpringSecurityå³å¯ã€‚\n\nâ‘ è‡ªå®šä¹‰å®ç°ç±»\n@Component\npublic class AccessDeniedHandlerImpl implements AccessDeniedHandler &#123;\n    @Override\n    public void handle(HttpServletRequest request, HttpServletResponse response, AccessDeniedException accessDeniedException) throws IOException, ServletException &#123;\n        ResponseResult result = new ResponseResult(HttpStatus.FORBIDDEN.value(), \"æƒé™ä¸è¶³\");\n        String json = JSON.toJSONString(result);\n        WebUtils.renderString(response,json);\n\n    &#125;\n&#125;\n\n/**\n * @Author ä¸‰æ›´  Bç«™ï¼š https://space.bilibili.com/663528522\n */\n@Component\npublic class AuthenticationEntryPointImpl implements AuthenticationEntryPoint &#123;\n    @Override\n    public void commence(HttpServletRequest request, HttpServletResponse response, AuthenticationException authException) throws IOException, ServletException &#123;\n        ResponseResult result = new ResponseResult(HttpStatus.UNAUTHORIZED.value(), \"è®¤è¯å¤±è´¥è¯·é‡æ–°ç™»å½•\");\n        String json = JSON.toJSONString(result);\n        WebUtils.renderString(response,json);\n    &#125;\n&#125;\n\nâ‘¡é…ç½®ç»™SpringSecurity\nå…ˆæ³¨å…¥å¯¹åº”çš„å¤„ç†å™¨\n\n@Autowired\nprivate AuthenticationEntryPoint authenticationEntryPoint;\n\n@Autowired\nprivate AccessDeniedHandler accessDeniedHandler;\n\nç„¶åæˆ‘ä»¬å¯ä»¥ä½¿ç”¨HttpSecurityå¯¹è±¡çš„æ–¹æ³•å»é…ç½®ã€‚\n\nhttp.exceptionHandling().authenticationEntryPoint(authenticationEntryPoint).\n        accessDeniedHandler(accessDeniedHandler);\n\n\n5. è·¨åŸŸæµè§ˆå™¨å‡ºäºå®‰å…¨çš„è€ƒè™‘ï¼Œä½¿ç”¨ XMLHttpRequestå¯¹è±¡å‘èµ· HTTPè¯·æ±‚æ—¶å¿…é¡»éµå®ˆåŒæºç­–ç•¥ï¼Œå¦åˆ™å°±æ˜¯è·¨åŸŸçš„HTTPè¯·æ±‚ï¼Œé»˜è®¤æƒ…å†µä¸‹æ˜¯è¢«ç¦æ­¢çš„ã€‚ åŒæºç­–ç•¥è¦æ±‚æºç›¸åŒæ‰èƒ½æ­£å¸¸è¿›è¡Œé€šä¿¡ï¼Œå³åè®®ã€åŸŸåã€ç«¯å£å·éƒ½å®Œå…¨ä¸€è‡´ã€‚\n\nå‰åç«¯åˆ†ç¦»é¡¹ç›®ï¼Œå‰ç«¯é¡¹ç›®å’Œåç«¯é¡¹ç›®ä¸€èˆ¬éƒ½ä¸æ˜¯åŒæºçš„ï¼Œæ‰€ä»¥è‚¯å®šä¼šå­˜åœ¨è·¨åŸŸè¯·æ±‚çš„é—®é¢˜ã€‚\n\næ‰€ä»¥æˆ‘ä»¬å°±è¦å¤„ç†ä¸€ä¸‹ï¼Œè®©å‰ç«¯èƒ½è¿›è¡Œè·¨åŸŸè¯·æ±‚ã€‚\n\nâ‘ å…ˆå¯¹SpringBooté…ç½®ï¼Œè¿è¡Œè·¨åŸŸè¯·æ±‚\n@Configuration\npublic class CorsConfig implements WebMvcConfigurer &#123;\n\n    @Override\n    public void addCorsMappings(CorsRegistry registry) &#123;\n      // è®¾ç½®å…è®¸è·¨åŸŸçš„è·¯å¾„\n        registry.addMapping(\"/**\")\n                // è®¾ç½®å…è®¸è·¨åŸŸè¯·æ±‚çš„åŸŸå\n                .allowedOriginPatterns(\"*\")\n                // æ˜¯å¦å…è®¸cookie\n                .allowCredentials(true)\n                // è®¾ç½®å…è®¸çš„è¯·æ±‚æ–¹å¼\n                .allowedMethods(\"GET\", \"POST\", \"DELETE\", \"PUT\")\n                // è®¾ç½®å…è®¸çš„headerå±æ€§\n                .allowedHeaders(\"*\")\n                // è·¨åŸŸå…è®¸æ—¶é—´\n                .maxAge(3600);\n    &#125;\n&#125;\n\nâ‘¡å¼€å¯SpringSecurityçš„è·¨åŸŸè®¿é—®\nç”±äºæˆ‘ä»¬çš„èµ„æºéƒ½ä¼šæ”¶åˆ°SpringSecurityçš„ä¿æŠ¤ï¼Œæ‰€ä»¥æƒ³è¦è·¨åŸŸè®¿é—®è¿˜è¦è®©SpringSecurityè¿è¡Œè·¨åŸŸè®¿é—®ã€‚\n@Override\nprotected void configure(HttpSecurity http) throws Exception &#123;\n    http\n            //å…³é—­csrf\n            .csrf().disable()\n            //ä¸é€šè¿‡Sessionè·å–SecurityContext\n            .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS)\n            .and()\n            .authorizeRequests()\n            // å¯¹äºç™»å½•æ¥å£ å…è®¸åŒ¿åè®¿é—®\n            .antMatchers(\"/user/login\").anonymous()\n            // é™¤ä¸Šé¢å¤–çš„æ‰€æœ‰è¯·æ±‚å…¨éƒ¨éœ€è¦é‰´æƒè®¤è¯\n            .anyRequest().authenticated();\n\n    //æ·»åŠ è¿‡æ»¤å™¨\n    http.addFilterBefore(jwtAuthenticationTokenFilter, UsernamePasswordAuthenticationFilter.class);\n\n    //é…ç½®å¼‚å¸¸å¤„ç†å™¨\n    http.exceptionHandling()\n            //é…ç½®è®¤è¯å¤±è´¥å¤„ç†å™¨\n            .authenticationEntryPoint(authenticationEntryPoint)\n            .accessDeniedHandler(accessDeniedHandler);\n\n    //å…è®¸è·¨åŸŸ\n    http.cors();\n&#125;\n\n\n6. é—ç•™å°é—®é¢˜\nå…¶å®ƒæƒé™æ ¡éªŒæ–¹æ³•æˆ‘ä»¬å‰é¢éƒ½æ˜¯ä½¿ç”¨@PreAuthorizeæ³¨è§£ï¼Œç„¶ååœ¨åœ¨å…¶ä¸­ä½¿ç”¨çš„æ˜¯hasAuthorityæ–¹æ³•è¿›è¡Œæ ¡éªŒã€‚SpringSecurityè¿˜ä¸ºæˆ‘ä»¬æä¾›äº†å…¶å®ƒæ–¹æ³•ä¾‹å¦‚ï¼šhasAnyAuthorityï¼ŒhasRoleï¼ŒhasAnyRoleç­‰ã€‚\n\n\n\nè¿™é‡Œæˆ‘ä»¬å…ˆä¸æ€¥ç€å»ä»‹ç»è¿™äº›æ–¹æ³•ï¼Œæˆ‘ä»¬å…ˆå»ç†è§£hasAuthorityçš„åŸç†ï¼Œç„¶åå†å»å­¦ä¹ å…¶ä»–æ–¹æ³•ä½ å°±æ›´å®¹æ˜“ç†è§£ï¼Œè€Œä¸æ˜¯æ­»è®°ç¡¬èƒŒåŒºåˆ«ã€‚å¹¶ä¸”æˆ‘ä»¬ä¹Ÿå¯ä»¥é€‰æ‹©å®šä¹‰æ ¡éªŒæ–¹æ³•ï¼Œå®ç°æˆ‘ä»¬è‡ªå·±çš„æ ¡éªŒé€»è¾‘ã€‚\n\nhasAuthorityæ–¹æ³•å®é™…æ˜¯æ‰§è¡Œåˆ°äº†SecurityExpressionRootçš„hasAuthorityï¼Œå¤§å®¶åªè¦æ–­ç‚¹è°ƒè¯•æ—¢å¯çŸ¥é“å®ƒå†…éƒ¨çš„æ ¡éªŒåŸç†ã€‚\n\nå®ƒå†…éƒ¨å…¶å®æ˜¯è°ƒç”¨authenticationçš„getAuthoritiesæ–¹æ³•è·å–ç”¨æˆ·çš„æƒé™åˆ—è¡¨ã€‚ç„¶ååˆ¤æ–­æˆ‘ä»¬å­˜å…¥çš„æ–¹æ³•å‚æ•°æ•°æ®åœ¨æƒé™åˆ—è¡¨ä¸­ã€‚\n\nhasAnyAuthorityæ–¹æ³•å¯ä»¥ä¼ å…¥å¤šä¸ªæƒé™ï¼Œåªæœ‰ç”¨æˆ·æœ‰å…¶ä¸­ä»»æ„ä¸€ä¸ªæƒé™éƒ½å¯ä»¥è®¿é—®å¯¹åº”èµ„æºã€‚\n\n@PreAuthorize(\"hasAnyAuthority('admin','test','system:dept:list')\")\npublic String hello()&#123;\n    return \"hello\";\n&#125;\n\nhasRoleè¦æ±‚æœ‰å¯¹åº”çš„è§’è‰²æ‰å¯ä»¥è®¿é—®ï¼Œä½†æ˜¯å®ƒå†…éƒ¨ä¼šæŠŠæˆ‘ä»¬ä¼ å…¥çš„å‚æ•°æ‹¼æ¥ä¸Š **ROLE_** åå†å»æ¯”è¾ƒã€‚æ‰€ä»¥è¿™ç§æƒ…å†µä¸‹è¦ç”¨ç”¨æˆ·å¯¹åº”çš„æƒé™ä¹Ÿè¦æœ‰ **ROLE_** è¿™ä¸ªå‰ç¼€æ‰å¯ä»¥ã€‚\n\n@PreAuthorize(\"hasRole('system:dept:list')\")\npublic String hello()&#123;\n    return \"hello\";\n&#125;\n\nhasAnyRole æœ‰ä»»æ„çš„è§’è‰²å°±å¯ä»¥è®¿é—®ã€‚å®ƒå†…éƒ¨ä¹Ÿä¼šæŠŠæˆ‘ä»¬ä¼ å…¥çš„å‚æ•°æ‹¼æ¥ä¸Š **ROLE_** åå†å»æ¯”è¾ƒã€‚æ‰€ä»¥è¿™ç§æƒ…å†µä¸‹è¦ç”¨ç”¨æˆ·å¯¹åº”çš„æƒé™ä¹Ÿè¦æœ‰ **ROLE_** è¿™ä¸ªå‰ç¼€æ‰å¯ä»¥ã€‚\n\n@PreAuthorize(\"hasAnyRole('admin','system:dept:list')\")\npublic String hello()&#123;\n    return \"hello\";\n&#125;\n\n\nè‡ªå®šä¹‰æƒé™æ ¡éªŒæ–¹æ³•æˆ‘ä»¬ä¹Ÿå¯ä»¥å®šä¹‰è‡ªå·±çš„æƒé™æ ¡éªŒæ–¹æ³•ï¼Œåœ¨@PreAuthorizeæ³¨è§£ä¸­ä½¿ç”¨æˆ‘ä»¬çš„æ–¹æ³•ã€‚\n\n@Component(\"ex\")\npublic class SGExpressionRoot &#123;\n\n    public boolean hasAuthority(String authority)&#123;\n        //è·å–å½“å‰ç”¨æˆ·çš„æƒé™\n        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();\n        LoginUser loginUser = (LoginUser) authentication.getPrincipal();\n        List&lt;String> permissions = loginUser.getPermissions();\n        //åˆ¤æ–­ç”¨æˆ·æƒé™é›†åˆä¸­æ˜¯å¦å­˜åœ¨authority\n        return permissions.contains(authority);\n    &#125;\n&#125;\n\n åœ¨SPELè¡¨è¾¾å¼ä¸­ä½¿ç”¨ @exç›¸å½“äºè·å–å®¹å™¨ä¸­beançš„åå­—æœªexçš„å¯¹è±¡ã€‚ç„¶åå†è°ƒç”¨è¿™ä¸ªå¯¹è±¡çš„hasAuthorityæ–¹æ³•\n\n@RequestMapping(\"/hello\")\n@PreAuthorize(\"@ex.hasAuthority('system:dept:list')\")\npublic String hello()&#123;\n    return \"hello\";\n&#125;\n\n\nåŸºäºé…ç½®çš„æƒé™æ§åˆ¶æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨é…ç½®ç±»ä¸­ä½¿ç”¨ä½¿ç”¨é…ç½®çš„æ–¹å¼å¯¹èµ„æºè¿›è¡Œæƒé™æ§åˆ¶ã€‚\n\n@Override\nprotected void configure(HttpSecurity http) throws Exception &#123;\n    http\n            //å…³é—­csrf\n            .csrf().disable()\n            //ä¸é€šè¿‡Sessionè·å–SecurityContext\n            .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS)\n            .and()\n            .authorizeRequests()\n            // å¯¹äºç™»å½•æ¥å£ å…è®¸åŒ¿åè®¿é—®\n            .antMatchers(\"/user/login\").anonymous()\n            .antMatchers(\"/testCors\").hasAuthority(\"system:dept:list222\")\n            // é™¤ä¸Šé¢å¤–çš„æ‰€æœ‰è¯·æ±‚å…¨éƒ¨éœ€è¦é‰´æƒè®¤è¯\n            .anyRequest().authenticated();\n\n    //æ·»åŠ è¿‡æ»¤å™¨\n    http.addFilterBefore(jwtAuthenticationTokenFilter, UsernamePasswordAuthenticationFilter.class);\n\n    //é…ç½®å¼‚å¸¸å¤„ç†å™¨\n    http.exceptionHandling()\n            //é…ç½®è®¤è¯å¤±è´¥å¤„ç†å™¨\n            .authenticationEntryPoint(authenticationEntryPoint)\n            .accessDeniedHandler(accessDeniedHandler);\n\n    //å…è®¸è·¨åŸŸ\n    http.cors();\n&#125;\n\n\nCSRFCSRFæ˜¯æŒ‡è·¨ç«™è¯·æ±‚ä¼ªé€ ï¼ˆCross-site request forgeryï¼‰ï¼Œæ˜¯webå¸¸è§çš„æ”»å‡»ä¹‹ä¸€ã€‚\n\n[https://blog.csdn.net/freeking101/article/details/86537087](https://blog.csdn.net/freeking101/article/details/86537087)\n\nSpringSecurityå»é˜²æ­¢CSRFæ”»å‡»çš„æ–¹å¼å°±æ˜¯é€šè¿‡csrf_tokenã€‚åç«¯ä¼šç”Ÿæˆä¸€ä¸ªcsrf_tokenï¼Œå‰ç«¯å‘èµ·è¯·æ±‚çš„æ—¶å€™éœ€è¦æºå¸¦è¿™ä¸ªcsrf_token,åç«¯ä¼šæœ‰è¿‡æ»¤å™¨è¿›è¡Œæ ¡éªŒï¼Œå¦‚æœæ²¡æœ‰æºå¸¦æˆ–è€…æ˜¯ä¼ªé€ çš„å°±ä¸å…è®¸è®¿é—®ã€‚\n\næˆ‘ä»¬å¯ä»¥å‘ç°CSRFæ”»å‡»ä¾é çš„æ˜¯cookieä¸­æ‰€æºå¸¦çš„è®¤è¯ä¿¡æ¯ã€‚ä½†æ˜¯åœ¨å‰åç«¯åˆ†ç¦»çš„é¡¹ç›®ä¸­æˆ‘ä»¬çš„è®¤è¯ä¿¡æ¯å…¶å®æ˜¯tokenï¼Œè€Œtokenå¹¶ä¸æ˜¯å­˜å‚¨ä¸­cookieä¸­ï¼Œå¹¶ä¸”éœ€è¦å‰ç«¯ä»£ç å»æŠŠtokenè®¾ç½®åˆ°è¯·æ±‚å¤´ä¸­æ‰å¯ä»¥ï¼Œæ‰€ä»¥CSRFæ”»å‡»ä¹Ÿå°±ä¸ç”¨æ‹…å¿ƒäº†ã€‚\n\n\nè®¤è¯æˆåŠŸå¤„ç†å™¨å®é™…ä¸Šåœ¨UsernamePasswordAuthenticationFilterè¿›è¡Œç™»å½•è®¤è¯çš„æ—¶å€™ï¼Œå¦‚æœç™»å½•æˆåŠŸäº†æ˜¯ä¼šè°ƒç”¨AuthenticationSuccessHandlerçš„æ–¹æ³•è¿›è¡Œè®¤è¯æˆåŠŸåçš„å¤„ç†çš„ã€‚AuthenticationSuccessHandlerå°±æ˜¯ç™»å½•æˆåŠŸå¤„ç†å™¨ã€‚\n\næˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå·±å»è‡ªå®šä¹‰æˆåŠŸå¤„ç†å™¨è¿›è¡ŒæˆåŠŸåçš„ç›¸åº”å¤„ç†ã€‚\n\n@Component\npublic class SGSuccessHandler implements AuthenticationSuccessHandler &#123;\n\n    @Override\n    public void onAuthenticationSuccess(HttpServletRequest request, HttpServletResponse response, Authentication authentication) throws IOException, ServletException &#123;\n        System.out.println(\"è®¤è¯æˆåŠŸäº†\");\n    &#125;\n&#125;\n\n@Configuration\npublic class SecurityConfig extends WebSecurityConfigurerAdapter &#123;\n\n    @Autowired\n    private AuthenticationSuccessHandler successHandler;\n\n    @Override\n    protected void configure(HttpSecurity http) throws Exception &#123;\n        http.formLogin().successHandler(successHandler);\n\n        http.authorizeRequests().anyRequest().authenticated();\n    &#125;\n&#125;\n\n\nè®¤è¯å¤±è´¥å¤„ç†å™¨å®é™…ä¸Šåœ¨UsernamePasswordAuthenticationFilterè¿›è¡Œç™»å½•è®¤è¯çš„æ—¶å€™ï¼Œå¦‚æœè®¤è¯å¤±è´¥äº†æ˜¯ä¼šè°ƒç”¨AuthenticationFailureHandlerçš„æ–¹æ³•è¿›è¡Œè®¤è¯å¤±è´¥åçš„å¤„ç†çš„ã€‚AuthenticationFailureHandlerå°±æ˜¯ç™»å½•å¤±è´¥å¤„ç†å™¨ã€‚\n\næˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå·±å»è‡ªå®šä¹‰å¤±è´¥å¤„ç†å™¨è¿›è¡Œå¤±è´¥åçš„ç›¸åº”å¤„ç†ã€‚\n\n@Component\npublic class SGFailureHandler implements AuthenticationFailureHandler &#123;\n    @Override\n    public void onAuthenticationFailure(HttpServletRequest request, HttpServletResponse response, AuthenticationException exception) throws IOException, ServletException &#123;\n        System.out.println(\"è®¤è¯å¤±è´¥äº†\");\n    &#125;\n&#125;\n\n@Configuration\npublic class SecurityConfig extends WebSecurityConfigurerAdapter &#123;\n\n    @Autowired\n    private AuthenticationSuccessHandler successHandler;\n\n    @Autowired\n    private AuthenticationFailureHandler failureHandler;\n\n    @Override\n    protected void configure(HttpSecurity http) throws Exception &#123;\n        http.formLogin()\n//                é…ç½®è®¤è¯æˆåŠŸå¤„ç†å™¨\n                .successHandler(successHandler)\n//                é…ç½®è®¤è¯å¤±è´¥å¤„ç†å™¨\n                .failureHandler(failureHandler);\n\n        http.authorizeRequests().anyRequest().authenticated();\n    &#125;\n&#125;\n\n\nç™»å‡ºæˆåŠŸå¤„ç†å™¨@Component\npublic class SGLogoutSuccessHandler implements LogoutSuccessHandler &#123;\n    @Override\n    public void onLogoutSuccess(HttpServletRequest request, HttpServletResponse response, Authentication authentication) throws IOException, ServletException &#123;\n        System.out.println(\"æ³¨é”€æˆåŠŸ\");\n    &#125;\n&#125;\n\n@Configuration\npublic class SecurityConfig extends WebSecurityConfigurerAdapter &#123;\n\n    @Autowired\n    private AuthenticationSuccessHandler successHandler;\n\n    @Autowired\n    private AuthenticationFailureHandler failureHandler;\n\n    @Autowired\n    private LogoutSuccessHandler logoutSuccessHandler;\n\n    @Override\n    protected void configure(HttpSecurity http) throws Exception &#123;\n        http.formLogin()\n//                é…ç½®è®¤è¯æˆåŠŸå¤„ç†å™¨\n                .successHandler(successHandler)\n//                é…ç½®è®¤è¯å¤±è´¥å¤„ç†å™¨\n                .failureHandler(failureHandler);\n\n        http.logout()\n                //é…ç½®æ³¨é”€æˆåŠŸå¤„ç†å™¨\n                .logoutSuccessHandler(logoutSuccessHandler);\n\n        http.authorizeRequests().anyRequest().authenticated();\n    &#125;\n&#125;\n\n","slug":"SpringSecurity","date":"2022-06-09T08:30:49.418Z","categories_index":"SpringSecurity","tags_index":"java,SpringSecurity,Spring","author_index":"å°æä¸åœ¨_"},{"id":"e1579ed1c931165c644c9ec68da7a87a","title":"Kafka","content":"ä¸€ã€ä¸ºä»€ä¹ˆä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—1.ä½¿ç”¨åŒæ­¥çš„é€šä¿¡æ–¹å¼æ¥è§£å†³å¤šä¸ªæœåŠ¡ä¹‹é—´çš„é€šä¿¡åŒæ­¥çš„é€šä¿¡æ–¹å¼ä¼šå­˜åœ¨æ€§èƒ½å’Œç¨³å®šæ€§çš„é—®é¢˜ã€‚\n2.ä½¿ç”¨å¼‚æ­¥çš„é€šä¿¡æ–¹å¼\né’ˆå¯¹äºåŒæ­¥çš„é€šä¿¡æ–¹å¼æ¥è¯´ï¼Œå¼‚æ­¥çš„æ–¹å¼ï¼Œå¯ä»¥è®©ä¸Šæ¸¸å¿«é€ŸæˆåŠŸï¼Œæå¤§æé«˜äº†ç³»ç»Ÿçš„ååé‡ã€‚è€Œä¸”åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œé€šè¿‡ä¸‹æ¸¸å¤šä¸ªæœåŠ¡çš„åˆ†å¸ƒå¼äº‹åŠ¡çš„ä¿éšœï¼Œä¹Ÿèƒ½ä¿éšœä¸šåŠ¡æ‰§è¡Œä¹‹åçš„æœ€ç»ˆä¸€è‡´æ€§ã€‚\næ¶ˆæ¯é˜Ÿåˆ—è§£å†³å…·ä½“çš„æ˜¯ä»€ä¹ˆé—®é¢˜â€”â€”é€šä¿¡é—®é¢˜ã€‚\näºŒã€æ¶ˆæ¯é˜Ÿåˆ—çš„æµæ´¾ç›®å‰æ¶ˆæ¯é˜Ÿåˆ—çš„ä¸­é—´ä»¶é€‰å‹æœ‰å¾ˆå¤šç§ï¼š\n\nrabbitMQï¼šå†…éƒ¨çš„å¯ç©æ€§ï¼ˆåŠŸèƒ½æ€§ï¼‰æ˜¯éå¸¸å¼ºçš„\n\nrocketMQï¼š é˜¿é‡Œå†…éƒ¨ä¸€ä¸ªå¤§ç¥ï¼Œæ ¹æ®kafkaçš„å†…éƒ¨æ‰§è¡ŒåŸç†ï¼Œæ‰‹å†™çš„ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶ã€‚æ€§èƒ½æ˜¯ä¸Kafkaç›¸æ¯”è‚©ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œåœ¨åŠŸèƒ½ä¸Šå°è£…äº†æ›´å¤šçš„åŠŸèƒ½ã€‚\n\nkafkaï¼šå…¨çƒæ¶ˆæ¯å¤„ç†æ€§èƒ½æœ€å¿«çš„ä¸€æ¬¾MQ\n\nzeroMQ\n\n\nè¿™äº›æ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ\n1. æœ‰broker\né‡topicï¼šKafkaã€RocketMQã€ActiveMQ\næ•´ä¸ªbrokerï¼Œä¾æ®topicæ¥è¿›è¡Œæ¶ˆæ¯çš„ä¸­è½¬ã€‚åœ¨é‡topicçš„æ¶ˆæ¯é˜Ÿåˆ—é‡Œå¿…ç„¶éœ€è¦topicçš„å­˜åœ¨\n\nè½»topicï¼šRabbitMQ\ntopicåªæ˜¯ä¸€ç§ä¸­è½¬æ¨¡å¼ã€‚\n\n\n2.æ— brokeråœ¨ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¹‹é—´æ²¡æœ‰ä½¿ç”¨brokerï¼Œä¾‹å¦‚zeroMQï¼Œç›´æ¥ä½¿ç”¨socketè¿›è¡Œé€šä¿¡ã€‚\nä¸‰ã€Kafkaçš„åŸºæœ¬çŸ¥è¯†1.Kafkaçš„å®‰è£…\néƒ¨ç½²ä¸€å°zookeeperæœåŠ¡å™¨\nå®‰è£…jdk\nä¸‹è½½kafkaçš„å®‰è£…åŒ…ï¼šhttp://kafka.apache.org/downloads\nä¸Šä¼ åˆ°kafkaæœåŠ¡å™¨ä¸Šï¼š/usr/local/kafka\nè§£å‹ç¼©å‹ç¼©åŒ…\nè¿›å…¥åˆ°configç›®å½•å†…ï¼Œä¿®æ”¹server.properties\n\n#broker.idå±æ€§åœ¨kafkaé›†ç¾¤ä¸­å¿…é¡»è¦æ˜¯å”¯ä¸€\nbroker.id=0\n#kafkaéƒ¨ç½²çš„æœºå™¨ipå’Œæä¾›æœåŠ¡çš„ç«¯å£å·\nlisteners=PLAINTEXT://192.168.65.60:9092   \n#kafkaçš„æ¶ˆæ¯å­˜å‚¨æ–‡ä»¶\nlog.dir=/usr/local/data/kafka-logs\n#kafkaè¿æ¥zookeeperçš„åœ°å€\nzookeeper.connect=192.168.65.60:2181\n\n\nè¿›å…¥åˆ°binç›®å½•å†…ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ¥å¯åŠ¨kafkaæœåŠ¡å™¨ï¼ˆå¸¦ç€é…ç½®æ–‡ä»¶ï¼‰\n\n./kafka-server-start.sh -daemon ../config/server.properties \n\n\næ ¡éªŒkafkaæ˜¯å¦å¯åŠ¨æˆåŠŸï¼š\n\nè¿›å…¥åˆ°zkå†…æŸ¥çœ‹æ˜¯å¦æœ‰kafkaçš„èŠ‚ç‚¹ï¼š/brokers/ids/0\nserver.propertiesæ ¸å¿ƒé…ç½®è¯¦è§£\n\n\nProperty\nDefault\nDescription\n\n\n\nbroker.id\n0\næ¯ä¸ªbrokeréƒ½å¯ä»¥ç”¨ä¸€ä¸ªå”¯ä¸€çš„éè´Ÿæ•´æ•°idè¿›è¡Œæ ‡è¯†ï¼›è¿™ä¸ªidå¯ä»¥ä½œä¸ºbrokerçš„â€œåå­—â€ï¼Œä½ å¯ä»¥é€‰æ‹©ä»»æ„ä½ å–œæ¬¢çš„æ•°å­—ä½œä¸ºidï¼Œåªè¦idæ˜¯å”¯ä¸€çš„å³å¯ã€‚\n\n\nlog.dirs\n&#x2F;tmp&#x2F;kafka-logs\nkafkaå­˜æ”¾æ•°æ®çš„è·¯å¾„ã€‚è¿™ä¸ªè·¯å¾„å¹¶ä¸æ˜¯å”¯ä¸€çš„ï¼Œå¯ä»¥æ˜¯å¤šä¸ªï¼Œè·¯å¾„ä¹‹é—´åªéœ€è¦ä½¿ç”¨é€—å·åˆ†éš”å³å¯ï¼›æ¯å½“åˆ›å»ºæ–°partitionæ—¶ï¼Œéƒ½ä¼šé€‰æ‹©åœ¨åŒ…å«æœ€å°‘partitionsçš„è·¯å¾„ä¸‹è¿›è¡Œã€‚\n\n\nlisteners\nPLAINTEXT:&#x2F;&#x2F;192.168.65.60:9092\nserveræ¥å—å®¢æˆ·ç«¯è¿æ¥çš„ç«¯å£ï¼Œipé…ç½®kafkaæœ¬æœºipå³å¯\n\n\nzookeeper.connect\nlocalhost:2181\nzooKeeperè¿æ¥å­—ç¬¦ä¸²çš„æ ¼å¼ä¸ºï¼šhostname:portï¼Œæ­¤å¤„hostnameå’Œportåˆ†åˆ«æ˜¯ZooKeeperé›†ç¾¤ä¸­æŸä¸ªèŠ‚ç‚¹çš„hostå’Œportï¼›zookeeperå¦‚æœæ˜¯é›†ç¾¤ï¼Œè¿æ¥æ–¹å¼ä¸º hostname1:port1, hostname2:port2, hostname3:port3\n\n\nlog.retention.hours\n168\næ¯ä¸ªæ—¥å¿—æ–‡ä»¶åˆ é™¤ä¹‹å‰ä¿å­˜çš„æ—¶é—´ã€‚é»˜è®¤æ•°æ®ä¿å­˜æ—¶é—´å¯¹æ‰€æœ‰topicéƒ½ä¸€æ ·ã€‚\n\n\nnum.partitions\n1\nåˆ›å»ºtopicçš„é»˜è®¤åˆ†åŒºæ•°\n\n\ndefault.replication.factor\n1\nè‡ªåŠ¨åˆ›å»ºtopicçš„é»˜è®¤å‰¯æœ¬æ•°é‡ï¼Œå»ºè®®è®¾ç½®ä¸ºå¤§äºç­‰äº2\n\n\nmin.insync.replicas\n1\nå½“producerè®¾ç½®acksä¸º-1æ—¶ï¼Œmin.insync.replicasæŒ‡å®šreplicasçš„æœ€å°æ•°ç›®ï¼ˆå¿…é¡»ç¡®è®¤æ¯ä¸€ä¸ªrepicaçš„å†™æ•°æ®éƒ½æ˜¯æˆåŠŸçš„ï¼‰ï¼Œå¦‚æœè¿™ä¸ªæ•°ç›®æ²¡æœ‰è¾¾åˆ°ï¼Œproducerå‘é€æ¶ˆæ¯ä¼šäº§ç”Ÿå¼‚å¸¸\n\n\ndelete.topic.enable\nfalse\næ˜¯å¦å…è®¸åˆ é™¤ä¸»é¢˜\n\n\n2.kafkaä¸­çš„ä¸€äº›åŸºæœ¬æ¦‚å¿µ\n\n\nåç§°\nè§£é‡Š\n\n\n\nBroker\næ¶ˆæ¯ä¸­é—´ä»¶å¤„ç†èŠ‚ç‚¹ï¼Œä¸€ä¸ªKafkaèŠ‚ç‚¹å°±æ˜¯ä¸€ä¸ªbrokerï¼Œä¸€ä¸ªæˆ–è€…å¤šä¸ªBrokerå¯ä»¥ç»„æˆä¸€ä¸ªKafkaé›†ç¾¤\n\n\nTopic\nKafkaæ ¹æ®topicå¯¹æ¶ˆæ¯è¿›è¡Œå½’ç±»ï¼Œå‘å¸ƒåˆ°Kafkaé›†ç¾¤çš„æ¯æ¡æ¶ˆæ¯éƒ½éœ€è¦æŒ‡å®šä¸€ä¸ªtopic\n\n\nProducer\næ¶ˆæ¯ç”Ÿäº§è€…ï¼Œå‘Brokerå‘é€æ¶ˆæ¯çš„å®¢æˆ·ç«¯\n\n\nConsumer\næ¶ˆæ¯æ¶ˆè´¹è€…ï¼Œä»Brokerè¯»å–æ¶ˆæ¯çš„å®¢æˆ·ç«¯\n\n\n\n\n\n\n\n\n\n\n3.åˆ›å»ºtopic\né€šè¿‡kafkaå‘½ä»¤å‘zkä¸­åˆ›å»ºä¸€ä¸ªä¸»é¢˜\n\n./kafka-topics.sh --create --zookeeper 172.16.253.35:2181 --replication-factor 1 --partitions 1 --topic test\n\n\næŸ¥çœ‹å½“å‰zkä¸­æ‰€æœ‰çš„ä¸»é¢˜\n\n./kafka-topics.sh --list --zookeeper 172.16.253.35:2181 test\n\n\n\n4.å‘é€æ¶ˆæ¯æŠŠæ¶ˆæ¯å‘é€ç»™brokerä¸­çš„æŸä¸ªtopicï¼Œæ‰“å¼€ä¸€ä¸ªkafkaå‘é€æ¶ˆæ¯çš„å®¢æˆ·ç«¯ï¼Œç„¶åå¼€å§‹ç”¨å®¢æˆ·ç«¯å‘kafkaæœåŠ¡å™¨å‘é€æ¶ˆæ¯\n./kafka-console-consumer.sh --bootstrap-server 172.16.253.38:9092 --topic test\n\n\n\n5.æ¶ˆè´¹æ¶ˆæ¯æ‰“å¼€ä¸€ä¸ªæ¶ˆè´¹æ¶ˆæ¯çš„å®¢æˆ·ç«¯ï¼Œå‘kafkaæœåŠ¡å™¨çš„æŸä¸ªä¸»é¢˜æ¶ˆè´¹æ¶ˆæ¯\n\næ–¹å¼ä¸€ï¼šä»å½“å‰ä¸»é¢˜ä¸­çš„æœ€åä¸€æ¡æ¶ˆæ¯çš„offsetï¼ˆåç§»é‡ä½ç½®ï¼‰+1å¼€å§‹æ¶ˆè´¹\n\n./kafka-console-consumer.sh --bootstrap-server 172.16.253.38:9092 --topic test\n\n\næ–¹å¼äºŒï¼šä»å½“å‰ä¸»é¢˜ä¸­çš„ç¬¬ä¸€æ¡æ¶ˆæ¯å¼€å§‹æ¶ˆè´¹\n\n./kafka-console-consumer.sh --bootstrap-server 172.16.253.38:9092 --from-beginning --topic test\n\n\n\n6.å…³äºæ¶ˆæ¯çš„ç»†èŠ‚\n\nç”Ÿäº§è€…å°†æ¶ˆæ¯å‘é€ç»™brokerï¼Œbrokerä¼šå°†æ¶ˆæ¯ä¿å­˜åœ¨æœ¬åœ°çš„æ—¥å¿—æ–‡ä»¶ä¸­\n\n/usr/local/kafka/data/kafka-logs/ä¸»é¢˜-åˆ†åŒº/00000000.log\n\n\næ¶ˆæ¯çš„ä¿å­˜æ˜¯æœ‰åºçš„ï¼Œé€šè¿‡offsetåç§»é‡æ¥æè¿°æ¶ˆæ¯çš„æœ‰åºæ€§\næ¶ˆè´¹è€…æ¶ˆè´¹æ¶ˆæ¯æ—¶ä¹Ÿæ˜¯é€šè¿‡offsetæ¥æè¿°å½“å‰è¦æ¶ˆè´¹çš„é‚£æ¡æ¶ˆæ¯çš„ä½ç½®\n\n7.å•æ’­æ¶ˆæ¯åœ¨ä¸€ä¸ªkafkaçš„topicä¸­ï¼Œå¯åŠ¨ä¸¤ä¸ªæ¶ˆè´¹è€…ï¼Œä¸€ä¸ªç”Ÿäº§è€…ï¼Œé—®ï¼šç”Ÿäº§è€…å‘é€æ¶ˆæ¯ï¼Œè¿™æ¡æ¶ˆæ¯æ˜¯å¦åŒæ—¶ä¼šè¢«ä¸¤ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹ï¼Ÿ\nå¦‚æœå¤šä¸ªæ¶ˆè´¹è€…åœ¨åŒä¸€ä¸ªæ¶ˆè´¹ç»„ï¼Œé‚£ä¹ˆåªæœ‰ä¸€ä¸ªæ¶ˆè´¹è€…å¯ä»¥æ”¶åˆ°è®¢é˜…çš„topicä¸­çš„æ¶ˆæ¯ã€‚æ¢è¨€ä¹‹ï¼ŒåŒä¸€ä¸ªæ¶ˆè´¹ç»„ä¸­åªèƒ½æœ‰ä¸€ä¸ªæ¶ˆè´¹è€…æ”¶åˆ°ä¸€ä¸ªtopicä¸­çš„æ¶ˆæ¯ã€‚\n.&#x2F;kafka-console-consumer.sh --bootstrap-server 172.16.253.38:9092  --consumer-property group.id&#x3D;testGroup --topic test\n\n\n\n8.å¤šæ’­æ¶ˆæ¯ä¸åŒçš„æ¶ˆè´¹ç»„è®¢é˜…åŒä¸€ä¸ªtopicï¼Œé‚£ä¹ˆä¸åŒçš„æ¶ˆè´¹ç»„ä¸­åªæœ‰ä¸€ä¸ªæ¶ˆè´¹è€…èƒ½æ”¶åˆ°æ¶ˆæ¯ã€‚å®é™…ä¸Šä¹Ÿæ˜¯å¤šä¸ªæ¶ˆè´¹ç»„ä¸­çš„å¤šä¸ªæ¶ˆè´¹è€…æ”¶åˆ°äº†åŒä¸€ä¸ªæ¶ˆæ¯ã€‚\n./kafka-console-consumer.sh --bootstrap-server 172.16.253.38:9092  --consumer-property group.id=testGroup1 --topic test\n./kafka-console-consumer.sh --bootstrap-server 172.16.253.38:9092  --consumer-property group.id=testGroup2 --topic test\n\n\n\nä¸‹å›¾å°±æ˜¯æè¿°å¤šæ’­å’Œå•æ’­æ¶ˆæ¯çš„åŒºåˆ«\n\n9. æŸ¥çœ‹æ¶ˆè´¹ç»„çš„è¯¦ç»†ä¿¡æ¯é€šè¿‡ä»¥ä¸‹å‘½ä»¤å¯ä»¥æŸ¥çœ‹åˆ°æ¶ˆè´¹ç»„çš„ç›¸ä¿¡ä¿¡æ¯ï¼š\n./kafka-consumer-groups.sh --bootstrap-server 172.16.253.38:9092 --describe --group testGroup\n\n\né‡ç‚¹å…³æ³¨ä»¥ä¸‹å‡ ä¸ªä¿¡æ¯ï¼š\n\ncurrent-offset: æœ€åè¢«æ¶ˆè´¹çš„æ¶ˆæ¯çš„åç§»é‡\nLog-end-offset: æ¶ˆæ¯æ€»é‡ï¼ˆæœ€åä¸€æ¡æ¶ˆæ¯çš„åç§»é‡ï¼‰\nLagï¼šç§¯å‹äº†å¤šå°‘æ¡æ¶ˆæ¯\n\nå››ã€Kafkaä¸­ä¸»é¢˜å’Œåˆ†åŒºçš„æ¦‚å¿µ1.ä¸»é¢˜Topicä¸»é¢˜-topicåœ¨kafkaä¸­æ˜¯ä¸€ä¸ªé€»è¾‘çš„æ¦‚å¿µï¼Œkafkaé€šè¿‡topicå°†æ¶ˆæ¯è¿›è¡Œåˆ†ç±»ã€‚ä¸åŒçš„topicä¼šè¢«è®¢é˜…è¯¥topicçš„æ¶ˆè´¹è€…æ¶ˆè´¹ã€‚\nä½†æ˜¯æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœè¯´è¿™ä¸ªtopicä¸­çš„æ¶ˆæ¯éå¸¸éå¸¸å¤šï¼Œå¤šåˆ°éœ€è¦å‡ Tæ¥å­˜ï¼Œå› ä¸ºæ¶ˆæ¯æ˜¯ä¼šè¢«ä¿å­˜åˆ°logæ—¥å¿—æ–‡ä»¶ä¸­çš„ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªæ–‡ä»¶è¿‡å¤§çš„é—®é¢˜ï¼Œkafkaæå‡ºäº†Partitionåˆ†åŒºçš„æ¦‚å¿µ\n2.åˆ†åŒºPartition1ï¼‰åˆ†åŒºçš„æ¦‚å¿µé€šè¿‡partitionå°†ä¸€ä¸ªtopicä¸­çš„æ¶ˆæ¯åˆ†åŒºæ¥å­˜å‚¨ã€‚è¿™æ ·çš„å¥½å¤„æœ‰å¤šä¸ªï¼š\n\nåˆ†åŒºå­˜å‚¨ï¼Œå¯ä»¥è§£å†³ç»Ÿä¸€å­˜å‚¨æ–‡ä»¶è¿‡å¤§çš„é—®é¢˜\næä¾›äº†è¯»å†™çš„ååé‡ï¼šè¯»å’Œå†™å¯ä»¥åŒæ—¶åœ¨å¤šä¸ªåˆ†åŒºä¸­è¿›è¡Œ\n\n\n\n\n\n2ï¼‰åˆ›å»ºå¤šåˆ†åŒºçš„ä¸»é¢˜./kafka-topics.sh --create --zookeeper 172.16.253.35:2181 --replication-factor 1 --partitions 2 --topic test1\n\n\n\n3.kafkaä¸­æ¶ˆæ¯æ—¥å¿—æ–‡ä»¶ä¸­ä¿å­˜çš„å†…å®¹\n00000.logï¼š è¿™ä¸ªæ–‡ä»¶ä¸­ä¿å­˜çš„å°±æ˜¯æ¶ˆæ¯\n\n__consumer_offsets-49:\nkafkaå†…éƒ¨è‡ªå·±åˆ›å»ºäº†__consumer_offsetsä¸»é¢˜åŒ…å«äº†50ä¸ªåˆ†åŒºã€‚è¿™ä¸ªä¸»é¢˜ç”¨æ¥å­˜æ”¾æ¶ˆè´¹è€…æ¶ˆè´¹æŸä¸ªä¸»é¢˜çš„åç§»é‡ã€‚å› ä¸ºæ¯ä¸ªæ¶ˆè´¹è€…éƒ½ä¼šè‡ªå·±ç»´æŠ¤ç€æ¶ˆè´¹çš„ä¸»é¢˜çš„åç§»é‡ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯ä¸ªæ¶ˆè´¹è€…ä¼šæŠŠæ¶ˆè´¹çš„ä¸»é¢˜çš„åç§»é‡è‡ªä¸»ä¸ŠæŠ¥ç»™kafkaä¸­çš„é»˜è®¤ä¸»é¢˜ï¼šconsumer_offsetsã€‚å› æ­¤kafkaä¸ºäº†æå‡è¿™ä¸ªä¸»é¢˜çš„å¹¶å‘æ€§ï¼Œé»˜è®¤è®¾ç½®äº†50ä¸ªåˆ†åŒºã€‚\n\næäº¤åˆ°å“ªä¸ªåˆ†åŒºï¼šé€šè¿‡hashå‡½æ•°ï¼šhash(consumerGroupId) % __consumer_offsetsä¸»é¢˜çš„åˆ†åŒºæ•°\n\næäº¤åˆ°è¯¥ä¸»é¢˜ä¸­çš„å†…å®¹æ˜¯ï¼škeyæ˜¯consumerGroupId+topic+åˆ†åŒºå·ï¼Œvalueå°±æ˜¯å½“å‰offsetçš„å€¼\n\n\n\næ–‡ä»¶ä¸­ä¿å­˜çš„æ¶ˆæ¯ï¼Œé»˜è®¤ä¿å­˜7å¤©ã€‚ä¸ƒå¤©åˆ°åæ¶ˆæ¯ä¼šè¢«åˆ é™¤ã€‚\n\n\näº”ã€Kafkaé›†ç¾¤æ“ä½œ1.æ­å»ºkafkaé›†ç¾¤ï¼ˆä¸‰ä¸ªbrokerï¼‰\nåˆ›å»ºä¸‰ä¸ªserver.propertiesæ–‡ä»¶\n\n# 0 1 2\nbroker.id=2\n// 9092 9093 9094\nlisteners=PLAINTEXT://192.168.65.60:9094\n//kafka-logs kafka-logs-1 kafka-logs-2\nlog.dir=/usr/local/data/kafka-logs-2\n\n\né€šè¿‡å‘½ä»¤æ¥å¯åŠ¨ä¸‰å°broker\n\n./kafka-server-start.sh -daemon ../config/server.properties\n./kafka-server-start.sh -daemon ../config/server1.properties\n./kafka-server-start.sh -daemon ../config/server2.properties\n\n\næ ¡éªŒæ˜¯å¦å¯åŠ¨æˆåŠŸ\n\nè¿›å…¥åˆ°zkä¸­æŸ¥çœ‹&#x2F;brokers&#x2F;idsä¸­è¿‡æ˜¯å¦æœ‰ä¸‰ä¸ªznodeï¼ˆ0ï¼Œ1ï¼Œ2ï¼‰\n2.å‰¯æœ¬çš„æ¦‚å¿µåœ¨åˆ›å»ºä¸»é¢˜æ—¶ï¼Œé™¤äº†æŒ‡æ˜äº†ä¸»é¢˜çš„åˆ†åŒºæ•°ä»¥å¤–ï¼Œè¿˜æŒ‡æ˜äº†å‰¯æœ¬æ•°ï¼Œé‚£ä¹ˆå‰¯æœ¬æ˜¯ä¸€ä¸ªä»€ä¹ˆæ¦‚å¿µå‘¢ï¼Ÿ\n./kafka-topics.sh --create --zookeeper 172.16.253.35:2181 --replication-factor 3 --partitions 2 --topic my-replicated-topic\n\n\n\nå‰¯æœ¬æ˜¯ä¸ºäº†ä¸ºä¸»é¢˜ä¸­çš„åˆ†åŒºåˆ›å»ºå¤šä¸ªå¤‡ä»½ï¼Œå¤šä¸ªå‰¯æœ¬åœ¨kafkaé›†ç¾¤çš„å¤šä¸ªbrokerä¸­ï¼Œä¼šæœ‰ä¸€ä¸ªå‰¯æœ¬ä½œä¸ºleaderï¼Œå…¶ä»–æ˜¯followerã€‚\næŸ¥çœ‹topicæƒ…å†µï¼š\n# æŸ¥çœ‹topicæƒ…å†µ\n./kafka-topics.sh --describe --zookeeper 172.16.253.35:2181 --topic my-replicated-topic\n\n\n\n\n\nleaderï¼š\n\nkafkaçš„å†™å’Œè¯»çš„æ“ä½œï¼Œéƒ½å‘ç”Ÿåœ¨leaderä¸Šã€‚leaderè´Ÿè´£æŠŠæ•°æ®åŒæ­¥ç»™followerã€‚å½“leaderæŒ‚äº†ï¼Œç»è¿‡ä¸»ä»é€‰ä¸¾ï¼Œä»å¤šä¸ªfollowerä¸­é€‰ä¸¾äº§ç”Ÿä¸€ä¸ªæ–°çš„leader\n\nfollower\n\næ¥æ”¶leaderçš„åŒæ­¥çš„æ•°æ®\n\nisrï¼š\nå¯ä»¥åŒæ­¥å’Œå·²åŒæ­¥çš„èŠ‚ç‚¹ä¼šè¢«å­˜å…¥åˆ°isré›†åˆä¸­ã€‚è¿™é‡Œæœ‰ä¸€ä¸ªç»†èŠ‚ï¼šå¦‚æœisrä¸­çš„èŠ‚ç‚¹æ€§èƒ½è¾ƒå·®ï¼Œä¼šè¢«è¸¢å‡ºisré›†åˆã€‚\n\n\nï¼ˆé‡ç‚¹ï½ï¼ï¼‰æ­¤æ—¶ï¼Œbrokerã€ä¸»é¢˜ã€åˆ†åŒºã€å‰¯æœ¬ è¿™äº›æ¦‚å¿µå°±å…¨éƒ¨å±•ç°äº†ï¼Œå¤§å®¶éœ€è¦æŠŠè¿™äº›æ¦‚å¿µæ¢³ç†æ¸…æ¥šï¼š\né›†ç¾¤ä¸­æœ‰å¤šä¸ªbrokerï¼Œåˆ›å»ºä¸»é¢˜æ—¶å¯ä»¥æŒ‡æ˜ä¸»é¢˜æœ‰å¤šä¸ªåˆ†åŒºï¼ˆæŠŠæ¶ˆæ¯æ‹†åˆ†åˆ°ä¸åŒçš„åˆ†åŒºä¸­å­˜å‚¨ï¼‰ï¼Œå¯ä»¥ä¸ºåˆ†åŒºåˆ›å»ºå¤šä¸ªå‰¯æœ¬ï¼Œä¸åŒçš„å‰¯æœ¬å­˜æ”¾åœ¨ä¸åŒçš„brokeré‡Œã€‚\n3.å…³äºé›†ç¾¤æ¶ˆè´¹1ï¼‰å‘é›†ç¾¤å‘é€æ¶ˆæ¯ï¼š./kafka-console-consumer.sh --bootstrap-server 172.16.253.38:9092,172.16.253.38:9093,172.16.253.38:9094 --from-beginning --consumer-property group.id=testGroup1 --topic my-replicated-topic\n\n2ï¼‰ä»é›†ç¾¤ä¸­æ¶ˆè´¹æ¶ˆæ¯./kafka-console-producer.sh --broker-list 172.16.253.38:9092,172.16.253.38:9093,172.16.253.38:9094 --topic my-replicated-topic\n\n3ï¼‰æŒ‡å®šæ¶ˆè´¹ç»„æ¥æ¶ˆè´¹æ¶ˆæ¯./kafka-console-consumer.sh --bootstrap-server 172.16.253.38:9092,172.16.253.38:9093,172.16.253.38:9094 --from-beginning --consumer-property group.id=testGroup1 --topic my-replicated-topic\n\n4ï¼‰åˆ†åŒºåˆ†æ¶ˆè´¹ç»„çš„é›†ç¾¤æ¶ˆè´¹ä¸­çš„ç»†èŠ‚\n\n\nä¸€ä¸ªpartitionåªèƒ½è¢«ä¸€ä¸ªæ¶ˆè´¹ç»„ä¸­çš„ä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹ï¼Œç›®çš„æ˜¯ä¸ºäº†ä¿è¯æ¶ˆè´¹çš„é¡ºåºæ€§ï¼Œä½†æ˜¯å¤šä¸ªpartionçš„å¤šä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹çš„æ€»çš„é¡ºåºæ€§æ˜¯å¾—ä¸åˆ°ä¿è¯çš„ï¼Œé‚£æ€ä¹ˆåšåˆ°æ¶ˆè´¹çš„æ€»é¡ºåºæ€§å‘¢ï¼Ÿ\n\npartitionçš„æ•°é‡å†³å®šäº†æ¶ˆè´¹ç»„ä¸­æ¶ˆè´¹è€…çš„æ•°é‡ï¼Œå»ºè®®åŒä¸€ä¸ªæ¶ˆè´¹ç»„ä¸­æ¶ˆè´¹è€…çš„æ•°é‡ä¸è¦è¶…è¿‡partitionçš„æ•°é‡ï¼Œå¦åˆ™å¤šçš„æ¶ˆè´¹è€…æ¶ˆè´¹ä¸åˆ°æ¶ˆæ¯\n\nå¦‚æœæ¶ˆè´¹è€…æŒ‚äº†ï¼Œé‚£ä¹ˆä¼šè§¦å‘rebalanceæœºåˆ¶ï¼ˆåé¢ä»‹ç»ï¼‰ï¼Œä¼šè®©å…¶ä»–æ¶ˆè´¹è€…æ¥æ¶ˆè´¹è¯¥åˆ†åŒº\n\n\nå…­ã€kafkaçš„javaå®¢æˆ·ç«¯-ç”Ÿäº§è€…çš„å®ç°1.ç”Ÿäº§è€…çš„åŸºæœ¬å®ç°\nå¼•å…¥ä¾èµ–\n\n&lt;dependency>\n    &lt;groupId>org.apache.kafka&lt;/groupId>\n    &lt;artifactId>kafka-clients&lt;/artifactId>\n    &lt;version>2.4.1&lt;/version>\n&lt;/dependency>\n\n\nå…·ä½“å®ç°\n\npackage com.qf.kafka;\n\nimport org.apache.kafka.clients.producer.*;\nimport org.apache.kafka.common.serialization.StringSerializer;\n\nimport java.util.Properties;\nimport java.util.concurrent.ExecutionException;\n\npublic class MySimpleProducer &#123;\n\n  private final static String TOPIC_NAME = \"my-replicated-topic\";\n\n  public static void main(String[] args) throws ExecutionException, InterruptedException &#123;\n\n    //1.è®¾ç½®å‚æ•°\n    Properties props = new Properties();\n    props.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, \"172.16.253.38:9092,172.16.253.38:9093,172.16.253.38:9094\");\n\n    //æŠŠå‘é€çš„keyä»å­—ç¬¦ä¸²åºåˆ—åŒ–ä¸ºå­—èŠ‚æ•°ç»„\n    props.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer.class.getName());\n    //æŠŠå‘é€æ¶ˆæ¯valueä»å­—ç¬¦ä¸²åºåˆ—åŒ–ä¸ºå­—èŠ‚æ•°ç»„\n    props.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, StringSerializer.class.getName());\n\n    //2.åˆ›å»ºç”Ÿäº§æ¶ˆæ¯çš„å®¢æˆ·ç«¯ï¼Œä¼ å…¥å‚æ•°\n    Producer&lt;String,String> producer = new KafkaProducer&lt;String, String>(props);\n\n    //3.åˆ›å»ºæ¶ˆæ¯\n    //keyï¼šä½œç”¨æ˜¯å†³å®šäº†å¾€å“ªä¸ªåˆ†åŒºä¸Šå‘ï¼Œvalueï¼šå…·ä½“è¦å‘é€çš„æ¶ˆæ¯å†…å®¹\n    ProducerRecord&lt;String,String> producerRecord = new ProducerRecord&lt;>(TOPIC_NAME,\"mykeyvalue\",\"hellokafka\");\n\n    //4.å‘é€æ¶ˆæ¯,å¾—åˆ°æ¶ˆæ¯å‘é€çš„å…ƒæ•°æ®å¹¶è¾“å‡º\n    RecordMetadata metadata = producer.send(producerRecord).get();\n    System.out.println(\"åŒæ­¥æ–¹å¼å‘é€æ¶ˆæ¯ç»“æœï¼š\" + \"topic-\" + metadata.topic() + \"|partition-\"\n      + metadata.partition() + \"|offset-\" + metadata.offset());\n  &#125;\n&#125;\n\n\n\n\n2.ç”Ÿäº§è€…çš„åŒæ­¥å‘é€æ¶ˆæ¯\n\nå¦‚æœç”Ÿäº§è€…å‘é€æ¶ˆæ¯æ²¡æœ‰æ”¶åˆ°ackï¼Œç”Ÿäº§è€…ä¼šé˜»å¡ï¼Œé˜»å¡åˆ°3sçš„æ—¶é—´ï¼Œå¦‚æœè¿˜æ²¡æœ‰æ”¶åˆ°æ¶ˆæ¯ï¼Œä¼šè¿›è¡Œé‡è¯•ã€‚é‡è¯•çš„æ¬¡æ•°3æ¬¡ã€‚\nRecordMetadata metadata = producer.send(producerRecord).get();\nSystem.out.println(\"åŒæ­¥æ–¹å¼å‘é€æ¶ˆæ¯ç»“æœï¼š\" + \"topic-\" + metadata.topic() + \"|partition-\"\n  + metadata.partition() + \"|offset-\" + metadata.offset());\n\n\n\n3.ç”Ÿäº§è€…çš„å¼‚æ­¥å‘é€æ¶ˆæ¯\n\nå¼‚æ­¥å‘é€ï¼Œç”Ÿäº§è€…å‘é€å®Œæ¶ˆæ¯åå°±å¯ä»¥æ‰§è¡Œä¹‹åçš„ä¸šåŠ¡ï¼Œbrokeråœ¨æ”¶åˆ°æ¶ˆæ¯åå¼‚æ­¥è°ƒç”¨ç”Ÿäº§è€…æä¾›çš„callbackå›è°ƒæ–¹æ³•ã€‚\n//5.å¼‚æ­¥å‘é€æ¶ˆæ¯\n    producer.send(producerRecord, new Callback() &#123;\n      public void onCompletion(RecordMetadata metadata, Exception exception) &#123;\n        if (exception != null) &#123;\n          System.err.println(\"å‘é€æ¶ˆæ¯å¤±è´¥ï¼š\" + exception.getStackTrace());\n\n        &#125;\n        if (metadata != null) &#123;\n          System.out.println(\"å¼‚æ­¥æ–¹å¼å‘é€æ¶ˆæ¯ç»“æœï¼š\" + \"topic-\" + metadata.topic() + \"|partition-\"\n            + metadata.partition() + \"|offset-\" + metadata.offset());\n        &#125;\n      &#125;\n    &#125;);\n\n\n\n4.ç”Ÿäº§è€…ä¸­çš„ackçš„é…ç½®åœ¨åŒæ­¥å‘é€çš„å‰æä¸‹ï¼Œç”Ÿäº§è€…åœ¨è·å¾—é›†ç¾¤è¿”å›çš„ackä¹‹å‰ä¼šä¸€ç›´é˜»å¡ã€‚é‚£ä¹ˆé›†ç¾¤ä»€ä¹ˆæ—¶å€™è¿”å›ackå‘¢ï¼Ÿæ­¤æ—¶ackæœ‰3ä¸ªé…ç½®ï¼š\n\nack &#x3D; 0   kafka-clusterä¸éœ€è¦ä»»ä½•çš„brokeræ”¶åˆ°æ¶ˆæ¯ï¼Œå°±ç«‹å³è¿”å›ackç»™ç”Ÿäº§è€…ï¼Œæœ€å®¹æ˜“ä¸¢æ¶ˆæ¯çš„ï¼Œæ•ˆç‡æ˜¯æœ€é«˜çš„\n\nack&#x3D;1ï¼ˆé»˜è®¤ï¼‰ï¼š å¤šå‰¯æœ¬ä¹‹é—´çš„leaderå·²ç»æ”¶åˆ°æ¶ˆæ¯ï¼Œå¹¶æŠŠæ¶ˆæ¯å†™å…¥åˆ°æœ¬åœ°çš„logä¸­ï¼Œæ‰ä¼šè¿”å›ackç»™ç”Ÿäº§è€…ï¼Œæ€§èƒ½å’Œå®‰å…¨æ€§æ˜¯æœ€å‡è¡¡çš„\n\nack&#x3D;-1&#x2F;allã€‚é‡Œé¢æœ‰é»˜è®¤çš„é…ç½®min.insync.replicas&#x3D;2(é»˜è®¤ä¸º1ï¼Œæ¨èé…ç½®å¤§äºç­‰äº2)ï¼Œæ­¤æ—¶å°±éœ€è¦leaderå’Œä¸€ä¸ªfolloweråŒæ­¥å®Œåï¼Œæ‰ä¼šè¿”å›ackç»™ç”Ÿäº§è€…ï¼ˆæ­¤æ—¶é›†ç¾¤ä¸­æœ‰2ä¸ªbrokerå·²å®Œæˆæ•°æ®çš„æ¥æ”¶ï¼‰ï¼Œè¿™ç§æ–¹å¼æœ€å®‰å…¨ï¼Œä½†æ€§èƒ½æœ€å·®ã€‚\n\n\n\n\nä¸‹é¢æ˜¯å…³äºackå’Œé‡è¯•ï¼ˆå¦‚æœæ²¡æœ‰æ”¶åˆ°ackï¼Œå°±å¼€å¯é‡è¯•ï¼‰çš„é…ç½®\nprops.put(ProducerConfig.ACKS_CONFIG, \"1\");\n   \t/*\n      å‘é€å¤±è´¥ä¼šé‡è¯•ï¼Œé»˜è®¤é‡è¯•é—´éš”100msï¼Œé‡è¯•èƒ½ä¿è¯æ¶ˆæ¯å‘é€çš„å¯é æ€§ï¼Œä½†æ˜¯ä¹Ÿå¯èƒ½é€ æˆæ¶ˆæ¯é‡å¤å‘é€ï¼Œæ¯”å¦‚ç½‘ç»œæŠ–åŠ¨ï¼Œæ‰€ä»¥éœ€è¦åœ¨\n      æ¥æ”¶è€…é‚£è¾¹åšå¥½æ¶ˆæ¯æ¥æ”¶çš„å¹‚ç­‰æ€§å¤„ç†\n      */\n      props.put(ProducerConfig.RETRIES_CONFIG, 3);\n      //é‡è¯•é—´éš”è®¾ç½®\n      props.put(ProducerConfig.RETRY_BACKOFF_MS_CONFIG, 300);\n\n\n\n5.å…³äºæ¶ˆæ¯å‘é€çš„ç¼“å†²åŒº\n\n\nkafkaé»˜è®¤ä¼šåˆ›å»ºä¸€ä¸ªæ¶ˆæ¯ç¼“å†²åŒºï¼Œç”¨æ¥å­˜æ”¾è¦å‘é€çš„æ¶ˆæ¯ï¼Œç¼“å†²åŒºæ˜¯32m\n\nprops.put(ProducerConfig.BUFFER_MEMORY_CONFIG, 33554432);\n\n\nkafkaæœ¬åœ°çº¿ç¨‹ä¼šå»ç¼“å†²åŒºä¸­ä¸€æ¬¡æ‹‰16kçš„æ•°æ®ï¼Œå‘é€åˆ°broker\n\nprops.put(ProducerConfig.BATCH_SIZE_CONFIG, 16384);\n\n\nå¦‚æœçº¿ç¨‹æ‹‰ä¸åˆ°16kçš„æ•°æ®ï¼Œé—´éš”10msä¹Ÿä¼šå°†å·²æ‹‰åˆ°çš„æ•°æ®å‘åˆ°broker\n\nprops.put(ProducerConfig.LINGER_MS_CONFIG, 10);\n\nä¸ƒã€Javaå®¢æˆ·ç«¯æ¶ˆè´¹è€…çš„å®ç°ç»†èŠ‚1.æ¶ˆè´¹è€…çš„åŸºæœ¬å®ç°package com.qf.kafka;\n\nimport org.apache.kafka.clients.consumer.ConsumerConfig;\nimport org.apache.kafka.clients.consumer.ConsumerRecord;\nimport org.apache.kafka.clients.consumer.ConsumerRecords;\nimport org.apache.kafka.clients.consumer.KafkaConsumer;\nimport org.apache.kafka.common.serialization.StringDeserializer;\n\nimport java.time.Duration;\nimport java.util.Arrays;\nimport java.util.Properties;\n\npublic class MySimpleConsumer &#123;\n\n\n  private final static String TOPIC_NAME = \"my-replicated-topic\";\n  private final static String CONSUMER_GROUP_NAME = \"testGroup\";\n\n  public static void main(String[] args) &#123;\n    Properties props = new Properties();\n    props.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, \"172.16.253.38:9092,172.16.253.38:9093,172.16.253.38:9094\");\n    // æ¶ˆè´¹åˆ†ç»„å\n    props.put(ConsumerConfig.GROUP_ID_CONFIG, CONSUMER_GROUP_NAME);\n    props.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class.getName());\n    props.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class.getName());\n    //1.åˆ›å»ºä¸€ä¸ªæ¶ˆè´¹è€…çš„å®¢æˆ·ç«¯\n    KafkaConsumer&lt;String, String> consumer = new KafkaConsumer&lt;String, String>(props);\n    //2. æ¶ˆè´¹è€…è®¢é˜…ä¸»é¢˜åˆ—è¡¨\n    consumer.subscribe(Arrays.asList(TOPIC_NAME));\n\n    while (true) &#123;\n      /*\n       * 3.poll() API æ˜¯æ‹‰å–æ¶ˆæ¯çš„é•¿è½®è¯¢\n       */\n      ConsumerRecords&lt;String, String> records = consumer.poll(Duration.ofMillis(1000));\n      for (ConsumerRecord&lt;String, String> record : records) &#123;\n        //4.æ‰“å°æ¶ˆæ¯\n        System.out.printf(\"æ”¶åˆ°æ¶ˆæ¯ï¼špartition = %d,offset = %d, key = %s, value = %s%n\", record.partition(),\n          record.offset(), record.key(), record.value());\n      &#125;\n    &#125;\n  &#125;\n\n&#125;\n\n\n2.å…³äºæ¶ˆè´¹è€…è‡ªåŠ¨æäº¤å’Œæ‰‹åŠ¨æäº¤offset1ï¼‰æäº¤çš„å†…å®¹æ¶ˆè´¹è€…æ— è®ºæ˜¯è‡ªåŠ¨æäº¤è¿˜æ˜¯æ‰‹åŠ¨æäº¤ï¼Œéƒ½éœ€è¦æŠŠæ‰€å±çš„æ¶ˆè´¹ç»„+æ¶ˆè´¹çš„æŸä¸ªä¸»é¢˜+æ¶ˆè´¹çš„æŸä¸ªåˆ†åŒºåŠæ¶ˆè´¹çš„åç§»é‡ï¼Œè¿™æ ·çš„ä¿¡æ¯æäº¤åˆ°é›†ç¾¤çš„_consumer_offsetsä¸»é¢˜é‡Œé¢ã€‚\n2ï¼‰è‡ªåŠ¨æäº¤æ¶ˆè´¹è€…pollæ¶ˆæ¯ä¸‹æ¥ä»¥åå°±ä¼šè‡ªåŠ¨æäº¤offset\n// æ˜¯å¦è‡ªåŠ¨æäº¤offsetï¼Œé»˜è®¤å°±æ˜¯true\nprops.put(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG, \"true\");\n// è‡ªåŠ¨æäº¤offsetçš„é—´éš”æ—¶é—´\nprops.put(ConsumerConfig.AUTO_COMMIT_INTERVAL_MS_CONFIG, \"1000\");\n\næ³¨æ„ï¼šè‡ªåŠ¨æäº¤ä¼šä¸¢æ¶ˆæ¯ã€‚å› ä¸ºæ¶ˆè´¹è€…åœ¨æ¶ˆè´¹å‰æäº¤offsetï¼Œæœ‰å¯èƒ½æäº¤å®Œåè¿˜æ²¡æ¶ˆè´¹æ—¶æ¶ˆè´¹è€…æŒ‚äº†ã€‚\n3ï¼‰æ‰‹åŠ¨æäº¤éœ€è¦æŠŠè‡ªåŠ¨æäº¤çš„é…ç½®æ”¹æˆfalse\nprops.put(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG, \"false\");\n\næ‰‹åŠ¨æäº¤åˆåˆ†æˆäº†ä¸¤ç§ï¼š\n\næ‰‹åŠ¨åŒæ­¥æäº¤\nåœ¨æ¶ˆè´¹å®Œæ¶ˆæ¯åè°ƒç”¨åŒæ­¥æäº¤çš„æ–¹æ³•ï¼Œå½“é›†ç¾¤è¿”å›ackå‰ä¸€ç›´é˜»å¡ï¼Œè¿”å›ackåè¡¨ç¤ºæäº¤æˆåŠŸï¼Œæ‰§è¡Œä¹‹åçš„é€»è¾‘\nwhile (true) &#123;\n     /*\n      * poll() API æ˜¯æ‹‰å–æ¶ˆæ¯çš„é•¿è½®è¯¢\n      */\n     ConsumerRecords&lt;String, String> records = consumer.poll(Duration.ofMillis(1000));\n     for (ConsumerRecord&lt;String, String> record : records) &#123;\n       System.out.printf(\"æ”¶åˆ°æ¶ˆæ¯ï¼špartition = %d,offset = %d, key = %s, value = %s%n\", record.partition(),\n         record.offset(), record.key(), record.value());\n     &#125;\n     //æ‰€æœ‰çš„æ¶ˆæ¯å·²æ¶ˆè´¹å®Œ\n     if (records.count() > 0) &#123;//æœ‰æ¶ˆæ¯\n       // æ‰‹åŠ¨åŒæ­¥æäº¤offsetï¼Œå½“å‰çº¿ç¨‹ä¼šé˜»å¡ç›´åˆ°offsetæäº¤æˆåŠŸ\n       // ä¸€èˆ¬ä½¿ç”¨åŒæ­¥æäº¤ï¼Œå› ä¸ºæäº¤ä¹‹åä¸€èˆ¬ä¹Ÿæ²¡æœ‰ä»€ä¹ˆé€»è¾‘ä»£ç äº†\n       consumer.commitSync();//=======é˜»å¡=== æäº¤æˆåŠŸ\n     &#125;\n   &#125;\n &#125;\n\n\n\næ‰‹åŠ¨å¼‚æ­¥æäº¤\nåœ¨æ¶ˆæ¯æ¶ˆè´¹å®Œåæäº¤ï¼Œä¸éœ€è¦ç­‰åˆ°é›†ç¾¤ackï¼Œç›´æ¥æ‰§è¡Œä¹‹åçš„é€»è¾‘ï¼Œå¯ä»¥è®¾ç½®ä¸€ä¸ªå›è°ƒæ–¹æ³•ï¼Œä¾›é›†ç¾¤è°ƒç”¨\nwhile (true) &#123;\n     /*\n      * poll() API æ˜¯æ‹‰å–æ¶ˆæ¯çš„é•¿è½®è¯¢\n      */\n     ConsumerRecords&lt;String, String> records = consumer.poll(Duration.ofMillis(1000));\n     for (ConsumerRecord&lt;String, String> record : records) &#123;\n       System.out.printf(\"æ”¶åˆ°æ¶ˆæ¯ï¼špartition = %d,offset = %d, key = %s, value = %s%n\", record.partition(),\n         record.offset(), record.key(), record.value());\n     &#125;\n     //æ‰€æœ‰çš„æ¶ˆæ¯å·²æ¶ˆè´¹å®Œ\n     if (records.count() > 0) &#123;\n  \n       // æ‰‹åŠ¨å¼‚æ­¥æäº¤offsetï¼Œå½“å‰çº¿ç¨‹æäº¤offsetä¸ä¼šé˜»å¡ï¼Œå¯ä»¥ç»§ç»­å¤„ç†åé¢çš„ç¨‹åºé€»è¾‘\n       consumer.commitAsync(new OffsetCommitCallback() &#123;\n         @Override\n         public void onComplete(Map&lt;TopicPartition, OffsetAndMetadata> offsets, Exception exception) &#123;\n           if (exception != null) &#123;\n             System.err.println(\"Commit failed for \" + offsets);\n             System.err.println(\"Commit failed exception: \" + exception.getStackTrace());\n           &#125;\n         &#125;\n       &#125;);\n  \n     &#125;\n   &#125;\n &#125;\n\n3.é•¿è½®è¯¢pollæ¶ˆæ¯\né»˜è®¤æƒ…å†µä¸‹ï¼Œæ¶ˆè´¹è€…ä¸€æ¬¡ä¼špoll500æ¡æ¶ˆæ¯ã€‚\n\n//ä¸€æ¬¡pollæœ€å¤§æ‹‰å–æ¶ˆæ¯çš„æ¡æ•°ï¼Œå¯ä»¥æ ¹æ®æ¶ˆè´¹é€Ÿåº¦çš„å¿«æ…¢æ¥è®¾ç½®\nprops.put(ConsumerConfig.MAX_POLL_RECORDS_CONFIG, 500);\n\n\nä»£ç ä¸­è®¾ç½®äº†é•¿è½®è¯¢çš„æ—¶é—´æ˜¯1000æ¯«ç§’\n\nwhile (true) &#123;\n     /*\n      * poll() API æ˜¯æ‹‰å–æ¶ˆæ¯çš„é•¿è½®è¯¢\n      */\n     ConsumerRecords&lt;String, String> records = consumer.poll(Duration.ofMillis(1000));\n     for (ConsumerRecord&lt;String, String> record : records) &#123;\n       System.out.printf(\"æ”¶åˆ°æ¶ˆæ¯ï¼špartition = %d,offset = %d, key = %s, value = %s%n\", record.partition(),\n         record.offset(), record.key(), record.value());\n     &#125;\n\næ„å‘³ç€ï¼š\n\n\nå¦‚æœä¸€æ¬¡pollåˆ°500æ¡ï¼Œå°±ç›´æ¥æ‰§è¡Œforå¾ªç¯\nå¦‚æœè¿™ä¸€æ¬¡æ²¡æœ‰pollåˆ°500æ¡ã€‚ä¸”æ—¶é—´åœ¨1ç§’å†…ï¼Œé‚£ä¹ˆé•¿è½®è¯¢ç»§ç»­pollï¼Œè¦ä¹ˆåˆ°500æ¡ï¼Œè¦ä¹ˆåˆ°1s\nå¦‚æœå¤šæ¬¡polléƒ½æ²¡è¾¾åˆ°500æ¡ï¼Œä¸”1ç§’æ—¶é—´åˆ°äº†ï¼Œé‚£ä¹ˆç›´æ¥æ‰§è¡Œforå¾ªç¯\n\n\nå¦‚æœä¸¤æ¬¡pollçš„é—´éš”è¶…è¿‡30sï¼Œé›†ç¾¤ä¼šè®¤ä¸ºè¯¥æ¶ˆè´¹è€…çš„æ¶ˆè´¹èƒ½åŠ›è¿‡å¼±ï¼Œè¯¥æ¶ˆè´¹è€…è¢«è¸¢å‡ºæ¶ˆè´¹ç»„ï¼Œè§¦å‘rebalanceæœºåˆ¶ï¼Œrebalanceæœºåˆ¶ä¼šé€ æˆæ€§èƒ½å¼€é”€ã€‚å¯ä»¥é€šè¿‡è®¾ç½®è¿™ä¸ªå‚æ•°ï¼Œè®©ä¸€æ¬¡pollçš„æ¶ˆæ¯æ¡æ•°å°‘ä¸€ç‚¹\n\n//ä¸€æ¬¡pollæœ€å¤§æ‹‰å–æ¶ˆæ¯çš„æ¡æ•°ï¼Œå¯ä»¥æ ¹æ®æ¶ˆè´¹é€Ÿåº¦çš„å¿«æ…¢æ¥è®¾ç½®\n  props.put(ConsumerConfig.MAX_POLL_RECORDS_CONFIG, 500);\n  //å¦‚æœä¸¤æ¬¡pollçš„æ—¶é—´å¦‚æœè¶…å‡ºäº†30sçš„æ—¶é—´é—´éš”ï¼Œkafkaä¼šè®¤ä¸ºå…¶æ¶ˆè´¹èƒ½åŠ›è¿‡å¼±ï¼Œå°†å…¶è¸¢å‡ºæ¶ˆè´¹ç»„ã€‚å°†åˆ†åŒºåˆ†é…ç»™å…¶ä»–æ¶ˆè´¹è€…ã€‚-rebalance\n  props.put(ConsumerConfig.MAX_POLL_INTERVAL_MS_CONFIG, 30 * 1000);\n\n\n\n4.æ¶ˆè´¹è€…çš„å¥åº·çŠ¶æ€æ£€æŸ¥æ¶ˆè´¹è€…æ¯éš”1så‘kafkaé›†ç¾¤å‘é€å¿ƒè·³ï¼Œé›†ç¾¤å‘ç°å¦‚æœæœ‰è¶…è¿‡10sæ²¡æœ‰ç»­çº¦çš„æ¶ˆè´¹è€…ï¼Œå°†è¢«è¸¢å‡ºæ¶ˆè´¹ç»„ï¼Œè§¦å‘è¯¥æ¶ˆè´¹ç»„çš„rebalanceæœºåˆ¶ï¼Œå°†è¯¥åˆ†åŒºäº¤ç»™æ¶ˆè´¹ç»„é‡Œçš„å…¶ä»–æ¶ˆè´¹è€…è¿›è¡Œæ¶ˆè´¹ã€‚\n//consumerç»™brokerå‘é€å¿ƒè·³çš„é—´éš”æ—¶é—´\n    props.put(ConsumerConfig.HEARTBEAT_INTERVAL_MS_CONFIG, 1000);\n    //kafkaå¦‚æœè¶…è¿‡10ç§’æ²¡æœ‰æ”¶åˆ°æ¶ˆè´¹è€…çš„å¿ƒè·³ï¼Œåˆ™ä¼šæŠŠæ¶ˆè´¹è€…è¸¢å‡ºæ¶ˆè´¹ç»„ï¼Œè¿›è¡Œrebalanceï¼ŒæŠŠåˆ†åŒºåˆ†é…ç»™å…¶ä»–æ¶ˆè´¹è€…ã€‚\n    props.put(ConsumerConfig.SESSION_TIMEOUT_MS_CONFIG, 10 * 1000);\n\n\n\n5.æŒ‡å®šåˆ†åŒºå’Œåç§»é‡ã€æ—¶é—´æ¶ˆè´¹\næŒ‡å®šåˆ†åŒºæ¶ˆè´¹\n\nconsumer.assign(Arrays.asList(new TopicPartition(TOPIC_NAME, 0)));\n\n\nä»å¤´æ¶ˆè´¹\n\nconsumer.assign(Arrays.asList(new TopicPartition(TOPIC_NAME, 0)));\nconsumer.seekToBeginning(Arrays.asList(new TopicPartition(TOPIC_NAME, 0)));\n\n\næŒ‡å®šoffsetæ¶ˆè´¹\n\nconsumer.assign(Arrays.asList(new TopicPartition(TOPIC_NAME, 0)));\nconsumer.seek(new TopicPartition(TOPIC_NAME, 0), 10);\n\n\næŒ‡å®šæ—¶é—´æ¶ˆè´¹\n\næ ¹æ®æ—¶é—´ï¼Œå»æ‰€æœ‰çš„partitionä¸­ç¡®å®šè¯¥æ—¶é—´å¯¹åº”çš„offsetï¼Œç„¶åå»æ‰€æœ‰çš„partitionä¸­æ‰¾åˆ°è¯¥offsetä¹‹åçš„æ¶ˆæ¯å¼€å§‹æ¶ˆè´¹ã€‚\nList&lt;PartitionInfo> topicPartitions = consumer.partitionsFor(TOPIC_NAME);\n        //ä»1å°æ—¶å‰å¼€å§‹æ¶ˆè´¹\n        long fetchDataTime = new Date().getTime() - 1000 * 60 * 60;\n        Map&lt;TopicPartition, Long> map = new HashMap&lt;>();\n        for (PartitionInfo par : topicPartitions) &#123;\n            map.put(new TopicPartition(TOPIC_NAME, par.partition()), fetchDataTime);\n        &#125;\n        Map&lt;TopicPartition, OffsetAndTimestamp> parMap = consumer.offsetsForTimes(map);\n        for (Map.Entry&lt;TopicPartition, OffsetAndTimestamp> entry : parMap.entrySet()) &#123;\n            TopicPartition key = entry.getKey();\n            OffsetAndTimestamp value = entry.getValue();\n            if (key == null || value == null) continue;\n            Long offset = value.offset();\n            System.out.println(\"partition-\" + key.partition() + \"|offset-\" + offset);\n            System.out.println();\n            //æ ¹æ®æ¶ˆè´¹é‡Œçš„timestampç¡®å®šoffset\n            if (value != null) &#123;\n                consumer.assign(Arrays.asList(key));\n                consumer.seek(key, offset);\n            &#125;\n        &#125;\n\n\n6.æ–°æ¶ˆè´¹ç»„çš„æ¶ˆè´¹offsetè§„åˆ™æ–°æ¶ˆè´¹ç»„ä¸­çš„æ¶ˆè´¹è€…åœ¨å¯åŠ¨ä»¥åï¼Œé»˜è®¤ä¼šä»å½“å‰åˆ†åŒºçš„æœ€åä¸€æ¡æ¶ˆæ¯çš„offset+1å¼€å§‹æ¶ˆè´¹ï¼ˆæ¶ˆè´¹æ–°æ¶ˆæ¯ï¼‰ã€‚å¯ä»¥é€šè¿‡ä»¥ä¸‹çš„è®¾ç½®ï¼Œè®©æ–°çš„æ¶ˆè´¹è€…ç¬¬ä¸€æ¬¡ä»å¤´å¼€å§‹æ¶ˆè´¹ã€‚ä¹‹åå¼€å§‹æ¶ˆè´¹æ–°æ¶ˆæ¯ï¼ˆæœ€åæ¶ˆè´¹çš„ä½ç½®çš„åç§»é‡+1ï¼‰\n\nLatest:é»˜è®¤çš„ï¼Œæ¶ˆè´¹æ–°æ¶ˆæ¯\nearliestï¼šç¬¬ä¸€æ¬¡ä»å¤´å¼€å§‹æ¶ˆè´¹ã€‚ä¹‹åå¼€å§‹æ¶ˆè´¹æ–°æ¶ˆæ¯ï¼ˆæœ€åæ¶ˆè´¹çš„ä½ç½®çš„åç§»é‡+1ï¼‰\n\nprops.put(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG, \"earliest\");\n\n\n\nå…«ã€Springbootä¸­ä½¿ç”¨Kafka1.å¼•å…¥ä¾èµ–&lt;dependency>\n    &lt;groupId>org.springframework.kafka&lt;/groupId>\n    &lt;artifactId>spring-kafka&lt;/artifactId>\n&lt;/dependency>\n\n2.ç¼–å†™é…ç½®æ–‡ä»¶server:\n  port: 9999\n\nspring:\n  kafka:\n    bootstrap-servers: 192.168.111.129:9092  #,172.16.253.38:9093,172.16.253.38:9094  é›†ç¾¤\n    producer: #ç”Ÿäº§è€…é…ç½®\n      retries: 3 # è®¾ç½®å¤§äº0çš„å€¼ï¼Œæ²¡æœ‰æ”¶åˆ°ackä¼šé‡å¤å‘é€ä¸‰æ¬¡\n      batch-size: 16384  #16kb æ¯æ¬¡æ‹‰å–16kb(ç¼“å†²åŒºä¸­æ•°æ®å¤§äº16kb)\n      buffer-memory: 33554432 #32mb æ¶ˆæ¯ç¼“å†²åŒº\n      acks: 1 #ä¸€ä¸ªleaderæ‹¿åˆ°æ¶ˆæ¯æ‰è¿”å›ack  ï¼ˆ0ï¼Œ1ï¼Œ-1ä¸‰ç§ï¼‰\n      # æŒ‡å®šæ¶ˆæ¯keyå’Œæ¶ˆæ¯ä½“çš„ç¼–è§£ç æ–¹å¼\n      key-serializer: org.apache.kafka.common.serialization.StringSerializer\n      value-serializer: org.apache.kafka.common.serialization.StringSerializer\n    consumer: #æ¶ˆè´¹è€…é…ç½®\n      group-id: default-group #æ¶ˆè´¹ç»„\n      enable-auto-commit: false  #æ‰‹åŠ¨æäº¤\n      auto-offset-reset: earliest #ä¸€ä¸ªæ–°æ¶ˆè´¹ç»„é»˜è®¤ä»å¤´å¼€å§‹æ¶ˆè´¹\n      # æŒ‡å®šæ¶ˆæ¯keyå’Œæ¶ˆæ¯ä½“çš„ç¼–è§£ç æ–¹å¼\n      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer\n      value-deserializer: org.apache.kafka.common.serialization.StringDeserializer\n      max-poll-records: 500 #ä¸€æ¬¡æœ€å¤šæ‹‰å»500æ¡æ¶ˆæ¯\n    listener:\n      # å½“æ¯ä¸€æ¡è®°å½•è¢«æ¶ˆè´¹è€…ç›‘å¬å™¨ï¼ˆListenerConsumerï¼‰å¤„ç†ä¹‹åæäº¤\n      # RECORD\n      # å½“æ¯ä¸€æ‰¹poll()çš„æ•°æ®è¢«æ¶ˆè´¹è€…ç›‘å¬å™¨ï¼ˆListenerConsumerï¼‰å¤„ç†ä¹‹åæäº¤\n      # BATCH\n      # å½“æ¯ä¸€æ‰¹poll()çš„æ•°æ®è¢«æ¶ˆè´¹è€…ç›‘å¬å™¨ï¼ˆListenerConsumerï¼‰å¤„ç†ä¹‹åï¼Œè·ç¦»ä¸Šæ¬¡æäº¤æ—¶é—´å¤§äºTIMEæ—¶æäº¤\n      # TIME\n      # å½“æ¯ä¸€æ‰¹poll()çš„æ•°æ®è¢«æ¶ˆè´¹è€…ç›‘å¬å™¨ï¼ˆListenerConsumerï¼‰å¤„ç†ä¹‹åï¼Œè¢«å¤„ç†recordæ•°é‡å¤§äºç­‰äºCOUNTæ—¶æäº¤\n      # COUNT\n      # TIME |ã€€COUNTã€€æœ‰ä¸€ä¸ªæ¡ä»¶æ»¡è¶³æ—¶æäº¤\n      # COUNT_TIME\n      # å½“æ¯ä¸€æ‰¹poll()çš„æ•°æ®è¢«æ¶ˆè´¹è€…ç›‘å¬å™¨ï¼ˆListenerConsumerï¼‰å¤„ç†ä¹‹å, æ‰‹åŠ¨è°ƒç”¨Acknowledgment.acknowledge()åæäº¤\n      # MANUAL\n      # æ‰‹åŠ¨è°ƒç”¨Acknowledgment.acknowledge()åç«‹å³æäº¤ï¼Œä¸€èˆ¬ä½¿ç”¨è¿™ç§\n      # MANUAL_IMMEDIATE\n      ack-mode: MANUAL_IMMEDIATE\n#  redis:\n#    host: 172.16.253.21\n\n\n\n3.ç¼–å†™æ¶ˆæ¯ç”Ÿäº§è€…package com.qf.kafka.spring.boot.demo.controller;\n\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.kafka.core.KafkaTemplate;\nimport org.springframework.web.bind.annotation.RequestMapping;\nimport org.springframework.web.bind.annotation.RestController;\n\n@RestController\n@RequestMapping(\"/msg\")\npublic class MyKafkaController &#123;\n\n  private final static String TOPIC_NAME = \"my-replicated-topic\";\n\n  @Autowired\n  private KafkaTemplate&lt;String,String> kafkaTemplate;\n\n  @RequestMapping(\"/send\")\n  public String sendMessage()&#123;\n\n    kafkaTemplate.send(TOPIC_NAME,0,\"key\",\"this is a message!\");\n\n    return \"send success!\";\n\n  &#125;\n\n\n\n\n&#125;\n\n\n\n\n4.ç¼–å†™æ¶ˆè´¹è€…package com.qf.kafka.spring.boot.demo.consumer;\n\nimport org.apache.kafka.clients.consumer.ConsumerRecord;\nimport org.apache.kafka.clients.consumer.ConsumerRecords;\nimport org.springframework.kafka.annotation.KafkaListener;\nimport org.springframework.kafka.support.Acknowledgment;\nimport org.springframework.stereotype.Component;\n\n@Component\npublic class MyConsumer &#123;\n\n\t@KafkaListener(topics = \"my-replicated-topic\", groupId = \"MyGroup1\")\n    public void listenGroup(ConsumerRecord&lt;String, String> record, Acknowledgment ack) &#123;\n        String value = record.value();\n        System.out.println(value);\n        System.out.println(record);\n        //æ‰‹åŠ¨æäº¤offset\n        ack.acknowledge();\n    &#125;\n\n&#125;\n\n\n5.æ¶ˆè´¹è€…ä¸­é…ç½®æ¶ˆè´¹ä¸»é¢˜ã€åˆ†åŒºå’Œåç§»é‡@KafkaListener(groupId = \"testGroup\", topicPartitions = &#123;\n        //ä¸»é¢˜ï¼Œåˆ†åŒº\n        //å¯ä»¥æ¶ˆè´¹å¤šä¸ªä¸»é¢˜ï¼Œåˆ†åŒº\n        @TopicPartition(topic = \"topic1\", partitions = &#123;\"0\", \"1\"&#125;),\n        //å¯ä»¥è®¾ç½®åç§»é‡,0å·åˆ†åŒºæ­£å¸¸æ¶ˆè´¹ï¼Œ1å·åˆ†åŒºä»åç§»é‡100å¼€å§‹æ¶ˆè´¹\n        @TopicPartition(topic = \"topic2\", partitions = \"0\", partitionOffsets = @PartitionOffset(partition = \"1\", initialOffset = \"100\"))\n    &#125;, concurrency = \"3\") //concurrencyå°±æ˜¯åŒæ¶ˆè´¹ç»„ä¸‹çš„æ¶ˆè´¹è€…ä¸ªæ•°ï¼Œå°±æ˜¯å¹¶å‘æ¶ˆè´¹æ•°ï¼Œå»ºè®®å°äºç­‰äºåˆ†åŒºæ€»æ•°\npublic void listenGroupPro(ConsumerRecord&lt;String, String> record, Acknowledgment ack) &#123;\n    String value = record.value();\n    System.out.println(value);\n    System.out.println(record);\n    //æ‰‹åŠ¨æäº¤offset\n    ack.acknowledge();\n&#125;\n\n\n\n\nä¹ã€kafkaé›†ç¾¤ä¸­çš„controllerã€rebalanceã€HW1.controller\né›†ç¾¤ä¸­è°æ¥å……å½“controller\n\næ¯ä¸ªbrokerå¯åŠ¨æ—¶ä¼šå‘zkåˆ›å»ºä¸€ä¸ªä¸´æ—¶åºå·èŠ‚ç‚¹ï¼Œè·å¾—çš„åºå·æœ€å°çš„é‚£ä¸ªbrokerå°†ä¼šä½œä¸ºé›†ç¾¤ä¸­çš„controllerï¼Œè´Ÿè´£è¿™ä¹ˆå‡ ä»¶äº‹ï¼š\n\nå½“é›†ç¾¤ä¸­æœ‰ä¸€ä¸ªå‰¯æœ¬çš„leaderæŒ‚æ‰ï¼Œéœ€è¦åœ¨é›†ç¾¤ä¸­é€‰ä¸¾å‡ºä¸€ä¸ªæ–°çš„leaderï¼Œé€‰ä¸¾çš„è§„åˆ™æ˜¯ä»isré›†åˆä¸­æœ€å·¦è¾¹è·å¾—ã€‚\nå½“é›†ç¾¤ä¸­æœ‰brokeræ–°å¢æˆ–å‡å°‘ï¼Œcontrollerä¼šåŒæ­¥ä¿¡æ¯ç»™å…¶ä»–broker\nå½“é›†ç¾¤ä¸­æœ‰åˆ†åŒºæ–°å¢æˆ–å‡å°‘ï¼Œcontrollerä¼šåŒæ­¥ä¿¡æ¯ç»™å…¶ä»–broker\n\n2.rebalanceæœºåˆ¶\nå‰æï¼šæ¶ˆè´¹ç»„ä¸­çš„æ¶ˆè´¹è€…æ²¡æœ‰æŒ‡æ˜åˆ†åŒºæ¥æ¶ˆè´¹\n\nè§¦å‘çš„æ¡ä»¶ï¼šå½“æ¶ˆè´¹ç»„ä¸­çš„æ¶ˆè´¹è€…å’Œåˆ†åŒºçš„å…³ç³»å‘ç”Ÿå˜åŒ–çš„æ—¶å€™\n\nåˆ†åŒºåˆ†é…çš„ç­–ç•¥ï¼šåœ¨rebalanceä¹‹å‰ï¼Œåˆ†åŒºæ€ä¹ˆåˆ†é…ä¼šæœ‰è¿™ä¹ˆä¸‰ç§ç­–ç•¥\n\nrangeï¼šæ ¹æ®å…¬ç¤ºè®¡ç®—å¾—åˆ°æ¯ä¸ªæ¶ˆè´¹æ¶ˆè´¹å“ªå‡ ä¸ªåˆ†åŒºï¼šå‰é¢çš„æ¶ˆè´¹è€…æ˜¯åˆ†åŒºæ€»æ•°&#x2F;æ¶ˆè´¹è€…æ•°é‡+1,ä¹‹åçš„æ¶ˆè´¹è€…æ˜¯åˆ†åŒºæ€»æ•°&#x2F;æ¶ˆè´¹è€…æ•°é‡\nè½®è¯¢ï¼šå¤§å®¶è½®ç€æ¥\nstickyï¼šç²˜åˆç­–ç•¥ï¼Œå¦‚æœéœ€è¦rebalanceï¼Œä¼šåœ¨ä¹‹å‰å·²åˆ†é…çš„åŸºç¡€ä¸Šè°ƒæ•´ï¼Œä¸ä¼šæ”¹å˜ä¹‹å‰çš„åˆ†é…æƒ…å†µã€‚å¦‚æœè¿™ä¸ªç­–ç•¥æ²¡æœ‰å¼€ï¼Œé‚£ä¹ˆå°±è¦è¿›è¡Œå…¨éƒ¨çš„é‡æ–°åˆ†é…ã€‚å»ºè®®å¼€å¯ã€‚\n\n\n\n3.HWå’ŒLEOLEOæ˜¯æŸä¸ªå‰¯æœ¬æœ€åæ¶ˆæ¯çš„æ¶ˆæ¯ä½ç½®ï¼ˆlog-end-offsetï¼‰\nHWæ˜¯å·²å®ŒæˆåŒæ­¥çš„ä½ç½®ã€‚æ¶ˆæ¯åœ¨å†™å…¥brokeræ—¶ï¼Œä¸”æ¯ä¸ªbrokerå®Œæˆè¿™æ¡æ¶ˆæ¯çš„åŒæ­¥åï¼Œhwæ‰ä¼šå˜åŒ–ã€‚åœ¨è¿™ä¹‹å‰æ¶ˆè´¹è€…æ˜¯æ¶ˆè´¹ä¸åˆ°è¿™æ¡æ¶ˆæ¯çš„ã€‚åœ¨åŒæ­¥å®Œæˆä¹‹åï¼ŒHWæ›´æ–°ä¹‹åï¼Œæ¶ˆè´¹è€…æ‰èƒ½æ¶ˆè´¹åˆ°è¿™æ¡æ¶ˆæ¯ï¼Œè¿™æ ·çš„ç›®çš„æ˜¯é˜²æ­¢æ¶ˆæ¯çš„ä¸¢å¤±ã€‚\n\nåã€Kafkaä¸­çš„ä¼˜åŒ–é—®é¢˜1.å¦‚ä½•é˜²æ­¢æ¶ˆæ¯ä¸¢å¤±\nç”Ÿäº§è€…ï¼š1ï¼‰ä½¿ç”¨åŒæ­¥å‘é€ 2ï¼‰æŠŠackè®¾æˆ1æˆ–è€…allï¼Œå¹¶ä¸”è®¾ç½®åŒæ­¥çš„åˆ†åŒºæ•°&gt;&#x3D;2\næ¶ˆè´¹è€…ï¼šæŠŠè‡ªåŠ¨æäº¤æ”¹æˆæ‰‹åŠ¨æäº¤\n\n2.å¦‚ä½•é˜²æ­¢é‡å¤æ¶ˆè´¹åœ¨é˜²æ­¢æ¶ˆæ¯ä¸¢å¤±çš„æ–¹æ¡ˆä¸­ï¼Œå¦‚æœç”Ÿäº§è€…å‘é€å®Œæ¶ˆæ¯åï¼Œå› ä¸ºç½‘ç»œæŠ–åŠ¨ï¼Œæ²¡æœ‰æ”¶åˆ°ackï¼Œä½†å®é™…ä¸Šbrokerå·²ç»æ”¶åˆ°äº†ã€‚\næ­¤æ—¶ç”Ÿäº§è€…ä¼šè¿›è¡Œé‡è¯•ï¼Œäºæ˜¯brokerå°±ä¼šæ”¶åˆ°å¤šæ¡ç›¸åŒçš„æ¶ˆæ¯ï¼Œè€Œé€ æˆæ¶ˆè´¹è€…çš„é‡å¤æ¶ˆè´¹ã€‚\næ€ä¹ˆè§£å†³ï¼š\n\nç”Ÿäº§è€…å…³é—­é‡è¯•ï¼šä¼šé€ æˆä¸¢æ¶ˆæ¯ï¼ˆä¸å»ºè®®ï¼‰\n\næ¶ˆè´¹è€…è§£å†³éå¹‚ç­‰æ€§æ¶ˆè´¹é—®é¢˜ï¼š\næ‰€è°“çš„å¹‚ç­‰æ€§ï¼šå¤šæ¬¡è®¿é—®çš„ç»“æœæ˜¯ä¸€æ ·çš„ã€‚å¯¹äºrestçš„è¯·æ±‚ï¼ˆgetï¼ˆå¹‚ç­‰ï¼‰ã€postï¼ˆéå¹‚ç­‰ï¼‰ã€putï¼ˆå¹‚ç­‰ï¼‰ã€deleteï¼ˆå¹‚ç­‰ï¼‰ï¼‰\nè§£å†³æ–¹æ¡ˆï¼š\n\nåœ¨æ•°æ®åº“ä¸­åˆ›å»ºè”åˆä¸»é”®ï¼Œé˜²æ­¢ç›¸åŒçš„ä¸»é”® åˆ›å»ºå‡ºå¤šæ¡è®°å½•\nä½¿ç”¨åˆ†å¸ƒå¼é”ï¼Œä»¥ä¸šåŠ¡idä¸ºé”ã€‚ä¿è¯åªæœ‰ä¸€æ¡è®°å½•èƒ½å¤Ÿåˆ›å»ºæˆåŠŸ\n\n\n\n\n3.å¦‚ä½•åšåˆ°æ¶ˆæ¯çš„é¡ºåºæ¶ˆè´¹\nç”Ÿäº§è€…ï¼šä¿è¯æ¶ˆæ¯æŒ‰é¡ºåºæ¶ˆè´¹ï¼Œä¸”æ¶ˆæ¯ä¸ä¸¢å¤±â€”â€”ä½¿ç”¨åŒæ­¥çš„å‘é€ï¼Œackè®¾ç½®æˆé0çš„å€¼ã€‚\næ¶ˆè´¹è€…ï¼šä¸»é¢˜åªèƒ½è®¾ç½®ä¸€ä¸ªåˆ†åŒºï¼Œæ¶ˆè´¹ç»„ä¸­åªèƒ½æœ‰ä¸€ä¸ªæ¶ˆè´¹è€…\n\nkafkaçš„é¡ºåºæ¶ˆè´¹ä½¿ç”¨åœºæ™¯ä¸å¤šï¼Œå› ä¸ºç‰ºç‰²æ‰äº†æ€§èƒ½ï¼Œä½†æ˜¯æ¯”å¦‚rocketmqåœ¨è¿™ä¸€å—æœ‰ä¸“é—¨çš„åŠŸèƒ½å·²è®¾è®¡å¥½ã€‚\n4.å¦‚ä½•è§£å†³æ¶ˆæ¯ç§¯å‹é—®é¢˜\n1ï¼‰æ¶ˆæ¯ç§¯å‹é—®é¢˜çš„å‡ºç°æ¶ˆæ¯çš„æ¶ˆè´¹è€…çš„æ¶ˆè´¹é€Ÿåº¦è¿œèµ¶ä¸ä¸Šç”Ÿäº§è€…çš„ç”Ÿäº§æ¶ˆæ¯çš„é€Ÿåº¦ï¼Œå¯¼è‡´kafkaä¸­æœ‰å¤§é‡çš„æ•°æ®æ²¡æœ‰è¢«æ¶ˆè´¹ã€‚éšç€æ²¡æœ‰è¢«æ¶ˆè´¹çš„æ•°æ®å †ç§¯è¶Šå¤šï¼Œæ¶ˆè´¹è€…å¯»å€çš„æ€§èƒ½ä¼šè¶Šæ¥è¶Šå·®ï¼Œæœ€åå¯¼è‡´æ•´ä¸ªkafkaå¯¹å¤–æä¾›çš„æœåŠ¡çš„æ€§èƒ½å¾ˆå·®ï¼Œä»è€Œé€ æˆå…¶ä»–æœåŠ¡ä¹Ÿè®¿é—®é€Ÿåº¦å˜æ…¢ï¼Œé€ æˆæœåŠ¡é›ªå´©ã€‚\n2ï¼‰æ¶ˆæ¯ç§¯å‹çš„è§£å†³æ–¹æ¡ˆ\nåœ¨è¿™ä¸ªæ¶ˆè´¹è€…ä¸­ï¼Œä½¿ç”¨å¤šçº¿ç¨‹ï¼Œå……åˆ†åˆ©ç”¨æœºå™¨çš„æ€§èƒ½è¿›è¡Œæ¶ˆè´¹æ¶ˆæ¯ã€‚\né€šè¿‡ä¸šåŠ¡çš„æ¶æ„è®¾è®¡ï¼Œæå‡ä¸šåŠ¡å±‚é¢æ¶ˆè´¹çš„æ€§èƒ½ã€‚\nåˆ›å»ºå¤šä¸ªæ¶ˆè´¹ç»„ï¼Œå¤šä¸ªæ¶ˆè´¹è€…ï¼Œéƒ¨ç½²åˆ°å…¶ä»–æœºå™¨ä¸Šï¼Œä¸€èµ·æ¶ˆè´¹ï¼Œæé«˜æ¶ˆè´¹è€…çš„æ¶ˆè´¹é€Ÿåº¦\nåˆ›å»ºä¸€ä¸ªæ¶ˆè´¹è€…ï¼Œè¯¥æ¶ˆè´¹è€…åœ¨kafkaå¦å»ºä¸€ä¸ªä¸»é¢˜ï¼Œé…ä¸Šå¤šä¸ªåˆ†åŒºï¼Œå¤šä¸ªåˆ†åŒºå†é…ä¸Šå¤šä¸ªæ¶ˆè´¹è€…ã€‚è¯¥æ¶ˆè´¹è€…å°†pollä¸‹æ¥çš„æ¶ˆæ¯ï¼Œä¸è¿›è¡Œæ¶ˆè´¹ï¼Œç›´æ¥è½¬å‘åˆ°æ–°å»ºçš„ä¸»é¢˜ä¸Šã€‚æ­¤æ—¶ï¼Œæ–°çš„ä¸»é¢˜çš„å¤šä¸ªåˆ†åŒºçš„å¤šä¸ªæ¶ˆè´¹è€…å°±å¼€å§‹ä¸€èµ·æ¶ˆè´¹äº†ã€‚â€”â€”ä¸å¸¸ç”¨\n\n\n5.å®ç°å»¶æ—¶é˜Ÿåˆ—çš„æ•ˆæœ1ï¼‰åº”ç”¨åœºæ™¯è®¢å•åˆ›å»ºåï¼Œè¶…è¿‡30åˆ†é’Ÿæ²¡æœ‰æ”¯ä»˜ï¼Œåˆ™éœ€è¦å–æ¶ˆè®¢å•ï¼Œè¿™ç§åœºæ™¯å¯ä»¥é€šè¿‡å»¶æ—¶é˜Ÿåˆ—æ¥å®ç°\n2ï¼‰å…·ä½“æ–¹æ¡ˆ\n\nkafkaä¸­åˆ›å»ºåˆ›å»ºç›¸åº”çš„ä¸»é¢˜\næ¶ˆè´¹è€…æ¶ˆè´¹è¯¥ä¸»é¢˜çš„æ¶ˆæ¯ï¼ˆè½®è¯¢ï¼‰\næ¶ˆè´¹è€…æ¶ˆè´¹æ¶ˆæ¯æ—¶åˆ¤æ–­æ¶ˆæ¯çš„åˆ›å»ºæ—¶é—´å’Œå½“å‰æ—¶é—´æ˜¯å¦è¶…è¿‡30åˆ†é’Ÿï¼ˆå‰ææ˜¯è®¢å•æ²¡æ”¯ä»˜ï¼‰\nå¦‚æœæ˜¯ï¼šå»æ•°æ®åº“ä¸­ä¿®æ”¹è®¢å•çŠ¶æ€ä¸ºå·²å–æ¶ˆ\nå¦‚æœå¦ï¼šè®°å½•å½“å‰æ¶ˆæ¯çš„offsetï¼Œå¹¶ä¸å†ç»§ç»­æ¶ˆè´¹ä¹‹åçš„æ¶ˆæ¯ã€‚ç­‰å¾…1åˆ†é’Ÿåï¼Œå†æ¬¡å‘kafkaæ‹‰å–è¯¥offsetåŠä¹‹åçš„æ¶ˆæ¯ï¼Œç»§ç»­è¿›è¡Œåˆ¤æ–­ï¼Œä»¥æ­¤åå¤ã€‚\n\n\n\n\nåä¸€ã€Kafka-eagleç›‘æ§å¹³å°1.æ­å»º\nå»kafka-eagleå®˜ç½‘ä¸‹è½½å‹ç¼©åŒ…\n\nhttp://download.kafka-eagle.org/\n\nåˆ†é…ä¸€å°è™šæ‹Ÿæœº\nè™šæ‹Ÿæœºä¸­å®‰è£…jdk\nè§£å‹ç¼©kafka-eagleçš„å‹ç¼©åŒ…\nç»™kafka-eagleé…ç½®ç¯å¢ƒå˜é‡\n\nexport KE_HOME=/usr/local/kafka-eagle\nexport PATH=$PATH:$KE_HOME/bin\n\n\néœ€è¦ä¿®æ”¹kafka-eagleå†…éƒ¨çš„é…ç½®æ–‡ä»¶ï¼švim system-config.properties \nä¿®æ”¹é‡Œé¢çš„zkçš„åœ°å€å’Œmysqlçš„åœ°å€\n\nè¿›å…¥åˆ°binä¸­ï¼Œé€šè¿‡å‘½ä»¤æ¥å¯åŠ¨\n\n\n./ke.sh start\n\n2.å¹³å°çš„ä½¿ç”¨\n","slug":"kafka","date":"2022-07-13T08:31:01.630Z","categories_index":"Kafka","tags_index":"Kafka,æ¶ˆæ¯ä¸­é—´ä»¶","author_index":"å°æä¸åœ¨_"},{"id":"090d1240eb81aec2da7fdd1a11b68406","title":"Streamæµ","content":"JDK8 Streamæ¦‚å¿µ\n\n\n\n\n\n\n\n\nStreamæ˜¯Java8 APIçš„æ–°æˆå‘˜ï¼Œå®ƒå…è®¸ä»¥å£°æ˜æ€§æ–¹å¼å¤„ç†æ•°æ®é›†åˆ ã€‚\nç‰¹ç‚¹\n\n\n\n\n\n\n\n\nï¼ˆ1ï¼‰ä»£ç ç®€æ´ï¼šå‡½æ•°å¼ç¼–ç¨‹å†™å‡ºçš„ä»£ç ç®€æ´ä¸”æ„å›¾æ˜ç¡®ï¼Œä½¿ç”¨streamæ¥å£è®©ä½ ä»æ­¤å‘Šåˆ«forå¾ªç¯ã€‚ \nï¼ˆ2ï¼‰å¤šæ ¸å‹å¥½ï¼šJavaå‡½æ•°å¼ç¼–ç¨‹ä½¿å¾—ç¼–å†™å¹¶è¡Œç¨‹åºä»æœªå¦‚æ­¤ç®€å•ï¼Œä½ éœ€è¦çš„å…¨éƒ¨å°±æ˜¯è°ƒç”¨ä¸€ä¸‹æ–¹æ³•ã€‚ \næµç¨‹1ï¼‰ç¬¬ä¸€æ­¥ï¼šæŠŠé›†åˆè½¬æ¢ä¸ºæµstream\n2ï¼‰ç¬¬äºŒæ­¥ï¼šæ“ä½œstreamæµ\nstreamæµåœ¨ç®¡é“ä¸­ç»è¿‡ä¸­é—´æ“ä½œï¼ˆintermediate operationï¼‰çš„å¤„ç†ï¼Œæœ€åç”±æœ€ç»ˆæ“ä½œ(terminal operation)å¾—åˆ°å‰é¢å¤„ç†çš„ç»“æœ\n\næ“ä½œç¬¦\n\n\n\n\n\n\n\n\nä¸¤ç§ï¼šä¸­é—´æ“ä½œç¬¦ã€ç»ˆæ­¢æ“ä½œç¬¦\nä¸­é—´æ“ä½œç¬¦\n\n\næµæ–¹æ³•\nå«ä¹‰\nç¤ºä¾‹\n\n\n\nfilter\nç”¨äºé€šè¿‡è®¾ç½®çš„æ¡ä»¶è¿‡æ»¤å‡ºå…ƒç´ \nList strings &#x3D; Arrays.asList(â€œabcâ€, â€œâ€, â€œbcâ€, â€œefgâ€, â€œabcdâ€,â€â€, â€œjklâ€);List filtered &#x3D; strings.stream().filter(string -&gt; !string.isEmpty()).collect(Collectors.toList());\n\n\ndistinct\nè¿”å›ä¸€ä¸ªå…ƒç´ å„å¼‚ï¼ˆæ ¹æ®æµæ‰€ç”Ÿæˆå…ƒç´ çš„hashCodeå’Œequalsæ–¹æ³•å®ç°ï¼‰çš„æµã€‚\nList numbers &#x3D; Arrays.asList(1, 2, 1, 3, 3, 2, 4);numbers.stream().filter(i -&gt; i % 2 &#x3D;&#x3D; 0).distinct().forEach(System.out::println);\n\n\nlimit\nä¼šè¿”å›ä¸€ä¸ªä¸è¶…è¿‡ç»™å®šé•¿åº¦çš„æµã€‚\nList strings &#x3D; Arrays.asList(â€œabcâ€, â€œabcâ€, â€œbcâ€, â€œefgâ€, â€œabcdâ€,â€jklâ€, â€œjklâ€);List limited &#x3D; strings.stream().limit(3).collect(Collectors.toList());\n\n\nskip\nè¿”å›ä¸€ä¸ªæ‰”æ‰äº†å‰nä¸ªå…ƒç´ çš„æµã€‚\nList strings &#x3D; Arrays.asList(â€œabcâ€, â€œabcâ€, â€œbcâ€, â€œefgâ€, â€œabcdâ€,â€jklâ€, â€œjklâ€);List skiped &#x3D; strings.stream().skip(3).collect(Collectors.toList());\n\n\nmap\næ¥å—ä¸€ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°ã€‚è¿™ä¸ªå‡½æ•°ä¼šè¢«åº”ç”¨åˆ°æ¯ä¸ªå…ƒç´ ä¸Šï¼Œå¹¶å°†å…¶æ˜ å°„æˆä¸€ä¸ªæ–°çš„å…ƒç´ ï¼ˆä½¿ç”¨æ˜ å°„ä¸€è¯ï¼Œæ˜¯å› ä¸ºå®ƒå’Œè½¬æ¢ç±»ä¼¼ï¼Œä½†å…¶ä¸­çš„ç»†å¾®å·®åˆ«åœ¨äºå®ƒæ˜¯â€œåˆ›å»ºä¸€ä¸ªæ–°ç‰ˆæœ¬â€è€Œä¸æ˜¯å»â€œä¿®æ”¹â€ï¼‰ã€‚\nList strings &#x3D; Arrays.asList(â€œabcâ€, â€œabcâ€, â€œbcâ€, â€œefgâ€, â€œabcdâ€,â€jklâ€, â€œjklâ€);List mapped &#x3D; strings.stream().map(str-&gt;str+â€-itcastâ€).collect(Collectors.toList());\n\n\nflatMap\nä½¿ç”¨flatMapæ–¹æ³•çš„æ•ˆæœæ˜¯ï¼Œå„ä¸ªæ•°ç»„å¹¶ä¸æ˜¯åˆ†åˆ«æ˜ å°„æˆä¸€ä¸ªæµï¼Œè€Œæ˜¯æ˜ å°„æˆæµçš„å†…å®¹ã€‚æ‰€æœ‰ä½¿ç”¨map(Arrays::stream)æ—¶ç”Ÿæˆçš„å•ä¸ªæµéƒ½è¢«åˆå¹¶èµ·æ¥ï¼Œå³æ‰å¹³åŒ–ä¸ºä¸€ä¸ªæµã€‚\nList strings &#x3D; Arrays.asList(â€œabcâ€, â€œabcâ€, â€œbcâ€, â€œefgâ€, â€œabcdâ€,â€jklâ€, â€œjklâ€);Stream flatMap &#x3D; strings.stream().flatMap(Java8StreamTest::getCharacterByString);\n\n\nsorted\nè¿”å›æ’åºåçš„æµ\nList strings1 &#x3D; Arrays.asList(â€œabcâ€, â€œabdâ€, â€œabaâ€, â€œefgâ€, â€œabcdâ€,â€jklâ€, â€œjklâ€);List sorted1 &#x3D; strings1.stream().sorted().collect(Collectors.toList());\n\n\n\n\n\n\n\n\n\n\n\nç¤ºä¾‹ä»£ç ï¼š\n1ï¼‰filter\n/**\n * åŠŸèƒ½æè¿°:æ ¹æ®æ¡ä»¶è¿‡æ»¤é›†åˆæ•°æ®\n * @return : void\n */\n@Test\npublic void filter()&#123;\n    List&lt;String> strings = Arrays.asList(\"abc\", \"\", \"bc\", \"efg\", \"abcd\",\"\", \"jkl\");\n    List&lt;String> filtered = strings.stream().filter(string -> !string.isEmpty()).collect(Collectors.toList());\n    out.println(filtered);\n&#125;\n\n2ï¼‰distinct\n/**\n * åŠŸèƒ½æè¿°:å»é™¤é›†åˆä¸­é‡å¤æ•°æ®\n * @return : void\n */\n@Test\npublic void distinct()&#123;\n    List&lt;String> strings = Arrays.asList(\"abc\", \"abc\", \"bc\", \"efg\", \"abcd\",\"jkl\", \"jkl\");\n    List&lt;String> distincted = strings.stream().distinct().collect(Collectors.toList());\n    out.println(distincted);\n&#125;\n\n3ï¼‰limit\n/**\n * åŠŸèƒ½æè¿°:æŒ‡å®šè·å–é›†åˆå‰xæ¡æ•°æ®ï¼Œé‡æ–°æ„é€ ä¸€ä¸ªæ–°çš„é›†åˆ\n * @return : void\n */\n@Test\npublic void limit()&#123;\n    List&lt;String> strings = Arrays.asList(\"abc\", \"abc\", \"bc\", \"efg\", \"abcd\",\"jkl\", \"jkl\");\n    List&lt;String> limited = strings.stream().limit(3).collect(Collectors.toList());\n    out.println(limited);\n&#125;\n\n4ï¼‰skip\n/**\n * åŠŸèƒ½æè¿°:æ’é™¤é›†åˆå‰xæ¡æ•°æ®ï¼ŒæŠŠåé¢çš„æ•°æ®é‡æ–°æ„é€ ä¸€ä¸ªæ–°çš„é›†åˆ\n * @return : void\n */\n@Test\n    public void skip()&#123;\n    List&lt;String> strings = Arrays.asList(\"abc\", \"abc\", \"bc\", \"efg\", \"abcd\",\"jkl\", \"jkl\");\n    List&lt;String> skiped = strings.stream().skip(3).collect(Collectors.toList());\n    out.println(skiped);\n&#125;\n\n5ï¼‰map\n/**\n * åŠŸèƒ½æè¿°:å¯¹é›†åˆä¸­æ‰€æœ‰å…ƒç´ ç»Ÿä¸€å¤„ç†\n * @return : void\n */\n@Test\npublic void map()&#123;\n    List&lt;String> strings = Arrays.asList(\"abc\", \"abc\", \"bc\", \"efg\", \"abcd\",\"jkl\", \"jkl\");\n    List&lt;String> mapped = strings.stream().map(str->str+\"-itcast\").collect(Collectors.toList());\n    out.println(mapped);\n&#125;\n\n6ï¼‰flatMap\n/**\n * åŠŸèƒ½æè¿°:å¯¹é›†åˆä¸­æ‰€æœ‰å…ƒç´ ç»Ÿä¸€å¤„ç†\n * @return : void\n */\n@Test\npublic void flatMap()&#123;\n    List&lt;String> strings = Arrays.asList(\"abc\", \"abc\", \"bc\", \"efg\", \"abcd\",\"jkl\", \"jkl\");\n    Stream&lt;String> stringStream = strings.stream().map(x -> x);\n    Stream&lt;String> stringStream1 = strings.stream().flatMap(x -> Arrays.asList(x.split(\" \")).stream());\n&#125;\n\n7ï¼‰sorted\n/**\n * åŠŸèƒ½æè¿° : å¯¹é›†åˆè¿›è¡Œæ’åº\n * @return : void\n */\n@Test\npublic void sorted()&#123;\n    List&lt;String> strings1 = Arrays.asList(\"abc\", \"abd\", \"aba\", \"efg\", \"abcd\",\"jkl\", \"jkl\");\n    List&lt;String> strings2 = Arrays.asList(\"å¼ ä¸‰\", \"æå››\", \"ç‹äº”\", \"èµµæŸ³\", \"å¼ å“¥\",\"æå“¥\", \"ç‹å“¥\");\n    List&lt;Integer> strings3 = Arrays.asList(10, 2, 30, 22, 1,0, -9);\n    List&lt;String> sorted1 = strings1.stream().sorted().collect(Collectors.toList());\n    List&lt;String> sorted2 = strings2.stream().sorted(Collections.reverseOrder(Collator.getInstance(Locale.CHINA))).collect(Collectors.toList());\n    List&lt;Integer> sorted3 = strings3.stream().sorted().collect(Collectors.toList());\n    out.println(sorted1);\n    out.println(sorted2);\n    out.println(sorted3);\n&#125;\n\n Mapã€flatMapåŒºåˆ«\nmapï¼šå¯¹æµä¸­æ¯ä¸€ä¸ªå…ƒç´ è¿›è¡Œå¤„ç†\nflatMapï¼šæµæ‰å¹³åŒ–ï¼Œè®©ä½ æŠŠä¸€ä¸ªæµä¸­çš„â€œæ¯ä¸ªå€¼â€éƒ½æ¢æˆå¦ä¸€ä¸ªæµï¼Œç„¶åæŠŠæ‰€æœ‰çš„æµè¿æ¥èµ·æ¥æˆä¸ºä¸€ä¸ªæµ \næ€»ç»“ï¼šmapæ˜¯å¯¹ä¸€çº§å…ƒç´ è¿›è¡Œæ“ä½œï¼Œflatmapæ˜¯å¯¹äºŒçº§å…ƒç´ æ“ä½œã€‚\n\næœ¬è´¨åŒºåˆ«ï¼šmapè¿”å›ä¸€ä¸ªå€¼ï¼›flatmapè¿”å›ä¸€ä¸ªæµï¼Œå¤šä¸ªå€¼ã€‚\nåº”ç”¨åœºæ™¯ï¼šmapå¯¹é›†åˆä¸­æ¯ä¸ªå…ƒç´ åŠ å·¥,è¿”å›åŠ å·¥åç»“æœï¼›flatmapå¯¹é›†åˆä¸­æ¯ä¸ªå…ƒç´ åŠ å·¥åï¼Œåšæ‰å¹³åŒ–å¤„ç†åï¼ˆæ‹†åˆ†å±‚çº§ï¼Œæ”¾åˆ°åŒä¸€å±‚ï¼‰ç„¶åè¿”å›\n\n/**\n * æ–¹æ³•ä¸€\n * åŠŸèƒ½æè¿°:  é€šè¿‡ä½¿ç”¨mapã€flatMapæŠŠå­—ç¬¦ä¸²è½¬æ¢ä¸ºå­—ç¬¦è¾“å‡ºå¯¹æ¯”åŒºåˆ«\n * @return : void\n */\n@Test\npublic void flatMap2Map()&#123;\n    List&lt;String> strings = Arrays.asList(\"abc\", \"abc\", \"bc\", \"efg\", \"abcd\",\"jkl\", \"jkl\");\n    final Stream&lt;Character> flatMap = strings.stream().flatMap(Java8StreamTest::getCharacterByString);\n    flatMap.forEach(System.out::println);\n    //----------------------------------------------\n    final Stream&lt;Stream&lt;Character>> mapStream = strings.stream().map(Java8StreamTest::getCharacterByString);\n    //mapStream.forEach(System.out::println);\n    out.println(\"------------------------------------------------\");\n    mapStream.forEach(stream-> &#123;stream.forEach(character->&#123;System.out.println(character);&#125;);&#125;);\n\n&#125;\n\n\n\n\n\n\n\n\n\n\nå…¬å…±æ–¹æ³•ï¼ˆå­—ç¬¦ä¸²è½¬æ¢ä¸ºå­—ç¬¦æµï¼‰\n/**\n* åŠŸèƒ½æè¿°:å­—ç¬¦ä¸²è½¬æ¢ä¸ºå­—ç¬¦æµ\n* @param str\n* @return : java.util.stream.Stream&lt;java.lang.Character>\n*/\npublic static Stream&lt;Character> getCharacterByString(String str) &#123;\n    List&lt;Character> characterList = new ArrayList&lt;>();\n    for (Character character : str.toCharArray()) &#123;\n    \tcharacterList.add(character);\n    &#125;\n    return characterList.stream();\n&#125;\n\nç»ˆæ­¢æ“ä½œç¬¦\n\n\næµæ–¹æ³•\nå«ä¹‰\nç¤ºä¾‹\n\n\n\nanyMatch\næ£€æŸ¥æ˜¯å¦è‡³å°‘åŒ¹é…ä¸€ä¸ªå…ƒç´ ï¼Œè¿”å›booleanã€‚\nList strings &#x3D; Arrays.asList(â€œabcâ€, â€œabdâ€, â€œabaâ€, â€œefgâ€, â€œabcdâ€,â€jklâ€, â€œjklâ€);boolean b &#x3D; strings.stream().anyMatch(s -&gt; s &#x3D;&#x3D; â€œabcâ€);\n\n\nallMatch\næ£€æŸ¥æ˜¯å¦åŒ¹é…æ‰€æœ‰å…ƒç´ ï¼Œè¿”å›booleanã€‚\nList strings &#x3D; Arrays.asList(â€œabcâ€, â€œabdâ€, â€œabaâ€, â€œefgâ€, â€œabcdâ€,â€jklâ€, â€œjklâ€);boolean b &#x3D; strings.stream().allMatch(s -&gt; s &#x3D;&#x3D; â€œabcâ€);\n\n\nnoneMatch\næ£€æŸ¥æ˜¯å¦æ²¡æœ‰åŒ¹é…æ‰€æœ‰å…ƒç´ ï¼Œè¿”å›booleanã€‚\nList strings &#x3D; Arrays.asList(â€œabcâ€, â€œabdâ€, â€œabaâ€, â€œefgâ€, â€œabcdâ€,â€jklâ€, â€œjklâ€);boolean b &#x3D; strings.stream().noneMatch(s -&gt; s &#x3D;&#x3D; â€œabcâ€);\n\n\nfindAny\nå°†è¿”å›å½“å‰æµä¸­çš„ä»»æ„å…ƒç´ ã€‚\nList strings &#x3D; Arrays.asList(â€œcvâ€, â€œabdâ€, â€œabaâ€, â€œefgâ€, â€œabcdâ€,â€jklâ€, â€œjklâ€);Optional any &#x3D; strings.stream().findAny();\n\n\nfindFirst\nè¿”å›ç¬¬ä¸€ä¸ªå…ƒç´ \nList strings &#x3D; Arrays.asList(â€œcvâ€, â€œabdâ€, â€œabaâ€, â€œefgâ€, â€œabcdâ€,â€jklâ€, â€œjklâ€);Optional first &#x3D; strings.stream().findFirst();\n\n\nforEach\néå†æµ\nList strings &#x3D; Arrays.asList(â€œcvâ€, â€œabdâ€, â€œabaâ€, â€œefgâ€, â€œabcdâ€,â€jklâ€, â€œjklâ€);strings.stream().forEach(s -&gt; out.println(s));\n\n\ncollect\næ”¶é›†å™¨ï¼Œå°†æµè½¬æ¢ä¸ºå…¶ä»–å½¢å¼ã€‚\nList strings &#x3D; Arrays.asList(â€œcvâ€, â€œabdâ€, â€œabaâ€, â€œefgâ€, â€œabcdâ€,â€jklâ€, â€œjklâ€);Set set &#x3D; strings.stream().collect(Collectors.toSet());List list &#x3D; strings.stream().collect(Collectors.toList());Map&lt;String, String&gt; map &#x3D; strings.stream().collect(Collectors.toMap(v -&gt;v.concat(â€œ_nameâ€), v1 -&gt; v1, (v1, v2) -&gt; v1));\n\n\nreduce\nå¯ä»¥å°†æµä¸­å…ƒç´ åå¤ç»“åˆèµ·æ¥ï¼Œå¾—åˆ°ä¸€ä¸ªå€¼ã€‚\nList strings &#x3D; Arrays.asList(â€œcvâ€, â€œabdâ€, â€œabaâ€, â€œefgâ€, â€œabcdâ€,â€jklâ€, â€œjklâ€);Optional reduce &#x3D; strings.stream().reduce((acc,item) -&gt; {return acc+item;});if(reduce.isPresent())out.println(reduce.get());\n\n\ncount\nè¿”å›æµä¸­å…ƒç´ æ€»æ•°ã€‚\nList strings &#x3D; Arrays.asList(â€œcvâ€, â€œabdâ€, â€œabaâ€, â€œefgâ€, â€œabcdâ€,â€jklâ€, â€œjklâ€);long count &#x3D; strings.stream().count();\n\n\n\n\n\n\n\n\n\n\n\nç¤ºä¾‹ä»£ç \n1ï¼‰anyMatch\n/**\n * åŠŸèƒ½æè¿° : åˆ¤æ–­é›†åˆä¸­æ˜¯å¦è‡³å°‘å­˜åœ¨ä¸€ä¸ªå…ƒç´ æ»¡è¶³æ¡ä»¶\n * @return : void\n */\n@Test\npublic void anyMatch()&#123;\n    List&lt;String> strings = Arrays.asList(\"abc\", \"abd\", \"aba\", \"efg\", \"abcd\",\"jkl\", \"jkl\");\n    boolean b = strings.stream().anyMatch(s -> s == \"abc\");\n    out.println(b);\n&#125;\n\n2ï¼‰allMatch\n/**\n * åŠŸèƒ½æè¿° : åˆ¤æ–­é›†åˆä¸­æ˜¯å¦æ‰€æœ‰å…ƒç´ éƒ½æ»¡è¶³æ¡ä»¶\n * @return : void\n */\n@Test\npublic void allMatch()&#123;\n    List&lt;String> strings = Arrays.asList(\"abc\", \"abd\", \"aba\", \"efg\", \"abcd\",\"jkl\", \"jkl\");\n    boolean b = strings.stream().allMatch(s -> s == \"abc\");\n    out.println(b);\n&#125;\n\n3ï¼‰noneMatch\n/**\n * åŠŸèƒ½æè¿° : åˆ¤æ–­é›†åˆä¸­æ˜¯å¦æ‰€æœ‰å…ƒç´ éƒ½ä¸æ»¡è¶³æ¡ä»¶\n * @return : void\n */\n@Test\npublic void noneMatch()&#123;\n    List&lt;String> strings = Arrays.asList(\"abc\", \"abd\", \"aba\", \"efg\", \"abcd\",\"jkl\", \"jkl\");\n    boolean b = strings.stream().noneMatch(s -> s == \"abc\");\n    out.println(b);\n&#125;\n\n4ï¼‰findAny\n/**\n * åŠŸèƒ½æè¿° : è¿”å›å½“å‰æµä¸­ä»»æ„å…ƒç´ \n * @return : void\n */\n@Test\npublic void findAny()&#123;\n    List&lt;String> strings = Arrays.asList(\"cv\", \"abd\", \"aba\", \"efg\", \"abcd\",\"jkl\", \"jkl\");\n    Optional&lt;String> any = strings.stream().findAny();\n    if(any.isPresent()) out.println(any.get());\n&#125;\n\n5ï¼‰findFirst\n/**\n * åŠŸèƒ½æè¿° : è¿”å›å½“å‰æµä¸­ç¬¬ä¸€ä¸ªå…ƒç´ \n * @return : void\n */\n@Test\npublic void findFirst()&#123;\n    List&lt;String> strings = Arrays.asList(\"cv\", \"abd\", \"aba\", \"efg\", \"abcd\",\"jkl\", \"jkl\");\n    Optional&lt;String> first = strings.stream().findFirst();\n    if(first.isPresent()) out.println(first.get());\n&#125;\n\n6ï¼‰forEach java \n/**\n * åŠŸèƒ½æè¿° : éå†æµ\n * @return : void\n */\n@Test\npublic void foreach()&#123;\n    List&lt;String> strings = Arrays.asList(\"cv\", \"abd\", \"aba\", \"efg\", \"abcd\",\"jkl\", \"jkl\");\n    strings.stream().forEach(s -> out.println(s));\n&#125;\n\n7ï¼‰collect\n/**\n * åŠŸèƒ½æè¿° : æµè½¬æ¢ä¸ºå…¶ä»–å½¢å¼\n * @return : void\n */\n@Test\npublic void collect()&#123;\n    List&lt;String> strings = Arrays.asList(\"cv\", \"abd\", \"aba\", \"efg\", \"abcd\",\"jkl\", \"jkl\");\n    Set&lt;String> set = strings.stream().collect(Collectors.toSet());\n    List&lt;String> list = strings.stream().collect(Collectors.toList());\n    Map&lt;String, String> map = strings.stream().collect(Collectors.toMap(v ->v.concat(\"_name\"), v1 -> v1, (v1, v2) -> v1));\n    out.println(set);\n    out.println(list);\n    out.println(map);\n&#125;\n\n8ï¼‰reduce\n/**\n * åŠŸèƒ½æè¿° : å°†æµä¸­å…ƒç´ åå¤ç»“åˆèµ·æ¥ï¼Œå¾—åˆ°ä¸€ä¸ªå€¼\n * @return : void\n */\n@Test\npublic void reduce()&#123;\n    List&lt;String> strings = Arrays.asList(\"cv\", \"abd\", \"aba\", \"efg\", \"abcd\",\"jkl\", \"jkl\");\n    //reduceæ–¹æ³•ä¸€\n    Optional&lt;String> reduce1 = strings.stream().reduce((acc,item) -> &#123;return acc+item;&#125;);\n    //reduceæ–¹æ³•äºŒ\n    String reduce2 = strings.stream().reduce(\"itcast\", (acc, item) -> &#123;\n    \treturn acc + item;\n    &#125;);\n    //reduceæ–¹æ³•ä¸‰\n    ArrayList&lt;String> reduce3 = strings.stream().reduce(\n        new ArrayList&lt;String>(),\n   \t\tnew BiFunction&lt;ArrayList&lt;String>, String, ArrayList&lt;String>>() &#123;\n    \t\t@Override\n    \t\tpublic ArrayList&lt;String> apply(ArrayList&lt;String> acc, String item) &#123;\n    \t\t\tacc.add(item);\n    \t\t\treturn acc;\n    \t\t&#125;\n    \t&#125;, \n        new BinaryOperator&lt;ArrayList&lt;String>>() &#123;\n   \t\t\t@Override\n    \t\tpublic ArrayList&lt;String> apply(ArrayList&lt;String> acc, ArrayList&lt;String> item) &#123;\n    \t\treturn acc;\n    \t\t&#125;\n    \t&#125;\n    );\n    if(reduce1.isPresent())out.println(reduce1.get());\n    out.println(reduce2);\n    out.println(reduce3);\n&#125;\n\n9ï¼‰count\n/**\n* åŠŸèƒ½æè¿° : è¿”å›æµä¸­å…ƒç´ æ€»æ•°\n* @return : void\n*/\n@Test\npublic void count()&#123;\n    List&lt;String> strings = Arrays.asList(\"cv\", \"abd\", \"aba\", \"efg\", \"abcd\",\"jkl\", \"jkl\");\n    long count = strings.stream().count();\n    out.println(count);\n&#125;\næ³¨æ„ï¼šæ–‡ç« ä¸­å› æ’åºéƒ¨åˆ†ç”¨åˆ°å¤–éƒ¨æ¯”è¾ƒå™¨ï¼Œéœ€è¦å¯¼å…¥å¤–éƒ¨jaråŒ…\n&lt;!--apacheé›†åˆæ“ä½œå·¥å…·åŒ…-->\n&lt;dependency>\n    &lt;groupId>org.apache.commons&lt;/groupId>\n    &lt;artifactId>commons-collections4&lt;/artifactId>\n    &lt;version>4.4&lt;/version>\n&lt;/dependency>\n\n","slug":"Java8 Streamè¯¦è§£","date":"2022-07-09T07:49:18.688Z","categories_index":"java","tags_index":"java,Stream","author_index":"å°æä¸åœ¨_"},{"id":"3244bafd4b77bc1eda4a2f2a047e0e05","title":"MybatisPlus","content":"ä¸€ã€MyBatis-Plus1.ç®€ä»‹MyBatis-Plus (opens new window)ï¼ˆç®€ç§° MPï¼‰æ˜¯ä¸€ä¸ª MyBatis (opens new window)çš„å¢å¼ºå·¥å…·ï¼Œåœ¨ MyBatis çš„åŸºç¡€ä¸Šåªåšå¢å¼ºä¸åšæ”¹å˜ï¼Œä¸ºç®€åŒ–å¼€å‘ã€æé«˜æ•ˆç‡è€Œç”Ÿã€‚\n\n\n\n\n\n\n\n\n\næˆ‘ä»¬çš„æ„¿æ™¯æ˜¯æˆä¸º MyBatis æœ€å¥½çš„æ­æ¡£ï¼Œå°±åƒ é­‚æ–—ç½— ä¸­çš„ 1Pã€2Pï¼ŒåŸºå‹æ­é…ï¼Œæ•ˆç‡ç¿»å€ã€‚\n\n2.ç‰¹æ€§\næ— ä¾µå…¥ï¼šåªåšå¢å¼ºä¸åšæ”¹å˜ï¼Œå¼•å…¥å®ƒä¸ä¼šå¯¹ç°æœ‰å·¥ç¨‹äº§ç”Ÿå½±å“ï¼Œå¦‚ä¸èˆ¬é¡ºæ»‘\næŸè€—å°ï¼šå¯åŠ¨å³ä¼šè‡ªåŠ¨æ³¨å…¥åŸºæœ¬ CURDï¼Œæ€§èƒ½åŸºæœ¬æ— æŸè€—ï¼Œç›´æ¥é¢å‘å¯¹è±¡æ“ä½œ\nå¼ºå¤§çš„ CRUD æ“ä½œï¼šå†…ç½®é€šç”¨ Mapperã€é€šç”¨ Serviceï¼Œä»…ä»…é€šè¿‡å°‘é‡é…ç½®å³å¯å®ç°å•è¡¨å¤§éƒ¨åˆ† CRUD æ“ä½œï¼Œæ›´æœ‰å¼ºå¤§çš„æ¡ä»¶æ„é€ å™¨ï¼Œæ»¡è¶³å„ç±»ä½¿ç”¨éœ€æ±‚\næ”¯æŒ Lambda å½¢å¼è°ƒç”¨ï¼šé€šè¿‡ Lambda è¡¨è¾¾å¼ï¼Œæ–¹ä¾¿çš„ç¼–å†™å„ç±»æŸ¥è¯¢æ¡ä»¶ï¼Œæ— éœ€å†æ‹…å¿ƒå­—æ®µå†™é”™\næ”¯æŒä¸»é”®è‡ªåŠ¨ç”Ÿæˆï¼šæ”¯æŒå¤šè¾¾ 4 ç§ä¸»é”®ç­–ç•¥ï¼ˆå†…å«åˆ†å¸ƒå¼å”¯ä¸€ ID ç”Ÿæˆå™¨ - Sequenceï¼‰ï¼Œå¯è‡ªç”±é…ç½®ï¼Œå®Œç¾è§£å†³ä¸»é”®é—®é¢˜\næ”¯æŒ ActiveRecord æ¨¡å¼ï¼šæ”¯æŒ ActiveRecord å½¢å¼è°ƒç”¨ï¼Œå®ä½“ç±»åªéœ€ç»§æ‰¿ Model ç±»å³å¯è¿›è¡Œå¼ºå¤§çš„ CRUD æ“ä½œ\næ”¯æŒè‡ªå®šä¹‰å…¨å±€é€šç”¨æ“ä½œï¼šæ”¯æŒå…¨å±€é€šç”¨æ–¹æ³•æ³¨å…¥ï¼ˆ Write once, use anywhere ï¼‰\nå†…ç½®ä»£ç ç”Ÿæˆå™¨ï¼šé‡‡ç”¨ä»£ç æˆ–è€… Maven æ’ä»¶å¯å¿«é€Ÿç”Ÿæˆ Mapper ã€ Model ã€ Service ã€ Controller å±‚ä»£ç ï¼Œæ”¯æŒæ¨¡æ¿å¼•æ“ï¼Œæ›´æœ‰è¶…å¤šè‡ªå®šä¹‰é…ç½®ç­‰æ‚¨æ¥ä½¿ç”¨\nå†…ç½®åˆ†é¡µæ’ä»¶ï¼šåŸºäº MyBatis ç‰©ç†åˆ†é¡µï¼Œå¼€å‘è€…æ— éœ€å…³å¿ƒå…·ä½“æ“ä½œï¼Œé…ç½®å¥½æ’ä»¶ä¹‹åï¼Œå†™åˆ†é¡µç­‰åŒäºæ™®é€š List æŸ¥è¯¢\nåˆ†é¡µæ’ä»¶æ”¯æŒå¤šç§æ•°æ®åº“ï¼šæ”¯æŒ MySQLã€MariaDBã€Oracleã€DB2ã€H2ã€HSQLã€SQLiteã€Postgreã€SQLServer ç­‰å¤šç§æ•°æ®åº“\nå†…ç½®æ€§èƒ½åˆ†ææ’ä»¶ï¼šå¯è¾“å‡º SQL è¯­å¥ä»¥åŠå…¶æ‰§è¡Œæ—¶é—´ï¼Œå»ºè®®å¼€å‘æµ‹è¯•æ—¶å¯ç”¨è¯¥åŠŸèƒ½ï¼Œèƒ½å¿«é€Ÿæªå‡ºæ…¢æŸ¥è¯¢\nå†…ç½®å…¨å±€æ‹¦æˆªæ’ä»¶ï¼šæä¾›å…¨è¡¨ delete ã€ update æ“ä½œæ™ºèƒ½åˆ†æé˜»æ–­ï¼Œä¹Ÿå¯è‡ªå®šä¹‰æ‹¦æˆªè§„åˆ™ï¼Œé¢„é˜²è¯¯æ“ä½œ\n\n3.æ”¯æŒæ•°æ®åº“\n\n\n\n\n\n\n\n\nä»»ä½•èƒ½ä½¿ç”¨ MyBatis è¿›è¡Œ CRUD, å¹¶ä¸”æ”¯æŒæ ‡å‡† SQL çš„æ•°æ®åº“ï¼Œå…·ä½“æ”¯æŒæƒ…å†µå¦‚ä¸‹ï¼Œå¦‚æœä¸åœ¨ä¸‹åˆ—è¡¨æŸ¥çœ‹åˆ†é¡µéƒ¨åˆ†æ•™ç¨‹ PR æ‚¨çš„æ”¯æŒã€‚\n\nMySQLï¼ŒOracleï¼ŒDB2ï¼ŒH2ï¼ŒHSQLï¼ŒSQLiteï¼ŒPostgreSQLï¼ŒSQLServerï¼ŒPhoenixï¼ŒGauss ï¼ŒClickHouseï¼ŒSybaseï¼ŒOceanBaseï¼ŒFirebirdï¼ŒCubridï¼ŒGoldilocksï¼Œcsiidb\nè¾¾æ¢¦æ•°æ®åº“ï¼Œè™šè°·æ•°æ®åº“ï¼Œäººå¤§é‡‘ä»“æ•°æ®åº“ï¼Œå—å¤§é€šç”¨(ååº“)æ•°æ®åº“ï¼Œå—å¤§é€šç”¨æ•°æ®åº“ï¼Œç¥é€šæ•°æ®åº“ï¼Œç€šé«˜æ•°æ®åº“\n\n4.æ¡†æ¶ç»“æ„\n\n\n\n5.å®˜æ–¹åœ°å€\n\n\n\n\n\n\n\n\nå®˜æ–¹ç½‘ç«™ï¼šhttps://baomidou.com/\nå®˜æ–¹æ–‡æ¡£ï¼šhttps://baomidou.com/pages/24112f/\näºŒã€å…¥é—¨æ¡ˆä¾‹1.å¼€å‘ç¯å¢ƒ\nIDEï¼šIDEA 2019.3.5\nJDKï¼šJDK8+\næ„å»ºå·¥å…·ï¼šMaven 3.5.4\nMySQLï¼šMySQL 8.0.24\nNavicatï¼šNavicat Premium 15\nSpring Bootï¼š2.6.7\nMyBatis-Plusï¼š3.5.1\n\n2.å»ºåº“å»ºè¡¨\næ‰“å¼€Navicatè¿è¡Œä»¥ä¸‹SQLè„šæœ¬è¿›è¡Œå»ºåº“å»ºè¡¨\nCREATE DATABASE `mybatis_plus` /*!40100 DEFAULT CHARACTER SET utf8mb4 */; \nuse `mybatis_plus`; \nCREATE TABLE `user` ( \n    `id` bigint(20) NOT NULL COMMENT 'ä¸»é”®ID', \n    `name` varchar(30) DEFAULT NULL COMMENT 'å§“å', \n    `age` int(11) DEFAULT NULL COMMENT 'å¹´é¾„', \n    `email` varchar(50) DEFAULT NULL COMMENT 'é‚®ç®±', \n    PRIMARY KEY (`id`) \n) ENGINE=InnoDB DEFAULT CHARSET=utf8;\n\næ’å…¥å‡ æ¡æµ‹è¯•æ•°æ®\nINSERT INTO user (id, name, age, email) VALUES \n(1, 'Jone', 18, 'test1@baomidou.com'), \n(2, 'Jack', 20, 'test2@baomidou.com'), \n(3, 'Tom', 28, 'test3@baomidou.com'), \n(4, 'Sandy', 21, 'test4@baomidou.com'), \n(5, 'Billie', 24, 'test5@baomidou.com');\n\n3.åˆ›å»ºå·¥ç¨‹\nä½¿ç”¨Spring Initializerå¿«é€Ÿåˆå§‹åŒ–ä¸€ä¸ª Spring Boot å·¥ç¨‹\n\n\n\n\n\n\n\n\nå¼•å…¥MyBatis-Plusçš„ä¾èµ–\n&lt;dependency>\n    &lt;groupId>com.baomidou&lt;/groupId>\n    &lt;artifactId>mybatis-plus-boot-starter&lt;/artifactId>\n    &lt;version>3.5.1&lt;/version>\n&lt;/dependency>\n\nå®‰è£…Lombokæ’ä»¶\n\n\n4.é…ç½®ç¼–ç \né…ç½®application.ymlæ–‡ä»¶\n#é…ç½®ç«¯å£\nserver:\n  port: 80\n\nspring:\n  #é…ç½®æ•°æ®æº\n  datasource:\n    #é…ç½®æ•°æ®æºç±»å‹\n    type: com.zaxxer.hikari.HikariDataSource\n    #é…ç½®è¿æ¥æ•°æ®åº“çš„ä¿¡æ¯\n    driver-class-name: com.mysql.cj.jdbc.Driver\n    url: jdbc:mysql://localhost:3306/mybatis_plus?characterEncoding=utf-8&amp;useSSL=false\n    username: &#123;username&#125;\n    password: &#123;password&#125;\n\n#MyBatis-Plusç›¸å…³é…ç½®\nmybatis-plus:\n  configuration:\n    #é…ç½®æ—¥å¿—\n    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl\n\nåœ¨ Spring Boot å¯åŠ¨ç±»ä¸­æ·»åŠ  @MapperScan æ³¨è§£ï¼Œæ‰«æ Mapper æ–‡ä»¶å¤¹\n@SpringBootApplication\n@MapperScan(\"æŒ‡å®šMapperæ¥å£æ‰€åœ¨çš„åŒ…\")\npublic class MybatisPlusDemoApplication &#123;\n\tpublic static void main(String[] args) &#123;\n\t\tSpringApplication.run(MybatisPlusDemoApplication.class, args);\n\t&#125;\n&#125;\n\nç¼–å†™å®ä½“ç±» User.javaï¼ˆæ­¤å¤„ä½¿ç”¨äº† Lombok ç®€åŒ–ä»£ç ï¼‰\n@Data\npublic class User &#123;\n    private Long id;\n    private String name;\n    private Integer age;\n    private String email;\n&#125;\n\nç¼–å†™ Mapper åŒ…ä¸‹çš„ UserMapperæ¥å£\npublic interface UserMapper extends BaseMapper&lt;User> &#123;&#125;\n\n5.æµ‹è¯•æŸ¥è¯¢\nç¼–å†™ä¸€ä¸ªæµ‹è¯•ç±»MyBatisPlusTest.java\n@SpringBootTest\npublic class MyBatisPlusTest &#123;\n    @Resource\n    private UserMapper userMapper;\n\n    /**\n     * æµ‹è¯•æŸ¥è¯¢æ‰€æœ‰æ•°æ®\n     */\n    @Test\n    void testSelectList()&#123;\n        //é€šè¿‡æ¡ä»¶æ„é€ å™¨æŸ¥è¯¢ä¸€ä¸ªlisté›†åˆï¼Œè‹¥æ²¡æœ‰æ¡ä»¶ï¼Œåˆ™å¯ä»¥è®¾ç½®nullä¸ºå‚æ•°\n        List&lt;User> users = userMapper.selectList(null);\n        users.forEach(System.out::println);\n    &#125;\n&#125;\n\næ§åˆ¶å°æ‰“å°æŸ¥è¯¢ç»“æœ\n\n\n\nä¸‰ã€å¢åˆ æ”¹æŸ¥1.BaseMapper&lt;T&gt;\n\n\n\n\n\n\n\n\nè¯´æ˜:\n\né€šç”¨ CRUD å°è£…BaseMapper æ¥å£ï¼Œä¸º Mybatis-Plus å¯åŠ¨æ—¶è‡ªåŠ¨è§£æå®ä½“è¡¨å…³ç³»æ˜ å°„è½¬æ¢ä¸º Mybatis å†…éƒ¨å¯¹è±¡æ³¨å…¥å®¹å™¨\næ³›å‹ T ä¸ºä»»æ„å®ä½“å¯¹è±¡\nå‚æ•° Serializable ä¸ºä»»æ„ç±»å‹ä¸»é”® Mybatis-Plus ä¸æ¨èä½¿ç”¨å¤åˆä¸»é”®çº¦å®šæ¯ä¸€å¼ è¡¨éƒ½æœ‰è‡ªå·±çš„å”¯ä¸€ id ä¸»é”®\nå¯¹è±¡ Wrapper ä¸ºæ¡ä»¶æ„é€ å™¨\n\nMyBatis-Plusä¸­çš„åŸºæœ¬CRUDåœ¨å†…ç½®çš„BaseMapperä¸­éƒ½å·²å¾—åˆ°äº†å®ç°ï¼Œå› æ­¤æˆ‘ä»¬ç»§æ‰¿è¯¥æ¥å£ä»¥åå¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚\næœ¬æ¬¡æ¼”ç¤ºçš„CRUDæ“ä½œä¸åŒ…å«å‚æ•°å¸¦æœ‰æ¡ä»¶æ„é€ å™¨çš„æ–¹æ³•ï¼Œå…³äºæ¡ä»¶æ„é€ å™¨å°†å•ç‹¬åœ¨ä¸€ä¸ªç« èŠ‚è¿›è¡Œæ¼”ç¤ºã€‚\n\n\n\n\n\n\n\n\n\n\nBaseMapperä¸­æä¾›çš„CRUDæ–¹æ³•ï¼š\n\nå¢åŠ ï¼šInsert\n// æ’å…¥ä¸€æ¡è®°å½•\nint insert(T entity);\n\nåˆ é™¤ï¼šDelete\n// æ ¹æ® entity æ¡ä»¶ï¼Œåˆ é™¤è®°å½•\nint delete(@Param(Constants.WRAPPER) Wrapper&lt;T> wrapper);\n// åˆ é™¤ï¼ˆæ ¹æ®ID æ‰¹é‡åˆ é™¤ï¼‰\nint deleteBatchIds(@Param(Constants.COLLECTION) Collection&lt;? extends Serializable> idList);\n// æ ¹æ® ID åˆ é™¤\nint deleteById(Serializable id);\n// æ ¹æ® columnMap æ¡ä»¶ï¼Œåˆ é™¤è®°å½•\nint deleteByMap(@Param(Constants.COLUMN_MAP) Map&lt;String, Object> columnMap);\n\nä¿®æ”¹ï¼šUpdate\n// æ ¹æ® whereWrapper æ¡ä»¶ï¼Œæ›´æ–°è®°å½•\nint update(@Param(Constants.ENTITY) T updateEntity, @Param(Constants.WRAPPER) Wrapper&lt;T> whereWrapper);\n// æ ¹æ® ID ä¿®æ”¹\nint updateById(@Param(Constants.ENTITY) T entity);\n\næŸ¥è¯¢ï¼šSelete\n// æ ¹æ® ID æŸ¥è¯¢\nT selectById(Serializable id);\n// æ ¹æ® entity æ¡ä»¶ï¼ŒæŸ¥è¯¢ä¸€æ¡è®°å½•\nT selectOne(@Param(Constants.WRAPPER) Wrapper&lt;T> queryWrapper);\n\n// æŸ¥è¯¢ï¼ˆæ ¹æ®ID æ‰¹é‡æŸ¥è¯¢ï¼‰\nList&lt;T> selectBatchIds(@Param(Constants.COLLECTION) Collection&lt;? extends Serializable> idList);\n// æ ¹æ® entity æ¡ä»¶ï¼ŒæŸ¥è¯¢å…¨éƒ¨è®°å½•\nList&lt;T> selectList(@Param(Constants.WRAPPER) Wrapper&lt;T> queryWrapper);\n// æŸ¥è¯¢ï¼ˆæ ¹æ® columnMap æ¡ä»¶ï¼‰\nList&lt;T> selectByMap(@Param(Constants.COLUMN_MAP) Map&lt;String, Object> columnMap);\n// æ ¹æ® Wrapper æ¡ä»¶ï¼ŒæŸ¥è¯¢å…¨éƒ¨è®°å½•\nList&lt;Map&lt;String, Object>> selectMaps(@Param(Constants.WRAPPER) Wrapper&lt;T> queryWrapper);\n// æ ¹æ® Wrapper æ¡ä»¶ï¼ŒæŸ¥è¯¢å…¨éƒ¨è®°å½•ã€‚æ³¨æ„ï¼š åªè¿”å›ç¬¬ä¸€ä¸ªå­—æ®µçš„å€¼\nList&lt;Object> selectObjs(@Param(Constants.WRAPPER) Wrapper&lt;T> queryWrapper);\n\n// æ ¹æ® entity æ¡ä»¶ï¼ŒæŸ¥è¯¢å…¨éƒ¨è®°å½•ï¼ˆå¹¶ç¿»é¡µï¼‰\nIPage&lt;T> selectPage(IPage&lt;T> page, @Param(Constants.WRAPPER) Wrapper&lt;T> queryWrapper);\n// æ ¹æ® Wrapper æ¡ä»¶ï¼ŒæŸ¥è¯¢å…¨éƒ¨è®°å½•ï¼ˆå¹¶ç¿»é¡µï¼‰\nIPage&lt;Map&lt;String, Object>> selectMapsPage(IPage&lt;T> page, @Param(Constants.WRAPPER) Wrapper&lt;T> queryWrapper);\n// æ ¹æ® Wrapper æ¡ä»¶ï¼ŒæŸ¥è¯¢æ€»è®°å½•æ•°\nInteger selectCount(@Param(Constants.WRAPPER) Wrapper&lt;T> queryWrapper);\n\n2.è°ƒç”¨Mapperå±‚å®ç°CRUD2.1\tæ’å…¥\n\n\n\n\n\n\n\n\n\næœ€ç»ˆæ‰§è¡Œçš„ç»“æœï¼Œæ‰€è·å–çš„idä¸º1527206783590903810\nè¿™æ˜¯å› ä¸ºMyBatis-Plusåœ¨å®ç°æ’å…¥æ•°æ®æ—¶ï¼Œä¼šé»˜è®¤åŸºäºé›ªèŠ±ç®—æ³•çš„ç­–ç•¥ç”Ÿæˆid\n/**\n  * æµ‹è¯•æ’å…¥ä¸€æ¡æ•°æ®\n  * MyBatis-Plusåœ¨å®ç°æ’å…¥æ•°æ®æ—¶ï¼Œä¼šé»˜è®¤åŸºäºé›ªèŠ±ç®—æ³•çš„ç­–ç•¥ç”Ÿæˆid\n  */\n@Test\npublic void testInsert()&#123;\n    User user = new User();\n    user.setName(\"Vz\");\n    user.setAge(21);\n    user.setEmail(\"vz@oz6.cn\");\n    int result = userMapper.insert(user);\n    System.out.println(result > 0 ? \"æ·»åŠ æˆåŠŸï¼\" : \"æ·»åŠ å¤±è´¥ï¼\");\n    System.out.println(\"å—å½±å“çš„è¡Œæ•°ä¸ºï¼š\" + result);\n    //1527206783590903810ï¼ˆå½“å‰ id ä¸ºé›ªèŠ±ç®—æ³•è‡ªåŠ¨ç”Ÿæˆçš„idï¼‰\n    System.out.println(\"idè‡ªåŠ¨è·å–\" + user.getId());\n&#125;\n\n\n\n2.2\tåˆ é™¤\naã€æ ¹æ®IDåˆ é™¤æ•°æ®\n\n\n\n\n\n\n\n\nè°ƒç”¨æ–¹æ³•ï¼šint deleteById(Serializable id);\n/**\n  * æµ‹è¯•æ ¹æ®idåˆ é™¤ä¸€æ¡æ•°æ®\n  */\n@Test\npublic void testDeleteById()&#123;\n    int result = userMapper.deleteById(1527206783590903810L);\n    System.out.println(result > 0 ? \"åˆ é™¤æˆåŠŸï¼\" : \"åˆ é™¤å¤±è´¥ï¼\");\n    System.out.println(\"å—å½±å“çš„è¡Œæ•°ä¸ºï¼š\" + result);\n&#125;\n\n\n\nbã€æ ¹æ®IDæ‰¹é‡åˆ é™¤æ•°æ®\n\n\n\n\n\n\n\n\nè°ƒç”¨æ–¹æ³•ï¼šint deleteBatchIds(@Param(Constants.COLLECTION) Collection&lt;? extends Serializable&gt; idList);\n/**\n  * æµ‹è¯•é€šè¿‡idæ‰¹é‡åˆ é™¤æ•°æ®\n  */\n@Test\npublic void testDeleteBatchIds()&#123;\n    List&lt;Long> ids = Arrays.asList(6L,7L,8L);\n    int result = userMapper.deleteBatchIds(ids);\n    System.out.println(result > 0 ? \"åˆ é™¤æˆåŠŸï¼\" : \"åˆ é™¤å¤±è´¥ï¼\");\n    System.out.println(\"å—å½±å“çš„è¡Œæ•°ä¸ºï¼š\" + result);\n&#125;\n\n\n\ncã€æ ¹æ®Mapæ¡ä»¶åˆ é™¤æ•°æ®\n\n\n\n\n\n\n\n\nè°ƒç”¨æ–¹æ³•ï¼šint deleteByMap(@Param(Constants.COLUMN_MAP) Map&lt;String, Object&gt; columnMap);\n/**\n   * æµ‹è¯•æ ¹æ®Mapé›†åˆä¸­æ‰€è®¾ç½®çš„æ¡ä»¶åˆ é™¤æ•°æ®\n   */\n@Test\npublic void testDeleteByMap()&#123;\n    //å½“å‰æ¼”ç¤ºä¸ºæ ¹æ®nameå’Œageåˆ é™¤æ•°æ®\n    //æ‰§è¡ŒSQLä¸ºï¼šDELETE FROM user WHERE name = ? AND age = ?\n    Map&lt;String,Object> map = new HashMap&lt;>();\n    map.put(\"name\",\"Vz\");\n    map.put(\"age\",21);\n    int result = userMapper.deleteByMap(map);\n    System.out.println(result > 0 ? \"åˆ é™¤æˆåŠŸï¼\" : \"åˆ é™¤å¤±è´¥ï¼\");\n    System.out.println(\"å—å½±å“çš„è¡Œæ•°ä¸ºï¼š\" + result);\n&#125;\n\n\n\n2.3\tä¿®æ”¹\n\n\n\n\n\n\n\n\nè°ƒç”¨æ–¹æ³•ï¼šint updateById(@Param(Constants.ENTITY) T entity);\n/**\n  * æµ‹è¯•æ ¹æ®idä¿®æ”¹ç”¨æˆ·ä¿¡æ¯\n  */\n@Test\npublic void testUpdateById()&#123;\n    //æ‰§è¡ŒSQLä¸ºï¼š UPDATE user SET name=?, age=?, email=? WHERE id=?\n    User user = new User();\n    user.setId(6L);\n    user.setName(\"VzUpdate\");\n    user.setAge(18);\n    user.setEmail(\"Vz@sina.com\");\n    int result = userMapper.updateById(user);\n    System.out.println(result > 0 ? \"ä¿®æ”¹æˆåŠŸï¼\" : \"ä¿®æ”¹å¤±è´¥ï¼\");\n    System.out.println(\"å—å½±å“çš„è¡Œæ•°ä¸ºï¼š\" + result);\n&#125;\n\n\n\n2.4\tæŸ¥è¯¢\naã€æ ¹æ®IDæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯\n\n\n\n\n\n\n\n\nè°ƒç”¨æ–¹æ³•ï¼šT selectById(Serializable id);\n/**\n  * æµ‹è¯•æ ¹æ®idæŸ¥è¯¢ç”¨æˆ·æ•°æ®\n  */\n@Test\npublic void testSelectById()&#123;\n    User user = userMapper.selectById(1L);\n    System.out.println(user);\n&#125;\n\n\n\nbã€æ ¹æ®å¤šä¸ªIDæŸ¥è¯¢å¤šä¸ªç”¨æˆ·ä¿¡æ¯\n\n\n\n\n\n\n\n\nè°ƒç”¨æ–¹æ³•ï¼šList selectBatchIds(@Param(Constants.COLLECTION) Collection&lt;? extends Serializable&gt; idList);\n/**\n  * æ ¹æ®å¤šä¸ªidæŸ¥è¯¢ç”¨æˆ·æ•°æ®\n  */\n@Test\npublic void testSelectBatchIds()&#123;\n    //æ‰§è¡ŒSQLä¸ºï¼šSELECT id,name,age,email FROM user WHERE id IN ( ? , ? , ? )\n    List&lt;Long> ids = Arrays.asList(1L,2L,3L);\n    List&lt;User> users = userMapper.selectBatchIds(ids);\n    users.forEach(System.out::println);\n&#125;\n\n\n\n\n\ncã€æ ¹æ®Mapæ¡ä»¶æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯\n\n\n\n\n\n\n\n\nè°ƒç”¨æ–¹æ³•ï¼šList selectByMap(@Param(Constants.COLUMN_MAP) Map&lt;String, Object&gt; columnMap);\n/**\n  * æ ¹æ®Mapæ‰€è®¾ç½®çš„æ¡ä»¶æŸ¥è¯¢ç”¨æˆ·\n  */\n@Test\npublic void testSelectByMap()&#123;\n    //æ‰§è¡ŒSQLä¸ºï¼šSELECT id,name,age,email FROM user WHERE age = ?\n    Map&lt;String,Object> map = new HashMap&lt;>();\n    map.put(\"age\",18);\n    List&lt;User> users = userMapper.selectByMap(map);\n    users.forEach(System.out::println);\n&#125;\n\n\n\ndã€æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·ä¿¡æ¯\n\n\n\n\n\n\n\n\nè°ƒç”¨æ–¹æ³•ï¼šList selectList(@Param(Constants.WRAPPER) Wrapper queryWrapper);\n/**\n  * æµ‹è¯•æŸ¥è¯¢æ‰€æœ‰æ•°æ®\n  */\n@Test\nvoid testSelectList()&#123;\n    List&lt;User> users = userMapper.selectList(null);\n    users.forEach(System.out::println);\n&#125;\n\n\n\n3.é€šç”¨Service\n\n\n\n\n\n\n\n\nè¯´æ˜:\n\né€šç”¨ Service CRUD å°è£…IServiceæ¥å£ï¼Œè¿›ä¸€æ­¥å°è£… CRUD é‡‡ç”¨ get æŸ¥è¯¢å•è¡Œ remove åˆ é™¤ list æŸ¥è¯¢é›†åˆ page åˆ†é¡µ å‰ç¼€å‘½åæ–¹å¼åŒºåˆ† Mapper å±‚é¿å…æ··æ·†ï¼Œ\næ³›å‹ T ä¸ºä»»æ„å®ä½“å¯¹è±¡\nå»ºè®®å¦‚æœå­˜åœ¨è‡ªå®šä¹‰é€šç”¨ Service æ–¹æ³•çš„å¯èƒ½ï¼Œè¯·åˆ›å»ºè‡ªå·±çš„ IBaseService ç»§æ‰¿ Mybatis-Plus æä¾›çš„åŸºç±»\nå¯¹è±¡ Wrapper ä¸º æ¡ä»¶æ„é€ å™¨\n\nMyBatis-Plusä¸­æœ‰ä¸€ä¸ªæ¥å£ **IService**å’Œå…¶å®ç°ç±» **ServiceImpl**ï¼Œå°è£…äº†å¸¸è§çš„ä¸šåŠ¡å±‚é€»è¾‘ï¼Œè¯¦æƒ…æŸ¥çœ‹æºç IServiceå’ŒServiceImpl\nå› æ­¤æˆ‘ä»¬åœ¨ä½¿ç”¨çš„æ—¶å€™ä»…éœ€åœ¨è‡ªå·±å®šä¹‰çš„**Serviceæ¥å£ä¸­ç»§æ‰¿IServiceæ¥å£ï¼Œåœ¨è‡ªå·±çš„å®ç°ç±»ä¸­å®ç°è‡ªå·±çš„Serviceå¹¶ç»§æ‰¿ServiceImpl**å³å¯\n\n\n\n\n\n\n\n\n\n\nIServiceä¸­çš„CRUDæ–¹æ³•\n\nå¢åŠ ï¼šSaveã€SaveOrUpdate\n// æ’å…¥ä¸€æ¡è®°å½•ï¼ˆé€‰æ‹©å­—æ®µï¼Œç­–ç•¥æ’å…¥ï¼‰\nboolean save(T entity);\n// æ’å…¥ï¼ˆæ‰¹é‡ï¼‰\nboolean saveBatch(Collection&lt;T> entityList);\n// æ’å…¥ï¼ˆæ‰¹é‡ï¼‰\nboolean saveBatch(Collection&lt;T> entityList, int batchSize);\n\n// TableId æ³¨è§£å­˜åœ¨æ›´æ–°è®°å½•ï¼Œå¦æ’å…¥ä¸€æ¡è®°å½•\nboolean saveOrUpdate(T entity);\n// æ ¹æ®updateWrapperå°è¯•æ›´æ–°ï¼Œå¦ç»§ç»­æ‰§è¡ŒsaveOrUpdate(T)æ–¹æ³•\nboolean saveOrUpdate(T entity, Wrapper&lt;T> updateWrapper);\n// æ‰¹é‡ä¿®æ”¹æ’å…¥\nboolean saveOrUpdateBatch(Collection&lt;T> entityList);\n// æ‰¹é‡ä¿®æ”¹æ’å…¥\nboolean saveOrUpdateBatch(Collection&lt;T> entityList, int batchSize);\n\nåˆ é™¤ï¼šRemove\n// æ ¹æ® entity æ¡ä»¶ï¼Œåˆ é™¤è®°å½•\nboolean remove(Wrapper&lt;T> queryWrapper);\n// æ ¹æ® ID åˆ é™¤\nboolean removeById(Serializable id);\n// æ ¹æ® columnMap æ¡ä»¶ï¼Œåˆ é™¤è®°å½•\nboolean removeByMap(Map&lt;String, Object> columnMap);\n// åˆ é™¤ï¼ˆæ ¹æ®ID æ‰¹é‡åˆ é™¤ï¼‰\nboolean removeByIds(Collection&lt;? extends Serializable> idList);\n\nä¿®æ”¹ï¼šUpdate\n// æ ¹æ® UpdateWrapper æ¡ä»¶ï¼Œæ›´æ–°è®°å½• éœ€è¦è®¾ç½®sqlset\nboolean update(Wrapper&lt;T> updateWrapper);\n// æ ¹æ® whereWrapper æ¡ä»¶ï¼Œæ›´æ–°è®°å½•\nboolean update(T updateEntity, Wrapper&lt;T> whereWrapper);\n// æ ¹æ® ID é€‰æ‹©ä¿®æ”¹\nboolean updateById(T entity);\n// æ ¹æ®ID æ‰¹é‡æ›´æ–°\nboolean updateBatchById(Collection&lt;T> entityList);\n// æ ¹æ®ID æ‰¹é‡æ›´æ–°\nboolean updateBatchById(Collection&lt;T> entityList, int batchSize);\n\næŸ¥è¯¢ï¼šGetã€Listã€Count\n// æ ¹æ® ID æŸ¥è¯¢\nT getById(Serializable id);\n// æ ¹æ® Wrapperï¼ŒæŸ¥è¯¢ä¸€æ¡è®°å½•ã€‚ç»“æœé›†ï¼Œå¦‚æœæ˜¯å¤šä¸ªä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œéšæœºå–ä¸€æ¡åŠ ä¸Šé™åˆ¶æ¡ä»¶ wrapper.last(\"LIMIT 1\")\nT getOne(Wrapper&lt;T> queryWrapper);\n// æ ¹æ® Wrapperï¼ŒæŸ¥è¯¢ä¸€æ¡è®°å½•\nT getOne(Wrapper&lt;T> queryWrapper, boolean throwEx);\n// æ ¹æ® Wrapperï¼ŒæŸ¥è¯¢ä¸€æ¡è®°å½•\nMap&lt;String, Object> getMap(Wrapper&lt;T> queryWrapper);\n// æ ¹æ® Wrapperï¼ŒæŸ¥è¯¢ä¸€æ¡è®°å½•\n&lt;V> V getObj(Wrapper&lt;T> queryWrapper, Function&lt;? super Object, V> mapper);\n\n\n// æŸ¥è¯¢æ‰€æœ‰\nList&lt;T> list();\n// æŸ¥è¯¢åˆ—è¡¨\nList&lt;T> list(Wrapper&lt;T> queryWrapper);\n// æŸ¥è¯¢ï¼ˆæ ¹æ®ID æ‰¹é‡æŸ¥è¯¢ï¼‰\nCollection&lt;T> listByIds(Collection&lt;? extends Serializable> idList);\n// æŸ¥è¯¢ï¼ˆæ ¹æ® columnMap æ¡ä»¶ï¼‰\nCollection&lt;T> listByMap(Map&lt;String, Object> columnMap);\n// æŸ¥è¯¢æ‰€æœ‰åˆ—è¡¨\nList&lt;Map&lt;String, Object>> listMaps();\n// æŸ¥è¯¢åˆ—è¡¨\nList&lt;Map&lt;String, Object>> listMaps(Wrapper&lt;T> queryWrapper);\n// æŸ¥è¯¢å…¨éƒ¨è®°å½•\nList&lt;Object> listObjs();\n// æŸ¥è¯¢å…¨éƒ¨è®°å½•\n&lt;V> List&lt;V> listObjs(Function&lt;? super Object, V> mapper);\n// æ ¹æ® Wrapper æ¡ä»¶ï¼ŒæŸ¥è¯¢å…¨éƒ¨è®°å½•\nList&lt;Object> listObjs(Wrapper&lt;T> queryWrapper);\n// æ ¹æ® Wrapper æ¡ä»¶ï¼ŒæŸ¥è¯¢å…¨éƒ¨è®°å½•\n&lt;V> List&lt;V> listObjs(Wrapper&lt;T> queryWrapper, Function&lt;? super Object, V> mapper);\n\n// æŸ¥è¯¢æ€»è®°å½•æ•°\nint count();\n// æ ¹æ® Wrapper æ¡ä»¶ï¼ŒæŸ¥è¯¢æ€»è®°å½•æ•°\nint count(Wrapper&lt;T> queryWrapper);\n\nåˆ†é¡µï¼šPage\n// æ ¹æ® ID æŸ¥è¯¢\nT getById(Serializable id);\n// æ ¹æ® Wrapperï¼ŒæŸ¥è¯¢ä¸€æ¡è®°å½•ã€‚ç»“æœé›†ï¼Œå¦‚æœæ˜¯å¤šä¸ªä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œéšæœºå–ä¸€æ¡åŠ ä¸Šé™åˆ¶æ¡ä»¶ wrapper.last(\"LIMIT 1\")\nT getOne(Wrapper&lt;T> queryWrapper);\n// æ ¹æ® Wrapperï¼ŒæŸ¥è¯¢ä¸€æ¡è®°å½•\nT getOne(Wrapper&lt;T> queryWrapper, boolean throwEx);\n// æ ¹æ® Wrapperï¼ŒæŸ¥è¯¢ä¸€æ¡è®°å½•\nMap&lt;String, Object> getMap(Wrapper&lt;T> queryWrapper);\n// æ ¹æ® Wrapperï¼ŒæŸ¥è¯¢ä¸€æ¡è®°å½•\n&lt;V> V getObj(Wrapper&lt;T> queryWrapper, Function&lt;? super Object, V> mapper);\n\n4.è°ƒç”¨Serviceå±‚æ“ä½œæ•°æ®\n\n\n\n\n\n\n\n\næˆ‘ä»¬åœ¨è‡ªå·±çš„Serviceæ¥å£ä¸­é€šè¿‡ç»§æ‰¿MyBatis-Plusæä¾›çš„IServiceæ¥å£ï¼Œä¸ä»…å¯ä»¥è·å¾—å…¶æä¾›çš„CRUDæ–¹æ³•ï¼Œè€Œä¸”è¿˜å¯ä»¥ä½¿ç”¨è‡ªèº«å®šä¹‰çš„æ–¹æ³•ã€‚\n\nåˆ›å»ºUserServiceå¹¶ç»§æ‰¿IService\n/**\n  * UserServiceç»§æ‰¿IServiceæ¨¡æ¿æä¾›çš„åŸºç¡€åŠŸèƒ½ \n  */\npublic interface UserService extends IService&lt;User> &#123;&#125;\n\nåˆ›å»ºUserServiceçš„å®ç°ç±»å¹¶ç»§æ‰¿ServiceImpl\n/**\n  * ServiceImplå®ç°äº†IServiceï¼Œæä¾›äº†IServiceä¸­åŸºç¡€åŠŸèƒ½çš„å®ç° \n  * è‹¥ServiceImplæ— æ³•æ»¡è¶³ä¸šåŠ¡éœ€æ±‚ï¼Œåˆ™å¯ä»¥ä½¿ç”¨è‡ªå®šçš„UserServiceå®šä¹‰æ–¹æ³•ï¼Œå¹¶åœ¨å®ç°ç±»ä¸­å®ç°\n  */\n@Service\npublic class UserServiceImpl extends ServiceImpl&lt;UserMapper,User> implements UserService&#123;&#125;\n\næµ‹è¯•æŸ¥è¯¢è®°å½•æ•°\n\n\n\n\n\n\n\n\n\nè°ƒç”¨æ–¹æ³•ï¼šint count();\n@Test\npublic void testGetCount()&#123;\n    //æŸ¥è¯¢æ€»è®°å½•æ•°\n    //æ‰§è¡Œçš„SQLä¸ºï¼šSELECT COUNT( * ) FROM user\n    long count = userService.count();\n    System.out.println(\"æ€»è®°å½•æ•°ï¼š\" + count);\n&#125;\n\næµ‹è¯•æ‰¹é‡æ’å…¥æ•°æ®\n\n\n\n\n\n\n\n\n\nè°ƒç”¨æ–¹æ³•ï¼šboolean saveBatch(Collection entityList);\n@Test\npublic void test()&#123;\n    List&lt;User> list = new ArrayList&lt;>();\n    for (int i = 1; i &lt;= 10; i++) &#123;\n        User user = new User();\n        user.setName(\"Vz\"+i);\n        user.setAge(20+i);\n        list.add(user);\n    &#125;\n    boolean b = userService.saveBatch(list);\n    System.out.println(b ? \"æ·»åŠ æˆåŠŸï¼\" : \"æ·»åŠ å¤±è´¥ï¼\");\n&#125;\n\nå››ã€å¸¸ç”¨æ³¨è§£\n\n\n\n\n\n\n\n\nMyBatis-Plusæä¾›çš„æ³¨è§£å¯ä»¥å¸®æˆ‘ä»¬è§£å†³ä¸€äº›æ•°æ®åº“ä¸å®ä½“ä¹‹é—´ç›¸äº’æ˜ å°„çš„é—®é¢˜ã€‚\n1.@TableName\n\n\n\n\n\n\n\n\nç»è¿‡ä»¥ä¸Šçš„æµ‹è¯•ï¼Œåœ¨ä½¿ç”¨MyBatis-Pluså®ç°åŸºæœ¬çš„CRUDæ—¶ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰æŒ‡å®šè¦æ“ä½œçš„è¡¨ï¼Œåªæ˜¯åœ¨Mapperæ¥å£ç»§æ‰¿BaseMapperæ—¶ï¼Œè®¾ç½®äº†æ³›å‹Userï¼Œè€Œæ“ä½œçš„è¡¨ä¸ºuserè¡¨ï¼Œç”±æ­¤å¾—å‡ºç»“è®ºï¼ŒMyBatis-Plusåœ¨ç¡®å®šæ“ä½œçš„è¡¨æ—¶ï¼Œç”±BaseMapperçš„æ³›å‹å†³å®šï¼Œå³å®ä½“ç±»å‹å†³å®šï¼Œä¸”é»˜è®¤æ“ä½œçš„è¡¨åå’Œå®ä½“ç±»å‹çš„ç±»åä¸€è‡´ã€‚\n1.1\tå¼•å‡ºé—®é¢˜\n\n\n\n\n\n\n\n\n\nè‹¥å®ä½“ç±»ç±»å‹çš„ç±»åå’Œè¦æ“ä½œçš„è¡¨çš„è¡¨åä¸ä¸€è‡´ï¼Œä¼šå‡ºç°ä»€ä¹ˆé—®é¢˜ï¼Ÿ\n\næˆ‘ä»¬å°†è¡¨useræ›´åä¸ºt_userï¼Œæµ‹è¯•æŸ¥è¯¢åŠŸèƒ½\n\n\nç¨‹åºæŠ›å‡ºå¼‚å¸¸ï¼ŒTable â€˜mybatis_plus.userâ€™ doesnâ€™t existï¼Œå› ä¸ºç°åœ¨çš„è¡¨åä¸ºt_userï¼Œè€Œé»˜è®¤æ“ä½œçš„è¡¨åå’Œå®ä½“ç±»å‹çš„ç±»åä¸€è‡´ï¼Œå³userè¡¨\n\n\n\n1.2\tè§£å†³é—®é¢˜\naã€ä½¿ç”¨æ³¨è§£è§£å†³é—®é¢˜\n\n\n\n\n\n\n\n\nåœ¨å®ä½“ç±»ç±»å‹ä¸Šæ·»åŠ @TableName(&quot;t_user&quot;)ï¼Œæ ‡è¯†å®ä½“ç±»å¯¹åº”çš„è¡¨ï¼Œå³å¯æˆåŠŸæ‰§è¡ŒSQLè¯­å¥\n@Data\n@TableName(\"t_user\")\npublic class User &#123;\n    private Long id;\n    private String name;\n    private Integer age;\n    private String email;\n&#125;\n\n\n\nbã€ä½¿ç”¨å…¨å±€é…ç½®è§£å†³é—®é¢˜\n\n\n\n\n\n\n\n\nåœ¨å¼€å‘çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸é‡åˆ°ä»¥ä¸Šçš„é—®é¢˜ï¼Œå³å®ä½“ç±»æ‰€å¯¹åº”çš„è¡¨éƒ½æœ‰å›ºå®šçš„å‰ç¼€ï¼Œä¾‹å¦‚ t_ æˆ– tbl_ æ­¤æ—¶ï¼Œå¯ä»¥ä½¿ç”¨MyBatis-Plusæä¾›çš„å…¨å±€é…ç½®ï¼Œä¸ºå®ä½“ç±»æ‰€å¯¹åº”çš„è¡¨åè®¾ç½®é»˜è®¤çš„å‰ç¼€ï¼Œé‚£ä¹ˆå°±ä¸éœ€è¦åœ¨æ¯ä¸ªå®ä½“ç±»ä¸Šé€šè¿‡@TableNameæ ‡è¯†å®ä½“ç±»å¯¹åº”çš„è¡¨\nmybatis-plus:\n  global-config:\n    db-config:\n      # è®¾ç½®å®ä½“ç±»æ‰€å¯¹åº”çš„è¡¨çš„ç»Ÿä¸€å‰ç¼€\n      table-prefix: t_\n\n\n\n\n\n2.@TableId\n\n\n\n\n\n\n\n\nç»è¿‡ä»¥ä¸Šçš„æµ‹è¯•ï¼ŒMyBatis-Plusåœ¨å®ç°CRUDæ—¶ï¼Œä¼šé»˜è®¤å°†idä½œä¸ºä¸»é”®åˆ—ï¼Œå¹¶åœ¨æ’å…¥æ•°æ®æ—¶ï¼Œé»˜è®¤åŸºäºé›ªèŠ±ç®—æ³•çš„ç­–ç•¥ç”Ÿæˆid\n2.1\tå¼•å‡ºé—®é¢˜\n\n\n\n\n\n\n\n\n\nè‹¥å®ä½“ç±»å’Œè¡¨ä¸­è¡¨ç¤ºä¸»é”®çš„ä¸æ˜¯idï¼Œè€Œæ˜¯å…¶ä»–å­—æ®µï¼Œä¾‹å¦‚uidï¼ŒMyBatis-Plusä¼šè‡ªåŠ¨è¯†åˆ«uidä¸ºä¸»é”®åˆ—å—ï¼Ÿ\n\næˆ‘ä»¬å®ä½“ç±»ä¸­çš„å±æ€§idæ”¹ä¸ºuidï¼Œå°†è¡¨ä¸­çš„å­—æ®µidä¹Ÿæ”¹ä¸ºuidï¼Œæµ‹è¯•æ·»åŠ åŠŸèƒ½\n\n\n\nç¨‹åºæŠ›å‡ºå¼‚å¸¸ï¼ŒField â€˜uidâ€™ doesnâ€™t have a default valueï¼Œè¯´æ˜MyBatis-Plusæ²¡æœ‰å°†uidä½œä¸ºä¸»é”®èµ‹å€¼\n\n\n\n2.2\tè§£å†³é—®é¢˜\n\n\n\n\n\n\n\n\n\nåœ¨å®ä½“ç±»ä¸­uidå±æ€§ä¸Šé€šè¿‡@TableIdå°†å…¶æ ‡è¯†ä¸ºä¸»é”®ï¼Œå³å¯æˆåŠŸæ‰§è¡ŒSQLè¯­å¥\n@Date\npublic class User &#123;\n    @TableId\n    private Long uid;\n    private String name;\n    private Integer age;\n    private String email;\n&#125;\n\n\n\n2.3\t@TableIdçš„valueå±æ€§\n\n\n\n\n\n\n\n\n\nè‹¥å®ä½“ç±»ä¸­ä¸»é”®å¯¹åº”çš„å±æ€§ä¸ºidï¼Œè€Œè¡¨ä¸­è¡¨ç¤ºä¸»é”®çš„å­—æ®µä¸ºuidï¼Œæ­¤æ—¶è‹¥åªåœ¨å±æ€§idä¸Šæ·»åŠ æ³¨è§£@TableIdï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸**Unknown column â€˜idâ€™ in â€˜field listâ€™**ï¼Œå³MyBatis-Plusä»ç„¶ä¼šå°†idä½œä¸ºè¡¨çš„ä¸»é”®æ“ä½œï¼Œè€Œè¡¨ä¸­è¡¨ç¤ºä¸»é”®çš„æ˜¯å­—æ®µuidæ­¤æ—¶éœ€è¦é€šè¿‡@TableIdæ³¨è§£çš„valueå±æ€§ï¼ŒæŒ‡å®šè¡¨ä¸­çš„ä¸»é”®å­—æ®µï¼Œ@TableId(&quot;uid&quot;)æˆ–@TableId(value=&quot;uid&quot;)\n\n2.4\t@TableIdçš„typeå±æ€§\n\n\n\n\n\n\n\n\n\ntypeå±æ€§ç”¨æ¥å®šä¹‰ä¸»é”®ç­–ç•¥ï¼šé»˜è®¤é›ªèŠ±ç®—æ³•\nå¸¸ç”¨çš„ä¸»é”®ç­–ç•¥ï¼š\n\n\n\nå€¼\næè¿°\n\n\n\nIdType.ASSIGN_IDï¼ˆé»˜è®¤ï¼‰\nåŸºäºé›ªèŠ±ç®—æ³•çš„ç­–ç•¥ç”Ÿæˆæ•°æ®idï¼Œä¸æ•°æ®åº“idæ˜¯å¦è®¾ç½®è‡ªå¢æ— å…³\n\n\nIdType.AUTO\nä½¿ç”¨æ•°æ®åº“çš„è‡ªå¢ç­–ç•¥ï¼Œæ³¨æ„ï¼Œè¯¥ç±»å‹è¯·ç¡®ä¿æ•°æ®åº“è®¾ç½®äº†idè‡ªå¢ï¼Œ\n\n\né…ç½®å…¨å±€ä¸»é”®ç­–ç•¥ï¼š\n#MyBatis-Plusç›¸å…³é…ç½®\nmybatis-plus:\n  configuration:\n    #é…ç½®æ—¥å¿—\n    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl\n  global-config:\n    db-config:\n      #é…ç½®mpçš„ä¸»é”®ç­–ç•¥ä¸ºè‡ªå¢\n      id-type: auto\n      # è®¾ç½®å®ä½“ç±»æ‰€å¯¹åº”çš„è¡¨çš„ç»Ÿä¸€å‰ç¼€\n      table-prefix: t_\n\n\n\n3.@TbaleField\n\n\n\n\n\n\n\n\nç»è¿‡ä»¥ä¸Šçš„æµ‹è¯•ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼ŒMyBatis-Plusåœ¨æ‰§è¡ŒSQLè¯­å¥æ—¶ï¼Œè¦ä¿è¯å®ä½“ç±»ä¸­çš„å±æ€§åå’Œè¡¨ä¸­çš„å­—æ®µåä¸€è‡´\nå¦‚æœå®ä½“ç±»ä¸­çš„å±æ€§åå’Œå­—æ®µåä¸ä¸€è‡´çš„æƒ…å†µï¼Œä¼šå‡ºç°ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿ\n3.1\tæƒ…å†µä¸€\nè‹¥å®ä½“ç±»ä¸­çš„å±æ€§ä½¿ç”¨çš„æ˜¯é©¼å³°å‘½åé£æ ¼ï¼Œè€Œè¡¨ä¸­çš„å­—æ®µä½¿ç”¨çš„æ˜¯ä¸‹åˆ’çº¿å‘½åé£æ ¼\nä¾‹å¦‚å®ä½“ç±»å±æ€§userNameï¼Œè¡¨ä¸­å­—æ®µuser_name\næ­¤æ—¶MyBatis-Plusä¼šè‡ªåŠ¨å°†ä¸‹åˆ’çº¿å‘½åé£æ ¼è½¬åŒ–ä¸ºé©¼å³°å‘½åé£æ ¼\nç›¸å½“äºåœ¨MyBatisä¸­é…ç½®\n3.2\tæƒ…å†µäºŒ\n\n\n\n\n\n\n\n\n\nè‹¥å®ä½“ç±»ä¸­çš„å±æ€§å’Œè¡¨ä¸­çš„å­—æ®µä¸æ»¡è¶³æƒ…å†µ1\nä¾‹å¦‚å®ä½“ç±»å±æ€§nameï¼Œè¡¨ä¸­å­—æ®µusername\næ­¤æ—¶éœ€è¦åœ¨å®ä½“ç±»å±æ€§ä¸Šä½¿ç”¨@TableField(&quot;username&quot;)è®¾ç½®å±æ€§æ‰€å¯¹åº”çš„å­—æ®µå\npublic class User &#123;\n    @TableId(\"uid\")\n    private Long id;\n    @TableField(\"username\")\n    private String name;\n    private Integer age;\n    private String email;\n&#125;\n\n\n\n4.@TableLogic4.1\té€»è¾‘åˆ é™¤\n\n\n\n\n\n\n\n\n\nç‰©ç†åˆ é™¤ï¼šçœŸå®åˆ é™¤ï¼Œå°†å¯¹åº”æ•°æ®ä»æ•°æ®åº“ä¸­åˆ é™¤ï¼Œä¹‹åæŸ¥è¯¢ä¸åˆ°æ­¤æ¡è¢«åˆ é™¤çš„æ•°æ®\né€»è¾‘åˆ é™¤ï¼šå‡åˆ é™¤ï¼Œå°†å¯¹åº”æ•°æ®ä¸­ä»£è¡¨æ˜¯å¦è¢«åˆ é™¤å­—æ®µçš„çŠ¶æ€ä¿®æ”¹ä¸ºâ€œè¢«åˆ é™¤çŠ¶æ€â€ï¼Œä¹‹ååœ¨æ•°æ®åº“ä¸­ä»æ—§èƒ½çœ‹åˆ°æ­¤æ¡æ•°æ®è®°å½•\nä½¿ç”¨åœºæ™¯ï¼šå¯ä»¥è¿›è¡Œæ•°æ®æ¢å¤\n4.2\tå®ç°é€»è¾‘åˆ é™¤\n\næ•°æ®åº“ä¸­åˆ›å»ºé€»è¾‘åˆ é™¤çŠ¶æ€åˆ—ï¼Œè®¾ç½®é»˜è®¤å€¼ä¸º0\n\n\nå®ä½“ç±»ä¸­æ·»åŠ é€»è¾‘åˆ é™¤å±æ€§\n\n\næµ‹è¯•åˆ é™¤åŠŸèƒ½ï¼ŒçœŸæ­£æ‰§è¡Œçš„æ˜¯ä¿®æ”¹\npublic void testDeleteById()&#123;\n    int result = userMapper.deleteById(1527472864163348482L);\n    System.out.println(result > 0 ? \"åˆ é™¤æˆåŠŸï¼\" : \"åˆ é™¤å¤±è´¥ï¼\");\n    System.out.println(\"å—å½±å“çš„è¡Œæ•°ä¸ºï¼š\" + result);\n&#125;\n\n\n\næ­¤æ—¶æ‰§è¡ŒæŸ¥è¯¢æ–¹æ³•ï¼ŒæŸ¥è¯¢çš„ç»“æœä¸ºè‡ªåŠ¨æ·»åŠ æ¡ä»¶is_deleted=0\n\n\n\näº”ã€æ¡ä»¶æ„é€ å™¨1.Wrapperä»‹ç»\n\nWrapper ï¼š æ¡ä»¶æ„é€ æŠ½è±¡ç±»ï¼Œæœ€é¡¶ç«¯çˆ¶ç±»\n\nAbstractWrapper ï¼š ç”¨äºæŸ¥è¯¢æ¡ä»¶å°è£…ï¼Œç”Ÿæˆ sql çš„ where æ¡ä»¶\n\nQueryWrapper ï¼š æŸ¥è¯¢æ¡ä»¶å°è£…\n\nUpdateWrapper ï¼š Update æ¡ä»¶å°è£…\n\nAbstractLambdaWrapper ï¼š ä½¿ç”¨Lambda è¯­æ³•\n\nLambdaQueryWrapper ï¼šç”¨äºLambdaè¯­æ³•ä½¿ç”¨çš„æŸ¥è¯¢Wrapper\n\nLambdaUpdateWrapper ï¼š Lambda æ›´æ–°å°è£…Wrapper\n\n\n\n\n\n\n\n\n2.QueryWrapper\nç»„è£…æŸ¥è¯¢æ¡ä»¶\n\n\n\n\n\n\n\n\n\næ‰§è¡ŒSQLï¼šSELECT uid AS id,username AS name,age,email,is_deleted FROM t_user WHERE is_deleted&#x3D;0 AND (username LIKE ? AND age BETWEEN ? AND ? AND email IS NOT NULL)\npublic void test01()&#123;\n    //æŸ¥è¯¢ç”¨æˆ·ååŒ…å«aï¼Œå¹´é¾„åœ¨20åˆ°30ä¹‹é—´ï¼Œé‚®ç®±ä¿¡æ¯ä¸ä¸ºnullçš„ç”¨æˆ·ä¿¡æ¯\n    QueryWrapper&lt;User> queryWrapper = new QueryWrapper&lt;>();\n    queryWrapper.like(\"username\",\"a\").between(\"age\",20,30).isNotNull(\"email\");\n    List&lt;User> users = userMapper.selectList(queryWrapper);\n    users.forEach(System.out::println);\n&#125;\n\nç»„è£…æ’åºæ¡ä»¶\n\n\n\n\n\n\n\n\n\næ‰§è¡ŒSQLï¼šSELECT uid AS id,username AS name,age,email,is_deleted FROM t_user WHERE is_deleted&#x3D;0 ORDER BY age DESC,id ASC\npublic void test02()&#123;\n    //æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼ŒæŒ‰ç…§å¹´é¾„çš„é™åºæ’åºï¼Œè‹¥å¹´é¾„ç›¸åŒï¼Œåˆ™æŒ‰ç…§idå‡åºæ’åº\n    QueryWrapper&lt;User> queryWrapper = new QueryWrapper&lt;>();\n    queryWrapper.orderByDesc(\"age\").orderByAsc(\"id\");\n    List&lt;User> users = userMapper.selectList(queryWrapper);\n    users.forEach(System.out::println);\n&#125;\n\nç»„è£…åˆ é™¤æ¡ä»¶\n\n\n\n\n\n\n\n\n\næ‰§è¡ŒSQLï¼šUPDATE t_user SET is_deleted&#x3D;1 WHERE is_deleted&#x3D;0 AND (email IS NULL)\npublic void test03()&#123;\n    //åˆ é™¤é‚®ç®±åœ°å€ä¸ºnullçš„ç”¨æˆ·ä¿¡æ¯\n    QueryWrapper&lt;User> queryWrapper = new QueryWrapper&lt;>();\n    queryWrapper.isNull(\"email\");\n    int result = userMapper.delete(queryWrapper);\n    System.out.println(result > 0 ? \"åˆ é™¤æˆåŠŸï¼\" : \"åˆ é™¤å¤±è´¥ï¼\");\n    System.out.println(\"å—å½±å“çš„è¡Œæ•°ä¸ºï¼š\" + result);\n&#125;\n\næ¡ä»¶çš„ä¼˜å…ˆçº§\n\n\n\n\n\n\n\n\n\næ‰§è¡ŒSQLï¼šUPDATE t_user SET user_name&#x3D;?, email&#x3D;? WHERE is_deleted&#x3D;0 AND (age &gt; ? AND user_name LIKE ? OR email IS NULL)\npublic void test04()&#123;\n    //å°†ï¼ˆå¹´é¾„å¤§äº20å¹¶ä¸”ç”¨æˆ·åä¸­åŒ…å«æœ‰aï¼‰æˆ–é‚®ç®±ä¸ºnullçš„ç”¨æˆ·ä¿¡æ¯ä¿®æ”¹\n    UpdateWrapper&lt;User> updateWrapper = new UpdateWrapper&lt;>();\n    updateWrapper.gt(\"age\",20).like(\"username\",\"a\").or().isNull(\"email\");\n    User user = new User();\n    user.setName(\"Oz\");\n    user.setEmail(\"test@oz6.com\");\n\n    int result = userMapper.update(user, updateWrapper);\n    System.out.println(result > 0 ? \"ä¿®æ”¹æˆåŠŸï¼\" : \"ä¿®æ”¹å¤±è´¥ï¼\");\n    System.out.println(\"å—å½±å“çš„è¡Œæ•°ä¸ºï¼š\" + result);\n&#125;\n\n\n\n\n\n\n\n\n\n\næ‰§è¡ŒSQLï¼šUPDATE t_user SET username&#x3D;?, email&#x3D;? WHERE is_deleted&#x3D;0 AND (username LIKE ? AND (age &gt; ? OR email IS NULL))\npublic void test05()&#123;\n    //å°†ç”¨æˆ·åä¸­åŒ…å«æœ‰aå¹¶ä¸”ï¼ˆå¹´é¾„å¤§äº20æˆ–é‚®ç®±ä¸ºnullï¼‰çš„ç”¨æˆ·ä¿¡æ¯ä¿®æ”¹\n    UpdateWrapper&lt;User> updateWrapper = new UpdateWrapper&lt;>();\n    updateWrapper.like(\"username\",\"a\").and(i->i.gt(\"age\",20).or().isNull(\"email\"));\n    User user = new User();\n    user.setName(\"Vz7797\");\n    user.setEmail(\"test@ss8o.com\");\n\n    int result = userMapper.update(user, updateWrapper);\n    System.out.println(result > 0 ? \"ä¿®æ”¹æˆåŠŸï¼\" : \"ä¿®æ”¹å¤±è´¥ï¼\");\n    System.out.println(\"å—å½±å“çš„è¡Œæ•°ä¸ºï¼š\" + result);\n&#125;\n\nç»„è£…selectå­å¥\n\n\n\n\n\n\n\n\n\næ‰§è¡ŒSQLï¼šSELECT username,age,email FROM t_user WHERE is_deleted&#x3D;0\npublic void test06()&#123;\n    //æŸ¥è¯¢ç”¨æˆ·çš„ç”¨æˆ·åã€å¹´é¾„ã€é‚®ç®±ä¿¡æ¯\n    QueryWrapper&lt;User> queryWrapper = new QueryWrapper&lt;>();\n    queryWrapper.select(\"username\",\"age\",\"email\");\n    List&lt;Map&lt;String, Object>> maps = userMapper.selectMaps(queryWrapper);\n    maps.forEach(System.out::println);\n&#125;\n\nå®ç°å­æŸ¥è¯¢\n\n\n\n\n\n\n\n\n\næ‰§è¡ŒSQLï¼šSELECT uid AS id,user_name AS name,age,email,is_deleted FROM t_user WHERE is_deleted&#x3D;0 AND (uid IN (select uid from t_user where uid &lt;&#x3D; 100))\npublic void test07()&#123;\n    //æŸ¥è¯¢idå°äºç­‰äº100çš„ç”¨æˆ·ä¿¡æ¯\n    QueryWrapper&lt;User> queryWrapper = new QueryWrapper&lt;>();\n    queryWrapper.inSql(\"uid\", \"select uid from t_user where uid &lt;= 100\");\n    List&lt;User> list = userMapper.selectList(queryWrapper);\n    list.forEach(System.out::println);\n&#125;\n\n3.UpdateWrapper\n\n\n\n\n\n\n\n\nUpdateWrapperä¸ä»…æ‹¥æœ‰QueryWrapperçš„ç»„è£…æ¡ä»¶åŠŸèƒ½ï¼Œè¿˜æä¾›äº†setæ–¹æ³•è¿›è¡Œä¿®æ”¹å¯¹åº”æ¡ä»¶çš„æ•°æ®åº“ä¿¡æ¯\npublic void test08()&#123;\n    //å°†ç”¨æˆ·åä¸­åŒ…å«æœ‰aå¹¶ä¸”ï¼ˆå¹´é¾„å¤§äº20æˆ–é‚®ç®±ä¸ºnullï¼‰çš„ç”¨æˆ·ä¿¡æ¯ä¿®æ”¹\n    UpdateWrapper&lt;User> updateWrapper = new UpdateWrapper&lt;>();\n    updateWrapper.like(\"username\",\"a\").and( i -> i.gt(\"age\",20).or().isNull(\"email\")).set(\"email\",\"svip@qq.com\");\n    int result = userMapper.update(null, updateWrapper);\n    System.out.println(result > 0 ? \"ä¿®æ”¹æˆåŠŸï¼\" : \"ä¿®æ”¹å¤±è´¥ï¼\");\n    System.out.println(\"å—å½±å“çš„è¡Œæ•°ä¸ºï¼š\" + result);\n&#125;\n\n\n\n4.condition\n\n\n\n\n\n\n\n\nåœ¨çœŸæ­£å¼€å‘çš„è¿‡ç¨‹ä¸­ï¼Œç»„è£…æ¡ä»¶æ˜¯å¸¸è§çš„åŠŸèƒ½ï¼Œè€Œè¿™äº›æ¡ä»¶æ•°æ®æ¥æºäºç”¨æˆ·è¾“å…¥ï¼Œæ˜¯å¯é€‰çš„ï¼Œå› æ­¤æˆ‘ä»¬åœ¨ç»„è£…è¿™äº›æ¡ä»¶æ—¶ï¼Œå¿…é¡»å…ˆåˆ¤æ–­ç”¨æˆ·æ˜¯å¦é€‰æ‹©äº†è¿™äº›æ¡ä»¶ï¼Œè‹¥é€‰æ‹©åˆ™éœ€è¦ç»„è£…è¯¥æ¡ä»¶ï¼Œè‹¥æ²¡æœ‰é€‰æ‹©åˆ™ä¸€å®šä¸èƒ½ç»„è£…ï¼Œä»¥å…å½±å“SQLæ‰§è¡Œçš„ç»“æœ\n\næ€è·¯ä¸€\n\n\n\n\n\n\n\n\n\næ‰§è¡ŒSQLï¼šSELECT uid AS id,user_name AS name,age,email,is_deleted FROM t_user WHERE is_deleted&#x3D;0 AND (user_name LIKE ? AND age &lt;&#x3D; ?)\npublic void test09()&#123;\n    String username = \"a\";\n    Integer ageBegin = null;\n    Integer ageEnd = 30;\n    QueryWrapper&lt;User> queryWrapper = new QueryWrapper&lt;>();\n    if(StringUtils.isNotBlank(username))&#123;\n        //isNotBlankåˆ¤æ–­æŸä¸ªå­—ç¬¦åˆ›æ˜¯å¦ä¸ä¸ºç©ºå­—ç¬¦ä¸²ã€ä¸ä¸ºnullã€ä¸ä¸ºç©ºç™½ç¬¦\n        queryWrapper.like(\"user_name\", username);\n    &#125;\n    if(ageBegin != null)&#123;\n        queryWrapper.ge(\"age\", ageBegin);\n    &#125;\n    if(ageEnd != null)&#123;\n        queryWrapper.le(\"age\", ageEnd);\n    &#125;\n    List&lt;User> list = userMapper.selectList(queryWrapper);\n    list.forEach(System.out::println);\n&#125;\n\næ€è·¯äºŒ\n\n\n\n\n\n\n\n\n\nä¸Šé¢çš„å®ç°æ–¹æ¡ˆæ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯ä»£ç æ¯”è¾ƒå¤æ‚ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¸¦conditionå‚æ•°çš„é‡è½½æ–¹æ³•æ„å»ºæŸ¥è¯¢æ¡ä»¶ï¼Œç®€åŒ–ä»£ç çš„ç¼–å†™\npublic void test10()&#123;\n    String username = \"a\";\n    Integer ageBegin = null;\n    Integer ageEnd = 30;\n    QueryWrapper&lt;User> queryWrapper = new QueryWrapper&lt;>();\n    queryWrapper.like(StringUtils.isNotBlank(username), \"user_name\", username)\n        .ge(ageBegin != null, \"age\", ageBegin)\n        .le(ageEnd != null, \"age\", ageEnd);\n    List&lt;User> list = userMapper.selectList(queryWrapper);\n    list.forEach(System.out::println);\n&#125;\n\n5.LambdaQueryWrapper\n\n\n\n\n\n\n\n\nåŠŸèƒ½ç­‰åŒäºQueryWrapperï¼Œæä¾›äº†Lambdaè¡¨è¾¾å¼çš„è¯­æ³•å¯ä»¥é¿å…å¡«é”™åˆ—åã€‚\npublic void test11()&#123;\n    String username = \"a\";\n    Integer ageBegin = null;\n    Integer ageEnd = 30;\n    LambdaQueryWrapper&lt;User> queryWrapper = new LambdaQueryWrapper&lt;>();\n    queryWrapper.like(StringUtils.isNotBlank(username), User::getName, username)\n        .ge(ageBegin != null, User::getAge, ageBegin)\n        .le(ageEnd != null, User::getAge, ageEnd);\n    List&lt;User> list = userMapper.selectList(queryWrapper);\n    list.forEach(System.out::println);\n&#125;\n\n\n\n6.LambdaUpdateWrapper\n\n\n\n\n\n\n\n\nåŠŸèƒ½ç­‰åŒäºUpdateWrapperï¼Œæä¾›äº†Lambdaè¡¨è¾¾å¼çš„è¯­æ³•å¯ä»¥é¿å…å¡«é”™åˆ—åã€‚\npublic void test12()&#123;\n    //å°†ç”¨æˆ·åä¸­åŒ…å«æœ‰aå¹¶ä¸”ï¼ˆå¹´é¾„å¤§äº20æˆ–é‚®ç®±ä¸ºnullï¼‰çš„ç”¨æˆ·ä¿¡æ¯ä¿®æ”¹\n    LambdaUpdateWrapper&lt;User> updateWrapper = new LambdaUpdateWrapper&lt;>();\n    updateWrapper.like(User::getName, \"a\")\n        .and(i -> i.gt(User::getAge, 20).or().isNull(User::getEmail));\n    updateWrapper.set(User::getName, \"å°é»‘\").set(User::getEmail,\"abc@atguigu.com\");\n    int result = userMapper.update(null, updateWrapper);\n    System.out.println(\"resultï¼š\"+result);\n&#125;\n\n\n\nå…­ã€å¸¸ç”¨æ’ä»¶1.åˆ†é¡µæ’ä»¶\n\n\n\n\n\n\n\n\nMyBatis Plusè‡ªå¸¦åˆ†é¡µæ’ä»¶ï¼Œåªè¦ç®€å•çš„é…ç½®å³å¯å®ç°åˆ†é¡µåŠŸèƒ½\n\næ·»åŠ é…ç½®ç±»MyBatisPlusConfig\n@Configuration\n@MapperScan(\"com.atguigu.mybatisplus.mapper\")\npublic class MyBatisPlusConfig &#123;\n    @Bean\n    public MybatisPlusInterceptor mybatisPlusInterceptor()&#123;\n        MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();\n        //æ·»åŠ åˆ†é¡µæ’ä»¶\n        interceptor.addInnerInterceptor(new PaginationInnerInterceptor(DbType.MYSQL));\n        return interceptor;\n    &#125;\n&#125;\n\nç¼–å†™æµ‹è¯•æ–¹æ³•\n@Test\npublic void testPage()&#123;\n    //new Page()ä¸­çš„ä¸¤ä¸ªå‚æ•°åˆ†åˆ«æ˜¯å½“å‰é¡µç ï¼Œæ¯é¡µæ˜¾ç¤ºæ•°é‡\n    Page&lt;User> page = userMapper.selectPage(new Page&lt;>(1, 2), null);\n    List&lt;User> users = page.getRecords();\n    users.forEach(System.out::println);\n&#125;\n\n2.è‡ªå®šä¹‰åˆ†é¡µ\n\n\n\n\n\n\n\n\nä¸Šé¢è°ƒç”¨çš„æ˜¯MyBatis-Plusæä¾›çš„å¸¦æœ‰åˆ†é¡µçš„æ–¹æ³•ï¼Œé‚£ä¹ˆæˆ‘ä»¬è‡ªå·±å®šä¹‰çš„æ–¹æ³•å¦‚ä½•å®ç°åˆ†é¡µå‘¢ï¼Ÿ\n\nåœ¨UserMapperæ¥å£ä¸­å®šä¹‰ä¸€ä¸ªæ–¹æ³•\n/**\n  * æ ¹æ®å¹´é¾„æŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨ï¼Œåˆ†é¡µæ˜¾ç¤º \n  * @param page åˆ†é¡µå¯¹è±¡,xmlä¸­å¯ä»¥ä»é‡Œé¢è¿›è¡Œå–å€¼,ä¼ é€’å‚æ•° Page å³è‡ªåŠ¨åˆ†é¡µ,å¿…é¡»æ”¾åœ¨ç¬¬ä¸€ä½ \n  * @param age å¹´é¾„ \n  * @return \n  */\nPage&lt;User> selectPageVo(@Param(\"page\") Page&lt;User> page,@Param(\"age\") Integer age);\n\nåœ¨UserMapper.xmlä¸­ç¼–å†™SQLå®ç°è¯¥æ–¹æ³•\n&lt;select id=\"selectPageVo\" resultType=\"User\">\n    select id,username as name,age,email from t_user where age > #&#123;age&#125;\n&lt;/select>\n\nç¼–å†™æµ‹è¯•æ–¹æ³•\n@Test\npublic void testPageVo()&#123;\n    Page&lt;User> page = userMapper.selectPageVo(new Page&lt;User>(1,2), 20);\n    List&lt;User> users = page.getRecords();\n    users.forEach(System.out::println);\n&#125;\n\n3.ä¹è§‚é”\n\n\n\n\n\n\n\n\nä½œç”¨ï¼šå½“è¦æ›´æ–°ä¸€æ¡è®°å½•çš„æ—¶å€™ï¼Œå¸Œæœ›è¿™æ¡è®°å½•æ²¡æœ‰è¢«åˆ«äººæ›´æ–°\nä¹è§‚é”çš„å®ç°æ–¹å¼ï¼š\n\nå–å‡ºè®°å½•æ—¶ï¼Œè·å–å½“å‰ version\næ›´æ–°æ—¶ï¼Œå¸¦ä¸Šè¿™ä¸ª version\næ‰§è¡Œæ›´æ–°æ—¶ï¼Œ set version &#x3D; newVersion where version &#x3D; oldVersion\nå¦‚æœ version ä¸å¯¹ï¼Œå°±æ›´æ–°å¤±è´¥\n\n3.1\tåœºæ™¯\n\nä¸€ä»¶å•†å“ï¼Œæˆæœ¬ä»·æ˜¯80å…ƒï¼Œå”®ä»·æ˜¯100å…ƒã€‚è€æ¿å…ˆæ˜¯é€šçŸ¥å°æï¼Œè¯´ä½ å»æŠŠå•†å“ä»·æ ¼å¢åŠ 50å…ƒã€‚å°ææ­£åœ¨ç©æ¸¸æˆï¼Œè€½æäº†ä¸€ä¸ªå°æ—¶ã€‚æ­£å¥½ä¸€ä¸ªå°æ—¶åï¼Œè€æ¿è§‰å¾—å•†å“ä»·æ ¼å¢åŠ åˆ°150å…ƒï¼Œä»·æ ¼å¤ªé«˜ï¼Œå¯èƒ½ä¼šå½±å“é”€é‡ã€‚åˆé€šçŸ¥å°ç‹ï¼Œä½ æŠŠå•†å“ä»·æ ¼é™ä½30å…ƒã€‚\næ­¤æ—¶ï¼Œå°æå’Œå°ç‹åŒæ—¶æ“ä½œå•†å“åå°ç³»ç»Ÿã€‚å°ææ“ä½œçš„æ—¶å€™ï¼Œç³»ç»Ÿå…ˆå–å‡ºå•†å“ä»·æ ¼100å…ƒï¼›å°ç‹ä¹Ÿåœ¨æ“ä½œï¼Œå–å‡ºçš„å•†å“ä»·æ ¼ä¹Ÿæ˜¯100å…ƒã€‚å°æå°†ä»·æ ¼åŠ äº†50å…ƒï¼Œå¹¶å°†100+50&#x3D;150å…ƒå­˜å…¥äº†æ•°æ®åº“ï¼›å°ç‹å°†å•†å“å‡äº†30å…ƒï¼Œå¹¶å°†100-30&#x3D;70å…ƒå­˜å…¥äº†æ•°æ®åº“ã€‚æ˜¯çš„ï¼Œå¦‚æœæ²¡æœ‰é”ï¼Œå°æçš„æ“ä½œå°±å®Œå…¨è¢«å°ç‹çš„è¦†ç›–äº†ã€‚\nç°åœ¨å•†å“ä»·æ ¼æ˜¯70å…ƒï¼Œæ¯”æˆæœ¬ä»·ä½10å…ƒã€‚å‡ åˆ†é’Ÿåï¼Œè¿™ä¸ªå•†å“å¾ˆå¿«å‡ºå”®äº†1åƒå¤šä»¶å•†å“ï¼Œè€æ¿äº1ä¸‡å¤šã€‚\n\n3.2\tä¹è§‚é”ä¸æ‚²è§‚é”\n\nä¸Šé¢çš„æ•…äº‹ï¼Œå¦‚æœæ˜¯ä¹è§‚é”ï¼Œå°ç‹ä¿å­˜ä»·æ ¼å‰ï¼Œä¼šæ£€æŸ¥ä¸‹ä»·æ ¼æ˜¯å¦è¢«äººä¿®æ”¹è¿‡äº†ã€‚å¦‚æœè¢«ä¿®æ”¹è¿‡äº†ï¼Œåˆ™é‡æ–°å–å‡ºçš„è¢«ä¿®æ”¹åçš„ä»·æ ¼ï¼Œ150å…ƒï¼Œè¿™æ ·ä»–ä¼šå°†120å…ƒå­˜å…¥æ•°æ®åº“ã€‚\nå¦‚æœæ˜¯æ‚²è§‚é”ï¼Œå°æå–å‡ºæ•°æ®åï¼Œå°ç‹åªèƒ½ç­‰å°ææ“ä½œå®Œä¹‹åï¼Œæ‰èƒ½å¯¹ä»·æ ¼è¿›è¡Œæ“ä½œï¼Œä¹Ÿä¼šä¿è¯æœ€ç»ˆçš„ä»·æ ¼æ˜¯120å…ƒã€‚\n\n3.3\tæ¨¡æ‹Ÿä¿®æ”¹å†²çª\n\næ•°æ®åº“ä¸­å¢åŠ å•†å“è¡¨\nCREATE TABLE t_product ( \n    id BIGINT(20) NOT NULL COMMENT 'ä¸»é”®ID', \n    NAME VARCHAR(30) NULL DEFAULT NULL COMMENT 'å•†å“åç§°', \n    price INT(11) DEFAULT 0 COMMENT 'ä»·æ ¼', \n    VERSION INT(11) DEFAULT 0 COMMENT 'ä¹è§‚é”ç‰ˆæœ¬å·', \n    PRIMARY KEY (id) \n);\n\næ·»åŠ ä¸€æ¡æ•°æ®\nINSERT INTO t_product (id, NAME, price) VALUES (1, 'å¤–æ˜Ÿäººç¬”è®°æœ¬', 100);\n\næ·»åŠ ä¸€ä¸ªå®ä½“ç±»Product\n@Data\npublic class Product &#123;\n    private Long id;\n    private String name;\n    private Integer price;\n    private Integer version;\n&#125;\n\næ·»åŠ ä¸€ä¸ªMapperæ¥å£ProductMapper\npublic interface ProductMapper extends BaseMapper&lt;Product> &#123;&#125;\n\næµ‹è¯•æ–¹æ³•\n@Test\npublic void testProduct01()&#123;\n    //1.å°æè·å–å•†å“ä»·æ ¼\n    Product productLi = productMapper.selectById(1);\n    System.out.println(\"å°æè·å–çš„å•†å“ä»·æ ¼ä¸ºï¼š\" + productLi.getPrice());\n\n    //2.å°ç‹è·å–å•†å“ä»·æ ¼\n    Product productWang = productMapper.selectById(1);\n    System.out.println(\"å°æè·å–çš„å•†å“ä»·æ ¼ä¸ºï¼š\" + productWang.getPrice());\n\n    //3.å°æä¿®æ”¹å•†å“ä»·æ ¼+50\n    productLi.setPrice(productLi.getPrice()+50);\n    productMapper.updateById(productLi);\n\n    //4.å°ç‹ä¿®æ”¹å•†å“ä»·æ ¼-30\n    productWang.setPrice(productWang.getPrice()-30);\n    productMapper.updateById(productWang);\n\n    //5.è€æ¿æŸ¥è¯¢å•†å“ä»·æ ¼\n    Product productBoss = productMapper.selectById(1);\n    System.out.println(\"è€æ¿è·å–çš„å•†å“ä»·æ ¼ä¸ºï¼š\" + productBoss.getPrice());\n&#125;\n\næ‰§è¡Œç»“æœ\n\n\n\n3.4\tä¹è§‚é”è§£å†³é—®é¢˜\n\nå®ä½“ç±»versionå­—æ®µæ·»åŠ æ³¨è§£@Version\n@Data\npublic class Product &#123;\n    private Long id;\n    private String name;\n    private Integer price;\n    @Version\n    private Integer version;\n&#125;\n\næ·»åŠ ä¹è§‚é”æ’ä»¶é…ç½®\n@Bean\npublic MybatisPlusInterceptor mybatisPlusInterceptor()&#123;\n    MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();\n    //æ·»åŠ åˆ†é¡µæ’ä»¶\n    interceptor.addInnerInterceptor(new PaginationInnerInterceptor(DbType.MYSQL));\n    //æ·»åŠ ä¹è§‚é”æ’ä»¶\n    interceptor.addInnerInterceptor(new OptimisticLockerInnerInterceptor());\n    return interceptor;\n&#125;\n\nå†æ¬¡æ‰§è¡Œæµ‹è¯•æ–¹æ³•\n\n\n\n\n\n\n\n\n\nå°ææŸ¥è¯¢å•†å“ä¿¡æ¯ï¼š\nâ€‹\tSELECT id,name,price,version FROM t_product WHERE id&#x3D;?\nå°ç‹æŸ¥è¯¢å•†å“ä¿¡æ¯ï¼š\nâ€‹\tSELECT id,name,price,version FROM t_product WHERE id&#x3D;?\nå°æä¿®æ”¹å•†å“ä»·æ ¼ï¼Œè‡ªåŠ¨å°†version+1\nâ€‹\tUPDATE t_product SET name&#x3D;?, price&#x3D;?, version&#x3D;? WHERE id&#x3D;? AND version&#x3D;?\nâ€‹\tParameters: å¤–æ˜Ÿäººç¬”è®°æœ¬(String), 150(Integer), 1(Integer), 1(Long), 0(Integer)\nå°ç‹ä¿®æ”¹å•†å“ä»·æ ¼ï¼Œæ­¤æ—¶versionå·²æ›´æ–°ï¼Œæ¡ä»¶ä¸æˆç«‹ï¼Œä¿®æ”¹å¤±è´¥\nâ€‹\tUPDATE t_product SET name&#x3D;?, price&#x3D;?, version&#x3D;? WHERE id&#x3D;? AND version&#x3D;?\nâ€‹\tParameters: å¤–æ˜Ÿäººç¬”è®°æœ¬(String), 70(Integer), 1(Integer), 1(Long), 0(Integer)\næœ€ç»ˆï¼Œå°ç‹ä¿®æ”¹å¤±è´¥ï¼ŒæŸ¥è¯¢ä»·æ ¼ï¼š150\nâ€‹\tSELECT id,name,price,version FROM t_product WHERE id&#x3D;?\n\nä¼˜åŒ–æ‰§è¡Œæµç¨‹\n@Test\npublic void testProduct01()&#123;\n    //1.å°æè·å–å•†å“ä»·æ ¼\n    Product productLi = productMapper.selectById(1);\n    System.out.println(\"å°æè·å–çš„å•†å“ä»·æ ¼ä¸ºï¼š\" + productLi.getPrice());\n\n    //2.å°ç‹è·å–å•†å“ä»·æ ¼\n    Product productWang = productMapper.selectById(1);\n    System.out.println(\"å°æè·å–çš„å•†å“ä»·æ ¼ä¸ºï¼š\" + productWang.getPrice());\n\n    //3.å°æä¿®æ”¹å•†å“ä»·æ ¼+50\n    productLi.setPrice(productLi.getPrice()+50);\n    productMapper.updateById(productLi);\n\n    //4.å°ç‹ä¿®æ”¹å•†å“ä»·æ ¼-30\n    productWang.setPrice(productWang.getPrice()-30);\n    int result = productMapper.updateById(productWang);\n    if(result == 0)&#123;\n        //æ“ä½œå¤±è´¥ï¼Œé‡è¯•\n        Product productNew = productMapper.selectById(1);\n        productNew.setPrice(productNew.getPrice()-30);\n        productMapper.updateById(productNew);\n    &#125;\n\n    //5.è€æ¿æŸ¥è¯¢å•†å“ä»·æ ¼\n    Product productBoss = productMapper.selectById(1);\n    System.out.println(\"è€æ¿è·å–çš„å•†å“ä»·æ ¼ä¸ºï¼š\" + productBoss.getPrice());\n&#125;\n\n\n\n\nä¸ƒã€é€šç”¨æšä¸¾\n\n\n\n\n\n\n\n\nè¡¨ä¸­çš„æœ‰äº›å­—æ®µå€¼æ˜¯å›ºå®šçš„ï¼Œä¾‹å¦‚æ€§åˆ«ï¼ˆç”·æˆ–å¥³ï¼‰ï¼Œæ­¤æ—¶æˆ‘ä»¬å¯ä»¥ä½¿ç”¨MyBatis-Plusçš„é€šç”¨æšä¸¾æ¥å®ç°\n\næ•°æ®åº“è¡¨æ·»åŠ å­—æ®µsex\n\n\nåˆ›å»ºé€šç”¨æšä¸¾ç±»å‹\n@Getter\npublic enum SexEnum &#123;\n    MALE(1, \"ç”·\"),\n    FEMALE(2, \"å¥³\");\n\n    @EnumValue //å°†æ³¨è§£æ‰€æ ‡è¯†çš„å±æ€§çš„å€¼å­˜å‚¨åˆ°æ•°æ®åº“ä¸­\n    private int sex;\n    private String sexName;\n\n    SexEnum(Integer sex, String sexName) &#123;\n        this.sex = sex;\n        this.sexName = sexName;\n    &#125;\n&#125;\n\nUserå®ä½“ç±»ä¸­æ·»åŠ å±æ€§sex\npublic class User &#123;\n    private Long id;\n    @TableField(\"username\")\n    private String name;\n    private Integer age;\n    private String email;\n\n    @TableLogic\n    private int isDeleted;  //é€»è¾‘åˆ é™¤\n\n    private SexEnum sex;\n&#125;\n\né…ç½®æ‰«æé€šç”¨æšä¸¾\n#MyBatis-Plusç›¸å…³é…ç½®\nmybatis-plus:\n  #æŒ‡å®šmapperæ–‡ä»¶æ‰€åœ¨çš„åœ°å€\n  mapper-locations: classpath:mapper/*.xml\n  configuration:\n    #é…ç½®æ—¥å¿—\n    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl\n  global-config:\n    banner: off\n    db-config:\n      #é…ç½®mpçš„ä¸»é”®ç­–ç•¥ä¸ºè‡ªå¢\n      id-type: auto\n      # è®¾ç½®å®ä½“ç±»æ‰€å¯¹åº”çš„è¡¨çš„ç»Ÿä¸€å‰ç¼€\n      table-prefix: t_\n  #é…ç½®ç±»å‹åˆ«åæ‰€å¯¹åº”çš„åŒ…\n  type-aliases-package: com.atguigu.mybatisplus.pojo\n  # æ‰«æé€šç”¨æšä¸¾çš„åŒ…\n  type-enums-package: com.atguigu.mybatisplus.enums\n\næ‰§è¡Œæµ‹è¯•æ–¹æ³•\n@Test\npublic void test()&#123;\n    User user = new User();\n    user.setName(\"admin\");\n    user.setAge(33);\n    user.setSex(SexEnum.MALE);\n    int result = userMapper.insert(user);\n    System.out.println(\"result:\"+result);\n&#125;\n\nå…«ã€å¤šæ•°æ®æº\n\n\n\n\n\n\n\n\né€‚ç”¨äºå¤šç§åœºæ™¯ï¼šçº¯ç²¹å¤šåº“ã€ è¯»å†™åˆ†ç¦»ã€ ä¸€ä¸»å¤šä»ã€ æ··åˆæ¨¡å¼ç­‰\nåœºæ™¯è¯´æ˜ï¼š\næˆ‘ä»¬åˆ›å»ºä¸¤ä¸ªåº“ï¼Œåˆ†åˆ«ä¸ºï¼šmybatis_plusï¼ˆä»¥å‰çš„åº“ä¸åŠ¨ï¼‰ä¸mybatis_plus_1ï¼ˆæ–°å»ºï¼‰ï¼Œå°†mybatis_plusåº“çš„productè¡¨ç§»åŠ¨åˆ°mybatis_plus_1åº“ï¼Œè¿™æ ·æ¯ä¸ªåº“ä¸€å¼ è¡¨ï¼Œé€šè¿‡ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹åˆ†åˆ«è·å–ç”¨æˆ·æ•°æ®ä¸å•†å“æ•°æ®ï¼Œå¦‚æœè·å–åˆ°è¯´æ˜å¤šåº“æ¨¡æ‹ŸæˆåŠŸ\n1.åˆ›å»ºæ•°æ®åº“åŠè¡¨\nåˆ›å»ºæ•°æ®åº“mybatis_plus_1å’Œè¡¨&#96;product\nCREATE DATABASE `mybatis_plus_1` /*!40100 DEFAULT CHARACTER SET utf8mb4 */;\nuse `mybatis_plus_1`; \nCREATE TABLE product ( \n    id BIGINT(20) NOT NULL COMMENT 'ä¸»é”®ID', \n    name VARCHAR(30) NULL DEFAULT NULL COMMENT 'å•†å“åç§°', \n    price INT(11) DEFAULT 0 COMMENT 'ä»·æ ¼', \n    version INT(11) DEFAULT 0 COMMENT 'ä¹è§‚é”ç‰ˆæœ¬å·', \n    PRIMARY KEY (id) \n);\n\næ·»åŠ æµ‹è¯•æ•°æ®\nINSERT INTO product (id, NAME, price) VALUES (1, 'å¤–æ˜Ÿäººç¬”è®°æœ¬', 100);\n\nåˆ é™¤mybatis_plusåº“ä¸­çš„productè¡¨ \nuse mybatis_plus; \nDROP TABLE IF EXISTS product;\n\n2.æ–°å»ºå·¥ç¨‹å¼•å…¥ä¾èµ–\n\n\n\n\n\n\n\n\nè‡ªè¡Œæ–°å»ºä¸€ä¸ªSpring Bootå·¥ç¨‹å¹¶é€‰æ‹©MySQLé©±åŠ¨åŠLombokä¾èµ–\nå¼•å…¥MyBaits-Plusçš„ä¾èµ–åŠå¤šæ•°æ®æºçš„ä¾èµ–\n&lt;dependency>\n    &lt;groupId>com.baomidou&lt;/groupId>\n    &lt;artifactId>mybatis-plus-boot-starter&lt;/artifactId>\n    &lt;version>3.5.1&lt;/version>\n&lt;/dependency>\n\n&lt;dependency>\n    &lt;groupId>com.baomidou&lt;/groupId>\n    &lt;artifactId>dynamic-datasource-spring-boot-starter&lt;/artifactId>\n    &lt;version>3.5.0&lt;/version>\n&lt;/dependency>\n\n\n\n3.ç¼–å†™é…ç½®æ–‡ä»¶spring:\n  # é…ç½®æ•°æ®æºä¿¡æ¯\n  datasource:\n    dynamic:\n      # è®¾ç½®é»˜è®¤çš„æ•°æ®æºæˆ–è€…æ•°æ®æºç»„,é»˜è®¤å€¼å³ä¸ºmaster\n      primary: master\n      # ä¸¥æ ¼åŒ¹é…æ•°æ®æº,é»˜è®¤false.trueæœªåŒ¹é…åˆ°æŒ‡å®šæ•°æ®æºæ—¶æŠ›å¼‚å¸¸,falseä½¿ç”¨é»˜è®¤æ•°æ®æº\n      strict: false\n      datasource:\n        master:\n          url: jdbc:mysql://localhost:3306/mybatis_plus?characterEncoding=utf-8&amp;useSSL=false\n          driver-class-name: com.mysql.cj.jdbc.Driver\n          username: root\n          password: 132537\n        slave_1:\n          url: jdbc:mysql://localhost:3306/mybatis_plus_1?characterEncoding=utf-8&amp;useSSL=false\n          driver-class-name: com.mysql.cj.jdbc.Driver\n          username: root\n          password: 132537\n\n\n\n4.åˆ›å»ºå®ä½“ç±»\næ–°å»ºä¸€ä¸ªUserå®ä½“ç±»ï¼ˆå¦‚æœæ•°æ®åº“è¡¨åæœ‰t_å‰ç¼€è®°å¾—é…ç½®ï¼‰\n@Data\npublic class User &#123;\n    private Long id;\n    private String name;\n    private Integer age;\n    private String email;\n&#125;\n\næ–°å»ºä¸€ä¸ªå®ä½“ç±»Product\n@Data\npublic class Product &#123;\n    private Long id;\n    private String name;\n    private Integer price;\n    private Integer version;\n&#125;\n\n5.åˆ›å»ºMapperåŠService\næ–°å»ºæ¥å£UserMapper\npublic interface UserMapper extends BaseMapper&lt;User> &#123;&#125;\n\næ–°å»ºæ¥å£ProductMapper\npublic interface ProductMapper extends BaseMapper&lt;Product> &#123;&#125;\n\næ–°å»ºServiceæ¥å£UserServiceæŒ‡å®šæ“ä½œçš„æ•°æ®æº\n@DS(\"master\") //æŒ‡å®šæ“ä½œçš„æ•°æ®æºï¼Œmasterä¸ºuserè¡¨\npublic interface UserService extends IService&lt;User> &#123;&#125;\n\næ–°å»ºServiceæ¥å£ProductServiceæŒ‡å®šæ“ä½œçš„æ•°æ®æº\n@DS(\"slave_1\")\npublic interface ProductService extends IService&lt;Product> &#123;&#125;\n\nè‡ªè¡Œå»ºç«‹Serviceçš„å®ç°ç±»\n...\n\n6.ç¼–å†™æµ‹è¯•æ–¹æ³•\n\n\n\n\n\n\n\n\nè®°å¾—åœ¨å¯åŠ¨ç±»ä¸­æ·»åŠ æ³¨è§£@MapperScan()\nclass TestDatasourceApplicationTests &#123;\n\t@Resource\n\tUserService userService;\n\n\t@Resource\n\tProductService productService;\n\n\t@Test\n\tvoid contextLoads() &#123;\n\t\tUser user = userService.getById(1L);\n\t\tProduct product = productService.getById(1L);\n\t\tSystem.out.println(\"User = \" + user);\n\t\tSystem.out.println(\"Product = \" + product);\n\t&#125;\n\n&#125;\n\n\nä¹ã€MyBatisXæ’ä»¶\n\n\n\n\n\n\n\n\nMyBatis-Plusä¸ºæˆ‘ä»¬æä¾›äº†å¼ºå¤§çš„mapperå’Œserviceæ¨¡æ¿ï¼Œèƒ½å¤Ÿå¤§å¤§çš„æé«˜å¼€å‘æ•ˆç‡ã€‚\nä½†æ˜¯åœ¨çœŸæ­£å¼€å‘è¿‡ç¨‹ä¸­ï¼ŒMyBatis-Pluså¹¶ä¸èƒ½ä¸ºæˆ‘ä»¬è§£å†³æ‰€æœ‰é—®é¢˜ï¼Œä¾‹å¦‚ä¸€äº›å¤æ‚çš„SQLï¼Œå¤šè¡¨è”æŸ¥ï¼Œæˆ‘ä»¬å°±éœ€è¦è‡ªå·±å»ç¼–å†™ä»£ç å’ŒSQLè¯­å¥ï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•å¿«é€Ÿçš„è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥ä½¿ç”¨MyBatisXæ’ä»¶ã€‚\nMyBatisXä¸€æ¬¾åŸºäº IDEA çš„å¿«é€Ÿå¼€å‘æ’ä»¶ï¼Œä¸ºæ•ˆç‡è€Œç”Ÿã€‚\n1.å®‰è£…MyBatisXæ’ä»¶\n\n\n\n\n\n\n\n\næ‰“å¼€IDEAï¼ŒFile-&gt; Setteings-&gt;Plugins-&gt;MyBatisXï¼Œæœç´¢æ æœç´¢MyBatisXç„¶åå®‰è£…ã€‚\n\n2.å¿«é€Ÿç”Ÿæˆä»£ç \næ–°å»ºä¸€ä¸ªSpring Booté¡¹ç›®å¼•å…¥ä¾èµ–ï¼ˆåˆ›å»ºå·¥ç¨‹æ—¶è®°å¾—å‹¾é€‰lombokåŠmysqlé©±åŠ¨ï¼‰\n&lt;dependency>\n    &lt;groupId>com.baomidou&lt;/groupId>\n    &lt;artifactId>mybatis-plus-boot-starter&lt;/artifactId>\n    &lt;version>3.5.1&lt;/version>\n&lt;/dependency>\n\n&lt;dependency>\n    &lt;groupId>com.baomidou&lt;/groupId>\n    &lt;artifactId>dynamic-datasource-spring-boot-starter&lt;/artifactId>\n    &lt;version>3.5.0&lt;/version>\n&lt;/dependency>\n\né…ç½®æ•°æ®æºä¿¡æ¯\nspring:\n  datasource:\n    type: com.zaxxer.hikari.HikariDataSource\n    driver-class-name: com.mysql.cj.jdbc.Driver\n    url: jdbc:mysql://localhost:3306/mybatis_plus?characterEncoding=utf-8&amp;useSSL=false\n    username: root\n    password: 132537\n\nåœ¨IDEAä¸­ä¸æ•°æ®åº“å»ºç«‹é“¾æ¥\n\n\nå¡«å†™æ•°æ®åº“ä¿¡æ¯å¹¶ä¿å­˜\n\n\næ‰¾åˆ°æˆ‘ä»¬éœ€è¦ç”Ÿæˆçš„è¡¨ç‚¹å‡»å³é”®\n\n\nå¡«å†™å®Œä¿¡æ¯ä»¥åä¸‹ä¸€æ­¥\n\n\nç»§ç»­å¡«å†™ä¿¡æ¯\n\n\nå¤§åŠŸå‘Šæˆï¼ˆçœŸç‰¹ä¹ˆå¥½ç”¨yydsï¼‰\n\n\n\n3.å¿«é€Ÿç”ŸæˆCRUD\n\n\n\n\n\n\n\n\nMyBaitsXå¯ä»¥æ ¹æ®æˆ‘ä»¬åœ¨Mapperæ¥å£ä¸­è¾“å…¥çš„æ–¹æ³•åå¿«é€Ÿå¸®æˆ‘ä»¬ç”Ÿæˆå¯¹åº”çš„sqlè¯­å¥\n\n\nåã€ä»£ç ç”Ÿæˆå™¨package com.example.dockertest;\n\nimport com.baomidou.mybatisplus.annotation.DbType;\nimport com.baomidou.mybatisplus.annotation.IdType;\nimport com.baomidou.mybatisplus.generator.AutoGenerator;\nimport com.baomidou.mybatisplus.generator.config.DataSourceConfig;\nimport com.baomidou.mybatisplus.generator.config.GlobalConfig;\nimport com.baomidou.mybatisplus.generator.config.PackageConfig;\nimport com.baomidou.mybatisplus.generator.config.StrategyConfig;\nimport com.baomidou.mybatisplus.generator.config.rules.DateType;\nimport com.baomidou.mybatisplus.generator.config.rules.NamingStrategy;\nimport org.junit.Test;\n\npublic class mp &#123;\n\n    @Test\n    public void run() &#123;\n        //ä¸€èˆ¬å†™åœ¨testä¸­\n        // 1ã€åˆ›å»ºä»£ç ç”Ÿæˆå™¨\n        AutoGenerator mpg = new AutoGenerator();\n\n        // 2ã€å…¨å±€é…ç½®\n        GlobalConfig gc = new GlobalConfig();\n        //ä½¿ç”¨ç»å¯¹è·¯å¾„\n        gc.setOutputDir(\"F:\\\\guli_parent\\\\service\\\\service-edu\" + \"/src/main/java\");\n        gc.setAuthor(\"LMZovo\"); //ä½œè€…\n        gc.setOpen(false); //ç”Ÿæˆåæ˜¯å¦æ‰“å¼€èµ„æºç®¡ç†å™¨\n        gc.setFileOverride(false); //é‡æ–°ç”Ÿæˆæ—¶æ–‡ä»¶æ˜¯å¦è¦†ç›–\n        gc.setServiceName(\"%sService\");    //å»æ‰Serviceæ¥å£çš„é¦–å­—æ¯I\n        gc.setIdType(IdType.ID_WORKER_STR); //ä¸»é”®ç­–ç•¥ Longä¸ç”¨åŠ strï¼Œstringè¦åŠ \n        gc.setDateType(DateType.ONLY_DATE);//å®šä¹‰ç”Ÿæˆçš„å®ä½“ç±»ä¸­æ—¥æœŸç±»å‹\n        gc.setSwagger2(true);//å¼€å¯Swagger2æ¨¡å¼\n\n        mpg.setGlobalConfig(gc);\n\n        // 3ã€æ•°æ®æºé…ç½®\n        DataSourceConfig dsc = new DataSourceConfig();\n        dsc.setUrl(\"jdbc:mysql://localhost:3307/guli?serverTimezone=GMT%2B8\");\n        dsc.setDriverName(\"com.mysql.cj.jdbc.Driver\");\n        dsc.setUsername(\"root\");\n        dsc.setPassword(\"lmz0521\");\n        dsc.setDbType(DbType.MYSQL);\n        mpg.setDataSource(dsc);\n\n        // 4ã€åŒ…é…ç½®\n        PackageConfig pc = new PackageConfig();\n        pc.setParent(\"com.guli\");\n        pc.setModuleName(\"eduService\"); //æ¨¡å—å\n        pc.setController(\"controller\");\n        pc.setEntity(\"entity\");\n        pc.setService(\"service\");\n        pc.setMapper(\"mapper\");\n        mpg.setPackageInfo(pc);\n\n        // 5ã€ç­–ç•¥é…ç½®\n        StrategyConfig strategy = new StrategyConfig();\n        strategy.setInclude(\"edu_teacher\"); //æ•°æ®åº“ä¸­è¡¨å\n        strategy.setNaming(NamingStrategy.underline_to_camel);//æ•°æ®åº“è¡¨æ˜ å°„åˆ°å®ä½“çš„å‘½åç­–ç•¥\n        strategy.setTablePrefix(pc.getModuleName() + \"_\"); //ç”Ÿæˆå®ä½“æ—¶å»æ‰è¡¨å‰ç¼€\n\n        strategy.setColumnNaming(NamingStrategy.underline_to_camel);//æ•°æ®åº“è¡¨å­—æ®µæ˜ å°„åˆ°å®ä½“çš„å‘½åç­–ç•¥\n        strategy.setEntityLombokModel(true); // lombok æ¨¡å‹ @Accessors(chain = true) setteré“¾å¼æ“ä½œ\n\n        strategy.setRestControllerStyle(true); //restful apié£æ ¼æ§åˆ¶å™¨\n        strategy.setControllerMappingHyphenStyle(true); //urlä¸­é©¼å³°è½¬è¿å­—ç¬¦\n\n        mpg.setStrategy(strategy);\n        // 6ã€æ‰§è¡Œ\n        mpg.execute();\n    &#125;\n&#125;\n\n","slug":"MybatisPlus","date":"2022-06-19T12:43:38.059Z","categories_index":"mybatisPlus","tags_index":"mybatisPlus","author_index":"å°æä¸åœ¨_"},{"id":"dffa3dc092427bd4c66bed12d5783ad5","title":"å‡¸åŒ…ç®—æ³•-Andrewç®—æ³•","content":"\nclass Solution &#123;\n    public int[][] outerTrees(int[][] trees) &#123;\n        int n = trees.length;\n        if (n &lt; 4) &#123;\n            return trees;\n        &#125;\n        /* æŒ‰ç…§ x å¤§å°è¿›è¡Œæ’åºï¼Œå¦‚æœ x ç›¸åŒï¼Œåˆ™æŒ‰ç…§ y çš„å¤§å°è¿›è¡Œæ’åº */\n        Arrays.sort(trees, (a, b) -> &#123;\n            if (a[0] == b[0]) &#123;\n                return a[1] - b[1];\n            &#125;\n            return a[0] - b[0];\n        &#125;);\n        List&lt;Integer> list = new ArrayList&lt;>();\n        boolean[] used = new boolean[n];\n        /* list[0] éœ€è¦å…¥æ ˆä¸¤æ¬¡ï¼Œä¸è¿›è¡Œæ ‡è®° */\n        list.add(0);\n        /* æ±‚å‡ºå‡¸åŒ…çš„ä¸‹åŠéƒ¨åˆ† */\n        for (int i = 1; i &lt; n; i++) &#123;\n            while (list.size() > 1 &amp;&amp; cross(trees[list.get(list.size() - 2)], trees[list.get(list.size() - 1)], trees[i]) &lt; 0) &#123;\n                used[list.get(list.size() - 1)] = false;\n                list.remove(list.size() - 1);\n            &#125;\n            used[i] = true;\n            list.add(i);\n        &#125;\n        int m = list.size();\n        /* æ±‚å‡ºå‡¸åŒ…çš„ä¸ŠåŠéƒ¨åˆ† */\n        for (int i = n - 2; i >= 0; i--) &#123;\n            if (!used[i]) &#123;\n                while (list.size() > m &amp;&amp; cross(trees[list.get(list.size() - 2)], trees[list.get(list.size() - 1)], trees[i]) &lt; 0) &#123;\n                    used[list.get(list.size() - 1)] = false;\n                    list.remove(list.size() - 1);\n                &#125;\n                used[i] = true;\n                list.add(i);\n            &#125;\n        &#125;\n        /* list[0] åŒæ—¶å‚ä¸å‡¸åŒ…çš„ä¸ŠåŠéƒ¨åˆ†æ£€æµ‹ï¼Œå› æ­¤éœ€å»æ‰é‡å¤çš„ list[0] */\n        list.remove(list.size() - 1);\n        int size = list.size();\n        int[][] res = new int[size][2];\n        for (int i = 0; i &lt; size; i++) &#123;\n            res[i] = trees[list.get(i)];\n        &#125;\n        return res;\n    &#125;\n\n    /*æ¯”è¾ƒæ–œç‡æ˜¯å¦ä¸ºå·¦æ‹,å¤§äº0è¯´æ˜æ˜¯å·¦æ‹\n     * (x2-x1)/(y2-y1) - (x3-x2)/(y3-y2) = (x2-x1)(y3-y2) - (x3-x2)(y2-y1)\n     * */\n    private int cross(int[] p, int[] q, int[] r) &#123;\n        return (q[0] - p[0]) * (r[1] - q[1]) - (q[1] - p[1]) * (r[0] - q[0]);\n    &#125;\n&#125;\n587\n","slug":"å‡¸åŒ…ç®—æ³•-- Andrew ç®—æ³•","date":"2022-06-11T13:28:51.911Z","categories_index":"æ•°æ®ç»“æ„","tags_index":"æ•°æ®ç»“æ„,ç®—æ³•","author_index":"å°æä¸åœ¨_"},{"id":"781fb484634f3be0f1bf39d2ec5d0535","title":"å­—å…¸æ ‘(å‰ç¼€æ ‘)","content":"1\nclass Solution &#123;\n    public int findKthNumber(int n, int k) &#123;\n    int ans = 1;\n    while(k>1)&#123;\n        int count = dfs(ans,n);\n        //æ±‚å‡ºå­æ ‘çš„æ•°é‡å’ŒKæ¯”è¾ƒï¼Œè‹¥å¤§äºkåˆ™åœ¨å­æ ‘ä¸­æ‰¾ï¼Œå¦åˆ™åœ¨å¾ªç¯ä¸‹ä¸€ä¸ªèŠ‚ç‚¹\n        if(count&lt;k)&#123;\n            ans++;\n            k-=count;\n        &#125;else&#123;\n            ans*=10;\n            k--;\n        &#125;\n    &#125;\n    return ans;\n&#125;\n\n    //è®¡ç®—å­æ ‘ä¸­çš„æ€»æ•°\n    public int dfs(long ans,long n)&#123;\n        int tem = 0;\n        long left = n;\n        long right = n;\n        while(left&lt;=right)&#123;\n            tem += Math.min(right,n) - left +1;\n            left*=10;\n            right=right*10+9;\n        &#125;\n        return tem;\n    &#125;\n&#125;\n2å®ç°Trie\nclass Trie &#123;\n    Trie[] chileren;\n    boolean isExist;\n    public Trie() &#123;\n        chileren = new Trie[26];\n        isExist = false;\n    &#125;\n    \n    public void insert(String word) &#123;\n        Trie node = this;\n        for(int i=0;i&lt;word.length();i++)&#123;\n            char c = word.charAt(i);\n            int index = c - 'a';\n            if(node.chileren[index] == null)&#123;\n                node.chileren[index] = new Trie();\n            &#125;\n            node = node.chileren[index];\n        &#125;\n        node.isExist = true;\n    &#125;\n    \n    public boolean search(String word) &#123;\n        Trie node = searchWorld(word);\n        return node!=null &amp;&amp; node.isExist;\n    &#125;\n    \n    public boolean startsWith(String prefix) &#123;\n        return searchWorld(prefix)!=null;\n    &#125;\n\n    private Trie searchWorld(String str)&#123;\n        Trie node = this;\n        for(int i=0;i&lt;str.length();i++)&#123;\n            char c = str.charAt(i);\n            int index = c-'a';\n            if(node.chileren[index]==null)&#123;\n                return null;\n            &#125;\n            node = node.chileren[index];\n        &#125;\n        return node;\n    &#125;\n&#125;\n","slug":"å­—å…¸æ ‘","date":"2022-06-11T13:28:51.903Z","categories_index":"æ•°æ®ç»“æ„","tags_index":"æ•°æ®ç»“æ„,ç®—æ³•","author_index":"å°æä¸åœ¨_"},{"id":"d1408add887a68e7d3f5038df24f24f8","title":"çº¦ç‘Ÿå¤«ç¯","content":"çº¦ç‘Ÿå¤«ç¯â€”â€”å…¬å¼æ³•ï¼ˆé€’æ¨å…¬å¼ï¼‰\n","slug":"çº¦ç‘Ÿå¤«é—®é¢˜","date":"2022-06-11T13:28:51.903Z","categories_index":"æ•°æ®ç»“æ„","tags_index":"æ•°æ®ç»“æ„,ç®—æ³•","author_index":"å°æä¸åœ¨_"},{"id":"a448dfd8ebb4408d1633f0dff8411f1c","title":"çº¿æ®µæ ‘","content":"leetcode\nclass NumArray &#123;\n    class TreeNode&#123;\n        int sum;\n        int start,end;\n        TreeNode left,right;\n        public TreeNode(int s,int e)&#123;\n            left = null;\n            right = null;\n            start = s;\n            end = e;\n        &#125;\n    &#125;\n    TreeNode root = null;\n    private TreeNode buildTree(int[] nums,int start,int end)&#123;\n        if(start > end)&#123;\n            return null;\n        &#125;\n        TreeNode res = new TreeNode(start,end);\n        if(start == end)&#123;\n            res.sum = nums[start];\n        &#125;else&#123;\n            int mid = start + (end - start)/2;\n            res.left = buildTree(nums,start,mid);\n            res.right = buildTree(nums,mid+1,end); \n            res.sum = res.left.sum + res.right.sum;\n        &#125;\n        return res;\n    &#125;\n    public NumArray(int[] nums) &#123;\n        root = buildTree(nums,0,nums.length - 1);\n    &#125;\n\n    private void update(TreeNode root,int i,int val)&#123;\n        if(root.start == root.end)&#123;\n            root.sum = val;\n        &#125;else&#123;\n            int mid = root.start + (root.end - root.start)/2;\n            if(i&lt;=mid)&#123;\n                update(root.left,i,val);\n            &#125;else&#123;\n                update(root.right,i,val);\n            &#125;\n            root.sum = root.left.sum + root.right.sum;\n        &#125;\n    &#125;\n    \n    public void update(int index, int val) &#123;\n        update(root,index,val);\n    &#125;\n    \n    private int query(TreeNode root,int i,int j)&#123;\n        if(root.start == i&amp;&amp;root.end == j)&#123;\n            return root.sum;\n        &#125;else&#123;\n            int mid = root.start + (root.end - root.start)/2;\n            if(j&lt;=mid)&#123;\n                return query(root.left,i,j);\n            &#125;else if(i>=mid+1)&#123;\n                return query(root.right,i,j);\n            &#125;else&#123;\n                return query(root.left,i,mid) + query(root.right,mid+1,j);\n            &#125;\n        &#125;\n    &#125;\n    public int sumRange(int left, int right) &#123;\n        return query(root,left,right);\n    &#125;\n&#125;\n\n/**\n * Your NumArray object will be instantiated and called as such:\n * NumArray obj = new NumArray(nums);\n * obj.update(index,val);\n * int param_2 = obj.sumRange(left,right);\n */\n","slug":"çº¿æ®µæ ‘","date":"2022-06-11T13:28:51.895Z","categories_index":"æ•°æ®ç»“æ„","tags_index":"æ•°æ®ç»“æ„,ç®—æ³•","author_index":"å°æä¸åœ¨_"},{"id":"c4317418140da87757f2c4ade40f3f4c","title":"å®ç°LRU","content":"å®é™…ä¸Šåº•å±‚ç»´æŠ¤åŒå‘é“¾è¡¨å’Œå“ˆå¸Œè¡¨ï¼Œå°†æ–°æŸ¥è¯¢çš„æ•°æ®æˆ–æ’å…¥çš„æ•°æ®ç§»åŠ¨åˆ°é“¾è¡¨å¤´ï¼Œè‹¥å†æ’å…¥æ•°æ®æ—¶å®¹é‡ä¸è¶³åˆ™ä»é“¾è¡¨å°¾éƒ¨åˆ é™¤\nclass LRUCache &#123;\n    Map&lt;Integer, Node> map;\n    DoubleLinkedList cache;\n    int capacity;\n\n    public LRUCache(int capacity) &#123;\n        this.capacity = capacity;\n        map = new HashMap&lt;>();\n        cache = new DoubleLinkedList();\n    &#125;\n\n    public int get(int key) &#123;\n        if (!map.containsKey(key)) &#123;\n            return -1;\n        &#125;\n        int val = map.get(key).value;\n        put(key, val);\n        return val;\n    &#125;\n\n    public void put(int key, int value) &#123;\n        Node newNode = new Node(key, value);\n        if (map.containsKey(key)) &#123;\n            cache.delete(map.get(key));\n            map.put(key, newNode);\n            cache.addFirst(newNode);\n        &#125; else &#123;\n            if (capacity == map.size()) &#123;\n                int k = cache.deleteLast(newNode);\n                map.remove(k);\n            &#125;\n            cache.addFirst(newNode);\n            map.put(key, newNode);\n        &#125;\n    &#125;\n\n     class Node &#123;\n        int key;\n        int value;\n        Node prev;\n        Node next;\n\n        public Node(int key, int value) &#123;\n            this.key = key;\n            this.value = value;\n        &#125;\n    &#125;\n\n     class DoubleLinkedList &#123;\n        Node head;\n        Node tail;\n\n        public DoubleLinkedList() &#123;\n            head = new Node(0, 0);\n            tail = new Node(0, 0);\n            head.next = tail;\n            tail.prev = head;\n        &#125;\n\n        public void addFirst(Node node) &#123;\n            node.next = head.next;\n            node.prev = head;\n            head.next.prev = node;\n            head.next = node;\n        &#125;\n\n        public int delete(Node node) &#123;\n            int key = node.key;\n            node.prev.next = node.next;\n            node.next.prev = node.prev;\n            return key;\n        &#125;\n\n        public int deleteLast(Node node) &#123;\n            if (tail.prev == head) return -1;\n            return delete(tail.prev);\n        &#125;\n    &#125;\n&#125;\n\n","slug":"LRUç¼“å­˜","date":"2022-06-11T13:26:26.264Z","categories_index":"æ•°æ®ç»“æ„","tags_index":"æ•°æ®ç»“æ„,ç®—æ³•","author_index":"å°æä¸åœ¨_"},{"id":"fb29227b1d7a6ce56d78eec37318e1c8","title":"èƒŒåŒ…dp","content":"1\nclass Solution &#123;\n    public boolean canPartition(int[] nums) &#123;\n        int len = nums.length;\n        int sum = 0;\n        for (int num : nums) &#123;\n            sum += num;\n        &#125;\n        if (sum % 2 == 1) &#123;\n            return false;\n        &#125;\n        int target = sum / 2;\n        boolean[] dp = new boolean[target + 1];\n        // dp[0] = true;æœ‰æ²¡æœ‰éƒ½æ²¡å½±å“\n        if (nums[0] &lt;= target) &#123;\n            dp[nums[0]] = true;\n        &#125;\n        for (int i = 1; i &lt; len; i++) &#123;\n            for (int j = target; j >= 0 &amp;&amp; nums[i] &lt;= j; j--) &#123;\n                //é€†åºéå†æ˜¯ä¸èƒ½è¦†ç›–ä¹‹å‰çš„å€¼ï¼Œå› ä¸ºåªç”¨ä¸€ç»´æ•°ç»„ï¼Œå½“å‰å…ƒç´ çš„å€¼ç”±ä¸Šä¸€è¡Œæˆ–ä¸Šä¸€è¡Œå·¦è¾¹æŸä¸ªå€¼å¾—æ¥\n                dp[j] = dp[j] || dp[j - nums[i]];\n            &#125;\n            if (dp[target]) &#123;\n                return true;\n            &#125;\n        &#125;\n        return dp[target];\n    &#125;\n&#125;\n\n2\nclass Solution &#123;\n    public int numSquares(int n) &#123;\n        //dp[i] è¡¨ç¤ºå½“å‰æ•°å­—iæœ€å°‘ç”±å‡ ä¸ªå®Œå…¨å¹³æ–¹æ•°æ„æˆ\n        //dp[i] = Math.Min(dp[i],dp[i-j*j]+1);\n        int[] dp = new int[n+1];\n        Arrays.fill(dp,Integer.MAX_VALUE);\n        dp[0] = 0;\n        for(int i=1;i*i&lt;=n;i++)&#123;\n            int x = i*i;\n            for(int j = x;j&lt;=n;j++)&#123;\n                dp[j] = Math.min(dp[j],dp[j-x]+1);\n            &#125;\n        &#125;\n        return dp[n];\n    &#125;\n&#125;\n\næ ‡ç­¾ï¼šåŠ¨æ€è§„åˆ’\né¦–å…ˆåˆå§‹åŒ–é•¿åº¦ä¸º n+1 çš„æ•°ç»„ dpï¼Œæ¯ä¸ªä½ç½®éƒ½ä¸º 0\nå¦‚æœ n ä¸º 0ï¼Œåˆ™ç»“æœä¸º 0\nå¯¹æ•°ç»„è¿›è¡Œéå†ï¼Œä¸‹æ ‡ä¸º iï¼Œæ¯æ¬¡éƒ½å°†å½“å‰æ•°å­—å…ˆæ›´æ–°ä¸ºæœ€å¤§çš„ç»“æœï¼Œå³ dp[i]=iï¼Œæ¯”å¦‚ i=4ï¼Œæœ€åç»“æœä¸º 4=1+1+1+1 å³ä¸º 4 ä¸ªæ•°å­—\nåŠ¨æ€è½¬ç§»æ–¹ç¨‹ä¸ºï¼šdp[i] = MIN(dp[i], dp[i - j * j] + 1)ï¼Œi è¡¨ç¤ºå½“å‰æ•°å­—ï¼Œj*j è¡¨ç¤ºå¹³æ–¹æ•°\næ—¶é—´å¤æ‚åº¦ï¼šO(n*sqrt(n))O(nâˆ—sqrt(n))ï¼Œsqrt ä¸ºå¹³æ–¹æ ¹\nclass Solution &#123;\n    public int numSquares(int n) &#123;\n        //dp[i] è¡¨ç¤ºå½“å‰æ•°å­—iæœ€å°‘ç”±å‡ ä¸ªå®Œå…¨å¹³æ–¹æ•°æ„æˆ\n        //dp[i] = Math.Min(dp[i],dp[i-j*j]+1);\n        int[] dp = new int[n+1];\n        for(int i=1;i&lt;=n;i++)&#123;\n            dp[i] = i; //æ¯æ¬¡æœ€åçš„æƒ…å†µå°±æ˜¯+1\n            for(int j = 1;i-j*j>=0;j++)&#123;\n                dp[i] = Math.min(dp[i],dp[i-j*j]+1);\n            &#125;\n        &#125;\n        return dp[n];\n    &#125;\n&#125;\n\n\n","slug":"èƒŒåŒ…dp","date":"2022-06-11T13:26:26.264Z","categories_index":"æ•°æ®ç»“æ„","tags_index":"æ•°æ®ç»“æ„,ç®—æ³•","author_index":"å°æä¸åœ¨_"},{"id":"546eab39c80ef1d176f6354aacd8516e","title":"290åœºå‘¨èµ›","content":"\n1.6041. å¤šä¸ªæ•°ç»„æ±‚äº¤é›†\nclass Solution &#123;\n    public List&lt;Integer> intersection(int[][] nums) &#123;\n        List&lt;Integer> list = new ArrayList&lt;>();\n        int[] res = new int[1001];\n        for(int[] num:nums)&#123;\n            for(int i=0;i&lt;num.length;i++)&#123;\n                res[num[i]]++;\n            &#125;\n        &#125;\n        for(int i=0;i&lt;res.length;i++)&#123;\n            if(res[i]==nums.length)&#123;\n                list.add(i);\n            &#125;\n        &#125;\n        return list;\n    &#125;\n&#125;\n\n\n\n2.6042. ç»Ÿè®¡åœ†å†…æ ¼ç‚¹æ•°ç›®æ¨¡æ‹Ÿï¼Œåœ†åŒ…æ‹¬çš„æœ€å¤§èŒƒå›´å†…\nclass Solution &#123;\n    public int countLatticePoints(int[][] circles) &#123;\n        int maxX = 0, maxY = 0, minX = Integer.MAX_VALUE, minY = Integer.MAX_VALUE;\n        for (int[] c : circles) &#123;\n            minX = Math.min(minX, c[0] - c[2]);\n            minY = Math.min(minY, c[1] - c[2]);\n            maxX = Math.max(maxX, c[0] + c[2]);\n            maxY = Math.max(maxY, c[1] + c[2]);\n        &#125;\n        int res = 0;\n        for (int i = minX; i &lt;= maxX; i++) &#123;\n            for (int j = minY; j &lt;= maxY; j++) &#123;\n                for (int[] c : circles) &#123;\n                    int tmp = (i - c[0]) * (i - c[0]) + (j - c[1]) * (j - c[1]);\n                    if (tmp &lt;= c[2] * c[2]) &#123;\n                        res++;\n                        break;\n                    &#125;\n                &#125;\n            &#125;\n        &#125;\n        return res;\n    &#125;\n&#125;\n\n\n\n36043. ç»Ÿè®¡åŒ…å«æ¯ä¸ªç‚¹çš„çŸ©å½¢æ•°ç›®\nclass Solution &#123;\n    public int[] countRectangles(int[][] rectangles, int[][] points) &#123;\n        //å“ˆå¸Œè¡¨keyä¸ºé«˜åº¦ï¼ŒListä¸ºå®½åº¦çš„é›†åˆã€‚\n        HashMap&lt;Integer, List&lt;Integer>> map = new HashMap&lt;>();\n        for (int[] rectangle : rectangles) &#123;\n            int l = rectangle[0];\n            int h = rectangle[1];\n            List&lt;Integer> list = map.getOrDefault(h, new ArrayList&lt;>());\n            list.add(l);\n            map.put(h, list);\n        &#125;\n        //ç”±äºéœ€è¦å¯¹å®½åº¦çš„åˆ—è¡¨ä½¿ç”¨äºŒåˆ†æ³•ï¼Œæ‰€ä»¥éœ€è¦æ’åºã€‚\n        for (int key : map.keySet()) &#123;\n            Collections.sort(map.get(key));\n        &#125;\n        int[] ans = new int[points.length];\n        for (int i = 0; i &lt; points.length; i++) &#123;\n            int[] p = points[i];\n            int x = p[0];\n            int y = p[1];\n            int count = 0;\n            //æœ¬é¢˜é‡ç‚¹ï¼Œæšä¸¾å¯èƒ½çš„é«˜åº¦ï¼Œå¹¶æ‰¾åˆ°å½“å‰é«˜åº¦ä¸‹ï¼Œåˆæ³•çš„çŸ©å½¢æ•°é‡ã€‚\n            for (int h = 100; h >= 1; h--) &#123;\n                //æšä¸¾é«˜åº¦å·²ç»æ¯”pointçš„é«˜åº¦è¿˜å°äº†ï¼Œä¸å¯èƒ½å†æ‰¾åˆ°åˆæ³•çŸ©å½¢äº†ã€‚\n                if (h &lt; y) break;\n                //ä¸å­˜åœ¨ä»¥å½“å‰hä¸ºé«˜åº¦çš„çŸ©å½¢ï¼Œè·³è¿‡ã€‚\n                if (!map.containsKey(h)) continue;\n                //äºŒåˆ†æœç´¢ï¼Œå¹¶ç´¯åŠ ç­”æ¡ˆ\n                count += binarySearch(map.get(h), x);\n            &#125;\n            ans[i] = count;\n        &#125;\n        return ans;\n\n    &#125;\n\n    public int binarySearch(List&lt;Integer> nums, int k) &#123;\n        //äºŒåˆ†æ³•æ‰¾numsä¸­æœ‰å¤šå°‘å…ƒç´ å¤§äºç­‰äºkã€‚\n        int n = nums.size();\n        int left = 0;\n        int right = n - 1;\n        while (left &lt; right) &#123;\n            int mid = left + (right - left) / 2;\n            if (nums.get(mid) >= k) &#123;\n                right = mid;\n            &#125; else &#123;\n                left = mid + 1;\n            &#125;\n        &#125;\n        return nums.get(right) >= k ? n - right : 0;\n    &#125;\n&#125;\n\n\n\n46044. èŠ±æœŸå†…èŠ±çš„æ•°ç›®\nclass Solution &#123;\n    public int[] fullBloomFlowers(int[][] flowers, int[] persons) &#123;\n        List&lt;Integer> in = new ArrayList&lt;>();\n        List&lt;Integer> out = new ArrayList&lt;>();\n        for (int[] f : flowers) &#123;\n            in.add(f[0]);\n            out.add(f[1]);\n        &#125;\n        in.sort((o1, o2) -> o1 - o2);\n        out.sort((o1, o2) -> o1 - o2);\n        int[] res = new int[persons.length];\n        for (int i = 0; i &lt; persons.length; i++) &#123;\n            int left = 0,right=in.size()-1;\n            int cnt = 0;\n            //è®¡ç®—å¼€èŠ±æ•°é‡\n            while(left&lt;right)&#123;\n                int mid = left+(right-left+1)/2;\n                if(in.get(mid)>persons[i])&#123;\n                    right = mid-1;\n                &#125;else&#123;\n                    left = mid;\n                &#125;\n            &#125;\n            if(in.get(left)&lt;=persons[i])&#123;\n                cnt+=(left+1);\n            &#125;\n            //è®¡ç®—å‡‹è°¢æ•°é‡\n            left = 0;\n            right = out.size()-1;\n            while(left&lt;right)&#123;\n                int mid = left+(right-left+1)/2;\n                if(out.get(mid)>=persons[i])&#123;\n                    right = mid-1;\n                &#125;else&#123;\n                    left = mid;\n                &#125;\n            &#125;\n            if(out.get(left)&lt;persons[i])&#123;\n                cnt-=(left+1);\n            &#125;\n            res[i] = cnt;\n        &#125;\n        return res;\n    &#125;\n    \n&#125;\n","slug":"290åœºå‘¨èµ›","date":"2022-06-11T13:26:26.256Z","categories_index":"æ•°æ®ç»“æ„","tags_index":"æ•°æ®ç»“æ„,ç®—æ³•,å‘¨èµ›","author_index":"å°æä¸åœ¨_"},{"id":"c18469ab20e7b093d36b4a61728d07eb","title":"å¹¶æŸ¥é›†","content":"\nclass Solution &#123;\n    public double[] calcEquation(List&lt;List&lt;String>> equations, double[] values, List&lt;List&lt;String>> queries) &#123;\n        int equationsSize = equations.size();\n        UnionFind unionFind = new UnionFind(2 * equationsSize); //æœ€å¤§éœ€è¦ä¸¤å€ç©ºé—´ï¼ˆæ¯ä¸ªlistæœ‰ä¸¤ä¸ªå­—æ¯ï¼‰\n        //ç¬¬ä¸€æ­¥ï¼Œé¢„å¤„ç†ï¼Œå°†å˜é‡çš„å€¼ä¸idè¿›è¡Œæ˜ å°„ï¼Œä½¿å¾—å¹¶æŸ¥é›†çš„åº•å±‚ç”¨æ•°ç»„å®ç°ï¼Œæ–¹ä¾¿ç¼–ç \n        Map&lt;String, Integer> map = new HashMap&lt;>(2 * equationsSize);//åˆå§‹åŒ–mapå°†å­—æ¯å…³ç³»è½¬åŒ–ä¸ºæ•°å­—\n        int id = 0; //å¯¹åº”valuesä¸­ç´¢å¼•å’Œæ˜ å°„å­—æ¯\n        for (int i = 0; i &lt; equationsSize; i++) &#123;\n            List&lt;String> equation = equations.get(i);\n            String var1 = equation.get(0);\n            String var2 = equation.get(1);\n            if (!map.containsKey(var1)) &#123;\n                map.put(var1, id++);\n            &#125;\n            if (!map.containsKey(var2)) &#123;\n                map.put(var2, id++);\n            &#125;\n            //å¹¶æŸ¥è¯¢æŸ¥è¯¢ä¹‹å‰æ‰§è¡Œä¸€æ¬¡åˆå¹¶æ“ä½œ\n            unionFind.union(map.get(var1), map.get(var2), values[i]);\n        &#125;\n        //ç¬¬äºŒæ­¥  åšæŸ¥è¯¢\n        int queriesSize = queries.size();\n        double[] res = new double[queriesSize];\n        for (int i = 0; i &lt; queriesSize; i++) &#123;\n            String var1 = queries.get(i).get(0);\n            String var2 = queries.get(i).get(1);\n            //å¾—åˆ°éœ€è¦æŸ¥è¯¢çš„å­—æ¯å¯¹åº”çš„id\n            Integer id1 = map.get(var1);\n            Integer id2 = map.get(var2);\n            if (id1 == null || id2 == null) &#123;\n                res[i] = -1.0;\n            &#125; else &#123;\n                //ä¸¤ä¸ªèŠ‚ç‚¹éƒ½å­˜åœ¨ï¼Œåˆ™è½¬åŒ–ä¸ºå’Œçˆ¶èŠ‚ç‚¹çš„å…³ç³»è¿›è¡Œæ¯”è¾ƒ\n                res[i] = unionFind.isConnected(id1, id2);\n            &#125;\n        &#125;\n        return res;\n    &#125;\n\n    class UnionFind &#123;\n        private int[] parent; //è¡¨ç¤ºæ¯ä¸ªèŠ‚ç‚¹å¯¹åº”çš„çˆ¶èŠ‚ç‚¹çš„id\n        private double[] weight; //è¡¨ç¤ºèŠ‚ç‚¹æŒ‡å‘çˆ¶èŠ‚ç‚¹çš„æƒå€¼\n\n        public UnionFind(int n) &#123;\n            this.parent = new int[n];\n            this.weight = new double[n];\n            //åˆå§‹åŒ–ï¼Œæ‰€æœ‰çš„çˆ¶èŠ‚ç‚¹å¼€å§‹éƒ½æ˜¯æŒ‡å‘è‡ªå·±\n            for (int i = 0; i &lt; n; i++) &#123;\n                parent[i] = i;\n                weight[i] = 1.0d;\n            &#125;\n        &#125;\n\n        /**\n         * åˆå¹¶æ“ä½œ\n         *\n         * @param xï¼Œy   ä¸¤ä¸ªèŠ‚ç‚¹\n         * @param value æœ‰å‘è¾¹çš„æƒå€¼\n         */\n        public void union(int x, int y, double value) &#123;\n            //æ‰¾åˆ°ä¸¤ä¸ªèŠ‚ç‚¹å¯¹åº”çš„çˆ¶èŠ‚ç‚¹\n            int rootx = find(x);\n            int rooty = find(y);\n            if (rootx == rooty) &#123;\n                return;\n            &#125;\n            parent[rootx] = rooty;\n            weight[rootx] = weight[y] * value / weight[x];\n        &#125;\n\n        /**\n         * è·¯å¾„å‹ç¼©\n         *\n         * @param id è¾“å…¥èŠ‚ç‚¹çš„id\n         * @return æ ¹èŠ‚ç‚¹çš„id\n         */\n        private int find(int id) &#123;\n            if (id != parent[id]) &#123;\n                //æ ¹æ®ä¸Šä¸€æ¬¡èŠ‚ç‚¹çš„æƒå€¼æ¥æ›´æ–°å½“å‰èŠ‚ç‚¹çš„æƒå€¼\n                int preNode = parent[id];\n                parent[id] = find(parent[id]);\n                weight[id] *= weight[preNode];\n            &#125;\n            return parent[id];\n        &#125;\n\n        public double isConnected(int x, int y) &#123;\n            int rootX = find(x);\n            int rootY = find(y);\n            if (rootX == rootY) &#123;\n                return weight[x] / weight[y];\n            &#125; else &#123;\n                //è¯´æ˜ä¸åœ¨ä¸€ä¸ªé›†åˆä¸­\n                return -1;\n            &#125;\n        &#125;\n    &#125;\n&#125;\nhot100-é™¤æ³•æ±‚å€¼\n","slug":"å¹¶æŸ¥é›†","date":"2022-06-11T13:26:26.256Z","categories_index":"æ•°æ®ç»“æ„","tags_index":"æ•°æ®ç»“æ„,ç®—æ³•","author_index":"å°æä¸åœ¨_"},{"id":"779600de7239585350eddc687c9afdbb","title":"CAS","content":"CASä¸volatileCAS â€” compareAndSet()ï¼Œå†…éƒ¨å®ç°äº†åŸå­æ€§ï¼ˆï¼‰\npublic void withdraw(Integer amount) &#123;\n    // éœ€è¦ä¸æ–­å°è¯•ï¼Œç›´åˆ°æˆåŠŸä¸ºæ­¢\n    while (true) &#123;\n        // æ¯”å¦‚æ‹¿åˆ°äº†æ—§å€¼ 1000\n        int prev = balance.get();\n        // åœ¨è¿™ä¸ªåŸºç¡€ä¸Š 1000-10 = 990\n        int next = prev - amount;\n         /*\n         compareAndSet æ­£æ˜¯åšè¿™ä¸ªæ£€æŸ¥ï¼Œåœ¨ set å‰ï¼Œå…ˆæ¯”è¾ƒ prev ä¸å½“å‰å€¼\n         - ä¸ä¸€è‡´äº†ï¼Œnext ä½œåºŸï¼Œè¿”å› false è¡¨ç¤ºå¤±è´¥\n         æ¯”å¦‚ï¼Œåˆ«çš„çº¿ç¨‹å·²ç»åšäº†å‡æ³•ï¼Œå½“å‰å€¼å·²ç»è¢«å‡æˆäº† 990\n         é‚£ä¹ˆæœ¬çº¿ç¨‹çš„è¿™æ¬¡ 990 å°±ä½œåºŸäº†ï¼Œè¿›å…¥ while ä¸‹æ¬¡å¾ªç¯é‡è¯•\n         - ä¸€è‡´ï¼Œä»¥ next è®¾ç½®ä¸ºæ–°å€¼ï¼Œè¿”å› true è¡¨ç¤ºæˆåŠŸ\n         */\n        if (balance.compareAndSet(prev, next)) &#123;\n            break;\n        &#125;\n    &#125;\n&#125;\n\nå…¶å® CAS çš„åº•å±‚æ˜¯ lock cmpxchg æŒ‡ä»¤ï¼ˆX86 æ¶æ„ï¼‰ï¼Œåœ¨å•æ ¸ CPU å’Œå¤šæ ¸ CPU ä¸‹éƒ½èƒ½å¤Ÿä¿è¯ã€æ¯”è¾ƒ-äº¤\næ¢ã€‘çš„åŸå­æ€§ã€‚\nåœ¨å¤šæ ¸çŠ¶æ€ä¸‹ï¼ŒæŸä¸ªæ ¸æ‰§è¡Œåˆ°å¸¦ lock çš„æŒ‡ä»¤æ—¶ï¼ŒCPU ä¼šè®©æ€»çº¿é”ä½ï¼Œå½“è¿™ä¸ªæ ¸æŠŠæ­¤æŒ‡ä»¤æ‰§è¡Œå®Œæ¯•ï¼Œå†\nå¼€å¯æ€»çº¿ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸­ä¸ä¼šè¢«çº¿ç¨‹çš„è°ƒåº¦æœºåˆ¶æ‰€æ‰“æ–­ï¼Œä¿è¯äº†å¤šä¸ªçº¿ç¨‹å¯¹å†…å­˜æ“ä½œçš„å‡†ç¡®æ€§ï¼Œæ˜¯åŸå­çš„ã€‚\n\nvolatile\nè·å–å…±äº«å˜é‡æ—¶ï¼Œä¸ºäº†ä¿è¯å˜é‡çš„å¯è§æ€§ï¼Œéœ€è¦ä½¿ç”¨volatileä¿®é¥°\nå®ƒå¯ä»¥ç”¨æ¥ä¿®é¥°æˆå‘˜å˜é‡å’Œé™æ€æˆå‘˜å˜é‡ï¼Œä»–å¯ä»¥é¿å…çº¿ç¨‹ä»è‡ªå·±çš„å·¥ä½œç¼“å­˜ä¸­æŸ¥æ‰¾å˜é‡çš„å€¼ï¼Œå¿…é¡»åˆ°ä¸»å­˜ä¸­è·å–å®ƒçš„å€¼ï¼Œçº¿ç¨‹æ“ä½œvolatileå˜é‡éƒ½æ˜¯ç›´æ¥æ“ä½œä¸»å­˜ï¼Œå³ä¸€ä¸ªçº¿ç¨‹å¯¹volatileå˜é‡çš„ä¿®æ”¹ï¼Œå¯¹å¦ä¸€ä¸ªçº¿ç¨‹å¯è§\nCASå¿…é¡»å€ŸåŠ©volatileæ‰èƒ½è¯»å–åˆ°å…±äº«å˜é‡çš„æœ€æ–°å€¼æ¥å®ç°ã€æ¯”è¾ƒå¹¶äº¤æ¢ã€‘çš„æ•ˆæœ\n\n\nä¸ºä»€ä¹ˆæ— é”æ•ˆç‡é«˜:æ— é”æƒ…å†µä¸‹ï¼Œå³ä½¿é‡è¯•å¤±è´¥ï¼Œçº¿ç¨‹å§‹ç»ˆåœ¨é«˜é€Ÿè¿è¡Œï¼Œæ²¡æœ‰åœæ­‡ï¼Œè€Œ synchronized ä¼šè®©çº¿ç¨‹åœ¨æ²¡æœ‰è·å¾—é”çš„æ—¶å€™ï¼Œ\nå‘ç”Ÿä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œè¿›å…¥é˜»å¡ã€‚\nä½†æ— é”æƒ…å†µä¸‹ï¼Œå› ä¸ºçº¿ç¨‹è¦ä¿æŒè¿è¡Œï¼Œéœ€è¦é¢å¤– CPU çš„æ”¯æŒï¼ŒCPU åœ¨è¿™é‡Œå°±å¥½æ¯”é«˜é€Ÿè·‘é“ï¼Œæ²¡æœ‰é¢å¤–çš„è·‘\né“ï¼Œçº¿ç¨‹æƒ³é«˜é€Ÿè¿è¡Œä¹Ÿæ— ä»è°ˆèµ·ï¼Œè™½ç„¶ä¸ä¼šè¿›å…¥é˜»å¡ï¼Œä½†ç”±äºæ²¡æœ‰åˆ†åˆ°æ—¶é—´ç‰‡ï¼Œä»ç„¶ä¼šè¿›å…¥å¯è¿è¡ŒçŠ¶æ€ï¼Œè¿˜\næ˜¯ä¼šå¯¼è‡´ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚\n\n\nCASçš„ç‰¹ç‚¹ï¼šç»“åˆCASå’Œvolatileå¯ä»¥å®ç°æ— é”å¹¶å‘ï¼Œé€‚ç”¨äºçº¿ç¨‹å°‘ï¼Œå¤šæ ¸CPUçš„åœºæ™¯ä¸‹\nCASæ˜¯åŸºäºä¹è§‚é”çš„æ€æƒ³\nsynchronizedæ˜¯åŸºäºæ‚²è§‚é”çš„æ€æƒ³\nCASä½“ç°çš„æ˜¯æ— é”å¹¶å‘ã€æ— é˜»å¡å¹¶å‘\nå› ä¸ºæ²¡æœ‰ä½¿ç”¨synchronizedï¼Œæ‰€ä»¥çº¿ç¨‹ä¸ä¼šè¿›å…¥é˜»å¡ï¼Œè¿™æ˜¯æ•ˆç‡æå‡çš„å› ç´ ä¹‹ä¸€\n\nä½†å¦‚æœç«äº‰æ¿€çƒˆï¼Œé‡è¯•å¿…ç„¶ä¼šé¢‘ç¹å‘ç”Ÿï¼Œåè€Œæ•ˆç‡ä¼šå—åˆ°å½±å“\n\n","slug":"CAS","date":"2022-06-11T13:20:41.435Z","categories_index":"JUC","tags_index":"JUC,java,å¤šçº¿ç¨‹","author_index":"å°æä¸åœ¨_"},{"id":"8719a59ea15091ad0c2facf954842244","title":"javaå†…å­˜æ¨¡å‹(JMM)","content":"javaå†…å­˜æ¨¡å‹(JMM)javaå†…å­˜æ¨¡å‹ï¼šJMMå³java Memory Modelï¼Œå®ƒå®šä¹‰äº†å†…å­˜ã€å·¥ä½œå†…å­˜æŠ½è±¡æ¦‚å¿µã€åº•å±‚å¯¹CPUå¯„å­˜å™¨ã€ç¼“å­˜ã€ç¡¬ä»¶å†…å­˜ã€CPUæŒ‡ä»¤ä¼˜åŒ–ç­‰\nJMMä½“ç°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼šâ€‹\t1.åŸå­æ€§ï¼šä¿è¯æŒ‡ä»¤ä¸ä¼šå—åˆ°çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å½±å“\nâ€‹\t2.å¯è§æ€§ï¼šä¿è¯æŒ‡ä»¤ä¸ä¼šå—åˆ°CPUç¼“å­˜çš„å½±å“\nâ€‹\t3.æœ‰åºæ€§ï¼šä¿è¯æŒ‡ä»¤ä¸ä¼šå—åˆ°CPUæŒ‡ä»¤å¹¶è¡Œä¼˜åŒ–çš„å½±å“\n\nå¯è§æ€§ï¼šå­˜åœ¨çš„é—®é¢˜ï¼š\nmain çº¿ç¨‹å¯¹ run å˜é‡çš„ä¿®æ”¹å¯¹äº t çº¿ç¨‹ä¸å¯è§ï¼Œå¯¼è‡´äº† t çº¿ç¨‹æ— æ³•åœæ­¢ï¼š\nstatic boolean run = true;\npublic static void main(String[] args) throws InterruptedException &#123;\n Thread t = new Thread(()->&#123;\n while(run)&#123;\n // ....\n &#125;\n &#125;);\n t.start();\n sleep(1);\n run = false; // çº¿ç¨‹tä¸ä¼šå¦‚é¢„æƒ³çš„åœä¸‹æ¥\n&#125;\n\nç¨‹åºä¸ä¼šåœæ­¢\n1.åˆå§‹çŠ¶æ€ï¼Œ t çº¿ç¨‹åˆšå¼€å§‹ä»ä¸»å†…å­˜è¯»å–äº† run çš„å€¼åˆ°å·¥ä½œå†…å­˜\n\n2.å› ä¸º t çº¿ç¨‹è¦é¢‘ç¹ä»ä¸»å†…å­˜ä¸­è¯»å– run çš„å€¼ï¼ŒJIT ç¼–è¯‘å™¨ä¼šå°† run çš„å€¼ç¼“å­˜è‡³è‡ªå·±å·¥ä½œå†…å­˜ä¸­çš„é«˜é€Ÿç¼“å­˜ä¸­ï¼Œ\nå‡å°‘å¯¹ä¸»å­˜ä¸­ run çš„è®¿é—®ï¼Œæé«˜æ•ˆç‡\n\n3.1 ç§’ä¹‹åï¼Œmain çº¿ç¨‹ä¿®æ”¹äº† run çš„å€¼ï¼Œå¹¶åŒæ­¥è‡³ä¸»å­˜ï¼Œè€Œ t æ˜¯ä»è‡ªå·±å·¥ä½œå†…å­˜ä¸­çš„é«˜é€Ÿç¼“å­˜ä¸­è¯»å–è¿™ä¸ªå˜é‡\nçš„å€¼ï¼Œç»“æœæ°¸è¿œæ˜¯æ—§å€¼\n\n\nè§£å†³ï¼š\næ·»åŠ volatileä¿®é¥°ç¬¦ï¼šï¼ˆåªèƒ½ä¿è¯å¯è§æ€§ï¼Œä¸èƒ½ä¿è¯åŸå­æ€§ï¼‰æ³¨æ„ï¼š\næƒ³è¦ä¿è¯åŸå­æ€§è¿˜éœ€è¦ä½¿ç”¨synchronizedæˆ–è€…ReentrantLock\nsynchronizedä¹Ÿå¯ä»¥ä¿è¯å¯è§æ€§ï¼Œä½†æ˜¯æ€§èƒ½æ¯”è¾ƒä½ï¼Œåº•å±‚ä¾èµ–äºmonitar\nå®ƒå¯ä»¥ç”¨æ¥ä¿®é¥°æˆå‘˜å˜é‡å’Œé™æ€æˆå‘˜å˜é‡\nä»–å¯ä»¥é¿å…çº¿ç¨‹ä»è‡ªå·±çš„å·¥ä½œç¼“å­˜ä¸­æŸ¥æ‰¾å˜é‡çš„å€¼ï¼Œå¿…é¡»åˆ°ä¸»å­˜ä¸­è·å–å®ƒçš„å€¼ï¼Œçº¿ç¨‹æ“ä½œ volatile å˜é‡éƒ½æ˜¯ç›´æ¥æ“ä½œä¸»å­˜\n\n\næœ‰åºæ€§ï¼šJVMä¼šåœ¨ä¸å½±å“æ­£ç¡®æ€§çš„å‰æä¸‹ï¼Œå¯ä»¥è°ƒæ•´è¯­å¥çš„æ‰§è¡Œé¡ºåº\né‡æ’åºå¯èƒ½å¯¼è‡´ç¨‹åºçš„è¿è¡Œç»“æœä¸é¢„æœŸç»“æœä¸ä¸€è‡´\nä½¿ç”¨volatileå¯ä»¥ç¦æ­¢æ‰é‡æ’åº\n\nvolatileåŸç†volatileçš„åº•å±‚å®ç°åŸç†æ˜¯å†…å­˜å±éšœï¼ŒMemory Barrierï¼ˆMemory Fenceï¼‰\nå¯¹volatileå˜é‡çš„å†™æŒ‡ä»¤åä¼šåŠ å…¥å†™å±éšœ\n\nå¯¹volatileå˜é‡çš„è¯»æŒ‡ä»¤ä¹‹å‰ä¼šåŠ å…¥è¯»å±éšœ\n\n\n1.å¦‚ä½•ä¿è¯å¯è§æ€§ï¼šå†™å±éšœ(sfence)ä¿è¯åœ¨è¯¥å±éšœä¹‹å‰çš„ï¼Œå¯¹å…±äº«å˜é‡çš„æ”¹åŠ¨ï¼Œéƒ½åŒæ­¥åˆ°ä¸»å­˜å½“ä¸­ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ç¼“å­˜ä¸­çš„æ•°æ®\npublic void actor(I_Result r) &#123;\n    num = 2;\n    ready = ture; //ready æ˜¯volatileèµ‹å€¼å¸¦å†™å±éšœ\n    //å†™å±éšœ\n&#125;\n\nè¯»å±éšœ(ifence)ä¿è¯åœ¨è¯¥å±éšœä¹‹åï¼Œå¯¹å…±äº«å˜é‡çš„è¯»å–ï¼ŒåŠ è½½çš„æ˜¯ä¸»å­˜ä¸­æœ€æ–°æ•°æ®ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ç¼“å­˜ä¸­çš„æ•°æ®\npublic void actor(I_Result r)&#123;\n    //è¯»å±éšœ\n    //ready æ˜¯volatileè¯»å–å€¼å¸¦è¯»å±éšœ\n    if(ready) &#123;\n        r,r1 = num + num;\n    &#125;else&#123;\n        r.r1 = 1;\n    &#125;\n&#125;\n\n\n\n\n2.å¦‚ä½•ä¿è¯æœ‰åºæ€§ï¼šå†™å±éšœä¼šç¡®ä¿æŒ‡ä»¤é‡æ’åºæ—¶ï¼Œä¸ä¼šå°†å†™å±éšœä¹‹å‰çš„ä»£ç æ’åœ¨å†™å±éšœä¹‹å\nè¯»å±éšœä¼šç¡®ä¿æŒ‡ä»¤é‡æ’åºæ—¶ï¼Œä¸ä¼šå°†è¯»å±éšœä¹‹åçš„ä»£ç æ’åœ¨è¯»å±éšœä¹‹å‰\n\nhappens-beforeè§„åˆ™ï¼šhappens-beforeè§„å®šäº†å¯¹å…±äº«å˜é‡çš„å†™æ“ä½œå¯¹å…¶ä»–çº¿ç¨‹çš„è¯»æ“ä½œå¯è§ï¼Œå®ƒæ˜¯å¯è§æ€§ä¸æœ‰åºæ€§çš„ä¸€å¥—è§„åˆ™æ€»ç»“ï¼ŒæŠ›å¼€ä»¥ä¸‹happens-beforeè§„åˆ™ï¼ŒJMMå¹¶ä¸èƒ½ä¿è¯ä¸€ä¸ªçº¿ç¨‹å¯¹å…±äº«å˜é‡çš„å†™ï¼Œå¯¹äºå…¶ä»–çº¿ç¨‹å¯¹è¯¥å…±äº«å˜é‡çš„è¯»å¯è§\n\n1.çº¿ç¨‹è§£é”mä¹‹å‰å¯¹å˜é‡çš„å†™ï¼Œå¯¹äºæ¥ä¸‹æ¥å¯¹måŠ é”çš„å…¶ä»–çº¿ç¨‹å¯¹è¯¥å˜é‡çš„è¯»å¯è§static int x;\nstatic Object m = new Object();\n\nnew Thread(()->&#123;\n    synchronized(m)&#123;\n        x = 10;\n    &#125;\n&#125;,\"t1\").start();\n\nnew Thread(()->&#123;\n    synchronized(m)&#123;\n        System.out.println(x);\n    &#125;\n&#125;,\"t2\").start();\n\n\n2.çº¿ç¨‹å¯¹volatileå˜é‡çš„å†™ï¼Œå¯¹æ¥ä¸‹æ¥å…¶ä»–çº¿ç¨‹å¯¹è¯¥å˜é‡çš„è¯»å¯è§volatile static int x;\n\nnew Thread(()->&#123;\n \tx = 10;\n&#125;,\"t1\").start();\n\nnew Thread(()->&#123;\n \tSystem.out.println(x);\n&#125;,\"t2\").start();\n\n\n3.çº¿ç¨‹startå‰å¯¹å˜é‡çš„å†™ï¼Œå¯¹è¯¥çº¿ç¨‹å¼€å¯åå¯¹è¯¥å˜é‡çš„è¯»å¯è§static int x;\nx = 10;\n\nnew Thread(()->&#123;\n \tSystem.out.println(x);\n&#125;,\"t2\").start();\n\n\n4.çº¿ç¨‹ç»“æŸå‰å¯¹å˜é‡çš„å†™ï¼Œå¯¹å…¶å®ƒçº¿ç¨‹å¾—çŸ¥å®ƒç»“æŸåçš„è¯»å¯è§ï¼ˆæ¯”å¦‚å…¶ä»–çº¿ç¨‹è°ƒç”¨isAliveæˆ–joinç­‰å¾…å®ƒç»“æŸï¼‰static int x;\n\nThread t1 = new Thread(()->&#123;\n \tx = 10;\n&#125;,\"t1\");\n\nt1.start();\nt1.join();\n\nSystem.out.println(x);\n\n\n5.çº¿ç¨‹t1æ‰“æ–­t2å‰å¯¹å˜é‡çš„å†™ï¼Œå¯¹äºå…¶ä»–çº¿ç¨‹å¾—çŸ¥t2è¢«æ‰“æ–­åå¯¹å˜é‡çš„è¯»å¯è§static int x;\npublic static void main(String[] args) &#123;\n    \n Thread t2 = new Thread(()->&#123;\n \twhile(true) &#123;\n \t\tif(Thread.currentThread().isInterrupted()) &#123;\n \t\t\tSystem.out.println(x);\n \t\t\tbreak;\n \t\t&#125;\n \t&#125;\n &#125;,\"t2\");\n    \n t2.start();\n    \n new Thread(()->&#123;\n \tsleep(1);\n \tx = 10;\n \tt2.interrupt();\n &#125;,\"t1\").start();\n    \n while(!t2.isInterrupted()) &#123;\n \tThread.yield();\n &#125;\n System.out.println(x);\n&#125;\n\n\n6.å¯¹å˜é‡é»˜è®¤å€¼(0ï¼Œfalseï¼Œnull)çš„å†™æ“ä½œï¼Œå¯¹å…¶ä»–çº¿ç¨‹å¯¹è¯¥å˜é‡çš„è¯»å¯è§\n7.å…·æœ‰ä¼ é€’æ€§volatile static int x;\nstatic int y;\n\nnew Thread(()->&#123;\n \ty = 10;\n \tx = 20;\n&#125;,\"t1\").start();\n\nnew Thread(()->&#123;\n \t// x=20 å¯¹ t2 å¯è§, åŒæ—¶ y=10 ä¹Ÿå¯¹ t2 å¯è§\n \tSystem.out.println(x);\n&#125;,\"t2\").start();","slug":"javaå†…å­˜æ¨¡å‹(JMM)","date":"2022-06-11T13:15:23.102Z","categories_index":"JUC","tags_index":"JUC,java,å¤šçº¿ç¨‹","author_index":"å°æä¸åœ¨_"},{"id":"489d7b6b150f5087fe22abf19dc56ce1","title":"wait/notifyï¼Œjoinï¼Œpark/Unpark","content":"wait&#x2F;notifyï¼Œjoinï¼Œpark&#x2F;Unparkwait&#x2F;notifyçš„åŸç†ï¼š\n1.Ownerå‘ç°çº¿ç¨‹æ¡ä»¶ä¸æ»¡è¶³ï¼Œè°ƒç”¨waitæ–¹æ³•ï¼Œå³å¯è¿›å…¥WaitSetå˜ä¸ºWAITINGçŠ¶æ€\n2.BLOCKEDå’ŒWAITINGçš„çº¿ç¨‹éƒ½å¤„äºé˜»å¡çŠ¶æ€ï¼Œä¸å ç”¨CPUæ—¶é—´ç‰‡\n3.BLOCKEDçº¿ç¨‹ä¼šåœ¨Ownerçº¿ç¨‹é‡Šæ”¾é”æ—¶å”¤é†’\n4.WAITINGçº¿ç¨‹ä¼šåœ¨Ownerçº¿ç¨‹è°ƒç”¨notifyæˆ–notifyAllæ—¶å”¤é†’ï¼Œä½†å”¤é†’åå¹¶ä¸æ„å‘³ç€ç«‹å³æ‰€å¾—é”ï¼Œä»éœ€è¦è¿›å…¥EntryListé‡æ–°ç«äº‰\n\n\nAPIä»‹ç»ï¼š1.obj.wait()ï¼šè®©è¿›å…¥objectç›‘è§†å™¨çš„çº¿ç¨‹åˆ°waitSetç­‰å¾…\n2.obj.wait(long timeout)ï¼šè®©è¿›å…¥objectç›‘è§†å™¨çš„çº¿ç¨‹åˆ°waitSetç­‰å¾…ï¼Œå±æ€§å€¼ä¸ºæœ€é•¿ç­‰å¾…æ—¶é—´\n3.obj.notify()ï¼šè®©objectä¸Šæ­£åœ¨waitSetç­‰å¾…çš„çº¿ç¨‹ä¸­æŒ‘ä¸€ä¸ªå”¤é†’\n4.obj.notifyAll()ï¼šè®©Objectä¸Šæ­£åœ¨waitSetç­‰å¾…çš„çº¿ç¨‹å…¨éƒ¨å”¤é†’\nå®ƒä»¬éƒ½æ˜¯çº¿ç¨‹ä¹‹é—´è¿›è¡Œå†™ä½œçš„æ‰‹æ®µï¼Œéƒ½æ˜¯Objectå¯¹è±¡çš„æ–¹æ³•ï¼Œå¿…é¡»è·å¾—æ­¤å¯¹è±¡çš„é”æ‰èƒ½è°ƒç”¨æ–¹æ³•\n\n\nwaitå’Œnotifyçš„æ­£ç¡®ä½¿ç”¨ï¼š\n1.sleep(long n)å’Œwait(long n)çš„åŒºåˆ«ï¼šâ‘ ï¼šsleepæ˜¯Threadçš„æ–¹æ³•ï¼Œè€Œwaitæ˜¯Objectçš„æ–¹æ³•\nâ‘¡ï¼šsleepä¸éœ€è¦å¼ºåˆ¶å’Œsynchronizedé…åˆä½¿ç”¨ï¼Œä½†æ˜¯waitéœ€è¦å’Œsynchronizedä¸€èµ·ä½¿ç”¨\nâ‘¢ï¼šsleepåœ¨ç¡çœ çš„åŒæ—¶ï¼Œä¸ä¼šé‡Šæ”¾å¯¹è±¡é”ï¼Œä½†æ˜¯waitåœ¨ç­‰å¾…çš„æ—¶å€™ä¼šé‡Šæ”¾å¯¹è±¡é”\nâ‘£ï¼šå®ƒä»¬çš„çŠ¶æ€éƒ½ä¼šå˜ä¸ºTIMED_WAITING\n\njoinåŸç†:joinçš„åº•å±‚ä½¿ç”¨åˆ°äº†ä¿æŠ¤æ€§æš‚åœçš„è®¾è®¡æ¨¡å¼\næºç ï¼š\npublic final synchronized void join(long millis)\n    throws InterruptedException &#123;\n    \t//è®°å½•æœ€åˆæ—¶é—´\n        long base = System.currentTimeMillis();\n    \t//è®°å½•å·²ç»ç»å†çš„æ—¶é—´\n        long now = 0;\n\t\t//ä¼ å…¥çš„æ—¶é—´å°äº0ï¼ŒæŠ›å¼‚å¸¸\n        if (millis &lt; 0) &#123;\n            throw new IllegalArgumentException(\"timeout value is negative\");\n        &#125;\n\t\t//ç­‰äº0å°±æ˜¯ä¸€ç›´ç­‰å¾…ï¼Œè°ƒç”¨wait(0)\n        if (millis == 0) &#123;\n            while (isAlive()) &#123;\n                wait(0);\n            &#125;\n        &#125; else &#123;\n            while (isAlive()) &#123;\n                //delayè¡¨ç¤ºä¼ å…¥çš„å‚æ•°å‡å»å·²ç»ç»å†çš„æ—¶é—´ï¼Œå°äº0å°±ç»“æŸ\n                long delay = millis - now;\n                if (delay &lt;= 0) &#123;\n                    break;\n                &#125;\n                //å°†delayè®¾ç½®ä¸ºå‚æ•°ï¼Œé˜²æ­¢å”¤é†’é”™è¯¯çš„é—®é¢˜\n                wait(delay);\n        \t\t//åˆ¤æ–­å·²ç»ç»å†çš„æ—¶é—´\n                now = System.currentTimeMillis() - base;\n            &#125;\n        &#125;\n    &#125;\n\n\nä¿æŠ¤æ€§æš‚åœçš„è®¾è®¡æ¨¡å¼ï¼š\n\nparkã€Unpark1.åŸºæœ¬ä½¿ç”¨ï¼š\nå®ƒä»¬æ˜¯LockSupportç±»ä¸­çš„æ–¹æ³•\nLockSupport.park()ï¼› &#x2F;&#x2F;æš‚åœå½“å‰çº¿ç¨‹\nLockSupport.unpark(æš‚åœçº¿ç¨‹å¯¹è±¡); Â  &#x2F;&#x2F;æ¢å¤æŸä¸ªçº¿ç¨‹çš„è¿è¡Œ\næ³¨æ„ï¼š\nunparkå¯ä»¥åœ¨ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨parkæ–¹æ³•ä¹‹å‰ä½¿ç”¨ï¼Œç­‰è¯¥çº¿ç¨‹è°ƒç”¨parkæ–¹æ³•åä¼šç«‹å³æ¢å¤è¿è¡Œ\n\nä¸waitå’Œnotifyæ¯”è¾ƒ1.wait,notifyå’ŒnotifyAll å¿…é¡»é…åˆObject Monitorä¸€èµ·ä½¿ç”¨(å³å…ˆè·å–åˆ°å¯¹è±¡é”)ï¼Œè€Œunparkä¸ç”¨\n\n2.parkå’Œunparkæ˜¯ä»¥çº¿ç¨‹ä¸ºå•ä½æ¥é˜»å¡å’Œå”¤é†’çº¿ç¨‹ï¼Œè€Œnotifyåªèƒ½éšæœºå”¤é†’ä¸€ä¸ªç­‰å¾…çš„çº¿ç¨‹\n\n3.parkå’Œunparkå¯ä»¥å…ˆunparkï¼Œä½†æ˜¯waitå’Œnotifyä¸èƒ½å…ˆnotify\n\n\nåŸç†ï¼šæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„ä¸€ä¸ªParkerå¯¹è±¡(åº•å±‚æœ‰Cå®ç°)ï¼Œç”±ä¸‰éƒ¨åˆ†ç»„æˆ _counter _cond _nutex\nçº¿ç¨‹å°±åƒä¸€ä¸ªæ—…è¡Œè€…ï¼ŒParkerå°±åƒå®ƒéšèº«æºå¸¦çš„èƒŒåŒ…ï¼Œæ¡ä»¶å˜é‡å°±åƒèƒŒåŒ…ä¸­çš„å¸ç¯·ï¼Œ_counterå°±åƒèƒŒåŒ…ä¸­çš„å¤‡ç”¨ç²®é£Ÿ(0ä¸ºè€—å°½ï¼Œ1ä¸ºå……è¶³)\nè°ƒç”¨parkå°±æ˜¯è¦çœ‹æ˜¯å¦éœ€è¦ä¼‘æ¯\nâ€‹\tå¦‚æœå¤‡ç”¨ç²®é£Ÿå……è¶³åˆ™ä¸éœ€è¦ä¼‘æ¯\nâ€‹\tå¦‚æœå¤‡ç”¨ç²®é£Ÿè€—å°½å°±éœ€è¦ä¼‘æ¯\nè°ƒç”¨unparkå°±å¥½æ¯”è®©å¤‡ç”¨ç²®é£Ÿå¤„äºå……è¶³çŠ¶æ€\nâ€‹\tå¦‚æœæ­¤æ—¶çº¿ç¨‹åœ¨ä¼‘æ¯ï¼Œå°±å”¤é†’å®ƒ\nâ€‹\tå¦‚æœæ­¤æ—¶çº¿ç¨‹æ­£åœ¨è¿è¡Œï¼Œé‚£ä¹ˆå®ƒä¸‹æ¬¡è°ƒç”¨parkæ–¹æ³•ï¼Œä»…æ¶ˆè€—æ‰å¤‡ç”¨ç²®é£Ÿï¼Œä¸éœ€è¦ä¼‘æ¯\nâ€‹\tå› ä¸ºèƒŒåŒ…ç©ºé—´æœ‰é™ï¼Œå¤šæ¬¡è°ƒç”¨unparkä»…ä»…ä¼šè¡¥å……ä¸€ä»½å¤‡ç”¨ç²®é£Ÿ\n","slug":"waitnotifyï¼Œjoinï¼ŒparkUnpark","date":"2022-06-11T13:10:26.016Z","categories_index":"JUC","tags_index":"JUC,java,å¤šçº¿ç¨‹","author_index":"å°æä¸åœ¨_"},{"id":"de5cee1035d10664a305cb1a74a3c58a","title":"ReentrantLockåŸç†","content":"\nReentrantLockåŸç†ï¼š\n\n1.éå…¬å¹³é”çš„å®ç°åŸç†ï¼š\nåŠ é”è§£é”æµç¨‹ï¼šå…ˆä»æ„é€ å™¨æ¥çœ‹ï¼Œé»˜è®¤ä¸ºéå…¬å¹³é”å®ç°\npublic ReentrantLock() &#123;\n\tsync = new NonfairSync();\n&#125;\n\nNonfairSync ç»§æ‰¿è‡ª AQS\n\næ²¡æœ‰ç«äº‰æ—¶ï¼š\n\nç¬¬ä¸€ä¸ªç«äº‰å‡ºç°æ—¶ï¼ˆstateè¡¨ç¤ºæ˜¯å¦è¢«åŠ é”ï¼‰\n\nThread-1 æ‰§è¡Œæµç¨‹1.CASå°è¯•å°†stateä»0æ”¹ä¸º1ï¼Œç»“æœå¤±è´¥äº†\n2.è¿›å…¥tryAcquireæ–¹æ³•ï¼Œé‡æ–°å°è¯•ï¼Œæ­¤æ—¶stateå·²ç»æ˜¯1ï¼Œç»“æœä»ç„¶å¤±è´¥\n3.è¿›å…¥addWaiteræ–¹æ³•ï¼Œæ„é€ Nodeé˜Ÿåˆ—\nâ‘ ï¼šå›¾ä¸­é»„è‰²ä¸‰è§’è¡¨ç¤ºNodeçš„wautStatusçŠ¶æ€ï¼Œé»˜è®¤ä¸º0æ­£å¸¸çŠ¶æ€\n\nâ‘¡ï¼šNodeçš„åˆ›å»ºæ˜¯æ‡’æƒ°çš„\n\nâ‘¢ï¼šç¬¬ä¸€ä¸ªNodeç§°ä¸ºDummyï¼ˆå“¨å…µï¼‰ï¼Œç”¨æ¥å ä½ï¼Œä¸å…³è”çº¿ç¨‹\n\n\n\nå½“å‰çº¿ç¨‹è¿›å…¥acquireQueuedæ–¹æ³•1.acquireQueuedæ–¹æ³•ä¼šåœ¨ä¸€ä¸ªæ­»å¾ªç¯ä¸­ä¸æ–­å°è¯•è·å–é”ï¼Œå¤±è´¥åå°±ä¼šè¢«parké˜»å¡\n\n2.å¦‚æœè‡ªå·±æ˜¯åœ¨å“¨å…µnodeä¸‹ä¸€ä¸ªï¼Œå°±ä¼šå†æ¬¡è¿›å…¥tryAcquireæ–¹æ³•å°è¯•è·å–é”ï¼Œæ­¤æ—¶stateä»ä¸º1ï¼Œå¤±è´¥\n\n3.è¿›å…¥shouldParkAfterAcquoreæ–¹æ³•ï¼Œå°†å‰å»nodeçš„waitStatusæ”¹ä¸º-1ï¼Œè¿”å›false\n\n\n4.shouldParkAfterFailedAcquireæ–¹æ³•æ‰§è¡Œå®Œæ¯•å›åˆ°acquireQueuedæ–¹æ³•ï¼Œå†æ¬¡tryAcquireå°è¯•è·å¾—é”ï¼Œæ­¤æ—¶stateè¿˜æ˜¯1ï¼Œè·å–å¤±è´¥\n\n5.å½“å†æ¬¡è¿›å…¥ shouldParkAfterFailedAcquire æ—¶ï¼Œæ­¤æ—¶å› ä¸ºiå…¶å‰é©±nodeçš„waitStateå·²ç»æ˜¯-1ï¼Œæ­¤æ—¶è¿”å›true\n\n6.è¿›å…¥parkAndCheckInterruptï¼ŒThread-1è¢«parké˜»å¡(å›¾ä¸­ç”¨ç°è‰²è¡¨ç¤º)\n\n\n\nå†æ¬¡æœ‰å¤šä¸ªçº¿ç¨‹ç»å†ä¸Šè¿°è¿‡ç¨‹ç«äº‰å¤±è´¥ï¼Œå˜æˆè¿™ä¸ªæ ·å­\n\nå½“Thread-0é‡Šæ”¾é”ï¼Œåˆ™è¿›å…¥tryReleaseæ–¹æ³•ï¼š1.è®¾ç½®exclusiveOwnerThreadä¸ºnull--è¡¨ç¤ºå½“å‰æ²¡æœ‰çº¿ç¨‹æŒæœ‰é”\n\n2.è®¾ç½®stateä¸º0\n\n\nç­‰å¾…é˜Ÿåˆ—ä¸ä¸ºnullï¼Œå¹¶ä¸”å‰é©±èŠ‚ç‚¹çš„waitStatus &#x3D; -1ï¼Œåˆ™è¿›å…¥unparkSuccessoræ–¹æ³•\næ‰¾åˆ°é˜Ÿåˆ—ä¸­è·ç¦»headæœ€è¿‘çš„ä¸€ä¸ªNodeï¼Œunparkè®©å…¶æ¢å¤è¿è¡Œï¼Œæœ¬ä¾‹ä¸­ä¸ºThread-1\nå›åˆ°Thread-1çš„acquireQueuedæ–¹æ³•\n\n\nè‹¥åŠ é”æˆåŠŸï¼ˆæ²¡æœ‰ç«äº‰ï¼‰ï¼Œåˆ™ï¼šexclusiveOwnerThreadä¸ºThread-1ï¼Œstateå€¼ä¸º1\n\nheadæŒ‡å‘åˆšåˆšThread-1æ‰€åœ¨çš„Nodeï¼Œå¹¶å°†Thread-1åˆšåˆšæ‰€åœ¨çš„Nodeæ¸…ç©ºThread(ä¸å…³è”çº¿ç¨‹)\n\nåŸæœ¬çš„å‰é©±èŠ‚ç‚¹ä»é“¾è¡¨ä¸­æ–­å¼€ï¼Œè¢«åƒåœ¾å›æ”¶\n\n\nå¦‚æœæ­¤æ—¶æœ‰æ–°çš„çº¿ç¨‹æ¥è¿›è¡Œç«äº‰**(éå…¬å¹³çš„ä½“ç°)**\nåˆ™å¯èƒ½åˆè¢«Thread-4å æ®é”èµ„æº\nThread-4è¢«è®¾ç½®ä¸ºexclusiveOwnerThreadï¼Œstate = 1\n\nThread-1å†æ¬¡è¿›å…¥acquireQueuedæ–¹æ³•ï¼Œè‹¥å°è¯•è·å–é”å¤±è´¥ï¼Œåˆ™è¿›å…¥ç­‰å¾…é˜Ÿåˆ—è¢«park\n\n\n\n2.å¯é‡å…¥åŸç†ï¼šstatic final class NonfairSync extends Sync &#123;\n    // ...\n    // Sync ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„\n    final boolean nonfairTryAcquire(int acquires) &#123;\n        final Thread current = Thread.currentThread();\n        int c = getState();\n        if (c == 0) &#123;\n            if (compareAndSetState(0, acquires)) &#123;\n                setExclusiveOwnerThread(current);\n                return true;\n            &#125;\n        &#125;\n        // å¦‚æœå·²ç»è·å¾—äº†é”, çº¿ç¨‹è¿˜æ˜¯å½“å‰çº¿ç¨‹, è¡¨ç¤ºå‘ç”Ÿäº†é”é‡å…¥\n        else if (current == getExclusiveOwnerThread()) &#123;\n            // state++\n            int nextc = c + acquires;\n            if (nextc &lt; 0) // overflow\n                throw new Error(\"Maximum lock count exceeded\");\n            setState(nextc);\n            return true;\n        &#125;\n        return false;\n    &#125;\n\n    // Sync ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„\n    protected final boolean tryRelease(int releases) &#123;\n        // state--\n        int c = getState() - releases;\n        if (Thread.currentThread() != getExclusiveOwnerThread())\n            throw new IllegalMonitorStateException();\n        boolean free = false;\n        // æ”¯æŒé”é‡å…¥, åªæœ‰ state å‡ä¸º 0, æ‰é‡Šæ”¾æˆåŠŸ\n        if (c == 0) &#123;\n            free = true;\n            setExclusiveOwnerThread(null);\n        &#125;\n        setState(c);\n        return free;\n    &#125;\n&#125;\n\n\næ€»ç»“ï¼šå½“å†æ¬¡åˆ†é…åˆ°èµ„æºæ—¶ï¼Œå› ä¸ºè‡ªå·±ä¹‹å‰å°±å·²ç»æ‹¿åˆ°äº†é”ï¼Œåˆ™ä¼šè®©stateè‡ªå¢ï¼Œå½“è§£é”æ—¶è®©stateè‡ªå‡\n\n\n3.å¯æ‰“æ–­åŸç†\nâ‘  ä¸å¯æ‰“æ–­æ¨¡å¼ï¼šåœ¨æ­¤æ¨¡å¼ä¸‹ï¼Œå³ä½¿è¢«å…¶ä»–çº¿ç¨‹æ‰“æ–­(interruptæ–¹æ³•)ï¼Œä»ä¼šé©»ç•™åœ¨AQSé˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…è·å–åˆ°é”ä¹‹åæ‰èƒ½ç»§ç»­è¿è¡Œ(æ˜¯ç»§ç»­è¿è¡Œï¼Œåªæ˜¯å°†æ‰“æ–­æ ‡è®°è®¾ç½®ä¸ºtrue)\n\nâ‘¡ å¯æ‰“æ–­æ¨¡å¼ï¼šå½“è¢«å…¶ä»–çº¿ç¨‹è°ƒç”¨interruptæ–¹å¼æ—¶æŠ›å‡ºå¼‚å¸¸\n\n\n4.å…¬å¹³é”å®ç°åŸç†ï¼šä¸éå…¬å¹³é”çš„åŒºåˆ«å°±æ˜¯ï¼Œè°ƒç”¨å…¬å¹³é”çš„æ–¹æ³•ä¼šå…ˆåˆ¤æ–­AQSç­‰å¾…é˜Ÿåˆ—ä¸­æ˜¯å¦å‰é©±èŠ‚ç‚¹ï¼Œæ²¡æœ‰ç­‰å¾…çš„çº¿ç¨‹æ‰ä¼šå»è°ƒç”¨casæ–¹æ³•ç«äº‰é”\n\n\n5.æ¡ä»¶å˜é‡çš„å®ç°åŸç†ï¼šæ¯ä¸ªæ¡ä»¶å˜é‡å…¶å®å°±å¯¹åº”ç€ä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—ï¼Œå…¶å®ç°ç±»æ˜¯ ConditionObject\n\nawaitæµç¨‹ï¼šå¼€å§‹ Thread-0 æŒæœ‰é”ï¼Œè°ƒç”¨ awaitï¼Œè¿›å…¥ ConditionObject çš„ addConditionWaiter æ–¹æ³•\nåˆ›å»ºæ–°çš„ Node çŠ¶æ€ä¸º -2ï¼ˆNode.CONDITIONï¼‰ï¼Œå…³è” Thread-0ï¼ŒåŠ å…¥ç­‰å¾…é˜Ÿåˆ—å°¾éƒ¨\n\næ¥ä¸‹æ¥è¿›å…¥ AQS çš„ fullyRelease æ–¹æ³•ï¼Œé‡Šæ”¾åŒæ­¥å™¨ä¸Šçš„é”\n\nunpark AQS é˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œç«äº‰é”ï¼Œå‡è®¾æ²¡æœ‰å…¶ä»–ç«äº‰çº¿ç¨‹ï¼Œé‚£ä¹ˆ Thread-1 ç«äº‰æˆåŠŸ\n\npark é˜»å¡ Thread-0\n\n\n\nsignalæµç¨‹ï¼šå‡è®¾ Thread-1 è¦æ¥å”¤é†’ Thread-0\n\nè¿›å…¥ ConditionObject çš„ doSignal æ–¹æ³•ï¼Œå–å¾—ç­‰å¾…é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ª Nodeï¼Œå³ Thread-0 æ‰€åœ¨ Node\n\næ‰§è¡Œ transferForSignal æ–¹æ³•ï¼Œå°†è¯¥ Node åŠ å…¥ AQS é˜Ÿåˆ—å°¾éƒ¨ï¼Œå°† Thread-0 çš„ waitStatus æ”¹ä¸º 0ï¼ŒThread-3 çš„waitStatus æ”¹ä¸º -1\n\nThread-1 é‡Šæ”¾é”ï¼Œè¿›å…¥ unlock æ–¹æ³•\n","slug":"ReentrantLock","date":"2022-06-11T13:07:20.302Z","categories_index":"JUC","tags_index":"JUC,java,å¤šçº¿ç¨‹","author_index":"å°æä¸åœ¨_"},{"id":"e1b3118af0455ea0158a80d4d6b7a3a6","title":"synchronizedå…³é”®å­—","content":"\n\n\nsynchronized è§£å†³æ–¹æ¡ˆ\näº’æ–¥ä¸ºäº†é¿å…ä¸´ç•ŒåŒºçš„ç«æ€æ¡ä»¶å‘ç”Ÿï¼Œæœ‰å¤šç§æ‰‹æ®µå¯ä»¥è¾¾åˆ°ç›®çš„ã€‚\né˜»å¡å¼çš„è§£å†³æ–¹æ¡ˆï¼šsynchronizedï¼ŒLock\n\néé˜»å¡å¼çš„è§£å†³æ–¹æ¡ˆï¼šåŸå­å˜é‡\n\nsynchronizedï¼Œæ¥è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œå³ä¿—ç§°çš„ã€å¯¹è±¡é”ã€‘ï¼Œå®ƒé‡‡ç”¨äº’æ–¥çš„æ–¹å¼è®©åŒä¸€æ—¶åˆ»è‡³å¤šåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æŒæœ‰\nã€å¯¹è±¡é”ã€‘ï¼Œå…¶å®ƒçº¿ç¨‹å†æƒ³è·å–è¿™ä¸ªã€å¯¹è±¡é”ã€‘æ—¶å°±ä¼šé˜»å¡ä½ã€‚è¿™æ ·å°±èƒ½ä¿è¯æ‹¥æœ‰é”çš„çº¿ç¨‹å¯ä»¥å®‰å…¨çš„æ‰§è¡Œä¸´ç•ŒåŒº\nå†…çš„ä»£ç ï¼Œä¸ç”¨æ‹…å¿ƒçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢\nsynchronizedå®é™…ä¸Šæ˜¯ç”¨å¯¹è±¡é”ä¿è¯äº†ä¸´ç•ŒåŒºå†…ä»£ç çš„åŸå­æ€§ï¼Œä¸´ç•ŒåŒºå†…çš„ä»£ç æ˜¯ä¸å¯åˆ†å‰²çš„ï¼Œä¸ä¼šè¢«çº¿ç¨‹åˆ‡æ¢æ‰€æ‰“æ–­\n\n\nè€ƒå¯Ÿsynchronizedé”ä½çš„æ˜¯å“ªä¸ªå¯¹è±¡1.é”ä½çš„æ˜¯n1-ï¼ˆthisï¼‰\n@Slf4j(topic = \"c.Number\")\nclass Number&#123;\n public synchronized void a() &#123;\n log.debug(\"1\");\n &#125;\n public synchronized void b() &#123;\n log.debug(\"2\");\n &#125;\n&#125;\npublic static void main(String[] args) &#123;\n Number n1 = new Number();\n new Thread(()->&#123; n1.a(); &#125;).start();\n new Thread(()->&#123; n1.b(); &#125;).start();\n&#125;\n\n2.è‹¥synchronizedåŠ åœ¨é™æ€æ–¹æ³•ä¸Šï¼Œåˆ™é”ä½çš„æ˜¯å½“å‰ç±»çš„è¿è¡Œæ—¶ç±»å¯¹è±¡ï¼ˆ.classï¼‰\n\n\nå˜é‡çš„çº¿ç¨‹å®‰å…¨åˆ†æï¼š\n1.æˆå‘˜å˜é‡å’Œé™æ€å˜é‡æ˜¯å¦çº¿ç¨‹å®‰å…¨ï¼Ÿå¦‚æœå®ƒä»¬æ²¡æœ‰è¢«å…±äº«ï¼Œåˆ™æ˜¯çº¿ç¨‹å®‰å…¨çš„\nå¦‚æœå®ƒä»¬è¢«å…±äº«äº†ï¼Œæ ¹æ®å®ƒä»¬çš„çŠ¶æ€æ˜¯å¦èƒ½è¢«æ”¹å˜ï¼Œåˆåˆ†ä¸ºä¸¤ç§æƒ…å†µ\nå¦‚æœåªæœ‰è¯»æ“ä½œï¼Œåˆ™çº¿ç¨‹å®‰å…¨\n\nå¦‚æœæœ‰è¯»å†™æ“ä½œï¼Œåˆ™è¿™æ®µä»£ç æ˜¯ä¸´ç•ŒåŒºï¼Œéœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨\n\n\n2.å±€éƒ¨å˜é‡æ˜¯å¦çº¿ç¨‹å®‰å…¨å±€éƒ¨å˜é‡æ˜¯çº¿ç¨‹å®‰å…¨çš„\nä½†å±€éƒ¨å˜é‡å¼•ç”¨çš„å¯¹è±¡åˆ™æœªå¿…\nå¦‚æœè¯¥å¯¹è±¡æ²¡æœ‰é€ƒç¦»æ–¹æ³•çš„ä½œç”¨è®¿é—®ã€‚å®ƒæ˜¯çº¿ç¨‹å®‰å…¨çš„\n\nå¦‚æœè¯¥å¯¹è±¡é€ƒç¦»æ–¹æ³•çš„ä½œç”¨èŒƒå›´ï¼Œéœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨ï¼ˆå¦‚ä½¿ç”¨returnï¼‰\n\n\n3.çº¿ç¨‹å®‰å…¨çš„å¤šä¸ªæ–¹æ³•ç»„åˆåœ¨ä¸€èµ·ä¸ä¸€å®šçº¿ç¨‹å®‰å…¨ï¼Œéœ€è¦åœ¨ç»„åˆæ–¹æ³•ä¸Šæ·»åŠ çº¿ç¨‹å®‰å…¨ä¿æŠ¤\n4.ä¸å¯å˜ç±»çº¿ç¨‹å®‰å…¨å¦‚Stringã€Integeréƒ½æ˜¯ä¸å¯å˜ç±»ï¼Œå†…éƒ¨çš„çŠ¶æ€ä¸å¯å˜ï¼Œå› æ­¤çº¿ç¨‹å®‰å…¨\n\n\njavaå¯¹è±¡çš„ç»“æ„ï¼š\n1.å¯¹è±¡å¤´ï¼šâ‘ ï¼šMark Wordï¼šhashcodeã€åˆ†ä»£å¹´é¾„ã€çŠ¶æ€ã€åŠ é”çŠ¶æ€ä½\n\nâ‘¡ï¼šKlass wordï¼šç±»å‹æŒ‡é’ˆï¼ˆä»€ä¹ˆç±»å‹çš„å¯¹è±¡ï¼‰\n\n\n2.å¯¹è±¡ä½“ï¼šæˆå‘˜å˜é‡çš„ä¿¡æ¯\n\n\nJava å¯¹è±¡å¤´ï¼šä»¥ 32 ä½è™šæ‹Ÿæœºä¸ºä¾‹\n\n64 ä½è™šæ‹Ÿæœº Mark Word\n\n\nMonitoræ¦‚å¿µMonitorè¢«ç¿»è¯‘ä¸ºç›‘è§†å™¨æˆ–è€…ç®¡ç¨‹\næ¯ä¸ªJavaå¯¹è±¡éƒ½å¯ä»¥å…³è”ä¸€ä¸ªMonitorå¯¹è±¡ï¼Œå¦‚æœä½¿ç”¨synchronizedç»™å¯¹è±¡ä¸Šé”ï¼ˆé‡é‡çº§ï¼‰ä¹‹åï¼Œè¯¥å¯¹è±¡å¤´çš„Mark Wordä¸­å°±è¢«è®¾ç½®æŒ‡å‘Monitorçš„æŒ‡é’ˆ\nMonitorç»“æ„å¦‚ä¸‹:\n\n1.åˆšå¼€å§‹Monitorç§Ownerä¸ºnull\n2.å½“Thread-2æ‰§è¡Œsynchronized(obj) å°±ä¼šå°†Monitorçš„æ‰€æœ‰è€…Ownerç½®ä¸ºThread-2ï¼ŒMonitorç§åªèƒ½æœ‰ä¸€ä¸ªOwner\n3ï¼Œåœ¨Thread-2ä¸Šé”çš„è¿‡ç¨‹ç§ï¼Œå¦‚æœThread-3ï¼Œ4ï¼Œ5ä¹Ÿæ¥æ‰§è¡Œsynchronized(obj) ï¼Œå°±ä¼šè¿›å…¥EntryList BLOCKED\n4.Thread-2æ‰§è¡Œå®ŒåŒæ­¥ä»£ç å—çš„å†…å®¹ï¼Œç„¶åå”¤é†’EntryListç§çš„ç­‰å¾…çº¿ç¨‹æ¥ç«äº‰é”ï¼Œç«äº‰æ˜¯éå…¬å¹³çš„\n5.å›¾ä¸­WaitSetç§çš„Thread-0ï¼ŒThread-1æ˜¯ä¹‹å‰è·å¾—è¿‡é”ï¼Œå½“æ¡ä»¶ä¸æ»¡è¶³WAITINGçŠ¶æ€çš„çº¿ç¨‹ï¼Œåé¢è®²wait-notify\næ—¶åˆ†æ\n**æ³¨æ„ï¼š**\n\nsynchronizedå¿…é¡»æ—¶è¿›å…¥åŒä¸€ä¸ªmonitoræ‰æœ‰ä¸Šè¿°æ•ˆæœ\n\nä¸åŠ synchronizedçš„å¯¹è±¡ä¸ä¼šå…³è”ç›‘è§†å™¨ï¼Œä¸éµä»ä»¥ä¸Šè§„åˆ™\n\n\nsynchronizedåŸç†è¿›é˜¶ï¼š\nè½»é‡çº§é”ï¼šä½¿ç”¨åœºæ™¯ï¼šå¦‚æœä¸€ä¸ªå¯¹è±¡è™½ç„¶æœ‰å¤šçº¿ç¨‹è®¿é—®ï¼Œä½†å¤šçº¿ç¨‹è®¿é—®çš„æ—¶é—´æ˜¯é”™å¼€çš„ï¼ˆä¹Ÿå°±æ˜¯æ²¡æœ‰ç«äº‰ï¼‰ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨è½»é‡çº§é”\nè½»é‡çº§é”å¯¹ä½¿ç”¨è€…æ˜¯é€æ˜çš„ï¼Œè¯­æ³•ä»ç„¶ä¸ºsynchronized\n1.åˆ›å»ºé”è®°å½•(Lock Record)ï¼Œæ¯ä¸ªçº¿ç¨‹çš„æ ˆå¸§éƒ½ä¼šåŒ…å«ä¸€ä¸ªé”çš„è®°å½•ï¼Œå†…å­˜å¯ä»¥å­˜å‚¨é”å¯¹è±¡çš„Mark Word\n\n\n2.è®©é”è®°å½•ä¸­Object reference æŒ‡å‘é”å¯¹è±¡ï¼Œå¹¶ä¸”å°è¯•ç”¨casæ›¿æ¢Objectä¸­çš„Mark Wordï¼Œå°†Mark Wordçš„å€¼å­˜å…¥é”è®°å½•ï¼ˆè‹¥Mark Wordå€¼å·²ç»è¢«å…¶ä»–çº¿ç¨‹æ‰€ä¿®æ”¹åˆ™æ›¿æ¢å¤±è´¥ï¼‰\n\n\n3.å¦‚æœcasæ›¿æ¢æˆåŠŸï¼Œå¯¹è±¡å¤´ä¸­å­˜å‚¨äº†é”è®°å½•åœ°å€å’ŒçŠ¶æ€ 00ï¼Œè¡¨ç¤ºç”±è¯¥çº¿ç¨‹ç»™å¯¹è±¡åŠ é”\n\n\n\nå¦‚æœcaså¤±è´¥ï¼š1.å…¶ä»–çº¿ç¨‹å·²ç»æŒæœ‰äº†è¯¥Objectçš„è½»é‡çº§é”ï¼Œæ­¤æ—¶è¡¨æ˜æœ‰ç«äº‰ï¼Œè¿›å…¥é”è†¨èƒ€è¿‡ç¨‹\n\n2.å¦‚æœæ˜¯è‡ªå·±æ‰§è¡Œäº†synchronizedé”é‡å…¥ï¼Œé‚£ä¹ˆå†æ·»åŠ ä¸€æ¡Lock Recordä½œä¸ºé‡å…¥çš„è®¡æ•°&lt;br /&gt;![1646820022734.png](https://cdn.nlark.com/yuque/0/2022/png/26737039/1647331695203-2b372579-5ee7-4efc-ae87-c2252e2679c6.png#clientId=u46ad077f-3ef3-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=ui&amp;id=lrT5o&amp;margin=%5Bobject%20Object%5D&amp;name=1646820022734.png&amp;originHeight=359&amp;originWidth=597&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=109184&amp;status=done&amp;style=none&amp;taskId=u75c465ef-1c37-456f-8a81-ec82f3f14d3&amp;title=)\n\n\nè§£é”ï¼š1.å½“é€€å‡ºsynchronizedä»£ç å—(è§£é”æ—¶) å¦‚æœæœ‰å–å€¼ä¸ºnullçš„é”è®°å½•ï¼Œè¡¨ç¤ºæœ‰é‡å…¥ï¼Œè¿™æ—¶é‡ç½®é”è®°å½•ï¼Œè¡¨ç¤ºé‡å…¥è®¡æ•°å‡1\n\n\n2.å½“é€€å‡ºsynchronizedä»£ç å—æ—¶ï¼Œé”è®°å½•çš„å€¼ä¸ä¸ºnullï¼Œè¿™æ˜¯ä½¿ç”¨caså°†Mark Wordçš„å€¼æ¢å¤ç»™å¯¹è±¡å¤´\n\n    æˆåŠŸï¼Œåˆ™è§£é”æˆåŠŸ\n\n    å¤±è´¥ï¼Œè¯´æ˜è½»é‡çº§é”è¿›è¡Œäº†é”è†¨èƒ€æˆ–å·²ç»å‡çº§ä¸ºé‡é‡çº§é”ï¼Œè¿›å…¥é‡é‡çº§é”è§£é”æµç¨‹\n\n\n\n2.é”è†¨èƒ€ï¼šå¦‚æœåœ¨å°è¯•åŠ è½»é‡çº§é”çš„è¿‡ç¨‹ä¸­ï¼ŒCASæ“ä½œæ— æ³•æˆåŠŸï¼Œè¿™æ—¶ä¸€ç§æƒ…å†µå°±æ˜¯æœ‰å…¶ä»–çº¿ç¨‹ä¸ºæ­¤å¯¹è±¡åŠ ä¸Šäº†è½»é‡çº§é”(æœ‰ç«äº‰)ï¼Œè¿™æ—¶éœ€è¦è¿›è¡Œé”è†¨èƒ€ï¼Œå°†è½»é‡çº§é”å˜ä¸ºé‡é‡çº§é”\n\n1.å½“Thread-1è¿›è¡Œè½»é‡çº§åŠ é”æ—¶ï¼ŒThread-0å·²ç»å¯¹è¯¥å¯¹è±¡åŠ äº†è½»é‡çº§é”\n\n2.è¿™æ—¶Thread-1åŠ è½»é‡çº§é”å¤±è´¥ï¼Œè¿›å…¥é”è†¨èƒ€æµç¨‹â‘ ï¼šå³ä¸ºObjectå¯¹è±¡ç”³è¯·Monitoré”ï¼Œè®©ObjectæŒ‡å‘é‡é‡çº§é”åœ°å€ï¼ˆåä¸¤ä½æ•°å­—å˜ä¸º10ï¼‰\n\nâ‘¡ï¼šç„¶åè‡ªå·±è¿›å…¥Monitorçš„EntryList BLOCKED\n\n\n\n3.å½“Thread-0é€€å‡ºåŒæ­¥å—è§£é”æ—¶ï¼Œä½¿ç”¨caså°†Mark Wordçš„å€¼æ¢å¤ç»™å¯¹è±¡å¤´ï¼Œå¤±è´¥ï¼Œè¿™æ—¶ä¼šè¿›å…¥é‡é‡çº§è§£é”æµç¨‹ï¼šå³æŒ‰ç…§Monitoråœ°å€æ‰¾åˆ°Monitorå¯¹è±¡ï¼Œå°†Ownerè®¾ç½®ä¸ºnullï¼Œå”¤é†’EntryListä¸­çš„BLOCKEDçº¿ç¨‹\n\n3.è‡ªæ—‹ä¼˜åŒ–ï¼šï¼ˆæ¯”è¾ƒé€‚åˆå¤šæ ¸CPUï¼‰é‡é‡çº§é”ç«äº‰çš„æ—¶å€™ï¼Œè¿˜å¯ä»¥ä½¿ç”¨è‡ªæ—‹æ¥è¿›è¡Œä¼˜åŒ–ï¼Œå¦‚æœå½“å‰çº¿ç¨‹è‡ªæ—‹æˆåŠŸï¼ˆå³è¿™æ—¶å€™æŒæœ‰é”çº¿ç¨‹å·²ç»é€€å‡ºäº†åŒæ­¥å—ï¼Œé‡Šæ”¾äº†é”ï¼‰ï¼Œè¿™æ—¶å½“å‰çº¿ç¨‹å°±å¯ä»¥é¿å…é˜»å¡ (é˜»å¡ä¼šå‘ç”Ÿä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œæ¶ˆè€—æ€§èƒ½)\nè‡ªæ—‹æˆåŠŸçš„æƒ…å†µï¼š\n\nè‡ªæ—‹å¤±è´¥çš„æƒ…å†µï¼š\n\næ³¨æ„ï¼š\n1.åœ¨java6ä¹‹åè‡ªæ—‹é”æ˜¯è‡ªé€‚åº”çš„ï¼Œæ¯”å¦‚å¯¹è±¡åˆšåˆšçš„ä¸€æ¬¡è‡ªé€‰æ“ä½œæˆåŠŸè¿‡ï¼Œé‚£ä¹ˆè®¤ä¸ºè¿™æ¬¡è‡ªæ—‹æˆåŠŸçš„å¯èƒ½æ€§ä¼šé«˜ï¼Œå°±ä¼šå¤šè‡ªæ—‹å‡ æ¬¡ï¼›åä¹‹ï¼Œå°±æ˜¯å°‘è‡ªæ—‹ç”šè‡³ä¸è‡ªæ—‹ï¼Œæ¯”è¾ƒåªèƒ½\n2.è‡ªæ—‹ä¼šå ç”¨CPUæ—¶é—´ï¼Œå•æ ¸CPUè‡ªæ—‹å°±æ˜¯æµªè´¹ï¼Œå¤šæ ¸CPUè‡ªæ—‹æ‰èƒ½å‘æŒ¥ä¼˜åŠ¿\n3.java 7 ä»¥åä¸èƒ½æ§åˆ¶æ˜¯å¦å¼€å¯è‡ªæ—‹åŠŸèƒ½\n\n\n4.åå‘é”ï¼šè½»é‡çº§é”åœ¨æ²¡æœ‰ç«äº‰æ—¶(å°±è‡ªå·±è¿™ä¸ªçº¿ç¨‹)ï¼Œæ¯æ¬¡é‡å…¥ä»ç„¶éœ€è¦æ‰§è¡ŒCASæ“ä½œï¼ˆæ€§èƒ½æŸè€—ï¼‰\njava6ä¸­å¼•å…¥äº†åå‘é”æ¥åšè¿›ä¸€æ­¥ä¼˜åŒ–ï¼šåªæœ‰ç¬¬ä¸€æ¬¡ä½¿ç”¨CASå°†çº¿ç¨‹IDè®¾ç½®åˆ°å¯¹è±¡çš„Mark Wordå¤´ï¼Œä¹‹åå‘ç°è¿™ä¸ªçº¿ç¨‹IDæ˜¯è‡ªå·±çš„å°±æ²¡æœ‰è¡¨ç¤ºç«äº‰ï¼Œä¸ç”¨é‡æ–°CASã€‚ä»¥ååªè¦ä¸å‘ç”Ÿç«äº‰ï¼Œè¿™ä¸ªå¯¹è±¡å°±å½’è¯¥çº¿ç¨‹æ‰€æœ‰\n\n\n4.1 åå‘çŠ¶æ€ï¼šå›å¿†å¯¹è±¡å¤´æ ¼å¼ï¼š\n\nä¸€ä¸ªå¯¹è±¡åˆ›å»ºæ—¶ï¼š\n1.å¦‚æœå¼€å¯äº†åå‘é”(é»˜è®¤å¼€å¯)ï¼Œé‚£ä¹ˆå¯¹è±¡åˆ›å»ºåï¼Œmarkwordå€¼çš„åä¸‰ä½ä¸º101(biased_lockå­—æ®µè¡¨ç¤ºæ˜¯å¦å¼€å¯åå‘é”ï¼Œ1ä¸ºå¼€å¯)ï¼Œæ­¤æ—¶ä»–çš„threadã€epocã€ageéƒ½ä¸º0\n\n2.åå‘é”æ˜¯é»˜è®¤å»¶è¿Ÿçš„ï¼Œä¸ä¼šåœ¨ç¨‹åºå¯åŠ¨æ—¶ç«‹å³ç”Ÿæ•ˆï¼Œå¦‚æœæƒ³é¿å…å»¶è¿Ÿï¼Œå¯ä»¥åŠ å‚æ•°æ¥ç¦ç”¨å»¶è¿Ÿ\n\n3.å¦‚æœæ²¡æœ‰å¼€å¯åå‘é”ï¼Œé‚£ä¹ˆå¯¹è±¡åˆ›å»ºåï¼Œmarkwordå€¼ä¸º001ï¼Œæ­¤æ—¶ä»–çš„hashcodeã€ageã€éƒ½ä¸º0ï¼Œç¬¬ä¸€æ¬¡ç”¨åˆ°hashcodeæ—¶æ‰ä¼šèµ‹å€¼\n\n4.å¤„äºåå‘é”çš„å¯¹è±¡è§£é”åï¼Œçº¿ç¨‹idä»å­˜å‚¨äºå¯¹è±¡å¤´ä¸­\n\næ³¨æ„ï¼š\nå½“æˆ‘ä»¬çš„ç¨‹åºæœ¬èº«å°±æ˜¯çº¿ç¨‹å¾ˆå¤šï¼Œé‚£ä¹ˆåå‘é”å°±ä¸é€‚ç”¨ï¼Œå¯ä»¥é€šè¿‡å‚æ•°æ¥ç¦ç”¨ï¼š\n\næ·»åŠ VMå‚æ•°ï¼š -xx:-UseBiasedLockingæ¥ç¦ç”¨åå‘é”\n\n\n4.2 æ’¤é”€åå‘é”â€”è°ƒç”¨å¯¹è±¡çš„hashcodeæ–¹æ³•å½“æˆ‘ä»¬è°ƒç”¨å¯¹è±¡çš„hashcodeæ–¹æ³•å°±ä¼šç¦ç”¨æ‰åå‘é”\nåŸå› ï¼šé€šè¿‡å¯¹è±¡å¤´çš„ç»“æ„å¯çŸ¥ï¼ŒMark Word çš„ç©ºé—´æ˜¯æœ‰é™çš„ï¼Œå½“æˆ‘ä»¬å¼€å¯åå‘é”ï¼Œå°±ä¼šå­˜å‚¨çº¿ç¨‹idï¼Œè€Œæ²¡æœ‰ç©ºé—´å­˜å‚¨hashcodeï¼Œæ‰€ä»¥æˆ‘ä»¬è°ƒç”¨hashcodeæ–¹æ³•ï¼Œå°±ä¼šå…³é—­åå‘é”ï¼Œæ¸…é™¤æ‰çº¿ç¨‹idæ›¿æ¢ä¸ºhashcode\n\nä¸ºä»€ä¹ˆè½»é‡çº§é”å’Œé‡é‡çº§é”ä¸ä¼šæœ‰ä¸Šè¿°é—®é¢˜ï¼Ÿ\nè½»é‡çº§é”ä¼šå­˜å‚¨åœ¨çº¿ç¨‹æ ˆå¸§çš„é”è®°å½•ä¸­\né‡é‡çº§é”ä¼šå°†hashcodeå­˜å‚¨åœ¨Monitorå¯¹è±¡ä¸­ï¼Œè§£é”æ—¶å†è¿›è¡Œè¿˜åŸ\nåªæœ‰åå‘é”æ²¡æœ‰é¢å¤–çš„ç©ºé—´ï¼Œæ‰€ä»¥ä¼šæœ‰ä¸Šè¿°é—®é¢˜\n\n\n4.3 æ’¤é”€åå‘é”â€”å…¶ä»–çº¿ç¨‹ä½¿ç”¨å¯¹è±¡å½“å…¶ä»–çº¿ç¨‹ä½¿ç”¨åå‘é”å¯¹è±¡æ—¶ï¼Œä¼šå°†åå‘é”å‡çº§ä¸ºè½»é‡çº§é”\n\n4.4 æ’¤é”€åå‘é”â€”è°ƒç”¨wait&#x2F;notifyåªæœ‰é‡é‡çº§é”æ‰æœ‰è¿™ä¸¤ä¸ªæ–¹æ³•ï¼Œæ‰€ä»¥è°ƒç”¨ä¼šå°†åå‘é”æˆ–è½»é‡çº§é”è½¬æ¢ä¸ºé‡é‡çº§é”\n\n4.5 æ‰¹é‡é‡åå‘å¦‚æœå¯¹è±¡è™½ç„¶è¢«å¤šä¸ªçº¿ç¨‹è®¿é—®ï¼Œä½†æ˜¯æ²¡æœ‰ç«äº‰ï¼Œè¿™æ—¶åå‘äº†çº¿ç¨‹T1çš„å¯¹è±¡ä»æœ‰æœºä¼šé‡æ–°åå‘T2ï¼Œé‡åå‘ä¼šé‡ç½®å¯¹è±¡çš„Thread ID(çº¿ç¨‹ID)\nå½“æ’¤é”€åå‘é”çš„é˜ˆå€¼è¶…è¿‡äº†20æ¬¡ï¼Œjvmä¼šè§‰å¾—æ˜¯ä¸æ˜¯åå‘é”™äº†å‘¢ï¼Ÿäºæ˜¯ä¼šç»™åœ¨è¿™äº›å¯¹è±¡åŠ é”æ—¶é‡æ–°åå‘è‡³åŠ é”çº¿ç¨‹\n\n4.6 æ‰¹é‡æ’¤é”€å½“æ’¤é”€åå‘é”çš„é˜ˆå€¼è¶…è¿‡äº†40æ¬¡ï¼Œjvmä¼šè§‰å¾—è‡ªå·±åå‘é”™äº†ï¼Œæ ¹æœ¬å°±ä¸è¯¥åå‘ï¼Œå°±ä¼šæŠŠæ•´ä¸ªç±»çš„æ‰€æœ‰å¯¹è±¡å˜ä¸ºä¸å¯åå‘çš„ï¼Œæ–°å»ºçš„å¯¹è±¡ä¹Ÿæ˜¯ä¸å¯åå‘çš„\n\n5.é”æ¶ˆé™¤javaè¿è¡Œæ—¶æœ‰ä¸€ä¸ªJITå³æ—¶ç¼–è¯‘å™¨ï¼Œä¼šå¯¹javaå­—èŠ‚ç è¿›ä¸€æ­¥ä¼˜åŒ–ï¼Œåå¤è¿è¡Œçš„ä»£ç è¶…è¿‡ä¸€å®šçš„é˜ˆå€¼å°±ä¼šè¿›è¡Œå³æ—¶ä¼˜åŒ–ï¼Œå½“å‘ç°å˜é‡ä¸ä¼šå­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼ŒJITå°±ä¼šæŠŠå¤šä½™çš„synchronizedå»æ‰\n\n\n6.é”çš„ç²—åŒ–public void test1()&#123;\n     for(int i=0;i&lt;1000;i++)&#123;\n         synchronized(Test.class)&#123;\n             sout(\"hello\");\n         &#125;\n     &#125;\n&#125;\né”ç²—åŒ–åï¼šæ‰©å¤§é”çš„èŒƒå›´ï¼Œé¿å…åå¤åŠ é”å’Œé‡Šæ”¾é”\npublic void test1()&#123;\n     synchronized(Test.class)&#123;\n         for(int i=0;i&lt;1000;i++)&#123;\n             sout(\"hello\");\n         &#125;\n     &#125;\n&#125;\n","slug":"synchronizedå…³é”®å­—","date":"2022-06-11T12:58:01.936Z","categories_index":"JUC","tags_index":"JUC,java,å¤šçº¿ç¨‹","author_index":"å°æä¸åœ¨_"},{"id":"dffb2abec4fa02f1174c155cbd8d7f1a","title":"javaçº¿ç¨‹","content":"javaçº¿ç¨‹\nåˆ›å»ºå’Œå¯åŠ¨çº¿ç¨‹1.new Threadï¼špublic static void test1() &#123;\n       Thread t = new Thread() &#123;\n           //æ‰§è¡Œçš„æ–¹æ³•\n           @Override\n           public void run() &#123;\n               log.debug(\"running\");\n           &#125;\n       &#125;;\n       //å‘½åçº¿ç¨‹\n       t.setName(\"t1\");\n       //å¯åŠ¨çº¿ç¨‹\n       t.start();\n   &#125;\n\n\n2.ä½¿ç”¨Runnableé…åˆThreadï¼ˆå°†éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡ä¸åˆ›å»ºçº¿ç¨‹åˆ†ç¦»ï¼Œæ›´çµæ´»ï¼‰public static void main(String[] args) &#123;\n   Runnable r = new Runnable() &#123;\n       @Override\n       public void run() &#123;\n          log.debug(\"running\");\n       &#125;\n   &#125;;\n    Thread t = new Thread(r, \"t2\");\n    t.start();\n&#125;\n\n\nåŸç†ï¼šThreadå’ŒRunnableçš„å…³ç³»æ–¹æ³•ä¸€ï¼šå®é™…ä¸Šæ˜¯æ‰‹åŠ¨é‡å†™äº†runæ–¹æ³•ï¼Œå°±ä¼šæ‰§è¡Œå­ç±»çš„runæ–¹æ³•\næ–¹æ³•äºŒï¼šåœ¨æ„é€ å™¨ä¸­ä¼ å…¥ä¸€ä¸ªRunnableå®ä¾‹ï¼Œå†…éƒ¨åœ¨åˆå§‹åŒ–æ–¹æ³•å°†runnableå®ä¾‹èµ‹å€¼ç»™äº†Threadä¸­çš„ä¸€ä¸ªæˆå‘˜å˜é‡ã€‚Threadç±»ä¸­çš„Runæ–¹æ³•ä¼šåˆ¤æ–­runnableå¯¹è±¡æ˜¯å¦ä¸ºnullï¼Œä¸ä¸ºnullå°±è¿è¡ŒThreadçš„runæ–¹æ³•\n\næ€»ç»“ï¼šæ–¹æ³•ä¸€å°±æ˜¯æŠŠçº¿ç¨‹å’Œä»»åŠ¡åˆå¹¶ï¼Œæ–¹æ³•äºŒå°±æ˜¯æŠŠçº¿ç¨‹å’Œä»»åŠ¡åˆ†å¼€äº†\n\nç”¨Runnableæ›´å®¹æ˜“ä¸çº¿ç¨‹æ± ç­‰é«˜çº§APIé…åˆ\n\nç”¨Runnableè®©ä»»åŠ¡è„±ç¦»äº†Threadç»§æ‰¿ä½“ç³»ï¼Œæ›´çµæ´»\n\n\n3.FutureTask é…åˆ ThreadFutureTask èƒ½å¤Ÿæ¥æ”¶ Callable ç±»å‹çš„å‚æ•°ï¼Œç”¨æ¥å¤„ç†æœ‰è¿”å›ç»“æœçš„æƒ…å†µ\npublic static void main(String[] args) throws Exception &#123;\n    // åˆ›å»ºä»»åŠ¡å¯¹è±¡\n    FutureTask&lt;Integer> task3 = new FutureTask&lt;>(() -> &#123;\n        log.debug(\"hello\");\n        return 100;\n    &#125;);\n    // å‚æ•°1 æ˜¯ä»»åŠ¡å¯¹è±¡; å‚æ•°2 æ˜¯çº¿ç¨‹åå­—ï¼Œæ¨è\n    new Thread(task3, \"t3\").start();\n    // ä¸»çº¿ç¨‹é˜»å¡ï¼ŒåŒæ­¥ç­‰å¾… task æ‰§è¡Œå®Œæ¯•çš„ç»“æœ\n    Integer result = task3.get();\n    log.debug(\"ç»“æœæ˜¯:&#123;&#125;\", result);\n&#125;\n\n\næŸ¥çœ‹è¿›ç¨‹çº¿ç¨‹çš„æ–¹æ³•\nwindowsä»»åŠ¡ç®¡ç†å™¨å¯ä»¥æŸ¥çœ‹è¿›ç¨‹å’Œçº¿ç¨‹æ•°ï¼Œä¹Ÿå¯ä»¥ç”¨æ¥æ€æ­»è¿›ç¨‹tasklist æŸ¥çœ‹è¿›ç¨‹taskkill æ€æ­»è¿›ç¨‹\n\nlinuxps -fe æŸ¥çœ‹æ‰€æœ‰è¿›ç¨‹ps -fT -p Â æŸ¥çœ‹æŸä¸ªè¿›ç¨‹ï¼ˆPIDï¼‰çš„æ‰€æœ‰çº¿ç¨‹kill æ€æ­»è¿›ç¨‹top æŒ‰å¤§å†™ H åˆ‡æ¢æ˜¯å¦æ˜¾ç¤ºçº¿ç¨‹top -H -p Â æŸ¥çœ‹æŸä¸ªè¿›ç¨‹ï¼ˆPIDï¼‰çš„æ‰€æœ‰çº¿ç¨‹\n\nJavajps å‘½ä»¤æŸ¥çœ‹æ‰€æœ‰ Java è¿›ç¨‹jstack Â æŸ¥çœ‹æŸä¸ª Java è¿›ç¨‹ï¼ˆPIDï¼‰çš„æ‰€æœ‰çº¿ç¨‹çŠ¶æ€jconsole æ¥æŸ¥çœ‹æŸä¸ª Java è¿›ç¨‹ä¸­çº¿ç¨‹çš„è¿è¡Œæƒ…å†µï¼ˆå›¾å½¢ç•Œé¢ï¼‰\njconsole è¿œç¨‹ç›‘æ§é…ç½®éœ€è¦ä»¥å¦‚ä¸‹æ–¹å¼è¿è¡Œä½ çš„ java ç±»\njava -Djava.rmi.server.hostname=`ipåœ°å€` -Dcom.sun.management.jmxremote -\nDcom.sun.management.jmxremote.port=`è¿æ¥ç«¯å£` -Dcom.sun.management.jmxremote.ssl=æ˜¯å¦å®‰å…¨è¿æ¥ -\nDcom.sun.management.jmxremote.authenticate=æ˜¯å¦è®¤è¯ javaç±»\n\nä¿®æ”¹ &#x2F;etc&#x2F;hosts æ–‡ä»¶å°† 127.0.0.1 æ˜ å°„è‡³ä¸»æœºåå¦‚æœè¦è®¤è¯è®¿é—®ï¼Œè¿˜éœ€è¦åšå¦‚ä¸‹æ­¥éª¤å¤åˆ¶ jmxremote.password æ–‡ä»¶ä¿®æ”¹ jmxremote.password å’Œ jmxremote.access æ–‡ä»¶çš„æƒé™ä¸º 600 å³æ–‡ä»¶æ‰€æœ‰è€…å¯è¯»å†™è¿æ¥æ—¶å¡«å…¥ controlRoleï¼ˆç”¨æˆ·åï¼‰ï¼ŒR&amp;Dï¼ˆå¯†ç ï¼‰\n\nçº¿ç¨‹è¿è¡ŒåŸç†æ ˆä¸æ ˆå¸§ï¼šJVMä¸­ç”±å †ï¼Œæ ˆï¼Œæ–¹æ³•åŒºæ‰€ç»„æˆï¼Œå…¶ä¸­æ ˆå†…å­˜å°±æ˜¯ç»™çº¿ç¨‹ä½¿ç”¨çš„ï¼Œæ¯ä¸ªçº¿ç¨‹å¯åŠ¨åï¼Œè™šæ‹Ÿæœºå°±ä¼šä¸ºå…¶åˆ†é…ä¸€å—æ ˆå†…å­˜\næ¯ä¸ªæ ˆç”±å¤šä¸ªæ ˆå¸§ç»„æˆï¼Œå¯¹åº”ç€æ¯æ¬¡æ–¹æ³•è°ƒç”¨æ‰€å ç”¨çš„å†…å­˜\n\næ¯ä¸ªçº¿ç¨‹åªèƒ½æœ‰ä¸€ä¸ªæ´»åŠ¨æ ˆå¸§ï¼Œå¯¹åº”ç€å½“å‰æ­£åœ¨æ‰§è¡Œçš„æ–¹æ³•\n\n\nçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼šä»ä½¿ç”¨CPUåˆ°ä¸ä½¿ç”¨CPUçš„çŠ¶æ€å°±æ˜¯ä¸€æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢\nå› ä¸ºä»¥ä¸‹ä¸€äº›åŸå› å¯¼è‡´ cpu ä¸å†æ‰§è¡Œå½“å‰çš„çº¿ç¨‹ï¼Œè½¬è€Œæ‰§è¡Œå¦ä¸€ä¸ªçº¿ç¨‹çš„ä»£ç \nçº¿ç¨‹çš„ cpu æ—¶é—´ç‰‡ç”¨å®Œ\n\nåƒåœ¾å›æ”¶\n\næœ‰æ›´é«˜ä¼˜å…ˆçº§çš„çº¿ç¨‹éœ€è¦è¿è¡Œ\n\nçº¿ç¨‹è‡ªå·±è°ƒç”¨äº† sleepã€yieldã€waitã€joinã€parkã€synchronizedã€lock ç­‰æ–¹æ³•\n\nå½“ Context Switch å‘ç”Ÿæ—¶ï¼Œéœ€è¦ç”±æ“ä½œç³»ç»Ÿä¿å­˜å½“å‰çº¿ç¨‹çš„çŠ¶æ€ï¼Œå¹¶æ¢å¤å¦ä¸€ä¸ªçº¿ç¨‹çš„çŠ¶æ€ï¼ŒJava ä¸­å¯¹åº”çš„æ¦‚å¿µå°±æ˜¯ç¨‹åºè®¡æ•°å™¨ï¼ˆProgram Counter Registerï¼‰ï¼Œå®ƒçš„ä½œç”¨æ˜¯è®°ä½ä¸‹ä¸€æ¡ jvm æŒ‡ä»¤çš„æ‰§è¡Œåœ°å€ï¼Œæ˜¯çº¿ç¨‹ç§æœ‰çš„\nçŠ¶æ€åŒ…æ‹¬ç¨‹åºè®¡æ•°å™¨ã€è™šæ‹Ÿæœºæ ˆä¸­æ¯ä¸ªæ ˆå¸§çš„ä¿¡æ¯ï¼Œå¦‚å±€éƒ¨å˜é‡ã€æ“ä½œæ•°æ ˆã€è¿”å›åœ°å€ç­‰\n\nContext Switch é¢‘ç¹å‘ç”Ÿä¼šå½±å“æ€§èƒ½\n\n\nå¸¸è§æ–¹æ³•ï¼š\n1.start å’Œ runï¼šstart()ï¼šå¯åŠ¨ä¸€ä¸ªæ–°çº¿ç¨‹ï¼Œåœ¨æ–°çš„çº¿ç¨‹è¿è¡Œ run æ–¹æ³•ä¸­çš„ä»£ç \n\n**æ³¨æ„ï¼š**start æ–¹æ³•åªæ˜¯è®©çº¿ç¨‹è¿›å…¥å°±ç»ªï¼Œé‡Œé¢ä»£ç ä¸ä¸€å®šç«‹åˆ»è¿è¡Œï¼ˆCPU çš„æ—¶é—´ç‰‡è¿˜æ²¡åˆ†ç»™å®ƒï¼‰ã€‚æ¯ä¸ªçº¿ç¨‹å¯¹è±¡çš„startæ–¹æ³•åªèƒ½è°ƒç”¨ä¸€æ¬¡ï¼Œå¦‚æœè°ƒç”¨äº†å¤šæ¬¡ä¼šå‡ºç°IllegalThreadStateException\n\nrun()ï¼šæ–°çº¿ç¨‹å¯åŠ¨åä¼šè°ƒç”¨çš„æ–¹æ³•\n\nå¦‚æœåœ¨æ„é€  Thread å¯¹è±¡æ—¶ä¼ é€’äº† Runnable å‚æ•°ï¼Œåˆ™çº¿ç¨‹å¯åŠ¨åä¼šè°ƒç”¨ Runnable ä¸­çš„ run æ–¹æ³•ï¼Œå¦åˆ™é»˜è®¤ä¸æ‰§è¡Œä»»ä½•æ“ä½œã€‚ä½†å¯ä»¥åˆ›å»º Thread çš„å­ç±»å¯¹è±¡ï¼Œæ¥è¦†ç›–é»˜è®¤è¡Œä¸º\n\n\n2.sleepå’Œyieldï¼šsleep\n\n1.è°ƒç”¨sleepä¼šè®©å½“å‰çº¿ç¨‹ä»Runningè¿›å…¥Timed WaitingçŠ¶æ€**ï¼ˆé˜»å¡ï¼‰**\n\n2.å…¶ä»–çº¿ç¨‹ä½¿ç”¨interruptæ–¹æ³•æ‰“æ–­æ­£åœ¨ç¡çœ çš„çº¿ç¨‹ï¼Œæ­¤æ—¶sleepæ–¹æ³•ä¼šæŠ›å‡ºInterrupedException\n\n3.ç¡çœ ç»“æŸåçš„çº¿ç¨‹æœªå¿…ä¼šç«‹å³æ‰§è¡Œ\n\n4.å»ºè®®ä½¿ç”¨TimeUnitçš„sleepä»£æ›¿Threadçš„sleepæ¥è·å¾—æ›´å¥½çš„å¯è¯»æ€§\n\nyield\n\n1.è°ƒç”¨yieldä¼šè®©å½“å‰çº¿ç¨‹ä»Runningè¿›å…¥Runnable**å°±ç»ª**çŠ¶æ€ï¼Œç„¶åè°ƒåº¦æ‰§è¡Œå…¶ä»–çº¿ç¨‹\n\n2.å…·ä½“çš„å®ç°ä¾èµ–äºæ“ä½œç³»ç»Ÿçš„ä»»åŠ¡è°ƒåº¦å™¨ï¼ˆå¯èƒ½æ²¡æœ‰å…¶ä»–çº¿ç¨‹ï¼Œè°ƒç”¨yieldåè¿˜æ˜¯ä¼šåˆ†ç»™å½“å‰çº¿ç¨‹ï¼‰\n\n\nåŒºåˆ«ï¼šæ“ä½œç³»ç»Ÿçš„æ—¶é—´è°ƒåº¦å™¨å¯ä»¥å°†cpuåˆ†é…ç»™å°±ç»ªçŠ¶æ€çš„çº¿ç¨‹ï¼Œä½†æ˜¯ä¸èƒ½åˆ†é…ç»™é˜»å¡çŠ¶æ€çš„çº¿ç¨‹\n\n3.ä¼˜å…ˆçº§ï¼šsetPriority() é»˜è®¤ä¸º5 èŒƒå›´æ˜¯1-10\n4.joinï¼šç­‰å¾…è°ƒç”¨joinçš„çº¿ç¨‹è¿è¡Œç»“æŸjoinå¯ä»¥æœ‰å‚æ•°ï¼Œè¡¨ç¤ºæœ€å¤šç­‰å¾…çš„æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰\nçº¿ç¨‹çš„åŒæ­¥ï¼ˆéœ€è¦ç­‰å¾…ç»“æœçš„è¿”å›ï¼‰\n\n\n5.interruptï¼šæ‰“æ–­æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹æ‰“æ–­ sleepï¼Œwaitï¼Œjoin çš„çº¿ç¨‹ä¼šé‡ç½®æ‰“æ–­æ ‡è®°ä¸ºfalse\nisInterrupted():å¯ä»¥è·å–æ‰“æ–­æ ‡è®°ï¼Œæ­£å¸¸è¿è¡Œçš„çº¿ç¨‹å¹¶ä¸ä¼šç›´æ¥è¢«æ‰“æ–­ï¼Œå¯é€šè¿‡æ‰“æ–­æ ‡è®°åˆ¤æ–­ï¼Œè‹¥è¢«æ‰“æ–­åˆ™ç»“æŸçº¿ç¨‹\ninterrupted():åˆ¤æ–­å®Œæ˜¯å¦è¢«æ‰“æ–­ä¹‹åï¼Œä¼šæ¸…æ¥šæ‰“æ–­æ ‡è®°ï¼ˆtrue-&gt;falseï¼‰\n\nå¤šçº¿ç¨‹è®¾è®¡æ¨¡å¼ä¹‹ä¸¤é˜¶æ®µç»ˆæ­¢ï¼šT1çº¿ç¨‹â€˜â€™ä¼˜é›…çš„â€˜â€™ç»ˆæ­¢çº¿ç¨‹T2 Â  ä¼˜é›…ï¼šç»™T2ä¸€ä¸ªåšå…¶ä»–äº‹æƒ…çš„æœºä¼šï¼ˆé€šè¿‡æˆ‘ä»¬å†™çš„ä»£ç ï¼‰\n\né”™è¯¯æ€è·¯\nä½¿ç”¨çº¿ç¨‹å¯¹è±¡çš„ stop() æ–¹æ³•åœæ­¢çº¿ç¨‹stop æ–¹æ³•ä¼šçœŸæ­£æ€æ­»çº¿ç¨‹ï¼Œå¦‚æœè¿™æ—¶çº¿ç¨‹é”ä½äº†å…±äº«èµ„æºï¼Œé‚£ä¹ˆå½“å®ƒè¢«æ€æ­»åå°±å†ä¹Ÿæ²¡æœ‰æœºä¼šé‡Šæ”¾é”ï¼Œå…¶å®ƒçº¿ç¨‹å°†æ°¸è¿œæ— æ³•è·å–é”\n\n\nä½¿ç”¨ System.exit(int) æ–¹æ³•åœæ­¢çº¿ç¨‹ç›®çš„ä»…æ˜¯åœæ­¢ä¸€ä¸ªçº¿ç¨‹ï¼Œä½†è¿™ç§åšæ³•ä¼šè®©æ•´ä¸ªç¨‹åºéƒ½åœæ­¢\n\n\nä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼ï¼š\n\n6.ä¸æ¨èä½¿ç”¨çš„æ–¹æ³•è¿™äº›æ–¹æ³•å·²è¿‡æ—¶ï¼Œå®¹æ˜“ç ´ååŒæ­¥ä»£ç å—ï¼Œé€ æˆçº¿ç¨‹æ­»é”\nstop() \t\t\t\t\t\tåœæ­¢çº¿ç¨‹è¿è¡Œ\nsuspend() \t\t\t\tæŒ‚èµ·ï¼ˆæš‚åœï¼‰çº¿ç¨‹è¿è¡Œ\nresume() \t\t\t\t\tæ¢å¤çº¿ç¨‹è¿è¡Œ\n\nä¸»çº¿ç¨‹å’Œå®ˆæŠ¤çº¿ç¨‹setDaemon(true)ï¼šè¡¨ç¤ºä¸ºå®ˆæŠ¤çº¿ç¨‹ Â \té»˜è®¤ä¸ºfalse\nå½“ä¸»çº¿ç¨‹ç»“æŸåã€‚å®ˆæŠ¤çº¿ç¨‹ä¼šè¢«å¼ºåˆ¶ç»“æŸ\njavaä¸­åƒåœ¾å›æ”¶å™¨å°±æ˜¯ä¸€ç§å®ˆæŠ¤çº¿ç¨‹\nTomcatä¸­çš„Acceptorä¸ªPollerçº¿ç¨‹éƒ½æ˜¯å®ˆæŠ¤çº¿ç¨‹ï¼Œæ‰€ä»¥Tomcatæ¥æ”¶åˆ°shutdownå‘½ä»¤åï¼Œä¸ä¼šç­‰å¾…å®ƒä»¬å¤„ç†å®Œå½“å‰è¯·æ±‚\n\nçº¿ç¨‹çš„5ç§çŠ¶æ€ï¼šè¿™æ˜¯ä»æ“ä½œç³»ç»Ÿå±‚é¢æ¥æè¿°çš„\nåˆå§‹çŠ¶æ€ï¼šä»…åœ¨è¯­è¨€å±‚é¢åˆ›å»ºäº†çº¿ç¨‹å¯¹è±¡ï¼Œè¿˜æœªä¸æ“ä½œç³»ç»Ÿçº¿ç¨‹å…³è”\nå¯è¿è¡ŒçŠ¶æ€ï¼šï¼ˆå°±ç»ªçŠ¶æ€ï¼‰æŒ‡è¯¥çº¿ç¨‹å·²ç»è¢«åˆ›å»ºï¼ˆä¸æ“ä½œç³»ç»Ÿçº¿ç¨‹å…³è”ï¼‰ï¼Œå¯ç”±CPUè°ƒåº¦æ‰§è¡Œ\nè¿è¡ŒçŠ¶æ€ï¼šæŒ‡è·å–äº†CPUæ—¶é—´ç‰‡è¿è¡Œä¸­çš„çŠ¶æ€\nå½“CPUæ—¶é—´ç‰‡ç”¨å®Œï¼Œä¼šä»è¿è¡ŒçŠ¶æ€è½¬æ¢è‡³å¯è¿è¡ŒçŠ¶æ€ï¼Œä¼šå¯¼è‡´çº¿ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢\n\né˜»å¡çŠ¶æ€ï¼š\nå¦‚æœè°ƒç”¨äº†é˜»å¡APIï¼Œæ¯”å¦‚BIOè¯»å†™æ–‡ä»¶ï¼Œè¿™æ—¶è¯¥çº¿ç¨‹å®é™…ä¸Šä¸ä¼šç”¨åˆ°CPUï¼Œä¼šå¯¼è‡´çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œè¿›å…¥é˜»å¡çŠ¶æ€\n\nç­‰BIOæ“ä½œå®Œæ¯•ï¼Œä¼šç”±æ“ä½œç³»ç»Ÿå”¤é†’é˜»å¡çš„çº¿ç¨‹ï¼Œè½¬æ¢è‡³ã€å¯è¿è¡ŒçŠ¶æ€ã€‘\n\nä¸ã€å¯è¿è¡ŒçŠ¶æ€ã€‘çš„åŒºåˆ«æ˜¯ï¼Œå¯¹äºé˜»å¡çŠ¶æ€çš„çº¿ç¨‹æ¥è¯´ï¼Œåªè¦å®ƒä»¬ä¸€ç›´ä¸å”¤é†’ï¼Œè°ƒåº¦å™¨å°±ä¸ä¼šè€ƒè™‘å®ƒä»¬\n\nç»ˆæ­¢çŠ¶æ€ï¼šè¡¨ç¤ºçº¿ç¨‹å·²ç»æ‰§è¡Œå®Œæ¯•ï¼Œç”Ÿå‘½å‘¨æœŸå·²ç»ç»“æŸï¼Œä¸ä¼šå†è½¬æ¢ä¸ºå…¶ä»–çŠ¶æ€\n\nçº¿ç¨‹çš„6ç§çŠ¶æ€\næ ¹æ®Thread Stateæšä¸¾ç±»çš„æè¿°ï¼Œè¿›è¡Œåˆ†ç±»\n\nNEWï¼šçº¿ç¨‹åˆšè¢«åˆ›å»ºï¼Œä½†æ˜¯è¿˜æ²¡è°ƒç”¨start()æ–¹æ³•\nRUNNABLEï¼šå½“è°ƒç”¨äº†start()æ–¹æ³•ä¹‹åï¼Œjava APIå±‚é¢çš„RUNNABLEçŠ¶æ€æ¶µç›–äº†æ“ä½œç³»ç»Ÿå±‚é¢çš„[å¯è¿è¡ŒçŠ¶æ€]ï¼Œ\n[è¿è¡ŒçŠ¶æ€]ã€[é˜»å¡çŠ¶æ€]ï¼ˆç”±äºBIOå¯¼è‡´çš„çº¿ç¨‹é˜»å¡ï¼Œåœ¨Javaé‡Œæ— æ³•åŒºåˆ†ï¼Œè®¤ä¸ºæ˜¯å¯è¿è¡Œçš„ï¼‰\nBLOCKED ï¼Œ WAITING ï¼Œ TIMED_WAITINGï¼šéƒ½æ˜¯ Java API å±‚é¢å¯¹ã€é˜»å¡çŠ¶æ€ã€‘çš„ç»†åˆ†ï¼Œåé¢ä¼šåœ¨çŠ¶æ€è½¬æ¢ä¸€èŠ‚\nè¯¦è¿°\nTERMINATEDï¼šå½“çº¿ç¨‹ä»£ç è¿è¡Œç»“æŸ\n","slug":"javaçº¿ç¨‹","date":"2022-06-11T12:49:10.748Z","categories_index":"JUC","tags_index":"JUC,java,å¤šçº¿ç¨‹","author_index":"å°æä¸åœ¨_"},{"id":"6ce63568dd0197dd5234fafddc6d369d","title":"è¿›ç¨‹çº¿ç¨‹å¹¶è¡Œå¹¶å‘","content":"\nè¿›ç¨‹å’Œçº¿ç¨‹ï¼š\nè¿›ç¨‹ï¼šèµ„æºåˆ†é…çš„æœ€å°å•ä½ç¨‹åºç”±æŒ‡ä»¤å’Œæ•°æ®ç»„æˆï¼Œä½†è¿™äº›æŒ‡ä»¤éœ€è¦è¿è¡Œï¼Œæ•°æ®è¦è¯»å†™ï¼Œå°±å¿…é¡»å°†æŒ‡ä»¤åŠ è½½åˆ°CPUï¼Œæ•°æ®åŠ è½½è‡³å†…å­˜ã€‚åœ¨æŒ‡ä»¤è¿è¡Œè¿‡ç¨‹ç§è¿˜é¡»éœ€è¦ç”¨åˆ°ç£ç›˜ï¼Œç½‘ç»œç­‰è®¾å¤‡ã€‚è¿›ç¨‹å°±æ˜¯ç”¨æ¥åŠ è½½æŒ‡ä»¤ï¼Œç®¡ç†å†…å­˜ï¼Œç®¡ç†IOçš„\n\nå½“ä¸€ä¸ªç¨‹åºè¢«è¿è¡Œï¼Œä»ç£ç›˜åŠ è½½è¿™ä¸ªç¨‹åºçš„ä»£ç åˆ°å†…å­˜ç§ï¼Œè¿™æ—¶å°±å¼€å¯äº†ä¸€ä¸ªè¿›ç¨‹\n\nè¿›ç¨‹å¯ä»¥ç†è§£ä¸ºç¨‹åºçš„ä¸€ä¸ªå®ä¾‹ã€‚å¤§éƒ¨åˆ†ç¨‹åºå¯ä»¥åŒæ—¶è¿è¡Œå¤šä¸ªè¿›ç¨‹ï¼ˆå¦‚è®°äº‹æœ¬ï¼Œæµè§ˆå™¨ç­‰ï¼‰ä½†ä¹Ÿæœ‰çš„ç¨‹åºåªèƒ½å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹ï¼ˆqqéŸ³ä¹ç­‰ï¼‰\n\n\nçº¿ç¨‹ï¼šjavaä¸­æœ€å°çš„è°ƒåº¦å•ä½ä¸€ä¸ªè¿›ç¨‹å†…å¯ä»¥åˆ†ä¸ºä¸€åˆ°å¤šä¸ªçº¿ç¨‹\n\nä¸€ä¸ªçº¿ç¨‹å°±æ˜¯ä¸€ä¸ªæŒ‡ä»¤æµï¼Œå°†æŒ‡ä»¤æµç§çš„ä¸€æ¡æ¡æŒ‡ä»¤ä»¥ä¸€å®šçš„é¡ºåºäº¤ç»™CPUæ‰§è¡Œ\n\njavaä¸­ï¼Œçº¿ç¨‹ä½œä¸ºæœ€å°è°ƒåº¦å•ä½ï¼Œè¿›ç¨‹ä½œä¸ºèµ„æºåˆ†é…çš„æœ€å°å•ä½ï¼Œåœ¨Windowsä¸­è¿›ç¨‹æ˜¯ä¸æ´»åŠ¨çš„ï¼Œåªæ˜¯ä½œä¸ºçº¿ç¨‹çš„å®¹å™¨\n\n\nå¯¹æ¯”ï¼š1.è¿›ç¨‹åŸºæœ¬ä¸Šæ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œè€Œçº¿ç¨‹å­˜åœ¨äºè¿›ç¨‹å†…ï¼Œæ˜¯è¿›ç¨‹çš„ä¸€ä¸ªå­é›†\n\n2.è¿›ç¨‹æ‹¥æœ‰å…±äº«çš„èµ„æºï¼Œå¦‚å†…å­˜ç©ºé—´ï¼Œä»…å…¶å†…éƒ¨çš„çº¿ç¨‹å…±äº«\n\n3.è¿›ç¨‹ä¹‹é—´çš„é€šä¿¡è¾ƒä¸ºå¤æ‚\n\n    â‘ .åŒä¸€å°è®¡ç®—æœºçš„è¿›ç¨‹é€šä¿¡ç§°ä¸ºIPC\n\n    â‘¡.ä¸åŒçš„è®¡ç®—æœºä¹‹é—´çš„è¿›ç¨‹é€šä¿¡ï¼Œéœ€è¦é€šè¿‡ç½‘ç»œï¼Œéµå®ˆå…±åŒçš„åè®®ï¼Œå¦‚HTTP\n\n4.çº¿ç¨‹çš„é€šä¿¡ç›¸å¯¹ç®€å•ï¼Œå› ä¸ºä»–ä»¬å…±äº«è¿›ç¨‹å†…çš„å†…å­˜ï¼Œä¸€ä¸ªä¾‹å­å°±æ˜¯å¤šä¸ªçº¿ç¨‹å¯ä»¥è®¿é—®åŒä¸€ä¸ªå…±äº«å˜é‡\n\n5.çº¿ç¨‹æ›´åŠ è½»é‡ï¼Œçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢æˆæœ¬ä¸€èˆ¬è¦æ¯”è¿›ç¨‹ä¸Šä¸‹æ–‡æˆæœ¬ä½\n\n\nå¹¶è¡Œå’Œå¹¶å‘ï¼šå•æ ¸CPUä¸‹ï¼Œçº¿ç¨‹å®é™…ä¸Šè¿˜æ˜¯ä¸²è¡Œæ‰§è¡Œçš„ï¼Œæ“ä½œç³»ç»Ÿä¸­æœ‰ä¸€ä¸ªç»„ä»¶å«åšä»»åŠ¡è°ƒåº¦å™¨ï¼Œå°†cpuçš„æ—¶é—´ç‰‡ï¼ˆå¾ˆçŸ­ï¼‰åˆ†ç»™ä¸åŒçš„çº¿ç¨‹ä½¿ç”¨ï¼Œç”±äºcpuåœ¨çº¿ç¨‹é—´çš„åˆ‡æ¢å¾ˆå¿«ï¼Œäººç±»æ„Ÿè§‰æ˜¯åŒæ—¶è¿è¡Œçš„ï¼Œæ€»ç»“å°±æ˜¯ï¼šå¾®è§‚ç©¿è¡Œï¼Œå®è§‚å¹¶è¡Œ\n\nä¸€èˆ¬ä¼šå°†è¿™ç§çº¿ç¨‹è½®æµä½¿ç”¨CPUçš„åšæ³•ç§°ä¸ºå¹¶å‘ï¼Œconcurrent\nå¤šæ ¸CPUä¸‹ï¼Œæ¯ä¸ªæ ¸éƒ½å¯ä»¥è°ƒåº¦è¿è¡Œçº¿ç¨‹ï¼Œè¿™æ—¶å€™çº¿ç¨‹æ˜¯å¹¶è¡Œçš„\nå¹¶å‘ï¼šåŒä¸€æ—¶é—´åº”å¯¹å¤šä»¶äº‹æƒ…çš„èƒ½åŠ›\n\n\nå¹¶è¡Œï¼šåŒä¸€æ—¶é—´åŠ¨æ‰‹å»åšå¤šä»¶äº‹æƒ…çš„èƒ½åŠ›\n\n\nåº”ç”¨ä¹‹å¼‚æ­¥è°ƒç”¨\nåŒæ­¥ï¼šéœ€è¦ç­‰å¾…ç»“æœè¿”å›ï¼Œæ‰èƒ½ç»§ç»­è¿è¡Œ\nå¼‚æ­¥ï¼šä¸éœ€è¦ç­‰å¾…ç»“æœè¿”å›å°±èƒ½ç»§ç»­è¿è¡Œ\n1) è®¾è®¡å¤šçº¿ç¨‹å¯ä»¥è®©æ–¹æ³•æ‰§è¡Œå˜ä¸ºå¼‚æ­¥çš„ï¼ˆå³ä¸è¦å·´å·´å¹²ç­‰ç€ï¼‰æ¯”å¦‚è¯´è¯»å–ç£ç›˜æ–‡ä»¶æ—¶ï¼Œå‡è®¾è¯»å–æ“ä½œèŠ±è´¹äº† 5 ç§’é’Ÿï¼Œå¦‚æœæ²¡æœ‰çº¿ç¨‹è°ƒåº¦æœºåˆ¶ï¼Œè¿™ 5 ç§’ cpu ä»€ä¹ˆéƒ½åšä¸äº†ï¼Œå…¶å®ƒä»£ç éƒ½å¾—æš‚åœâ€¦\n\n2) ç»“è®ºæ¯”å¦‚åœ¨é¡¹ç›®ä¸­ï¼Œè§†é¢‘æ–‡ä»¶éœ€è¦è½¬æ¢æ ¼å¼ç­‰æ“ä½œæ¯”è¾ƒè´¹æ—¶ï¼Œè¿™æ—¶å¼€ä¸€ä¸ªæ–°çº¿ç¨‹å¤„ç†è§†é¢‘è½¬æ¢ï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹tomcat çš„å¼‚æ­¥ servlet ä¹Ÿæ˜¯ç±»ä¼¼çš„ç›®çš„ï¼Œè®©ç”¨æˆ·çº¿ç¨‹å¤„ç†è€—æ—¶è¾ƒé•¿çš„æ“ä½œï¼Œé¿å…é˜»å¡ tomcat çš„å·¥ä½œçº¿ç¨‹ui ç¨‹åºä¸­ï¼Œå¼€çº¿ç¨‹è¿›è¡Œå…¶ä»–æ“ä½œï¼Œé¿å…é˜»å¡ ui çº¿ç¨‹\n","slug":"è¿›ç¨‹çº¿ç¨‹å¹¶è¡Œå¹¶å‘","date":"2022-06-11T12:36:30.645Z","categories_index":"JUC","tags_index":"JUC,java,å¤šçº¿ç¨‹","author_index":"å°æä¸åœ¨_"},{"id":"c1f6d722cc4602038235f2e7924e8ff2","title":"MySQLäº‹åŠ¡","content":"äº‹åŠ¡\näº‹åŠ¡çš„åŸºç¡€çŸ¥è¯†ï¼šåœ¨MySQLä¸­åªæœ‰InnoDBå­˜å‚¨å¼•æ“æ”¯æŒäº‹åŠ¡\n\n1.æ•°æ®åº“äº‹åŠ¡çš„æ¦‚è¿°ï¼šäº‹åŠ¡æ˜¯æ•°æ®åº“åŒºåˆ«äºæ–‡ä»¶ç³»ç»Ÿçš„é‡è¦ç‰¹å¾ä¹‹ä¸€ï¼Œå½“æˆ‘ä»¬æœ‰äº†äº‹åŠ¡å°±ä¼šè®©æ•°æ®åº“å§‹ç»ˆä¿æŒä¸€è‡´æ€§ï¼ŒåŒæ—¶æˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡äº‹åŠ¡çš„æœºåˆ¶æ¢å¤åˆ°æŸä¸ªæ—¶é—´ç‚¹\n\n\nåŸºæœ¬æ¦‚å¿µï¼šäº‹åŠ¡ï¼šæ˜¯ä¸€ç»„é€»è¾‘å•å…ƒï¼Œä½¿æ•°æ®ä»ä¸€ç§çŠ¶æ€è½¬æ¢åˆ°å¦ä¸€ç§çŠ¶æ€\näº‹åŠ¡å¤„ç†åŸåˆ™ï¼šä¿è¯æ‰€æœ‰äº‹åŠ¡ä½œä¸ºä¸€ä¸ªå·¥ä½œå•å…ƒæ¥æ‰§è¡Œï¼Œå³ä½¿å‡ºç°äº†æ•…éšœéƒ½ä¸èƒ½æ”¹å˜è¿™ç§æ‰§è¡Œæ–¹å¼ï¼Œä¸€ä¸ªäº‹åŠ¡ä¸­æ‰§è¡Œå¤šä¸ªæ“ä½œï¼Œè¦ä¹ˆéƒ½è¢«æäº¤ï¼Œè¦ä¹ˆå…¨éƒ¨æ”¾å¼ƒï¼Œå›æ»šåˆ°æœ€åˆçš„çŠ¶æ€\nå¦‚ï¼šè½¬è´¦æ“ä½œå°±æ˜¯ä¸€ä¸ªäº‹åŠ¡ï¼Œä¸èƒ½è®©é’±çš„æ€»é¢æ”¹å˜\n\näº‹åŠ¡çš„ACIDç‰¹å¾ï¼š\n1.åŸå­æ€§åŸå­æ€§æŒ‡äº‹åŠ¡æ˜¯ä¸€ä¸ªä¸å¯åˆ†å‰²çš„å·¥ä½œå•ä½ï¼Œè¦ä¹ˆå…¨éƒ¨æäº¤ï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥å›æ»š\n\n\n2.ä¸€è‡´æ€§ä¸€è‡´æ€§æ˜¯æŒ‡äº‹åŠ¡åœ¨æ‰§è¡Œå‰åï¼Œæ•°æ®ä»ä¸€ä¸ªåˆæ³•æ€§çŠ¶æ€ï¼Œå˜æ¢åˆ°å¦ä¸€ä¸ªåˆæ³•æ€§çš„çŠ¶æ€ï¼ˆæ»¡è¶³å®é™…è§„å®šï¼‰\n\nä¾‹å¦‚ï¼šAæœ‰100å…ƒï¼Œå»å–é’±ä¸èƒ½å¤šä½™100å…ƒï¼ˆå› ä¸ºè§„å®šé’±ä¸èƒ½ä¸ºè´Ÿæ•°ï¼‰\n\n            Aç»™Bè½¬è´¦ï¼Œè¦ä¿è¯Aå’ŒBçš„ä½™é¢æ€»æ•°è½¬è´¦å‰åç›¸åŒ\n\n\n3.éš”ç¦»æ€§æŒ‡ä¸€ä¸ªäº‹åŠ¡çš„æ‰§è¡Œä¸èƒ½è¢«å…¶ä»–äº‹åŠ¡å¹²æ‰°ï¼Œå³ä¸€ä¸ªäº‹åŠ¡å†…éƒ¨çš„æ“ä½œåŠä½¿ç”¨çš„æ•°æ®å¯¹å¹¶å‘çš„å…¶ä»–äº‹åŠ¡æ˜¯éš”ç¦»çš„ï¼Œå¹¶å‘æ‰§è¡Œçš„è¿‡ç¨‹ä¸­å„ä¸ªäº‹åŠ¡ä¹‹é—´ä¸èƒ½äº’ç›¸å¹²æ‰°\n\n\n4.æŒä¹…æ€§ä¸€æ—¦äº‹åŠ¡è¿›è¡Œäº†æäº¤ï¼Œåˆ™å¯¹æ•°æ®çš„æ”¹å˜æ˜¯æ°¸ä¹…æ€§çš„ï¼Œä¸ä¼šè¢«æ¥ä¸‹æ¥çš„å…¶ä»–æ“ä½œå½±å“\n\næŒä¹…æ€§æ˜¯é€šè¿‡äº‹åŠ¡æ—¥å¿—æ¥ä¿è¯çš„ï¼Œæ—¥å¿—åŒ…æ‹¬äº†é‡åšæ—¥å¿—å’Œå›æ»šæ—¥å¿—ï¼Œå½“æˆ‘ä»¬é€šè¿‡äº‹åŠ¡å¯¹æ•°æ®è¿›è¡Œä¿®æ”¹çš„æ—¶å€™ï¼Œé¦–å…ˆä¼šå°†æ•°æ®åº“çš„å˜åŒ–ä¿¡æ¯è®°å½•åˆ°é‡åšæ—¥å¿—ä¸­ï¼Œç„¶åå†å¯¹æ•°æ®åº“ä¸­å¯¹åº”çš„è¡Œè¿›è¡Œä¿®æ”¹ï¼Œè¿™æ ·çš„å¥½å¤„æ˜¯ï¼Œå³ä½¿æ•°æ®åº“å®•æœºï¼Œæ•°æ®åº“é‡å¯åä¹Ÿèƒ½æ‰¾åˆ°æ²¡æœ‰æ›´æ–°åˆ°æ•°æ®åº“ä¸­çš„é‡åšæ—¥å¿—ï¼Œé‡æ–°æ‰§è¡Œï¼Œä»è€Œä½¿äº‹åŠ¡å…·æœ‰æŒä¹…æ€§\n\næ€»ç»“ï¼šACIDæ˜¯äº‹åŠ¡çš„å››å¤§ç‰¹å¾ï¼ŒåŸå­æ€§æ˜¯åŸºç¡€ï¼Œéš”ç¦»æ€§æ˜¯æ‰‹æ®µï¼Œä¸€è‡´æ€§æ˜¯çº¦æŸæ¡ä»¶ï¼Œè€ŒæŒä¹…æ€§æ˜¯æˆ‘ä»¬çš„ç›®çš„\næ•°æ®åº“äº‹åŠ¡å…¶å®å°±æ˜¯æ•°æ®åº“æ“ä½œè€…ä¸ºäº†æ–¹ä¾¿ï¼ŒæŠŠéœ€è¦ä¿è¯åŸå­æ€§ï¼Œéš”ç¦»æ€§ï¼Œä¸€è‡´æ€§ï¼ŒæŒä¹…æ€§çš„ä¸€ä¸ªæˆ–å¤šä¸ªæ•°æ®åº“æ“ä½œæˆä¸ºä¸€ä¸ªäº‹åŠ¡\n\näº‹åŠ¡çš„çŠ¶æ€æ´»åŠ¨çš„ï¼šäº‹åŠ¡å¯¹åº”çš„æ•°æ®åº“æ“ä½œæ­£åœ¨æ‰§è¡Œä¸­\néƒ¨åˆ†æäº¤ï¼šäº‹åŠ¡æ“ä½œæ‰§è¡Œå®Œæˆï¼Œè¿˜æœªåˆ·ç›˜å°†æ•°æ®ä¿å­˜åˆ°ç£ç›˜\nå¤±è´¥çš„ï¼šäº‹åŠ¡å¤„äºæ´»åŠ¨æˆ–éƒ¨åˆ†æäº¤çŠ¶æ€æ—¶ï¼Œé‡åˆ°äº†ä¸€äº›é”™è¯¯å¯¼è‡´äº‹åŠ¡åœæ­¢æ‰§è¡Œ\nä¸­æ­¢çš„ï¼šå½“äº‹åŠ¡ä¸€éƒ¨åˆ†å˜ä¸ºå¤±è´¥çš„çŠ¶æ€ï¼Œå›æ»šåˆ°ä¹‹å‰çš„çŠ¶æ€ï¼Œå›æ»šå®Œæ¯•åæˆä¸ºäº‹åŠ¡ä¸­æ­¢çš„\næäº¤çš„ï¼šä¸€ä¸ªå¤„äºéƒ¨åˆ†æäº¤çš„çŠ¶æ€é€šè¿‡ä¿®æ”¹è¿‡çš„æ•°æ®åŒæ­¥åˆ°ç£ç›˜ä¸Š\n\n\nå¦‚ä½•ä½¿ç”¨äº‹åŠ¡ï¼Ÿ\näº‹åŠ¡çš„å®Œæ•´è¿‡ç¨‹ï¼š1.å¼€å¯äº‹åŠ¡\n2.ä¸€ç³»åˆ—çš„DMLæ“ä½œ\n3.äº‹åŠ¡çš„çŠ¶æ€ï¼šï¼ˆäº‹åŠ¡ç»“æŸï¼‰\n    æäº¤ï¼šCOMMIT\n\n    ä¸­æ­¢ï¼šROLLBACK\n\n\n1.æ˜¾å¼äº‹åŠ¡ä½¿ç”¨å…³é”®å­—å¼€å¯äº‹åŠ¡ï¼ˆä¸¤ç§æ–¹å¼ï¼‰\n\n    start transaction ï¼ˆä½¿ç”¨è¯¥æ–¹å¼å¯ä»¥è®¾ç½®æ˜¯å¦åªè¯»ï¼Ÿå¯ä»¥è¯»å†™ï¼ˆé»˜è®¤read writeï¼‰ï¼Ÿä¸€è‡´æ€§è¯»ï¼Ÿï¼‰\n\n    begin\n\nä¿å­˜ç‚¹ï¼ˆsavepointï¼‰å¯ä»¥æ§åˆ¶å›æ»šåˆ°ä¿å­˜ç‚¹è€Œä¸æ˜¯å›æ»šåˆ°æœ€åˆçŠ¶æ€\n\n\n2.éšå¼äº‹åŠ¡å…³é”®å­—ï¼šautocommitï¼ˆè‡ªåŠ¨æäº¤ï¼‰\né»˜è®¤å¼€å¯è‡ªåŠ¨æäº¤çš„çŠ¶æ€ä¸‹ï¼Œæˆ‘ä»¬çš„æ¯ä¸€ä¸ªDMLæ“ä½œéƒ½æ˜¯ä¸€ä¸ªéšå¼äº‹åŠ¡ï¼Œä¼šè‡ªåŠ¨æäº¤\nå¦‚æœæˆ‘ä»¬æ˜¾å¼çš„å¼€å¯äº†äº‹åŠ¡ï¼Œé‚£ä¹ˆDMLæ“ä½œå°±ä¸ä¼šè‡ªåŠ¨æäº¤æ•°æ®\n\néšå¼æäº¤æ•°æ®çš„æƒ…å†µï¼š1.æ•°æ®å®šä¹‰è¯­è¨€ï¼ˆDDLï¼‰CREATEã€ALTERã€DROPç­‰æ“ä½œ\n2.ä½¿ç”¨æˆ–ä¿®æ”¹MySQLæ•°æ®åº“ä¸­çš„è¡¨ï¼Œå¦‚ï¼šALTER USERã€CREATE USERç­‰\n3.äº‹åŠ¡æ§åˆ¶æˆ–å…³äºé”å®šçš„è¯­å¥\nå½“ä¸€ä¸ªäº‹åŠ¡è¿˜æ²¡è¿›è¡Œæäº¤æˆ–å›æ»šæ“ä½œæ—¶ï¼Œåˆæ˜¾å¼çš„å¼€å¯äº†ä¸€ä¸ªäº‹åŠ¡ï¼Œé‚£ä¹ˆä¼šéšå¼æäº¤ä¸Šä¸€ä¸ªäº‹åŠ¡\n\nå½“å‰çš„autocommitç³»ç»Ÿå˜é‡çš„å€¼ä¸ºOFFï¼Œæ‰‹åŠ¨å˜ä¸ºONä¼šéšå¼æäº¤å‰é¢è¯­å¥çš„äº‹åŠ¡\n\nä½¿ç”¨LOCK TABLESç­‰å…³äºé”å®šè¯­å¥ä¹Ÿä¼šéšå¼æäº¤å‰é¢è¯­å¥æ‰€å±çš„äº‹åŠ¡\n\n4.åŠ è½½æ•°æ®çš„è¯­å¥\nä½¿ç”¨LOAD DATAè¯­å¥æ¥æ‰¹é‡å‘æ•°æ®åº“ä¸­å¯¼å…¥æ•°æ®æ—¶ï¼Œä¹Ÿä¼šéšå¼çš„æäº¤å‰é¢è¯­å¥æ‰€å±çš„äº‹åŠ¡\n\n5.å…³äºMySQLå¤åˆ¶çš„ä¸€äº›è¯­å¥\nä½¿ç”¨START SLAVEã€STOP SLAVEã€RESET SLAVEç­‰è¯­å¥ä¹Ÿä¼šéšå¼çš„æäº¤å‰é¢è¯­å¥æ‰€å±çš„äº‹åŠ¡\n\n6.ä¸€äº›å…¶ä»–è¯­å¥\nä½¿ç”¨ANALYZE TABLEï¼ˆåˆ†æè¡¨ï¼‰ æ£€æŸ¥è¡¨ï¼Œä¼˜åŒ–è¡¨ç­‰æ“ä½œä¹Ÿä¼šéšå¼çš„æäº¤å‰é¢è¯­å¥æ‰€å±çš„äº‹åŠ¡\n\n\n\næ•°æ®å¹¶å‘é—®é¢˜ï¼š\n1.è„å†™å¯¹äºä¸¤ä¸ªäº‹åŠ¡Aï¼ŒBï¼Œå¦‚æœäº‹åŠ¡Aä¿®æ”¹äº†å¦ä¸€ä¸ªäº‹åŠ¡Bä¿®æ”¹è¿‡çš„æ•°æ®ï¼Œé‚£å°±è¯´æ˜å‘ç”Ÿäº†è„å†™\n\n\n2.è„è¯»äº‹åŠ¡Aè¯»å–äº†å·²ç»è¢«äº‹åŠ¡Bæ›´æ–°ä½†è¿˜æœªæäº¤çš„æ•°æ®ï¼Œå¦‚æœäº‹åŠ¡Bè¿›è¡Œå›æ»šï¼Œé‚£ä¹ˆAè¯»å–çš„å†…å®¹å°±æ˜¯ä¸´æ—¶ä¸”æ— æ•ˆçš„\n\n\n3.ä¸å¯é‡å¤è¯»äº‹åŠ¡Aè¯»å–äº†ä¸€ä¸ªå­—æ®µï¼Œç„¶åäº‹åŠ¡Bæ›´æ–°äº†è¯¥å­—æ®µï¼Œä¹‹åäº‹åŠ¡Aå†æ¬¡è¿›è¡Œè¯»å–ï¼Œå‘ç°æ•°æ®æ”¹å˜äº†\n\n\n4.å¹»è¯»äº‹åŠ¡Aä»ä¸€ä¸ªè¡¨ä¸­è¯»å–äº†ä¸€ä¸ªå­—æ®µï¼Œç„¶åäº‹åŠ¡Båœ¨è¯¥è¡¨ä¸­æ’å…¥äº†ä¸€äº›æ–°çš„è¡Œï¼Œä¹‹åäº‹åŠ¡Aå†æ¬¡è¯»å–åŒä¸€ä¸ªè¡¨ï¼Œå°±ä¼šå¤šå‡ºå‡ è¡Œ\n\n\näº‹åŠ¡çš„éš”ç¦»çº§åˆ«ï¼šï¼ˆéš”ç¦»çº§åˆ«è¶Šé«˜ï¼Œå¹¶å‘æ€§è¶Šå·®ï¼‰1.è¯»æœªæäº¤ï¼šè§£å†³è„å†™\n2.è¯»å·²æäº¤ï¼šè§£å†³è„è¯»ã€è„å†™\n3.å¯é‡å¤è¯»ï¼šè§£å†³è„å†™ï¼Œè„è¯»ï¼Œä¸å¯é‡å¤è¯» ï¼ˆMySQLé»˜è®¤ï¼‰\n4.å¯ä¸²è¡ŒåŒ–ï¼šå‡è§£å†³\n\näº‹åŠ¡æ—¥å¿—ï¼šäº‹åŠ¡çš„éš”ç¦»æ€§æ˜¯ç”±é”æœºåˆ¶å®ç°\nè€Œäº‹åŠ¡çš„åŸå­æ€§ï¼Œä¸€è‡´æ€§ï¼ŒæŒä¹…æ€§ç”±äº‹åŠ¡çš„redoæ—¥å¿—undoæ—¥å¿—æ¥ä¿è¯\nREDO LOG é‡åšæ—¥å¿—ï¼Œæä¾›å†å†™å…¥æ“ä½œï¼Œæ¢å¤æäº¤äº‹åŠ¡ä¿®æ”¹çš„é¡µæ“ä½œï¼Œç”¨æ¥ä¿è¯äº‹åŠ¡çš„æŒä¹…æ€§\n\nUNDO LOG Â å›æ»šæ—¥å¿—ï¼Œå›æ»šè¡Œè®°å½•åˆ°æŸä¸ªç‰¹å®šç‰ˆæœ¬ï¼Œç”¨æ¥ä¿è¯äº‹åŠ¡çš„åŸå­æ€§å’Œä¸€ç›´æ€§\n\n\n\nREDOæ—¥å¿—çš„ä¼˜ç‚¹å’Œç‰¹ç‚¹ï¼šä¼˜ç‚¹ï¼š\n1.redoæ—¥å¿—é™ä½äº†åˆ·ç›˜é¢‘ç‡\n\n2.redoæ—¥å¿—å ç”¨çš„ç©ºé—´éå¸¸å°\n\nç‰¹ç‚¹ï¼š\n\nredoæ—¥å¿—æ˜¯é¡ºåºå†™å…¥ç£ç›˜çš„åœ¨æ‰§è¡Œäº‹åŠ¡çš„è¿‡ç¨‹ä¸­ï¼Œæ¯æ‰§è¡Œä¸€æ¡è¯­å¥ï¼Œå°±å¯èƒ½äº§ç”Ÿè‹¥å¹²æ¡redoæ—¥å¿—ï¼Œè¿™äº›æ—¥å¿—æ˜¯æŒ‰ç…§äº§ç”Ÿçš„é¡ºåºå†™å…¥ç£ç›˜çš„ï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨é¡ºåºIOï¼Œæ•ˆç‡æ¯”éšæœºIOå¿«\n\n\näº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œredo log ä¸æ–­è®°å½•redo logæ˜¯å­˜å‚¨å¼•æ“å±‚äº§ç”Ÿçš„ï¼Œè€Œbin logæ˜¯æ•°æ®åº“å±‚äº§ç”Ÿçš„ï¼Œåœ¨ä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œä¸€ç›´ä¸æ–­çš„å‘redo logé¡ºåºè®°å½•ï¼Œè€Œbin logç›´åˆ°äº‹åŠ¡æäº¤æ‰ä¼šä¸€æ¬¡æ€§å†™å…¥bin logæ–‡ä»¶ä¸­\n\n\nUNDOæ—¥å¿—undo log çš„äº§ç”Ÿä¹Ÿä¼šä¼´éšç€redo logçš„äº§ç”Ÿï¼Œå› ä¸ºundo logä¹Ÿéœ€è¦æŒä¹…æ€§çš„ä¿æŠ¤\n\nä½œç”¨ï¼š1.å›æ»šæ•°æ®\n2.MVCC\n","slug":"äº‹åŠ¡","date":"2022-06-11T12:25:00.191Z","categories_index":"MySQL","tags_index":"MySQL,äº‹åŠ¡","author_index":"å°æä¸åœ¨_"},{"id":"55817b11714364db5e90bcd7c8c20421","title":"MySQLä¸­çš„é”","content":"\nMySQLä¸­çš„é”åœ¨æ•°æ®åº“ä¸­ï¼Œé™¤ä¼ ç»Ÿçš„è®¡ç®—èµ„æºï¼ˆå¦‚CPUã€RAMã€I&#x2F;Oç­‰ï¼‰çš„äº‰ç”¨ä»¥å¤–ï¼Œæ•°æ®ä¹Ÿæ˜¯ä¸€ç§ä¾›è®¸å¤šç”¨æˆ·å…±äº«çš„èµ„æºã€‚ä¸ºä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ï¼Œéœ€è¦å¯¹ å¹¶å‘æ“ä½œè¿›è¡Œæ§åˆ¶ ï¼Œå› æ­¤äº§ç”Ÿäº† é” ã€‚åŒæ—¶ é”æœºåˆ¶ ä¹Ÿä¸ºå®ç°MySQLçš„å„ä¸ªéš”ç¦»çº§åˆ«æä¾›äº†ä¿è¯ã€‚ é”å†²çªä¹Ÿæ˜¯å½±å“æ•°æ®åº“å¹¶å‘è®¿é—®æ€§èƒ½çš„ä¸€ä¸ªé‡è¦å› ç´ ã€‚æ‰€ä»¥é”å¯¹æ•°æ®åº“è€Œè¨€æ˜¾å¾—å°¤å…¶é‡è¦ï¼Œä¹Ÿæ›´åŠ å¤æ‚ã€‚\n\nå¹¶å‘é—®é¢˜çš„è§£å†³æ–¹æ¡ˆï¼š1.è¯»æ“ä½œåˆ©ç”¨MVCC(å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶)ï¼Œå†™æ“ä½œè¿›è¡ŒåŠ é”\n2.è¯»å†™å‡è¿›è¡ŒåŠ é”ï¼ˆè¯»-å†™ Â å½¼æ­¤éœ€è¦æ’é˜Ÿæ‰§è¡Œï¼Œå½±å“æ€§èƒ½ï¼‰\n\nåˆ†ç±»ï¼š\n\n1.ä»æ•°æ®æ“ä½œç±»å‹åˆ†ç±»ï¼šè¯»é”ã€å†™é”ï¼šè¯»é”ï¼šä¹Ÿç§°å…±äº«é”ã€‚æˆ–Sé” é’ˆå¯¹åŒä¸€ä»½æ•°æ®ï¼Œå¤šä¸ªäº‹åŠ¡çš„è¯»æ“ä½œå¯ä»¥åŒæ—¶è¿›è¡Œè€Œä¸ä¼šäº’ç›¸å½±å“ä¹Ÿä¸ä¼šäº’ç›¸é˜»å¡\n\nå†™é”ï¼šä¹Ÿç§°æ’ä»–é”ã€‚æˆ–Xé” å½“å‰å†™æ“ä½œæ²¡å®Œæˆå‰ï¼Œä¼šé˜»æ–­å…¶ä»–å†™é”å’Œè¯»é”ï¼Œç¡®ä¿ç»™å®šçš„æ—¶é—´ä¸­ï¼Œåªæœ‰ä¸€ä¸ªäº‹åŠ¡å¯ä»¥æ‰§è¡Œ\n\næ³¨æ„ï¼šå¯¹äºInnoDBæ¥è¯´ï¼Œè¯»é”å’Œå†™é”å¯ä»¥åŠ åœ¨è¡¨ä¸Šï¼Œä¹Ÿå¯ä»¥åŠ åœ¨è¡Œä¸Šï¼ŒMyISAMä¸èƒ½åŠ åœ¨è¡Œä¸Š\n\n2.ä»æ•°æ®æ“ä½œçš„ç²’åº¦åˆ’åˆ†ï¼šè¡¨çº§é”ï¼Œé¡µçº§é”ï¼Œè¡Œé”ä¸ºäº†å°½å¯èƒ½çš„æé«˜æ•°æ®åº“çš„å¹¶å‘åº¦ï¼Œæ¯æ¬¡é”å®šçš„æ•°æ®çš„èŒƒå›´è¶Šå°è¶Šå¥½ï¼Œç†è®ºä¸Šæ¯æ¬¡åªé”å®šå½“å‰æ“ä½œçš„æ•°æ®çš„æ–¹æ¡ˆä¼šå¾—åˆ°æœ€å¤§çš„å¹¶å‘åº¦ï¼Œä½†æ˜¯ç®¡ç†é”å¾ˆè€—è´¹èµ„æºï¼Œå› æ­¤æ•°æ®åº“ç³»ç»Ÿéœ€è¦åœ¨é«˜å¹¶å‘å“åº”å’Œç³»ç»Ÿæ€§èƒ½ä¸¤ä¸ªæ–¹é¢è¿›è¡Œå¹³è¡¡ï¼Œè¿™å°±æ˜¯é”ç²’åº¦çš„æ¦‚å¿µ\n\nè¡¨é”ï¼šé”å®šæ•´å¼ è¡¨ï¼Œæ˜¯MySQLæœ€åŸºæœ¬çš„é”ç­–ç•¥ï¼Œå¯ä»¥é¿å…æ­»é”ï¼Œä½†æ˜¯å¹¶å‘é‡å¤§å¤§é™ä½\n\nâ‘  è¡¨çº§åˆ«çš„Sé”å’ŒXé”ï¼ˆä¸å»ºè®®åœ¨InnoDBä¸­ä½¿ç”¨ï¼‰\nâ‘¡ æ„å‘é”ï¼šä¸éœ€è¦æ˜¾ç¤ºçš„æ·»åŠ InnoDBæ”¯æŒå¤šç²’åº¦é”ï¼Œå…è®¸è¡Œçº§é”å’Œè¡¨çº§é”å…±å­˜\n1.æ„å‘é”çš„å­˜åœ¨æ˜¯ä¸ºäº†åè°ƒè¡Œé”å’Œè¡¨é”çš„å…³ç³»ï¼Œæ”¯æŒå¤šç²’åº¦ï¼ˆè¡¨é”å’Œè¡Œé”ï¼‰çš„é”å…±å­˜\n2.æ„å‘é”æ˜¯ä¸€ç§ä¸ä¸è¡Œçº§é”å†²çªçš„è¡¨çº§é”\n3.è¡¨æ˜æŸä¸ªäº‹åŠ¡æ­£åœ¨æŸäº›è¡ŒæŒæœ‰äº†é”æˆ–è€…è¯¥äº‹åŠ¡å‡†å¤‡å»æŒæœ‰é”\n\næ„å‘é”åˆ†ä¸ºä¸¤ç§ï¼š1.æ„å‘å…±äº«é”ï¼šäº‹åŠ¡æœ‰æ„å¯¹è¡¨ä¸­çš„æŸäº›è¡ŒåŠ å…±äº«é”\n\n2.æ„å‘æ’ä»–é”ï¼šäº‹åŠ¡æœ‰æ„å¯¹è¡¨ä¸­çš„æŸäº›è¡ŒåŠ æ’ä»–é”\n\n\næ„å‘é”éœ€è¦è§£å†³çš„é—®é¢˜ï¼šå¦‚æœæˆ‘ä»¬ç»™æŸä¸€è¡Œæ•°æ®åŠ äº†æ’ä»–é”ï¼Œæ•°æ®åº“ä¼šè‡ªåŠ¨ç»™æ›´å¤§ä¸€çº§çš„ç©ºé—´ï¼Œæ¯”å¦‚æ•°æ®é¡µæˆ–æ•°æ®è¡¨åŠ ä¸Šæ„å‘é”ï¼Œå‘Šè¯‰å…¶ä»–äººè¿™ä¸ªæ•°æ®é¡µæˆ–æ•°æ®è¡¨å·²ç»æœ‰äººä¸Šè¿‡æ’ä»–é”äº†\n\nâ‘¢ è‡ªå¢é”ï¼ˆä¿è¯ä¸»é”®å”¯ä¸€æ€§ï¼‰\nâ‘£ å…ƒæ•°æ®é”ï¼ˆMDLé”ï¼‰ï¼šä¸éœ€è¦æ˜¾ç¤ºçš„æ·»åŠ å½“å¯¹ä¸€ä¸ªè¡¨åšå¢åˆ æ”¹æŸ¥æ“ä½œçš„æ—¶å€™ï¼ŒåŠ MDLè¯»é”ï¼Œå½“è¦å¯¹è¡¨ç»“æ„å˜æ›´æ“ä½œçš„æ—¶å€™ï¼ŒåŠ MDLå†™é”\n\nInnoDBä¸­è¡Œé”ï¼šåªåœ¨å­˜å‚¨å¼•æ“å±‚å®ç°ä¼˜ç‚¹ï¼šé”çš„åŠ›åº¦å°ï¼Œå‘ç”Ÿé”å†²çªçš„æ¦‚ç‡ä½ï¼Œå¯ä»¥å®ç°é«˜å¹¶å‘\nç¼ºç‚¹ï¼šå¯¹äºé”çš„å¼€é”€æ¯”è¾ƒå¤§ï¼ŒåŠ é”ä¼šæ¯”è¾ƒæ…¢ï¼Œå®¹æ˜“å‡ºç°æ­»é”\nInnoDBä¸MyISAMæœ€å¤§çš„åŒºåˆ«ï¼šä¸€æ˜¯æ”¯æŒäº‹åŠ¡ï¼ŒäºŒæ˜¯æ”¯æŒè¡Œçº§é”\n\nâ‘  è®°å½•é”ï¼šä»…ä»…æŠŠä¸€æ¡è®°å½•é”ä¸Šï¼ˆåŒæ ·æœ‰Så’ŒXä¸¤ç§é”ï¼‰\nâ‘¡ é—´éš™é”ï¼ˆgapé”ï¼‰ï¼šä»…ä»…ä¸ºäº†æ–¹å¼æ’å…¥å¹»å½±è®°å½•ï¼Œå‡ºç°å¹»è¯»ï¼Œåœ¨æŸä¸ªåŒºé—´èŒƒå›´åŠ é”\né—´éš™é”å¯èƒ½ä¼šå¯¼è‡´æ­»é”ä¸¤ä¸ªäº‹åŠ¡é”å®šäº†ç»Ÿä¸€ä¸ªèŒƒå›´ï¼Œå°±ä¼šå¯¼è‡´å‡ä¸èƒ½å¯¹è¯¥èŒƒå›´è¿›è¡Œæ“ä½œ\n\n\nâ‘¢ ä¸´é”®é”ï¼šç›¸å½“äºå‰ä¸¤ç§é”çš„åˆä½“ï¼Œç›¸å½“äºç»™é—´éš™é”åŠ ä¸Šä¸€ä¸ªé—­åŒºé—´\nâ‘£ æ’å…¥æ„å‘é”ï¼šä¸€ä¸ªäº‹åŠ¡åœ¨æ’å…¥ä¸€æ¡è®°å½•çš„æ—¶å€™éœ€è¦åˆ¤æ–­ä¸€ä¸‹æ’å…¥çš„ä½ç½®æ˜¯å¦è¢«åˆ«çš„äº‹åŠ¡åŠ äº†gapé”ï¼Œè‹¥æœ‰åˆ™éœ€è¦ç­‰å¾…ï¼Œç›´åˆ°é‚£ä¸€ä¸ªäº‹åŠ¡è¿›è¡Œæäº¤,ä½†æ˜¯InnoDBè§„å®šäº‹åŠ¡åœ¨ç­‰å¾…çš„æ—¶å€™é¡µéœ€è¦åœ¨å†…å­˜ä¸­ç”Ÿæˆä¸€ä¸ªé”ç»“æ„ï¼Œå°±æ˜¯æ’å…¥æ„å‘é”\n\næ’å…¥æ„å‘é”æ˜¯ä¸€ç§gapé”ï¼Œå¹¶ä¸æ˜¯æ„å‘é”ï¼Œåœ¨insertæ“ä½œæ—¶äº§ç”Ÿ\n\n\né¡µé”ï¼šé¡µé”çš„å¼€é”€ä»‹äºè¡¨é”å’Œè¡Œé”ä¹‹é—´ï¼Œä¹Ÿä¼šå‡ºç°æ­»é”ï¼Œå¹¶å‘åº¦ä¸€èˆ¬\n\n\n3.ä»å¯¹å¾…é”çš„æ€åº¦åˆ†ç±»ï¼šä¹è§‚é”å’Œæ‚²è§‚é”ï¼ˆä¸¤ç§è®¾è®¡æ€æƒ³ï¼Œå¹¶ä¸æ˜¯å…·ä½“å®ç°ï¼‰\n\n\næ‚²è§‚é”ï¼ˆPessimistic Lockingï¼‰æ‚²è§‚é”æ˜¯ä¸€ç§æ€æƒ³ï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯å¾ˆæ‚²è§‚ï¼Œå¯¹æ•°æ®è¢«å…¶ä»–äº‹åŠ¡çš„ä¿®æ”¹æŒä¿å®ˆæ€åº¦ï¼Œä¼šé€šè¿‡æ•°æ®åº“è‡ªèº«çš„é”æœºåˆ¶æ¥å®ç°ï¼Œä»è€Œä¿è¯æ•°æ®æ“ä½œçš„æ’å®ƒæ€§ã€‚æ‚²è§‚é”æ€»æ˜¯å‡è®¾æœ€åçš„æƒ…å†µï¼Œæ¯æ¬¡å»æ‹¿æ•°æ®çš„æ—¶å€™éƒ½è®¤ä¸ºåˆ«äººä¼šä¿®æ”¹ï¼Œæ‰€ä»¥æ¯æ¬¡åœ¨æ‹¿æ•°æ®çš„æ—¶å€™éƒ½ä¼šä¸Šé”ï¼Œè¿™æ ·åˆ«äººæƒ³æ‹¿è¿™ä¸ªæ•°æ®å°±ä¼š é˜»å¡ ç›´åˆ°å®ƒæ‹¿åˆ°é”ï¼ˆå…±äº«èµ„æºæ¯æ¬¡åªç»™ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨ï¼Œå…¶å®ƒçº¿ç¨‹é˜»å¡ï¼Œç”¨å®Œåå†æŠŠèµ„æºè½¬è®©ç»™å…¶å®ƒçº¿ç¨‹ï¼‰ã€‚æ¯”å¦‚è¡Œé”ï¼Œè¡¨é”ç­‰ï¼Œè¯»é”ï¼Œå†™é”ç­‰ï¼Œéƒ½æ˜¯åœ¨åšæ“ä½œä¹‹å‰å…ˆä¸Šé”ï¼Œå½“å…¶ä»–çº¿ç¨‹æƒ³è¦è®¿é—®æ•°æ®æ—¶ï¼Œéƒ½éœ€è¦é˜»å¡æŒ‚èµ·ã€‚Javaä¸­ synchronized å’Œ ReentrantLock ç­‰ç‹¬å é”å°±æ˜¯æ‚²è§‚é”æ€æƒ³çš„å®ç°ã€‚\n\n\n\nä¹è§‚é”ï¼ˆOptimistic Lockingï¼‰ä¹è§‚é”è®¤ä¸ºå¯¹åŒä¸€æ•°æ®çš„å¹¶å‘æ“ä½œä¸ä¼šæ€»å‘ç”Ÿï¼Œå±äºå°æ¦‚ç‡äº‹ä»¶ï¼Œä¸ç”¨æ¯æ¬¡éƒ½å¯¹æ•°æ®ä¸Šé”ï¼Œä½†æ˜¯åœ¨æ›´æ–°çš„æ—¶å€™ä¼šåˆ¤æ–­ä¸€ä¸‹åœ¨æ­¤æœŸé—´åˆ«äººæœ‰æ²¡æœ‰å»æ›´æ–°è¿™ä¸ªæ•°æ®ï¼Œä¹Ÿå°±æ˜¯ä¸é‡‡ç”¨æ•°æ®åº“è‡ªèº«çš„é”æœºåˆ¶ï¼Œè€Œæ˜¯é€šè¿‡ç¨‹åºæ¥å®ç°ã€‚åœ¨ç¨‹åºä¸Šï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨ ç‰ˆæœ¬å·æœºåˆ¶ æˆ–è€… CASæœºåˆ¶ å®ç°ã€‚ä¹è§‚é”é€‚ç”¨äºå¤šè¯»çš„åº”ç”¨ç±»å‹ï¼Œè¿™æ ·å¯ä»¥æé«˜ååé‡ã€‚åœ¨Javaä¸­ java.util.concurrent.atomic åŒ…ä¸‹çš„åŸå­å˜é‡ç±»å°±æ˜¯ä½¿ç”¨äº†ä¹è§‚é”begin;select * from student where id &lt;&#x3D;8 and id &gt; 3 for update;çš„ä¸€ç§å®ç°æ–¹å¼ï¼šCASå®ç°çš„ã€‚\n\nä¹è§‚é”çš„ç‰ˆæœ¬å·æœºåˆ¶åœ¨è¡¨ä¸­è®¾è®¡ä¸€ä¸ª ç‰ˆæœ¬å­—æ®µ version ï¼Œç¬¬ä¸€æ¬¡è¯»çš„æ—¶å€™ï¼Œä¼šè·å– version å­—æ®µçš„å–å€¼ã€‚ç„¶åå¯¹æ•°æ®è¿›è¡Œæ›´æ–°æˆ–åˆ é™¤æ“ä½œæ—¶ï¼Œä¼šæ‰§è¡Œ UPDATE â€¦ SET version&#x3D;version+1 WHERE version&#x3D;version ã€‚æ­¤æ—¶å¦‚æœå·²ç»æœ‰äº‹åŠ¡å¯¹è¿™æ¡æ•°æ®è¿›è¡Œäº†æ›´æ”¹ï¼Œä¿®æ”¹å°±ä¸ä¼šæˆåŠŸã€‚\n\nä¹è§‚é”çš„æ—¶é—´æˆ³æœºåˆ¶æ—¶é—´æˆ³å’Œç‰ˆæœ¬å·æœºåˆ¶ä¸€æ ·ï¼Œä¹Ÿæ˜¯åœ¨æ›´æ–°æäº¤çš„æ—¶å€™ï¼Œå°†å½“å‰æ•°æ®çš„æ—¶é—´æˆ³å’Œæ›´æ–°ä¹‹å‰å–å¾—çš„æ—¶é—´æˆ³è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœä¸¤è€…ä¸€è‡´åˆ™æ›´æ–°æˆåŠŸï¼Œå¦åˆ™å°±æ˜¯ç‰ˆæœ¬å†²çªã€‚ä½ èƒ½çœ‹åˆ°ä¹è§‚é”å°±æ˜¯ç¨‹åºå‘˜è‡ªå·±æ§åˆ¶æ•°æ®å¹¶å‘æ“ä½œçš„æƒé™ï¼ŒåŸºæœ¬æ˜¯é€šè¿‡ç»™æ•°æ®è¡Œå¢åŠ ä¸€ä¸ªæˆ³ï¼ˆç‰ˆæœ¬å·æˆ–è€…æ—¶é—´æˆ³ï¼‰ï¼Œä»è€Œè¯æ˜å½“å‰æ‹¿åˆ°çš„æ•°æ®æ˜¯å¦æœ€æ–°ã€‚\n\n\n\nä¸¤ç§é”çš„é€‚ç”¨åœºæ™¯ä»è¿™ä¸¤ç§é”çš„è®¾è®¡æ€æƒ³ä¸­ï¼Œæˆ‘ä»¬æ€»ç»“ä¸€ä¸‹ä¹è§‚é”å’Œæ‚²è§‚é”çš„é€‚ç”¨åœºæ™¯ï¼š\nä¹è§‚é” é€‚åˆ è¯»æ“ä½œå¤š çš„åœºæ™¯ï¼Œç›¸å¯¹æ¥è¯´å†™çš„æ“ä½œæ¯”è¾ƒå°‘ã€‚å®ƒçš„ä¼˜ç‚¹åœ¨äº ç¨‹åºå®ç° ï¼Œ ä¸å­˜åœ¨æ­»é”é—®é¢˜ï¼Œä¸è¿‡é€‚ç”¨åœºæ™¯ä¹Ÿä¼šç›¸å¯¹ä¹è§‚ï¼Œå› ä¸ºå®ƒé˜»æ­¢ä¸äº†é™¤äº†ç¨‹åºä»¥å¤–çš„æ•°æ®åº“æ“ä½œã€‚\næ‚²è§‚é” é€‚åˆ å†™æ“ä½œå¤š çš„åœºæ™¯ï¼Œå› ä¸ºå†™çš„æ“ä½œå…·æœ‰ æ’å®ƒæ€§ ã€‚é‡‡ç”¨æ‚²è§‚é”çš„æ–¹å¼ï¼Œå¯ä»¥åœ¨æ•°æ®åº“å±‚é¢é˜»æ­¢å…¶ä»–äº‹åŠ¡å¯¹è¯¥æ•°æ®çš„æ“ä½œæƒé™ï¼Œé˜²æ­¢ è¯» - å†™ å’Œ å†™ - å†™ çš„å†²çª\n\n4.æŒ‰ç…§åŠ é”çš„æ–¹å¼è¿›è¡Œåˆ’åˆ†ï¼šæ˜¾å¼é”å’Œéšå¼é”\n5.å…¨å±€é”é”å®šæ•´ä¸ªæ•°æ®åº“ï¼Œå½“ä½ éœ€è¦è®©æ•´ä¸ªæ•°æ®åº“å¤„äºåªè¯»çŠ¶æ€ï¼Œå…¶ä»–çº¿ç¨‹çš„DMLå’ŒDDLæ“ä½œä¼šè¢«é˜»å¡ï¼Œå…¨å±€é”çš„å…¸å‹ä½¿ç”¨åœºæ™¯æ˜¯ï¼šåšå…¨åº“é€»è¾‘å¤‡ä»½\n\n6.æ­»é”ä¸¤ä¸ªäº‹åŠ¡éƒ½æŒæœ‰å¯¹æ–¹éœ€è¦çš„é”ï¼Œå¹¶ä¸”åœ¨ç­‰å¾…å¯¹æ–¹é‡Šæ”¾ï¼Œå¹¶ä¸”åŒæ–¹éƒ½ä¸ä¼šé‡Šæ”¾è‡ªå·±çš„é”\nå¦‚ä½•å¤„ç†æ­»é”ï¼Ÿ\n1.ç­‰å¾…ï¼Œç›´åˆ°è¶…æ—¶ï¼ˆå¯ä»¥è®¾ç½®è¶…æ—¶æ—¶é—´ï¼‰\n2.æ­»é”çš„æ£€æµ‹æœºåˆ¶ï¼ˆwait-for grapç®—æ³•ï¼‰\n\nå¦‚ä½•é¿å…æ­»é”ï¼š1.åˆç†è®¾è®¡ç´¢å¼•ï¼Œæ˜¯ä¸šåŠ¡SQLå°½å¯èƒ½é€šè¿‡ç´¢å¼•å®šä½æ›´å°‘çš„è¡Œï¼Œå‡å°‘é”ç«äº‰\n2.è°ƒæ•´ä¸šåŠ¡é€»è¾‘SQLæ‰§è¡Œé¡ºåºï¼Œé¿å…æ›´æ–°&#x2F;åˆ é™¤é•¿æ—¶é—´æŒæœ‰é”çš„SQLåœ¨äº‹åŠ¡å‰é¢\n3.é¿å…å¤§äº‹åŠ¡ï¼Œå¯ä»¥å°†å¤§äº‹åŠ¡æ‹†åˆ†æˆå¤šä¸ªå°äº‹åŠ¡æ¥è¿›è¡Œå¤„ç†ï¼Œå°äº‹åŠ¡ç¼©çŸ­é”å®šèµ„æºçš„æ—¶é—´ï¼Œå‘ç”Ÿé”å†²çªçš„å‡ ç‡æ›´å°\n4.åœ¨å¹¶å‘æ¯”è¾ƒé«˜çš„ç³»ç»Ÿä¸­ï¼Œä¸è¦æ˜¾ç¤ºçš„åŠ é”ï¼Œç‰¹åˆ«æ˜¯åœ¨äº‹åŠ¡ä¸­æ˜¾ç¤ºåŠ é”\n5.é™ä½éš”ç¦»çº§åˆ«\n\nç»“æ„è§£æï¼š\n\né”æ‰€åœ¨çš„äº‹åŠ¡ä¿¡æ¯ ï¼šä¸è®ºæ˜¯ è¡¨é” è¿˜æ˜¯ è¡Œé” ï¼Œéƒ½æ˜¯åœ¨äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ç”Ÿæˆçš„ï¼Œå“ªä¸ªäº‹åŠ¡ç”Ÿæˆäº†è¿™ä¸ª é”ç»“æ„ ï¼Œè¿™é‡Œå°±è®°å½•è¿™ä¸ªäº‹åŠ¡çš„ä¿¡æ¯ã€‚æ­¤ é”æ‰€åœ¨çš„äº‹åŠ¡ä¿¡æ¯ åœ¨å†…å­˜ç»“æ„ä¸­åªæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œé€šè¿‡æŒ‡é’ˆå¯ä»¥æ‰¾åˆ°å†…å­˜ä¸­å…³äºè¯¥äº‹åŠ¡çš„æ›´å¤šä¿¡æ¯ï¼Œæ¯”æ–¹è¯´äº‹åŠ¡idç­‰ã€‚ \nç´¢å¼•ä¿¡æ¯ ï¼šå¯¹äº è¡Œé” æ¥è¯´ï¼Œéœ€è¦è®°å½•ä¸€ä¸‹åŠ é”çš„è®°å½•æ˜¯å±äºå“ªä¸ªç´¢å¼•çš„ã€‚è¿™é‡Œä¹Ÿæ˜¯ä¸€ä¸ªæŒ‡é’ˆã€‚ \nè¡¨é”ï¼è¡Œé”ä¿¡æ¯ ï¼šè¡¨é”ç»“æ„ å’Œ è¡Œé”ç»“æ„ åœ¨è¿™ä¸ªä½ç½®çš„å†…å®¹æ˜¯ä¸åŒçš„ï¼šè¡¨é”ï¼šè®°è½½ç€æ˜¯å¯¹å“ªä¸ªè¡¨åŠ çš„é”ï¼Œè¿˜æœ‰å…¶ä»–çš„ä¸€äº›ä¿¡æ¯ã€‚è¡Œé”ï¼šè®°è½½äº†ä¸‰ä¸ªé‡è¦çš„ä¿¡æ¯ï¼šSpace ID ï¼šè®°å½•æ‰€åœ¨è¡¨ç©ºé—´ã€‚Page Number ï¼šè®°å½•æ‰€åœ¨é¡µå·ã€‚n_bits ï¼šå¯¹äºè¡Œé”æ¥è¯´ï¼Œä¸€æ¡è®°å½•å°±å¯¹åº”ç€ä¸€ä¸ªæ¯”ç‰¹ä½ï¼Œä¸€ä¸ªé¡µé¢ä¸­åŒ…å«å¾ˆå¤šè®°å½•ï¼Œç”¨ä¸åŒçš„æ¯”ç‰¹ä½æ¥åŒºåˆ†åˆ°åº•æ˜¯å“ªä¸€æ¡è®°å½•åŠ äº†é”ã€‚ä¸ºæ­¤åœ¨è¡Œé”ç»“æ„çš„æœ«å°¾æ”¾ç½®äº†ä¸€å †æ¯”ç‰¹ä½ï¼Œè¿™ä¸ªn_bits å±æ€§ä»£è¡¨ä½¿ç”¨äº†å¤šå°‘æ¯”ç‰¹ä½ã€‚n_bitsçš„å€¼ä¸€èˆ¬éƒ½æ¯”é¡µé¢ä¸­è®°å½•æ¡æ•°å¤šä¸€äº›ã€‚ä¸»è¦æ˜¯ä¸ºäº†ä¹‹ååœ¨é¡µé¢ä¸­æ’å…¥äº†æ–°è®°å½•åä¹Ÿä¸è‡³äºé‡æ–°åˆ†é…é”ç»“æ„ \ntype_mode ï¼šè¿™æ˜¯ä¸€ä¸ª32ä½çš„æ•°ï¼Œè¢«åˆ†æˆäº† lock_mode ã€ lock_type å’Œ rec_lock_type ä¸‰ä¸ªéƒ¨åˆ†ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š\n\né”çš„æ¨¡å¼ï¼ˆ lock_mode ï¼‰ï¼Œå ç”¨ä½4ä½ï¼Œå¯é€‰çš„å€¼å¦‚ä¸‹ï¼šLOCK_IS ï¼ˆåè¿›åˆ¶çš„ 0 ï¼‰ï¼šè¡¨ç¤ºå…±äº«æ„å‘é”ï¼Œä¹Ÿå°±æ˜¯ ISé” ã€‚LOCK_IX ï¼ˆåè¿›åˆ¶çš„ 1 ï¼‰ï¼šè¡¨ç¤ºç‹¬å æ„å‘é”ï¼Œä¹Ÿå°±æ˜¯ IXé” ã€‚LOCK_S ï¼ˆåè¿›åˆ¶çš„ 2 ï¼‰ï¼šè¡¨ç¤ºå…±äº«é”ï¼Œä¹Ÿå°±æ˜¯ Sé” ã€‚LOCK_X ï¼ˆåè¿›åˆ¶çš„ 3 ï¼‰ï¼šè¡¨ç¤ºç‹¬å é”ï¼Œä¹Ÿå°±æ˜¯ Xé” ã€‚LOCK_AUTO_INC ï¼ˆåè¿›åˆ¶çš„ 4 ï¼‰ï¼šè¡¨ç¤º AUTO-INCé” ã€‚åœ¨InnoDBå­˜å‚¨å¼•æ“ä¸­ï¼ŒLOCK_ISï¼ŒLOCK_IXï¼ŒLOCK_AUTO_INCéƒ½ç®—æ˜¯è¡¨çº§é”çš„æ¨¡å¼ï¼ŒLOCK_Så’ŒLOCK_Xæ—¢å¯ä»¥ç®—æ˜¯è¡¨çº§é”çš„æ¨¡å¼ï¼Œä¹Ÿå¯ä»¥æ˜¯è¡Œçº§é”çš„æ¨¡å¼ã€‚é”çš„ç±»å‹ï¼ˆ lock_type ï¼‰ï¼Œå ç”¨ç¬¬5ï½8ä½ï¼Œä¸è¿‡ç°é˜¶æ®µåªæœ‰ç¬¬5ä½å’Œç¬¬6ä½è¢«ä½¿ç”¨ï¼šLOCK_TABLE ï¼ˆåè¿›åˆ¶çš„ 16 ï¼‰ï¼Œä¹Ÿå°±æ˜¯å½“ç¬¬5ä¸ªæ¯”ç‰¹ä½ç½®ä¸º1æ—¶ï¼Œè¡¨ç¤ºè¡¨çº§é”ã€‚LOCK_REC ï¼ˆåè¿›åˆ¶çš„ 32 ï¼‰ï¼Œä¹Ÿå°±æ˜¯å½“ç¬¬6ä¸ªæ¯”ç‰¹ä½ç½®ä¸º1æ—¶ï¼Œè¡¨ç¤ºè¡Œçº§é”ã€‚è¡Œé”çš„å…·ä½“ç±»å‹ï¼ˆ rec_lock_type ï¼‰ï¼Œä½¿ç”¨å…¶ä½™çš„ä½æ¥è¡¨ç¤ºã€‚åªæœ‰åœ¨ lock_type çš„å€¼ä¸ºLOCK_REC æ—¶ï¼Œä¹Ÿå°±æ˜¯åªæœ‰åœ¨è¯¥é”ä¸ºè¡Œçº§é”æ—¶ï¼Œæ‰ä¼šè¢«ç»†åˆ†ä¸ºæ›´å¤šçš„ç±»å‹ï¼šLOCK_ORDINARY ï¼ˆåè¿›åˆ¶çš„ 0 ï¼‰ï¼šè¡¨ç¤º next-keyé” ã€‚LOCK_GAP ï¼ˆåè¿›åˆ¶çš„ 512 ï¼‰ï¼šä¹Ÿå°±æ˜¯å½“ç¬¬10ä¸ªæ¯”ç‰¹ä½ç½®ä¸º1æ—¶ï¼Œè¡¨ç¤º gapé” ã€‚LOCK_REC_NOT_GAP ï¼ˆåè¿›åˆ¶çš„ 1024 ï¼‰ï¼šä¹Ÿå°±æ˜¯å½“ç¬¬11ä¸ªæ¯”ç‰¹ä½ç½®ä¸º1æ—¶ï¼Œè¡¨ç¤ºæ­£ç» è®°å½•é” ã€‚LOCK_INSERT_INTENTION ï¼ˆåè¿›åˆ¶çš„ 2048 ï¼‰ï¼šä¹Ÿå°±æ˜¯å½“ç¬¬12ä¸ªæ¯”ç‰¹ä½ç½®ä¸º1æ—¶ï¼Œè¡¨ç¤ºæ’å…¥æ„å‘é”ã€‚å…¶ä»–çš„ç±»å‹ï¼šè¿˜æœ‰ä¸€äº›ä¸å¸¸ç”¨çš„ç±»å‹æˆ‘ä»¬å°±ä¸å¤šè¯´äº†ã€‚is_waiting å±æ€§å‘¢ï¼ŸåŸºäºå†…å­˜ç©ºé—´çš„èŠ‚çœï¼Œæ‰€ä»¥æŠŠ is_waiting å±æ€§æ”¾åˆ°äº† type_mode è¿™ä¸ª32ä½çš„æ•°å­—ä¸­ï¼šLOCK_WAIT ï¼ˆåè¿›åˆ¶çš„ 256 ï¼‰ ï¼šå½“ç¬¬9ä¸ªæ¯”ç‰¹ä½ç½®ä¸º 1 æ—¶ï¼Œè¡¨ç¤º is_waiting ä¸º true ï¼Œä¹Ÿå°±æ˜¯å½“å‰äº‹åŠ¡å°šæœªè·å–åˆ°é”ï¼Œå¤„åœ¨ç­‰å¾…çŠ¶æ€ï¼›å½“è¿™ä¸ªæ¯”ç‰¹ä½ä¸º 0 æ—¶ï¼Œè¡¨ç¤º is_waiting ä¸ºfalse ï¼Œä¹Ÿå°±æ˜¯å½“å‰äº‹åŠ¡è·å–é”æˆåŠŸã€‚\n\nå…¶ä»–ä¿¡æ¯ ï¼šä¸ºäº†æ›´å¥½çš„ç®¡ç†ç³»ç»Ÿè¿è¡Œè¿‡ç¨‹ä¸­ç”Ÿæˆçš„å„ç§é”ç»“æ„è€Œè®¾è®¡äº†å„ç§å“ˆå¸Œè¡¨å’Œé“¾è¡¨ã€‚ \nä¸€å †æ¯”ç‰¹ä½ ï¼šå¦‚æœæ˜¯ è¡Œé”ç»“æ„ çš„è¯ï¼Œåœ¨è¯¥ç»“æ„æœ«å°¾è¿˜æ”¾ç½®äº†ä¸€å †æ¯”ç‰¹ä½ï¼Œæ¯”ç‰¹ä½çš„æ•°é‡æ˜¯ç”±ä¸Šè¾¹æåˆ°çš„ n_bits å±æ€§è¡¨ç¤ºçš„ã€‚InnoDBæ•°æ®é¡µä¸­çš„æ¯æ¡è®°å½•åœ¨ è®°å½•å¤´ä¿¡æ¯ ä¸­éƒ½åŒ…å«ä¸€ä¸ª heap_no å±æ€§ï¼Œä¼ªè®°å½• Infimum çš„heap_no å€¼ä¸º 0 ï¼Œ Supremum çš„ heap_no å€¼ä¸º 1 ï¼Œä¹‹åæ¯æ’å…¥ä¸€æ¡è®°å½•ï¼Œ heap_no å€¼å°±å¢1ã€‚ é”ç»“æ„ æœ€åçš„ä¸€å †æ¯”ç‰¹ä½å°±å¯¹åº”ç€ä¸€ä¸ªé¡µé¢ä¸­çš„è®°å½•ï¼Œä¸€ä¸ªæ¯”ç‰¹ä½æ˜ å°„ä¸€ä¸ª heap_no ï¼Œå³ä¸€ä¸ªæ¯”ç‰¹ä½æ˜ å°„åˆ°é¡µå†…çš„ä¸€æ¡è®°å½•ã€‚\n\n","slug":"MySQLä¸­çš„é”","date":"2022-06-11T12:23:16.177Z","categories_index":"MySQL","tags_index":"MySQL","author_index":"å°æä¸åœ¨_"},{"id":"70425fba86b2c28266d9c33de675b2d8","title":"ç´¢å¼•ä¼˜åŒ–ä¸æŸ¥è¯¢ä¼˜åŒ–","content":"ç´¢å¼•ä¼˜åŒ–ä¸æŸ¥è¯¢ä¼˜åŒ–å“ªäº›ç»´åº¦å¯ä»¥è¿›è¡Œæ•°æ®åº“è°ƒä¼˜ï¼Ÿ\n1.ç´¢å¼•å¤±æ•ˆã€æ²¡æœ‰å……åˆ†åˆ©ç”¨ç´¢å¼• â€” å»ºç«‹ç´¢å¼•\n2.å…³è”æŸ¥è¯¢å¤ªå¤šjoinï¼ˆè®¾è®¡ç¼ºé™·æˆ–ä¸å¾—å·²çš„éœ€æ±‚ï¼‰ â€“ sqlä¼˜åŒ–\n3..æœåŠ¡å™¨è°ƒä¼˜åŠå„ä¸ªå‚æ•°è®¾ç½®ï¼ˆç¼“å†²ï¼Œçº¿ç¨‹æ•°ç­‰ï¼‰ â€“ è°ƒæ•´my.cnf\n4.æ•°æ®è¿‡å¤š â€“ åˆ†åº“åˆ†è¡¨\nsqlæŸ¥è¯¢ä¼˜åŒ–çš„å¤§ä½“æ–¹å‘ â€”\nç‰©ç†æŸ¥è¯¢ä¼˜åŒ–ï¼šé€šè¿‡ç´¢å¼•å’Œè¡¨è¿æ¥ç­‰å¥‡æ•°æ¥è¿›è¡Œä¼˜åŒ–\n\né€»è¾‘æŸ¥è¯¢ä¼˜åŒ–ï¼šé€šè¿‡SQLç­‰ä»·å˜æ¢æå‡æŸ¥è¯¢æ•ˆç‡ï¼Œä¹Ÿå°±æ˜¯æ¢ä¸€ç§æŸ¥è¯¢å†™æ³•\n\nå…³è”æŸ¥è¯¢ä¼˜åŒ–ï¼š\næƒ…å†µä¸€ï¼šå·¦å¤–è¿æ¥\næƒ…å†µäºŒï¼šå†…è¿æ¥å†…è¿æ¥ä¸­è‹¥åªèƒ½æœ‰ä¸€ä¸ªå­—æ®µæœ‰ç´¢å¼•ï¼Œåˆ™è¢«é©±åŠ¨è¡¨çš„å­—æ®µæœ‰ç´¢å¼•æˆæœ¬è¾ƒä½\nå¯¹äºå†…è¿æ¥ä¸­ï¼Œåœ¨ä¸¤ä¸ªè¡¨çš„è¿æ¥æ¡ä»¶éƒ½å­˜åœ¨ç´¢å¼•çš„æƒ…å†µä¸‹ï¼Œä¼šé€‰æ‹©æ•°æ®å°‘çš„è¡¨ä½œä¸ºé©±åŠ¨è¡¨ï¼ˆå°è¡¨é©±åŠ¨å¤§è¡¨ï¼‰\nå‡æ²¡æœ‰ç´¢å¼•ä¹Ÿç¬¦åˆ\tå°è¡¨é©±åŠ¨å¤§è¡¨çš„è§„åˆ™\n\næ€»ç»“ï¼šå°çš„ç»“æœé›†é©±åŠ¨å¤§çš„ç»“æœé›†ï¼ˆè¿‡æ»¤ä¹‹åçš„è¡¨çš„è¡Œæ•°*æ¯è¡Œçš„å¤§å°ï¼Œå¹¶ä¸æ˜¯è¡¨ä¸­çš„æ€»æ•°æ®ï¼‰\nä¸ºè¢«é©±åŠ¨è¡¨åŒ¹é…çš„æ¡ä»¶å¢åŠ ç´¢å¼•ï¼ˆå‡å°‘å†…å±‚è¡¨çš„å¾ªç¯åŒ¹é…æ¬¡æ•°ï¼‰\nå¢å¤§join buffer sizeçš„å¤§å°ï¼ˆä¸€æ¬¡ç¼“å­˜çš„æ•°æ®è¶Šå¤šï¼Œé‚£ä¹ˆå†…å±‚åŒ…çš„æ‰«æçš„æ¬¡æ•°å°±è¶Šå°‘ï¼‰\nå‡å°‘é©±åŠ¨è¡¨ä¸å¿…è¦çš„å­—æ®µçš„æŸ¥è¯¢ï¼ˆå­—æ®µè¶Šå°‘ï¼Œjoin buffer ç¼“å­˜çš„æ•°æ®å°±è¶Šå¤šï¼‰\nMySQL8.0æ–°ç‰¹æ€§ï¼šåºŸå¼ƒäº†ä¹‹å‰çš„BNLJ åŠ å…¥hash joinä¸”é»˜è®¤ä½¿ç”¨\n\n\næ’åºä¼˜åŒ–ï¼šé—®é¢˜ï¼šåœ¨whereæ¡ä»¶å­—æ®µä¸Šæ·»åŠ ç´¢å¼•ï¼Œä¸ºä»€ä¹ˆè¿˜è¦åœ¨order by å­—æ®µä¸Šæ·»åŠ ç´¢å¼•å‘¢ï¼Ÿ\nåœ¨MySQLä¸­æ”¯æŒä¸¤ç§æ’åºæ–¹å¼ï¼Œåˆ†åˆ«æ˜¯filesortå’Œindexæ–¹å¼ï¼ˆfilesortæ¯”è¾ƒè€—æ—¶é—´ï¼‰\nindexæ’åºä¸­ï¼Œç´¢å¼•å¯ä»¥ä¿è¯æ•°æ®çš„æœ‰åºæ€§ï¼Œä¸éœ€è¦å†æ¬¡è¿›è¡Œæ’åºï¼Œæ•ˆç‡æ›´é«˜\n\nfilesortæ’åºä¸€èˆ¬åœ¨å†…å­˜ä¸­è¿›è¡Œï¼Œå ç”¨çš„CPUè¿‡å¤šï¼Œå¦‚æœå¾…æ’åºçš„ç»“æœè¾ƒå¤§ï¼Œä¼šäº§ç”Ÿä¸´æ—¶æ–‡ä»¶ioåˆ°ç£ç›˜è¿›è¡Œæ’åºï¼Œæ•ˆç‡ä½\n\n\nä¼˜åŒ–å»ºè®®ï¼š1.SQLä¸­ï¼Œå¯ä»¥åœ¨whereè¯­å¥å’Œorder by è¯­å¥ä¸­ä½¿ç”¨åˆ°ç´¢å¼•ï¼Œç›®çš„æ˜¯é¿å…whereçš„å…¨è¡¨æ‰«æå’Œorder byçš„File Sortæ’åºï¼Œä½†æ˜¯åœ¨æŸäº›æç«¯çš„æƒ…å†µä¸‹ï¼Œä¹Ÿæœ‰ä¸ä½¿ç”¨ç´¢å¼•å¯èƒ½æ¯”ä½¿ç”¨ç´¢å¼•çš„æ•ˆç‡è¦é«˜\n2.å°½é‡ä½¿ç”¨indexå®Œæˆorder byæ’åºï¼Œå¦‚æœwhereå’Œorder byåé¢æ˜¯ç›¸åŒçš„åˆ—å°±ä½¿ç”¨å•åˆ—ç´¢å¼•ï¼Œä¸åŒçš„åˆ—å°±ä½¿ç”¨è”åˆç´¢å¼•\n3.æ— æ³•ä½¿ç”¨indexæ—¶ï¼Œéœ€è¦å¯¹FileSortæ–¹å¼è¿›è¡Œè°ƒä¼˜\n\norder byé¡ºåºé”™è¯¯ä¹Ÿä¼šå¯¼è‡´ç´¢å¼•å¤±æ•ˆï¼Œä¹Ÿæ˜¯æœ€å·¦å‰ç¼€æ³•åˆ™\norder byæ’åºæ–¹å‘åäº†ä¹Ÿä¼šå¯¼è‡´ç´¢å¼•å¤±æ•ˆï¼ˆå¦‚idå‡åºï¼Œageé™åºï¼‰å­—æ®µçš„æ’åºæ–¹å‘è¦ç›¸åŒï¼ˆéƒ½å‡åºæˆ–é™åºï¼‰\næ•°æ®æœªè¿›è¡Œè¿‡æ»¤ï¼ˆwhereæœªè¿‡æ»¤ï¼‰å¯¼è‡´æ•°æ®è¿‡å¤šå¯èƒ½å¯¼è‡´ç´¢å¼•å¤±æ•ˆ\n\næ€»ç»“ï¼š1.å½“ä¸¤ä¸ªç´¢å¼•åŒæ—¶å­˜åœ¨çš„æ—¶å€™ï¼ŒMySQLä¼šè‡ªåŠ¨é€‰æ‹©æœ€ä¼˜çš„æ–¹æ¡ˆï¼Œä½†æ˜¯éšç€æ•°æ®é‡çš„å˜åŒ–ï¼Œé€‰æ‹©çš„ç´¢å¼•ä¹Ÿä¼šéšä¹‹å˜åŒ–\n2.å½“èŒƒå›´æ¡ä»¶å’Œgroup byæˆ–è€…order by çš„å­—æ®µå‡ºç°äºŒé€‰ä¸€æ—¶ï¼Œä¼˜å…ˆè§‚å¯Ÿæ¡ä»¶å­—æ®µçš„è¿‡æ»¤æ•°é‡ï¼Œå¦‚æœè¿‡æ»¤çš„æ•°æ®è¶³å¤Ÿå¤šï¼Œè€Œéœ€è¦æ’åºçš„æ•°æ®å¹¶ä¸å¤šæ—¶ï¼Œä¼˜å…ˆæŠŠç´¢å¼•æ”¾åœ¨èŒƒå›´å­—æ®µä¸Šï¼Œåä¹‹ï¼ŒåŒç†\n\n\nFileSortç®—æ³•ï¼šåŒè·¯æ’åºå’Œå•è·¯æ’åºæ’åºçš„å­—æ®µè‹¥ä¸åœ¨ç´¢å¼•åˆ—ä¸Šï¼Œåˆ™filesortä¼šæœ‰ä¸¤ç§ç®—æ³•ï¼šåŒè·¯æ’åºå’Œå•è·¯æ’åº\nåŒè·¯æ’åº ï¼ˆæ…¢ï¼‰MySQL 4.1ä¹‹å‰æ˜¯ä½¿ç”¨åŒè·¯æ’åº ï¼Œå­—é¢æ„æ€å°±æ˜¯ä¸¤æ¬¡æ‰«æç£ç›˜ï¼Œæœ€ç»ˆå¾—åˆ°æ•°æ®ï¼Œ è¯»å–è¡ŒæŒ‡é’ˆå’Œorder byåˆ— ï¼Œå¯¹ä»–ä»¬è¿›è¡Œæ’åºï¼Œç„¶åæ‰«æå·²ç»æ’åºå¥½çš„åˆ—è¡¨ï¼ŒæŒ‰ç…§åˆ—è¡¨ä¸­çš„å€¼é‡æ–°ä»åˆ—è¡¨ä¸­è¯»å–å¯¹åº”çš„æ•°æ®è¾“å‡º\nä»ç£ç›˜å–æ’åºå­—æ®µï¼Œåœ¨bufferè¿›è¡Œæ’åºï¼Œå†ä» ç£ç›˜å–å…¶ä»–å­—æ®µ ã€‚\nå–ä¸€æ‰¹æ•°æ®ï¼Œè¦å¯¹ç£ç›˜è¿›è¡Œä¸¤æ¬¡æ‰«æï¼Œä¼—æ‰€å‘¨çŸ¥ï¼ŒIOæ˜¯å¾ˆè€—æ—¶çš„ï¼Œæ‰€ä»¥åœ¨mysql4.1ä¹‹åï¼Œå‡ºç°äº†ç¬¬äºŒç§æ”¹è¿›çš„ç®—æ³•ï¼Œå°±æ˜¯å•è·¯æ’åºã€‚\nå•è·¯æ’åº ï¼ˆå¿«ï¼‰ä»ç£ç›˜è¯»å–æŸ¥è¯¢éœ€è¦çš„ æ‰€æœ‰åˆ— ï¼ŒæŒ‰ç…§order byåˆ—åœ¨bufferå¯¹å®ƒä»¬è¿›è¡Œæ’åºï¼Œç„¶åæ‰«ææ’åºåçš„åˆ—è¡¨è¿›è¡Œè¾“å‡ºï¼Œ å®ƒçš„æ•ˆç‡æ›´å¿«ä¸€äº›ï¼Œé¿å…äº†ç¬¬äºŒæ¬¡è¯»å–æ•°æ®ã€‚å¹¶ä¸”æŠŠéšæœºIOå˜æˆäº†é¡ºåºIOï¼Œä½†æ˜¯å®ƒä¼šä½¿ç”¨æ›´å¤šçš„ç©ºé—´ï¼Œ å› ä¸ºå®ƒæŠŠæ¯ä¸€è¡Œéƒ½ä¿å­˜åœ¨å†…å­˜ä¸­äº†ã€‚\n\næ™®é€šç´¢å¼•å’Œå”¯ä¸€ç´¢å¼•ä¼˜åŒ–ï¼š11.1 æŸ¥è¯¢è¿‡ç¨‹å‡è®¾ï¼Œæ‰§è¡ŒæŸ¥è¯¢çš„è¯­å¥æ˜¯ select id from test where k&#x3D;5ã€‚å¯¹äºæ™®é€šç´¢å¼•æ¥è¯´ï¼ŒæŸ¥æ‰¾åˆ°æ»¡è¶³æ¡ä»¶çš„ç¬¬ä¸€ä¸ªè®°å½•(5,500)åï¼Œéœ€è¦æŸ¥æ‰¾ä¸‹ä¸€ä¸ªè®°å½•ï¼Œç›´åˆ°ç¢°åˆ°ç¬¬ä¸€ä¸ªä¸æ»¡è¶³k&#x3D;5æ¡ä»¶çš„è®°å½•ã€‚å¯¹äºå”¯ä¸€ç´¢å¼•æ¥è¯´ï¼Œç”±äºç´¢å¼•å®šä¹‰äº†å”¯ä¸€æ€§ï¼ŒæŸ¥æ‰¾åˆ°ç¬¬ä¸€ä¸ªæ»¡è¶³æ¡ä»¶çš„è®°å½•åï¼Œå°±ä¼šåœæ­¢ç»§ç»­æ£€ç´¢ã€‚é‚£ä¹ˆï¼Œè¿™ä¸ªä¸åŒå¸¦æ¥çš„æ€§èƒ½å·®è·ä¼šæœ‰å¤šå°‘å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ï¼Œ å¾®ä¹å…¶å¾® ã€‚\n11.2 æ›´æ–°è¿‡ç¨‹ä¸ºäº†è¯´æ˜æ™®é€šç´¢å¼•å’Œå”¯ä¸€ç´¢å¼•å¯¹æ›´æ–°è¯­å¥æ€§èƒ½çš„å½±å“è¿™ä¸ªé—®é¢˜ï¼Œä»‹ç»ä¸€ä¸‹change bufferã€‚å½“éœ€è¦æ›´æ–°ä¸€ä¸ªæ•°æ®é¡µæ—¶ï¼Œå¦‚æœæ•°æ®é¡µåœ¨å†…å­˜ä¸­å°±ç›´æ¥æ›´æ–°ï¼Œè€Œå¦‚æœè¿™ä¸ªæ•°æ®é¡µè¿˜æ²¡æœ‰åœ¨å†…å­˜ä¸­çš„è¯ï¼Œåœ¨ä¸å½±å“æ•°æ®ä¸€è‡´æ€§çš„å‰æä¸‹ï¼Œ InooDBä¼šå°†è¿™äº›æ›´æ–°æ“ä½œç¼“å­˜åœ¨change bufferä¸­ ï¼Œè¿™æ ·å°±ä¸éœ€è¦ä»ç£ç›˜ä¸­è¯»å…¥è¿™ä¸ªæ•°æ®é¡µäº†ã€‚åœ¨ä¸‹æ¬¡æŸ¥è¯¢éœ€è¦è®¿é—®è¿™ä¸ªæ•°æ®é¡µçš„æ—¶å€™ï¼Œå°†æ•°æ®é¡µè¯»å…¥å†…å­˜ï¼Œç„¶åæ‰§è¡Œchangebufferä¸­ä¸è¿™ä¸ªé¡µæœ‰å…³çš„æ“ä½œã€‚é€šè¿‡è¿™ç§æ–¹å¼å°±èƒ½ä¿è¯è¿™ä¸ªæ•°æ®é€»è¾‘çš„æ­£ç¡®æ€§ã€‚å°†change bufferä¸­çš„æ“ä½œåº”ç”¨åˆ°åŸæ•°æ®é¡µï¼Œå¾—åˆ°æœ€æ–°ç»“æœçš„è¿‡ç¨‹ç§°ä¸º merge ã€‚é™¤äº† è®¿é—®è¿™ä¸ªæ•°æ®é¡µ ä¼šè§¦å‘mergeå¤–ï¼Œç³»ç»Ÿæœ‰ åå°çº¿ç¨‹ä¼šå®šæœŸ mergeã€‚åœ¨ æ•°æ®åº“æ­£å¸¸å…³é—­ï¼ˆshutdownï¼‰ çš„è¿‡ç¨‹ä¸­ï¼Œä¹Ÿä¼šæ‰§è¡Œmergeæ“ä½œã€‚å¦‚æœèƒ½å¤Ÿå°†æ›´æ–°æ“ä½œå…ˆè®°å½•åœ¨change bufferï¼Œ å‡å°‘è¯»ç£ç›˜ ï¼Œè¯­å¥çš„æ‰§è¡Œé€Ÿåº¦ä¼šå¾—åˆ°æ˜æ˜¾çš„æå‡ã€‚è€Œä¸”ï¼Œæ•°æ®è¯»å…¥å†…å­˜æ˜¯éœ€è¦å ç”¨ buffer pool çš„ï¼Œæ‰€ä»¥è¿™ç§æ–¹å¼è¿˜èƒ½å¤Ÿ é¿å…å ç”¨å†…å­˜ ï¼Œæé«˜å†…å­˜åˆ©ç”¨ç‡ã€‚å”¯ä¸€ç´¢å¼•çš„æ›´æ–°å°±ä¸èƒ½ä½¿ç”¨change buffer ï¼Œå®é™…ä¸Šä¹Ÿåªæœ‰æ™®é€šç´¢å¼•å¯ä»¥ä½¿ç”¨ã€‚å¦‚æœè¦åœ¨è¿™å¼ è¡¨ä¸­æ’å…¥ä¸€ä¸ªæ–°è®°å½•(4,400)çš„è¯ï¼ŒInnoDBçš„å¤„ç†æµç¨‹æ˜¯æ€æ ·çš„ï¼Ÿ\n11.3 change bufferçš„ä½¿ç”¨åœºæ™¯ï¼šåªèƒ½ä½¿ç”¨äºæ™®é€šç´¢å¼•\n\næ™®é€šç´¢å¼•å’Œå”¯ä¸€ç´¢å¼•åº”è¯¥æ€ä¹ˆé€‰æ‹©ï¼Ÿå…¶å®ï¼Œè¿™ä¸¤ç±»ç´¢å¼•åœ¨æŸ¥è¯¢èƒ½åŠ›ä¸Šæ˜¯æ²¡å·®åˆ«çš„ï¼Œä¸»è¦è€ƒè™‘çš„æ˜¯å¯¹ æ›´æ–°æ€§èƒ½ çš„å½±å“ã€‚æ‰€ä»¥ï¼Œå»ºè®®ä½  å°½é‡é€‰æ‹©æ™®é€šç´¢å¼• ã€‚\nåœ¨å®é™…ä½¿ç”¨ä¸­ä¼šå‘ç°ï¼Œ æ™®é€šç´¢å¼• å’Œ change buffer çš„é…åˆä½¿ç”¨ï¼Œå¯¹äº æ•°æ®é‡å¤§ çš„è¡¨çš„æ›´æ–°ä¼˜åŒ–è¿˜æ˜¯å¾ˆæ˜æ˜¾çš„ã€‚\nå¦‚æœæ‰€æœ‰çš„æ›´æ–°åé¢ï¼Œéƒ½é©¬ä¸Š ä¼´éšç€å¯¹è¿™ä¸ªè®°å½•çš„æŸ¥è¯¢ ï¼Œé‚£ä¹ˆä½ åº”è¯¥ å…³é—­change buffer ã€‚è€Œåœ¨å…¶ä»–æƒ…å†µä¸‹ï¼Œchange bufferéƒ½èƒ½æå‡æ›´æ–°æ€§èƒ½ã€‚\nç”±äºå”¯ä¸€ç´¢å¼•ç”¨ä¸ä¸Šchange bufferçš„ä¼˜åŒ–æœºåˆ¶ï¼Œå› æ­¤å¦‚æœ ä¸šåŠ¡å¯ä»¥æ¥å— ï¼Œä»æ€§èƒ½è§’åº¦å‡ºå‘å»ºè®®ä¼˜å…ˆè€ƒè™‘éå”¯ä¸€ç´¢å¼•ã€‚ä½†æ˜¯å¦‚æœâ€ä¸šåŠ¡å¯èƒ½æ— æ³•ç¡®ä¿â€çš„æƒ…å†µä¸‹ï¼Œæ€ä¹ˆå¤„ç†å‘¢ï¼Ÿé¦–å…ˆï¼Œ ä¸šåŠ¡æ­£ç¡®æ€§ä¼˜å…ˆ ã€‚æˆ‘ä»¬çš„å‰ææ˜¯â€œä¸šåŠ¡ä»£ç å·²ç»ä¿è¯ä¸ä¼šå†™å…¥é‡å¤æ•°æ®â€çš„æƒ…å†µä¸‹ï¼Œè®¨è®ºæ€§èƒ½é—®é¢˜ã€‚å¦‚æœä¸šåŠ¡ä¸èƒ½ä¿è¯ï¼Œæˆ–è€…ä¸šåŠ¡å°±æ˜¯è¦æ±‚æ•°æ®åº“æ¥åšçº¦æŸï¼Œé‚£ä¹ˆæ²¡å¾—é€‰ï¼Œå¿…é¡»åˆ›å»ºå”¯ä¸€ç´¢å¼•ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œæœ¬èŠ‚çš„æ„ä¹‰åœ¨äºï¼Œå¦‚æœç¢°ä¸Šäº†å¤§é‡æ’å…¥æ•°æ®æ…¢ã€å†…å­˜å‘½ä¸­ç‡ä½çš„æ—¶å€™ï¼Œç»™ä½ å¤šæä¾›ä¸€ä¸ªæ’æŸ¥æ€è·¯ã€‚ç„¶åï¼Œåœ¨ä¸€äº›â€œ å½’æ¡£åº“ â€çš„åœºæ™¯ï¼Œä½ æ˜¯å¯ä»¥è€ƒè™‘ä½¿ç”¨å”¯ä¸€ç´¢å¼•çš„ã€‚æ¯”å¦‚ï¼Œçº¿ä¸Šæ•°æ®åªéœ€è¦ä¿ç•™åŠå¹´ï¼Œç„¶åå†å²æ•°æ®ä¿å­˜åœ¨å½’æ¡£åº“ã€‚è¿™æ—¶å€™ï¼Œå½’æ¡£æ•°æ®å·²ç»æ˜¯ç¡®ä¿æ²¡æœ‰å”¯ä¸€é”®å†²çªäº†ã€‚è¦æé«˜å½’æ¡£æ•ˆç‡ï¼Œå¯ä»¥è€ƒè™‘æŠŠè¡¨é‡Œé¢çš„å”¯ä¸€ç´¢å¼•æ”¹æˆæ™®é€šç´¢å¼•ã€‚\n\n\nå…¶ä»–æŸ¥è¯¢ä¼˜åŒ–ç­–ç•¥ï¼š\n1.EXISTS å’Œ INï¼šå…·ä½“çœ‹è¡¨çš„å¤§å°ï¼Œè¦ç¬¦åˆå°è¡¨é©±åŠ¨å¤§è¡¨çš„åŸåˆ™\nå¦‚\nSELECT * FROM A WHERE id IN (SELECT id FROM B)ï¼›â€”â€”â€”â€”â€”â€”â‘ \nSELECT * FROM A WHERE EXISTS (SELECT id FROM B WHERE B.id &#x3D; A.id)ï¼›â€”â€”â€”â€”â€”â€”â‘¡\nè‹¥Aä¸ºå°è¡¨ï¼Œåˆ™ä½¿ç”¨â‘¡EXISTS\nè‹¥Bä¸ºå°è¡¨ï¼Œåˆ™ä½¿ç”¨â‘ IN\n\n2.COUNT(*) he COUNT(å…·ä½“å­—æ®µ)ï¼šé—®ï¼šåœ¨ MySQL ä¸­ç»Ÿè®¡æ•°æ®è¡¨çš„è¡Œæ•°ï¼Œå¯ä»¥ä½¿ç”¨ä¸‰ç§æ–¹å¼ï¼š SELECT COUNT(*) ã€ SELECT COUNT(1) å’ŒSELECT COUNT(å…·ä½“å­—æ®µ) ï¼Œä½¿ç”¨è¿™ä¸‰è€…ä¹‹é—´çš„æŸ¥è¯¢æ•ˆç‡æ˜¯æ€æ ·çš„ï¼Ÿ\nç­”ï¼š\n1.COUNT(*)å’ŒCOUNT(1)éƒ½æ˜¯å¯¹æ‰€æœ‰ç»“æœè¿›è¡ŒCOUNTï¼Œæœ¬è´¨ä¸Šæ²¡æœ‰åŒºåˆ«ï¼Œ\nâ‘ å¦‚æœä½¿ç”¨MyISAMå­˜å‚¨å¼•æ“ï¼Œåˆ™å¤æ‚åº¦ä¸ºO(1)ï¼Œå› ä¸ºMyISAMå­˜å‚¨å¼•æ“ä¸­æœ‰ä¸€ä¸ªmataä¿¡æ¯è®°å½•äº†è¡¨ä¸­çš„è®°å½•æ•°ï¼ˆrow_countï¼‰è€Œä¸€è‡´æ€§åˆ™ç”±è¡¨çº§é”æ¥ä¿è¯\nâ‘¡å¦‚æœä½¿ç”¨InnoDBå­˜å‚¨å¼•æ“åˆ™å¤æ‚åº¦ä¸ºO(n)ï¼Œå› ä¸ºInnoDBæ”¯æŒäº‹åŠ¡ï¼Œé‡‡ç”¨è¡Œçº§é”å’ŒMVCCæœºåˆ¶ï¼Œæ— æ³•åƒMyISAMä¸€æ ·ç»´æŠ¤ä¸€ä¸ªrow_countå˜é‡ï¼Œéœ€è¦å…¨è¡¨æ‰«æ\n2.åœ¨InnoDBå­˜å‚¨å¼•æ“ä¸­ï¼Œå¦‚æœé‡‡ç”¨COUNT(å…·ä½“å­—æ®µ)æ¥ç»Ÿè®¡æ•°æ®è¡Œæ•°ï¼Œè¦å°½é‡ä½¿ç”¨äºŒçº§ç´¢å¼•ï¼Œå› ä¸ºä¸»é”®ç´¢å¼•ä½¿ç”¨çš„æ˜¯èšç°‡ç´¢å¼•ï¼ŒåŒ…å«çš„ä¿¡æ¯è¾ƒå¤šï¼Œè€Œå¯¹äºCOUNT(*)å’ŒCOUNT(1)æ¥è¯´ï¼Œå®ƒä»¬ä¸éœ€è¦æŸ¥æ‰¾å…·ä½“çš„è¡Œï¼Œåªæ˜¯ç»Ÿè®¡è¡Œæ•°ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨é‡‡ç”¨å ç”¨ç©ºé—´æ›´å°çš„äºŒçº§ç´¢å¼•æ¥è¿›è¡Œç»Ÿè®¡\nå¦‚æœå­˜åœ¨å¤šä¸ªäºŒçº§ç´¢å¼•ï¼Œåˆ™ä¼šä½¿ç”¨key_lenæ›´å°çš„äºŒçº§ç´¢å¼•è¿›è¡Œæ‰«æï¼Œå½“æ²¡æœ‰äºŒçº§ç´¢å¼•çš„æ—¶å€™ï¼Œæ‰ä¼šä½¿ç”¨ä¸»é”®ç´¢å¼•æ¥è¿›è¡Œç»Ÿè®¡\n\n3.å…³äºSELECT * FROM æŸä¸ªè¡¨ï¼šåœ¨è¡¨æŸ¥è¯¢ä¸­ï¼Œå»ºè®®æ˜ç¡®å­—æ®µï¼Œä¸è¦ä½¿ç”¨*ä½œä¸ºæŸ¥è¯¢çš„å­—æ®µåˆ—è¡¨ï¼Œæ¨èä½¿ç”¨SELECT å…·ä½“å­—æ®µ æ¥è¿›è¡ŒæŸ¥è¯¢\n\nåŸå› ï¼šâ‘ ï¼šMySQLåœ¨è§£æçš„è¿‡ç¨‹ä¸­ï¼Œä¼šé€šè¿‡æŸ¥è¯¢æ•°æ®å­—å…¸å°† Â â€˜*â€˜ Â è½¬æ¢ä¸ºæ‰€æœ‰å­—æ®µçš„åç§°ï¼Œä¼šå¤§å¤§çš„è€—è´¹èµ„æºå’Œæ—¶é—´\nâ‘¡ï¼šæ— æ³•ä½¿ç”¨è¦†ç›–ç´¢å¼•\n\n4.LIMIT 1 å¯¹ä¼˜åŒ–çš„å½±å“é’ˆå¯¹çš„æ˜¯ä¼šæ‰«æå…¨è¡¨çš„SQLè¯­å¥ï¼Œå¦‚æœä½ å¯ä»¥ç¡®å®šç»“æœé›†åªæœ‰ä¸€æ¡ï¼Œé‚£ä¹ˆåŠ ä¸ŠLIMIT 1 çš„æ—¶å€™ï¼Œå½“æ‰¾åˆ°ä¸€æ¡ç»“æœçš„æ—¶å€™å°±ä¸ä¼šç»§ç»­è¿›è¡Œæ‰«æäº†ï¼Œè¿™æ ·ä¼šåŠ å¿«æŸ¥è¯¢é€Ÿåº¦\nå¦‚æœæ•°æ®è¡¨å¯¹å­—æ®µå·²ç»å»ºç«‹äº†å”¯ä¸€ç´¢å¼•ï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡ç´¢å¼•è¿›è¡ŒæŸ¥è¯¢ï¼Œä¸ä¼šå¯¹å…¨è¡¨è¿›è¡Œæ‰«æï¼Œé‚£ä¹ˆå°±ä¸éœ€è¦å†åŠ LIMIT 1\n\n5.å¤šä½¿ç”¨COMMITè¿›è¡Œæ‰‹åŠ¨æäº¤COMMITä¼šé‡Šæ”¾èµ„æºï¼š\nâ€‹\t1.å›æ»šæ®µä¸Šç”¨æˆ·æ¢å¤æ•°æ®çš„ä¿¡æ¯\nâ€‹\t2.è¢«ç¨‹åºè¯­å¥è·å¾—çš„é”\nâ€‹\t3.redo &#x2F; undo log bufferä¸­çš„ç©ºé—´\nâ€‹\t4.ç®¡ç†ä¸Šè¿°ä¸‰ç§èµ„æºä¸­çš„å†…éƒ¨èŠ±è´¹\n\nç´¢å¼•å¤±æ•ˆçš„æƒ…å†µ\nå…¨å€¼åŒ¹é…æŸ¥è¯¢å­—æ®µä¸æ‰€æœ‰çš„ç´¢å¼•ä¸€ä¸€å¯¹åº”æ‰å¯ä»¥ä½¿æ‰€æœ‰ç´¢å¼•éƒ½ç”Ÿæ•ˆ\n\næœ€å·¦å‰ç¼€æ³•åˆ™å¦‚ç”±idï¼Œnameï¼Œphoneç»„æˆçš„è”åˆç´¢å¼•ï¼ŒåªæŸ¥è¯¢nameå’Œphoneåˆ™ç´¢å¼•ä¸ç”Ÿæ•ˆï¼Œå¿…é¡»ä¸¥æ ¼æŒ‰ç…§åˆ›å»ºç´¢å¼•çš„é¡ºåº\n\nè®¡ç®—ã€å‡½æ•°ã€ç±»å‹è½¬æ¢ï¼ˆæ‰‹åŠ¨æˆ–è‡ªåŠ¨ï¼‰å¯¼è‡´ç´¢å¼•å¤±æ•ˆå¦‚ï¼šEXPLAIN SELECT SQL_NO_CACHE * FROM student WHERE student.name LIKE â€˜abc%â€™;\nEXPLAIN SELECT SQL_NO_CACHE * FROM student WHERE LEFT(student.name,3) &#x3D; â€˜abcâ€™;\nä½¿ç”¨leftåˆ™ä¼šå¯¼è‡´ç´¢å¼•å¤±æ•ˆ Â åŸå› æ˜¯ä¸çŸ¥é“nameçš„å€¼ï¼Œè€Œæ˜¯æŠŠæ‰€æœ‰çš„å€¼å…¨å–å‡ºå†å»å‰ä¸‰ä¸ªå­—ç¬¦ï¼Œåˆ¤æ–­æ˜¯å¦ä¸abcç›¸ç­‰ï¼Œå¹¶ä¸ä¼šä½¿ç”¨åˆ°ç´¢å¼•\n\nè¿”å›æ¡ä»¶å³è¾¹çš„åˆ—ç´¢å¼•å¤±æ•ˆcreate index idx_age_name_classid on student(ageï¼Œclassidï¼Œname); Â  &#x2F;&#x2F;åˆ›å»ºç´¢å¼•\nEXPLAIN SELECT SQL_NO_CACHE * FROM studentWHERE student.age&#x3D;30 AND student.classId&gt;20 AND student.name &#x3D; â€˜abcâ€™ ;\nä¸Šè¿°sql nameæœªä½¿ç”¨ç´¢å¼•ï¼ˆä¸å†™çš„æ¡ä»¶çš„é¡ºåºæ— å…³ ï¼‰\n\næ”¹æ­£ï¼šåˆ›å»ºç´¢å¼•çš„æ—¶å€™æŠŠnameå†™åˆ°è¿”å›æ¡ä»¶classidçš„å‰é¢create index idx_age_name_classid on student(age,name,classid);\n\nä¸ç­‰äº(!&#x3D;æˆ–è€…&lt;&gt;)å¯¼è‡´ç´¢å¼•å¤±æ•ˆåŸå› ï¼šåœ¨B+æ ‘ä¸­ï¼Œè‹¥æŸ¥æ‰¾å…·ä½“æŸä¸ªå€¼å¦‚ï¼ˆwhere id &#x3D; 1ï¼‰ åˆ™å¯ä»¥ç²¾ç¡®æŸ¥æ‰¾ï¼Œä½†æ˜¯ä¸ç­‰äºåˆ™æ— æ³•æŸ¥æ‰¾ï¼Œæ‰€ä»¥ä¸ç­‰äºä¼šå¯¼è‡´ç´¢å¼•å¤±æ•ˆï¼Œåªèƒ½ä¸€ä¸ªä¸€ä¸ªå»æŸ¥æ‰¾å†åˆ¤æ–­æ˜¯å¦ç›¸ç­‰\n\nis nullå¯ä»¥ä½¿ç”¨ç´¢å¼•ï¼Œis not null ä¸èƒ½ä½¿ç”¨ç´¢å¼•ä¸ä¸Šè¿°ä¸ç­‰äºçš„æƒ…å†µç±»ä¼¼ï¼Œis nullç›¸å½“äºç­‰äºæŸä¸ªå€¼ï¼ˆå€¼ä¸ºnullï¼‰ è€Œis not null ç›¸å½“äºä¸ç­‰äºæŸä¸ªå€¼ï¼Œä¸èƒ½ä½¿ç”¨ç´¢å¼•åˆ¤æ–­\n\nlikeä»¥é€šé…ç¬¦%å¼€å¤´å¯¼è‡´ç´¢å¼•å¤±æ•ˆå¦‚where name like â€˜%abcâ€™ï¼›\n\norå‰åå­˜åœ¨éç´¢å¼•çš„åˆ—å¯¼è‡´ç´¢å¼•å¤±æ•ˆEXPLAIN SELECT SQL_NO_CACHE * FROM student WHERE age &#x3D; 10 OR classid &#x3D; 100;\nè‹¥ä¸Šè¿°SQLåªæœ‰ageæˆ–classidä½œä¸ºç´¢å¼•åˆ™ä¼šå¯¼è‡´ç´¢å¼•å¤±æ•ˆï¼Œåªæœ‰orå‰åçš„å­—æ®µæœ‰ç´¢å¼•æ‰å¯ä»¥ç”Ÿæ•ˆ\n\næ•°æ®åº“å’Œè¡¨çš„å­—ç¬¦é›†ç»Ÿä¸€ä¸åŒçš„å­—ç¬¦é›†è¿›è¡Œæ¯”è¾ƒä¹‹å‰éœ€è¦è¿›è¡Œè½¬æ¢ï¼Œä½¿ç”¨åˆ°è½¬æ¢å‡½æ•°ï¼Œå¯¼è‡´ç´¢å¼•å¤±æ•ˆ\n\næ€»ç»“ï¼š1.å¯¹äºå•åˆ—ç´¢å¼•ï¼Œå°½é‡é€‰æ‹©é’ˆå¯¹å½“å‰æŸ¥è¯¢è¿‡æ»¤æ€§æ›´å¥½çš„ç´¢å¼•\n2.åœ¨é€‰æ‹©ç»„åˆç´¢å¼•çš„æ—¶å€™ï¼Œå½“å‰æŸ¥è¯¢ä¸­è¿‡æ»¤æ€§æœ€å¥½çš„ç´¢å¼•è¶Šé å‰è¶Šå¥½\nè¿‡æ»¤æ€§è¶Šå¥½ï¼Œç­›é€‰å‰©ä½™çš„æ•°æ®è¶Šå°‘ï¼Œç»™åé¢æŸ¥è¯¢çš„å‹åŠ›è¶Šå°\n\n3.åœ¨é€‰æ‹©ç»„åˆç´¢å¼•çš„æ—¶å€™ï¼Œå°½é‡é€‰æ‹©èƒ½å¤ŸåŒ…å«å½“å‰æŸ¥è¯¢ä¸­çš„whereå­å¥ä¸­æ›´å¤šå­—æ®µçš„ç´¢å¼•\n4.åœ¨é€‰æ‹©ç»„åˆç´¢å¼•çš„æ—¶å€™ï¼Œå¦‚æœæŸä¸ªå­—æ®µå¯èƒ½å‡ºç°èŒƒå›´æŸ¥è¯¢æ—¶ï¼Œå°½é‡æŠŠè¿™ä¸ªå­—æ®µæ”¾åœ¨ç´¢å¼•æ¬¡åºçš„æœ€åé¢\nç´¢å¼•ï¼ˆæ¡ä»¶ï¼‰ä¸‹æ¨ï¼šï¼ˆICPï¼‰ä¾‹å¦‚ï¼š\nèšåˆç´¢å¼• zipcode_lastname_id\nEXPLAIN SELECT * FROM people\nWHERE zipcode &#x3D; â€˜00001â€™\nAND lastname LIKE â€˜%å¼ %â€™\nAND address LIKE â€˜%åŒ—äº¬%â€™\nä¸Šè¿°SQLè¯­å¥å°±ä½¿ç”¨åˆ°ç´¢å¼•ä¸‹æ¨ï¼Œlastnameçš„æ¨¡ç³ŠæŸ¥è¯¢å¯¼è‡´ç´¢å¼•å¤±æ•ˆï¼Œä½†æ˜¯ä¼˜åŒ–å™¨å¹¶æ²¡æœ‰åœ¨ä½¿ç”¨å®Œzipcodeå­—æ®µç´¢å¼•åå°±è¿›è¡Œå›è¡¨å»æŸ¥è¯¢æ•°æ®ï¼Œè€Œæ˜¯ç›´æ¥å¯¹lastnameè¿›è¡Œæ¨¡ç³ŠæŸ¥è¯¢ï¼Œå†è¿‡æ»¤æ‰ä¸€éƒ¨åˆ†æ•°æ®åå†è¿›è¡Œå›è¡¨ï¼Œè¿™ç§æƒ…å†µå°±å«ç´¢å¼•ä¸‹æ¨ï¼ˆICP)\n\nICPä½¿ç”¨æ¡ä»¶ï¼š1.ICPå¯ä»¥ç”¨äºInnoDBå’ŒMyISAMè¡¨ï¼Œå¯¹äºInnoDBè¡¨ï¼ŒICPä»…ç”¨äºäºŒçº§ç´¢å¼•ã€‚ICPçš„ç›®æ ‡æ˜¯å‡å°‘å…¨è¡Œè¯»å–æ¬¡æ•°ï¼Œä»è€Œå‡å°‘IOæ“ä½œ\n2.å½“SQLä½¿ç”¨è¦†ç›–ç´¢å¼•æ—¶ï¼Œä¸æ”¯æŒICP\n3.ç›¸å…³å­æŸ¥è¯¢ä¸èƒ½ä½¿ç”¨ICP\n\nä¼˜å…ˆè€ƒè™‘è¦†ç›–ç´¢å¼•1.è¦†ç›–ç´¢å¼•ï¼šä¸€ä¸ªç´¢å¼•åŒ…å«äº†æ»¡è¶³æŸ¥è¯¢ç»“æœçš„æ•°æ®å°±å«åšè¦†ç›–ç´¢å¼•\nç®€å•æ¥è¯´å°±æ˜¯ï¼šç´¢å¼•åˆ—+ä¸»é”® åŒ…å«select åˆ° from ä¹‹é—´æŸ¥è¯¢çš„åˆ—\n\nå¥½å¤„ï¼š1.é¿å…Innodbè¡¨è¿›è¡Œç´¢å¼•çš„äºŒæ¬¡æŸ¥è¯¢ï¼ˆå›è¡¨ï¼‰\nInnodbä¸­ï¼ŒäºŒçº§ç´¢å¼•åœ¨å¶å­èŠ‚ç‚¹ä¸­ä¿å­˜çš„æ•°æ®æ˜¯è¡Œçš„ä¸»é”®ä¿¡æ¯ï¼Œå¦‚æœæ˜¯ç”¨äºŒçº§ç´¢å¼•æŸ¥è¯¢æ•°æ®ï¼Œåœ¨æŸ¥åˆ°ç›¸åº”çš„é”®å€¼åï¼Œè¿˜éœ€è¦è¿›è¡ŒäºŒæ¬¡æŸ¥è¯¢æ¥è·å–çœŸå®æ•°æ®\nåœ¨è¦†ç›–ç´¢å¼•ä¸­ï¼ŒäºŒçº§ç´¢å¼•çš„é”®å€¼å¯ä»¥è·å–æˆ‘ä»¬éœ€è¦çš„æ•°æ®ï¼Œé¿å…äº†å¯¹ä¸»é”®çš„äºŒæ¬¡æŸ¥è¯¢ï¼Œå‡å°‘äº†IOæ“ä½œï¼Œæå‡äº†æŸ¥è¯¢æ•ˆç‡\n2.å¯ä»¥æŠŠéšæœºIOæˆé¡ºåºIOåŠ å¿«æŸ¥è¯¢æ•ˆç‡\nç”±äºè¦†ç›–ç´¢å¼•æ˜¯æŒ‰ç…§é”®å€¼çš„é¡ºåºå­˜å‚¨çš„ï¼Œå¯¹äºIOå¯†é›†å‹çš„èŒƒå›´æŸ¥æ‰¾æ¥è¯´ï¼Œå¯¹æ¯”éšæœºä»ç£ç›˜è¯»å–æ¯ä¸€è¡Œçš„æ•°æ®IOè¦å°‘çš„å¤šï¼Œå› æ­¤åˆ©ç”¨è¦†ç›–ç´¢å¼•åœ¨è®¿é—®æ—¶ä¹Ÿå¯ä»¥æŠŠç£ç›˜çš„éšæœºè¯»å–IOè½¬å˜ä¸ºé¡ºåºIOã€‚\nè‹¥ä¸ä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼Œéœ€è¦è¿›è¡Œå›è¡¨æ“ä½œï¼Œè€Œä¸åŒçš„åŒºå¯èƒ½å¤„äºä¸åŒçš„ä½ç½®ï¼Œä¼šå¯¼è‡´åŠ è½½æ›´å¤šçš„ç£ç›˜æ•°æ®\n\nå¼Šç«¯ï¼šç´¢å¼•å­—æ®µçš„ç»´æŠ¤éœ€è¦ä»˜å‡ºä»£ä»·ï¼Œå› æ­¤åœ¨å»ºç«‹å†—ä½™ç´¢å¼•æ¥æ”¯æŒè¦†ç›–ç´¢å¼•æ—¶å°±éœ€è¦æƒè¡¡è€ƒè™‘\n\nä¸»é”®çš„è®¾è®¡ï¼š\n1.è‡ªå¢idå­˜åœ¨çš„é—®é¢˜ï¼š\n1.å¯é æ€§ä¸é«˜ï¼šå­˜åœ¨è‡ªå¢idå›æº¯çš„é—®é¢˜ï¼Œ8.0ç‰ˆæœ¬è¿›è¡Œäº†ä¿®å¤\n\n\n2.å®‰å…¨æ€§ä¸é«˜å¯¹å¤–æš´æ¼çš„æ¥å£å¯ä»¥éå¸¸å®¹æ˜“çš„çŒœæµ‹å¯¹åº”çš„ä¿¡æ¯ï¼Œå¦‚ï¼šuser&#x2F;1è¿™æ ·çš„æ¥å£ï¼Œä»è€Œå¯¹æ•°æ®è¿›è¡Œçˆ¬å–\n\n\n3.æ€§èƒ½å·®ï¼šè‡ªå¢idçš„æ€§èƒ½å·®ï¼Œéœ€è¦å†æ•°æ®åº“æœåŠ¡å™¨ç«¯ç”Ÿæˆ\n\n4.äº¤äº’å¤šï¼šä¸šåŠ¡è¿˜éœ€è¦é¢å¤–æ‰§è¡Œä¸€æ¬¡ç±»ä¼¼last_insert_id()çš„å‡½æ•°æ‰èƒ½çŸ¥é“åˆšæ‰æ’å…¥çš„è‡ªå¢å€¼ï¼Œå†å¤šè¿›è¡Œä¸€æ¬¡ç½‘ç»œäº¤äº’ï¼Œåœ¨æµ·é‡çš„å¹¶å‘ç³»ç»Ÿä¸­ï¼Œå¤šä¸€æ¡sqlå°±å¤šä¸€æ¬¡æ€§èƒ½çš„å¼€é”€\n\n5.å±€éƒ¨å”¯ä¸€æ€§ï¼šæœ€é‡è¦çš„ä¸€ç‚¹ï¼Œè‡ªå¢idæ˜¯å±€éƒ¨å”¯ä¸€ï¼Œåªæ˜¯åœ¨å½“å‰æ•°æ®åº“å®ä¾‹ä¸­å”¯ä¸€ï¼Œè€Œä¸æ˜¯å…¨å±€å”¯ä¸€ï¼ˆåœ¨ä»»æ„æœåŠ¡å™¨é—´éƒ½æ˜¯å”¯ä¸€çš„ï¼‰ï¼Œåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿè¯´æ˜¯å™©æ¢¦\n\n2.ä¸šåŠ¡å­—æ®µä½œä¸ºä¸»é”®ï¼šä¸å¤ªåˆé€‚1.ä¸èƒ½ä½¿ç”¨ä¼šå‘˜å¡å·ä½œä¸ºä¸»é”®\nâ€‹\tå¦‚æœä¼šå‘˜å¡å·ä¸å†ä½¿ç”¨æ³¨é”€äº†ï¼Œå°±å¯ä»¥å†ç»™å…¶ä»–äººç”¨è¯¥å¡å·ï¼Œä¼šå¯¼è‡´æ•°æ®åº“ä¸­æŸ¥è¯¢å‡ºè¯¥å¡å·çš„æ¶ˆè´¹ä¿¡æ¯æ˜¯ä¸Šä¸€ä¸ªäººçš„\n2.èº«ä»½è¯å·æˆ–ç”µè¯ä¹Ÿä¸èƒ½ä½œä¸ºä¸»é”®\nâ€‹\tç”µè¯æ³¨é”€ï¼Œæ‰‹æœºä¹Ÿå­˜åœ¨è¢«è¿è¥å•†æ”¶å›å†åˆ©ç”¨çš„æƒ…å†µ\nâ€‹\tèº«ä»½è¯å·å±äºä¸ªäººéšç§ï¼Œä¹Ÿä¸èƒ½ä½¿ç”¨\n\n\nè®¾è®¡ä¸»é”®çš„å»ºè®®:éæ ¸å¿ƒä¸šåŠ¡ï¼šå¯¹åº”è¡¨çš„ä¸»é”®è‡ªå¢ID å¦‚æ—¥å¿—ï¼Œç›‘æ§ç­‰ä¿¡æ¯\næ ¸å¿ƒä¸šåŠ¡ï¼šä¸»é”®çš„è®¾è®¡åº”è¯¥æ˜¯å…¨å±€å”¯ä¸€ä¸”å•è°ƒè‡ªå¢ï¼Œå…¨å±€å”¯ä¸€ä¿è¯å„ä¸ªç³»ç»Ÿä¸­éƒ½æ˜¯å”¯ä¸€çš„ï¼Œå•è°ƒé€’å¢æ˜¯å¸Œæœ›æ’å…¥æ—¶ä¸å½±å“æ•°æ®åº“æ€§èƒ½\n\nå­æŸ¥è¯¢ä¼˜åŒ–\nå­æŸ¥è¯¢æ‰§è¡Œæ•ˆç‡ä¸é«˜çš„åŸå› ï¼š1.æ‰§è¡Œå­æŸ¥è¯¢æ—¶ï¼ŒMySQLéœ€è¦ä¸ºå†…å±‚æŸ¥è¯¢è¯­å¥çš„æŸ¥è¯¢ç»“æœå»ºç«‹ä¸€ä¸ªä¸´æ—¶è¡¨ï¼Œç„¶åå¤–å±‚æŸ¥è¯¢è¯­å¥ä»ä¸´æ—¶è¡¨ä¸­æŸ¥è¯¢è®°å½•ï¼ŒæŸ¥è¯¢å®Œæ¯•åå†æ’¤é”€ä¸´æ—¶è¡¨ï¼Œè¿™æ ·ä¼šæ¶ˆè€—è¿‡å¤šçš„CPUå’ŒIOèµ„æºï¼Œäº§ç”Ÿå¤§é‡æ…¢æŸ¥è¯¢\n2.å­æŸ¥è¯¢çš„ç»“æœé›†å­˜å‚¨çš„ä¸´æ—¶è¡¨ï¼Œä¸è®ºæ˜¯å†…å­˜ä¸´æ—¶è¡¨è¿˜æ˜¯ç£ç›˜ä¸´æ—¶è¡¨éƒ½ä¸ä¼šå­˜åœ¨ç´¢å¼•ï¼Œæ‰€ä»¥æŸ¥è¯¢æ€§èƒ½ä¼šå—åˆ°ä¸€å®šçš„å½±å“\n3.å¯¹äºè¿”å›ç»“æœé›†æ¯”è¾ƒå¤§çš„å­æŸ¥è¯¢ï¼Œå…¶å¯¹æŸ¥è¯¢æ€§èƒ½ä¹Ÿæœ‰ä¸€å®šçš„å½±å“\n\nä¼˜åŒ–ï¼šå»ºè®®åœ¨MySQLä¸­ä½¿ç”¨è¿æ¥ï¼ˆjoinï¼‰æŸ¥è¯¢æ¥æ›¿ä»£å­æŸ¥è¯¢ï¼Œè¿æ¥æŸ¥è¯¢ä¸éœ€è¦å»ºç«‹ä¸´æ—¶è¡¨ï¼Œå…¶é€Ÿåº¦æ¯”å­æŸ¥è¯¢è¦å¿«ï¼Œè€Œä¸”å¯ä»¥æ·»åŠ ç´¢å¼•è¿›ä¸€æ­¥ä¼˜åŒ–æ€§èƒ½\n","slug":"ç´¢å¼•ä¼˜åŒ–ä¸æŸ¥è¯¢ä¼˜åŒ–","date":"2022-06-11T12:12:38.267Z","categories_index":"MySQL","tags_index":"MySQL","author_index":"å°æä¸åœ¨_"},{"id":"4a36e618a4b7e38da744c1d2baebbf87","title":"èŒƒå¼","content":"\nèŒƒå¼ï¼šåœ¨å…³ç³»å‹æ•°æ®åº“ä¸­ï¼Œå…³äºæ•°æ®è¡¨è®¾è®¡çš„åŸºæœ¬åŸåˆ™ï¼Œè§„åˆ™å°±æˆä¸ºèŒƒå¼\nç›®å‰å…³ç³»å‹æ•°æ®åº“æœ‰å…­ç§å¸¸è§èŒƒå¼ï¼ŒæŒ‰ç…§èŒƒå¼çº§åˆ«ï¼Œä»ä½åˆ°é«˜åˆ†åˆ«æ˜¯ï¼šç¬¬ä¸€èŒƒå¼ï¼ˆ1NFï¼‰ã€ç¬¬äºŒèŒƒå¼ï¼ˆ2NFï¼‰ã€ç¬¬ä¸‰èŒƒå¼ï¼ˆ3NFï¼‰ã€å·´æ–¯-ç§‘å¾·èŒƒå¼ï¼ˆBCNFï¼‰ã€ç¬¬å››èŒƒå¼(4NFï¼‰å’Œç¬¬äº”èŒƒå¼ï¼ˆ5NFï¼Œåˆç§°å®Œç¾èŒƒå¼ï¼‰ã€‚\n\næ•°æ®åº“çš„èŒƒå¼è®¾è®¡è¶Šé«˜é˜¶ï¼Œå†—ä½™åº¦å°±è¶Šä½ï¼ŒåŒæ—¶é«˜é˜¶çš„èŒƒå¼ä¸€å®šç¬¦åˆä½é˜¶èŒƒå¼çš„è¦æ±‚ï¼Œæœ€ä½è¦æ±‚ä¸ºç¬¬ä¸€èŒƒå¼\nä¸€èˆ¬æ¥è¯´ï¼Œåœ¨å…³ç³»å‹æ•°æ®åº“è®¾è®¡ä¸­ï¼Œæœ€é«˜ä¹Ÿå°±éµå¾ªåˆ°BCNF(å·´æ–¯èŒƒå¼ï¼‰ï¼Œæ™®éè¿˜æ˜¯3NFï¼Œä½†ä¹Ÿä¸æ˜¯ç»å¯¹ï¼Œæœ‰æ—¶å€™ä¸ºäº†æé«˜æŸäº›æŸ¥è¯¢æ€§èƒ½ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ç ´åèŒƒå¼è§„åˆ™ï¼Œä¹Ÿå°±æ˜¯åèŒƒå¼åŒ–\n\nç¬¬ä¸€èŒƒå¼:ç¡®ä¿æ•°æ®è¡¨ä¸­æ¯ä¸ªå­—æ®µçš„å€¼å¿…é¡»å…·æœ‰åŸå­æ€§ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯ä¸ªæ•°æ®è¡¨ä¸­æ¯ä¸ªå­—æ®µçš„å€¼ä¸ºä¸å¯å†æ¬¡æ‹†åˆ†çš„æœ€å°å•å…ƒæ•°æ®\n\nç¬¬äºŒèŒƒå¼ï¼šåœ¨æ»¡è¶³ç¬¬ä¸€èŒƒå¼çš„åŸºç¡€ä¸Šï¼Œè¿˜è¦æ»¡è¶³æ•°æ®è¡¨ä¸­çš„æ¯ä¸€æ¡è®°å½•éƒ½æ˜¯å¯å”¯ä¸€æ ‡è¯†çš„ï¼Œè€Œä¸”æ‰€æœ‰çš„éä¸»é”®å­—æ®µï¼Œéƒ½å¿…é¡»å®Œå…¨ä¾èµ–ä¸»é”®ï¼Œä¸èƒ½åªä¾èµ–ä¸»é”®çš„ä¸€éƒ¨åˆ†\nä¾‹å¦‚ï¼šæˆç»©è¡¨ä¸­ï¼Œå­¦å·å’Œè¯¾ç¨‹å·å¯ä»¥å†³å®šæˆç»©ï¼Œä½†æ˜¯å­¦å·ä¸èƒ½å†³å®šæˆç»©ï¼Œè¯¾ç¨‹å·ä¹Ÿä¸èƒ½å†³å®šæˆç»©ï¼Œ\næ‰€ä»¥ï¼ˆå­¦å·ã€è¯¾ç¨‹å·ï¼‰â€“ã€‹æˆç»© Â å°±æ˜¯å®Œå…¨ä¾èµ–å…³ç³»\n\nç¬¬ä¸‰èŒƒå¼ï¼šåœ¨ç¬¬äºŒèŒƒå¼çš„åŸºç¡€ä¸Šï¼Œç¡®ä¿æ•°æ®è¡¨ä¸­çš„æ¯ä¸€ä¸ªéä¸»é”®å­—æ®µéƒ½å’Œä¸»é”®å­—æ®µç›´æ¥ç›¸å…³ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¦æ±‚æ•°æ®è¡¨ä¸­çš„æ‰€æœ‰éä¸»é”®å­—æ®µä¸èƒ½ä¾èµ–äºå…¶ä»–éä¸»é”®å­—æ®µ\nå³ï¼š\nä¸èƒ½å­˜åœ¨éä¸»é”®å­—æ®µAä¾èµ–äºéä¸»é”®Bï¼Œè€Œéä¸»é”®Båˆä¾èµ–äºä¸»é”®Cï¼Œå³å­˜åœ¨A-&gt;B-&gt;Cçš„å…³ç³»\n\næ€»ç»“ï¼š1.ç¬¬ä¸€èŒƒå¼ï¼Œç¡®ä¿äº†æ¯åˆ—ä¿æŒåŸå­æ€§\n2.ç¬¬äºŒèŒƒå¼ï¼Œç¡®ä¿äº†æ¯åˆ—éƒ½å’Œä¸»é”®å®Œå…¨ä¾èµ–\n3.ç¬¬ä¸‰èŒƒå¼ï¼Œç¡®ä¿äº†æ¯åˆ—éƒ½å’Œä¸»é”®åˆ—ç›´æ¥ç›¸å…³è€Œä¸èƒ½é—´æ¥ç›¸å…³ï¼ˆA-&gt;B,B-&gt;Cï¼Œä¸èƒ½æ˜¯A-&gt;B-&gt;Cï¼‰\nä¼˜ç‚¹ï¼šæ•°æ®çš„æ ‡å‡†åŒ–æœ‰åŠ©äºæ¶ˆé™¤æ•°æ®åº“ä¸­çš„æ•°æ®å†—ä½™ï¼Œç¬¬ä¸‰èŒƒå¼é€šå¸¸è¢«è®¤ä¸ºåœ¨æ€§èƒ½ï¼Œæ‰©å±•æ€§å’Œæ•°æ®å®Œæ•´æ€§æ–¹é¢è¾¾åˆ°äº†æœ€å¥½çš„å¹³è¡¡\nç¼ºç‚¹ï¼šèŒƒå¼çš„ä½¿ç”¨å¯èƒ½ä¼šé™ä½æŸ¥è¯¢æ•ˆç‡ï¼Œå› ä¸ºèŒƒå¼çš„ç­‰çº§è¶Šé«˜ï¼Œè®¾è®¡å‡ºæ¥çš„æ•°æ®è¡¨å°±è¶Šå¤šï¼Œè¶Šç²¾ç»†ï¼Œæ•°æ®çš„å†—ä½™åº¦è¶Šä½ï¼Œè¿›è¡Œæ•°æ®æŸ¥è¯¢çš„æ—¶å€™å¯èƒ½å°±éœ€è¦å…³è”å¤šå¼ è¡¨ï¼Œä¹Ÿå¯èƒ½å¯¼è‡´ä¸€äº›ç´¢å¼•ç­–ç•¥å¤±æ•ˆ\n\n\nåèŒƒå¼åŒ–ï¼šä¸èƒ½åªæŒ‰ç…§èŒƒå¼çš„è¦æ±‚è¿›è¡Œæ•°æ®åº“è¡¨çš„è®¾è®¡ï¼Œè¦éµå¾ªä¸šåŠ¡ä¼˜å…ˆçš„åŸåˆ™\næœ‰æ—¶å€™å¯ä»¥è€ƒè™‘é€‚å½“å¢åŠ å†—ä½™çš„å­—æ®µæ¥å‡å°‘è¡¨çš„å…³è”æŸ¥è¯¢ï¼Œä»è€Œè¾¾åˆ°å¯¹æ€§èƒ½ä¼˜åŒ–çš„æ•ˆæœï¼Œå¢åŠ å†—ä½™å­—æ®µå°±æ˜¯åèŒƒå¼åŒ–\n\nè§„èŒƒåŒ– vs æ€§èƒ½\nä¸ºæ»¡è¶³æŸç§å•†ä¸šç›®æ ‡ , æ•°æ®åº“æ€§èƒ½æ¯”è§„èŒƒåŒ–æ•°æ®åº“æ›´é‡è¦\nåœ¨æ•°æ®è§„èŒƒåŒ–çš„åŒæ—¶ , è¦ç»¼åˆè€ƒè™‘æ•°æ®åº“çš„æ€§èƒ½\né€šè¿‡åœ¨ç»™å®šçš„è¡¨ä¸­æ·»åŠ é¢å¤–çš„å­—æ®µï¼Œä»¥å¤§é‡å‡å°‘éœ€è¦ä»ä¸­æœç´¢ä¿¡æ¯æ‰€éœ€çš„æ—¶é—´\né€šè¿‡åœ¨ç»™å®šçš„è¡¨ä¸­æ’å…¥è®¡ç®—åˆ—ï¼Œä»¥æ–¹ä¾¿æŸ¥è¯¢\n\n\nåèŒƒå¼åŒ–çš„æ–°é—®é¢˜ï¼š1.å­˜å‚¨ç©ºé—´å˜å¤§äº†\n2.ä¸€ä¸ªè¡¨ä¸­å­—æ®µåšäº†ä¿®æ”¹ï¼Œå¦ä¸€ä¸ªè¡¨ä¸­å†—ä½™çš„å­—æ®µä¹Ÿéœ€è¦åŒæ­¥ä¿®æ”¹ï¼Œå¦åˆ™æ•°æ®ä¸ä¸€è‡´\n3.è‹¥é‡‡ç”¨å­˜å‚¨è¿‡ç¨‹æ¥æ”¯æŒæ•°æ®çš„æ›´æ–°ã€åˆ é™¤ç­‰æ“ä½œï¼Œå¦‚æœæ›´æ–°é¢‘ç¹ä¼šå¾ˆæ¶ˆè€—ç³»ç»Ÿèµ„æº\n4.åœ¨æ•°æ®é‡å°çš„æƒ…å†µä¸‹ï¼ŒåèŒƒå¼åŒ–ä¸èƒ½ä½“ç°æ€§èƒ½çš„ä¼˜åŠ¿ï¼Œå¯èƒ½è¿˜ä¼šè®©æ•°æ®åº“è¡¨çš„è®¾è®¡æ›´åŠ å¤æ‚\n\nä½¿ç”¨åœºæ™¯ï¼šå½“å†—ä½™ä¿¡æ¯æœ‰ä»·å€¼æˆ–è€…èƒ½å¤§å¹…åº¦æå‡æŸ¥è¯¢æ•ˆç‡çš„æ—¶å€™æ‰ä¼šä½¿ç”¨åèŒƒå¼åŒ–\n\n1.å¢åŠ å†—ä½™å­—æ®µçš„å»ºè®®ï¼šâ‘ ï¼šå†—ä½™å­—æ®µä¸éœ€è¦ç»å¸¸è¿›è¡Œä¿®æ”¹\nâ‘¡ï¼šå†—ä½™å­—æ®µæŸ¥è¯¢çš„æ—¶å€™ä¸å¯æˆ–ç¼º\n\n2.å†å²å¿«ç…§ã€å†å²æ•°æ®çš„éœ€è¦æ¯”å¦‚è®¢å•ä¸­çš„æ”¶è´§äººï¼Œåœ°å€ç­‰ä¿¡æ¯ï¼Œæ¯æ¬¡å‘ç”Ÿçš„è®¢å•æ”¶è´§ä¿¡æ¯éƒ½å±äºå†å²æ•°æ®ï¼Œéœ€è¦è¿›è¡Œä¿å­˜ï¼Œä½†æ˜¯ç”¨æˆ·éšæ—¶æœ‰å¯èƒ½å¯¹æ”¶è´§ä¿¡æ¯è¿›è¡Œä¿®æ”¹ï¼Œæ‰€ä»¥å†—ä½™å­—æ®µçš„ä¿å­˜æ˜¯ååˆ†å¿…è¦çš„\n\n3.æ•°æ®ä»“åº“çš„è®¾è®¡ä¸­é€šå¸¸ä½¿ç”¨åèŒƒå¼åŒ–æ•°æ®ä»“åº“é€šå¸¸ç”¨æ¥å­˜å‚¨å†å²ä¿¡æ¯ï¼Œå¯¹äºä¿¡æ¯çš„ä¿®æ”¹æ¯”è¾ƒå°‘ï¼Œä½†æ˜¯è®¾ç½®å†—ä½™å­—æ®µå¯èƒ½æ›´åˆ©äºæ•°æ®åˆ†æ\n\n4.å·´æ–¯èŒƒå¼ BCNF","slug":"èŒƒå¼","date":"2022-06-11T11:53:14.859Z","categories_index":"MySQL","tags_index":"MySQL","author_index":"å°æä¸åœ¨_"},{"id":"fdf7bb567823aed005b212decd2fd46a","title":"æ•°æ®è¡¨çš„è®¾è®¡åŸåˆ™","content":"\næ•°æ®è¡¨çš„è®¾è®¡åŸåˆ™ï¼šï¼ˆå…·ä½“æ ¹æ®å®é™…æƒ…å†µï¼‰1.æ•°æ®è¡¨çš„ä¸ªæ•°è¶Šå°‘è¶Šå¥½\n2.æ•°æ®è¡¨ä¸­çš„å­—æ®µè¶Šå°‘è¶Šå¥½\n3.æ•°æ®è¡¨ä¸­è”åˆä¸»é”®çš„å­—æ®µä¸ªæ•°è¶Šå°‘è¶Šå¥½\nâ€‹\tè”åˆä¸»é”®çš„å­—æ®µè¶Šå¤šï¼Œå¯¼è‡´å ç”¨çš„ç´¢å¼•ç©ºé—´è¾ƒå¤§\n4.ä½¿ç”¨ä¸»é”®å’Œå¤–é”®è¶Šå¤šè¶Šå¥½\nâ€‹\tæ­¤å¤„çš„å¤–é”®å¹¶ä¸ä¸€å®šæ˜¯æŒ‡æ•°æ®åº“ä¸­çš„å¤–é”®ï¼Œè€Œæ˜¯æŒ‡ä¸€ç§ä¸šåŠ¡é€»è¾‘å…³ç³»ï¼Œè¡¨å’Œè¡¨å­—æ®µä¹‹é—´æœ‰ä¸€å¯¹ä¸€ã€ä¸€å¯¹å¤šçš„é€»è¾‘å…³ç³»ï¼Œä¹Ÿå¯ä»¥åœ¨ä¸šåŠ¡é€»è¾‘å±‚è¿›è¡Œå®ç°\n","slug":"æ•°æ®è¡¨çš„è®¾è®¡åŸåˆ™","date":"2022-06-11T11:53:14.856Z","categories_index":"MySQL","tags_index":"MySQL","author_index":"å°æä¸åœ¨_"},{"id":"c027261888329c6d8eabd6851937e11d","title":"MVCC","content":"\nå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼šMVCCå°±æ˜¯é€šè¿‡æ•°æ®è¡Œçš„å¤šä¸ªç‰ˆæœ¬æ¥ç®¡ç†å®ç°æ•°æ®åº“çš„å¹¶å‘æ§åˆ¶ï¼Œè¿™é¡¹æŠ€æœ¯ä½¿å¾—åœ¨InnoDBçš„äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸‹æ‰§è¡Œä¸€ç›´æ€§è¯»æ“ä½œæœ‰äº†ä¿è¯ï¼Œæ¢è¨€ä¹‹å°±æ˜¯ä¸ºäº†æŸ¥è¯¢ä¸€äº›æ­£åœ¨è¢«å¦ä¸€ä¸ªäº‹åŠ¡æ›´æ–°çš„è¡Œï¼Œå¹¶ä¸”å¯ä»¥çœ‹åˆ°ä»–ä»¬è¢«æ›´æ–°ä¹‹å‰çš„å€¼ï¼Œè¿™æ ·åœ¨åšæŸ¥è¯¢çš„æ—¶å€™å°±ä¸ç”¨ç­‰å¾…å¦ä¸€ä¸ªäº‹åŠ¡é‡Šæ”¾é”\n\nMVCCçš„å®ç°ä¾èµ–äºï¼šéšè—å­—æ®µã€Undo Logã€ReadViewMySQLä¸­åªæœ‰InnoDBå­˜å‚¨å¼•æ“æ”¯æŒMVCC\nMySQLä¸­é»˜è®¤çš„éš”ç¦»çº§åˆ«æ˜¯å¯é‡å¤è¯»ï¼Œè§£å†³äº†è„è¯»å’Œä¸å¯é‡å¤è¯»çš„é—®é¢˜ï¼Œä½†æ˜¯MVCCå¯ä»¥ä¸é‡‡ç”¨é”æœºåˆ¶ï¼Œè€Œæ˜¯é€šè¿‡ä¹è§‚é”çš„æ–¹å¼æ¥è§£å†³ä¸å¯é‡å¤è¯»å’Œå¹»è¯»çš„é—®é¢˜ï¼\n\néšè—å­—æ®µã€Undo Logç‰ˆæœ¬é“¾ï¼štrx_idï¼šæ¯æ¬¡ä¸€ä¸ªäº‹åŠ¡å¯¹æŸæ¡èšç°‡ç´¢å¼•è®°å½•è¿›è¡Œæ”¹åŠ¨æ—¶ï¼Œéƒ½ä¼šæŠŠè¯¥äº‹åŠ¡çš„äº‹åŠ¡idå¤åˆ¶ç»™trx_idéšè—åˆ—\nroll_pointerï¼šæ¯æ¬¡å¯¹æŸæ¡èšç°‡ç´¢å¼•è¿›è¡Œæ”¹åŠ¨ æ—¶ï¼Œéƒ½ä¼šæŠŠæ—§çš„ç‰ˆæœ¬å†™å…¥undoæ—¥å¿—ä¸­ï¼Œè¿™ä¸ªéšè—åˆ—ç›¸å½“äºä¸€ä¸ªæŒ‡é’ˆï¼Œå¯é€šè¿‡å®ƒæ¥æ‰¾åˆ°è¯¥è®°å½•ä¿®æ”¹ä¹‹å‰çš„ä¿¡æ¯\næ¯æ¬¡å¯¹è®°å½•è¿›è¡Œæ”¹åŠ¨ï¼Œéƒ½ä¼šè®°å½•ä¸€æ¡undoæ—¥å¿—ï¼Œæ¯æ¡undoæ—¥å¿—ä¹Ÿéƒ½æœ‰ä¸€ä¸ª roll_pointer å±æ€§ï¼ˆ INSERT æ“ä½œå¯¹åº”çš„undoæ—¥å¿—æ²¡æœ‰è¯¥å±æ€§ï¼Œå› ä¸ºè¯¥è®°å½•å¹¶æ²¡æœ‰æ›´æ—©çš„ç‰ˆæœ¬ï¼‰ï¼Œå¯ä»¥å°†è¿™äº› undoæ—¥å¿—éƒ½è¿èµ·æ¥ï¼Œä¸²æˆä¸€ä¸ªé“¾è¡¨ï¼š\n\nå¯¹è¯¥è®°å½•æ¯æ¬¡æ›´æ–°åï¼Œéƒ½ä¼šå°†æ—§å€¼æ”¾åˆ°ä¸€æ¡ undoæ—¥å¿— ä¸­ï¼Œå°±ç®—æ˜¯è¯¥è®°å½•çš„ä¸€ä¸ªæ—§ç‰ˆæœ¬ï¼Œéšç€æ›´æ–°æ¬¡æ•°çš„å¢å¤šï¼Œæ‰€æœ‰çš„ç‰ˆæœ¬éƒ½ä¼šè¢« roll_pointer å±æ€§è¿æ¥æˆä¸€ä¸ªé“¾è¡¨ï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªé“¾è¡¨ç§°ä¹‹ä¸º ç‰ˆæœ¬é“¾ ï¼Œç‰ˆæœ¬é“¾çš„å¤´èŠ‚ç‚¹å°±æ˜¯å½“å‰è®°å½•æœ€æ–°çš„å€¼ã€‚æ¯ä¸ªç‰ˆæœ¬ä¸­è¿˜åŒ…å«ç”Ÿæˆè¯¥ç‰ˆæœ¬æ—¶å¯¹åº”çš„ äº‹åŠ¡id ã€‚\n\nReadViewï¼šï¼ˆæ ¸å¿ƒï¼‰\n1.ä»€ä¹ˆæ—¶ReadViewï¼Ÿåœ¨MVCCæœºåˆ¶ä¸­ï¼Œå¤šä¸ªäº‹åŠ¡å¯¹åŒä¸€ä¸ªè¡Œè®°å½•è¿›è¡Œæ›´æ–°ä¼šäº§ç”Ÿå¤šä¸ªå†å²å¿«ç…§ï¼Œè¿™äº›å†å²å¿«ç…§ä¿å­˜åœ¨Undo Logä¸­ã€‚å¦‚æœä¸€ä¸ªäº‹åŠ¡æƒ³è¦æŸ¥è¯¢è¿™ä¸ªè¡Œè®°å½•ï¼Œéœ€è¦è¯»å–å“ªä¸ªç‰ˆæœ¬çš„è¡Œè®°å½•å‘¢ï¼Ÿè¿™æ—¶å°±éœ€è¦ç”¨åˆ°ReadViewäº†ï¼Œå¸®æˆ‘ä»¬è§£å†³å¯è§æ€§çš„é—®é¢˜\nReadViewå°±æ˜¯ä¸€ä¸ªäº‹åŠ¡åœ¨ä½¿ç”¨MVCCæœºåˆ¶è¿›è¡Œå¿«ç…§è¯»å–æ“ä½œæ—¶äº§ç”Ÿçš„è¯»è§†å›¾ï¼Œå½“äº‹åŠ¡å¯åŠ¨æ—¶ï¼Œä¼šæ ¹æ®æ•°æ®åº“ç³»ç»Ÿå½“å‰çš„ä¸€ä¸ªå¿«ç…§ï¼ŒInnoDBä¸ºæ¯ä¸ªäº‹åŠ¡æ„é€ äº†ä¸€ä¸ªæ•°ç»„ï¼Œç”¨æ¥è®°å½•å¹¶ç»´æŠ¤ç³»ç»Ÿå½“å‰æ´»è·ƒäº‹åŠ¡çš„idï¼ˆæ´»è·ƒå°±æ˜¯å¯åŠ¨äº†äº‹åŠ¡ä½†æ˜¯æ²¡æœ‰æäº¤ï¼‰\n\nMVCCæ•´ä½“æ“ä½œæµç¨‹\né¦–å…ˆè·å–äº‹åŠ¡è‡ªå·±çš„ç‰ˆæœ¬å·ï¼Œä¹Ÿå°±æ˜¯äº‹åŠ¡ IDï¼›\nè·å– ReadViewï¼›\næŸ¥è¯¢å¾—åˆ°çš„æ•°æ®ï¼Œç„¶åä¸ ReadView ä¸­çš„äº‹åŠ¡ç‰ˆæœ¬å·è¿›è¡Œæ¯”è¾ƒï¼›\nå¦‚æœä¸ç¬¦åˆ ReadView è§„åˆ™ï¼Œå°±éœ€è¦ä» Undo Log ä¸­è·å–å†å²å¿«ç…§ï¼›\næœ€åè¿”å›ç¬¦åˆè§„åˆ™çš„æ•°æ®ã€‚\n\n\næ€»ç»“ï¼šMVCCåªæœ‰åœ¨è¯»å·²æäº¤å’Œå¯é‡å¤è¯»ä¸¤ç§éš”ç¦»çº§åˆ«çš„äº‹åŠ¡åœ¨æ‰§è¡Œå¿«ç…§è¯»æ“ä½œæ—¶è®¿é—®è®°å½•ç‰ˆæœ¬é“¾çš„è¿‡ç¨‹ï¼Œè¿™æ ·ä½¿ä¸åŒäº‹åŠ¡çš„è¯»-å†™ã€å†™-è¯»æ“ä½œå¹¶å‘æ‰§è¡Œï¼Œæå‡ç³»ç»Ÿæ€§èƒ½\næ ¸å¿ƒç‚¹åœ¨äºReadViewçš„åŸç†ï¼Œè¯»å·²æäº¤å’Œå¯é‡å¤è¯»è¿™ä¸¤ä¸ªéš”ç¦»çº§åˆ«çš„å¾ˆå¤§ä¸åŒå°±æ˜¯ç”ŸæˆReadViewçš„æ—¶æœºä¸åŒï¼š\nREAD COMMITTDåœ¨æ¯æ¬¡è¿›è¡Œæ™®é€šçš„SELECTæ“ä½œå‰éƒ½ä¼šç”Ÿæˆä¸€ä¸ªReadView\n\nREPEATABLE READåªä¼šåœ¨ç¬¬ä¸€æ¬¡è¿›è¡Œæ™®é€šçš„SELECTæ“ä½œå‰ç”Ÿæˆä¸€ä¸ªReadViewï¼Œä¹‹åçš„æŸ¥è¯¢éƒ½é‡å¤ä½¿ç”¨è¿™ä¸ªReadView\n\n\né€šè¿‡MVCCå¯ä»¥è§£å†³çš„é—®é¢˜ï¼š1.è¯»å†™ä¹‹é—´é˜»å¡çš„é—®ã€‚é€šè¿‡MVCCå¯ä»¥è®©è¯»å†™äº’ç›¸ä¸é˜»å¡ï¼Œå³è¯»ä¸é˜»å¡å†™ï¼Œå†™ä¸é˜»å¡è¯»ï¼Œè¿™æ ·å°±å¯ä»¥æå‡äº‹åŠ¡å¹¶å‘å¤„ç†èƒ½åŠ›\n2.é™ä½äº†æ­»é”çš„æ¦‚ç‡ã€‚å› ä¸ºMVCCé‡‡ç”¨äº†ä¹è§‚é”çš„æ–¹å¼ï¼Œè¯»å–æ•°æ®æ—¶å¹¶ä¸éœ€è¦åŠ é”ï¼Œå¯¹äºå†™æ“ä½œï¼Œä¹Ÿåªé”å®šäº†å¿…è¦çš„è¡Œ\n3.è§£å†³å¿«ç…§è¯»çš„é—®é¢˜ã€‚å½“æˆ‘ä»¬æŸ¥è¯¢æ•°æ®åº“åœ¨æŸä¸ªæ—¶é—´ç‚¹çš„å¿«ç…§æ—¶ï¼Œåªèƒ½çœ‹åˆ°è¿™ä¸ªæ—¶é—´ç‚¹ä¹‹å‰äº‹åŠ¡æäº¤æ›´æ–°çš„ç»“æœï¼Œè€Œä¸èƒ½çœ‹åˆ°è¿™ä¸ªæ—¶é—´ç‚¹ä¹‹åäº‹åŠ¡æäº¤çš„æ›´æ–°ç»“æœ\n","slug":"MVCC","date":"2022-06-11T11:53:14.852Z","categories_index":"MySQL","tags_index":"MySQL","author_index":"å°æä¸åœ¨_"},{"id":"0cb8b12f38f1e4c52cf2229e17b82a90","title":"Dubboæºç åˆ†æ","content":"å‡†å¤‡ä»€ä¹ˆæ˜¯ Dubbo?Apache Dubbo (incubating) |ËˆdÊŒbÉ™ÊŠ| Â æ˜¯ä¸€æ¬¾é«˜æ€§èƒ½ã€è½»é‡çº§çš„å¼€æº Java RPC æ¡†æ¶ã€‚\næ ¹æ® Dubbo å®˜æ–¹æ–‡æ¡£çš„ä»‹ç»ï¼ŒDubbo æä¾›äº†å…­å¤§æ ¸å¿ƒèƒ½åŠ›\n\né¢å‘æ¥å£ä»£ç†çš„é«˜æ€§èƒ½RPCè°ƒç”¨ã€‚\næ™ºèƒ½å®¹é”™å’Œè´Ÿè½½å‡è¡¡ã€‚\næœåŠ¡è‡ªåŠ¨æ³¨å†Œå’Œå‘ç°ã€‚\né«˜åº¦å¯æ‰©å±•èƒ½åŠ›ã€‚\nè¿è¡ŒæœŸæµé‡è°ƒåº¦ã€‚\nå¯è§†åŒ–çš„æœåŠ¡æ²»ç†ä¸è¿ç»´ã€‚\n\n\nç®€å•æ¥è¯´å°±æ˜¯ï¼š Dubbo ä¸å…‰å¯ä»¥å¸®åŠ©æˆ‘ä»¬è°ƒç”¨è¿œç¨‹æœåŠ¡ï¼Œè¿˜æä¾›äº†ä¸€äº›å…¶ä»–å¼€ç®±å³ç”¨çš„åŠŸèƒ½æ¯”å¦‚æ™ºèƒ½è´Ÿè½½å‡è¡¡ã€‚\nDubbo ç›®å‰å·²ç»æœ‰æ¥è¿‘ 34.4 k çš„ Star Â ã€‚\nåœ¨ 2020 å¹´åº¦ OSC ä¸­å›½å¼€æºé¡¹ç›® è¯„é€‰æ´»åŠ¨ä¸­ï¼ŒDubbo ä½åˆ—å¼€å‘æ¡†æ¶å’ŒåŸºç¡€ç»„ä»¶ç±»é¡¹ç›®çš„ç¬¬7åã€‚æƒ³æ¯”å‡ å¹´å‰æ¥è¯´ï¼Œçƒ­åº¦å’Œæ’åæœ‰æ‰€ä¸‹é™ã€‚\n\nDubbo æ˜¯ç”±é˜¿é‡Œå¼€æºï¼Œåæ¥åŠ å…¥äº† Apache ã€‚æ­£å¼ç”±äº Dubbo çš„å‡ºç°ï¼Œæ‰ä½¿å¾—è¶Šæ¥è¶Šå¤šçš„å…¬å¸å¼€å§‹ä½¿ç”¨ä»¥åŠæ¥å—åˆ†å¸ƒå¼æ¶æ„ã€‚\n\nä¸ºä»€ä¹ˆè¦ç”¨ Dubbo?éšç€äº’è”ç½‘çš„å‘å±•ï¼Œç½‘ç«™çš„è§„æ¨¡è¶Šæ¥è¶Šå¤§ï¼Œç”¨æˆ·æ•°é‡è¶Šæ¥è¶Šå¤šã€‚å•ä¸€åº”ç”¨æ¶æ„ ã€å‚ç›´åº”ç”¨æ¶æ„æ— æ³•æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ï¼Œè¿™ä¸ªæ—¶å€™åˆ†å¸ƒå¼æœåŠ¡æ¶æ„å°±è¯ç”Ÿäº†ã€‚\nåˆ†å¸ƒå¼æœåŠ¡æ¶æ„ä¸‹ï¼Œç³»ç»Ÿè¢«æ‹†åˆ†æˆä¸åŒçš„æœåŠ¡æ¯”å¦‚çŸ­ä¿¡æœåŠ¡ã€å®‰å…¨æœåŠ¡ï¼Œæ¯ä¸ªæœåŠ¡ç‹¬ç«‹æä¾›ç³»ç»Ÿçš„æŸä¸ªæ ¸å¿ƒæœåŠ¡ã€‚\næˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Java RMIï¼ˆJava Remote Method Invocationï¼‰ã€Hessianè¿™ç§æ”¯æŒè¿œç¨‹è°ƒç”¨çš„æ¡†æ¶æ¥ç®€å•åœ°æš´éœ²å’Œå¼•ç”¨è¿œç¨‹æœåŠ¡ã€‚ä½†æ˜¯ï¼å½“æœåŠ¡è¶Šæ¥è¶Šå¤šä¹‹åï¼ŒæœåŠ¡è°ƒç”¨å…³ç³»è¶Šæ¥è¶Šå¤æ‚ã€‚å½“åº”ç”¨è®¿é—®å‹åŠ›è¶Šæ¥è¶Šå¤§åï¼Œè´Ÿè½½å‡è¡¡ä»¥åŠæœåŠ¡ç›‘æ§çš„éœ€æ±‚ä¹Ÿè¿«åœ¨çœ‰ç«ã€‚æˆ‘ä»¬å¯ä»¥ç”¨ F5 è¿™ç±»ç¡¬ä»¶æ¥åšè´Ÿè½½å‡è¡¡ï¼Œä½†è¿™æ ·å¢åŠ äº†æˆæœ¬ï¼Œå¹¶ä¸”å­˜åœ¨å•ç‚¹æ•…éšœçš„é£é™©ã€‚\nä¸è¿‡ï¼ŒDubbo çš„å‡ºç°è®©ä¸Šè¿°é—®é¢˜å¾—åˆ°äº†è§£å†³ã€‚Dubbo å¸®åŠ©æˆ‘ä»¬è§£å†³äº†ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿ\n\nè´Ÿè½½å‡è¡¡ ï¼š åŒä¸€ä¸ªæœåŠ¡éƒ¨ç½²åœ¨ä¸åŒçš„æœºå™¨æ—¶è¯¥è°ƒç”¨é‚£ä¸€å°æœºå™¨ä¸Šçš„æœåŠ¡ã€‚\næœåŠ¡è°ƒç”¨é“¾è·¯ç”Ÿæˆ Â ï¼š éšç€ç³»ç»Ÿçš„å‘å±•ï¼ŒæœåŠ¡è¶Šæ¥è¶Šå¤šï¼ŒæœåŠ¡é—´ä¾èµ–å…³ç³»å˜å¾—é”™è¸ªå¤æ‚ï¼Œç”šè‡³åˆ†ä¸æ¸…å“ªä¸ªåº”ç”¨è¦åœ¨å“ªä¸ªåº”ç”¨ä¹‹å‰å¯åŠ¨ï¼Œæ¶æ„å¸ˆéƒ½ä¸èƒ½å®Œæ•´çš„æè¿°åº”ç”¨çš„æ¶æ„å…³ç³»ã€‚Dubbo å¯ä»¥ä¸ºæˆ‘ä»¬è§£å†³æœåŠ¡ä¹‹é—´äº’ç›¸æ˜¯å¦‚ä½•è°ƒç”¨çš„ã€‚\næœåŠ¡è®¿é—®å‹åŠ›ä»¥åŠæ—¶é•¿ç»Ÿè®¡ã€èµ„æºè°ƒåº¦å’Œæ²»ç† ï¼šåŸºäºè®¿é—®å‹åŠ›å®æ—¶ç®¡ç†é›†ç¾¤å®¹é‡ï¼Œæé«˜é›†ç¾¤åˆ©ç”¨ç‡ã€‚\nâ€¦â€¦\n\n\nå¦å¤–ï¼ŒDubbo é™¤äº†èƒ½å¤Ÿåº”ç”¨åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œä¹Ÿå¯ä»¥åº”ç”¨åœ¨ç°åœ¨æ¯”è¾ƒç«çš„å¾®æœåŠ¡ç³»ç»Ÿä¸­ã€‚ä¸è¿‡ï¼Œç”±äº Spring Cloud åœ¨å¾®æœåŠ¡ä¸­åº”ç”¨æ›´åŠ å¹¿æ³›ï¼Œæ‰€ä»¥ï¼Œæˆ‘è§‰å¾—ä¸€èˆ¬æˆ‘ä»¬æ Dubbo çš„è¯ï¼Œå¤§éƒ¨åˆ†æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿçš„æƒ…å†µã€‚\n\nDubbo çš„æ¶æ„è®¾è®¡å®˜æ–¹æ–‡æ¡£ä¸­çš„æ¡†æ¶è®¾è®¡ç« èŠ‚ å·²ç»ä»‹ç»çš„éå¸¸è¯¦ç»†äº†ï¼Œæˆ‘è¿™é‡ŒæŠŠä¸¤ä¸ªæ¯”è¾ƒé‡è¦çš„ç‚¹å†æä¸€ä¸‹ã€‚\n\næ ¸å¿ƒè§’è‰²\nä¸Šè¿°èŠ‚ç‚¹ç®€å•ä»‹ç»ä»¥åŠä»–ä»¬ä¹‹é—´çš„å…³ç³»ï¼š\n\nContainerï¼š æœåŠ¡è¿è¡Œå®¹å™¨ï¼Œè´Ÿè´£åŠ è½½ã€è¿è¡ŒæœåŠ¡æä¾›è€…ã€‚å¿…é¡»ã€‚\nProviderï¼š æš´éœ²æœåŠ¡çš„æœåŠ¡æä¾›æ–¹ï¼Œä¼šå‘æ³¨å†Œä¸­å¿ƒæ³¨å†Œè‡ªå·±æä¾›çš„æœåŠ¡ã€‚å¿…é¡»ã€‚\nConsumerï¼š è°ƒç”¨è¿œç¨‹æœåŠ¡çš„æœåŠ¡æ¶ˆè´¹æ–¹ï¼Œä¼šå‘æ³¨å†Œä¸­å¿ƒè®¢é˜…è‡ªå·±æ‰€éœ€çš„æœåŠ¡ã€‚å¿…é¡»ã€‚\nRegistryï¼š æœåŠ¡æ³¨å†Œä¸å‘ç°çš„æ³¨å†Œä¸­å¿ƒã€‚æ³¨å†Œä¸­å¿ƒä¼šè¿”å›æœåŠ¡æä¾›è€…åœ°å€åˆ—è¡¨ç»™æ¶ˆè´¹è€…ã€‚éå¿…é¡»ã€‚\nMonitorï¼š ç»Ÿè®¡æœåŠ¡çš„è°ƒç”¨æ¬¡æ•°å’Œè°ƒç”¨æ—¶é—´çš„ç›‘æ§ä¸­å¿ƒã€‚æœåŠ¡æ¶ˆè´¹è€…å’Œæä¾›è€…ä¼šå®šæ—¶å‘é€ç»Ÿè®¡æ•°æ®åˆ°ç›‘æ§ä¸­å¿ƒã€‚ éå¿…é¡»ã€‚\n\nä¸€äº›ç”¨äºè‡ªæµ‹çš„å°é—®é¢˜ï¼ˆé¢è¯•ä¸­å¯èƒ½ä¼šé‡åˆ°ï¼‰ï¼š\n\næ³¨å†Œä¸­å¿ƒçš„ä½œç”¨ï¼Ÿ æ³¨å†Œä¸­å¿ƒè´Ÿè´£æœåŠ¡åœ°å€çš„æ³¨å†Œä¸æŸ¥æ‰¾ï¼Œç›¸å½“äºç›®å½•æœåŠ¡ï¼ŒæœåŠ¡æä¾›è€…å’Œæ¶ˆè´¹è€…åªåœ¨å¯åŠ¨æ—¶ä¸æ³¨å†Œä¸­å¿ƒäº¤äº’ã€‚\nç›‘æ§ä¸­å¿ƒçš„ä½œç”¨ï¼Ÿ ç›‘æ§ä¸­å¿ƒè´Ÿè´£ç»Ÿè®¡å„æœåŠ¡è°ƒç”¨æ¬¡æ•°ï¼Œè°ƒç”¨æ—¶é—´ç­‰ã€‚\næœåŠ¡æä¾›è€…å®•æœºåï¼Œæ³¨å†Œä¸­å¿ƒä¼šåšä»€ä¹ˆï¼Ÿ Â æ³¨å†Œä¸­å¿ƒä¼šç«‹å³æ¨é€äº‹ä»¶é€šçŸ¥æ¶ˆè´¹è€…ã€‚\næ³¨å†Œä¸­å¿ƒå’Œç›‘æ§ä¸­å¿ƒéƒ½å®•æœºçš„è¯ï¼ŒæœåŠ¡éƒ½ä¼šæŒ‚æ‰å—ï¼Ÿ ä¸ä¼šã€‚ä¸¤è€…éƒ½å®•æœºä¹Ÿä¸å½±å“å·²è¿è¡Œçš„æä¾›è€…å’Œæ¶ˆè´¹è€…ï¼Œæ¶ˆè´¹è€…åœ¨æœ¬åœ°ç¼“å­˜äº†æä¾›è€…åˆ—è¡¨ã€‚æ³¨å†Œä¸­å¿ƒå’Œç›‘æ§ä¸­å¿ƒéƒ½æ˜¯å¯é€‰çš„ï¼ŒæœåŠ¡æ¶ˆè´¹è€…å¯ä»¥ç›´è¿æœåŠ¡æä¾›è€…ã€‚\n\n\næ•´ä½“è®¾è®¡ä¸‹å›¾æ˜¯ Dubbo çš„æ•´ä½“è®¾è®¡ï¼Œä»ä¸‹è‡³ä¸Šåˆ†ä¸ºåå±‚ï¼Œå„å±‚å‡ä¸ºå•å‘ä¾èµ–ã€‚\n\n\n\n\n\n\n\n\n\nå·¦è¾¹æ·¡è“èƒŒæ™¯çš„ä¸ºæœåŠ¡æ¶ˆè´¹æ–¹ä½¿ç”¨çš„æ¥å£ï¼Œå³è¾¹æ·¡ç»¿è‰²èƒŒæ™¯çš„ä¸ºæœåŠ¡æä¾›æ–¹ä½¿ç”¨çš„æ¥å£ï¼Œä½äºä¸­è½´çº¿ä¸Šçš„ä¸ºåŒæ–¹éƒ½ç”¨åˆ°çš„æ¥å£ã€‚\n\n\nconfig é…ç½®å±‚ï¼šDubboç›¸å…³çš„é…ç½®ã€‚æ”¯æŒä»£ç é…ç½®ï¼ŒåŒæ—¶ä¹Ÿæ”¯æŒåŸºäº Spring Â æ¥åšé…ç½®ï¼Œä»¥ ServiceConfig, ReferenceConfig ä¸ºä¸­å¿ƒ\nproxy æœåŠ¡ä»£ç†å±‚ï¼šè°ƒç”¨è¿œç¨‹æ–¹æ³•åƒè°ƒç”¨æœ¬åœ°çš„æ–¹æ³•ä¸€æ ·ç®€å•çš„ä¸€ä¸ªå…³é”®ï¼ŒçœŸå®è°ƒç”¨è¿‡ç¨‹ä¾èµ–ä»£ç†ç±»ï¼Œä»¥ ServiceProxy ä¸ºä¸­å¿ƒã€‚\nregistry æ³¨å†Œä¸­å¿ƒå±‚ï¼šå°è£…æœåŠ¡åœ°å€çš„æ³¨å†Œä¸å‘ç°ã€‚\ncluster è·¯ç”±å±‚ï¼šå°è£…å¤šä¸ªæä¾›è€…çš„è·¯ç”±åŠè´Ÿè½½å‡è¡¡ï¼Œå¹¶æ¡¥æ¥æ³¨å†Œä¸­å¿ƒï¼Œä»¥ Invoker ä¸ºä¸­å¿ƒã€‚\nmonitor ç›‘æ§å±‚ï¼šRPC è°ƒç”¨æ¬¡æ•°å’Œè°ƒç”¨æ—¶é—´ç›‘æ§ï¼Œä»¥ Statistics ä¸ºä¸­å¿ƒã€‚\nprotocol è¿œç¨‹è°ƒç”¨å±‚ï¼šå°è£… RPC è°ƒç”¨ï¼Œä»¥ Invocation, Result ä¸ºä¸­å¿ƒã€‚\nexchange ä¿¡æ¯äº¤æ¢å±‚ï¼šå°è£…è¯·æ±‚å“åº”æ¨¡å¼ï¼ŒåŒæ­¥è½¬å¼‚æ­¥ï¼Œä»¥ Request, Response ä¸ºä¸­å¿ƒã€‚\ntransport ç½‘ç»œä¼ è¾“å±‚ï¼šæŠ½è±¡ mina å’Œ netty ä¸ºç»Ÿä¸€æ¥å£ï¼Œä»¥ Message ä¸ºä¸­å¿ƒã€‚\nserialize æ•°æ®åºåˆ—åŒ–å±‚ ï¼šå¯¹éœ€è¦åœ¨ç½‘ç»œä¼ è¾“çš„æ•°æ®è¿›è¡Œåºåˆ—åŒ–ã€‚\n\n\nåŸºæœ¬è®¾è®¡åŸåˆ™\nå¾®å†…æ ¸æ¶æ„Dubbo é‡‡ç”¨å¾®å†…æ ¸ï¼ˆMicrokernelï¼‰ + æ’ä»¶ï¼ˆPluginï¼‰ æ¨¡å¼ï¼Œç®€å•æ¥è¯´å°±æ˜¯å¾®å†…æ ¸æ¶æ„ã€‚å¾®å†…æ ¸åªè´Ÿè´£ç»„è£…æ’ä»¶ã€‚\nä½•ä¸ºå¾®å†…æ ¸æ¶æ„å‘¢ï¼Ÿ ã€Šè½¯ä»¶æ¶æ„æ¨¡å¼ã€‹ è¿™æœ¬ä¹¦æ˜¯è¿™æ ·ä»‹ç»çš„ï¼š\n\n\n\n\n\n\n\n\n\nå¾®å†…æ ¸æ¶æ„æ¨¡å¼ï¼ˆæœ‰æ—¶è¢«ç§°ä¸ºæ’ä»¶æ¶æ„æ¨¡å¼ï¼‰æ˜¯å®ç°åŸºäºäº§å“åº”ç”¨ç¨‹åºçš„ä¸€ç§è‡ªç„¶æ¨¡å¼ã€‚åŸºäºäº§å“çš„åº”ç”¨ç¨‹åºæ˜¯å·²ç»æ‰“åŒ…å¥½å¹¶ä¸”æ‹¥æœ‰ä¸åŒç‰ˆæœ¬ï¼Œå¯ä½œä¸ºç¬¬ä¸‰æ–¹æ’ä»¶ä¸‹è½½çš„ã€‚ç„¶åï¼Œå¾ˆå¤šå…¬å¸ä¹Ÿåœ¨å¼€å‘ã€å‘å¸ƒè‡ªå·±å†…éƒ¨å•†ä¸šåº”ç”¨åƒæœ‰ç‰ˆæœ¬å·ã€è¯´æ˜åŠå¯åŠ è½½æ’ä»¶å¼çš„åº”ç”¨è½¯ä»¶ï¼ˆè¿™ä¹Ÿæ˜¯è¿™ç§æ¨¡å¼çš„ç‰¹å¾ï¼‰ã€‚å¾®å†…æ ¸ç³»ç»Ÿå¯è®©ç”¨æˆ·æ·»åŠ é¢å¤–çš„åº”ç”¨å¦‚æ’ä»¶ï¼Œåˆ°æ ¸å¿ƒåº”ç”¨ï¼Œç»§è€Œæä¾›äº†å¯æ‰©å±•æ€§å’ŒåŠŸèƒ½åˆ†ç¦»çš„ç”¨æ³•ã€‚\nå¾®å†…æ ¸æ¶æ„åŒ…å«ä¸¤ç±»ç»„ä»¶ï¼šæ ¸å¿ƒç³»ç»Ÿï¼ˆcore systemï¼‰ å’Œ æ’ä»¶æ¨¡å—ï¼ˆplug-in modulesï¼‰ã€‚\n\næ ¸å¿ƒç³»ç»Ÿæä¾›ç³»ç»Ÿæ‰€éœ€æ ¸å¿ƒèƒ½åŠ›ï¼Œæ’ä»¶æ¨¡å—å¯ä»¥æ‰©å±•ç³»ç»Ÿçš„åŠŸèƒ½ã€‚å› æ­¤ï¼Œ åŸºäºå¾®å†…æ ¸æ¶æ„çš„ç³»ç»Ÿï¼Œéå¸¸æ˜“äºæ‰©å±•åŠŸèƒ½ã€‚\næˆ‘ä»¬å¸¸è§çš„ä¸€äº›IDEï¼Œéƒ½å¯ä»¥çœ‹ä½œæ˜¯åŸºäºå¾®å†…æ ¸æ¶æ„è®¾è®¡çš„ã€‚ç»å¤§å¤šæ•° IDEæ¯”å¦‚IDEAã€VSCodeéƒ½æä¾›äº†æ’ä»¶æ¥ä¸°å¯Œè‡ªå·±çš„åŠŸèƒ½ã€‚\næ­£æ˜¯å› ä¸ºDubboåŸºäºå¾®å†…æ ¸æ¶æ„ï¼Œæ‰ä½¿å¾—æˆ‘ä»¬å¯ä»¥éšå¿ƒæ‰€æ¬²æ›¿æ¢Dubboçš„åŠŸèƒ½ç‚¹ã€‚æ¯”å¦‚ä½ è§‰å¾—Dubbo çš„åºåˆ—åŒ–æ¨¡å—å®ç°çš„ä¸æ»¡è¶³è‡ªå·±è¦æ±‚ï¼Œæ²¡å…³ç³»å•Šï¼ä½ è‡ªå·±å®ç°ä¸€ä¸ªåºåˆ—åŒ–æ¨¡å—å°±å¥½äº†å•Šï¼\né€šå¸¸æƒ…å†µä¸‹ï¼Œå¾®æ ¸å¿ƒéƒ½ä¼šé‡‡ç”¨ Factoryã€IoCã€OSGi ç­‰æ–¹å¼ç®¡ç†æ’ä»¶ç”Ÿå‘½å‘¨æœŸã€‚Dubbo ä¸æƒ³ä¾èµ– Spring ç­‰ IoC å®¹å™¨ï¼Œä¹Ÿä¸æƒ³è‡ªå·²é€ ä¸€ä¸ªå°çš„ IoC å®¹å™¨ï¼ˆè¿‡åº¦è®¾è®¡ï¼‰ï¼Œå› æ­¤é‡‡ç”¨äº†ä¸€ç§æœ€ç®€å•çš„ Factory æ–¹å¼ç®¡ç†æ’ä»¶ ï¼šJDK æ ‡å‡†çš„ SPI æ‰©å±•æœºåˆ¶ ï¼ˆjava.util.ServiceLoaderï¼‰ã€‚\n\nURL ä¼ é€’é…ç½®ä¿¡æ¯é‡‡ç”¨ URL ä½œä¸ºé…ç½®ä¿¡æ¯çš„ç»Ÿä¸€æ ¼å¼ï¼Œæ‰€æœ‰æ‰©å±•ç‚¹éƒ½é€šè¿‡ä¼ é€’ URL æºå¸¦é…ç½®ä¿¡æ¯ã€‚æœ‰ä»€ä¹ˆå¥½å¤„å‘¢ï¼Ÿ Â å½¢æˆè§„èŒƒï¼Œæå‡ä»£ç å¯è¯»æ€§ï¼Œé™ä½ä»£ç ç†è§£æˆæœ¬ã€‚\n\næ¨¡å—åˆ†åŒ…\n\n\n\n\n\n\n\n\nä»¥ä¸‹å†…å®¹æ¥è‡ªå®˜æ–¹æ–‡æ¡£ï¼šhttps://dubbo.apache.org/zh/docs/v2.7/dev/design/ ã€‚\n\næ¨¡å—è¯´æ˜ï¼š\n\ndubbo-common å…¬å…±é€»è¾‘æ¨¡å—ï¼šåŒ…æ‹¬ Util ç±»å’Œé€šç”¨æ¨¡å‹ã€‚\ndubbo-remoting è¿œç¨‹é€šè®¯æ¨¡å—ï¼šç›¸å½“äº Dubbo åè®®çš„å®ç°ï¼Œå¦‚æœ RPC ç”¨ RMIåè®®åˆ™ä¸éœ€è¦ä½¿ç”¨æ­¤åŒ…ã€‚\ndubbo-rpc è¿œç¨‹è°ƒç”¨æ¨¡å—ï¼šæŠ½è±¡å„ç§åè®®ï¼Œä»¥åŠåŠ¨æ€ä»£ç†ï¼ŒåªåŒ…å«ä¸€å¯¹ä¸€çš„è°ƒç”¨ï¼Œä¸å…³å¿ƒé›†ç¾¤çš„ç®¡ç†ã€‚\ndubbo-cluster é›†ç¾¤æ¨¡å—ï¼šå°†å¤šä¸ªæœåŠ¡æä¾›æ–¹ä¼ªè£…ä¸ºä¸€ä¸ªæä¾›æ–¹ï¼ŒåŒ…æ‹¬ï¼šè´Ÿè½½å‡è¡¡, å®¹é”™ï¼Œè·¯ç”±ç­‰ï¼Œé›†ç¾¤çš„åœ°å€åˆ—è¡¨å¯ä»¥æ˜¯é™æ€é…ç½®çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯ç”±æ³¨å†Œä¸­å¿ƒä¸‹å‘ã€‚\ndubbo-registry æ³¨å†Œä¸­å¿ƒæ¨¡å—ï¼šåŸºäºæ³¨å†Œä¸­å¿ƒä¸‹å‘åœ°å€çš„é›†ç¾¤æ–¹å¼ï¼Œä»¥åŠå¯¹å„ç§æ³¨å†Œä¸­å¿ƒçš„æŠ½è±¡ã€‚\ndubbo-monitor ç›‘æ§æ¨¡å—ï¼šç»Ÿè®¡æœåŠ¡è°ƒç”¨æ¬¡æ•°ï¼Œè°ƒç”¨æ—¶é—´çš„ï¼Œè°ƒç”¨é“¾è·Ÿè¸ªçš„æœåŠ¡ã€‚\ndubbo-config é…ç½®æ¨¡å—ï¼šæ˜¯ Dubbo å¯¹å¤–çš„ APIï¼Œç”¨æˆ·é€šè¿‡ Config ä½¿ç”¨Dubboï¼Œéšè— Dubbo æ‰€æœ‰ç»†èŠ‚ã€‚\ndubbo-container å®¹å™¨æ¨¡å—ï¼šæ˜¯ä¸€ä¸ª Standlone çš„å®¹å™¨ï¼Œä»¥ç®€å•çš„ Main åŠ è½½ Spring å¯åŠ¨ï¼Œå› ä¸ºæœåŠ¡é€šå¸¸ä¸éœ€è¦ Tomcat&#x2F;JBoss ç­‰ Web å®¹å™¨çš„ç‰¹æ€§ï¼Œæ²¡å¿…è¦ç”¨ Web å®¹å™¨å»åŠ è½½æœåŠ¡ã€‚\n\n\nå‰è¨€åœ¨ã€Šå¦‚ä½•è‡ªå·±å®ç°ä¸€ä¸ª RPCæ¡†æ¶ã€‹ä¸­æˆ‘ä»¬ä»‹ç»åˆ°ä¸€ä¸ªæœ€åŸºæœ¬çš„ RPC æ¡†æ¶åº”è¯¥åŒ…æ‹¬ä¸‹é¢å‡ éƒ¨åˆ†:\n\næ³¨å†Œä¸­å¿ƒ ï¼šæ³¨å†Œä¸­å¿ƒè´Ÿè´£æœåŠ¡åœ°å€çš„æ³¨å†Œä¸æŸ¥æ‰¾ï¼Œç›¸å½“äºç›®å½•æœåŠ¡ã€‚\nç½‘ç»œä¼ è¾“ ï¼šæ—¢ç„¶æˆ‘ä»¬è¦è°ƒç”¨è¿œç¨‹çš„æ–¹æ³•ï¼Œå°±è¦å‘é€ç½‘ç»œè¯·æ±‚æ¥ä¼ é€’ç›®æ ‡ç±»å’Œæ–¹æ³•çš„ä¿¡æ¯ä»¥åŠæ–¹æ³•çš„å‚æ•°ç­‰æ•°æ®åˆ°æœåŠ¡æä¾›ç«¯ã€‚\nåºåˆ—åŒ–å’Œååºåˆ—åŒ– ï¼šè¦åœ¨ç½‘ç»œä¼ è¾“æ•°æ®å°±è¦æ¶‰åŠåˆ°åºåˆ—åŒ–ã€‚\nåŠ¨æ€ä»£ç† ï¼šå±è”½ç¨‹æ–¹æ³•è°ƒç”¨çš„åº•å±‚ç»†èŠ‚ã€‚\nè´Ÿè½½å‡è¡¡ Â ï¼š é¿å…å•ä¸ªæœåŠ¡å™¨å“åº”åŒä¸€è¯·æ±‚ï¼Œå®¹æ˜“é€ æˆæœåŠ¡å™¨å®•æœºã€å´©æºƒç­‰é—®é¢˜ã€‚\nä¼ è¾“åè®® ï¼šè¿™ä¸ªåè®®æ˜¯å®¢æˆ·ç«¯ï¼ˆæœåŠ¡æ¶ˆè´¹æ–¹ï¼‰å’ŒæœåŠ¡ç«¯ï¼ˆæœåŠ¡æä¾›æ–¹ï¼‰äº¤æµçš„åŸºç¡€ã€‚\n\næ›´å®Œå–„çš„ä¸€ç‚¹çš„ RPC æ¡†æ¶å¯èƒ½è¿˜æœ‰ç›‘æ§æ¨¡å—ã€‚\nDubbo æ˜¯æ¯”è¾ƒæˆç†Ÿçš„ RPC æ¡†æ¶äº†ï¼Œå®ƒå½“ç„¶æ»¡è¶³æˆ‘ä»¬æ‰€è¯´çš„è¿™äº›è¦æ±‚ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ Dubbo æºç çš„æ¨¡å—ç»“æ„å°±å¯ä»¥çœ‹å‡ºæ¥äº†ã€‚\n\nDubbo æ ¸å¿ƒæ¨¡å—ä»‹ç»\ndubbo-common(å…¬å…±é€»è¾‘æ¨¡å—)\nè¿™éƒ¨åˆ†ä¸»è¦æ˜¯ä¸€äº›é€šç”¨å·¥å…·ç±»ï¼ˆUtilï¼‰æ¯”å¦‚Dubbo å¯¹ SPIï¼ˆorg.apache.dubbo.common.extensionï¼‰ã€æ—¶é—´è½®ç®—æ³•(org.apache.dubbo.common.timer)çš„å®ç°éƒ½æ”¾åœ¨è¿™ä¸ªæ¨¡å—ä¸‹ã€‚\né™¤äº†å·¥å…·ç±»ä¹‹å¤–ï¼Œdubbo-common è¿˜åŒ…æ‹¬ä¸€äº›é€šç”¨æ¨¡å‹æ¯”å¦‚ URLï¼ˆDubbo é€šè¿‡URL ä¼ é€’é…ç½®ä¿¡æ¯ï¼‰ã€‚\n\ndubbo-remoting (ç½‘ç»œä¼ è¾“æ¨¡å—)\næƒ³è¦è°ƒç”¨è¿œç¨‹æ–¹æ³•ï¼Œå¿…ç„¶æ¶‰åŠåˆ°ç½‘ç»œä¼ è¾“ã€‚ç½‘ç»œä¼ è¾“æ¨¡å—å¾ˆå¤§ç¨‹åº¦å†³å®šäº†Dubboçš„æ€§èƒ½å’Œç¨³å®šæ€§ï¼Œæ‰€ä»¥ï¼Œè¿™å—çš„è®¾è®¡éå¸¸é‡è¦ã€‚\ndubbo-remoting-api æ¨¡å—æ˜¯æ•´ä¸ªç½‘ç»œä¼ è¾“æ¨¡å—çš„æŠ½è±¡ï¼Œå®šä¹‰äº†ä¸€äº›ç½‘ç»œä¼ è¾“æ¨¡å—å¿…é¡»è¦å®ç°çš„æ¥å£ä»¥åŠé€šç”¨çš„ä¸€äº›å®ç°ï¼Œdubbo-remoting æ¨¡å—ä¸‹çš„å…¶ä»–æ¨¡å—éƒ½è¦å¯¹å…¶è¿›è¡Œå®ç°ã€‚\nä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼ŒDubbo çš„ç½‘ç»œä¼ è¾“æ¨¡å—æœ‰å¤šç§å®ç°æ–¹å¼ã€‚é™¤äº†æˆ‘ä»¬æ¯”è¾ƒç†Ÿæ‚‰çš„ Netty å®ç°æ–¹å¼ä¹‹å¤–ï¼Œè¿˜æœ‰Grizzlyã€Minaç­‰å®ç°æ–¹å¼ã€‚\nNettyã€Grizzlyã€Minaä¸‰è€…éƒ½æ˜¯åŸºäº Java NIOï¼Œå¹¶ä¸”Nettyç›¸æ¯”äºå…¶ä»–ä¸¤è€…å°è£…å’Œè®¾è®¡çš„è¦æ›´å¥½ä¸€äº›ã€‚\n\ndubbo-registry (æ³¨å†Œä¸­å¿ƒæ¨¡å—)\næ³¨å†Œä¸­å¿ƒç›¸å½“äºæœåŠ¡æä¾›è€…å’Œæ¶ˆè´¹è€…ä¸­é—´çš„æ¡¥æ¢ï¼Œè´Ÿè´£æœåŠ¡åœ°å€çš„æ³¨å†Œä¸æŸ¥æ‰¾ï¼Œç›¸å½“äºç›®å½•æœåŠ¡ã€‚\ndubbo-registry-api æ¨¡å—æ˜¯æ•´ä¸ªæ³¨å†Œä¸­å¿ƒä¼ è¾“æ¨¡å—çš„æŠ½è±¡ï¼Œå®šä¹‰äº†ä¸€äº›æ³¨å†Œä¸­å¿ƒæ¨¡å—å¿…é¡»è¦å®ç°çš„æ¥å£ä»¥åŠé€šç”¨çš„ä¸€äº›å®ç°ã€‚\nDubbo çš„æ³¨å†Œä¸­å¿ƒè¾“æ¨¡å—ä¹Ÿæœ‰å¤šç§å®ç°æ–¹å¼ã€‚é™¤äº†æˆ‘ä»¬æ¯”è¾ƒç†Ÿæ‚‰çš„ zookeeperã€nacos å®ç°æ–¹å¼ä¹‹å¤–ï¼Œè¿˜æœ‰mutilcastã€redisç­‰å®ç°æ–¹å¼ã€‚\nä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éƒ½æ˜¯ä½¿ç”¨zookeeperä½œä¸ºæ³¨å†Œä¸­å¿ƒï¼Œè¿™ä¹Ÿæ˜¯ Dubbo å®˜æ–¹æ¨èçš„ä¸€ç§æ–¹å¼ã€‚\n\n\ndubbo-config(é…ç½®æ¨¡å—)\næˆ‘ä»¬åœ¨æºç ç¯å¢ƒé‚£ä¸€èŠ‚ä¸­æåˆ°ï¼š dubbo-demo æ¨¡å—ä¸‹ï¼ŒåŒ…å«äº† 3 ç§ä¸åŒç±»å‹ï¼ˆxmlã€apiã€annotationï¼‰é…ç½®æ–¹å¼ä½¿ç”¨ Dubbo çš„demoã€‚\ndubbo-config Â å°±æ˜¯å¯¹è¿™äº›é…ç½®æ–¹å¼çš„å®ç°ã€‚\n\ndubbo-config-api ï¼šAPIé…ç½®æ–¹å¼çš„å®ç°ï¼ˆçº¯ä»£ç ä½¿ç”¨ï¼‰ã€‚\ndubbo-config-spring ï¼šXMLå’Œæ³¨è§£æ–¹å¼çš„å®ç°ã€‚\n\n\ndubbo-monitor (ç›‘æ§æ¨¡å—)ç›‘æ§æ¨¡å—ä¸»è¦ç»Ÿè®¡æœåŠ¡è°ƒç”¨æ¬¡æ•°ï¼Œè°ƒç”¨æ—¶é—´çš„ï¼Œè°ƒç”¨é“¾è·Ÿè¸ªçš„æœåŠ¡ã€‚\nä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼Œç›‘æ§æ¨¡å—åªæœ‰ä¸€ä¸ªé»˜è®¤å®ç°ã€‚\n\ndubbo-rpc(è¿œç¨‹è°ƒç”¨æ¨¡å—)\ndubbo-rpc æ¨¡å—æŠ½è±¡äº†å„ç§åè®®ï¼Œä»¥åŠåŠ¨æ€ä»£ç†ï¼ŒåªåŒ…å«ä¸€å¯¹ä¸€çš„è°ƒç”¨ï¼Œä¸å…³å¿ƒé›†ç¾¤çš„ç®¡ç†ã€‚\nä»â€œè¿œç¨‹è°ƒç”¨æ¨¡å—â€ è¿™ä¸ªåå­—ä¸­ï¼Œæˆ‘ä»¬å¤§æ¦‚å°±èƒ½æ¨æ–­å‡º dubbo-rpc æ¨¡å—ä¾èµ–äº†ç½‘ç»œä¼ è¾“æ¨¡å—ï¼ˆdubbo-remotingï¼‰ã€‚\ndubbo-rpc-api æ¨¡å—æ˜¯æ•´ä¸ªè¿œç¨‹è°ƒç”¨æ¨¡å—çš„æŠ½è±¡ï¼Œå®šä¹‰äº†ä¸€äº›è¿œç¨‹è°ƒç”¨æ¨¡å—å¿…é¡»è¦å®ç°çš„æ¥å£ä»¥åŠé€šç”¨çš„ä¸€äº›å®ç°ã€‚\nDubbo æœ¬èº«å°±æä¾›äº†å¤šç§åè®®å®ç°æ¯”å¦‚ dubboåè®®ã€hessionåè®®ã€gRPCåè®®ï¼Œä¸è¿‡å®˜æ–¹æ›´æ¨èä½¿ç”¨dubboåè®®ã€‚å¹¶ä¸”ï¼Œè¿˜ç»™å‡ºäº†ä¸€ä»½æ€§èƒ½æµ‹è¯•æŠ¥å‘Šã€‚\n\ndubbo-cluster(é›†ç¾¤æ¨¡å—)\ndubbo-cluster æ¨¡å—å°†å¤šä¸ªæœåŠ¡æä¾›æ–¹ä¼ªè£…ä¸ºä¸€ä¸ªæä¾›æ–¹ï¼ŒåŒ…æ‹¬ï¼šè´Ÿè½½å‡è¡¡, å®¹é”™ï¼Œè·¯ç”±ç­‰ï¼Œé›†ç¾¤çš„åœ°å€åˆ—è¡¨å¯ä»¥æ˜¯é™æ€é…ç½®çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯ç”±æ³¨å†Œä¸­å¿ƒä¸‹å‘ã€‚\n\nå‰è¨€ä½ ç»™é¢è¯•å®˜è¯´ï¼šâ€œæˆ‘é˜…è¯»è¿‡ Dubbo çš„æºç ï¼Œè§‰å¾—é‚£å—è®¾è®¡çš„æ¯”è¾ƒå¥½â€ã€‚ç»“æœï¼Œä½ è‡ªå·±è¿Dubbo æºç é˜…è¯»ç¯å¢ƒéƒ½æ²¡æ­å»ºè¿‡çš„è¯ï¼Œå°´å°¬ä¸ï¼Ÿ\nDubboå®˜æ–¹ä¹Ÿæœ‰å¯¹åº”çš„æºç ç¯å¢ƒæ­å»ºæ•™ç¨‹ï¼ˆ@æºç æ„å»ºï¼‰ï¼Œä¸è¿‡æˆ‘çš„æ›´è¯¦ç»†å®Œå–„ä¸€ç‚¹ã€‚å¹¶ä¸”ï¼Œæ›´æ¸…æ™°æ˜“æ‡‚ã€‚ä¸€äº›ä½ ä»¬å¯èƒ½æˆ‘è¸©çš„å‘ï¼Œæˆ‘éƒ½æå‰æŒ‡äº†å‡ºæ¥ï¼Œé¿å…æ²¡æœ‰å¿…è¦çš„æ—¶é—´æµªè´¹ã€‚\n\nç¯å¢ƒå‡†å¤‡\nIDEAï¼šå»ºè®®ä½¿ç”¨ IDEA ä½œä¸º IDEã€‚\nMaven 3.6.5 ï¼šDubbo ä½¿ç”¨ maven ä½œä¸ºæ„å»ºå·¥å…·ã€‚\nJDK 1.8 Â ï¼šJDK 1.8 ç‰ˆæœ¬å³å¯ã€‚\n\n\nDubbo æºç é˜…è¯»ç¯å¢ƒæ­å»º\nå…‹éš†é¡¹ç›®åˆ°æœ¬åœ°æˆ‘ä»¬å…ˆå…‹éš†é¡¹ç›®åˆ°æœ¬åœ°(å»ºè®® fork ä¸€ä»½é¡¹ç›®åˆ°è‡ªå·±çš„ä»“åº“ä¸­å†å…‹éš†ï¼Œç‰ˆæœ¬å»ºè®® dubbo-2.6.4)ã€‚\ngit clone https://github.com/apache/dubbo.git dubbo\n\n\nä½¿ç”¨ IDEA æ‰“å¼€é¡¹ç›®é¡¹ç›®å…‹éš†å®Œæˆä¹‹åï¼Œæ¨èä½¿ç”¨ IDEA æ‰“å¼€ã€‚æ‰“å¼€ä¹‹åï¼Œå¯èƒ½éœ€è¦ä¸€ä¼šæ—¶é—´ä¸‹è½½é¡¹ç›®æ‰€ä¾èµ–çš„ jaråŒ…ï¼Œæˆ‘ä»¬å–æ¯å’–å•¡ï¼Œè€å¿ƒç­‰å¾…å³å¯ã€‚\n\n\n\n\n\n\n\n\n\nä¸‹è½½jaråŒ…çš„è¿‡ç¨‹ä¸­ï¼Œå¾ˆå¯èƒ½ä¼šé‡åˆ°æŸäº› jar åŒ…å‡ºç°é—®é¢˜çš„æƒ…å†µï¼Œå¯¼è‡´é¡¹ç›®å¤šå¤„æŠ¥çº¢ï¼Œæ˜¾ç¤ºç›¸å…³ä¾èµ–å¯¼å…¥é”™è¯¯ã€‚è§£å†³çš„åŠæ³•å°±æ˜¯ï¼šä½ å»è‡ªå·±æœ¬åœ°çš„ Mavenä»“åº“æ‰¾åˆ°å¯¹åº”çš„ Â jar åŒ…ï¼Œå°†å…¶åˆ é™¤ï¼Œç„¶åé‡æ–°å¯¼å…¥é¡¹ç›®ä¸‹è½½å³å¯ã€‚\n\næ„å»ºé¡¹ç›®å¦‚æœæˆ‘ä»¬çš„é¡¹ç›®ç›¸å…³çš„ jar åŒ…ä¸‹è½½å®Œæˆï¼Œæˆ‘ä»¬å°±å¯ä»¥å¼€å§‹æ„å»ºé¡¹ç›®äº†ã€‚ä½ å¯ä»¥ä½¿ç”¨ä¸‹é¢ä¸¤ç§æ–¹å¼çš„ä»»æ„ä¸€ç§ï¼š\nï¼ˆ1ï¼‰ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤æ„å»ºé¡¹ç›®äº†ï¼š\nmvn install -Dmaven.test.skip #æ„å»ºå¹¶è·³è¿‡å•å…ƒæµ‹è¯•\n\nï¼ˆ2ï¼‰ä¸åŒè¿‡å‘½ä»¤çš„æ–¹å¼ï¼š\né¦–å…ˆç‚¹å‡»è·³è¿‡æµ‹è¯•ï¼Œç„¶åç‚¹å‡»clean å’Œ installã€‚\n\n\néªŒè¯æºç ç¯å¢ƒæ˜¯å¦æ­å»ºæˆåŠŸè¿™äº›äº‹æƒ…åšå®Œä¹‹åï¼Œæˆ‘ä»¬éœ€è¦éªŒè¯ä¸€ä¸‹ Dubbo æºç é˜…è¯»ç¯å¢ƒæ˜¯å¦çœŸçš„æ­å»ºæˆåŠŸäº†ã€‚æ€ä¹ˆæ¥éªŒè¯å‘¢ï¼Ÿ\néå¸¸ç®€å•ï¼Œä¸éœ€è¦è‡ªå·±æ‰‹åŠ¨å†™ Demo äº†ã€‚é¡¹ç›®æºç å·²ç»è‡ªå¸¦äº†ä¸€äº›ä½¿ç”¨ Dubbo çš„Demoï¼Œæˆ‘ä»¬ç›´æ¥è¿è¡Œå³å¯ã€‚\næˆ‘ä»¬æ‰¾åˆ° dubbo-demo è¿™ä¸ªæ–‡ä»¶å¤¹ï¼Œé‡Œé¢åŒ…å«äº† 3 ç§ä¸åŒç±»å‹ï¼ˆxmlã€apiã€annotationï¼‰ä½¿ç”¨æ–¹å¼çš„ demoï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬èŠ‚çœæ‰å¤§é‡å†™ Demo çš„æ—¶é—´ã€‚\n\nè¿™äº› Demo éƒ½æ˜¯ä½¿ç”¨ zookeepeer ä½œä¸ºæ³¨å†Œä¸­å¿ƒçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦æå‰ä¸‹è½½ zookeeper åˆ°æœ¬åœ°ã€‚\næˆ‘è¿™é‡Œå»ºè®®ä¸‹è½½ 3.4.12 ç‰ˆæœ¬çš„ zookeeper ,é¿å…å‡ºç°å…¶ä»–é—®é¢˜ã€‚æˆ‘ä»¬ç›´æ¥ä½¿ç”¨ Docker è¿›è¡Œä¸‹è½½å°±è¡Œäº†ï¼Œæ–¹ä¾¿ç®€å•ã€‚\ndocker pull zookeeper:3.4.12\n\nç„¶åï¼Œä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤è¿è¡Œã€‚\ndocker run -d --name zookeeper3.4.12 -p 2181:2181 zookeeper:3.4.12\n\næˆ‘ä»¬éšä¾¿æ‰¾åˆ°ä¸€ä¸ª Demo ï¼Œæˆ‘è¿™é‡Œä»¥ api ä½¿ç”¨çš„æ–¹å¼æ¥è¯´æ˜ä¸€ä¸‹ã€‚\næˆ‘ä»¬æ‰¾åˆ° dubbo-demo-api è¿™ä¸ªæ–‡ä»¶å¤¹ï¼Œç„¶åå…ˆå¯åŠ¨æœåŠ¡æä¾›è€…ï¼Œå†å¯åŠ¨æœåŠ¡ç”Ÿäº§è€…ï¼š\n\nå¯åŠ¨æœåŠ¡æä¾›è€… ï¼šç›´æ¥è¿è¡Œ dubbo-demo-api-provider ï¼ˆæœåŠ¡æä¾›è€…ï¼‰ä¸‹çš„ Application Â å³å¯ã€‚æœåŠ¡æä¾›è€…å¯åŠ¨æˆåŠŸä¹‹åï¼Œæ§åˆ¶å°ä¼šæ‰“å°å‡ºæœåŠ¡è¢«æ³¨å†Œçš„ä¸€äº›ä¿¡æ¯ã€‚\nå¯åŠ¨æœåŠ¡æ¶ˆè´¹è€… ï¼šç›´æ¥è¿è¡Œ dubbo-demo-api-consumer ï¼ˆæœåŠ¡æä¾›è€…ï¼‰ä¸‹çš„ Application Â å³å¯ã€‚æœåŠ¡æ¶ˆè´¹è€…å¯åŠ¨æˆåŠŸä¹‹åï¼Œæ§åˆ¶å°ä¼šæ‰“å°å‡ºè°ƒç”¨æœåŠ¡æä¾›è€…çš„sayHello()æ–¹æ³•è¿”å›çš„ç»“æœã€‚\n\nå¯åŠ¨è¿‡ç¨‹ä¸­å¯èƒ½ä¼šå‡ºç°çš„é—®é¢˜ï¼šjava.nio.channels.UnresolvedAddressException ã€‚\nå‡ºç°è¿™ç§é—®é¢˜çš„åŸå› å¤§æ¦‚æ˜¯ä½ çš„ JDK ç‰ˆæœ¬æ˜¯ JDK14,ä½ åªéœ€è¦å°† JDK ç‰ˆæœ¬è°ƒæ•´åˆ°å¯¹åº”çš„ JDK 8 å³å¯ã€‚\n\næºç åˆ†æ\nDubbo SPI1.ç®€ä»‹SPI å…¨ç§°ä¸º Service Provider Interfaceï¼Œæ˜¯ä¸€ç§æœåŠ¡å‘ç°æœºåˆ¶ã€‚SPI çš„æœ¬è´¨æ˜¯å°†æ¥å£å®ç°ç±»çš„å…¨é™å®šåé…ç½®åœ¨æ–‡ä»¶ä¸­ï¼Œå¹¶ç”±æœåŠ¡åŠ è½½å™¨è¯»å–é…ç½®æ–‡ä»¶ï¼ŒåŠ è½½å®ç°ç±»ã€‚è¿™æ ·å¯ä»¥åœ¨è¿è¡Œæ—¶ï¼ŒåŠ¨æ€ä¸ºæ¥å£æ›¿æ¢å®ç°ç±»ã€‚æ­£å› æ­¤ç‰¹æ€§ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çš„é€šè¿‡ SPI æœºåˆ¶ä¸ºæˆ‘ä»¬çš„ç¨‹åºæä¾›æ‹“å±•åŠŸèƒ½ã€‚SPI æœºåˆ¶åœ¨ç¬¬ä¸‰æ–¹æ¡†æ¶ä¸­ä¹Ÿæœ‰æ‰€åº”ç”¨ï¼Œæ¯”å¦‚ Dubbo å°±æ˜¯é€šè¿‡ SPI æœºåˆ¶åŠ è½½æ‰€æœ‰çš„ç»„ä»¶ã€‚ä¸è¿‡ï¼ŒDubbo å¹¶æœªä½¿ç”¨ Java åŸç”Ÿçš„ SPI æœºåˆ¶ï¼Œè€Œæ˜¯å¯¹å…¶è¿›è¡Œäº†å¢å¼ºï¼Œä½¿å…¶èƒ½å¤Ÿæ›´å¥½çš„æ»¡è¶³éœ€æ±‚ã€‚åœ¨ Dubbo ä¸­ï¼ŒSPI æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„æ¨¡å—ã€‚åŸºäº SPIï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çš„å¯¹ Dubbo è¿›è¡Œæ‹“å±•ã€‚å¦‚æœå¤§å®¶æƒ³è¦å­¦ä¹  Dubbo çš„æºç ï¼ŒSPI æœºåˆ¶åŠ¡å¿…å¼„æ‡‚ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å…ˆæ¥äº†è§£ä¸€ä¸‹ Java SPI ä¸ Dubbo SPI çš„ç”¨æ³•ï¼Œç„¶åå†æ¥åˆ†æ Dubbo SPI çš„æºç ã€‚\néœ€è¦ç‰¹åˆ«è¯´æ˜çš„æ˜¯ï¼Œæœ¬ç¯‡æ–‡ç« ä»¥åŠæœ¬ç³»åˆ—å…¶ä»–æ–‡ç« æ‰€åˆ†æçš„æºç ç‰ˆæœ¬å‡ä¸º dubbo-2.6.4ã€‚å› æ­¤å¤§å®¶åœ¨é˜…è¯»æ–‡ç« çš„è¿‡ç¨‹ä¸­ï¼Œéœ€æ³¨æ„å°†ä»£ç ç‰ˆæœ¬åˆ‡æ¢åˆ° dubbo-2.6.4 tag ä¸Šã€‚\n\n2.SPI ç¤ºä¾‹\n2.1 Java SPI ç¤ºä¾‹å‰é¢ç®€å•ä»‹ç»äº† SPI æœºåˆ¶çš„åŸç†ï¼Œæœ¬èŠ‚é€šè¿‡ä¸€ä¸ªç¤ºä¾‹æ¼”ç¤º Java SPI çš„ä½¿ç”¨æ–¹æ³•ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªæ¥å£ï¼Œåç§°ä¸º Robotã€‚\npublic interface Robot &#123;\n    void sayHello();\n&#125;\n\næ¥ä¸‹æ¥å®šä¹‰ä¸¤ä¸ªå®ç°ç±»ï¼Œåˆ†åˆ«ä¸º OptimusPrime å’Œ Bumblebeeã€‚\npublic class OptimusPrime implements Robot &#123;\n    \n    @Override\n    public void sayHello() &#123;\n        System.out.println(\"Hello, I am Optimus Prime.\");\n    &#125;\n&#125;\n\npublic class Bumblebee implements Robot &#123;\n\n    @Override\n    public void sayHello() &#123;\n        System.out.println(\"Hello, I am Bumblebee.\");\n    &#125;\n&#125;\n\næ¥ä¸‹æ¥ META-INF/services æ–‡ä»¶å¤¹ä¸‹åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œåç§°ä¸º Robot çš„å…¨é™å®šå Â org.apache.spi.Robotã€‚æ–‡ä»¶å†…å®¹ä¸ºå®ç°ç±»çš„å…¨é™å®šçš„ç±»åï¼Œå¦‚ä¸‹ï¼š\norg.apache.spi.OptimusPrime\norg.apache.spi.Bumblebee\n\nåšå¥½æ‰€éœ€çš„å‡†å¤‡å·¥ä½œï¼Œæ¥ä¸‹æ¥ç¼–å†™ä»£ç è¿›è¡Œæµ‹è¯•ã€‚\npublic class JavaSPITest &#123;\n\n    @Test\n    public void sayHello() throws Exception &#123;\n        ServiceLoader&lt;Robot> serviceLoader = ServiceLoader.load(Robot.class);\n        System.out.println(\"Java SPI\");\n        serviceLoader.forEach(Robot::sayHello);\n    &#125;\n&#125;\n\næœ€åæ¥çœ‹ä¸€ä¸‹æµ‹è¯•ç»“æœï¼Œå¦‚ä¸‹ï¼š\n\nä»æµ‹è¯•ç»“æœå¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬çš„ä¸¤ä¸ªå®ç°ç±»è¢«æˆåŠŸçš„åŠ è½½ï¼Œå¹¶è¾“å‡ºäº†ç›¸åº”çš„å†…å®¹ã€‚å…³äº Java SPI çš„æ¼”ç¤ºå…ˆåˆ°è¿™é‡Œï¼Œæ¥ä¸‹æ¥æ¼”ç¤º Dubbo SPIã€‚\n\n2.2 Dubbo SPI ç¤ºä¾‹Dubbo å¹¶æœªä½¿ç”¨ Java SPIï¼Œè€Œæ˜¯é‡æ–°å®ç°äº†ä¸€å¥—åŠŸèƒ½æ›´å¼ºçš„ SPI æœºåˆ¶ã€‚Dubbo SPI çš„ç›¸å…³é€»è¾‘è¢«å°è£…åœ¨äº† ExtensionLoader ç±»ä¸­ï¼Œé€šè¿‡ ExtensionLoaderï¼Œæˆ‘ä»¬å¯ä»¥åŠ è½½æŒ‡å®šçš„å®ç°ç±»ã€‚Dubbo SPI æ‰€éœ€çš„é…ç½®æ–‡ä»¶éœ€æ”¾ç½®åœ¨ META-INF/dubbo è·¯å¾„ä¸‹ï¼Œé…ç½®å†…å®¹å¦‚ä¸‹ã€‚\noptimusPrime &#x3D; org.apache.spi.OptimusPrime\nbumblebee &#x3D; org.apache.spi.Bumblebee\n\nä¸ Java SPI å®ç°ç±»é…ç½®ä¸åŒï¼ŒDubbo SPI æ˜¯é€šè¿‡é”®å€¼å¯¹çš„æ–¹å¼è¿›è¡Œé…ç½®ï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥æŒ‰éœ€åŠ è½½æŒ‡å®šçš„å®ç°ç±»ã€‚å¦å¤–ï¼Œåœ¨æµ‹è¯• Dubbo SPI æ—¶ï¼Œéœ€è¦åœ¨ Robot æ¥å£ä¸Šæ ‡æ³¨ @SPI æ³¨è§£ã€‚ä¸‹é¢æ¥æ¼”ç¤º Dubbo SPI çš„ç”¨æ³•ï¼š\npublic class DubboSPITest &#123;\n\n    @Test\n    public void sayHello() throws Exception &#123;\n        ExtensionLoader&lt;Robot> extensionLoader = \n            ExtensionLoader.getExtensionLoader(Robot.class);\n        Robot optimusPrime = extensionLoader.getExtension(\"optimusPrime\");\n        optimusPrime.sayHello();\n        Robot bumblebee = extensionLoader.getExtension(\"bumblebee\");\n        bumblebee.sayHello();\n    &#125;\n&#125;\n\næµ‹è¯•ç»“æœå¦‚ä¸‹ï¼š\n\nDubbo SPI é™¤äº†æ”¯æŒæŒ‰éœ€åŠ è½½æ¥å£å®ç°ç±»ï¼Œè¿˜å¢åŠ äº† IOC å’Œ AOP ç­‰ç‰¹æ€§ï¼Œè¿™äº›ç‰¹æ€§å°†ä¼šåœ¨æ¥ä¸‹æ¥çš„æºç åˆ†æç« èŠ‚ä¸­ä¸€ä¸€è¿›è¡Œä»‹ç»ã€‚\n\n3. Dubbo SPI æºç åˆ†æä¸Šé¢ç®€å•æ¼”ç¤ºäº† Dubbo SPI çš„ä½¿ç”¨æ–¹æ³•ã€‚æˆ‘ä»¬é¦–å…ˆé€šè¿‡ ExtensionLoader çš„ getExtensionLoader æ–¹æ³•è·å–ä¸€ä¸ª ExtensionLoader å®ä¾‹ï¼Œç„¶åå†é€šè¿‡ ExtensionLoader çš„ getExtension æ–¹æ³•è·å–æ‹“å±•ç±»å¯¹è±¡ã€‚è¿™å…¶ä¸­ï¼ŒgetExtensionLoader æ–¹æ³•ç”¨äºä»ç¼“å­˜ä¸­è·å–ä¸æ‹“å±•ç±»å¯¹åº”çš„ ExtensionLoaderï¼Œè‹¥ç¼“å­˜æœªå‘½ä¸­ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„å®ä¾‹ã€‚è¯¥æ–¹æ³•çš„é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œæœ¬ç« å°±ä¸è¿›è¡Œåˆ†æäº†ã€‚ä¸‹é¢æˆ‘ä»¬ä» ExtensionLoader çš„ getExtension æ–¹æ³•ä½œä¸ºå…¥å£ï¼Œå¯¹æ‹“å±•ç±»å¯¹è±¡çš„è·å–è¿‡ç¨‹è¿›è¡Œè¯¦ç»†çš„åˆ†æã€‚\npublic T getExtension(String name) &#123;\n    if (name == null || name.length() == 0)\n        throw new IllegalArgumentException(\"Extension name == null\");\n    if (\"true\".equals(name)) &#123;\n        // è·å–é»˜è®¤çš„æ‹“å±•å®ç°ç±»\n        return getDefaultExtension();\n    &#125;\n    // Holderï¼Œé¡¾åæ€ä¹‰ï¼Œç”¨äºæŒæœ‰ç›®æ ‡å¯¹è±¡\n    Holder&lt;Object> holder = cachedInstances.get(name);\n    if (holder == null) &#123;\n        cachedInstances.putIfAbsent(name, new Holder&lt;Object>());\n        holder = cachedInstances.get(name);\n    &#125;\n    Object instance = holder.get();\n    // åŒé‡æ£€æŸ¥\n    if (instance == null) &#123;\n        synchronized (holder) &#123;\n            instance = holder.get();\n            if (instance == null) &#123;\n                // åˆ›å»ºæ‹“å±•å®ä¾‹\n                instance = createExtension(name);\n                // è®¾ç½®å®ä¾‹åˆ° holder ä¸­\n                holder.set(instance);\n            &#125;\n        &#125;\n    &#125;\n    return (T) instance;\n&#125;\n\nä¸Šé¢ä»£ç çš„é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œé¦–å…ˆæ£€æŸ¥ç¼“å­˜ï¼Œç¼“å­˜æœªå‘½ä¸­åˆ™åˆ›å»ºæ‹“å±•å¯¹è±¡ã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹åˆ›å»ºæ‹“å±•å¯¹è±¡çš„è¿‡ç¨‹æ˜¯æ€æ ·çš„ã€‚\nprivate T createExtension(String name) &#123;\n    // ä»é…ç½®æ–‡ä»¶ä¸­åŠ è½½æ‰€æœ‰çš„æ‹“å±•ç±»ï¼Œå¯å¾—åˆ°â€œé…ç½®é¡¹åç§°â€åˆ°â€œé…ç½®ç±»â€çš„æ˜ å°„å…³ç³»è¡¨\n    Class&lt;?> clazz = getExtensionClasses().get(name);\n    if (clazz == null) &#123;\n        throw findException(name);\n    &#125;\n    try &#123;\n        T instance = (T) EXTENSION_INSTANCES.get(clazz);\n        if (instance == null) &#123;\n            // é€šè¿‡åå°„åˆ›å»ºå®ä¾‹\n            EXTENSION_INSTANCES.putIfAbsent(clazz, clazz.newInstance());\n            instance = (T) EXTENSION_INSTANCES.get(clazz);\n        &#125;\n        // å‘å®ä¾‹ä¸­æ³¨å…¥ä¾èµ–\n        injectExtension(instance);\n        Set&lt;Class&lt;?>> wrapperClasses = cachedWrapperClasses;\n        if (wrapperClasses != null &amp;&amp; !wrapperClasses.isEmpty()) &#123;\n            // å¾ªç¯åˆ›å»º Wrapper å®ä¾‹\n            for (Class&lt;?> wrapperClass : wrapperClasses) &#123;\n                // å°†å½“å‰ instance ä½œä¸ºå‚æ•°ä¼ ç»™ Wrapper çš„æ„é€ æ–¹æ³•ï¼Œå¹¶é€šè¿‡åå°„åˆ›å»º Wrapper å®ä¾‹ã€‚\n                // ç„¶åå‘ Wrapper å®ä¾‹ä¸­æ³¨å…¥ä¾èµ–ï¼Œæœ€åå°† Wrapper å®ä¾‹å†æ¬¡èµ‹å€¼ç»™ instance å˜é‡\n                instance = injectExtension(\n                    (T) wrapperClass.getConstructor(type).newInstance(instance));\n            &#125;\n        &#125;\n        return instance;\n    &#125; catch (Throwable t) &#123;\n        throw new IllegalStateException(\"...\");\n    &#125;\n&#125;\n\ncreateExtension æ–¹æ³•çš„é€»è¾‘ç¨å¤æ‚ä¸€ä¸‹ï¼ŒåŒ…å«äº†å¦‚ä¸‹çš„æ­¥éª¤ï¼š\n\né€šè¿‡ getExtensionClasses è·å–æ‰€æœ‰çš„æ‹“å±•ç±»\né€šè¿‡åå°„åˆ›å»ºæ‹“å±•å¯¹è±¡\nå‘æ‹“å±•å¯¹è±¡ä¸­æ³¨å…¥ä¾èµ–\nå°†æ‹“å±•å¯¹è±¡åŒ…è£¹åœ¨ç›¸åº”çš„ Wrapper å¯¹è±¡ä¸­\n\nä»¥ä¸Šæ­¥éª¤ä¸­ï¼Œç¬¬ä¸€ä¸ªæ­¥éª¤æ˜¯åŠ è½½æ‹“å±•ç±»çš„å…³é”®ï¼Œç¬¬ä¸‰å’Œç¬¬å››ä¸ªæ­¥éª¤æ˜¯ Dubbo IOC ä¸ AOP çš„å…·ä½“å®ç°ã€‚åœ¨æ¥ä¸‹æ¥çš„ç« èŠ‚ä¸­ï¼Œå°†ä¼šé‡ç‚¹åˆ†æ getExtensionClasses æ–¹æ³•çš„é€»è¾‘ï¼Œä»¥åŠç®€å•ä»‹ç» Dubbo IOC çš„å…·ä½“å®ç°ã€‚\n\n3.1 è·å–æ‰€æœ‰çš„æ‹“å±•ç±»æˆ‘ä»¬åœ¨é€šè¿‡åç§°è·å–æ‹“å±•ç±»ä¹‹å‰ï¼Œé¦–å…ˆéœ€è¦æ ¹æ®é…ç½®æ–‡ä»¶è§£æå‡ºæ‹“å±•é¡¹åç§°åˆ°æ‹“å±•ç±»çš„æ˜ å°„å…³ç³»è¡¨ï¼ˆMap&lt;åç§°, æ‹“å±•ç±»&gt;ï¼‰ï¼Œä¹‹åå†æ ¹æ®æ‹“å±•é¡¹åç§°ä»æ˜ å°„å…³ç³»è¡¨ä¸­å–å‡ºç›¸åº”çš„æ‹“å±•ç±»å³å¯ã€‚ç›¸å…³è¿‡ç¨‹çš„ä»£ç åˆ†æå¦‚ä¸‹ï¼š\nprivate Map&lt;String, Class&lt;?>> getExtensionClasses() &#123;\n    // ä»ç¼“å­˜ä¸­è·å–å·²åŠ è½½çš„æ‹“å±•ç±»\n    Map&lt;String, Class&lt;?>> classes = cachedClasses.get();\n    // åŒé‡æ£€æŸ¥\n    if (classes == null) &#123;\n        synchronized (cachedClasses) &#123;\n            classes = cachedClasses.get();\n            if (classes == null) &#123;\n                // åŠ è½½æ‹“å±•ç±»\n                classes = loadExtensionClasses();\n                cachedClasses.set(classes);\n            &#125;\n        &#125;\n    &#125;\n    return classes;\n&#125;\n\nè¿™é‡Œä¹Ÿæ˜¯å…ˆæ£€æŸ¥ç¼“å­˜ï¼Œè‹¥ç¼“å­˜æœªå‘½ä¸­ï¼Œåˆ™é€šè¿‡ synchronized åŠ é”ã€‚åŠ é”åå†æ¬¡æ£€æŸ¥ç¼“å­˜ï¼Œå¹¶åˆ¤ç©ºã€‚æ­¤æ—¶å¦‚æœ classes ä»ä¸º nullï¼Œåˆ™é€šè¿‡ loadExtensionClasses åŠ è½½æ‹“å±•ç±»ã€‚ä¸‹é¢åˆ†æ loadExtensionClasses æ–¹æ³•çš„é€»è¾‘ã€‚\nprivate Map&lt;String, Class&lt;?>> loadExtensionClasses() &#123;\n    // è·å– SPI æ³¨è§£ï¼Œè¿™é‡Œçš„ type å˜é‡æ˜¯åœ¨è°ƒç”¨ getExtensionLoader æ–¹æ³•æ—¶ä¼ å…¥çš„\n    final SPI defaultAnnotation = type.getAnnotation(SPI.class);\n    if (defaultAnnotation != null) &#123;\n        String value = defaultAnnotation.value();\n        if ((value = value.trim()).length() > 0) &#123;\n            // å¯¹ SPI æ³¨è§£å†…å®¹è¿›è¡Œåˆ‡åˆ†\n            String[] names = NAME_SEPARATOR.split(value);\n            // æ£€æµ‹ SPI æ³¨è§£å†…å®¹æ˜¯å¦åˆæ³•ï¼Œä¸åˆæ³•åˆ™æŠ›å‡ºå¼‚å¸¸\n            if (names.length > 1) &#123;\n                throw new IllegalStateException(\"more than 1 default extension name on extension...\");\n            &#125;\n\n            // è®¾ç½®é»˜è®¤åç§°ï¼Œå‚è€ƒ getDefaultExtension æ–¹æ³•\n            if (names.length == 1) &#123;\n                cachedDefaultName = names[0];\n            &#125;\n        &#125;\n    &#125;\n\n    Map&lt;String, Class&lt;?>> extensionClasses = new HashMap&lt;String, Class&lt;?>>();\n    // åŠ è½½æŒ‡å®šæ–‡ä»¶å¤¹ä¸‹çš„é…ç½®æ–‡ä»¶\n    loadDirectory(extensionClasses, DUBBO_INTERNAL_DIRECTORY);\n    loadDirectory(extensionClasses, DUBBO_DIRECTORY);\n    loadDirectory(extensionClasses, SERVICES_DIRECTORY);\n    return extensionClasses;\n&#125;\n\nloadExtensionClasses æ–¹æ³•æ€»å…±åšäº†ä¸¤ä»¶äº‹æƒ…ï¼Œä¸€æ˜¯å¯¹ SPI æ³¨è§£è¿›è¡Œè§£æï¼ŒäºŒæ˜¯è°ƒç”¨ loadDirectory æ–¹æ³•åŠ è½½æŒ‡å®šæ–‡ä»¶å¤¹é…ç½®æ–‡ä»¶ã€‚SPI æ³¨è§£è§£æè¿‡ç¨‹æ¯”è¾ƒç®€å•ï¼Œæ— éœ€å¤šè¯´ã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ loadDirectory åšäº†å“ªäº›äº‹æƒ…ã€‚\nprivate void loadDirectory(Map&lt;String, Class&lt;?>> extensionClasses, String dir) &#123;\n    // fileName = æ–‡ä»¶å¤¹è·¯å¾„ + type å…¨é™å®šå \n    String fileName = dir + type.getName();\n    try &#123;\n        Enumeration&lt;java.net.URL> urls;\n        ClassLoader classLoader = findClassLoader();\n        // æ ¹æ®æ–‡ä»¶ååŠ è½½æ‰€æœ‰çš„åŒåæ–‡ä»¶\n        if (classLoader != null) &#123;\n            urls = classLoader.getResources(fileName);\n        &#125; else &#123;\n            urls = ClassLoader.getSystemResources(fileName);\n        &#125;\n        if (urls != null) &#123;\n            while (urls.hasMoreElements()) &#123;\n                java.net.URL resourceURL = urls.nextElement();\n                // åŠ è½½èµ„æº\n                loadResource(extensionClasses, classLoader, resourceURL);\n            &#125;\n        &#125;\n    &#125; catch (Throwable t) &#123;\n        logger.error(\"...\");\n    &#125;\n&#125;\n\nloadDirectory æ–¹æ³•å…ˆé€šè¿‡ classLoader è·å–æ‰€æœ‰èµ„æºé“¾æ¥ï¼Œç„¶åå†é€šè¿‡ loadResource æ–¹æ³•åŠ è½½èµ„æºã€‚æˆ‘ä»¬ç»§ç»­è·Ÿä¸‹å»ï¼Œçœ‹ä¸€ä¸‹ loadResource æ–¹æ³•çš„å®ç°ã€‚\nprivate void loadResource(Map&lt;String, Class&lt;?>> extensionClasses, \n\tClassLoader classLoader, java.net.URL resourceURL) &#123;\n    try &#123;\n        BufferedReader reader = new BufferedReader(\n            new InputStreamReader(resourceURL.openStream(), \"utf-8\"));\n        try &#123;\n            String line;\n            // æŒ‰è¡Œè¯»å–é…ç½®å†…å®¹\n            while ((line = reader.readLine()) != null) &#123;\n                // å®šä½ # å­—ç¬¦\n                final int ci = line.indexOf('#');\n                if (ci >= 0) &#123;\n                    // æˆªå– # ä¹‹å‰çš„å­—ç¬¦ä¸²ï¼Œ# ä¹‹åçš„å†…å®¹ä¸ºæ³¨é‡Šï¼Œéœ€è¦å¿½ç•¥\n                    line = line.substring(0, ci);\n                &#125;\n                line = line.trim();\n                if (line.length() > 0) &#123;\n                    try &#123;\n                        String name = null;\n                        int i = line.indexOf('=');\n                        if (i > 0) &#123;\n                            // ä»¥ç­‰äºå· = ä¸ºç•Œï¼Œæˆªå–é”®ä¸å€¼\n                            name = line.substring(0, i).trim();\n                            line = line.substring(i + 1).trim();\n                        &#125;\n                        if (line.length() > 0) &#123;\n                            // åŠ è½½ç±»ï¼Œå¹¶é€šè¿‡ loadClass æ–¹æ³•å¯¹ç±»è¿›è¡Œç¼“å­˜\n                            loadClass(extensionClasses, resourceURL, \n                                      Class.forName(line, true, classLoader), name);\n                        &#125;\n                    &#125; catch (Throwable t) &#123;\n                        IllegalStateException e = new IllegalStateException(\"Failed to load extension class...\");\n                    &#125;\n                &#125;\n            &#125;\n        &#125; finally &#123;\n            reader.close();\n        &#125;\n    &#125; catch (Throwable t) &#123;\n        logger.error(\"Exception when load extension class...\");\n    &#125;\n&#125;\n\nloadResource æ–¹æ³•ç”¨äºè¯»å–å’Œè§£æé…ç½®æ–‡ä»¶ï¼Œå¹¶é€šè¿‡åå°„åŠ è½½ç±»ï¼Œæœ€åè°ƒç”¨ loadClass æ–¹æ³•è¿›è¡Œå…¶ä»–æ“ä½œã€‚loadClass æ–¹æ³•ç”¨äºä¸»è¦ç”¨äºæ“ä½œç¼“å­˜ï¼Œè¯¥æ–¹æ³•çš„é€»è¾‘å¦‚ä¸‹ï¼š\nprivate void loadClass(Map&lt;String, Class&lt;?>> extensionClasses, java.net.URL resourceURL, \n    Class&lt;?> clazz, String name) throws NoSuchMethodException &#123;\n    \n    if (!type.isAssignableFrom(clazz)) &#123;\n        throw new IllegalStateException(\"...\");\n    &#125;\n\n    // æ£€æµ‹ç›®æ ‡ç±»ä¸Šæ˜¯å¦æœ‰ Adaptive æ³¨è§£\n    if (clazz.isAnnotationPresent(Adaptive.class)) &#123;\n        if (cachedAdaptiveClass == null) &#123;\n            // è®¾ç½® cachedAdaptiveClassç¼“å­˜\n            cachedAdaptiveClass = clazz;\n        &#125; else if (!cachedAdaptiveClass.equals(clazz)) &#123;\n            throw new IllegalStateException(\"...\");\n        &#125;\n        \n    // æ£€æµ‹ clazz æ˜¯å¦æ˜¯ Wrapper ç±»å‹\n    &#125; else if (isWrapperClass(clazz)) &#123;\n        Set&lt;Class&lt;?>> wrappers = cachedWrapperClasses;\n        if (wrappers == null) &#123;\n            cachedWrapperClasses = new ConcurrentHashSet&lt;Class&lt;?>>();\n            wrappers = cachedWrapperClasses;\n        &#125;\n        // å­˜å‚¨ clazz åˆ° cachedWrapperClasses ç¼“å­˜ä¸­\n        wrappers.add(clazz);\n        \n    // ç¨‹åºè¿›å…¥æ­¤åˆ†æ”¯ï¼Œè¡¨æ˜ clazz æ˜¯ä¸€ä¸ªæ™®é€šçš„æ‹“å±•ç±»\n    &#125; else &#123;\n        // æ£€æµ‹ clazz æ˜¯å¦æœ‰é»˜è®¤çš„æ„é€ æ–¹æ³•ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸\n        clazz.getConstructor();\n        if (name == null || name.length() == 0) &#123;\n            // å¦‚æœ name ä¸ºç©ºï¼Œåˆ™å°è¯•ä» Extension æ³¨è§£ä¸­è·å– nameï¼Œæˆ–ä½¿ç”¨å°å†™çš„ç±»åä½œä¸º name\n            name = findAnnotationName(clazz);\n            if (name.length() == 0) &#123;\n                throw new IllegalStateException(\"...\");\n            &#125;\n        &#125;\n        // åˆ‡åˆ† name\n        String[] names = NAME_SEPARATOR.split(name);\n        if (names != null &amp;&amp; names.length > 0) &#123;\n            Activate activate = clazz.getAnnotation(Activate.class);\n            if (activate != null) &#123;\n                // å¦‚æœç±»ä¸Šæœ‰ Activate æ³¨è§£ï¼Œåˆ™ä½¿ç”¨ names æ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ ä½œä¸ºé”®ï¼Œ\n                // å­˜å‚¨ name åˆ° Activate æ³¨è§£å¯¹è±¡çš„æ˜ å°„å…³ç³»\n                cachedActivates.put(names[0], activate);\n            &#125;\n            for (String n : names) &#123;\n                if (!cachedNames.containsKey(clazz)) &#123;\n                    // å­˜å‚¨ Class åˆ°åç§°çš„æ˜ å°„å…³ç³»\n                    cachedNames.put(clazz, n);\n                &#125;\n                Class&lt;?> c = extensionClasses.get(n);\n                if (c == null) &#123;\n                    // å­˜å‚¨åç§°åˆ° Class çš„æ˜ å°„å…³ç³»\n                    extensionClasses.put(n, clazz);\n                &#125; else if (c != clazz) &#123;\n                    throw new IllegalStateException(\"...\");\n                &#125;\n            &#125;\n        &#125;\n    &#125;\n&#125;\n\nå¦‚ä¸Šï¼ŒloadClass æ–¹æ³•æ“ä½œäº†ä¸åŒçš„ç¼“å­˜ï¼Œæ¯”å¦‚ cachedAdaptiveClassã€cachedWrapperClasses å’Œ cachedNames ç­‰ç­‰ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œè¯¥æ–¹æ³•æ²¡æœ‰å…¶ä»–ä»€ä¹ˆé€»è¾‘äº†ã€‚\nåˆ°æ­¤ï¼Œå…³äºç¼“å­˜ç±»åŠ è½½çš„è¿‡ç¨‹å°±åˆ†æå®Œäº†ã€‚æ•´ä¸ªè¿‡ç¨‹æ²¡ä»€ä¹ˆç‰¹åˆ«å¤æ‚çš„åœ°æ–¹ï¼Œå¤§å®¶æŒ‰éƒ¨å°±ç­çš„åˆ†æå³å¯ï¼Œä¸æ‡‚çš„åœ°æ–¹å¯ä»¥è°ƒè¯•ä¸€ä¸‹ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥èŠèŠ Dubbo IOC æ–¹é¢çš„å†…å®¹ã€‚\n\n3.2 Dubbo IOCDubbo IOC æ˜¯é€šè¿‡ setter æ–¹æ³•æ³¨å…¥ä¾èµ–ã€‚Dubbo é¦–å…ˆä¼šé€šè¿‡åå°„è·å–åˆ°å®ä¾‹çš„æ‰€æœ‰æ–¹æ³•ï¼Œç„¶åå†éå†æ–¹æ³•åˆ—è¡¨ï¼Œæ£€æµ‹æ–¹æ³•åæ˜¯å¦å…·æœ‰ setter æ–¹æ³•ç‰¹å¾ã€‚è‹¥æœ‰ï¼Œåˆ™é€šè¿‡ ObjectFactory è·å–ä¾èµ–å¯¹è±¡ï¼Œæœ€åé€šè¿‡åå°„è°ƒç”¨ setter æ–¹æ³•å°†ä¾èµ–è®¾ç½®åˆ°ç›®æ ‡å¯¹è±¡ä¸­ã€‚æ•´ä¸ªè¿‡ç¨‹å¯¹åº”çš„ä»£ç å¦‚ä¸‹ï¼š\nprivate T injectExtension(T instance) &#123;\n    try &#123;\n        if (objectFactory != null) &#123;\n            // éå†ç›®æ ‡ç±»çš„æ‰€æœ‰æ–¹æ³•\n            for (Method method : instance.getClass().getMethods()) &#123;\n                // æ£€æµ‹æ–¹æ³•æ˜¯å¦ä»¥ set å¼€å¤´ï¼Œä¸”æ–¹æ³•ä»…æœ‰ä¸€ä¸ªå‚æ•°ï¼Œä¸”æ–¹æ³•è®¿é—®çº§åˆ«ä¸º public\n                if (method.getName().startsWith(\"set\")\n                    &amp;&amp; method.getParameterTypes().length == 1\n                    &amp;&amp; Modifier.isPublic(method.getModifiers())) &#123;\n                    // è·å– setter æ–¹æ³•å‚æ•°ç±»å‹\n                    Class&lt;?> pt = method.getParameterTypes()[0];\n                    try &#123;\n                        // è·å–å±æ€§åï¼Œæ¯”å¦‚ setName æ–¹æ³•å¯¹åº”å±æ€§å name\n                        String property = method.getName().length() > 3 ? \n                            method.getName().substring(3, 4).toLowerCase() + \n                            \tmethod.getName().substring(4) : \"\";\n                        // ä» ObjectFactory ä¸­è·å–ä¾èµ–å¯¹è±¡\n                        Object object = objectFactory.getExtension(pt, property);\n                        if (object != null) &#123;\n                            // é€šè¿‡åå°„è°ƒç”¨ setter æ–¹æ³•è®¾ç½®ä¾èµ–\n                            method.invoke(instance, object);\n                        &#125;\n                    &#125; catch (Exception e) &#123;\n                        logger.error(\"fail to inject via method...\");\n                    &#125;\n                &#125;\n            &#125;\n        &#125;\n    &#125; catch (Exception e) &#123;\n        logger.error(e.getMessage(), e);\n    &#125;\n    return instance;\n&#125;\n\nåœ¨ä¸Šé¢ä»£ç ä¸­ï¼ŒobjectFactory å˜é‡çš„ç±»å‹ä¸º AdaptiveExtensionFactoryï¼ŒAdaptiveExtensionFactory å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ª ExtensionFactory åˆ—è¡¨ï¼Œç”¨äºå­˜å‚¨å…¶ä»–ç±»å‹çš„ ExtensionFactoryã€‚Dubbo ç›®å‰æä¾›äº†ä¸¤ç§ ExtensionFactoryï¼Œåˆ†åˆ«æ˜¯ SpiExtensionFactory å’Œ SpringExtensionFactoryã€‚å‰è€…ç”¨äºåˆ›å»ºè‡ªé€‚åº”çš„æ‹“å±•ï¼Œåè€…æ˜¯ç”¨äºä» Spring çš„ IOC å®¹å™¨ä¸­è·å–æ‰€éœ€çš„æ‹“å±•ã€‚è¿™ä¸¤ä¸ªç±»çš„ç±»çš„ä»£ç ä¸æ˜¯å¾ˆå¤æ‚ï¼Œè¿™é‡Œå°±ä¸ä¸€ä¸€åˆ†æäº†ã€‚\nDubbo IOC ç›®å‰ä»…æ”¯æŒ setter æ–¹å¼æ³¨å…¥ï¼Œæ€»çš„æ¥è¯´ï¼Œé€»è¾‘æ¯”è¾ƒç®€å•æ˜“æ‡‚ã€‚\n\n4.æ€»ç»“æœ¬ç¯‡æ–‡ç« ç®€å•åˆ†åˆ«ä»‹ç»äº† Java SPI ä¸ Dubbo SPI ç”¨æ³•ï¼Œå¹¶å¯¹ Dubbo SPI çš„åŠ è½½æ‹“å±•ç±»çš„è¿‡ç¨‹è¿›è¡Œäº†åˆ†æã€‚å¦å¤–ï¼Œåœ¨ Dubbo SPI ä¸­è¿˜æœ‰ä¸€å—é‡è¦çš„é€»è¾‘è¿™é‡Œæ²¡æœ‰è¿›è¡Œåˆ†æï¼Œå³ Dubbo SPI çš„æ‰©å±•ç‚¹è‡ªé€‚åº”æœºåˆ¶ã€‚è¯¥æœºåˆ¶çš„é€»è¾‘è¾ƒä¸ºå¤æ‚ï¼Œæˆ‘ä»¬å°†ä¼šåœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­è¿›è¡Œè¯¦ç»†çš„åˆ†æã€‚\nå¥½äº†ï¼Œæœ¬ç¯‡æ–‡ç« å°±å…ˆåˆ°è¿™é‡Œäº†ã€‚å¦‚æœæ–‡ç« ä¸­æœ‰é”™è¯¯ä¸å¦¥ä¹‹å¤„ï¼Œæ¬¢è¿å¤§å®¶æ issue è¿›è¡Œåé¦ˆï¼Œæˆ–è€…æ pull request è¿›è¡Œä¿®æ­£ã€‚è®©æˆ‘ä»¬æºæ‰‹å…±å»º Dubbo ç¤¾åŒºã€‚\n\n\n\n\n\n\n\n\n\nåŸæ–‡åœ°å€ï¼šhttps://dubbo.apache.org/zh/docsv2.7/dev/source/adaptive-extension/\nä½œè€…ï¼š Dubbo å®˜æ–¹\n\nDubbo SPIè‡ªé€‚åº”æ€§æ‰©å±•1.åŸç†åœ¨ Dubbo ä¸­ï¼Œå¾ˆå¤šæ‹“å±•éƒ½æ˜¯é€šè¿‡ SPI æœºåˆ¶è¿›è¡ŒåŠ è½½çš„ï¼Œæ¯”å¦‚ Protocolã€Clusterã€LoadBalance ç­‰ã€‚æœ‰æ—¶ï¼Œæœ‰äº›æ‹“å±•å¹¶ä¸æƒ³åœ¨æ¡†æ¶å¯åŠ¨é˜¶æ®µè¢«åŠ è½½ï¼Œè€Œæ˜¯å¸Œæœ›åœ¨æ‹“å±•æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œæ ¹æ®è¿è¡Œæ—¶å‚æ•°è¿›è¡ŒåŠ è½½ã€‚è¿™å¬èµ·æ¥æœ‰äº›çŸ›ç›¾ã€‚æ‹“å±•æœªè¢«åŠ è½½ï¼Œé‚£ä¹ˆæ‹“å±•æ–¹æ³•å°±æ— æ³•è¢«è°ƒç”¨ï¼ˆé™æ€æ–¹æ³•é™¤å¤–ï¼‰ã€‚æ‹“å±•æ–¹æ³•æœªè¢«è°ƒç”¨ï¼Œæ‹“å±•å°±æ— æ³•è¢«åŠ è½½ã€‚å¯¹äºè¿™ä¸ªçŸ›ç›¾çš„é—®é¢˜ï¼ŒDubbo é€šè¿‡è‡ªé€‚åº”æ‹“å±•æœºåˆ¶å¾ˆå¥½çš„è§£å†³äº†ã€‚è‡ªé€‚åº”æ‹“å±•æœºåˆ¶çš„å®ç°é€»è¾‘æ¯”è¾ƒå¤æ‚ï¼Œé¦–å…ˆ Dubbo ä¼šä¸ºæ‹“å±•æ¥å£ç”Ÿæˆå…·æœ‰ä»£ç†åŠŸèƒ½çš„ä»£ç ã€‚ç„¶åé€šè¿‡ javassist æˆ– jdk ç¼–è¯‘è¿™æ®µä»£ç ï¼Œå¾—åˆ° Class ç±»ã€‚æœ€åå†é€šè¿‡åå°„åˆ›å»ºä»£ç†ç±»ï¼Œæ•´ä¸ªè¿‡ç¨‹æ¯”è¾ƒå¤æ‚ã€‚ä¸ºäº†è®©å¤§å®¶å¯¹è‡ªé€‚åº”æ‹“å±•æœ‰ä¸€ä¸ªæ„Ÿæ€§çš„è®¤è¯†ï¼Œä¸‹é¢æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç¤ºä¾‹è¿›è¡Œæ¼”ç¤ºã€‚è¿™æ˜¯ä¸€ä¸ªä¸æ±½è½¦ç›¸å…³çš„ä¾‹å­ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªè½¦è½®åˆ¶é€ å‚æ¥å£ WheelMakerï¼š\npublic interface WheelMaker &#123;\n    Wheel makeWheel(URL url);\n&#125;\n\nWheelMaker æ¥å£çš„è‡ªé€‚åº”å®ç°ç±»å¦‚ä¸‹ï¼š\npublic class AdaptiveWheelMaker implements WheelMaker &#123;\n    public Wheel makeWheel(URL url) &#123;\n        if (url == null) &#123;\n            throw new IllegalArgumentException(\"url == null\");\n        &#125;\n        \n    \t// 1.ä» URL ä¸­è·å– WheelMaker åç§°\n        String wheelMakerName = url.getParameter(\"Wheel.maker\");\n        if (wheelMakerName == null) &#123;\n            throw new IllegalArgumentException(\"wheelMakerName == null\");\n        &#125;\n        \n        // 2.é€šè¿‡ SPI åŠ è½½å…·ä½“çš„ WheelMaker\n        WheelMaker wheelMaker = ExtensionLoader\n            .getExtensionLoader(WheelMaker.class).getExtension(wheelMakerName);\n        \n        // 3.è°ƒç”¨ç›®æ ‡æ–¹æ³•\n        return wheelMaker.makeWheel(url);\n    &#125;\n&#125;\n\nAdaptiveWheelMaker æ˜¯ä¸€ä¸ªä»£ç†ç±»ï¼Œä¸ä¼ ç»Ÿçš„ä»£ç†é€»è¾‘ä¸åŒï¼ŒAdaptiveWheelMaker æ‰€ä»£ç†çš„å¯¹è±¡æ˜¯åœ¨ makeWheel æ–¹æ³•ä¸­é€šè¿‡ SPI åŠ è½½å¾—åˆ°çš„ã€‚makeWheel æ–¹æ³•ä¸»è¦åšäº†ä¸‰ä»¶äº‹æƒ…ï¼š\n\nä» URL ä¸­è·å– WheelMaker åç§°\né€šè¿‡ SPI åŠ è½½å…·ä½“çš„ WheelMaker å®ç°ç±»\nè°ƒç”¨ç›®æ ‡æ–¹æ³•\n\næ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹æ±½è½¦åˆ¶é€ å‚ CarMaker æ¥å£ä¸å…¶å®ç°ç±»ã€‚\npublic interface CarMaker &#123;\n    Car makeCar(URL url);\n&#125;\n\npublic class RaceCarMaker implements CarMaker &#123;\n    WheelMaker wheelMaker;\n \n    // é€šè¿‡ setter æ³¨å…¥ AdaptiveWheelMaker\n    public setWheelMaker(WheelMaker wheelMaker) &#123;\n        this.wheelMaker = wheelMaker;\n    &#125;\n \n    public Car makeCar(URL url) &#123;\n        Wheel wheel = wheelMaker.makeWheel(url);\n        return new RaceCar(wheel, ...);\n    &#125;\n&#125;\n\nRaceCarMaker æŒæœ‰ä¸€ä¸ª WheelMaker ç±»å‹çš„æˆå‘˜å˜é‡ï¼Œåœ¨ç¨‹åºå¯åŠ¨æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å°† AdaptiveWheelMaker é€šè¿‡ setter æ–¹æ³•æ³¨å…¥åˆ° RaceCarMaker ä¸­ã€‚åœ¨è¿è¡Œæ—¶ï¼Œå‡è®¾æœ‰è¿™æ ·ä¸€ä¸ª url å‚æ•°ä¼ å…¥ï¼š\ndubbo:&#x2F;&#x2F;192.168.0.101:20880&#x2F;XxxService?wheel.maker&#x3D;MichelinWheelMaker\n\nRaceCarMaker çš„ makeCar æ–¹æ³•å°†ä¸Šé¢çš„ url ä½œä¸ºå‚æ•°ä¼ ç»™ AdaptiveWheelMaker çš„ makeWheel æ–¹æ³•ï¼ŒmakeWheel æ–¹æ³•ä» url ä¸­æå– wheel.maker å‚æ•°ï¼Œå¾—åˆ° MichelinWheelMakerã€‚ä¹‹åå†é€šè¿‡ SPI åŠ è½½é…ç½®åä¸º MichelinWheelMaker çš„å®ç°ç±»ï¼Œå¾—åˆ°å…·ä½“çš„ WheelMaker å®ä¾‹ã€‚\nä¸Šé¢çš„ç¤ºä¾‹å±•ç¤ºäº†è‡ªé€‚åº”æ‹“å±•ç±»çš„æ ¸å¿ƒå®ç° â€”- åœ¨æ‹“å±•æ¥å£çš„æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œé€šè¿‡ SPI åŠ è½½å…·ä½“çš„æ‹“å±•å®ç°ç±»ï¼Œå¹¶è°ƒç”¨æ‹“å±•å¯¹è±¡çš„åŒåæ–¹æ³•ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ·±å…¥åˆ°æºç ä¸­ï¼Œæ¢ç´¢è‡ªé€‚åº”æ‹“å±•ç±»ç”Ÿæˆçš„è¿‡ç¨‹ã€‚\n\n2.æºç åˆ†æåœ¨å¯¹è‡ªé€‚åº”æ‹“å±•ç”Ÿæˆè¿‡ç¨‹è¿›è¡Œæ·±å…¥åˆ†æä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹ä¸è‡ªé€‚åº”æ‹“å±•æ¯æ¯ç›¸å…³çš„ä¸€ä¸ªæ³¨è§£ï¼Œå³ Adaptive æ³¨è§£ã€‚è¯¥æ³¨è§£çš„å®šä¹‰å¦‚ä¸‹ï¼š\n@Documented\n@Retention(RetentionPolicy.RUNTIME)\n@Target(&#123;ElementType.TYPE, ElementType.METHOD&#125;)\npublic @interface Adaptive &#123;\n    String[] value() default &#123;&#125;;\n&#125;\n\nä»ä¸Šé¢çš„ä»£ç ä¸­å¯çŸ¥ï¼ŒAdaptive å¯æ³¨è§£åœ¨ç±»æˆ–æ–¹æ³•ä¸Šã€‚å½“ Adaptive æ³¨è§£åœ¨ç±»ä¸Šæ—¶ï¼ŒDubbo ä¸ä¼šä¸ºè¯¥ç±»ç”Ÿæˆä»£ç†ç±»ã€‚æ³¨è§£åœ¨æ–¹æ³•ï¼ˆæ¥å£æ–¹æ³•ï¼‰ä¸Šæ—¶ï¼ŒDubbo åˆ™ä¼šä¸ºè¯¥æ–¹æ³•ç”Ÿæˆä»£ç†é€»è¾‘ã€‚Adaptive æ³¨è§£åœ¨ç±»ä¸Šçš„æƒ…å†µå¾ˆå°‘ï¼Œåœ¨ Dubbo ä¸­ï¼Œä»…æœ‰ä¸¤ä¸ªç±»è¢« Adaptive æ³¨è§£äº†ï¼Œåˆ†åˆ«æ˜¯ AdaptiveCompiler å’Œ AdaptiveExtensionFactoryã€‚æ­¤ç§æƒ…å†µï¼Œè¡¨ç¤ºæ‹“å±•çš„åŠ è½½é€»è¾‘ç”±äººå·¥ç¼–ç å®Œæˆã€‚æ›´å¤šæ—¶å€™ï¼ŒAdaptive æ˜¯æ³¨è§£åœ¨æ¥å£æ–¹æ³•ä¸Šçš„ï¼Œè¡¨ç¤ºæ‹“å±•çš„åŠ è½½é€»è¾‘éœ€ç”±æ¡†æ¶è‡ªåŠ¨ç”Ÿæˆã€‚Adaptive æ³¨è§£çš„åœ°æ–¹ä¸åŒï¼Œç›¸åº”çš„å¤„ç†é€»è¾‘ä¹Ÿæ˜¯ä¸åŒçš„ã€‚æ³¨è§£åœ¨ç±»ä¸Šæ—¶ï¼Œå¤„ç†é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œæœ¬æ–‡å°±ä¸åˆ†æäº†ã€‚æ³¨è§£åœ¨æ¥å£æ–¹æ³•ä¸Šæ—¶ï¼Œå¤„ç†é€»è¾‘è¾ƒä¸ºå¤æ‚ï¼Œæœ¬ç« å°†ä¼šé‡ç‚¹åˆ†ææ­¤å—é€»è¾‘ã€‚\n\n2.1 è·å–è‡ªé€‚åº”æ‹“å±•getAdaptiveExtension æ–¹æ³•æ˜¯è·å–è‡ªé€‚åº”æ‹“å±•çš„å…¥å£æ–¹æ³•ï¼Œå› æ­¤ä¸‹é¢æˆ‘ä»¬ä»è¿™ä¸ªæ–¹æ³•è¿›è¡Œåˆ†æã€‚ç›¸å…³ä»£ç å¦‚ä¸‹ï¼š\npublic T getAdaptiveExtension() &#123;\n    // ä»ç¼“å­˜ä¸­è·å–è‡ªé€‚åº”æ‹“å±•\n    Object instance = cachedAdaptiveInstance.get();\n    if (instance == null) &#123;    // ç¼“å­˜æœªå‘½ä¸­\n        if (createAdaptiveInstanceError == null) &#123;\n            synchronized (cachedAdaptiveInstance) &#123;\n                instance = cachedAdaptiveInstance.get();\n                if (instance == null) &#123;\n                    try &#123;\n                        // åˆ›å»ºè‡ªé€‚åº”æ‹“å±•\n                        instance = createAdaptiveExtension();\n                        // è®¾ç½®è‡ªé€‚åº”æ‹“å±•åˆ°ç¼“å­˜ä¸­\n                        cachedAdaptiveInstance.set(instance);\n                    &#125; catch (Throwable t) &#123;\n                        createAdaptiveInstanceError = t;\n                        throw new IllegalStateException(\"fail to create adaptive instance: ...\");\n                    &#125;\n                &#125;\n            &#125;\n        &#125; else &#123;\n            throw new IllegalStateException(\"fail to create adaptive instance:  ...\");\n        &#125;\n    &#125;\n\n    return (T) instance;\n&#125;\n\ngetAdaptiveExtension æ–¹æ³•é¦–å…ˆä¼šæ£€æŸ¥ç¼“å­˜ï¼Œç¼“å­˜æœªå‘½ä¸­ï¼Œåˆ™è°ƒç”¨ createAdaptiveExtension æ–¹æ³•åˆ›å»ºè‡ªé€‚åº”æ‹“å±•ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ createAdaptiveExtension æ–¹æ³•çš„ä»£ç ã€‚\nprivate T createAdaptiveExtension() &#123;\n    try &#123;\n        // è·å–è‡ªé€‚åº”æ‹“å±•ç±»ï¼Œå¹¶é€šè¿‡åå°„å®ä¾‹åŒ–\n        return injectExtension((T) getAdaptiveExtensionClass().newInstance());\n    &#125; catch (Exception e) &#123;\n        throw new IllegalStateException(\"Can not create adaptive extension ...\");\n    &#125;\n&#125;\n\ncreateAdaptiveExtension æ–¹æ³•çš„ä»£ç æ¯”è¾ƒå°‘ï¼Œä½†å´åŒ…å«äº†ä¸‰ä¸ªé€»è¾‘ï¼Œåˆ†åˆ«å¦‚ä¸‹ï¼š\n\nè°ƒç”¨ getAdaptiveExtensionClass æ–¹æ³•è·å–è‡ªé€‚åº”æ‹“å±• Class å¯¹è±¡\né€šè¿‡åå°„è¿›è¡Œå®ä¾‹åŒ–\nè°ƒç”¨ injectExtension æ–¹æ³•å‘æ‹“å±•å®ä¾‹ä¸­æ³¨å…¥ä¾èµ–\n\nå‰ä¸¤ä¸ªé€»è¾‘æ¯”è¾ƒå¥½ç†è§£ï¼Œç¬¬ä¸‰ä¸ªé€»è¾‘ç”¨äºå‘è‡ªé€‚åº”æ‹“å±•å¯¹è±¡ä¸­æ³¨å…¥ä¾èµ–ã€‚è¿™ä¸ªé€»è¾‘çœ‹ä¼¼å¤šä½™ï¼Œä½†æœ‰å­˜åœ¨çš„å¿…è¦ï¼Œè¿™é‡Œç®€å•è¯´æ˜ä¸€ä¸‹ã€‚å‰é¢è¯´è¿‡ï¼ŒDubbo ä¸­æœ‰ä¸¤ç§ç±»å‹çš„è‡ªé€‚åº”æ‹“å±•ï¼Œä¸€ç§æ˜¯æ‰‹å·¥ç¼–ç çš„ï¼Œä¸€ç§æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„ã€‚æ‰‹å·¥ç¼–ç çš„è‡ªé€‚åº”æ‹“å±•ä¸­å¯èƒ½å­˜åœ¨ç€ä¸€äº›ä¾èµ–ï¼Œè€Œè‡ªåŠ¨ç”Ÿæˆçš„ Adaptive æ‹“å±•åˆ™ä¸ä¼šä¾èµ–å…¶ä»–ç±»ã€‚è¿™é‡Œè°ƒç”¨ injectExtension æ–¹æ³•çš„ç›®çš„æ˜¯ä¸ºæ‰‹å·¥ç¼–ç çš„è‡ªé€‚åº”æ‹“å±•æ³¨å…¥ä¾èµ–ï¼Œè¿™ä¸€ç‚¹éœ€è¦å¤§å®¶æ³¨æ„ä¸€ä¸‹ã€‚å…³äº injectExtension æ–¹æ³•ï¼Œå‰æ–‡å·²ç»åˆ†æè¿‡äº†ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚æ¥ä¸‹æ¥ï¼Œåˆ†æ getAdaptiveExtensionClass æ–¹æ³•çš„é€»è¾‘ã€‚\nprivate Class&lt;?> getAdaptiveExtensionClass() &#123;\n    // é€šè¿‡ SPI è·å–æ‰€æœ‰çš„æ‹“å±•ç±»\n    getExtensionClasses();\n    // æ£€æŸ¥ç¼“å­˜ï¼Œè‹¥ç¼“å­˜ä¸ä¸ºç©ºï¼Œåˆ™ç›´æ¥è¿”å›ç¼“å­˜\n    if (cachedAdaptiveClass != null) &#123;\n        return cachedAdaptiveClass;\n    &#125;\n    // åˆ›å»ºè‡ªé€‚åº”æ‹“å±•ç±»\n    return cachedAdaptiveClass = createAdaptiveExtensionClass();\n&#125;\n\ngetAdaptiveExtensionClass æ–¹æ³•åŒæ ·åŒ…å«äº†ä¸‰ä¸ªé€»è¾‘ï¼Œå¦‚ä¸‹ï¼š\n\nè°ƒç”¨ getExtensionClasses è·å–æ‰€æœ‰çš„æ‹“å±•ç±»\næ£€æŸ¥ç¼“å­˜ï¼Œè‹¥ç¼“å­˜ä¸ä¸ºç©ºï¼Œåˆ™è¿”å›ç¼“å­˜\nè‹¥ç¼“å­˜ä¸ºç©ºï¼Œåˆ™è°ƒç”¨ createAdaptiveExtensionClass åˆ›å»ºè‡ªé€‚åº”æ‹“å±•ç±»\n\nè¿™ä¸‰ä¸ªé€»è¾‘çœ‹èµ·æ¥å¹³æ·¡æ— å¥‡ï¼Œä¼¼ä¹æ²¡æœ‰å¤šè®²çš„å¿…è¦ã€‚ä½†æ˜¯è¿™äº›å¹³æ·¡æ— å¥‡çš„ä»£ç ä¸­éšè—äº†ç€ä¸€äº›ç»†èŠ‚ï¼Œéœ€è¦è¯´æ˜ä¸€ä¸‹ã€‚é¦–å…ˆä»ç¬¬ä¸€ä¸ªé€»è¾‘è¯´èµ·ï¼ŒgetExtensionClasses è¿™ä¸ªæ–¹æ³•ç”¨äºè·å–æŸä¸ªæ¥å£çš„æ‰€æœ‰å®ç°ç±»ã€‚æ¯”å¦‚è¯¥æ–¹æ³•å¯ä»¥è·å– Protocol æ¥å£çš„ DubboProtocolã€HttpProtocolã€InjvmProtocol ç­‰å®ç°ç±»ã€‚åœ¨è·å–å®ç°ç±»çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœæŸä¸ªå®ç°ç±»è¢« Adaptive æ³¨è§£ä¿®é¥°äº†ï¼Œé‚£ä¹ˆè¯¥ç±»å°±ä¼šè¢«èµ‹å€¼ç»™ cachedAdaptiveClass å˜é‡ã€‚æ­¤æ—¶ï¼Œä¸Šé¢æ­¥éª¤ä¸­çš„ç¬¬äºŒæ­¥æ¡ä»¶æˆç«‹ï¼ˆç¼“å­˜ä¸ä¸ºç©ºï¼‰ï¼Œç›´æ¥è¿”å› cachedAdaptiveClass å³å¯ã€‚å¦‚æœæ‰€æœ‰çš„å®ç°ç±»å‡æœªè¢« Adaptive æ³¨è§£ä¿®é¥°ï¼Œé‚£ä¹ˆæ‰§è¡Œç¬¬ä¸‰æ­¥é€»è¾‘ï¼Œåˆ›å»ºè‡ªé€‚åº”æ‹“å±•ç±»ã€‚ç›¸å…³ä»£ç å¦‚ä¸‹ï¼š\nprivate Class&lt;?> createAdaptiveExtensionClass() &#123;\n    // æ„å»ºè‡ªé€‚åº”æ‹“å±•ä»£ç \n    String code = createAdaptiveExtensionClassCode();\n    ClassLoader classLoader = findClassLoader();\n    // è·å–ç¼–è¯‘å™¨å®ç°ç±»\n    com.alibaba.dubbo.common.compiler.Compiler compiler = ExtensionLoader.getExtensionLoader(com.alibaba.dubbo.common.compiler.Compiler.class).getAdaptiveExtension();\n    // ç¼–è¯‘ä»£ç ï¼Œç”Ÿæˆ Class\n    return compiler.compile(code, classLoader);\n&#125;\n\ncreateAdaptiveExtensionClass æ–¹æ³•ç”¨äºç”Ÿæˆè‡ªé€‚åº”æ‹“å±•ç±»ï¼Œè¯¥æ–¹æ³•é¦–å…ˆä¼šç”Ÿæˆè‡ªé€‚åº”æ‹“å±•ç±»çš„æºç ï¼Œç„¶åé€šè¿‡ Compiler å®ä¾‹ï¼ˆDubbo é»˜è®¤ä½¿ç”¨ javassist ä½œä¸ºç¼–è¯‘å™¨ï¼‰ç¼–è¯‘æºç ï¼Œå¾—åˆ°ä»£ç†ç±» Class å®ä¾‹ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æŠŠé‡ç‚¹æ”¾åœ¨ä»£ç†ç±»ä»£ç ç”Ÿæˆçš„é€»è¾‘ä¸Šï¼Œå…¶ä»–é€»è¾‘å¤§å®¶è‡ªè¡Œåˆ†æã€‚\n\n2.2 è‡ªé€‚åº”æ‹“å±•ç±»ä»£ç ç”ŸæˆcreateAdaptiveExtensionClassCode æ–¹æ³•ä»£ç ç•¥å¤šï¼Œçº¦æœ‰ä¸¤ç™¾è¡Œä»£ç ã€‚å› æ­¤æœ¬èŠ‚å°†ä¼šå¯¹è¯¥æ–¹æ³•çš„ä»£ç è¿›è¡Œæ‹†åˆ†åˆ†æï¼Œä»¥å¸®åŠ©å¤§å®¶æ›´å¥½çš„ç†è§£ä»£ç é€»è¾‘ã€‚\n\n2.2.1 Adaptive æ³¨è§£æ£€æµ‹åœ¨ç”Ÿæˆä»£ç†ç±»æºç ä¹‹å‰ï¼ŒcreateAdaptiveExtensionClassCode æ–¹æ³•é¦–å…ˆä¼šé€šè¿‡åå°„æ£€æµ‹æ¥å£æ–¹æ³•æ˜¯å¦åŒ…å« Adaptive æ³¨è§£ã€‚å¯¹äºè¦ç”Ÿæˆè‡ªé€‚åº”æ‹“å±•çš„æ¥å£ï¼ŒDubbo è¦æ±‚è¯¥æ¥å£è‡³å°‘æœ‰ä¸€ä¸ªæ–¹æ³•è¢« Adaptive æ³¨è§£ä¿®é¥°ã€‚è‹¥ä¸æ»¡è¶³æ­¤æ¡ä»¶ï¼Œå°±ä¼šæŠ›å‡ºè¿è¡Œæ—¶å¼‚å¸¸ã€‚ç›¸å…³ä»£ç å¦‚ä¸‹ï¼š\n// é€šè¿‡åå°„è·å–æ‰€æœ‰çš„æ–¹æ³•\nMethod[] methods = type.getMethods();\nboolean hasAdaptiveAnnotation = false;\n// éå†æ–¹æ³•åˆ—è¡¨\nfor (Method m : methods) &#123;\n    // æ£€æµ‹æ–¹æ³•ä¸Šæ˜¯å¦æœ‰ Adaptive æ³¨è§£\n    if (m.isAnnotationPresent(Adaptive.class)) &#123;\n        hasAdaptiveAnnotation = true;\n        break;\n    &#125;\n&#125;\n\nif (!hasAdaptiveAnnotation)\n    // è‹¥æ‰€æœ‰çš„æ–¹æ³•ä¸Šå‡æ—  Adaptive æ³¨è§£ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸\n    throw new IllegalStateException(\"No adaptive method on extension ...\");\n\n\n2.2.2 ç”Ÿæˆç±»é€šè¿‡ Adaptive æ³¨è§£æ£€æµ‹åï¼Œå³å¯å¼€å§‹ç”Ÿæˆä»£ç ã€‚ä»£ç ç”Ÿæˆçš„é¡ºåºä¸ Java æ–‡ä»¶å†…å®¹é¡ºåºä¸€è‡´ï¼Œé¦–å…ˆä¼šç”Ÿæˆ package è¯­å¥ï¼Œç„¶åç”Ÿæˆ import è¯­å¥ï¼Œç´§æ¥ç€ç”Ÿæˆç±»åç­‰ä»£ç ã€‚æ•´ä¸ªé€»è¾‘å¦‚ä¸‹ï¼š\n// ç”Ÿæˆ package ä»£ç ï¼špackage + type æ‰€åœ¨åŒ…\ncodeBuilder.append(\"package \").append(type.getPackage().getName()).append(\";\");\n// ç”Ÿæˆ import ä»£ç ï¼šimport + ExtensionLoader å…¨é™å®šå\ncodeBuilder.append(\"\\nimport \").append(ExtensionLoader.class.getName()).append(\";\");\n// ç”Ÿæˆç±»ä»£ç ï¼špublic class + typeç®€å•åç§° + $Adaptive + implements + typeå…¨é™å®šå + &#123;\ncodeBuilder.append(\"\\npublic class \")\n    .append(type.getSimpleName())\n    .append(\"$Adaptive\")\n    .append(\" implements \")\n    .append(type.getCanonicalName())\n    .append(\" &#123;\");\n\n// $&#123;ç”Ÿæˆæ–¹æ³•&#125;\n\ncodeBuilder.append(\"\\n&#125;\");\n\nè¿™é‡Œä½¿ç”¨ ${â€¦} å ä½ç¬¦ä»£è¡¨å…¶ä»–ä»£ç çš„ç”Ÿæˆé€»è¾‘ï¼Œè¯¥éƒ¨åˆ†é€»è¾‘å°†åœ¨éšåè¿›è¡Œåˆ†æã€‚ä¸Šé¢ä»£ç ä¸æ˜¯å¾ˆéš¾ç†è§£ï¼Œä¸‹é¢ç›´æ¥é€šè¿‡ä¸€ä¸ªä¾‹å­å±•ç¤ºè¯¥æ®µä»£ç æ‰€ç”Ÿæˆçš„å†…å®¹ã€‚ä»¥ Dubbo çš„ Protocol æ¥å£ä¸ºä¾‹ï¼Œç”Ÿæˆçš„ä»£ç å¦‚ä¸‹ï¼š\npackage com.alibaba.dubbo.rpc;\nimport com.alibaba.dubbo.common.extension.ExtensionLoader;\npublic class Protocol$Adaptive implements com.alibaba.dubbo.rpc.Protocol &#123;\n    // çœç•¥æ–¹æ³•ä»£ç \n&#125;\n\n\n2.2.3 ç”Ÿæˆæ–¹æ³•ä¸€ä¸ªæ–¹æ³•å¯ä»¥è¢« Adaptive æ³¨è§£ä¿®é¥°ï¼Œä¹Ÿå¯ä»¥ä¸è¢«ä¿®é¥°ã€‚è¿™é‡Œå°†æœªè¢« Adaptive æ³¨è§£ä¿®é¥°çš„æ–¹æ³•ç§°ä¸ºâ€œæ—  Adaptive æ³¨è§£æ–¹æ³•â€ï¼Œä¸‹é¢æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹æ­¤ç§æ–¹æ³•çš„ä»£ç ç”Ÿæˆé€»è¾‘æ˜¯æ€æ ·çš„ã€‚\n\n2.2.3.1 æ—  Adaptive æ³¨è§£æ–¹æ³•ä»£ç ç”Ÿæˆé€»è¾‘å¯¹äºæ¥å£æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‰ç…§éœ€æ±‚æ ‡æ³¨ Adaptive æ³¨è§£ã€‚ä»¥ Protocol æ¥å£ä¸ºä¾‹ï¼Œè¯¥æ¥å£çš„ destroy å’Œ getDefaultPort æœªæ ‡æ³¨ Adaptive æ³¨è§£ï¼Œå…¶ä»–æ–¹æ³•å‡æ ‡æ³¨äº† Adaptive æ³¨è§£ã€‚Dubbo ä¸ä¼šä¸ºæ²¡æœ‰æ ‡æ³¨ Adaptive æ³¨è§£çš„æ–¹æ³•ç”Ÿæˆä»£ç†é€»è¾‘ï¼Œå¯¹äºè¯¥ç§ç±»å‹çš„æ–¹æ³•ï¼Œä»…ä¼šç”Ÿæˆä¸€å¥æŠ›å‡ºå¼‚å¸¸çš„ä»£ç ã€‚ç”Ÿæˆé€»è¾‘å¦‚ä¸‹ï¼š\nfor (Method method : methods) &#123;\n    \n    // çœç•¥æ— å…³é€»è¾‘\n\n    Adaptive adaptiveAnnotation = method.getAnnotation(Adaptive.class);\n    StringBuilder code = new StringBuilder(512);\n    // å¦‚æœæ–¹æ³•ä¸Šæ—  Adaptive æ³¨è§£ï¼Œåˆ™ç”Ÿæˆ throw new UnsupportedOperationException(...) ä»£ç \n    if (adaptiveAnnotation == null) &#123;\n        // ç”Ÿæˆçš„ä»£ç æ ¼å¼å¦‚ä¸‹ï¼š\n        // throw new UnsupportedOperationException(\n        //     \"method \" + æ–¹æ³•ç­¾å + of interface + å…¨é™å®šæ¥å£å + is not adaptive method!â€)\n        code.append(\"throw new UnsupportedOperationException(\\\"method \")\n            .append(method.toString()).append(\" of interface \")\n            .append(type.getName()).append(\" is not adaptive method!\\\");\");\n    &#125; else &#123;\n        // çœç•¥æ— å…³é€»è¾‘\n    &#125;\n    \n    // çœç•¥æ— å…³é€»è¾‘\n&#125;\n\nä»¥ Protocol æ¥å£çš„ destroy æ–¹æ³•ä¸ºä¾‹ï¼Œä¸Šé¢ä»£ç ç”Ÿæˆçš„å†…å®¹å¦‚ä¸‹ï¼š\nthrow new UnsupportedOperationException(\n            \"method public abstract void com.alibaba.dubbo.rpc.Protocol.destroy() of interface com.alibaba.dubbo.rpc.Protocol is not adaptive method!\");\n\n\n2.2.3.2 è·å– URL æ•°æ®å‰é¢è¯´è¿‡æ–¹æ³•ä»£ç†é€»è¾‘ä¼šä» URL ä¸­æå–ç›®æ ‡æ‹“å±•çš„åç§°ï¼Œå› æ­¤ä»£ç ç”Ÿæˆé€»è¾‘çš„ä¸€ä¸ªé‡è¦çš„ä»»åŠ¡æ˜¯ä»æ–¹æ³•çš„å‚æ•°åˆ—è¡¨æˆ–è€…å…¶ä»–å‚æ•°ä¸­è·å– URL æ•°æ®ã€‚ä¸¾ä¾‹è¯´æ˜ä¸€ä¸‹ï¼Œæˆ‘ä»¬è¦ä¸º Protocol æ¥å£çš„ refer å’Œ export æ–¹æ³•ç”Ÿæˆä»£ç†é€»è¾‘ã€‚åœ¨è¿è¡Œæ—¶ï¼Œé€šè¿‡åå°„å¾—åˆ°çš„æ–¹æ³•å®šä¹‰å¤§è‡´å¦‚ä¸‹ï¼š\nInvoker refer(Class&lt;T> arg0, URL arg1) throws RpcException;\nExporter export(Invoker&lt;T> arg0) throws RpcException;\n\nå¯¹äº refer æ–¹æ³•ï¼Œé€šè¿‡éå† refer çš„å‚æ•°åˆ—è¡¨å³å¯è·å– URL æ•°æ®ï¼Œè¿™ä¸ªè¿˜æ¯”è¾ƒç®€å•ã€‚å¯¹äº export æ–¹æ³•ï¼Œè·å– URL æ•°æ®åˆ™è¦éº»çƒ¦ä¸€äº›ã€‚export å‚æ•°åˆ—è¡¨ä¸­æ²¡æœ‰ URL å‚æ•°ï¼Œå› æ­¤éœ€è¦ä» Invoker å‚æ•°ä¸­è·å– URL æ•°æ®ã€‚è·å–æ–¹å¼æ˜¯è°ƒç”¨ Invoker ä¸­å¯è¿”å› URL çš„ getter æ–¹æ³•ï¼Œæ¯”å¦‚ getUrlã€‚å¦‚æœ Invoker ä¸­æ— ç›¸å…³ getter æ–¹æ³•ï¼Œæ­¤æ—¶åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚æ•´ä¸ªé€»è¾‘å¦‚ä¸‹ï¼š\nfor (Method method : methods) &#123;\n    Class&lt;?> rt = method.getReturnType();\n    Class&lt;?>[] pts = method.getParameterTypes();\n    Class&lt;?>[] ets = method.getExceptionTypes();\n\n    Adaptive adaptiveAnnotation = method.getAnnotation(Adaptive.class);\n    StringBuilder code = new StringBuilder(512);\n    if (adaptiveAnnotation == null) &#123;\n        // $&#123;æ—  Adaptive æ³¨è§£æ–¹æ³•ä»£ç ç”Ÿæˆé€»è¾‘&#125;\n    &#125; else &#123;\n    \tint urlTypeIndex = -1;\n        // éå†å‚æ•°åˆ—è¡¨ï¼Œç¡®å®š URL å‚æ•°ä½ç½®\n        for (int i = 0; i &lt; pts.length; ++i) &#123;\n            if (pts[i].equals(URL.class)) &#123;\n                urlTypeIndex = i;\n                break;\n            &#125;\n        &#125;\n        \n        // urlTypeIndex != -1ï¼Œè¡¨ç¤ºå‚æ•°åˆ—è¡¨ä¸­å­˜åœ¨ URL å‚æ•°\n        if (urlTypeIndex != -1) &#123;\n            // ä¸º URL ç±»å‹å‚æ•°ç”Ÿæˆåˆ¤ç©ºä»£ç ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š\n            // if (arg + urlTypeIndex == null) \n            //     throw new IllegalArgumentException(\"url == null\");\n            String s = String.format(\"\\nif (arg%d == null) throw new IllegalArgumentException(\\\"url == null\\\");\",\n                                     urlTypeIndex);\n            code.append(s);\n\n            // ä¸º URL ç±»å‹å‚æ•°ç”Ÿæˆèµ‹å€¼ä»£ç ï¼Œå½¢å¦‚ URL url = arg1\n            s = String.format(\"\\n%s url = arg%d;\", URL.class.getName(), urlTypeIndex);\n            code.append(s);\n            \n        // å‚æ•°åˆ—è¡¨ä¸­ä¸å­˜åœ¨ URL ç±»å‹å‚æ•°\n        &#125; else &#123;\n            String attribMethod = null;\n\n            LBL_PTS:\n            // éå†æ–¹æ³•çš„å‚æ•°ç±»å‹åˆ—è¡¨\n            for (int i = 0; i &lt; pts.length; ++i) &#123;\n                // è·å–æŸä¸€ç±»å‹å‚æ•°çš„å…¨éƒ¨æ–¹æ³•\n                Method[] ms = pts[i].getMethods();\n                // éå†æ–¹æ³•åˆ—è¡¨ï¼Œå¯»æ‰¾å¯è¿”å› URL çš„ getter æ–¹æ³•\n                for (Method m : ms) &#123;\n                    String name = m.getName();\n                    // 1. æ–¹æ³•åä»¥ get å¼€å¤´ï¼Œæˆ–æ–¹æ³•åå¤§äº3ä¸ªå­—ç¬¦\n                    // 2. æ–¹æ³•çš„è®¿é—®æƒé™ä¸º public\n                    // 3. éé™æ€æ–¹æ³•\n                    // 4. æ–¹æ³•å‚æ•°æ•°é‡ä¸º0\n                    // 5. æ–¹æ³•è¿”å›å€¼ç±»å‹ä¸º URL\n                    if ((name.startsWith(\"get\") || name.length() > 3)\n                        &amp;&amp; Modifier.isPublic(m.getModifiers())\n                        &amp;&amp; !Modifier.isStatic(m.getModifiers())\n                        &amp;&amp; m.getParameterTypes().length == 0\n                        &amp;&amp; m.getReturnType() == URL.class) &#123;\n                        urlTypeIndex = i;\n                        attribMethod = name;\n                        \n                        // ç»“æŸ for (int i = 0; i &lt; pts.length; ++i) å¾ªç¯\n                        break LBL_PTS;\n                    &#125;\n                &#125;\n            &#125;\n            if (attribMethod == null) &#123;\n                // å¦‚æœæ‰€æœ‰å‚æ•°ä¸­å‡ä¸åŒ…å«å¯è¿”å› URL çš„ getter æ–¹æ³•ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸\n                throw new IllegalStateException(\"fail to create adaptive class for interface ...\");\n            &#125;\n\n            // ä¸ºå¯è¿”å› URL çš„å‚æ•°ç”Ÿæˆåˆ¤ç©ºä»£ç ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š\n            // if (arg + urlTypeIndex == null) \n            //     throw new IllegalArgumentException(\"å‚æ•°å…¨é™å®šå + argument == null\");\n            String s = String.format(\"\\nif (arg%d == null) throw new IllegalArgumentException(\\\"%s argument == null\\\");\",\n                                     urlTypeIndex, pts[urlTypeIndex].getName());\n            code.append(s);\n\n            // ä¸º getter æ–¹æ³•è¿”å›çš„ URL ç”Ÿæˆåˆ¤ç©ºä»£ç ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š\n            // if (argN.getteræ–¹æ³•å() == null) \n            //     throw new IllegalArgumentException(å‚æ•°å…¨é™å®šå + argument getUrl() == null);\n            s = String.format(\"\\nif (arg%d.%s() == null) throw new IllegalArgumentException(\\\"%s argument %s() == null\\\");\",\n                              urlTypeIndex, attribMethod, pts[urlTypeIndex].getName(), attribMethod);\n            code.append(s);\n\n            // ç”Ÿæˆèµ‹å€¼è¯­å¥ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š\n            // URLå…¨é™å®šå url = argN.getteræ–¹æ³•å()ï¼Œæ¯”å¦‚ \n            // com.alibaba.dubbo.common.URL url = invoker.getUrl();\n            s = String.format(\"%s url = arg%d.%s();\", URL.class.getName(), urlTypeIndex, attribMethod);\n            code.append(s);\n        &#125;\n        \n        // çœç•¥æ— å…³ä»£ç \n    &#125;\n    \n    // çœç•¥æ— å…³ä»£ç \n&#125;\n\nä¸Šé¢ä»£ç æœ‰ç‚¹å¤šï¼Œéœ€è¦è€å¿ƒçœ‹ä¸€ä¸‹ã€‚è¿™æ®µä»£ç ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†è·å– URL æ•°æ®ï¼Œå¹¶ä¸ºä¹‹ç”Ÿæˆåˆ¤ç©ºå’Œèµ‹å€¼ä»£ç ã€‚ä»¥ Protocol çš„ refer å’Œ export æ–¹æ³•ä¸ºä¾‹ï¼Œä¸Šé¢çš„ä»£ç ä¸ºå®ƒä»¬ç”Ÿæˆå¦‚ä¸‹å†…å®¹ï¼ˆä»£ç å·²æ ¼å¼åŒ–ï¼‰ï¼š\nrefer:\nif (arg1 == null) \n    throw new IllegalArgumentException(\"url == null\");\ncom.alibaba.dubbo.common.URL url = arg1;\n\nexport:\nif (arg0 == null) \n    throw new IllegalArgumentException(\"com.alibaba.dubbo.rpc.Invoker argument == null\");\nif (arg0.getUrl() == null) \n    throw new IllegalArgumentException(\"com.alibaba.dubbo.rpc.Invoker argument getUrl() == null\");\ncom.alibaba.dubbo.common.URL url = arg0.getUrl();\n\n\n\n2.2.3.3 è·å– Adaptive æ³¨è§£å€¼Adaptive æ³¨è§£å€¼ value ç±»å‹ä¸º String[]ï¼Œå¯å¡«å†™å¤šä¸ªå€¼ï¼Œé»˜è®¤æƒ…å†µä¸‹ä¸ºç©ºæ•°ç»„ã€‚è‹¥ value ä¸ºéç©ºæ•°ç»„ï¼Œç›´æ¥è·å–æ•°ç»„å†…å®¹å³å¯ã€‚è‹¥ value ä¸ºç©ºæ•°ç»„ï¼Œåˆ™éœ€è¿›è¡Œé¢å¤–å¤„ç†ã€‚å¤„ç†è¿‡ç¨‹æ˜¯å°†ç±»åè½¬æ¢ä¸ºå­—ç¬¦æ•°ç»„ï¼Œç„¶åéå†å­—ç¬¦æ•°ç»„ï¼Œå¹¶å°†å­—ç¬¦æ”¾å…¥ StringBuilder ä¸­ã€‚è‹¥å­—ç¬¦ä¸ºå¤§å†™å­—æ¯ï¼Œåˆ™å‘ StringBuilder ä¸­æ·»åŠ ç‚¹å·ï¼Œéšåå°†å­—ç¬¦å˜ä¸ºå°å†™å­˜å…¥ StringBuilder ä¸­ã€‚æ¯”å¦‚ LoadBalance ç»è¿‡å¤„ç†åï¼Œå¾—åˆ° load.balanceã€‚\nfor (Method method : methods) &#123;\n    Class&lt;?> rt = method.getReturnType();\n    Class&lt;?>[] pts = method.getParameterTypes();\n    Class&lt;?>[] ets = method.getExceptionTypes();\n\n    Adaptive adaptiveAnnotation = method.getAnnotation(Adaptive.class);\n    StringBuilder code = new StringBuilder(512);\n    if (adaptiveAnnotation == null) &#123;\n        // $&#123;æ—  Adaptive æ³¨è§£æ–¹æ³•ä»£ç ç”Ÿæˆé€»è¾‘&#125;\n    &#125; else &#123;\n        // $&#123;è·å– URL æ•°æ®&#125;\n        \n        String[] value = adaptiveAnnotation.value();\n        // value ä¸ºç©ºæ•°ç»„\n        if (value.length == 0) &#123;\n            // è·å–ç±»åï¼Œå¹¶å°†ç±»åè½¬æ¢ä¸ºå­—ç¬¦æ•°ç»„\n            char[] charArray = type.getSimpleName().toCharArray();\n            StringBuilder sb = new StringBuilder(128);\n            // éå†å­—èŠ‚æ•°ç»„\n            for (int i = 0; i &lt; charArray.length; i++) &#123;\n                // æ£€æµ‹å½“å‰å­—ç¬¦æ˜¯å¦ä¸ºå¤§å†™å­—æ¯\n                if (Character.isUpperCase(charArray[i])) &#123;\n                    if (i != 0) &#123;\n                        // å‘ sb ä¸­æ·»åŠ ç‚¹å·\n                        sb.append(\".\");\n                    &#125;\n                    // å°†å­—ç¬¦å˜ä¸ºå°å†™ï¼Œå¹¶æ·»åŠ åˆ° sb ä¸­\n                    sb.append(Character.toLowerCase(charArray[i]));\n                &#125; else &#123;\n                    // æ·»åŠ å­—ç¬¦åˆ° sb ä¸­\n                    sb.append(charArray[i]);\n                &#125;\n            &#125;\n            value = new String[]&#123;sb.toString()&#125;;\n        &#125;\n        \n        // çœç•¥æ— å…³ä»£ç \n    &#125;\n    \n    // çœç•¥æ— å…³é€»è¾‘\n&#125;\n\n\n\n2.2.3.4 æ£€æµ‹ Invocation å‚æ•°æ­¤æ®µé€»è¾‘æ˜¯æ£€æµ‹æ–¹æ³•åˆ—è¡¨ä¸­æ˜¯å¦å­˜åœ¨ Invocation ç±»å‹çš„å‚æ•°ï¼Œè‹¥å­˜åœ¨ï¼Œåˆ™ä¸ºå…¶ç”Ÿæˆåˆ¤ç©ºä»£ç å’Œå…¶ä»–ä¸€äº›ä»£ç ã€‚ç›¸åº”çš„é€»è¾‘å¦‚ä¸‹ï¼š\nfor (Method method : methods) &#123;\n    Class&lt;?> rt = method.getReturnType();\n    Class&lt;?>[] pts = method.getParameterTypes();    // è·å–å‚æ•°ç±»å‹åˆ—è¡¨\n    Class&lt;?>[] ets = method.getExceptionTypes();\n\n    Adaptive adaptiveAnnotation = method.getAnnotation(Adaptive.class);\n    StringBuilder code = new StringBuilder(512);\n    if (adaptiveAnnotation == null) &#123;\n        // $&#123;æ—  Adaptive æ³¨è§£æ–¹æ³•ä»£ç ç”Ÿæˆé€»è¾‘&#125;\n    &#125; else &#123;\n        // $&#123;è·å– URL æ•°æ®&#125;\n        \n        // $&#123;è·å– Adaptive æ³¨è§£å€¼&#125;\n        \n        boolean hasInvocation = false;\n        // éå†å‚æ•°ç±»å‹åˆ—è¡¨\n        for (int i = 0; i &lt; pts.length; ++i) &#123;\n            // åˆ¤æ–­å½“å‰å‚æ•°åç§°æ˜¯å¦ç­‰äº com.alibaba.dubbo.rpc.Invocation\n            if (pts[i].getName().equals(\"com.alibaba.dubbo.rpc.Invocation\")) &#123;\n                // ä¸º Invocation ç±»å‹å‚æ•°ç”Ÿæˆåˆ¤ç©ºä»£ç \n                String s = String.format(\"\\nif (arg%d == null) throw new IllegalArgumentException(\\\"invocation == null\\\");\", i);\n                code.append(s);\n                // ç”Ÿæˆ getMethodName æ–¹æ³•è°ƒç”¨ä»£ç ï¼Œæ ¼å¼ä¸ºï¼š\n                //    String methodName = argN.getMethodName();\n                s = String.format(\"\\nString methodName = arg%d.getMethodName();\", i);\n                code.append(s);\n                \n                // è®¾ç½® hasInvocation ä¸º true\n                hasInvocation = true;\n                break;\n            &#125;\n        &#125;\n    &#125;\n    \n    // çœç•¥æ— å…³é€»è¾‘\n&#125;\n\n\n\n2.2.3.5 ç”Ÿæˆæ‹“å±•åè·å–é€»è¾‘æœ¬æ®µé€»è¾‘ç”¨äºæ ¹æ® SPI å’Œ Adaptive æ³¨è§£å€¼ç”Ÿæˆâ€œè·å–æ‹“å±•åé€»è¾‘â€ï¼ŒåŒæ—¶ç”Ÿæˆé€»è¾‘ä¹Ÿå— Invocation ç±»å‹å‚æ•°å½±å“ï¼Œç»¼åˆå› ç´ å¯¼è‡´æœ¬æ®µé€»è¾‘ç›¸å¯¹å¤æ‚ã€‚æœ¬æ®µé€»è¾‘å¯èƒ½ä¼šç”Ÿæˆä½†ä¸é™äºä¸‹é¢çš„ä»£ç ï¼š\nString extName = (url.getProtocol() == null ? \"dubbo\" : url.getProtocol());\n\n\næˆ–\nString extName = url.getMethodParameter(methodName, \"loadbalance\", \"random\");\n\n\näº¦æˆ–æ˜¯\nString extName = url.getParameter(\"client\", url.getParameter(\"transporter\", \"netty\"));\n\n\næœ¬æ®µé€»è¾‘å¤æ‚ä¹‹å¤„åœ¨äºæ¡ä»¶åˆ†æ”¯æ¯”è¾ƒå¤šï¼Œå¤§å®¶åœ¨é˜…è¯»æºç æ—¶éœ€è¦çŸ¥é“æ¯ä¸ªæ¡ä»¶åˆ†æ”¯çš„æ„ä¹‰æ˜¯ä»€ä¹ˆï¼Œå¦åˆ™ä¸å¤ªå®¹æ˜“çœ‹æ‡‚ç›¸å…³ä»£ç ã€‚ä¸‹é¢å¼€å§‹åˆ†ææœ¬æ®µé€»è¾‘ã€‚\nfor (Method method : methods) &#123;\n    Class&lt;?> rt = method.getReturnType();\n    Class&lt;?>[] pts = method.getParameterTypes();\n    Class&lt;?>[] ets = method.getExceptionTypes();\n\n    Adaptive adaptiveAnnotation = method.getAnnotation(Adaptive.class);\n    StringBuilder code = new StringBuilder(512);\n    if (adaptiveAnnotation == null) &#123;\n        // $æ—  Adaptive æ³¨è§£æ–¹æ³•ä»£ç ç”Ÿæˆé€»è¾‘&#125;\n    &#125; else &#123;\n        // $&#123;è·å– URL æ•°æ®&#125;\n        \n        // $&#123;è·å– Adaptive æ³¨è§£å€¼&#125;\n        \n        // $&#123;æ£€æµ‹ Invocation å‚æ•°&#125;\n        \n        // è®¾ç½®é»˜è®¤æ‹“å±•åï¼ŒcachedDefaultName æºäº SPI æ³¨è§£å€¼ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œ\n        // SPI æ³¨è§£å€¼ä¸ºç©ºä¸²ï¼Œæ­¤æ—¶ cachedDefaultName = null\n        String defaultExtName = cachedDefaultName;\n        String getNameCode = null;\n        \n        // éå† valueï¼Œè¿™é‡Œçš„ value æ˜¯ Adaptive çš„æ³¨è§£å€¼ï¼Œ2.2.3.3 èŠ‚åˆ†æè¿‡ value å˜é‡çš„è·å–è¿‡ç¨‹ã€‚\n        // æ­¤å¤„å¾ªç¯ç›®çš„æ˜¯ç”Ÿæˆä» URL ä¸­è·å–æ‹“å±•åçš„ä»£ç ï¼Œç”Ÿæˆçš„ä»£ç ä¼šèµ‹å€¼ç»™ getNameCode å˜é‡ã€‚æ³¨æ„è¿™\n        // ä¸ªå¾ªç¯çš„éå†é¡ºåºæ˜¯ç”±åå‘å‰éå†çš„ã€‚\n        for (int i = value.length - 1; i >= 0; --i) &#123;\n            // å½“ i ä¸ºæœ€åä¸€ä¸ªå…ƒç´ çš„åæ ‡æ—¶\n            if (i == value.length - 1) &#123;\n                // é»˜è®¤æ‹“å±•åéç©º\n                if (null != defaultExtName) &#123;\n                    // protocol æ˜¯ url çš„ä¸€éƒ¨åˆ†ï¼Œå¯é€šè¿‡ getProtocol æ–¹æ³•è·å–ï¼Œå…¶ä»–çš„åˆ™æ˜¯ä»\n                    // URL å‚æ•°ä¸­è·å–ã€‚å› ä¸ºè·å–æ–¹å¼ä¸åŒï¼Œæ‰€ä»¥è¿™é‡Œè¦åˆ¤æ–­ value[i] æ˜¯å¦ä¸º protocol\n                    if (!\"protocol\".equals(value[i]))\n                    \t// hasInvocation ç”¨äºæ ‡è¯†æ–¹æ³•å‚æ•°åˆ—è¡¨ä¸­æ˜¯å¦æœ‰ Invocation ç±»å‹å‚æ•°\n                        if (hasInvocation)\n                            // ç”Ÿæˆçš„ä»£ç åŠŸèƒ½ç­‰ä»·äºä¸‹é¢çš„ä»£ç ï¼š\n                            //   url.getMethodParameter(methodName, value[i], defaultExtName)\n                            // ä»¥ LoadBalance æ¥å£çš„ select æ–¹æ³•ä¸ºä¾‹ï¼Œæœ€ç»ˆç”Ÿæˆçš„ä»£ç å¦‚ä¸‹ï¼š\n                            //   url.getMethodParameter(methodName, \"loadbalance\", \"random\")\n                            getNameCode = String.format(\"url.getMethodParameter(methodName, \\\"%s\\\", \\\"%s\\\")\", value[i], defaultExtName);\n                    \telse\n                    \t\t// ç”Ÿæˆçš„ä»£ç åŠŸèƒ½ç­‰ä»·äºä¸‹é¢çš„ä»£ç ï¼š\n\t                        //   url.getParameter(value[i], defaultExtName)\n\t                        getNameCode = String.format(\"url.getParameter(\\\"%s\\\", \\\"%s\\\")\", value[i], defaultExtName);\n                    else\n                    \t// ç”Ÿæˆçš„ä»£ç åŠŸèƒ½ç­‰ä»·äºä¸‹é¢çš„ä»£ç ï¼š\n                        //   ( url.getProtocol() == null ? defaultExtName : url.getProtocol() )\n                        getNameCode = String.format(\"( url.getProtocol() == null ? \\\"%s\\\" : url.getProtocol() )\", defaultExtName);\n                    \n                // é»˜è®¤æ‹“å±•åä¸ºç©º\n                &#125; else &#123;\n                    if (!\"protocol\".equals(value[i]))\n                        if (hasInvocation)\n                        \t// ç”Ÿæˆä»£ç æ ¼å¼åŒä¸Š\n                            getNameCode = String.format(\"url.getMethodParameter(methodName, \\\"%s\\\", \\\"%s\\\")\", value[i], defaultExtName);\n\t                    else\n\t                    \t// ç”Ÿæˆçš„ä»£ç åŠŸèƒ½ç­‰ä»·äºä¸‹é¢çš„ä»£ç ï¼š\n\t                        //   url.getParameter(value[i])\n\t                        getNameCode = String.format(\"url.getParameter(\\\"%s\\\")\", value[i]);\n                    else\n                    \t// ç”Ÿæˆä» url ä¸­è·å–åè®®çš„ä»£ç ï¼Œæ¯”å¦‚ \"dubbo\"\n                        getNameCode = \"url.getProtocol()\";\n                &#125;\n            &#125; else &#123;\n                if (!\"protocol\".equals(value[i]))\n                    if (hasInvocation)\n                        // ç”Ÿæˆä»£ç æ ¼å¼åŒä¸Š\n                        getNameCode = String.format(\"url.getMethodParameter(methodName, \\\"%s\\\", \\\"%s\\\")\", value[i], defaultExtName);\n\t                else\n\t                \t// ç”Ÿæˆçš„ä»£ç åŠŸèƒ½ç­‰ä»·äºä¸‹é¢çš„ä»£ç ï¼š\n\t                    //   url.getParameter(value[i], getNameCode)\n\t                    // ä»¥ Transporter æ¥å£çš„ connect æ–¹æ³•ä¸ºä¾‹ï¼Œæœ€ç»ˆç”Ÿæˆçš„ä»£ç å¦‚ä¸‹ï¼š\n\t                    //   url.getParameter(\"client\", url.getParameter(\"transporter\", \"netty\"))\n\t                    getNameCode = String.format(\"url.getParameter(\\\"%s\\\", %s)\", value[i], getNameCode);\n                else\n                    // ç”Ÿæˆçš„ä»£ç åŠŸèƒ½ç­‰ä»·äºä¸‹é¢çš„ä»£ç ï¼š\n                    //   url.getProtocol() == null ? getNameCode : url.getProtocol()\n                    // ä»¥ Protocol æ¥å£çš„ connect æ–¹æ³•ä¸ºä¾‹ï¼Œæœ€ç»ˆç”Ÿæˆçš„ä»£ç å¦‚ä¸‹ï¼š\n                    //   url.getProtocol() == null ? \"dubbo\" : url.getProtocol()\n                    getNameCode = String.format(\"url.getProtocol() == null ? (%s) : url.getProtocol()\", getNameCode);\n            &#125;\n        &#125;\n        // ç”Ÿæˆ extName èµ‹å€¼ä»£ç \n        code.append(\"\\nString extName = \").append(getNameCode).append(\";\");\n        // ç”Ÿæˆ extName åˆ¤ç©ºä»£ç \n        String s = String.format(\"\\nif(extName == null) \" +\n                                 \"throw new IllegalStateException(\\\"Fail to get extension(%s) name from url(\\\" + url.toString() + \\\") use keys(%s)\\\");\",\n                                 type.getName(), Arrays.toString(value));\n        code.append(s);\n    &#125;\n    \n    // çœç•¥æ— å…³é€»è¾‘\n&#125;\n\n\nä¸Šé¢ä»£ç æ¯”è¾ƒå¤æ‚ï¼Œä¸æ˜¯å¾ˆå¥½ç†è§£ã€‚å¯¹äºè¿™æ®µä»£ç ï¼Œå»ºè®®å¤§å®¶å†™ç‚¹æµ‹è¯•ç”¨ä¾‹ï¼Œå¯¹ Protocolã€LoadBalance ä»¥åŠ Transporter ç­‰æ¥å£çš„è‡ªé€‚åº”æ‹“å±•ç±»ä»£ç ç”Ÿæˆè¿‡ç¨‹è¿›è¡Œè°ƒè¯•ã€‚è¿™é‡Œæˆ‘ä»¥ Transporter æ¥å£çš„è‡ªé€‚åº”æ‹“å±•ç±»ä»£ç ç”Ÿæˆè¿‡ç¨‹ä¸¾ä¾‹è¯´æ˜ã€‚é¦–å…ˆçœ‹ä¸€ä¸‹ Transporter æ¥å£çš„å®šä¹‰ï¼Œå¦‚ä¸‹ï¼š\n@SPI(\"netty\")\npublic interface Transporter &#123;\n\t// @Adaptive(&#123;server, transporter&#125;)\n    @Adaptive(&#123;Constants.SERVER_KEY, Constants.TRANSPORTER_KEY&#125;) \n    Server bind(URL url, ChannelHandler handler) throws RemotingException;\n\n    // @Adaptive(&#123;client, transporter&#125;)\n    @Adaptive(&#123;Constants.CLIENT_KEY, Constants.TRANSPORTER_KEY&#125;)\n    Client connect(URL url, ChannelHandler handler) throws RemotingException;\n&#125;\n\n\nä¸‹é¢å¯¹ connect æ–¹æ³•ä»£ç†é€»è¾‘ç”Ÿæˆçš„è¿‡ç¨‹è¿›è¡Œåˆ†æï¼Œæ­¤æ—¶ç”Ÿæˆä»£ç†é€»è¾‘æ‰€ç”¨åˆ°çš„å˜é‡å¦‚ä¸‹ï¼š\nString defaultExtName = \"netty\";\nboolean hasInvocation = false;\nString getNameCode = null;\nString[] value = [\"client\", \"transporter\"];\n\n\nä¸‹é¢å¯¹ value æ•°ç»„è¿›è¡Œéå†ï¼Œæ­¤æ—¶ i &#x3D; 1, value[i] &#x3D; â€œtransporterâ€ï¼Œç”Ÿæˆçš„ä»£ç å¦‚ä¸‹ï¼š\ngetNameCode = url.getParameter(\"transporter\", \"netty\");\n\n\næ¥ä¸‹æ¥ï¼Œfor å¾ªç¯ç»§ç»­æ‰§è¡Œï¼Œæ­¤æ—¶ i &#x3D; 0, value[i] &#x3D; â€œclientâ€ï¼Œç”Ÿæˆçš„ä»£ç å¦‚ä¸‹ï¼š\ngetNameCode = url.getParameter(\"client\", url.getParameter(\"transporter\", \"netty\"));\n\n\nfor å¾ªç¯ç»“æŸè¿è¡Œï¼Œç°åœ¨ä¸º extName å˜é‡ç”Ÿæˆèµ‹å€¼å’Œåˆ¤ç©ºä»£ç ï¼Œå¦‚ä¸‹ï¼š\nString extName = url.getParameter(\"client\", url.getParameter(\"transporter\", \"netty\"));\nif (extName == null) &#123;\n    throw new IllegalStateException(\n        \"Fail to get extension(com.alibaba.dubbo.remoting.Transporter) name from url(\" + url.toString()\n        + \") use keys([client, transporter])\");\n&#125;\n\n\n\n2.2.3.6 ç”Ÿæˆæ‹“å±•åŠ è½½ä¸ç›®æ ‡æ–¹æ³•è°ƒç”¨é€»è¾‘æœ¬æ®µä»£ç é€»è¾‘ç”¨äºæ ¹æ®æ‹“å±•ååŠ è½½æ‹“å±•å®ä¾‹ï¼Œå¹¶è°ƒç”¨æ‹“å±•å®ä¾‹çš„ç›®æ ‡æ–¹æ³•ã€‚ç›¸å…³é€»è¾‘å¦‚ä¸‹ï¼š\nfor (Method method : methods) &#123;\n    Class&lt;?> rt = method.getReturnType();\n    Class&lt;?>[] pts = method.getParameterTypes();\n    Class&lt;?>[] ets = method.getExceptionTypes();\n\n    Adaptive adaptiveAnnotation = method.getAnnotation(Adaptive.class);\n    StringBuilder code = new StringBuilder(512);\n    if (adaptiveAnnotation == null) &#123;\n        // $æ—  Adaptive æ³¨è§£æ–¹æ³•ä»£ç ç”Ÿæˆé€»è¾‘&#125;\n    &#125; else &#123;\n        // $&#123;è·å– URL æ•°æ®&#125;\n        \n        // $&#123;è·å– Adaptive æ³¨è§£å€¼&#125;\n        \n        // $&#123;æ£€æµ‹ Invocation å‚æ•°&#125;\n        \n        // $&#123;ç”Ÿæˆæ‹“å±•åè·å–é€»è¾‘&#125;\n        \n        // ç”Ÿæˆæ‹“å±•è·å–ä»£ç ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š\n        // typeå…¨é™å®šå extension = (typeå…¨é™å®šå)ExtensionLoaderå…¨é™å®šå\n        //     .getExtensionLoader(typeå…¨é™å®šå.class).getExtension(extName);\n        // Tips: æ ¼å¼åŒ–å­—ç¬¦ä¸²ä¸­çš„ %&lt;s è¡¨ç¤ºä½¿ç”¨å‰ä¸€ä¸ªè½¬æ¢ç¬¦æ‰€æè¿°çš„å‚æ•°ï¼Œå³ type å…¨é™å®šå\n        s = String.format(\"\\n%s extension = (%&lt;s)%s.getExtensionLoader(%s.class).getExtension(extName);\",\n                        type.getName(), ExtensionLoader.class.getSimpleName(), type.getName());\n        code.append(s);\n\n\t\t// å¦‚æœæ–¹æ³•è¿”å›å€¼ç±»å‹é voidï¼Œåˆ™ç”Ÿæˆ return è¯­å¥ã€‚\n        if (!rt.equals(void.class)) &#123;\n            code.append(\"\\nreturn \");\n        &#125;\n\n        // ç”Ÿæˆç›®æ ‡æ–¹æ³•è°ƒç”¨é€»è¾‘ï¼Œæ ¼å¼ä¸ºï¼š\n        //     extension.æ–¹æ³•å(arg0, arg2, ..., argN);\n        s = String.format(\"extension.%s(\", method.getName());\n        code.append(s);\n        for (int i = 0; i &lt; pts.length; i++) &#123;\n            if (i != 0)\n                code.append(\", \");\n            code.append(\"arg\").append(i);\n        &#125;\n        code.append(\");\");   \n    &#125;\n    \n    // çœç•¥æ— å…³é€»è¾‘\n&#125;\n\n\nä»¥ Protocol æ¥å£ä¸¾ä¾‹è¯´æ˜ï¼Œä¸Šé¢ä»£ç ç”Ÿæˆçš„å†…å®¹å¦‚ä¸‹ï¼š\ncom.alibaba.dubbo.rpc.Protocol extension = (com.alibaba.dubbo.rpc.Protocol) ExtensionLoader\n    .getExtensionLoader(com.alibaba.dubbo.rpc.Protocol.class).getExtension(extName);\nreturn extension.refer(arg0, arg1);\n\n\n\n2.2.3.7 ç”Ÿæˆå®Œæ•´çš„æ–¹æ³•æœ¬èŠ‚è¿›è¡Œä»£ç ç”Ÿæˆçš„æ”¶å°¾å·¥ä½œï¼Œä¸»è¦ç”¨äºç”Ÿæˆæ–¹æ³•å®šä¹‰çš„ä»£ç ã€‚ç›¸å…³é€»è¾‘å¦‚ä¸‹ï¼š\nfor (Method method : methods) &#123;\n    Class&lt;?> rt = method.getReturnType();\n    Class&lt;?>[] pts = method.getParameterTypes();\n    Class&lt;?>[] ets = method.getExceptionTypes();\n\n    Adaptive adaptiveAnnotation = method.getAnnotation(Adaptive.class);\n    StringBuilder code = new StringBuilder(512);\n    if (adaptiveAnnotation == null) &#123;\n        // $æ—  Adaptive æ³¨è§£æ–¹æ³•ä»£ç ç”Ÿæˆé€»è¾‘&#125;\n    &#125; else &#123;\n        // $&#123;è·å– URL æ•°æ®&#125;\n        \n        // $&#123;è·å– Adaptive æ³¨è§£å€¼&#125;\n        \n        // $&#123;æ£€æµ‹ Invocation å‚æ•°&#125;\n        \n        // $&#123;ç”Ÿæˆæ‹“å±•åè·å–é€»è¾‘&#125;\n        \n        // $&#123;ç”Ÿæˆæ‹“å±•åŠ è½½ä¸ç›®æ ‡æ–¹æ³•è°ƒç”¨é€»è¾‘&#125;\n    &#125;\n&#125;\n    \n// public + è¿”å›å€¼å…¨é™å®šå + æ–¹æ³•å + (\ncodeBuilder.append(\"\\npublic \")\n    .append(rt.getCanonicalName())\n    .append(\" \")\n    .append(method.getName())\n    .append(\"(\");\n\n// æ·»åŠ å‚æ•°åˆ—è¡¨ä»£ç \nfor (int i = 0; i &lt; pts.length; i++) &#123;\n    if (i > 0) &#123;\n        codeBuilder.append(\", \");\n    &#125;\n    codeBuilder.append(pts[i].getCanonicalName());\n    codeBuilder.append(\" \");\n    codeBuilder.append(\"arg\").append(i);\n&#125;\ncodeBuilder.append(\")\");\n\n// æ·»åŠ å¼‚å¸¸æŠ›å‡ºä»£ç \nif (ets.length > 0) &#123;\n    codeBuilder.append(\" throws \");\n    for (int i = 0; i &lt; ets.length; i++) &#123;\n        if (i > 0) &#123;\n            codeBuilder.append(\", \");\n        &#125;\n        codeBuilder.append(ets[i].getCanonicalName());\n    &#125;\n&#125;\ncodeBuilder.append(\" &#123;\");\ncodeBuilder.append(code.toString());\ncodeBuilder.append(\"\\n&#125;\");\n\n\nä»¥ Protocol çš„ refer æ–¹æ³•ä¸ºä¾‹ï¼Œä¸Šé¢ä»£ç ç”Ÿæˆçš„å†…å®¹å¦‚ä¸‹ï¼š\npublic com.alibaba.dubbo.rpc.Invoker refer(java.lang.Class arg0, com.alibaba.dubbo.common.URL arg1) &#123;\n    // æ–¹æ³•ä½“\n&#125;\n\n\n\n3.æ€»ç»“åˆ°æ­¤ï¼Œå…³äºè‡ªé€‚åº”æ‹“å±•çš„åŸç†ï¼Œå®ç°å°±åˆ†æå®Œäº†ã€‚æ€»çš„æ¥è¯´è‡ªé€‚åº”æ‹“å±•æ•´ä¸ªé€»è¾‘è¿˜æ˜¯å¾ˆå¤æ‚çš„ï¼Œå¹¶ä¸æ˜¯å¾ˆå®¹æ˜“å¼„æ‡‚ã€‚å› æ­¤ï¼Œå¤§å®¶åœ¨é˜…è¯»è¯¥éƒ¨åˆ†æºç æ—¶ï¼Œè€å¿ƒä¸€äº›ã€‚åŒæ—¶å¤šè¿›è¡Œè°ƒè¯•ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ç”Ÿæˆå¥½çš„ä»£ç æ€è€ƒä»£ç çš„ç”Ÿæˆé€»è¾‘ã€‚å¥½äº†ï¼Œæœ¬ç¯‡æ–‡ç« å°±åˆ†æåˆ°è¿™é‡Œã€‚\n\n\n\n\n\n\n\n\n\nåŸæ–‡åœ°å€ï¼šhttps://dubbo.apache.org/zh/docsv2.7/dev/source/directory/\nä½œè€…ï¼š Dubbo å®˜æ–¹\næœ¬æ–‡ä»‹ç»äº†æœåŠ¡ç›®å½•çš„åŸç†å’Œå®ç°ç»†èŠ‚ã€‚\n\næœåŠ¡ç›®å½•1. ç®€ä»‹æœ¬ç¯‡æ–‡ç« ï¼Œå°†å¼€å§‹åˆ†æ Dubbo é›†ç¾¤å®¹é”™æ–¹é¢çš„æºç ã€‚é›†ç¾¤å®¹é”™æºç åŒ…å«å››ä¸ªéƒ¨åˆ†ï¼Œåˆ†åˆ«æ˜¯:\n\næœåŠ¡ç›®å½• Directory\næœåŠ¡è·¯ç”± Router\né›†ç¾¤ Cluster\nè´Ÿè½½å‡è¡¡ LoadBalanceã€‚\n\nè¿™å‡ ä¸ªéƒ¨åˆ†çš„æºç é€»è¾‘ç›¸å¯¹æ¯”è¾ƒç‹¬ç«‹ï¼Œæˆ‘ä»¬å°†ä¼šåˆ†å››ç¯‡æ–‡ç« è¿›è¡Œåˆ†æã€‚\næœ¬ç¯‡æ–‡ç« ä½œä¸ºé›†ç¾¤å®¹é”™çš„å¼€ç¯‡æ–‡ç« ï¼Œå°†å’Œå¤§å®¶ä¸€èµ·åˆ†ææœåŠ¡ç›®å½•ç›¸å…³çš„æºç ã€‚åœ¨è¿›è¡Œæ·±å…¥åˆ†æä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥äº†è§£ä¸€ä¸‹ï¼šæœåŠ¡ç›®å½•æ˜¯ä»€ä¹ˆï¼Ÿ\næœåŠ¡ç›®å½•ä¸­å­˜å‚¨äº†ä¸€äº›å’ŒæœåŠ¡æä¾›è€…æœ‰å…³çš„ä¿¡æ¯ï¼Œé€šè¿‡æœåŠ¡ç›®å½•ï¼ŒæœåŠ¡æ¶ˆè´¹è€…å¯è·å–åˆ°æœåŠ¡æä¾›è€…çš„ä¿¡æ¯ï¼Œæ¯”å¦‚ ipã€ç«¯å£ã€æœåŠ¡åè®®ç­‰ã€‚é€šè¿‡è¿™äº›ä¿¡æ¯ï¼ŒæœåŠ¡æ¶ˆè´¹è€…å°±å¯é€šè¿‡ Netty ç­‰å®¢æˆ·ç«¯è¿›è¡Œè¿œç¨‹è°ƒç”¨ã€‚\nåœ¨ä¸€ä¸ªæœåŠ¡é›†ç¾¤ä¸­ï¼ŒæœåŠ¡æä¾›è€…æ•°é‡å¹¶ä¸æ˜¯ä¸€æˆä¸å˜çš„ï¼Œå¦‚æœé›†ç¾¤ä¸­æ–°å¢äº†ä¸€å°æœºå™¨ï¼Œç›¸åº”åœ°åœ¨æœåŠ¡ç›®å½•ä¸­å°±è¦æ–°å¢ä¸€æ¡æœåŠ¡æä¾›è€…è®°å½•ã€‚æˆ–è€…ï¼Œå¦‚æœæœåŠ¡æä¾›è€…çš„é…ç½®ä¿®æ”¹äº†ï¼ŒæœåŠ¡ç›®å½•ä¸­çš„è®°å½•ä¹Ÿè¦åšç›¸åº”çš„æ›´æ–°ã€‚å¦‚æœè¿™æ ·è¯´ï¼ŒæœåŠ¡ç›®å½•å’Œæ³¨å†Œä¸­å¿ƒçš„åŠŸèƒ½ä¸å°±é›·åŒäº†å—ï¼Ÿç¡®å®å¦‚æ­¤ï¼Œè¿™é‡Œè¿™ä¹ˆè¯´æ˜¯ä¸ºäº†æ–¹ä¾¿å¤§å®¶ç†è§£ã€‚å®é™…ä¸ŠæœåŠ¡ç›®å½•åœ¨è·å–æ³¨å†Œä¸­å¿ƒçš„æœåŠ¡é…ç½®ä¿¡æ¯åï¼Œä¼šä¸ºæ¯æ¡é…ç½®ä¿¡æ¯ç”Ÿæˆä¸€ä¸ª Invoker å¯¹è±¡ï¼Œå¹¶æŠŠè¿™ä¸ª Invoker å¯¹è±¡å­˜å‚¨èµ·æ¥ï¼Œè¿™ä¸ª Invoker æ‰æ˜¯æœåŠ¡ç›®å½•æœ€ç»ˆæŒæœ‰çš„å¯¹è±¡ã€‚Invoker æœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿçœ‹åå­—å°±çŸ¥é“äº†ï¼Œè¿™æ˜¯ä¸€ä¸ªå…·æœ‰è¿œç¨‹è°ƒç”¨åŠŸèƒ½çš„å¯¹è±¡ã€‚è®²åˆ°è¿™å¤§å®¶åº”è¯¥çŸ¥é“äº†ä»€ä¹ˆæ˜¯æœåŠ¡ç›®å½•äº†ï¼Œå®ƒå¯ä»¥çœ‹åšæ˜¯ Invoker é›†åˆï¼Œä¸”è¿™ä¸ªé›†åˆä¸­çš„å…ƒç´ ä¼šéšæ³¨å†Œä¸­å¿ƒçš„å˜åŒ–è€Œè¿›è¡ŒåŠ¨æ€è°ƒæ•´ã€‚\nå…³äºæœåŠ¡ç›®å½•è¿™é‡Œå°±å…ˆä»‹ç»è¿™äº›ï¼Œå¤§å®¶å…ˆæœ‰ä¸ªå¤§è‡´å°è±¡ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬é€šè¿‡ç»§æ‰¿ä½“ç³»å›¾æ¥äº†è§£ä¸€ä¸‹æœåŠ¡ç›®å½•çš„å®¶æ—æˆå‘˜éƒ½æœ‰å“ªäº›ã€‚\n\n2. ç»§æ‰¿ä½“ç³»æœåŠ¡ç›®å½•ç›®å‰å†…ç½®çš„å®ç°æœ‰ä¸¤ä¸ªï¼Œåˆ†åˆ«ä¸º StaticDirectory å’Œ RegistryDirectoryï¼Œå®ƒä»¬å‡æ˜¯ AbstractDirectory çš„å­ç±»ã€‚AbstractDirectory å®ç°äº† Directory æ¥å£ï¼Œè¿™ä¸ªæ¥å£åŒ…å«äº†ä¸€ä¸ªé‡è¦çš„æ–¹æ³•å®šä¹‰ï¼Œå³ list(Invocation)ï¼Œç”¨äºåˆ—ä¸¾ Invokerã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ä»–ä»¬çš„ç»§æ‰¿ä½“ç³»å›¾ã€‚\n\nå¦‚ä¸Šï¼ŒDirectory ç»§æ‰¿è‡ª Node æ¥å£ï¼ŒNode è¿™ä¸ªæ¥å£ç»§æ‰¿è€…æ¯”è¾ƒå¤šï¼Œåƒ Registryã€Monitorã€Invoker ç­‰å‡ç»§æ‰¿äº†è¿™ä¸ªæ¥å£ã€‚è¿™ä¸ªæ¥å£åŒ…å«äº†ä¸€ä¸ªè·å–é…ç½®ä¿¡æ¯çš„æ–¹æ³• getUrlï¼Œå®ç°è¯¥æ¥å£çš„ç±»å¯ä»¥å‘å¤–æä¾›é…ç½®ä¿¡æ¯ã€‚å¦å¤–ï¼Œå¤§å®¶æ³¨æ„çœ‹ RegistryDirectory å®ç°äº† NotifyListener æ¥å£ï¼Œå½“æ³¨å†Œä¸­å¿ƒèŠ‚ç‚¹ä¿¡æ¯å‘ç”Ÿå˜åŒ–åï¼ŒRegistryDirectory å¯ä»¥é€šè¿‡æ­¤æ¥å£æ–¹æ³•å¾—åˆ°å˜æ›´ä¿¡æ¯ï¼Œå¹¶æ ¹æ®å˜æ›´ä¿¡æ¯åŠ¨æ€è°ƒæ•´å†…éƒ¨ Invoker åˆ—è¡¨ã€‚\n\n3. æºç åˆ†ææœ¬ç« å°†åˆ†æ AbstractDirectory å’Œå®ƒä¸¤ä¸ªå­ç±»çš„æºç ã€‚AbstractDirectory å°è£…äº† Invoker åˆ—ä¸¾æµç¨‹ï¼Œå…·ä½“çš„åˆ—ä¸¾é€»è¾‘åˆ™ç”±å­ç±»å®ç°ï¼Œè¿™æ˜¯å…¸å‹çš„æ¨¡æ¿æ¨¡å¼ã€‚æ‰€ä»¥ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹ AbstractDirectory çš„æºç ã€‚\npublic List&lt;Invoker&lt;T>> list(Invocation invocation) throws RpcException &#123;\n    if (destroyed) &#123;\n        throw new RpcException(\"Directory already destroyed...\");\n    &#125;\n    \n    // è°ƒç”¨ doList æ–¹æ³•åˆ—ä¸¾ Invokerï¼ŒdoList æ˜¯æ¨¡æ¿æ–¹æ³•ï¼Œç”±å­ç±»å®ç°\n    List&lt;Invoker&lt;T>> invokers = doList(invocation);\n    \n    // è·å–è·¯ç”± Router åˆ—è¡¨\n    List&lt;Router> localRouters = this.routers;\n    if (localRouters != null &amp;&amp; !localRouters.isEmpty()) &#123;\n        for (Router router : localRouters) &#123;\n            try &#123;\n                // è·å– runtime å‚æ•°ï¼Œå¹¶æ ¹æ®å‚æ•°å†³å®šæ˜¯å¦è¿›è¡Œè·¯ç”±\n                if (router.getUrl() == null || router.getUrl().getParameter(Constants.RUNTIME_KEY, false)) &#123;\n                    // è¿›è¡ŒæœåŠ¡è·¯ç”±\n                    invokers = router.route(invokers, getConsumerUrl(), invocation);\n                &#125;\n            &#125; catch (Throwable t) &#123;\n                logger.error(\"Failed to execute router: ...\");\n            &#125;\n        &#125;\n    &#125;\n    return invokers;\n&#125;\n\n// æ¨¡æ¿æ–¹æ³•ï¼Œç”±å­ç±»å®ç°\nprotected abstract List&lt;Invoker&lt;T>> doList(Invocation invocation) throws RpcException;\n\nä¸Šé¢å°±æ˜¯ AbstractDirectory çš„ list æ–¹æ³•æºç ï¼Œè¿™ä¸ªæ–¹æ³•å°è£…äº† Invoker çš„åˆ—ä¸¾è¿‡ç¨‹ã€‚å¦‚ä¸‹ï¼š\n\nè°ƒç”¨ doList è·å– Invoker åˆ—è¡¨\næ ¹æ® Router çš„ getUrl è¿”å›å€¼ä¸ºç©ºä¸å¦ï¼Œä»¥åŠ runtime å‚æ•°å†³å®šæ˜¯å¦è¿›è¡ŒæœåŠ¡è·¯ç”±\n\nä»¥ä¸Šæ­¥éª¤ä¸­ï¼ŒdoList æ˜¯æ¨¡æ¿æ–¹æ³•ï¼Œéœ€ç”±å­ç±»å®ç°ã€‚Router çš„ runtime å‚æ•°è¿™é‡Œç®€å•è¯´æ˜ä¸€ä¸‹ï¼Œè¿™ä¸ªå‚æ•°å†³å®šäº†æ˜¯å¦åœ¨æ¯æ¬¡è°ƒç”¨æœåŠ¡æ—¶éƒ½æ‰§è¡Œè·¯ç”±è§„åˆ™ã€‚å¦‚æœ runtime ä¸º trueï¼Œé‚£ä¹ˆæ¯æ¬¡è°ƒç”¨æœåŠ¡å‰ï¼Œéƒ½éœ€è¦è¿›è¡ŒæœåŠ¡è·¯ç”±ã€‚è¿™ä¸ªå¯¹æ€§èƒ½é€ æˆå½±å“ï¼Œé…ç½®æ—¶éœ€è¦æ³¨æ„ã€‚\nå…³äº AbstractDirectory å°±åˆ†æè¿™ä¹ˆå¤šï¼Œä¸‹é¢å¼€å§‹åˆ†æå­ç±»çš„æºç ã€‚\n\n3.1 StaticDirectory:é™æ€ç›®å½•æœåŠ¡StaticDirectory å³é™æ€æœåŠ¡ç›®å½•ï¼Œé¡¾åæ€ä¹‰ï¼Œå®ƒå†…éƒ¨å­˜æ”¾çš„ Invoker æ˜¯ä¸ä¼šå˜åŠ¨çš„ã€‚æ‰€ä»¥ï¼Œç†è®ºä¸Šå®ƒå’Œä¸å¯å˜ List çš„åŠŸèƒ½å¾ˆç›¸ä¼¼ã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªç±»çš„å®ç°ã€‚\npublic class StaticDirectory&lt;T> extends AbstractDirectory&lt;T> &#123;\n\n    // Invoker åˆ—è¡¨\n    private final List&lt;Invoker&lt;T>> invokers;\n    // çœç•¥æ„é€ æ–¹æ³•\n    @Override\n    public Class&lt;T> getInterface() &#123;\n        // è·å–æ¥å£ç±»\n        return invokers.get(0).getInterface();\n    &#125;\n    \n    // æ£€æµ‹æœåŠ¡ç›®å½•æ˜¯å¦å¯ç”¨\n    @Override\n    public boolean isAvailable() &#123;\n        if (isDestroyed()) &#123;\n            return false;\n        &#125;\n        for (Invoker&lt;T> invoker : invokers) &#123;\n            if (invoker.isAvailable()) &#123;\n                // åªè¦æœ‰ä¸€ä¸ª Invoker æ˜¯å¯ç”¨çš„ï¼Œå°±è®¤ä¸ºå½“å‰ç›®å½•æ˜¯å¯ç”¨çš„\n                return true;\n            &#125;\n        &#125;\n        return false;\n    &#125;\n\n    @Override\n    public void destroy() &#123;\n        if (isDestroyed()) &#123;\n            return;\n        &#125;\n        // è°ƒç”¨çˆ¶ç±»é”€æ¯é€»è¾‘\n        super.destroy();\n        // éå† Invoker åˆ—è¡¨ï¼Œå¹¶æ‰§è¡Œç›¸åº”çš„é”€æ¯é€»è¾‘\n        for (Invoker&lt;T> invoker : invokers) &#123;\n            invoker.destroy();\n        &#125;\n        invokers.clear();\n    &#125;\n\n    @Override\n    protected List&lt;Invoker&lt;T>> doList(Invocation invocation) throws RpcException &#123;\n        // åˆ—ä¸¾ Inovkerï¼Œä¹Ÿå°±æ˜¯ç›´æ¥è¿”å› invokers æˆå‘˜å˜é‡\n        return invokers;\n    &#125;\n&#125;\n\nä»¥ä¸Šå°±æ˜¯ StaticDirectory çš„ä»£ç é€»è¾‘ï¼Œå¾ˆç®€å•ï¼Œå°±ä¸å¤šè¯´äº†ã€‚ä¸‹é¢æ¥çœ‹çœ‹ RegistryDirectoryï¼Œè¿™ä¸ªç±»çš„é€»è¾‘æ¯”è¾ƒå¤æ‚ã€‚\n\n3.2 RegistryDirectory:åŠ¨æ€æœåŠ¡ç›®å½•RegistryDirectory æ˜¯ä¸€ç§åŠ¨æ€æœåŠ¡ç›®å½•ï¼Œå®ç°äº† NotifyListener æ¥å£ã€‚å½“æ³¨å†Œä¸­å¿ƒæœåŠ¡é…ç½®å‘ç”Ÿå˜åŒ–åï¼ŒRegistryDirectory å¯æ”¶åˆ°ä¸å½“å‰æœåŠ¡ç›¸å…³çš„å˜åŒ–ã€‚æ”¶åˆ°å˜æ›´é€šçŸ¥åï¼ŒRegistryDirectory å¯æ ¹æ®é…ç½®å˜æ›´ä¿¡æ¯åˆ·æ–° Invoker åˆ—è¡¨ã€‚RegistryDirectory ä¸­æœ‰å‡ ä¸ªæ¯”è¾ƒé‡è¦çš„é€»è¾‘ï¼Œç¬¬ä¸€æ˜¯ Invoker çš„åˆ—ä¸¾é€»è¾‘ï¼Œç¬¬äºŒæ˜¯æ¥æ”¶æœåŠ¡é…ç½®å˜æ›´çš„é€»è¾‘ï¼Œç¬¬ä¸‰æ˜¯ Invoker åˆ—è¡¨çš„åˆ·æ–°é€»è¾‘ã€‚æ¥ä¸‹æ¥æŒ‰é¡ºåºå¯¹è¿™ä¸‰å—é€»è¾‘è¿›è¡Œåˆ†æã€‚\n\n3.2.1 åˆ—ä¸¾ InvokerInvoker åˆ—ä¸¾é€»è¾‘å°è£…åœ¨ doList æ–¹æ³•ä¸­ï¼Œç›¸å…³ä»£ç å¦‚ä¸‹ï¼š\npublic List&lt;Invoker&lt;T>> doList(Invocation invocation) &#123;\n    if (forbidden) &#123;\n        // æœåŠ¡æä¾›è€…å…³é—­æˆ–ç¦ç”¨äº†æœåŠ¡ï¼Œæ­¤æ—¶æŠ›å‡º No provider å¼‚å¸¸\n        throw new RpcException(RpcException.FORBIDDEN_EXCEPTION,\n            \"No provider available from registry ...\");\n    &#125;\n    List&lt;Invoker&lt;T>> invokers = null;\n    // è·å– Invoker æœ¬åœ°ç¼“å­˜\n    Map&lt;String, List&lt;Invoker&lt;T>>> localMethodInvokerMap = this.methodInvokerMap;\n    if (localMethodInvokerMap != null &amp;&amp; localMethodInvokerMap.size() > 0) &#123;\n        // è·å–æ–¹æ³•åå’Œå‚æ•°åˆ—è¡¨\n        String methodName = RpcUtils.getMethodName(invocation);\n        Object[] args = RpcUtils.getArguments(invocation);\n        // æ£€æµ‹å‚æ•°åˆ—è¡¨çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å¦ä¸º String æˆ– enum ç±»å‹\n        if (args != null &amp;&amp; args.length > 0 &amp;&amp; args[0] != null\n                &amp;&amp; (args[0] instanceof String || args[0].getClass().isEnum())) &#123;\n            // é€šè¿‡ æ–¹æ³•å + ç¬¬ä¸€ä¸ªå‚æ•°åç§° æŸ¥è¯¢ Invoker åˆ—è¡¨ï¼Œå…·ä½“çš„ä½¿ç”¨åœºæ™¯æš‚æ—¶æ²¡æƒ³åˆ°\n            invokers = localMethodInvokerMap.get(methodName + \".\" + args[0]);\n        &#125;\n        if (invokers == null) &#123;\n            // é€šè¿‡æ–¹æ³•åè·å– Invoker åˆ—è¡¨\n            invokers = localMethodInvokerMap.get(methodName);\n        &#125;\n        if (invokers == null) &#123;\n            // é€šè¿‡æ˜Ÿå· * è·å– Invoker åˆ—è¡¨\n            invokers = localMethodInvokerMap.get(Constants.ANY_VALUE);\n        &#125;\n        \n        // å†—ä½™é€»è¾‘ï¼Œpull request #2861 ç§»é™¤äº†ä¸‹é¢çš„ if åˆ†æ”¯ä»£ç \n        if (invokers == null) &#123;\n            Iterator&lt;List&lt;Invoker&lt;T>>> iterator = localMethodInvokerMap.values().iterator();\n            if (iterator.hasNext()) &#123;\n                invokers = iterator.next();\n            &#125;\n        &#125;\n    &#125;\n\n\t// è¿”å› Invoker åˆ—è¡¨\n    return invokers == null ? new ArrayList&lt;Invoker&lt;T>>(0) : invokers;\n&#125;\n\nä»¥ä¸Šä»£ç è¿›è¡Œå¤šæ¬¡å°è¯•ï¼Œä»¥æœŸä» localMethodInvokerMap ä¸­è·å–åˆ° Invoker åˆ—è¡¨ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæ™®é€šçš„è°ƒç”¨å¯é€šè¿‡æ–¹æ³•åè·å–åˆ°å¯¹åº”çš„ Invoker åˆ—è¡¨ï¼Œæ³›åŒ–è°ƒç”¨å¯é€šè¿‡ * è·å–åˆ° Invoker åˆ—è¡¨ã€‚localMethodInvokerMap æºè‡ª RegistryDirectory ç±»çš„æˆå‘˜å˜é‡ methodInvokerMapã€‚doList æ–¹æ³•å¯ä»¥çœ‹åšæ˜¯å¯¹ methodInvokerMap å˜é‡çš„è¯»æ“ä½œï¼Œè‡³äºå¯¹ methodInvokerMap å˜é‡çš„å†™æ“ä½œï¼Œä¸‹ä¸€èŠ‚è¿›è¡Œåˆ†æã€‚\n\n3.2.2 æ¥æ”¶æœåŠ¡å˜æ›´é€šçŸ¥RegistryDirectory æ˜¯ä¸€ä¸ªåŠ¨æ€æœåŠ¡ç›®å½•ï¼Œä¼šéšæ³¨å†Œä¸­å¿ƒé…ç½®çš„å˜åŒ–è¿›è¡ŒåŠ¨æ€è°ƒæ•´ã€‚å› æ­¤ RegistryDirectory å®ç°äº† NotifyListener æ¥å£ï¼Œé€šè¿‡è¿™ä¸ªæ¥å£è·å–æ³¨å†Œä¸­å¿ƒå˜æ›´é€šçŸ¥ã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å…·ä½“çš„é€»è¾‘ã€‚\npublic synchronized void notify(List&lt;URL> urls) &#123;\n    // å®šä¹‰ä¸‰ä¸ªé›†åˆï¼Œåˆ†åˆ«ç”¨äºå­˜æ”¾æœåŠ¡æä¾›è€… urlï¼Œè·¯ç”± urlï¼Œé…ç½®å™¨ url\n    List&lt;URL> invokerUrls = new ArrayList&lt;URL>();\n    List&lt;URL> routerUrls = new ArrayList&lt;URL>();\n    List&lt;URL> configuratorUrls = new ArrayList&lt;URL>();\n    for (URL url : urls) &#123;\n        String protocol = url.getProtocol();\n        // è·å– category å‚æ•°\n        String category = url.getParameter(Constants.CATEGORY_KEY, Constants.DEFAULT_CATEGORY);\n        // æ ¹æ® category å‚æ•°å°† url åˆ†åˆ«æ”¾åˆ°ä¸åŒçš„åˆ—è¡¨ä¸­\n        if (Constants.ROUTERS_CATEGORY.equals(category)\n                || Constants.ROUTE_PROTOCOL.equals(protocol)) &#123;\n            // æ·»åŠ è·¯ç”±å™¨ url\n            routerUrls.add(url);\n        &#125; else if (Constants.CONFIGURATORS_CATEGORY.equals(category)\n                || Constants.OVERRIDE_PROTOCOL.equals(protocol)) &#123;\n            // æ·»åŠ é…ç½®å™¨ url\n            configuratorUrls.add(url);\n        &#125; else if (Constants.PROVIDERS_CATEGORY.equals(category)) &#123;\n            // æ·»åŠ æœåŠ¡æä¾›è€… url\n            invokerUrls.add(url);\n        &#125; else &#123;\n            // å¿½ç•¥ä¸æ”¯æŒçš„ category\n            logger.warn(\"Unsupported category ...\");\n        &#125;\n    &#125;\n    if (configuratorUrls != null &amp;&amp; !configuratorUrls.isEmpty()) &#123;\n        // å°† url è½¬æˆ Configurator\n        this.configurators = toConfigurators(configuratorUrls);\n    &#125;\n    if (routerUrls != null &amp;&amp; !routerUrls.isEmpty()) &#123;\n        // å°† url è½¬æˆ Router\n        List&lt;Router> routers = toRouters(routerUrls);\n        if (routers != null) &#123;\n            setRouters(routers);\n        &#125;\n    &#125;\n    List&lt;Configurator> localConfigurators = this.configurators;\n    this.overrideDirectoryUrl = directoryUrl;\n    if (localConfigurators != null &amp;&amp; !localConfigurators.isEmpty()) &#123;\n        for (Configurator configurator : localConfigurators) &#123;\n            // é…ç½® overrideDirectoryUrl\n            this.overrideDirectoryUrl = configurator.configure(overrideDirectoryUrl);\n        &#125;\n    &#125;\n\n    // åˆ·æ–° Invoker åˆ—è¡¨\n    refreshInvoker(invokerUrls);\n&#125;\n\nå¦‚ä¸Šï¼Œnotify æ–¹æ³•é¦–å…ˆæ˜¯æ ¹æ® url çš„ category å‚æ•°å¯¹ url è¿›è¡Œåˆ†é—¨åˆ«ç±»å­˜å‚¨ï¼Œç„¶åé€šè¿‡ toRouters å’Œ toConfigurators å°† url åˆ—è¡¨è½¬æˆ Router å’Œ Configurator åˆ—è¡¨ã€‚æœ€åè°ƒç”¨ refreshInvoker æ–¹æ³•åˆ·æ–° Invoker åˆ—è¡¨ã€‚è¿™é‡Œçš„ toRouters å’Œ toConfigurators æ–¹æ³•é€»è¾‘ä¸å¤æ‚ï¼Œå¤§å®¶è‡ªè¡Œåˆ†æã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æŠŠé‡ç‚¹æ”¾åœ¨ refreshInvoker æ–¹æ³•ä¸Šã€‚\n\n3.2.3 åˆ·æ–° Invoker åˆ—è¡¨refreshInvoker æ–¹æ³•æ˜¯ä¿è¯ RegistryDirectory éšæ³¨å†Œä¸­å¿ƒå˜åŒ–è€Œå˜åŒ–çš„å…³é”®æ‰€åœ¨ã€‚è¿™ä¸€å—é€»è¾‘æ¯”è¾ƒå¤šï¼Œæ¥ä¸‹æ¥ä¸€ä¸€è¿›è¡Œåˆ†æã€‚\nprivate void refreshInvoker(List&lt;URL> invokerUrls) &#123;\n    // invokerUrls ä»…æœ‰ä¸€ä¸ªå…ƒç´ ï¼Œä¸” url åè®®å¤´ä¸º emptyï¼Œæ­¤æ—¶è¡¨ç¤ºç¦ç”¨æ‰€æœ‰æœåŠ¡\n    if (invokerUrls != null &amp;&amp; invokerUrls.size() == 1 &amp;&amp; invokerUrls.get(0) != null\n            &amp;&amp; Constants.EMPTY_PROTOCOL.equals(invokerUrls.get(0).getProtocol())) &#123;\n        // è®¾ç½® forbidden ä¸º true\n        this.forbidden = true;\n        this.methodInvokerMap = null;\n        // é”€æ¯æ‰€æœ‰ Invoker\n        destroyAllInvokers();\n    &#125; else &#123;\n        this.forbidden = false;\n        Map&lt;String, Invoker&lt;T>> oldUrlInvokerMap = this.urlInvokerMap;\n        if (invokerUrls.isEmpty() &amp;&amp; this.cachedInvokerUrls != null) &#123;\n            // æ·»åŠ ç¼“å­˜ url åˆ° invokerUrls ä¸­\n            invokerUrls.addAll(this.cachedInvokerUrls);\n        &#125; else &#123;\n            this.cachedInvokerUrls = new HashSet&lt;URL>();\n            // ç¼“å­˜ invokerUrls\n            this.cachedInvokerUrls.addAll(invokerUrls);\n        &#125;\n        if (invokerUrls.isEmpty()) &#123;\n            return;\n        &#125;\n        // å°† url è½¬æˆ Invoker\n        Map&lt;String, Invoker&lt;T>> newUrlInvokerMap = toInvokers(invokerUrls);\n        // å°† newUrlInvokerMap è½¬æˆæ–¹æ³•ååˆ° Invoker åˆ—è¡¨çš„æ˜ å°„\n        Map&lt;String, List&lt;Invoker&lt;T>>> newMethodInvokerMap = toMethodInvokers(newUrlInvokerMap);\n        // è½¬æ¢å‡ºé”™ï¼Œç›´æ¥æ‰“å°å¼‚å¸¸ï¼Œå¹¶è¿”å›\n        if (newUrlInvokerMap == null || newUrlInvokerMap.size() == 0) &#123;\n            logger.error(new IllegalStateException(\"urls to invokers error ...\"));\n            return;\n        &#125;\n        // åˆå¹¶å¤šä¸ªç»„çš„ Invoker\n        this.methodInvokerMap = multiGroup ? toMergeMethodInvokerMap(newMethodInvokerMap) : newMethodInvokerMap;\n        this.urlInvokerMap = newUrlInvokerMap;\n        try &#123;\n            // é”€æ¯æ— ç”¨ Invoker\n            destroyUnusedInvokers(oldUrlInvokerMap, newUrlInvokerMap);\n        &#125; catch (Exception e) &#123;\n            logger.warn(\"destroyUnusedInvokers error. \", e);\n        &#125;\n    &#125;\n&#125;\n\nrefreshInvoker æ–¹æ³•é¦–å…ˆä¼šæ ¹æ®å…¥å‚ invokerUrls çš„æ•°é‡å’Œåè®®å¤´åˆ¤æ–­æ˜¯å¦ç¦ç”¨æ‰€æœ‰çš„æœåŠ¡ï¼Œå¦‚æœç¦ç”¨ï¼Œåˆ™å°† forbidden è®¾ä¸º trueï¼Œå¹¶é”€æ¯æ‰€æœ‰çš„ Invokerã€‚è‹¥ä¸ç¦ç”¨ï¼Œåˆ™å°† url è½¬æˆ Invokerï¼Œå¾—åˆ° &lt;url, Invoker&gt; çš„æ˜ å°„å…³ç³»ã€‚ç„¶åè¿›ä¸€æ­¥è¿›è¡Œè½¬æ¢ï¼Œå¾—åˆ° &lt;methodName, Invoker åˆ—è¡¨&gt; æ˜ å°„å…³ç³»ã€‚ä¹‹åè¿›è¡Œå¤šç»„ Invoker åˆå¹¶æ“ä½œï¼Œå¹¶å°†åˆå¹¶ç»“æœèµ‹å€¼ç»™ methodInvokerMapã€‚methodInvokerMap å˜é‡åœ¨ doList æ–¹æ³•ä¸­ä¼šè¢«ç”¨åˆ°ï¼ŒdoList ä¼šå¯¹è¯¥å˜é‡è¿›è¡Œè¯»æ“ä½œï¼Œåœ¨è¿™é‡Œæ˜¯å†™æ“ä½œã€‚å½“æ–°çš„ Invoker åˆ—è¡¨ç”Ÿæˆåï¼Œè¿˜è¦ä¸€ä¸ªé‡è¦çš„å·¥ä½œè¦åšï¼Œå°±æ˜¯é”€æ¯æ— ç”¨çš„ Invokerï¼Œé¿å…æœåŠ¡æ¶ˆè´¹è€…è°ƒç”¨å·²ä¸‹çº¿çš„æœåŠ¡çš„æœåŠ¡ã€‚\næ¥ä¸‹æ¥å¯¹ refreshInvoker æ–¹æ³•ä¸­æ¶‰åŠåˆ°çš„è°ƒç”¨ä¸€ä¸€è¿›è¡Œåˆ†æã€‚æŒ‰ç…§é¡ºåºï¼Œå…ˆæ¥åˆ†æ url åˆ° Invoker çš„è½¬æ¢è¿‡ç¨‹ã€‚\nprivate Map&lt;String, Invoker&lt;T>> toInvokers(List&lt;URL> urls) &#123;\n    Map&lt;String, Invoker&lt;T>> newUrlInvokerMap = new HashMap&lt;String, Invoker&lt;T>>();\n    if (urls == null || urls.isEmpty()) &#123;\n        return newUrlInvokerMap;\n    &#125;\n    Set&lt;String> keys = new HashSet&lt;String>();\n    // è·å–æœåŠ¡æ¶ˆè´¹ç«¯é…ç½®çš„åè®®\n    String queryProtocols = this.queryMap.get(Constants.PROTOCOL_KEY);\n    for (URL providerUrl : urls) &#123;\n        if (queryProtocols != null &amp;&amp; queryProtocols.length() > 0) &#123;\n            boolean accept = false;\n            String[] acceptProtocols = queryProtocols.split(\",\");\n            // æ£€æµ‹æœåŠ¡æä¾›è€…åè®®æ˜¯å¦è¢«æœåŠ¡æ¶ˆè´¹è€…æ‰€æ”¯æŒ\n            for (String acceptProtocol : acceptProtocols) &#123;\n                if (providerUrl.getProtocol().equals(acceptProtocol)) &#123;\n                    accept = true;\n                    break;\n                &#125;\n            &#125;\n            if (!accept) &#123;\n                // è‹¥æœåŠ¡æä¾›è€…åè®®å¤´ä¸è¢«æ¶ˆè´¹è€…æ‰€æ”¯æŒï¼Œåˆ™å¿½ç•¥å½“å‰ providerUrl\n                continue;\n            &#125;\n        &#125;\n        // å¿½ç•¥ empty åè®®\n        if (Constants.EMPTY_PROTOCOL.equals(providerUrl.getProtocol())) &#123;\n            continue;\n        &#125;\n        // é€šè¿‡ SPI æ£€æµ‹æœåŠ¡ç«¯åè®®æ˜¯å¦è¢«æ¶ˆè´¹ç«¯æ”¯æŒï¼Œä¸æ”¯æŒåˆ™æŠ›å‡ºå¼‚å¸¸\n        if (!ExtensionLoader.getExtensionLoader(Protocol.class).hasExtension(providerUrl.getProtocol())) &#123;\n            logger.error(new IllegalStateException(\"Unsupported protocol...\"));\n            continue;\n        &#125;\n        \n        // åˆå¹¶ url\n        URL url = mergeUrl(providerUrl);\n\n        String key = url.toFullString();\n        if (keys.contains(key)) &#123;\n            // å¿½ç•¥é‡å¤ url\n            continue;\n        &#125;\n        keys.add(key);\n        // å°†æœ¬åœ° Invoker ç¼“å­˜èµ‹å€¼ç»™ localUrlInvokerMap\n        Map&lt;String, Invoker&lt;T>> localUrlInvokerMap = this.urlInvokerMap;\n        // è·å–ä¸ url å¯¹åº”çš„ Invoker\n        Invoker&lt;T> invoker = localUrlInvokerMap == null ? null : localUrlInvokerMap.get(key);\n        // ç¼“å­˜æœªå‘½ä¸­\n        if (invoker == null) &#123;\n            try &#123;\n                boolean enabled = true;\n                if (url.hasParameter(Constants.DISABLED_KEY)) &#123;\n                    // è·å– disable é…ç½®ï¼Œå–åï¼Œç„¶åèµ‹å€¼ç»™ enable å˜é‡\n                    enabled = !url.getParameter(Constants.DISABLED_KEY, false);\n                &#125; else &#123;\n                    // è·å– enable é…ç½®ï¼Œå¹¶èµ‹å€¼ç»™ enable å˜é‡\n                    enabled = url.getParameter(Constants.ENABLED_KEY, true);\n                &#125;\n                if (enabled) &#123;\n                    // è°ƒç”¨ refer è·å– Invoker\n                    invoker = new InvokerDelegate&lt;T>(protocol.refer(serviceType, url), url, providerUrl);\n                &#125;\n            &#125; catch (Throwable t) &#123;\n                logger.error(\"Failed to refer invoker for interface...\");\n            &#125;\n            if (invoker != null) &#123;\n                // ç¼“å­˜ Invoker å®ä¾‹\n                newUrlInvokerMap.put(key, invoker);\n            &#125;\n            \n        // ç¼“å­˜å‘½ä¸­\n        &#125; else &#123;\n            // å°† invoker å­˜å‚¨åˆ° newUrlInvokerMap ä¸­\n            newUrlInvokerMap.put(key, invoker);\n        &#125;\n    &#125;\n    keys.clear();\n    return newUrlInvokerMap;\n&#125;\n\ntoInvokers æ–¹æ³•ä¸€å¼€å§‹ä¼šå¯¹æœåŠ¡æä¾›è€… url è¿›è¡Œæ£€æµ‹ï¼Œè‹¥æœåŠ¡æ¶ˆè´¹ç«¯çš„é…ç½®ä¸æ”¯æŒæœåŠ¡ç«¯çš„åè®®ï¼Œæˆ–æœåŠ¡ç«¯ url åè®®å¤´ä¸º empty æ—¶ï¼ŒtoInvokers å‡ä¼šå¿½ç•¥æœåŠ¡æä¾›æ–¹ urlã€‚å¿…è¦çš„æ£€æµ‹åšå®Œåï¼Œç´§æ¥ç€æ˜¯åˆå¹¶ urlï¼Œç„¶åè®¿é—®ç¼“å­˜ï¼Œå°è¯•è·å–ä¸ url å¯¹åº”çš„ invokerã€‚å¦‚æœç¼“å­˜å‘½ä¸­ï¼Œç›´æ¥å°† Invoker å­˜å…¥ newUrlInvokerMap ä¸­å³å¯ã€‚å¦‚æœæœªå‘½ä¸­ï¼Œåˆ™éœ€æ–°å»º Invokerã€‚\ntoInvokers æ–¹æ³•è¿”å›çš„æ˜¯ &lt;url, Invoker&gt; æ˜ å°„å…³ç³»è¡¨ï¼Œæ¥ä¸‹æ¥è¿˜è¦å¯¹è¿™ä¸ªç»“æœè¿›è¡Œè¿›ä¸€æ­¥å¤„ç†ï¼Œå¾—åˆ°æ–¹æ³•ååˆ° Invoker åˆ—è¡¨çš„æ˜ å°„å…³ç³»ã€‚è¿™ä¸ªè¿‡ç¨‹ç”± toMethodInvokers æ–¹æ³•å®Œæˆï¼Œå¦‚ä¸‹ï¼š\nprivate Map&lt;String, List&lt;Invoker&lt;T>>> toMethodInvokers(Map&lt;String, Invoker&lt;T>> invokersMap) &#123;\n    // æ–¹æ³•å -> Invoker åˆ—è¡¨\n    Map&lt;String, List&lt;Invoker&lt;T>>> newMethodInvokerMap = new HashMap&lt;String, List&lt;Invoker&lt;T>>>();\n    List&lt;Invoker&lt;T>> invokersList = new ArrayList&lt;Invoker&lt;T>>();\n    if (invokersMap != null &amp;&amp; invokersMap.size() > 0) &#123;\n        for (Invoker&lt;T> invoker : invokersMap.values()) &#123;\n            // è·å– methods å‚æ•°\n            String parameter = invoker.getUrl().getParameter(Constants.METHODS_KEY);\n            if (parameter != null &amp;&amp; parameter.length() > 0) &#123;\n                // åˆ‡åˆ† methods å‚æ•°å€¼ï¼Œå¾—åˆ°æ–¹æ³•åæ•°ç»„\n                String[] methods = Constants.COMMA_SPLIT_PATTERN.split(parameter);\n                if (methods != null &amp;&amp; methods.length > 0) &#123;\n                    for (String method : methods) &#123;\n                        // æ–¹æ³•åä¸ä¸º *\n                        if (method != null &amp;&amp; method.length() > 0\n                                &amp;&amp; !Constants.ANY_VALUE.equals(method)) &#123;\n                            // æ ¹æ®æ–¹æ³•åè·å– Invoker åˆ—è¡¨\n                            List&lt;Invoker&lt;T>> methodInvokers = newMethodInvokerMap.get(method);\n                            if (methodInvokers == null) &#123;\n                                methodInvokers = new ArrayList&lt;Invoker&lt;T>>();\n                                newMethodInvokerMap.put(method, methodInvokers);\n                            &#125;\n                            // å­˜å‚¨ Invoker åˆ°åˆ—è¡¨ä¸­\n                            methodInvokers.add(invoker);\n                        &#125;\n                    &#125;\n                &#125;\n            &#125;\n            invokersList.add(invoker);\n        &#125;\n    &#125;\n    \n    // è¿›è¡ŒæœåŠ¡çº§åˆ«è·¯ç”±ï¼Œå‚è€ƒ pull request #749\n    List&lt;Invoker&lt;T>> newInvokersList = route(invokersList, null);\n    // å­˜å‚¨ &lt;*, newInvokersList> æ˜ å°„å…³ç³»\n    newMethodInvokerMap.put(Constants.ANY_VALUE, newInvokersList);\n    if (serviceMethods != null &amp;&amp; serviceMethods.length > 0) &#123;\n        for (String method : serviceMethods) &#123;\n            List&lt;Invoker&lt;T>> methodInvokers = newMethodInvokerMap.get(method);\n            if (methodInvokers == null || methodInvokers.isEmpty()) &#123;\n                methodInvokers = newInvokersList;\n            &#125;\n            // è¿›è¡Œæ–¹æ³•çº§åˆ«è·¯ç”±\n            newMethodInvokerMap.put(method, route(methodInvokers, method));\n        &#125;\n    &#125;\n    // æ’åºï¼Œè½¬æˆä¸å¯å˜åˆ—è¡¨\n    for (String method : new HashSet&lt;String>(newMethodInvokerMap.keySet())) &#123;\n        List&lt;Invoker&lt;T>> methodInvokers = newMethodInvokerMap.get(method);\n        Collections.sort(methodInvokers, InvokerComparator.getComparator());\n        newMethodInvokerMap.put(method, Collections.unmodifiableList(methodInvokers));\n    &#125;\n    return Collections.unmodifiableMap(newMethodInvokerMap);\n&#125;\n\nä¸Šé¢æ–¹æ³•ä¸»è¦åšäº†ä¸‰ä»¶äº‹æƒ…ï¼Œ ç¬¬ä¸€æ˜¯å¯¹å…¥å‚è¿›è¡Œéå†ï¼Œç„¶åä» Invoker çš„ url æˆå‘˜å˜é‡ä¸­è·å– methods å‚æ•°ï¼Œå¹¶åˆ‡åˆ†æˆæ•°ç»„ã€‚éšåä»¥æ–¹æ³•åä¸ºé”®ï¼ŒInvoker åˆ—è¡¨ä¸ºå€¼ï¼Œå°†æ˜ å°„å…³ç³»å­˜å‚¨åˆ° newMethodInvokerMap ä¸­ã€‚ç¬¬äºŒæ˜¯åˆ†åˆ«åŸºäºç±»å’Œæ–¹æ³•å¯¹ Invoker åˆ—è¡¨è¿›è¡Œè·¯ç”±æ“ä½œã€‚ç¬¬ä¸‰æ˜¯å¯¹ Invoker åˆ—è¡¨è¿›è¡Œæ’åºï¼Œå¹¶è½¬æˆä¸å¯å˜åˆ—è¡¨ã€‚å…³äº toMethodInvokers æ–¹æ³•å°±å…ˆåˆ†æåˆ°è¿™ï¼Œæˆ‘ä»¬ç»§ç»­å‘ä¸‹åˆ†æï¼Œè¿™æ¬¡è¦åˆ†æçš„å¤šç»„æœåŠ¡çš„åˆå¹¶é€»è¾‘ã€‚\nprivate Map&lt;String, List&lt;Invoker&lt;T>>> toMergeMethodInvokerMap(Map&lt;String, List&lt;Invoker&lt;T>>> methodMap) &#123;\n    Map&lt;String, List&lt;Invoker&lt;T>>> result = new HashMap&lt;String, List&lt;Invoker&lt;T>>>();\n    // éå†å…¥å‚\n    for (Map.Entry&lt;String, List&lt;Invoker&lt;T>>> entry : methodMap.entrySet()) &#123;\n        String method = entry.getKey();\n        List&lt;Invoker&lt;T>> invokers = entry.getValue();\n        // group -> Invoker åˆ—è¡¨\n        Map&lt;String, List&lt;Invoker&lt;T>>> groupMap = new HashMap&lt;String, List&lt;Invoker&lt;T>>>();\n        // éå† Invoker åˆ—è¡¨\n        for (Invoker&lt;T> invoker : invokers) &#123;\n            // è·å–åˆ†ç»„é…ç½®\n            String group = invoker.getUrl().getParameter(Constants.GROUP_KEY, \"\");\n            List&lt;Invoker&lt;T>> groupInvokers = groupMap.get(group);\n            if (groupInvokers == null) &#123;\n                groupInvokers = new ArrayList&lt;Invoker&lt;T>>();\n                // ç¼“å­˜ &lt;group, List&lt;Invoker>> åˆ° groupMap ä¸­\n                groupMap.put(group, groupInvokers);\n            &#125;\n            // å­˜å‚¨ invoker åˆ° groupInvokers\n            groupInvokers.add(invoker);\n        &#125;\n        if (groupMap.size() == 1) &#123;\n            // å¦‚æœ groupMap ä¸­ä»…åŒ…å«ä¸€ç»„é”®å€¼å¯¹ï¼Œæ­¤æ—¶ç›´æ¥å–å‡ºè¯¥é”®å€¼å¯¹çš„å€¼å³å¯\n            result.put(method, groupMap.values().iterator().next());\n        \n        // groupMap.size() > 1 æˆç«‹ï¼Œè¡¨ç¤º groupMap ä¸­åŒ…å«å¤šç»„é”®å€¼å¯¹ï¼Œæ¯”å¦‚ï¼š\n        // &#123;\n        //     \"dubbo\": [invoker1, invoker2, invoker3, ...],\n        //     \"hello\": [invoker4, invoker5, invoker6, ...]\n        // &#125;\n        &#125; else if (groupMap.size() > 1) &#123;\n            List&lt;Invoker&lt;T>> groupInvokers = new ArrayList&lt;Invoker&lt;T>>();\n            for (List&lt;Invoker&lt;T>> groupList : groupMap.values()) &#123;\n                // é€šè¿‡é›†ç¾¤ç±»åˆå¹¶æ¯ä¸ªåˆ†ç»„å¯¹åº”çš„ Invoker åˆ—è¡¨\n                groupInvokers.add(cluster.join(new StaticDirectory&lt;T>(groupList)));\n            &#125;\n            // ç¼“å­˜ç»“æœ\n            result.put(method, groupInvokers);\n        &#125; else &#123;\n            result.put(method, invokers);\n        &#125;\n    &#125;\n    return result;\n&#125;\n\nä¸Šé¢æ–¹æ³•é¦–å…ˆæ˜¯ç”Ÿæˆ group åˆ° Invoker åˆ—è¡¨çš„æ˜ å°„å…³ç³»è¡¨ï¼Œè‹¥å…³ç³»è¡¨ä¸­çš„æ˜ å°„å…³ç³»æ•°é‡å¤§äº1ï¼Œè¡¨ç¤ºæœ‰å¤šç»„æœåŠ¡ã€‚æ­¤æ—¶é€šè¿‡é›†ç¾¤ç±»åˆå¹¶æ¯ç»„ Invokerï¼Œå¹¶å°†åˆå¹¶ç»“æœå­˜å‚¨åˆ° groupInvokers ä¸­ã€‚ä¹‹åå°†æ–¹æ³•åä¸ groupInvokers å­˜åˆ°åˆ° result ä¸­ï¼Œå¹¶è¿”å›ï¼Œæ•´ä¸ªé€»è¾‘ç»“æŸã€‚\næ¥ä¸‹æ¥æˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹ Invoker åˆ—è¡¨åˆ·æ–°é€»è¾‘çš„æœ€åä¸€ä¸ªåŠ¨ä½œ â€” åˆ é™¤æ— ç”¨ Invokerã€‚å¦‚ä¸‹ï¼š\nprivate void destroyUnusedInvokers(Map&lt;String, Invoker&lt;T>> oldUrlInvokerMap, Map&lt;String, Invoker&lt;T>> newUrlInvokerMap) &#123;\n    if (newUrlInvokerMap == null || newUrlInvokerMap.size() == 0) &#123;\n        destroyAllInvokers();\n        return;\n    &#125;\n   \n    List&lt;String> deleted = null;\n    if (oldUrlInvokerMap != null) &#123;\n        // è·å–æ–°ç”Ÿæˆçš„ Invoker åˆ—è¡¨\n        Collection&lt;Invoker&lt;T>> newInvokers = newUrlInvokerMap.values();\n        // éå†è€çš„ &lt;url, Invoker> æ˜ å°„è¡¨\n        for (Map.Entry&lt;String, Invoker&lt;T>> entry : oldUrlInvokerMap.entrySet()) &#123;\n            // æ£€æµ‹ newInvokers ä¸­æ˜¯å¦åŒ…å«è€çš„ Invoker\n            if (!newInvokers.contains(entry.getValue())) &#123;\n                if (deleted == null) &#123;\n                    deleted = new ArrayList&lt;String>();\n                &#125;\n                // è‹¥ä¸åŒ…å«ï¼Œåˆ™å°†è€çš„ Invoker å¯¹åº”çš„ url å­˜å…¥ deleted åˆ—è¡¨ä¸­\n                deleted.add(entry.getKey());\n            &#125;\n        &#125;\n    &#125;\n\n    if (deleted != null) &#123;\n        // éå† deleted é›†åˆï¼Œå¹¶åˆ°è€çš„ &lt;url, Invoker> æ˜ å°„å…³ç³»è¡¨æŸ¥å‡º Invokerï¼Œé”€æ¯ä¹‹\n        for (String url : deleted) &#123;\n            if (url != null) &#123;\n                // ä» oldUrlInvokerMap ä¸­ç§»é™¤ url å¯¹åº”çš„ Invoker\n                Invoker&lt;T> invoker = oldUrlInvokerMap.remove(url);\n                if (invoker != null) &#123;\n                    try &#123;\n                        // é”€æ¯ Invoker\n                        invoker.destroy();\n                    &#125; catch (Exception e) &#123;\n                        logger.warn(\"destroy invoker...\");\n                    &#125;\n                &#125;\n            &#125;\n        &#125;\n    &#125;\n&#125;\n\ndestroyUnusedInvokers æ–¹æ³•çš„ä¸»è¦é€»è¾‘æ˜¯é€šè¿‡ newUrlInvokerMap æ‰¾å‡ºå¾…åˆ é™¤ Invoker å¯¹åº”çš„ urlï¼Œå¹¶å°† url å­˜å…¥åˆ° deleted åˆ—è¡¨ä¸­ã€‚ç„¶åå†éå† deleted åˆ—è¡¨ï¼Œå¹¶ä» oldUrlInvokerMap ä¸­ç§»é™¤ç›¸åº”çš„ Invokerï¼Œé”€æ¯ä¹‹ã€‚æ•´ä¸ªé€»è¾‘å¤§è‡´å¦‚æ­¤ï¼Œä¸æ˜¯å¾ˆéš¾ç†è§£ã€‚\nåˆ°æ­¤å…³äº Invoker åˆ—è¡¨çš„åˆ·æ–°é€»è¾‘å°±åˆ†æäº†ï¼Œè¿™é‡Œå¯¹æ•´ä¸ªè¿‡ç¨‹è¿›è¡Œç®€å•æ€»ç»“ã€‚å¦‚ä¸‹ï¼š\n\næ£€æµ‹å…¥å‚æ˜¯å¦ä»…åŒ…å«ä¸€ä¸ª urlï¼Œä¸” url åè®®å¤´ä¸º empty\nè‹¥ç¬¬ä¸€æ­¥æ£€æµ‹ç»“æœä¸º trueï¼Œè¡¨ç¤ºç¦ç”¨æ‰€æœ‰æœåŠ¡ï¼Œæ­¤æ—¶é”€æ¯æ‰€æœ‰çš„ Invoker\nè‹¥ç¬¬ä¸€æ­¥æ£€æµ‹ç»“æœä¸º falseï¼Œæ­¤æ—¶å°†å…¥å‚è½¬ä¸º Invoker åˆ—è¡¨\nå¯¹ä¸Šä¸€æ­¥é€»è¾‘ç”Ÿæˆçš„ç»“æœè¿›è¡Œè¿›ä¸€æ­¥å¤„ç†ï¼Œå¾—åˆ°æ–¹æ³•ååˆ° Invoker çš„æ˜ å°„å…³ç³»è¡¨\nåˆå¹¶å¤šç»„ Invoker\né”€æ¯æ— ç”¨ Invoker\n\nInvoker çš„åˆ·æ–°é€»è¾‘è¿˜æ˜¯æ¯”è¾ƒå¤æ‚çš„ï¼Œå¤§å®¶åœ¨çœ‹çš„è¿‡ç¨‹ä¸­å¤šå†™ç‚¹ demo è¿›è¡Œè°ƒè¯•ï¼Œä»¥åŠ æ·±ç†è§£ã€‚\n\n4. æ€»ç»“æœ¬ç¯‡æ–‡ç« å¯¹ Dubbo æœåŠ¡ç›®å½•è¿›è¡Œäº†è¾ƒä¸ºè¯¦ç»†çš„åˆ†æï¼Œç¯‡å¹…ä¸»è¦é›†ä¸­åœ¨ RegistryDirectory çš„æºç åˆ†æä¸Šã€‚ä»ä»£ç é‡ä¸Šå¯ä»¥çœ‹å‡ºï¼Œæƒ³è®©æœ¬åœ°æœåŠ¡ç›®å½•å’Œæ³¨å†Œä¸­å¿ƒä¿æŒä¸€è‡´è¿˜æ˜¯éœ€è¦åšå¾ˆå¤šäº‹æƒ…çš„ï¼Œå¹¶ä¸ç®€å•ã€‚æœåŠ¡ç›®å½•æ˜¯ Dubbo é›†ç¾¤å®¹é”™çš„ä¸€éƒ¨åˆ†ï¼Œä¹Ÿæ˜¯æ¯”è¾ƒåŸºç¡€çš„éƒ¨åˆ†ï¼Œæ‰€ä»¥å¤§å®¶åº”å°½é‡ææ‡‚ã€‚\n\n\n\n\n\n\n\n\n\nåŸæ–‡åœ°å€ï¼šhttps://dubbo.apache.org/zh/docsv2.7/dev/source/router/\nä½œè€…ï¼š Dubbo å®˜æ–¹\n\næœåŠ¡è·¯ç”±1. ç®€ä»‹ä¸Šä¸€ç¯‡æ–‡ç« åˆ†æäº†é›†ç¾¤å®¹é”™çš„ç¬¬ä¸€éƒ¨åˆ† â€” æœåŠ¡ç›®å½• Directoryã€‚æœåŠ¡ç›®å½•åœ¨åˆ·æ–° Invoker åˆ—è¡¨çš„è¿‡ç¨‹ä¸­ï¼Œä¼šé€šè¿‡ Router è¿›è¡ŒæœåŠ¡è·¯ç”±ï¼Œç­›é€‰å‡ºç¬¦åˆè·¯ç”±è§„åˆ™çš„æœåŠ¡æä¾›è€…ã€‚åœ¨è¯¦ç»†åˆ†ææœåŠ¡è·¯ç”±çš„æºç ä¹‹å‰ï¼Œå…ˆæ¥ä»‹ç»ä¸€ä¸‹æœåŠ¡è·¯ç”±æ˜¯ä»€ä¹ˆã€‚æœåŠ¡è·¯ç”±åŒ…å«ä¸€æ¡è·¯ç”±è§„åˆ™ï¼Œè·¯ç”±è§„åˆ™å†³å®šäº†æœåŠ¡æ¶ˆè´¹è€…çš„è°ƒç”¨ç›®æ ‡ï¼Œå³è§„å®šäº†æœåŠ¡æ¶ˆè´¹è€…å¯è°ƒç”¨å“ªäº›æœåŠ¡æä¾›è€…ã€‚Dubbo ç›®å‰æä¾›äº†ä¸‰ç§æœåŠ¡è·¯ç”±å®ç°ï¼Œåˆ†åˆ«ä¸ºï¼š\n\næ¡ä»¶è·¯ç”± ConditionRouter\nè„šæœ¬è·¯ç”± ScriptRouter\næ ‡ç­¾è·¯ç”± TagRouterã€‚\n\næ¡ä»¶è·¯ç”±æ˜¯æˆ‘ä»¬æœ€å¸¸ä½¿ç”¨çš„ï¼Œæ ‡ç­¾è·¯ç”±æ˜¯ä¸€ä¸ªæ–°çš„å®ç°ï¼Œæš‚æ—¶è¿˜æœªå‘å¸ƒï¼Œè¯¥å®ç°é¢„è®¡ä¼šåœ¨ 2.7.x ç‰ˆæœ¬ä¸­å‘å¸ƒã€‚æœ¬ç¯‡æ–‡ç« å°†åˆ†ææ¡ä»¶è·¯ç”±ç›¸å…³æºç ï¼Œè„šæœ¬è·¯ç”±å’Œæ ‡ç­¾è·¯ç”±è¿™é‡Œå°±ä¸åˆ†æäº†ã€‚\n\n2. æºç åˆ†ææ¡ä»¶è·¯ç”±è§„åˆ™ç”±ä¸¤ä¸ªæ¡ä»¶ç»„æˆï¼Œåˆ†åˆ«ç”¨äºå¯¹æœåŠ¡æ¶ˆè´¹è€…å’Œæä¾›è€…è¿›è¡ŒåŒ¹é…ã€‚æ¯”å¦‚æœ‰è¿™æ ·ä¸€æ¡è§„åˆ™ï¼š\nhost &#x3D; 10.20.153.10 &#x3D;&gt; host &#x3D; 10.20.153.11\n\nè¯¥æ¡è§„åˆ™è¡¨ç¤º IP ä¸º 10.20.153.10 çš„æœåŠ¡æ¶ˆè´¹è€…åªå¯è°ƒç”¨ IP ä¸º 10.20.153.11 æœºå™¨ä¸Šçš„æœåŠ¡ï¼Œä¸å¯è°ƒç”¨å…¶ä»–æœºå™¨ä¸Šçš„æœåŠ¡ã€‚æ¡ä»¶è·¯ç”±è§„åˆ™çš„æ ¼å¼å¦‚ä¸‹ï¼š\n[æœåŠ¡æ¶ˆè´¹è€…åŒ¹é…æ¡ä»¶] &#x3D;&gt; [æœåŠ¡æä¾›è€…åŒ¹é…æ¡ä»¶]\n\nå¦‚æœæœåŠ¡æ¶ˆè´¹è€…åŒ¹é…æ¡ä»¶ä¸ºç©ºï¼Œè¡¨ç¤ºä¸å¯¹æœåŠ¡æ¶ˆè´¹è€…è¿›è¡Œé™åˆ¶ã€‚å¦‚æœæœåŠ¡æä¾›è€…åŒ¹é…æ¡ä»¶ä¸ºç©ºï¼Œè¡¨ç¤ºå¯¹æŸäº›æœåŠ¡æ¶ˆè´¹è€…ç¦ç”¨æœåŠ¡ã€‚å®˜æ–¹æ–‡æ¡£ä¸­å¯¹æ¡ä»¶è·¯ç”±è¿›è¡Œäº†æ¯”è¾ƒè¯¦ç»†çš„ä»‹ç»ï¼Œå¤§å®¶å¯ä»¥å‚è€ƒä¸‹ï¼Œè¿™é‡Œå°±ä¸è¿‡å¤šè¯´æ˜äº†ã€‚\næ¡ä»¶è·¯ç”±å®ç°ç±» ConditionRouter åœ¨è¿›è¡Œå·¥ä½œå‰ï¼Œéœ€è¦å…ˆå¯¹ç”¨æˆ·é…ç½®çš„è·¯ç”±è§„åˆ™è¿›è¡Œè§£æï¼Œå¾—åˆ°ä¸€ç³»åˆ—çš„æ¡ä»¶ã€‚ç„¶åå†æ ¹æ®è¿™äº›æ¡ä»¶å¯¹æœåŠ¡è¿›è¡Œè·¯ç”±ã€‚æœ¬ç« å°†åˆ†ä¸¤èŠ‚è¿›è¡Œè¯´æ˜ï¼Œ2.1èŠ‚ä»‹ç»è¡¨è¾¾å¼è§£æè¿‡ç¨‹ã€‚2.2 èŠ‚ä»‹ç»æœåŠ¡è·¯ç”±çš„è¿‡ç¨‹ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬å…ˆä»è¡¨è¾¾å¼è§£æè¿‡ç¨‹çœ‹èµ·ã€‚\n\n2.1 è¡¨è¾¾å¼è§£ææ¡ä»¶è·¯ç”±è§„åˆ™æ˜¯ä¸€æ¡å­—ç¬¦ä¸²ï¼Œå¯¹äº Dubbo æ¥è¯´ï¼Œå®ƒå¹¶ä¸èƒ½ç›´æ¥ç†è§£å­—ç¬¦ä¸²çš„æ„æ€ï¼Œéœ€è¦å°†å…¶è§£ææˆå†…éƒ¨æ ¼å¼æ‰è¡Œã€‚æ¡ä»¶è¡¨è¾¾å¼çš„è§£æè¿‡ç¨‹å§‹äº ConditionRouter çš„æ„é€ æ–¹æ³•ï¼Œä¸‹é¢ä¸€èµ·çœ‹ä¸€ä¸‹ï¼š\npublic ConditionRouter(URL url) &#123;\n    this.url = url;\n    // è·å– priority å’Œ force é…ç½®\n    this.priority = url.getParameter(Constants.PRIORITY_KEY, 0);\n    this.force = url.getParameter(Constants.FORCE_KEY, false);\n    try &#123;\n        // è·å–è·¯ç”±è§„åˆ™\n        String rule = url.getParameterAndDecoded(Constants.RULE_KEY);\n        if (rule == null || rule.trim().length() == 0) &#123;\n            throw new IllegalArgumentException(\"Illegal route rule!\");\n        &#125;\n        rule = rule.replace(\"consumer.\", \"\").replace(\"provider.\", \"\");\n        // å®šä½ => åˆ†éš”ç¬¦\n        int i = rule.indexOf(\"=>\");\n        // åˆ†åˆ«è·å–æœåŠ¡æ¶ˆè´¹è€…å’Œæä¾›è€…åŒ¹é…è§„åˆ™\n        String whenRule = i &lt; 0 ? null : rule.substring(0, i).trim();\n        String thenRule = i &lt; 0 ? rule.trim() : rule.substring(i + 2).trim();\n        // è§£ææœåŠ¡æ¶ˆè´¹è€…åŒ¹é…è§„åˆ™\n        Map&lt;String, MatchPair> when = \n            StringUtils.isBlank(whenRule) || \"true\".equals(whenRule) \n                ? new HashMap&lt;String, MatchPair>() : parseRule(whenRule);\n        // è§£ææœåŠ¡æä¾›è€…åŒ¹é…è§„åˆ™\n        Map&lt;String, MatchPair> then = \n            StringUtils.isBlank(thenRule) || \"false\".equals(thenRule) \n                ? null : parseRule(thenRule);\n        // å°†è§£æå‡ºçš„åŒ¹é…è§„åˆ™åˆ†åˆ«èµ‹å€¼ç»™ whenCondition å’Œ thenCondition æˆå‘˜å˜é‡\n        this.whenCondition = when;\n        this.thenCondition = then;\n    &#125; catch (ParseException e) &#123;\n        throw new IllegalStateException(e.getMessage(), e);\n    &#125;\n&#125;\n\nå¦‚ä¸Šï¼ŒConditionRouter æ„é€ æ–¹æ³•å…ˆæ˜¯å¯¹è·¯ç”±è§„åˆ™åšé¢„å¤„ç†ï¼Œç„¶åè°ƒç”¨ parseRule æ–¹æ³•åˆ†åˆ«å¯¹æœåŠ¡æä¾›è€…å’Œæ¶ˆè´¹è€…è§„åˆ™è¿›è¡Œè§£æï¼Œæœ€åå°†è§£æç»“æœèµ‹å€¼ç»™ whenCondition å’Œ thenCondition æˆå‘˜å˜é‡ã€‚ConditionRouter æ„é€ æ–¹æ³•ä¸æ˜¯å¾ˆå¤æ‚ï¼Œè¿™é‡Œå°±ä¸å¤šè¯´äº†ã€‚ä¸‹é¢æˆ‘ä»¬æŠŠé‡ç‚¹æ”¾åœ¨ parseRule æ–¹æ³•ä¸Šï¼Œåœ¨è¯¦ç»†ä»‹ç»è¿™ä¸ªæ–¹æ³•ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸ªå†…éƒ¨ç±»ã€‚\nprivate static final class MatchPair &#123;\n    final Set&lt;String> matches = new HashSet&lt;String>();\n    final Set&lt;String> mismatches = new HashSet&lt;String>();\n&#125;\n\nMatchPair å†…éƒ¨åŒ…å«äº†ä¸¤ä¸ª Set ç±»å‹çš„æˆå‘˜å˜é‡ï¼Œåˆ†åˆ«ç”¨äºå­˜æ”¾åŒ¹é…å’Œä¸åŒ¹é…çš„æ¡ä»¶ã€‚è¿™ä¸ªç±»ä¸¤ä¸ªæˆå‘˜å˜é‡ä¼šåœ¨ parseRule æ–¹æ³•ä¸­è¢«ç”¨åˆ°ï¼Œä¸‹é¢æ¥çœ‹ä¸€ä¸‹ã€‚\nprivate static Map&lt;String, MatchPair> parseRule(String rule)\n        throws ParseException &#123;\n    // å®šä¹‰æ¡ä»¶æ˜ å°„é›†åˆ\n    Map&lt;String, MatchPair> condition = new HashMap&lt;String, MatchPair>();\n    if (StringUtils.isBlank(rule)) &#123;\n        return condition;\n    &#125;\n    MatchPair pair = null;\n    Set&lt;String> values = null;\n    // é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…è·¯ç”±è§„åˆ™ï¼ŒROUTE_PATTERN = ([&amp;!=,]*)\\s*([^&amp;!=,\\s]+)\n    // è¿™ä¸ªè¡¨è¾¾å¼çœ‹èµ·æ¥ä¸æ˜¯å¾ˆå¥½ç†è§£ï¼Œç¬¬ä¸€ä¸ªæ‹¬å·å†…çš„è¡¨è¾¾å¼ç”¨äºåŒ¹é…\"&amp;\", \"!\", \"=\" å’Œ \",\" ç­‰ç¬¦å·ã€‚\n    // ç¬¬äºŒæ‹¬å·å†…çš„ç”¨äºåŒ¹é…è‹±æ–‡å­—æ¯ï¼Œæ•°å­—ç­‰å­—ç¬¦ã€‚ä¸¾ä¸ªä¾‹å­è¯´æ˜ä¸€ä¸‹ï¼š\n    //    host = 2.2.2.2 &amp; host != 1.1.1.1 &amp; method = hello\n    // åŒ¹é…ç»“æœå¦‚ä¸‹ï¼š\n    //     æ‹¬å·ä¸€      æ‹¬å·äºŒ\n    // 1.  null       host\n    // 2.   =         2.2.2.2\n    // 3.   &amp;         host\n    // 4.   !=        1.1.1.1 \n    // 5.   &amp;         method\n    // 6.   =         hello\n    final Matcher matcher = ROUTE_PATTERN.matcher(rule);\n    while (matcher.find()) &#123;\n       \t// è·å–æ‹¬å·ä¸€å†…çš„åŒ¹é…ç»“æœ\n        String separator = matcher.group(1);\n        // è·å–æ‹¬å·äºŒå†…çš„åŒ¹é…ç»“æœ\n        String content = matcher.group(2);\n        // åˆ†éš”ç¬¦ä¸ºç©ºï¼Œè¡¨ç¤ºåŒ¹é…çš„æ˜¯è¡¨è¾¾å¼çš„å¼€å§‹éƒ¨åˆ†\n        if (separator == null || separator.length() == 0) &#123;\n            // åˆ›å»º MatchPair å¯¹è±¡\n            pair = new MatchPair();\n            // å­˜å‚¨ &lt;åŒ¹é…é¡¹, MatchPair> é”®å€¼å¯¹ï¼Œæ¯”å¦‚ &lt;host, MatchPair>\n            condition.put(content, pair); \n        &#125; \n        \n        // å¦‚æœåˆ†éš”ç¬¦ä¸º &amp;ï¼Œè¡¨æ˜æ¥ä¸‹æ¥ä¹Ÿæ˜¯ä¸€ä¸ªæ¡ä»¶\n        else if (\"&amp;\".equals(separator)) &#123;\n            // å°è¯•ä» condition è·å– MatchPair\n            if (condition.get(content) == null) &#123;\n                // æœªè·å–åˆ° MatchPairï¼Œé‡æ–°åˆ›å»ºä¸€ä¸ªï¼Œå¹¶æ”¾å…¥ condition ä¸­\n                pair = new MatchPair();\n                condition.put(content, pair);\n            &#125; else &#123;\n                pair = condition.get(content);\n            &#125;\n        &#125; \n        \n        // åˆ†éš”ç¬¦ä¸º =\n        else if (\"=\".equals(separator)) &#123;\n            if (pair == null)\n                throw new ParseException(\"Illegal route rule ...\");\n\n            values = pair.matches;\n            // å°† content å­˜å…¥åˆ° MatchPair çš„ matches é›†åˆä¸­\n            values.add(content);\n        &#125; \n        \n        //  åˆ†éš”ç¬¦ä¸º != \n        else if (\"!=\".equals(separator)) &#123;\n            if (pair == null)\n                throw new ParseException(\"Illegal route rule ...\");\n\n            values = pair.mismatches;\n            // å°† content å­˜å…¥åˆ° MatchPair çš„ mismatches é›†åˆä¸­\n            values.add(content);\n        &#125;\n        \n        // åˆ†éš”ç¬¦ä¸º ,\n        else if (\",\".equals(separator)) &#123;\n            if (values == null || values.isEmpty())\n                throw new ParseException(\"Illegal route rule ...\");\n            // å°† content å­˜å…¥åˆ°ä¸Šä¸€æ­¥è·å–åˆ°çš„ values ä¸­ï¼Œå¯èƒ½æ˜¯ matchesï¼Œä¹Ÿå¯èƒ½æ˜¯ mismatches\n            values.add(content);\n        &#125; else &#123;\n            throw new ParseException(\"Illegal route rule ...\");\n        &#125;\n    &#125;\n    return condition;\n&#125;\n\nä»¥ä¸Šå°±æ˜¯è·¯ç”±è§„åˆ™çš„è§£æé€»è¾‘ï¼Œè¯¥é€»è¾‘ç”±æ­£åˆ™è¡¨è¾¾å¼å’Œä¸€ä¸ª while å¾ªç¯ä»¥åŠæ•°ä¸ªæ¡ä»¶åˆ†æ”¯ç»„æˆã€‚ä¸‹é¢é€šè¿‡ä¸€ä¸ªç¤ºä¾‹å¯¹è§£æé€»è¾‘è¿›è¡Œæ¼”ç»ã€‚ç¤ºä¾‹ä¸º host = 2.2.2.2 &amp; host != 1.1.1.1 &amp; method = helloã€‚æ­£åˆ™è§£æç»“æœå¦‚ä¸‹ï¼š\n    æ‹¬å·ä¸€      æ‹¬å·äºŒ\n1.  null       host\n2.   &#x3D;         2.2.2.2\n3.   &amp;         host\n4.   !&#x3D;        1.1.1.1\n5.   &amp;         method\n6.   &#x3D;         hello\n\nç°åœ¨çº¿ç¨‹è¿›å…¥ while å¾ªç¯ï¼š\nç¬¬ä¸€æ¬¡å¾ªç¯ï¼šåˆ†éš”ç¬¦ separator &#x3D; nullï¼Œcontent &#x3D; â€œhostâ€ã€‚æ­¤æ—¶åˆ›å»º MatchPair å¯¹è±¡ï¼Œå¹¶å­˜å…¥åˆ° condition ä¸­ï¼Œcondition &#x3D; {â€œhostâ€: MatchPair@123}\nç¬¬äºŒæ¬¡å¾ªç¯ï¼šåˆ†éš”ç¬¦ separator &#x3D; â€œ&#x3D;â€ï¼Œcontent &#x3D; â€œ2.2.2.2â€ï¼Œpair &#x3D; MatchPair@123ã€‚æ­¤æ—¶å°† 2.2.2.2 æ”¾å…¥åˆ° MatchPair@123  å¯¹è±¡çš„ matches é›†åˆä¸­ã€‚ \nç¬¬ä¸‰æ¬¡å¾ªç¯ï¼šåˆ†éš”ç¬¦ separator &#x3D; â€œ&amp;â€ï¼Œcontent &#x3D; â€œhostâ€ã€‚host å·²å­˜åœ¨äº condition ä¸­ï¼Œå› æ­¤ pair &#x3D; MatchPair@123ã€‚\nç¬¬å››æ¬¡å¾ªç¯ï¼šåˆ†éš”ç¬¦ separator &#x3D; â€œ!&#x3D;â€ï¼Œcontent &#x3D; â€œ1.1.1.1â€ï¼Œpair &#x3D; MatchPair@123ã€‚æ­¤æ—¶å°† 1.1.1.1 æ”¾å…¥åˆ° MatchPair@123  å¯¹è±¡çš„ mismatches é›†åˆä¸­ã€‚ \nç¬¬äº”æ¬¡å¾ªç¯ï¼šåˆ†éš”ç¬¦ separator &#x3D; â€œ&amp;â€ï¼Œcontent &#x3D; â€œmethodâ€ã€‚condition.get(â€œmethodâ€) &#x3D; nullï¼Œå› æ­¤æ–°å»ºä¸€ä¸ª MatchPair å¯¹è±¡ï¼Œå¹¶æ”¾å…¥åˆ° condition ä¸­ã€‚æ­¤æ—¶ condition &#x3D; {â€œhostâ€: MatchPair@123, â€œmethodâ€: MatchPair@ 456}\nç¬¬å…­æ¬¡å¾ªç¯ï¼šåˆ†éš”ç¬¦ separator &#x3D; â€œ&#x3D;â€ï¼Œcontent &#x3D; â€œ2.2.2.2â€ï¼Œpair &#x3D; MatchPair@456ã€‚æ­¤æ—¶å°† hello æ”¾å…¥åˆ° MatchPair@456  å¯¹è±¡çš„ matches é›†åˆä¸­ã€‚ \nå¾ªç¯ç»“æŸï¼Œæ­¤æ—¶ condition çš„å†…å®¹å¦‚ä¸‹ï¼š\n&#123;\n    \"host\": &#123;\n        \"matches\": [\"2.2.2.2\"],\n        \"mismatches\": [\"1.1.1.1\"]\n    &#125;,\n    \"method\": &#123;\n        \"matches\": [\"hello\"],\n        \"mismatches\": []\n    &#125;\n&#125;\n\nè·¯ç”±è§„åˆ™çš„è§£æè¿‡ç¨‹ç¨å¾®æœ‰ç‚¹å¤æ‚ï¼Œå¤§å®¶å¯é€šè¿‡ ConditionRouter çš„æµ‹è¯•ç±»å¯¹è¯¥é€»è¾‘è¿›è¡Œæµ‹è¯•ã€‚å¹¶ä¸”æ‰¾ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œå¯¹ç…§ä¸Šé¢çš„ä»£ç èµ°ä¸€éï¼ŒåŠ æ·±ç†è§£ã€‚\n\n2.2 æœåŠ¡è·¯ç”±æœåŠ¡è·¯ç”±çš„å…¥å£æ–¹æ³•æ˜¯ ConditionRouter çš„ route æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å®šä¹‰åœ¨ Router æ¥å£ä¸­ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š\npublic &lt;T> List&lt;Invoker&lt;T>> route(List&lt;Invoker&lt;T>> invokers, URL url, Invocation invocation) throws RpcException &#123;\n    if (invokers == null || invokers.isEmpty()) &#123;\n        return invokers;\n    &#125;\n    try &#123;\n        // å…ˆå¯¹æœåŠ¡æ¶ˆè´¹è€…æ¡ä»¶è¿›è¡ŒåŒ¹é…ï¼Œå¦‚æœåŒ¹é…å¤±è´¥ï¼Œè¡¨æ˜æœåŠ¡æ¶ˆè´¹è€… url ä¸ç¬¦åˆåŒ¹é…è§„åˆ™ï¼Œ\n        // æ— éœ€è¿›è¡Œåç»­åŒ¹é…ï¼Œç›´æ¥è¿”å› Invoker åˆ—è¡¨å³å¯ã€‚æ¯”å¦‚ä¸‹é¢çš„è§„åˆ™ï¼š\n        //     host = 10.20.153.10 => host = 10.0.0.10\n        // è¿™æ¡è·¯ç”±è§„åˆ™å¸Œæœ› IP ä¸º 10.20.153.10 çš„æœåŠ¡æ¶ˆè´¹è€…è°ƒç”¨ IP ä¸º 10.0.0.10 æœºå™¨ä¸Šçš„æœåŠ¡ã€‚\n        // å½“æ¶ˆè´¹è€… ip ä¸º 10.20.153.11 æ—¶ï¼ŒmatchWhen è¿”å› falseï¼Œè¡¨æ˜å½“å‰è¿™æ¡è·¯ç”±è§„åˆ™ä¸é€‚ç”¨äº\n        // å½“å‰çš„æœåŠ¡æ¶ˆè´¹è€…ï¼Œæ­¤æ—¶æ— éœ€å†è¿›è¡Œåç»­åŒ¹é…ï¼Œç›´æ¥è¿”å›å³å¯ã€‚\n        if (!matchWhen(url, invocation)) &#123;\n            return invokers;\n        &#125;\n        List&lt;Invoker&lt;T>> result = new ArrayList&lt;Invoker&lt;T>>();\n        // æœåŠ¡æä¾›è€…åŒ¹é…æ¡ä»¶æœªé…ç½®ï¼Œè¡¨æ˜å¯¹æŒ‡å®šçš„æœåŠ¡æ¶ˆè´¹è€…ç¦ç”¨æœåŠ¡ï¼Œä¹Ÿå°±æ˜¯æœåŠ¡æ¶ˆè´¹è€…åœ¨é»‘åå•ä¸­\n        if (thenCondition == null) &#123;\n            logger.warn(\"The current consumer in the service blacklist...\");\n            return result;\n        &#125;\n        // è¿™é‡Œå¯ä»¥ç®€å•çš„æŠŠ Invoker ç†è§£ä¸ºæœåŠ¡æä¾›è€…ï¼Œç°åœ¨ä½¿ç”¨æœåŠ¡æä¾›è€…åŒ¹é…è§„åˆ™å¯¹ \n        // Invoker åˆ—è¡¨è¿›è¡ŒåŒ¹é…\n        for (Invoker&lt;T> invoker : invokers) &#123;\n            // è‹¥åŒ¹é…æˆåŠŸï¼Œè¡¨æ˜å½“å‰ Invoker ç¬¦åˆæœåŠ¡æä¾›è€…åŒ¹é…è§„åˆ™ã€‚\n            // æ­¤æ—¶å°† Invoker æ·»åŠ åˆ° result åˆ—è¡¨ä¸­\n            if (matchThen(invoker.getUrl(), url)) &#123;\n                result.add(invoker);\n            &#125;\n        &#125;\n        \n        // è¿”å›åŒ¹é…ç»“æœï¼Œå¦‚æœ result ä¸ºç©ºåˆ—è¡¨ï¼Œä¸” force = trueï¼Œè¡¨ç¤ºå¼ºåˆ¶è¿”å›ç©ºåˆ—è¡¨ï¼Œ\n        // å¦åˆ™è·¯ç”±ç»“æœä¸ºç©ºçš„è·¯ç”±è§„åˆ™å°†è‡ªåŠ¨å¤±æ•ˆ\n        if (!result.isEmpty()) &#123;\n            return result;\n        &#125; else if (force) &#123;\n            logger.warn(\"The route result is empty and force execute ...\");\n            return result;\n        &#125;\n    &#125; catch (Throwable t) &#123;\n        logger.error(\"Failed to execute condition router rule: ...\");\n    &#125;\n    \n    // åŸæ ·è¿”å›ï¼Œæ­¤æ—¶ force = falseï¼Œè¡¨ç¤ºè¯¥æ¡è·¯ç”±è§„åˆ™å¤±æ•ˆ\n    return invokers;\n&#125;\n\nroute æ–¹æ³•å…ˆæ˜¯è°ƒç”¨ matchWhen å¯¹æœåŠ¡æ¶ˆè´¹è€…è¿›è¡ŒåŒ¹é…ï¼Œå¦‚æœåŒ¹é…å¤±è´¥ï¼Œç›´æ¥è¿”å› Invoker åˆ—è¡¨ã€‚å¦‚æœåŒ¹é…æˆåŠŸï¼Œå†å¯¹æœåŠ¡æä¾›è€…è¿›è¡ŒåŒ¹é…ï¼ŒåŒ¹é…é€»è¾‘å°è£…åœ¨äº† matchThen æ–¹æ³•ä¸­ã€‚ä¸‹é¢æ¥çœ‹ä¸€ä¸‹è¿™ä¸¤ä¸ªæ–¹æ³•çš„é€»è¾‘ï¼š\nboolean matchWhen(URL url, Invocation invocation) &#123;\n    // æœåŠ¡æ¶ˆè´¹è€…æ¡ä»¶ä¸º null æˆ–ç©ºï¼Œå‡è¿”å› trueï¼Œæ¯”å¦‚ï¼š\n    //     => host != 172.22.3.91\n    // è¡¨ç¤ºæ‰€æœ‰çš„æœåŠ¡æ¶ˆè´¹è€…éƒ½ä¸å¾—è°ƒç”¨ IP ä¸º 172.22.3.91 çš„æœºå™¨ä¸Šçš„æœåŠ¡\n    return whenCondition == null || whenCondition.isEmpty() \n        || matchCondition(whenCondition, url, null, invocation);  // è¿›è¡Œæ¡ä»¶åŒ¹é…\n&#125;\n\nprivate boolean matchThen(URL url, URL param) &#123;\n    // æœåŠ¡æä¾›è€…æ¡ä»¶ä¸º null æˆ–ç©ºï¼Œè¡¨ç¤ºç¦ç”¨æœåŠ¡\n    return !(thenCondition == null || thenCondition.isEmpty()) \n        &amp;&amp; matchCondition(thenCondition, url, param, null);  // è¿›è¡Œæ¡ä»¶åŒ¹é…\n&#125;\n\nè¿™ä¸¤ä¸ªæ–¹æ³•é•¿çš„æœ‰ç‚¹åƒï¼Œä¸è¿‡é€»è¾‘ä¸Šè¿˜æ˜¯æœ‰å·®åˆ«çš„ï¼Œå¤§å®¶æ³¨æ„çœ‹ã€‚è¿™ä¸¤ä¸ªæ–¹æ³•å‡è°ƒç”¨äº† matchCondition æ–¹æ³•ï¼Œä½†å®ƒä»¬æ‰€ä¼ å…¥çš„å‚æ•°æ˜¯ä¸åŒçš„ã€‚è¿™ä¸ªéœ€è¦ç‰¹åˆ«æ³¨æ„ä¸€ä¸‹ï¼Œä¸ç„¶åé¢çš„é€»è¾‘ä¸å¥½å¼„æ‡‚ã€‚ä¸‹é¢æˆ‘ä»¬å¯¹è¿™å‡ ä¸ªå‚æ•°è¿›è¡Œæº¯æºã€‚matchWhen æ–¹æ³•å‘ matchCondition æ–¹æ³•ä¼ å…¥çš„å‚æ•°ä¸º [whenCondition, url, null, invocation]ï¼Œç¬¬ä¸€ä¸ªå‚æ•° whenCondition ä¸ºæœåŠ¡æ¶ˆè´¹è€…åŒ¹é…æ¡ä»¶ï¼Œè¿™ä¸ªå‰é¢åˆ†æè¿‡ã€‚ç¬¬äºŒä¸ªå‚æ•° url æºè‡ª route æ–¹æ³•çš„å‚æ•°åˆ—è¡¨ï¼Œè¯¥å‚æ•°ç”±å¤–éƒ¨ç±»è°ƒç”¨ route æ–¹æ³•æ—¶ä¼ å…¥ã€‚æ¯”å¦‚ï¼š\nprivate List&lt;Invoker&lt;T>> route(List&lt;Invoker&lt;T>> invokers, String method) &#123;\n    Invocation invocation = new RpcInvocation(method, new Class&lt;?>[0], new Object[0]);\n    List&lt;Router> routers = getRouters();\n    if (routers != null) &#123;\n        for (Router router : routers) &#123;\n            if (router.getUrl() != null) &#123;\n                // æ³¨æ„ç¬¬äºŒä¸ªå‚æ•°\n                invokers = router.route(invokers, getConsumerUrl(), invocation);\n            &#125;\n        &#125;\n    &#125;\n    return invokers;\n&#125;\n\nä¸Šé¢è¿™æ®µä»£ç æ¥è‡ª RegistryDirectoryï¼Œç¬¬äºŒä¸ªå‚æ•°è¡¨ç¤ºçš„æ˜¯æœåŠ¡æ¶ˆè´¹è€… urlã€‚matchCondition çš„ invocation å‚æ•°ä¹Ÿæ˜¯ä»è¿™é‡Œä¼ å…¥çš„ã€‚\næ¥ä¸‹æ¥å†æ¥çœ‹çœ‹ matchThen å‘ matchCondition æ–¹æ³•ä¼ å…¥çš„å‚æ•° [thenCondition, url, param, null]ã€‚ç¬¬ä¸€ä¸ªå‚æ•°ä¸ç”¨è§£é‡Šäº†ã€‚ç¬¬äºŒä¸ªå’Œç¬¬ä¸‰ä¸ªå‚æ•°æ¥è‡ª matchThen æ–¹æ³•çš„å‚æ•°åˆ—è¡¨ï¼Œè¿™ä¸¤ä¸ªå‚æ•°åˆ†åˆ«ä¸ºæœåŠ¡æä¾›è€… url å’ŒæœåŠ¡æ¶ˆè´¹è€… urlã€‚ææ¸…æ¥šè¿™äº›å‚æ•°æ¥æºåï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥åˆ†æ matchCondition æ–¹æ³•äº†ã€‚\nprivate boolean matchCondition(Map&lt;String, MatchPair> condition, URL url, URL param, Invocation invocation) &#123;\n    // å°†æœåŠ¡æä¾›è€…æˆ–æ¶ˆè´¹è€… url è½¬æˆ Map\n    Map&lt;String, String> sample = url.toMap();\n    boolean result = false;\n    // éå† condition åˆ—è¡¨\n    for (Map.Entry&lt;String, MatchPair> matchPair : condition.entrySet()) &#123;\n        // è·å–åŒ¹é…é¡¹åç§°ï¼Œæ¯”å¦‚ hostã€method ç­‰\n        String key = matchPair.getKey();\n        String sampleValue;\n        // å¦‚æœ invocation ä¸ä¸ºç©ºï¼Œä¸” key ä¸º method(s)ï¼Œè¡¨ç¤ºè¿›è¡Œæ–¹æ³•åŒ¹é…\n        if (invocation != null &amp;&amp; (Constants.METHOD_KEY.equals(key) || Constants.METHODS_KEY.equals(key))) &#123;\n            // ä» invocation è·å–è¢«è°ƒç”¨æ–¹æ³•çš„åç§°\n            sampleValue = invocation.getMethodName();\n        &#125; else &#123;\n            // ä»æœåŠ¡æä¾›è€…æˆ–æ¶ˆè´¹è€… url ä¸­è·å–æŒ‡å®šå­—æ®µå€¼ï¼Œæ¯”å¦‚ hostã€application ç­‰\n            sampleValue = sample.get(key);\n            if (sampleValue == null) &#123;\n                // å°è¯•é€šè¿‡ default.xxx è·å–ç›¸åº”çš„å€¼\n                sampleValue = sample.get(Constants.DEFAULT_KEY_PREFIX + key);\n            &#125;\n        &#125;\n        \n        // --------------------âœ¨ åˆ†å‰²çº¿ âœ¨-------------------- //\n        \n        if (sampleValue != null) &#123;\n            // è°ƒç”¨ MatchPair çš„ isMatch æ–¹æ³•è¿›è¡ŒåŒ¹é…\n            if (!matchPair.getValue().isMatch(sampleValue, param)) &#123;\n                // åªè¦æœ‰ä¸€ä¸ªè§„åˆ™åŒ¹é…å¤±è´¥ï¼Œç«‹å³è¿”å› false ç»“æŸæ–¹æ³•é€»è¾‘\n                return false;\n            &#125; else &#123;\n                result = true;\n            &#125;\n        &#125; else &#123;\n            // sampleValue ä¸ºç©ºï¼Œè¡¨æ˜æœåŠ¡æä¾›è€…æˆ–æ¶ˆè´¹è€… url ä¸­ä¸åŒ…å«ç›¸å…³å­—æ®µã€‚æ­¤æ—¶å¦‚æœ \n            // MatchPair çš„ matches ä¸ä¸ºç©ºï¼Œè¡¨ç¤ºåŒ¹é…å¤±è´¥ï¼Œè¿”å› falseã€‚æ¯”å¦‚æˆ‘ä»¬æœ‰è¿™æ ·\n            // ä¸€æ¡åŒ¹é…æ¡ä»¶ loadbalance = randomï¼Œå‡è®¾ url ä¸­å¹¶ä¸åŒ…å« loadbalance å‚æ•°ï¼Œ\n            // æ­¤æ—¶ sampleValue = nullã€‚æ—¢ç„¶è·¯ç”±è§„åˆ™é‡Œé™åˆ¶äº† loadbalance å¿…é¡»ä¸º randomï¼Œ\n            // ä½† sampleValue = nullï¼Œæ˜æ˜¾ä¸ç¬¦åˆè§„åˆ™ï¼Œå› æ­¤è¿”å› false\n            if (!matchPair.getValue().matches.isEmpty()) &#123;\n                return false;\n            &#125; else &#123;\n                result = true;\n            &#125;\n        &#125;\n    &#125;\n    return result;\n&#125;\n\nå¦‚ä¸Šï¼ŒmatchCondition æ–¹æ³•çœ‹èµ·æ¥æœ‰ç‚¹å¤æ‚ï¼Œè¿™é‡Œç®€å•è¯´æ˜ä¸€ä¸‹ã€‚åˆ†å‰²çº¿ä»¥ä¸Šçš„ä»£ç å®é™…ä¸Šç”¨äºè·å– sampleValue çš„å€¼ï¼Œåˆ†å‰²çº¿ä»¥ä¸‹æ‰æ˜¯è¿›è¡Œæ¡ä»¶åŒ¹é…ã€‚æ¡ä»¶åŒ¹é…è°ƒç”¨çš„é€»è¾‘å°è£…åœ¨ isMatch ä¸­ï¼Œä»£ç å¦‚ä¸‹ï¼š\nprivate boolean isMatch(String value, URL param) &#123;\n    // æƒ…å†µä¸€ï¼šmatches éç©ºï¼Œmismatches ä¸ºç©º\n    if (!matches.isEmpty() &amp;&amp; mismatches.isEmpty()) &#123;\n        // éå† matches é›†åˆï¼Œæ£€æµ‹å…¥å‚ value æ˜¯å¦èƒ½è¢« matches é›†åˆå…ƒç´ åŒ¹é…åˆ°ã€‚\n        // ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœ value = 10.20.153.11ï¼Œmatches = [10.20.153.*],\n        // æ­¤æ—¶ isMatchGlobPattern æ–¹æ³•è¿”å› true\n        for (String match : matches) &#123;\n            if (UrlUtils.isMatchGlobPattern(match, value, param)) &#123;\n                return true;\n            &#125;\n        &#125;\n        \n        // å¦‚æœæ‰€æœ‰åŒ¹é…é¡¹éƒ½æ— æ³•åŒ¹é…åˆ°å…¥å‚ï¼Œåˆ™è¿”å› false\n        return false;\n    &#125;\n\n    // æƒ…å†µäºŒï¼šmatches ä¸ºç©ºï¼Œmismatches éç©º\n    if (!mismatches.isEmpty() &amp;&amp; matches.isEmpty()) &#123;\n        for (String mismatch : mismatches) &#123;\n            // åªè¦å…¥å‚è¢« mismatches é›†åˆä¸­çš„ä»»æ„ä¸€ä¸ªå…ƒç´ åŒ¹é…åˆ°ï¼Œå°±è¿”å› false\n            if (UrlUtils.isMatchGlobPattern(mismatch, value, param)) &#123;\n                return false;\n            &#125;\n        &#125;\n        // mismatches é›†åˆä¸­æ‰€æœ‰å…ƒç´ éƒ½æ— æ³•åŒ¹é…åˆ°å…¥å‚ï¼Œæ­¤æ—¶è¿”å› true\n        return true;\n    &#125;\n\n    // æƒ…å†µä¸‰ï¼šmatches éç©ºï¼Œmismatches éç©º\n    if (!matches.isEmpty() &amp;&amp; !mismatches.isEmpty()) &#123;\n        // matches å’Œ mismatches å‡ä¸ºéç©ºï¼Œæ­¤æ—¶ä¼˜å…ˆä½¿ç”¨ mismatches é›†åˆå…ƒç´ å¯¹å…¥å‚è¿›è¡ŒåŒ¹é…ã€‚\n        // åªè¦ mismatches é›†åˆä¸­ä»»æ„ä¸€ä¸ªå…ƒç´ ä¸å…¥å‚åŒ¹é…æˆåŠŸï¼Œå°±ç«‹å³è¿”å› falseï¼Œç»“æŸæ–¹æ³•é€»è¾‘\n        for (String mismatch : mismatches) &#123;\n            if (UrlUtils.isMatchGlobPattern(mismatch, value, param)) &#123;\n                return false;\n            &#125;\n        &#125;\n        // mismatches é›†åˆå…ƒç´ æ— æ³•åŒ¹é…åˆ°å…¥å‚ï¼Œæ­¤æ—¶å†ä½¿ç”¨ matches ç»§ç»­åŒ¹é…\n        for (String match : matches) &#123;\n            // åªè¦ matches é›†åˆä¸­ä»»æ„ä¸€ä¸ªå…ƒç´ ä¸å…¥å‚åŒ¹é…æˆåŠŸï¼Œå°±ç«‹å³è¿”å› true\n            if (UrlUtils.isMatchGlobPattern(match, value, param)) &#123;\n                return true;\n            &#125;\n        &#125;\n        \n        // å…¨éƒ¨å¤±é…ï¼Œåˆ™è¿”å› false\n        return false;\n    &#125;\n    \n    // æƒ…å†µå››ï¼šmatches å’Œ mismatches å‡ä¸ºç©ºï¼Œæ­¤æ—¶è¿”å› false\n    return false;\n&#125;\n\nisMatch æ–¹æ³•é€»è¾‘æ¯”è¾ƒæ¸…æ™°ï¼Œç”±ä¸‰ä¸ªæ¡ä»¶åˆ†æ”¯ç»„æˆï¼Œç”¨äºå¤„ç†å››ç§æƒ…å†µã€‚è¿™é‡Œå¯¹å››ç§æƒ…å†µä¸‹çš„åŒ¹é…é€»è¾‘è¿›è¡Œç®€å•çš„æ€»ç»“ï¼Œå¦‚ä¸‹ï¼š\n\n\n\n\næ¡ä»¶\nè¿‡ç¨‹\n\n\n\næƒ…å†µä¸€\nmatches éç©ºï¼Œmismatches ä¸ºç©º\néå† matches é›†åˆå…ƒç´ ï¼Œå¹¶ä¸å…¥å‚è¿›è¡ŒåŒ¹é…ã€‚åªè¦æœ‰ä¸€ä¸ªå…ƒç´ æˆåŠŸåŒ¹é…å…¥å‚ï¼Œå³å¯è¿”å› trueã€‚è‹¥å…¨éƒ¨å¤±é…ï¼Œåˆ™è¿”å› falseã€‚\n\n\næƒ…å†µäºŒ\nmatches ä¸ºç©ºï¼Œmismatches éç©º\néå† mismatches é›†åˆå…ƒç´ ï¼Œå¹¶ä¸å…¥å‚è¿›è¡ŒåŒ¹é…ã€‚åªè¦æœ‰ä¸€ä¸ªå…ƒç´ æˆåŠŸåŒ¹é…å…¥å‚ï¼Œç«‹å³ falseã€‚è‹¥å…¨éƒ¨å¤±é…ï¼Œåˆ™è¿”å› trueã€‚\n\n\næƒ…å†µä¸‰\nmatches éç©ºï¼Œmismatches éç©º\nä¼˜å…ˆä½¿ç”¨ mismatches é›†åˆå…ƒç´ å¯¹å…¥å‚è¿›è¡ŒåŒ¹é…ï¼Œåªè¦ä»»ä¸€å…ƒç´ ä¸å…¥å‚åŒ¹é…æˆåŠŸï¼Œå°±ç«‹å³è¿”å› falseï¼Œç»“æŸæ–¹æ³•é€»è¾‘ã€‚å¦åˆ™å†ä½¿ç”¨ matches ä¸­çš„é›†åˆå…ƒç´ è¿›è¡ŒåŒ¹é…ï¼Œåªè¦æœ‰ä»»æ„ä¸€ä¸ªå…ƒç´ åŒ¹é…æˆåŠŸï¼Œå³å¯è¿”å› trueã€‚è‹¥å…¨éƒ¨å¤±é…ï¼Œåˆ™è¿”å› false\n\n\næƒ…å†µå››\nmatches ä¸ºç©ºï¼Œmismatches ä¸ºç©º\nç›´æ¥è¿”å› false\n\n\nisMatch æ–¹æ³•æ˜¯é€šè¿‡ UrlUtils çš„ isMatchGlobPattern æ–¹æ³•è¿›è¡ŒåŒ¹é…ï¼Œå› æ­¤ä¸‹é¢æˆ‘ä»¬å†æ¥çœ‹çœ‹ isMatchGlobPattern æ–¹æ³•çš„é€»è¾‘ã€‚\npublic static boolean isMatchGlobPattern(String pattern, String value, URL param) &#123;\n    if (param != null &amp;&amp; pattern.startsWith(\"$\")) &#123;\n        // å¼•ç”¨æœåŠ¡æ¶ˆè´¹è€…å‚æ•°ï¼Œparam å‚æ•°ä¸ºæœåŠ¡æ¶ˆè´¹è€… url\n        pattern = param.getRawParameter(pattern.substring(1));\n    &#125;\n    // è°ƒç”¨é‡è½½æ–¹æ³•ç»§ç»­æ¯”è¾ƒ\n    return isMatchGlobPattern(pattern, value);\n&#125;\n\npublic static boolean isMatchGlobPattern(String pattern, String value) &#123;\n    // å¯¹ * é€šé…ç¬¦æä¾›æ”¯æŒ\n    if (\"*\".equals(pattern))\n        // åŒ¹é…è§„åˆ™ä¸ºé€šé…ç¬¦ *ï¼Œç›´æ¥è¿”å› true å³å¯\n        return true;\n    if ((pattern == null || pattern.length() == 0)\n            &amp;&amp; (value == null || value.length() == 0))\n        // pattern å’Œ value å‡ä¸ºç©ºï¼Œæ­¤æ—¶å¯è®¤ä¸ºä¸¤è€…ç›¸ç­‰ï¼Œè¿”å› true\n        return true;\n    if ((pattern == null || pattern.length() == 0)\n            || (value == null || value.length() == 0))\n        // pattern å’Œ value å…¶ä¸­æœ‰ä¸€ä¸ªä¸ºç©ºï¼Œè¡¨æ˜ä¸¤è€…ä¸ç›¸ç­‰ï¼Œè¿”å› false\n        return false;\n\n    // å®šä½ * é€šé…ç¬¦ä½ç½®\n    int i = pattern.lastIndexOf('*');\n    if (i == -1) &#123;\n        // åŒ¹é…è§„åˆ™ä¸­ä¸åŒ…å«é€šé…ç¬¦ï¼Œæ­¤æ—¶ç›´æ¥æ¯”è¾ƒ value å’Œ pattern æ˜¯å¦ç›¸ç­‰å³å¯ï¼Œå¹¶è¿”å›æ¯”è¾ƒç»“æœ\n        return value.equals(pattern);\n    &#125;\n    // é€šé…ç¬¦ \"*\" åœ¨åŒ¹é…è§„åˆ™å°¾éƒ¨ï¼Œæ¯”å¦‚ 10.0.21.*\n    else if (i == pattern.length() - 1) &#123;\n        // æ£€æµ‹ value æ˜¯å¦ä»¥â€œä¸å«é€šé…ç¬¦çš„åŒ¹é…è§„åˆ™â€å¼€å¤´ï¼Œå¹¶è¿”å›ç»“æœã€‚æ¯”å¦‚:\n        // pattern = 10.0.21.*ï¼Œvalue = 10.0.21.12ï¼Œæ­¤æ—¶è¿”å› true\n        return value.startsWith(pattern.substring(0, i));\n    &#125;\n    // é€šé…ç¬¦ \"*\" åœ¨åŒ¹é…è§„åˆ™å¤´éƒ¨\n    else if (i == 0) &#123;\n        // æ£€æµ‹ value æ˜¯å¦ä»¥â€œä¸å«é€šé…ç¬¦çš„åŒ¹é…è§„åˆ™â€ç»“å°¾ï¼Œå¹¶è¿”å›ç»“æœ\n        return value.endsWith(pattern.substring(i + 1));\n    &#125;\n    // é€šé…ç¬¦ \"*\" åœ¨åŒ¹é…è§„åˆ™ä¸­é—´ä½ç½®\n    else &#123;\n        // é€šè¿‡é€šé…ç¬¦å°† pattern åˆ†æˆä¸¤åŠï¼Œå¾—åˆ° prefix å’Œ suffix\n        String prefix = pattern.substring(0, i);\n        String suffix = pattern.substring(i + 1);\n        // æ£€æµ‹ value æ˜¯å¦ä»¥ prefix å¼€å¤´ï¼Œä¸”ä»¥ suffix ç»“å°¾ï¼Œå¹¶è¿”å›ç»“æœ\n        return value.startsWith(prefix) &amp;&amp; value.endsWith(suffix);\n    &#125;\n&#125;\n\nä»¥ä¸Šå°±æ˜¯ isMatchGlobPattern ä¸¤ä¸ªé‡è½½æ–¹æ³•çš„å…¨éƒ¨é€»è¾‘ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•åˆ†åˆ«å¯¹æ™®é€šçš„åŒ¹é…è¿‡ç¨‹ï¼Œä»¥åŠâ€å¼•ç”¨æ¶ˆè´¹è€…å‚æ•°â€œå’Œé€šé…ç¬¦åŒ¹é…ç­‰ç‰¹æ€§æä¾›äº†æ”¯æŒã€‚è¿™ä¸¤ä¸ªæ–¹æ³•çš„é€»è¾‘ä¸æ˜¯å¾ˆå¤æ‚ï¼Œä¸”ä»£ç ä¸­ä¹Ÿè¿›è¡Œäº†æ¯”è¾ƒè¯¦ç»†çš„æ³¨é‡Šï¼Œå› æ­¤å°±ä¸å¤šè¯´äº†ã€‚\n\n3. æ€»ç»“æœ¬ç¯‡æ–‡ç« å¯¹æ¡ä»¶è·¯ç”±çš„è¡¨è¾¾å¼è§£æå’ŒæœåŠ¡è·¯ç”±è¿‡ç¨‹è¿›è¡Œäº†è¾ƒä¸ºç»†è‡´çš„åˆ†æã€‚æ€»çš„æ¥è¯´ï¼Œæ¡ä»¶è·¯ç”±çš„ä»£ç è¿˜æ˜¯æœ‰ä¸€äº›å¤æ‚çš„ï¼Œéœ€è¦é™ä¸‹å¿ƒæ¥çœ‹ã€‚åœ¨é˜…è¯»æ¡ä»¶è·¯ç”±ä»£ç çš„è¿‡ç¨‹ä¸­ï¼Œè¦å¤šè°ƒè¯•ã€‚ä¸€èˆ¬çš„æ¡†æ¶éƒ½ä¼šæœ‰å•å…ƒæµ‹è¯•ï¼ŒDubbo ä¹Ÿä¸ä¾‹å¤–ï¼Œå› æ­¤å¤§å®¶å¯ä»¥ç›´æ¥é€šè¿‡ ConditionRouterTest å¯¹æ¡ä»¶è·¯ç”±è¿›è¡Œè°ƒè¯•ï¼Œæ— éœ€é‡å¤´æ„å»ºæµ‹è¯•ç”¨ä¾‹ã€‚\n\n\n\n\n\n\n\n\n\nåŸæ–‡åœ°å€ï¼šhttps://dubbo.apache.org/zh/docsv2.7/dev/source/cluster/\nä½œè€…ï¼š Dubbo å®˜æ–¹\næœ¬æ–‡ä»‹ç»äº†é›†ç¾¤çš„åŸç†å’Œå®ç°ç»†èŠ‚\n\né›†ç¾¤1.ç®€ä»‹ä¸ºäº†é¿å…å•ç‚¹æ•…éšœï¼Œç°åœ¨çš„åº”ç”¨é€šå¸¸è‡³å°‘ä¼šéƒ¨ç½²åœ¨ä¸¤å°æœåŠ¡å™¨ä¸Šã€‚å¯¹äºä¸€äº›è´Ÿè½½æ¯”è¾ƒé«˜çš„æœåŠ¡ï¼Œä¼šéƒ¨ç½²æ›´å¤šçš„æœåŠ¡å™¨ã€‚è¿™æ ·ï¼Œåœ¨åŒä¸€ç¯å¢ƒä¸‹çš„æœåŠ¡æä¾›è€…æ•°é‡ä¼šå¤§äº1ã€‚å¯¹äºæœåŠ¡æ¶ˆè´¹è€…æ¥è¯´ï¼ŒåŒä¸€ç¯å¢ƒä¸‹å‡ºç°äº†å¤šä¸ªæœåŠ¡æä¾›è€…ã€‚è¿™æ—¶ä¼šå‡ºç°ä¸€ä¸ªé—®é¢˜ï¼ŒæœåŠ¡æ¶ˆè´¹è€…éœ€è¦å†³å®šé€‰æ‹©å“ªä¸ªæœåŠ¡æä¾›è€…è¿›è¡Œè°ƒç”¨ã€‚å¦å¤–æœåŠ¡è°ƒç”¨å¤±è´¥æ—¶çš„å¤„ç†æªæ–½ä¹Ÿæ˜¯éœ€è¦è€ƒè™‘çš„ï¼Œæ˜¯é‡è¯•å‘¢ï¼Œè¿˜æ˜¯æŠ›å‡ºå¼‚å¸¸ï¼Œäº¦æˆ–æ˜¯åªæ‰“å°å¼‚å¸¸ç­‰ã€‚ä¸ºäº†å¤„ç†è¿™äº›é—®é¢˜ï¼ŒDubbo å®šä¹‰äº†é›†ç¾¤æ¥å£ Cluster ä»¥åŠ Cluster Invokerã€‚é›†ç¾¤ Cluster ç”¨é€”æ˜¯å°†å¤šä¸ªæœåŠ¡æä¾›è€…åˆå¹¶ä¸ºä¸€ä¸ª Cluster Invokerï¼Œå¹¶å°†è¿™ä¸ª Invoker æš´éœ²ç»™æœåŠ¡æ¶ˆè´¹è€…ã€‚è¿™æ ·ä¸€æ¥ï¼ŒæœåŠ¡æ¶ˆè´¹è€…åªéœ€é€šè¿‡è¿™ä¸ª Invoker è¿›è¡Œè¿œç¨‹è°ƒç”¨å³å¯ï¼Œè‡³äºå…·ä½“è°ƒç”¨å“ªä¸ªæœåŠ¡æä¾›è€…ï¼Œä»¥åŠè°ƒç”¨å¤±è´¥åå¦‚ä½•å¤„ç†ç­‰é—®é¢˜ï¼Œç°åœ¨éƒ½äº¤ç»™é›†ç¾¤æ¨¡å—å»å¤„ç†ã€‚é›†ç¾¤æ¨¡å—æ˜¯æœåŠ¡æä¾›è€…å’ŒæœåŠ¡æ¶ˆè´¹è€…çš„ä¸­é—´å±‚ï¼Œä¸ºæœåŠ¡æ¶ˆè´¹è€…å±è”½äº†æœåŠ¡æä¾›è€…çš„æƒ…å†µï¼Œè¿™æ ·æœåŠ¡æ¶ˆè´¹è€…å°±å¯ä»¥ä¸“å¿ƒå¤„ç†è¿œç¨‹è°ƒç”¨ç›¸å…³äº‹å®œã€‚æ¯”å¦‚å‘è¯·æ±‚ï¼Œæ¥å—æœåŠ¡æä¾›è€…è¿”å›çš„æ•°æ®ç­‰ã€‚è¿™å°±æ˜¯é›†ç¾¤çš„ä½œç”¨ã€‚\nDubbo æä¾›äº†å¤šç§é›†ç¾¤å®ç°ï¼ŒåŒ…å«ä½†ä¸é™äº Failover Clusterã€Failfast Cluster å’Œ Failsafe Cluster ç­‰ã€‚æ¯ç§é›†ç¾¤å®ç°ç±»çš„ç”¨é€”ä¸åŒï¼Œæ¥ä¸‹æ¥ä¼šä¸€ä¸€è¿›è¡Œåˆ†æã€‚\n\n2. é›†ç¾¤å®¹é”™åœ¨å¯¹é›†ç¾¤ç›¸å…³ä»£ç è¿›è¡Œåˆ†æä¹‹å‰ï¼Œè¿™é‡Œæœ‰å¿…è¦å…ˆæ¥ä»‹ç»ä¸€ä¸‹é›†ç¾¤å®¹é”™çš„æ‰€æœ‰ç»„ä»¶ã€‚åŒ…å« Clusterã€Cluster Invokerã€Directoryã€Router å’Œ LoadBalance ç­‰ã€‚\n\né›†ç¾¤å·¥ä½œè¿‡ç¨‹å¯åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼Œç¬¬ä¸€ä¸ªé˜¶æ®µæ˜¯åœ¨æœåŠ¡æ¶ˆè´¹è€…åˆå§‹åŒ–æœŸé—´ï¼Œé›†ç¾¤ Cluster å®ç°ç±»ä¸ºæœåŠ¡æ¶ˆè´¹è€…åˆ›å»º Cluster Invoker å®ä¾‹ï¼Œå³ä¸Šå›¾ä¸­çš„ merge æ“ä½œã€‚ç¬¬äºŒä¸ªé˜¶æ®µæ˜¯åœ¨æœåŠ¡æ¶ˆè´¹è€…è¿›è¡Œè¿œç¨‹è°ƒç”¨æ—¶ã€‚ä»¥ FailoverClusterInvoker ä¸ºä¾‹ï¼Œè¯¥ç±»å‹ Cluster Invoker é¦–å…ˆä¼šè°ƒç”¨ Directory çš„ list æ–¹æ³•åˆ—ä¸¾ Invoker åˆ—è¡¨ï¼ˆå¯å°† Invoker ç®€å•ç†è§£ä¸ºæœåŠ¡æä¾›è€…ï¼‰ã€‚Directory çš„ç”¨é€”æ˜¯ä¿å­˜ Invokerï¼Œå¯ç®€å•ç±»æ¯”ä¸º Listã€‚å…¶å®ç°ç±» RegistryDirectory æ˜¯ä¸€ä¸ªåŠ¨æ€æœåŠ¡ç›®å½•ï¼Œå¯æ„ŸçŸ¥æ³¨å†Œä¸­å¿ƒé…ç½®çš„å˜åŒ–ï¼Œå®ƒæ‰€æŒæœ‰çš„ Invoker åˆ—è¡¨ä¼šéšç€æ³¨å†Œä¸­å¿ƒå†…å®¹çš„å˜åŒ–è€Œå˜åŒ–ã€‚æ¯æ¬¡å˜åŒ–åï¼ŒRegistryDirectory ä¼šåŠ¨æ€å¢åˆ  Invokerï¼Œå¹¶è°ƒç”¨ Router çš„ route æ–¹æ³•è¿›è¡Œè·¯ç”±ï¼Œè¿‡æ»¤æ‰ä¸ç¬¦åˆè·¯ç”±è§„åˆ™çš„ Invokerã€‚å½“ FailoverClusterInvoker æ‹¿åˆ° Directory è¿”å›çš„ Invoker åˆ—è¡¨åï¼Œå®ƒä¼šé€šè¿‡ LoadBalance ä» Invoker åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ª Invokerã€‚æœ€å FailoverClusterInvoker ä¼šå°†å‚æ•°ä¼ ç»™ LoadBalance é€‰æ‹©å‡ºçš„ Invoker å®ä¾‹çš„ invoke æ–¹æ³•ï¼Œè¿›è¡ŒçœŸæ­£çš„è¿œç¨‹è°ƒç”¨ã€‚\nä»¥ä¸Šå°±æ˜¯é›†ç¾¤å·¥ä½œçš„æ•´ä¸ªæµç¨‹ï¼Œè¿™é‡Œå¹¶æ²¡ä»‹ç»é›†ç¾¤æ˜¯å¦‚ä½•å®¹é”™çš„ã€‚Dubbo ä¸»è¦æä¾›äº†è¿™æ ·å‡ ç§å®¹é”™æ–¹å¼ï¼š\n\nFailover Cluster - å¤±è´¥è‡ªåŠ¨åˆ‡æ¢\nFailfast Cluster - å¿«é€Ÿå¤±è´¥\nFailsafe Cluster - å¤±è´¥å®‰å…¨\nFailback Cluster - å¤±è´¥è‡ªåŠ¨æ¢å¤\nForking Cluster - å¹¶è¡Œè°ƒç”¨å¤šä¸ªæœåŠ¡æä¾›è€…\n\nä¸‹é¢å¼€å§‹åˆ†ææºç ã€‚\n\n3.æºç åˆ†æ\n3.1 Cluster å®ç°ç±»åˆ†ææˆ‘ä»¬åœ¨ä¸Šä¸€ç« çœ‹åˆ°äº†ä¸¤ä¸ªæ¦‚å¿µï¼Œåˆ†åˆ«æ˜¯é›†ç¾¤æ¥å£ Cluster å’Œ Cluster Invokerï¼Œè¿™ä¸¤è€…æ˜¯ä¸åŒçš„ã€‚Cluster æ˜¯æ¥å£ï¼Œè€Œ Cluster Invoker æ˜¯ä¸€ç§ Invokerã€‚æœåŠ¡æä¾›è€…çš„é€‰æ‹©é€»è¾‘ï¼Œä»¥åŠè¿œç¨‹è°ƒç”¨å¤±è´¥åçš„çš„å¤„ç†é€»è¾‘å‡æ˜¯å°è£…åœ¨ Cluster Invoker ä¸­ã€‚é‚£ä¹ˆ Cluster æ¥å£å’Œç›¸å…³å®ç°ç±»æœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿç”¨é€”æ¯”è¾ƒç®€å•ï¼Œä»…ç”¨äºç”Ÿæˆ Cluster Invokerã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æºç ã€‚\npublic class FailoverCluster implements Cluster &#123;\n\n    public final static String NAME = \"failover\";\n\n    @Override\n    public &lt;T> Invoker&lt;T> join(Directory&lt;T> directory) throws RpcException &#123;\n        // åˆ›å»ºå¹¶è¿”å› FailoverClusterInvoker å¯¹è±¡\n        return new FailoverClusterInvoker&lt;T>(directory);\n    &#125;\n&#125;\n\nå¦‚ä¸Šï¼ŒFailoverCluster æ€»å…±å°±åŒ…å«è¿™å‡ è¡Œä»£ç ï¼Œç”¨äºåˆ›å»º FailoverClusterInvoker å¯¹è±¡ï¼Œå¾ˆç®€å•ã€‚ä¸‹é¢å†çœ‹ä¸€ä¸ªã€‚\npublic class FailbackCluster implements Cluster &#123;\n\n    public final static String NAME = \"failback\";\n\n    @Override\n    public &lt;T> Invoker&lt;T> join(Directory&lt;T> directory) throws RpcException &#123;\n        // åˆ›å»ºå¹¶è¿”å› FailbackClusterInvoker å¯¹è±¡\n        return new FailbackClusterInvoker&lt;T>(directory);\n    &#125;\n\n&#125;\n\nå¦‚ä¸Šï¼ŒFailbackCluster çš„é€»è¾‘ä¹Ÿæ˜¯å¾ˆç®€å•ï¼Œæ— éœ€è§£é‡Šäº†ã€‚æ‰€ä»¥æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æŠŠé‡ç‚¹æ”¾åœ¨å„ç§ Cluster Invoker ä¸Š\n\n3.2 Cluster Invoker åˆ†ææˆ‘ä»¬é¦–å…ˆä»å„ç§ Cluster Invoker çš„çˆ¶ç±» AbstractClusterInvoker æºç å¼€å§‹è¯´èµ·ã€‚å‰é¢è¯´è¿‡ï¼Œé›†ç¾¤å·¥ä½œè¿‡ç¨‹å¯åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼Œç¬¬ä¸€ä¸ªé˜¶æ®µæ˜¯åœ¨æœåŠ¡æ¶ˆè´¹è€…åˆå§‹åŒ–æœŸé—´ï¼Œè¿™ä¸ªåœ¨æœåŠ¡å¼•ç”¨é‚£ç¯‡æ–‡ç« ä¸­åˆ†æè¿‡ï¼Œå°±ä¸èµ˜è¿°ã€‚ç¬¬äºŒä¸ªé˜¶æ®µæ˜¯åœ¨æœåŠ¡æ¶ˆè´¹è€…è¿›è¡Œè¿œç¨‹è°ƒç”¨æ—¶ï¼Œæ­¤æ—¶ AbstractClusterInvoker çš„ invoke æ–¹æ³•ä¼šè¢«è°ƒç”¨ã€‚åˆ—ä¸¾ Invokerï¼Œè´Ÿè½½å‡è¡¡ç­‰æ“ä½œå‡ä¼šåœ¨æ­¤é˜¶æ®µè¢«æ‰§è¡Œã€‚å› æ­¤ä¸‹é¢å…ˆæ¥çœ‹ä¸€ä¸‹ invoke æ–¹æ³•çš„é€»è¾‘ã€‚\npublic Result invoke(final Invocation invocation) throws RpcException &#123;\n    checkWhetherDestroyed();\n    LoadBalance loadbalance = null;\n\n    // ç»‘å®š attachments åˆ° invocation ä¸­.\n    Map&lt;String, String> contextAttachments = RpcContext.getContext().getAttachments();\n    if (contextAttachments != null &amp;&amp; contextAttachments.size() != 0) &#123;\n        ((RpcInvocation) invocation).addAttachments(contextAttachments);\n    &#125;\n\n    // åˆ—ä¸¾ Invoker\n    List&lt;Invoker&lt;T>> invokers = list(invocation);\n    if (invokers != null &amp;&amp; !invokers.isEmpty()) &#123;\n        // åŠ è½½ LoadBalance\n        loadbalance = ExtensionLoader.getExtensionLoader(LoadBalance.class).getExtension(invokers.get(0).getUrl()\n                .getMethodParameter(RpcUtils.getMethodName(invocation), Constants.LOADBALANCE_KEY, Constants.DEFAULT_LOADBALANCE));\n    &#125;\n    RpcUtils.attachInvocationIdIfAsync(getUrl(), invocation);\n    \n    // è°ƒç”¨ doInvoke è¿›è¡Œåç»­æ“ä½œ\n    return doInvoke(invocation, invokers, loadbalance);\n&#125;\n\n// æŠ½è±¡æ–¹æ³•ï¼Œç”±å­ç±»å®ç°\nprotected abstract Result doInvoke(Invocation invocation, List&lt;Invoker&lt;T>> invokers,\n                                       LoadBalance loadbalance) throws RpcException;\n\nAbstractClusterInvoker çš„ invoke æ–¹æ³•ä¸»è¦ç”¨äºåˆ—ä¸¾ Invokerï¼Œä»¥åŠåŠ è½½ LoadBalanceã€‚æœ€åå†è°ƒç”¨æ¨¡æ¿æ–¹æ³• doInvoke è¿›è¡Œåç»­æ“ä½œã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ Invoker åˆ—ä¸¾æ–¹æ³• list(Invocation) çš„é€»è¾‘ï¼Œå¦‚ä¸‹ï¼š\nprotected List&lt;Invoker&lt;T>> list(Invocation invocation) throws RpcException &#123;\n    // è°ƒç”¨ Directory çš„ list æ–¹æ³•åˆ—ä¸¾ Invoker\n    List&lt;Invoker&lt;T>> invokers = directory.list(invocation);\n    return invokers;\n&#125;\n\nå¦‚ä¸Šï¼ŒAbstractClusterInvoker ä¸­çš„ list æ–¹æ³•åšçš„äº‹æƒ…å¾ˆç®€å•ï¼Œåªæ˜¯ç®€å•çš„è°ƒç”¨äº† Directory çš„ list æ–¹æ³•ï¼Œæ²¡æœ‰å…¶ä»–æ›´å¤šçš„é€»è¾‘äº†ã€‚Directory å³ç›¸å…³å®ç°ç±»åœ¨å‰æ–‡å·²ç»åˆ†æè¿‡ï¼Œè¿™é‡Œå°±ä¸å¤šè¯´äº†ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æŠŠç›®å…‰è½¬ç§»åˆ° AbstractClusterInvoker çš„å„ç§å®ç°ç±»ä¸Šï¼Œæ¥çœ‹ä¸€ä¸‹è¿™äº›å®ç°ç±»æ˜¯å¦‚ä½•å®ç° doInvoke æ–¹æ³•é€»è¾‘çš„ã€‚\n\n3.2.1 FailoverClusterInvokerFailoverClusterInvoker åœ¨è°ƒç”¨å¤±è´¥æ—¶ï¼Œä¼šè‡ªåŠ¨åˆ‡æ¢ Invoker è¿›è¡Œé‡è¯•ã€‚é»˜è®¤é…ç½®ä¸‹ï¼ŒDubbo ä¼šä½¿ç”¨è¿™ä¸ªç±»ä½œä¸ºç¼ºçœ Cluster Invokerã€‚ä¸‹é¢æ¥çœ‹ä¸€ä¸‹è¯¥ç±»çš„é€»è¾‘ã€‚\npublic class FailoverClusterInvoker&lt;T> extends AbstractClusterInvoker&lt;T> &#123;\n\n    // çœç•¥éƒ¨åˆ†ä»£ç \n\n    @Override\n    public Result doInvoke(Invocation invocation, final List&lt;Invoker&lt;T>> invokers, LoadBalance loadbalance) throws RpcException &#123;\n        List&lt;Invoker&lt;T>> copyinvokers = invokers;\n        checkInvokers(copyinvokers, invocation);\n        // è·å–é‡è¯•æ¬¡æ•°\n        int len = getUrl().getMethodParameter(invocation.getMethodName(), Constants.RETRIES_KEY, Constants.DEFAULT_RETRIES) + 1;\n        if (len &lt;= 0) &#123;\n            len = 1;\n        &#125;\n        RpcException le = null;\n        List&lt;Invoker&lt;T>> invoked = new ArrayList&lt;Invoker&lt;T>>(copyinvokers.size());\n        Set&lt;String> providers = new HashSet&lt;String>(len);\n        // å¾ªç¯è°ƒç”¨ï¼Œå¤±è´¥é‡è¯•\n        for (int i = 0; i &lt; len; i++) &#123;\n            if (i > 0) &#123;\n                checkWhetherDestroyed();\n                // åœ¨è¿›è¡Œé‡è¯•å‰é‡æ–°åˆ—ä¸¾ Invokerï¼Œè¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼Œå¦‚æœæŸä¸ªæœåŠ¡æŒ‚äº†ï¼Œ\n                // é€šè¿‡è°ƒç”¨ list å¯å¾—åˆ°æœ€æ–°å¯ç”¨çš„ Invoker åˆ—è¡¨\n                copyinvokers = list(invocation);\n                // å¯¹ copyinvokers è¿›è¡Œåˆ¤ç©ºæ£€æŸ¥\n                checkInvokers(copyinvokers, invocation);\n            &#125;\n\n            // é€šè¿‡è´Ÿè½½å‡è¡¡é€‰æ‹© Invoker\n            Invoker&lt;T> invoker = select(loadbalance, invocation, copyinvokers, invoked);\n            // æ·»åŠ åˆ° invoker åˆ° invoked åˆ—è¡¨ä¸­\n            invoked.add(invoker);\n            // è®¾ç½® invoked åˆ° RPC ä¸Šä¸‹æ–‡ä¸­\n            RpcContext.getContext().setInvokers((List) invoked);\n            try &#123;\n                // è°ƒç”¨ç›®æ ‡ Invoker çš„ invoke æ–¹æ³•\n                Result result = invoker.invoke(invocation);\n                return result;\n            &#125; catch (RpcException e) &#123;\n                if (e.isBiz()) &#123;\n                    throw e;\n                &#125;\n                le = e;\n            &#125; catch (Throwable e) &#123;\n                le = new RpcException(e.getMessage(), e);\n            &#125; finally &#123;\n                providers.add(invoker.getUrl().getAddress());\n            &#125;\n        &#125;\n        \n        // è‹¥é‡è¯•å¤±è´¥ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸\n        throw new RpcException(..., \"Failed to invoke the method ...\");\n    &#125;\n&#125;\n\nå¦‚ä¸Šï¼ŒFailoverClusterInvoker çš„ doInvoke æ–¹æ³•é¦–å…ˆæ˜¯è·å–é‡è¯•æ¬¡æ•°ï¼Œç„¶åæ ¹æ®é‡è¯•æ¬¡æ•°è¿›è¡Œå¾ªç¯è°ƒç”¨ï¼Œå¤±è´¥åè¿›è¡Œé‡è¯•ã€‚åœ¨ for å¾ªç¯å†…ï¼Œé¦–å…ˆæ˜¯é€šè¿‡è´Ÿè½½å‡è¡¡ç»„ä»¶é€‰æ‹©ä¸€ä¸ª Invokerï¼Œç„¶åå†é€šè¿‡è¿™ä¸ª Invoker çš„ invoke æ–¹æ³•è¿›è¡Œè¿œç¨‹è°ƒç”¨ã€‚å¦‚æœå¤±è´¥äº†ï¼Œè®°å½•ä¸‹å¼‚å¸¸ï¼Œå¹¶è¿›è¡Œé‡è¯•ã€‚é‡è¯•æ—¶ä¼šå†æ¬¡è°ƒç”¨çˆ¶ç±»çš„ list æ–¹æ³•åˆ—ä¸¾ Invokerã€‚æ•´ä¸ªæµç¨‹å¤§è‡´å¦‚æ­¤ï¼Œä¸æ˜¯å¾ˆéš¾ç†è§£ã€‚ä¸‹é¢æˆ‘ä»¬çœ‹ä¸€ä¸‹ select æ–¹æ³•çš„é€»è¾‘ã€‚\nprotected Invoker&lt;T> select(LoadBalance loadbalance, Invocation invocation, List&lt;Invoker&lt;T>> invokers, List&lt;Invoker&lt;T>> selected) throws RpcException &#123;\n    if (invokers == null || invokers.isEmpty())\n        return null;\n    // è·å–è°ƒç”¨æ–¹æ³•å\n    String methodName = invocation == null ? \"\" : invocation.getMethodName();\n\n    // è·å– sticky é…ç½®ï¼Œsticky è¡¨ç¤ºç²˜æ»è¿æ¥ã€‚æ‰€è°“ç²˜æ»è¿æ¥æ˜¯æŒ‡è®©æœåŠ¡æ¶ˆè´¹è€…å°½å¯èƒ½çš„\n    // è°ƒç”¨åŒä¸€ä¸ªæœåŠ¡æä¾›è€…ï¼Œé™¤éè¯¥æä¾›è€…æŒ‚äº†å†è¿›è¡Œåˆ‡æ¢\n    boolean sticky = invokers.get(0).getUrl().getMethodParameter(methodName, Constants.CLUSTER_STICKY_KEY, Constants.DEFAULT_CLUSTER_STICKY);\n    &#123;\n        // æ£€æµ‹ invokers åˆ—è¡¨æ˜¯å¦åŒ…å« stickyInvokerï¼Œå¦‚æœä¸åŒ…å«ï¼Œ\n        // è¯´æ˜ stickyInvoker ä»£è¡¨çš„æœåŠ¡æä¾›è€…æŒ‚äº†ï¼Œæ­¤æ—¶éœ€è¦å°†å…¶ç½®ç©º\n        if (stickyInvoker != null &amp;&amp; !invokers.contains(stickyInvoker)) &#123;\n            stickyInvoker = null;\n        &#125;\n        \n        // åœ¨ sticky ä¸º trueï¼Œä¸” stickyInvoker != null çš„æƒ…å†µä¸‹ã€‚å¦‚æœ selected åŒ…å« \n        // stickyInvokerï¼Œè¡¨æ˜ stickyInvoker å¯¹åº”çš„æœåŠ¡æä¾›è€…å¯èƒ½å› ç½‘ç»œåŸå› æœªèƒ½æˆåŠŸæä¾›æœåŠ¡ã€‚\n        // ä½†æ˜¯è¯¥æä¾›è€…å¹¶æ²¡æŒ‚ï¼Œæ­¤æ—¶ invokers åˆ—è¡¨ä¸­ä»å­˜åœ¨è¯¥æœåŠ¡æä¾›è€…å¯¹åº”çš„ Invokerã€‚\n        if (sticky &amp;&amp; stickyInvoker != null &amp;&amp; (selected == null || !selected.contains(stickyInvoker))) &#123;\n            // availablecheck è¡¨ç¤ºæ˜¯å¦å¼€å¯äº†å¯ç”¨æ€§æ£€æŸ¥ï¼Œå¦‚æœå¼€å¯äº†ï¼Œåˆ™è°ƒç”¨ stickyInvoker çš„ \n            // isAvailable æ–¹æ³•è¿›è¡Œæ£€æŸ¥ï¼Œå¦‚æœæ£€æŸ¥é€šè¿‡ï¼Œåˆ™ç›´æ¥è¿”å› stickyInvokerã€‚\n            if (availablecheck &amp;&amp; stickyInvoker.isAvailable()) &#123;\n                return stickyInvoker;\n            &#125;\n        &#125;\n    &#125;\n    \n    // å¦‚æœçº¿ç¨‹èµ°åˆ°å½“å‰ä»£ç å¤„ï¼Œè¯´æ˜å‰é¢çš„ stickyInvoker ä¸ºç©ºï¼Œæˆ–è€…ä¸å¯ç”¨ã€‚\n    // æ­¤æ—¶ç»§ç»­è°ƒç”¨ doSelect é€‰æ‹© Invoker\n    Invoker&lt;T> invoker = doSelect(loadbalance, invocation, invokers, selected);\n\n    // å¦‚æœ sticky ä¸º trueï¼Œåˆ™å°†è´Ÿè½½å‡è¡¡ç»„ä»¶é€‰å‡ºçš„ Invoker èµ‹å€¼ç»™ stickyInvoker\n    if (sticky) &#123;\n        stickyInvoker = invoker;\n    &#125;\n    return invoker;\n&#125;\n\nå¦‚ä¸Šï¼Œselect æ–¹æ³•çš„ä¸»è¦é€»è¾‘é›†ä¸­åœ¨äº†å¯¹ç²˜æ»è¿æ¥ç‰¹æ€§çš„æ”¯æŒä¸Šã€‚é¦–å…ˆæ˜¯è·å– sticky é…ç½®ï¼Œç„¶åå†æ£€æµ‹ invokers åˆ—è¡¨ä¸­æ˜¯å¦åŒ…å« stickyInvokerï¼Œå¦‚æœä¸åŒ…å«ï¼Œåˆ™è®¤ä¸ºè¯¥ stickyInvoker ä¸å¯ç”¨ï¼Œæ­¤æ—¶å°†å…¶ç½®ç©ºã€‚è¿™é‡Œçš„ invokers åˆ—è¡¨å¯ä»¥çœ‹åšæ˜¯å­˜æ´»ç€çš„æœåŠ¡æä¾›è€…åˆ—è¡¨ï¼Œå¦‚æœè¿™ä¸ªåˆ—è¡¨ä¸åŒ…å« stickyInvokerï¼Œé‚£è‡ªç„¶è€Œç„¶çš„è®¤ä¸º stickyInvoker æŒ‚äº†ï¼Œæ‰€ä»¥ç½®ç©ºã€‚å¦‚æœ stickyInvoker å­˜åœ¨äº invokers åˆ—è¡¨ä¸­ï¼Œæ­¤æ—¶è¦è¿›è¡Œä¸‹ä¸€é¡¹æ£€æµ‹ â€” æ£€æµ‹ selected ä¸­æ˜¯å¦åŒ…å« stickyInvokerã€‚å¦‚æœåŒ…å«çš„è¯ï¼Œè¯´æ˜ stickyInvoker åœ¨æ­¤ä¹‹å‰æ²¡æœ‰æˆåŠŸæä¾›æœåŠ¡ï¼ˆä½†å…¶ä»ç„¶å¤„äºå­˜æ´»çŠ¶æ€ï¼‰ã€‚æ­¤æ—¶æˆ‘ä»¬è®¤ä¸ºè¿™ä¸ªæœåŠ¡ä¸å¯é ï¼Œä¸åº”è¯¥åœ¨é‡è¯•æœŸé—´å†…å†æ¬¡è¢«è°ƒç”¨ï¼Œå› æ­¤è¿™ä¸ªæ—¶å€™ä¸ä¼šè¿”å›è¯¥ stickyInvokerã€‚å¦‚æœ selected ä¸åŒ…å« stickyInvokerï¼Œæ­¤æ—¶è¿˜éœ€è¦è¿›è¡Œå¯ç”¨æ€§æ£€æµ‹ï¼Œæ¯”å¦‚æ£€æµ‹æœåŠ¡æä¾›è€…ç½‘ç»œè¿é€šæ€§ç­‰ã€‚å½“å¯ç”¨æ€§æ£€æµ‹é€šè¿‡ï¼Œæ‰å¯è¿”å› stickyInvokerï¼Œå¦åˆ™è°ƒç”¨ doSelect æ–¹æ³•é€‰æ‹© Invokerã€‚å¦‚æœ sticky ä¸º trueï¼Œæ­¤æ—¶ä¼šå°† doSelect æ–¹æ³•é€‰å‡ºçš„ Invoker èµ‹å€¼ç»™ stickyInvokerã€‚\nä»¥ä¸Šå°±æ˜¯ select æ–¹æ³•çš„é€»è¾‘ï¼Œè¿™æ®µé€»è¾‘çœ‹èµ·æ¥ä¸æ˜¯å¾ˆå¤æ‚ï¼Œä½†æ˜¯ä¿¡æ¯é‡æ¯”è¾ƒå¤§ã€‚ä¸ææ‡‚ invokers å’Œ selected ä¸¤ä¸ªå…¥å‚çš„å«ä¹‰ï¼Œä»¥åŠç²˜æ»è¿æ¥ç‰¹æ€§ï¼Œè¿™æ®µä»£ç æ˜¯ä¸å®¹æ˜“çœ‹æ‡‚çš„ã€‚æ‰€ä»¥å¤§å®¶åœ¨é˜…è¯»è¿™æ®µä»£ç æ—¶ï¼Œä¸è¦å¿½ç•¥äº†å¯¹èƒŒæ™¯çŸ¥è¯†çš„ç†è§£ã€‚å…³äº select æ–¹æ³•å…ˆåˆ†æè¿™ä¹ˆå¤šï¼Œç»§ç»­å‘ä¸‹åˆ†æã€‚\nprivate Invoker&lt;T> doSelect(LoadBalance loadbalance, Invocation invocation, List&lt;Invoker&lt;T>> invokers, List&lt;Invoker&lt;T>> selected) throws RpcException &#123;\n    if (invokers == null || invokers.isEmpty())\n        return null;\n    if (invokers.size() == 1)\n        return invokers.get(0);\n    if (loadbalance == null) &#123;\n        // å¦‚æœ loadbalance ä¸ºç©ºï¼Œè¿™é‡Œé€šè¿‡ SPI åŠ è½½ Loadbalanceï¼Œé»˜è®¤ä¸º RandomLoadBalance\n        loadbalance = ExtensionLoader.getExtensionLoader(LoadBalance.class).getExtension(Constants.DEFAULT_LOADBALANCE);\n    &#125;\n    \n    // é€šè¿‡è´Ÿè½½å‡è¡¡ç»„ä»¶é€‰æ‹© Invoker\n    Invoker&lt;T> invoker = loadbalance.select(invokers, getUrl(), invocation);\n\n\t// å¦‚æœ selected åŒ…å«è´Ÿè½½å‡è¡¡é€‰æ‹©å‡ºçš„ Invokerï¼Œæˆ–è€…è¯¥ Invoker æ— æ³•ç»è¿‡å¯ç”¨æ€§æ£€æŸ¥ï¼Œæ­¤æ—¶è¿›è¡Œé‡é€‰\n    if ((selected != null &amp;&amp; selected.contains(invoker))\n            || (!invoker.isAvailable() &amp;&amp; getUrl() != null &amp;&amp; availablecheck)) &#123;\n        try &#123;\n            // è¿›è¡Œé‡é€‰\n            Invoker&lt;T> rinvoker = reselect(loadbalance, invocation, invokers, selected, availablecheck);\n            if (rinvoker != null) &#123;\n                // å¦‚æœ rinvoker ä¸ä¸ºç©ºï¼Œåˆ™å°†å…¶èµ‹å€¼ç»™ invoker\n                invoker = rinvoker;\n            &#125; else &#123;\n                // rinvoker ä¸ºç©ºï¼Œå®šä½ invoker åœ¨ invokers ä¸­çš„ä½ç½®\n                int index = invokers.indexOf(invoker);\n                try &#123;\n                    // è·å– index + 1 ä½ç½®å¤„çš„ Invokerï¼Œä»¥ä¸‹ä»£ç ç­‰ä»·äºï¼š\n                    //     invoker = invokers.get((index + 1) % invokers.size());\n                    invoker = index &lt; invokers.size() - 1 ? invokers.get(index + 1) : invokers.get(0);\n                &#125; catch (Exception e) &#123;\n                    logger.warn(\"... may because invokers list dynamic change, ignore.\");\n                &#125;\n            &#125;\n        &#125; catch (Throwable t) &#123;\n            logger.error(\"cluster reselect fail reason is : ...\");\n        &#125;\n    &#125;\n    return invoker;\n&#125;\n\ndoSelect ä¸»è¦åšäº†ä¸¤ä»¶äº‹ï¼Œç¬¬ä¸€æ˜¯é€šè¿‡è´Ÿè½½å‡è¡¡ç»„ä»¶é€‰æ‹© Invokerã€‚ç¬¬äºŒæ˜¯ï¼Œå¦‚æœé€‰å‡ºæ¥çš„ Invoker ä¸ç¨³å®šï¼Œæˆ–ä¸å¯ç”¨ï¼Œæ­¤æ—¶éœ€è¦è°ƒç”¨ reselect æ–¹æ³•è¿›è¡Œé‡é€‰ã€‚è‹¥ reselect é€‰å‡ºæ¥çš„ Invoker ä¸ºç©ºï¼Œæ­¤æ—¶å®šä½ invoker åœ¨ invokers åˆ—è¡¨ä¸­çš„ä½ç½® indexï¼Œç„¶åè·å– index + 1 å¤„çš„ invokerï¼Œè¿™ä¹Ÿå¯ä»¥çœ‹åšæ˜¯é‡é€‰é€»è¾‘çš„ä¸€éƒ¨åˆ†ã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ reselect æ–¹æ³•çš„é€»è¾‘ã€‚\nprivate Invoker&lt;T> reselect(LoadBalance loadbalance, Invocation invocation,\n    List&lt;Invoker&lt;T>> invokers, List&lt;Invoker&lt;T>> selected, boolean availablecheck) throws RpcException &#123;\n\n    List&lt;Invoker&lt;T>> reselectInvokers = new ArrayList&lt;Invoker&lt;T>>(invokers.size() > 1 ? (invokers.size() - 1) : invokers.size());\n\n    // ä¸‹é¢çš„ if-else åˆ†æ”¯é€»è¾‘æœ‰äº›å†—ä½™ï¼Œpull request #2826 å¯¹è¿™æ®µä»£ç è¿›è¡Œäº†ç®€åŒ–ï¼Œå¯ä»¥å‚è€ƒä¸€ä¸‹\n    // æ ¹æ® availablecheck è¿›è¡Œä¸åŒçš„å¤„ç†\n    if (availablecheck) &#123;\n        // éå† invokers åˆ—è¡¨\n        for (Invoker&lt;T> invoker : invokers) &#123;\n            // æ£€æµ‹å¯ç”¨æ€§\n            if (invoker.isAvailable()) &#123;\n                // å¦‚æœ selected åˆ—è¡¨ä¸åŒ…å«å½“å‰ invokerï¼Œåˆ™å°†å…¶æ·»åŠ åˆ° reselectInvokers ä¸­\n                if (selected == null || !selected.contains(invoker)) &#123;\n                    reselectInvokers.add(invoker);\n                &#125;\n            &#125;\n        &#125;\n        \n        // reselectInvokers ä¸ä¸ºç©ºï¼Œæ­¤æ—¶é€šè¿‡è´Ÿè½½å‡è¡¡ç»„ä»¶è¿›è¡Œé€‰æ‹©\n        if (!reselectInvokers.isEmpty()) &#123;\n            return loadbalance.select(reselectInvokers, getUrl(), invocation);\n        &#125;\n\n    // ä¸æ£€æŸ¥ Invoker å¯ç”¨æ€§\n    &#125; else &#123;\n        for (Invoker&lt;T> invoker : invokers) &#123;\n            // å¦‚æœ selected åˆ—è¡¨ä¸åŒ…å«å½“å‰ invokerï¼Œåˆ™å°†å…¶æ·»åŠ åˆ° reselectInvokers ä¸­\n            if (selected == null || !selected.contains(invoker)) &#123;\n                reselectInvokers.add(invoker);\n            &#125;\n        &#125;\n        if (!reselectInvokers.isEmpty()) &#123;\n            // é€šè¿‡è´Ÿè½½å‡è¡¡ç»„ä»¶è¿›è¡Œé€‰æ‹©\n            return loadbalance.select(reselectInvokers, getUrl(), invocation);\n        &#125;\n    &#125;\n\n    &#123;\n        // è‹¥çº¿ç¨‹èµ°åˆ°æ­¤å¤„ï¼Œè¯´æ˜ reselectInvokers é›†åˆä¸ºç©ºï¼Œæ­¤æ—¶ä¸ä¼šè°ƒç”¨è´Ÿè½½å‡è¡¡ç»„ä»¶è¿›è¡Œç­›é€‰ã€‚\n        // è¿™é‡Œä» selected åˆ—è¡¨ä¸­æŸ¥æ‰¾å¯ç”¨çš„ Invokerï¼Œå¹¶å°†å…¶æ·»åŠ åˆ° reselectInvokers é›†åˆä¸­\n        if (selected != null) &#123;\n            for (Invoker&lt;T> invoker : selected) &#123;\n                if ((invoker.isAvailable())\n                        &amp;&amp; !reselectInvokers.contains(invoker)) &#123;\n                    reselectInvokers.add(invoker);\n                &#125;\n            &#125;\n        &#125;\n        if (!reselectInvokers.isEmpty()) &#123;\n            // å†æ¬¡è¿›è¡Œé€‰æ‹©ï¼Œå¹¶è¿”å›é€‰æ‹©ç»“æœ\n            return loadbalance.select(reselectInvokers, getUrl(), invocation);\n        &#125;\n    &#125;\n    return null;\n&#125;\n\nreselect æ–¹æ³•æ€»ç»“ä¸‹æ¥å…¶å®åªåšäº†ä¸¤ä»¶äº‹æƒ…ï¼Œç¬¬ä¸€æ˜¯æŸ¥æ‰¾å¯ç”¨çš„ Invokerï¼Œå¹¶å°†å…¶æ·»åŠ åˆ° reselectInvokers é›†åˆä¸­ã€‚ç¬¬äºŒï¼Œå¦‚æœ reselectInvokers ä¸ä¸ºç©ºï¼Œåˆ™é€šè¿‡è´Ÿè½½å‡è¡¡ç»„ä»¶å†æ¬¡è¿›è¡Œé€‰æ‹©ã€‚å…¶ä¸­ç¬¬ä¸€ä»¶äº‹æƒ…åˆå¯è¿›è¡Œç»†åˆ†ï¼Œä¸€å¼€å§‹ï¼Œreselect ä» invokers åˆ—è¡¨ä¸­æŸ¥æ‰¾æœ‰æ•ˆå¯ç”¨çš„ Invokerï¼Œè‹¥æœªèƒ½æ‰¾åˆ°ï¼Œæ­¤æ—¶å†åˆ° selected åˆ—è¡¨ä¸­ç»§ç»­æŸ¥æ‰¾ã€‚å…³äº reselect æ–¹æ³•å°±å…ˆåˆ†æåˆ°è¿™ï¼Œç»§ç»­åˆ†æå…¶ä»–çš„ Cluster Invokerã€‚\n\n3.2.2 FailbackClusterInvokerFailbackClusterInvoker ä¼šåœ¨è°ƒç”¨å¤±è´¥åï¼Œè¿”å›ä¸€ä¸ªç©ºç»“æœç»™æœåŠ¡æ¶ˆè´¹è€…ã€‚å¹¶é€šè¿‡å®šæ—¶ä»»åŠ¡å¯¹å¤±è´¥çš„è°ƒç”¨è¿›è¡Œé‡ä¼ ï¼Œé€‚åˆæ‰§è¡Œæ¶ˆæ¯é€šçŸ¥ç­‰æ“ä½œã€‚ä¸‹é¢æ¥çœ‹ä¸€ä¸‹å®ƒçš„å®ç°é€»è¾‘ã€‚\npublic class FailbackClusterInvoker&lt;T> extends AbstractClusterInvoker&lt;T> &#123;\n\n    private static final long RETRY_FAILED_PERIOD = 5 * 1000;\n\n    private final ScheduledExecutorService scheduledExecutorService = Executors.newScheduledThreadPool(2,\n            new NamedInternalThreadFactory(\"failback-cluster-timer\", true));\n\n    private final ConcurrentMap&lt;Invocation, AbstractClusterInvoker&lt;?>> failed = new ConcurrentHashMap&lt;Invocation, AbstractClusterInvoker&lt;?>>();\n    private volatile ScheduledFuture&lt;?> retryFuture;\n\n    @Override\n    protected Result doInvoke(Invocation invocation, List&lt;Invoker&lt;T>> invokers, LoadBalance loadbalance) throws RpcException &#123;\n        try &#123;\n            checkInvokers(invokers, invocation);\n            // é€‰æ‹© Invoker\n            Invoker&lt;T> invoker = select(loadbalance, invocation, invokers, null);\n            // è¿›è¡Œè°ƒç”¨\n            return invoker.invoke(invocation);\n        &#125; catch (Throwable e) &#123;\n            // å¦‚æœè°ƒç”¨è¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸ï¼Œæ­¤æ—¶ä»…æ‰“å°é”™è¯¯æ—¥å¿—ï¼Œä¸æŠ›å‡ºå¼‚å¸¸\n            logger.error(\"Failback to invoke method ...\");\n            \n            // è®°å½•è°ƒç”¨ä¿¡æ¯\n            addFailed(invocation, this);\n            // è¿”å›ä¸€ä¸ªç©ºç»“æœç»™æœåŠ¡æ¶ˆè´¹è€…\n            return new RpcResult();\n        &#125;\n    &#125;\n\n    private void addFailed(Invocation invocation, AbstractClusterInvoker&lt;?> router) &#123;\n        if (retryFuture == null) &#123;\n            synchronized (this) &#123;\n                if (retryFuture == null) &#123;\n                    // åˆ›å»ºå®šæ—¶ä»»åŠ¡ï¼Œæ¯éš”5ç§’æ‰§è¡Œä¸€æ¬¡\n                    retryFuture = scheduledExecutorService.scheduleWithFixedDelay(new Runnable() &#123;\n\n                        @Override\n                        public void run() &#123;\n                            try &#123;\n                                // å¯¹å¤±è´¥çš„è°ƒç”¨è¿›è¡Œé‡è¯•\n                                retryFailed();\n                            &#125; catch (Throwable t) &#123;\n                                // å¦‚æœå‘ç”Ÿå¼‚å¸¸ï¼Œä»…æ‰“å°å¼‚å¸¸æ—¥å¿—ï¼Œä¸æŠ›å‡º\n                                logger.error(\"Unexpected error occur at collect statistic\", t);\n                            &#125;\n                        &#125;\n                    &#125;, RETRY_FAILED_PERIOD, RETRY_FAILED_PERIOD, TimeUnit.MILLISECONDS);\n                &#125;\n            &#125;\n        &#125;\n        \n        // æ·»åŠ  invocation å’Œ invoker åˆ° failed ä¸­\n        failed.put(invocation, router);\n    &#125;\n\n    void retryFailed() &#123;\n        if (failed.size() == 0) &#123;\n            return;\n        &#125;\n        \n        // éå† failedï¼Œå¯¹å¤±è´¥çš„è°ƒç”¨è¿›è¡Œé‡è¯•\n        for (Map.Entry&lt;Invocation, AbstractClusterInvoker&lt;?>> entry : new HashMap&lt;Invocation, AbstractClusterInvoker&lt;?>>(failed).entrySet()) &#123;\n            Invocation invocation = entry.getKey();\n            Invoker&lt;?> invoker = entry.getValue();\n            try &#123;\n                // å†æ¬¡è¿›è¡Œè°ƒç”¨\n                invoker.invoke(invocation);\n                // è°ƒç”¨æˆåŠŸåï¼Œä» failed ä¸­ç§»é™¤ invoker\n                failed.remove(invocation);\n            &#125; catch (Throwable e) &#123;\n                // ä»…æ‰“å°å¼‚å¸¸ï¼Œä¸æŠ›å‡º\n                logger.error(\"Failed retry to invoke method ...\");\n            &#125;\n        &#125;\n    &#125;\n&#125;\n\nè¿™ä¸ªç±»ä¸»è¦ç”±3ä¸ªæ–¹æ³•ç»„æˆï¼Œé¦–å…ˆæ˜¯ doInvokerï¼Œè¯¥æ–¹æ³•è´Ÿè´£åˆæ¬¡çš„è¿œç¨‹è°ƒç”¨ã€‚è‹¥è¿œç¨‹è°ƒç”¨å¤±è´¥ï¼Œåˆ™é€šè¿‡ addFailed æ–¹æ³•å°†è°ƒç”¨ä¿¡æ¯å­˜å…¥åˆ° failed ä¸­ï¼Œç­‰å¾…å®šæ—¶é‡è¯•ã€‚addFailed åœ¨å¼€å§‹é˜¶æ®µä¼šæ ¹æ® retryFuture ä¸ºç©ºä¸å¦ï¼Œæ¥å†³å®šæ˜¯å¦å¼€å¯å®šæ—¶ä»»åŠ¡ã€‚retryFailed æ–¹æ³•åˆ™æ˜¯åŒ…å«äº†å¤±è´¥é‡è¯•çš„é€»è¾‘ï¼Œè¯¥æ–¹æ³•ä¼šå¯¹ failed è¿›è¡Œéå†ï¼Œç„¶åä¾æ¬¡å¯¹ Invoker è¿›è¡Œè°ƒç”¨ã€‚è°ƒç”¨æˆåŠŸåˆ™å°† Invoker ä» failed ä¸­ç§»é™¤ï¼Œè°ƒç”¨å¤±è´¥åˆ™å¿½ç•¥å¤±è´¥åŸå› ã€‚\nä»¥ä¸Šå°±æ˜¯ FailbackClusterInvoker çš„æ‰§è¡Œé€»è¾‘ï¼Œä¸æ˜¯å¾ˆå¤æ‚ï¼Œç»§ç»­å¾€ä¸‹çœ‹ã€‚\n\n3.2.3 FailfastClusterInvokerFailfastClusterInvoker åªä¼šå‘èµ·ä¸€æ¬¡è°ƒç”¨ï¼Œå¤±è´¥åç«‹å³æŠ›å‡ºå¼‚å¸¸ã€‚é€šå¸¸ç”¨äºéå¹‚ç­‰æ€§çš„å†™æ“ä½œï¼Œæ¯”å¦‚æ–°å¢è®°å½•ã€‚æºç å¦‚ä¸‹ï¼š\npublic class FailfastClusterInvoker&lt;T> extends AbstractClusterInvoker&lt;T> &#123;\n\n    @Override\n    public Result doInvoke(Invocation invocation, List&lt;Invoker&lt;T>> invokers, LoadBalance loadbalance) throws RpcException &#123;\n        checkInvokers(invokers, invocation);\n        // é€‰æ‹© Invoker\n        Invoker&lt;T> invoker = select(loadbalance, invocation, invokers, null);\n        try &#123;\n            // è°ƒç”¨ Invoker\n            return invoker.invoke(invocation);\n        &#125; catch (Throwable e) &#123;\n            if (e instanceof RpcException &amp;&amp; ((RpcException) e).isBiz()) &#123;\n                // æŠ›å‡ºå¼‚å¸¸\n                throw (RpcException) e;\n            &#125;\n            // æŠ›å‡ºå¼‚å¸¸\n            throw new RpcException(..., \"Failfast invoke providers ...\");\n        &#125;\n    &#125;\n&#125;\n\nå¦‚ä¸Šï¼Œé¦–å…ˆæ˜¯é€šè¿‡ select æ–¹æ³•é€‰æ‹© Invokerï¼Œç„¶åè¿›è¡Œè¿œç¨‹è°ƒç”¨ã€‚å¦‚æœè°ƒç”¨å¤±è´¥ï¼Œåˆ™ç«‹å³æŠ›å‡ºå¼‚å¸¸ã€‚FailfastClusterInvoker å°±å…ˆåˆ†æåˆ°è¿™ï¼Œä¸‹é¢åˆ†æ FailsafeClusterInvokerã€‚\n\n3.2.4 FailsafeClusterInvokerFailsafeClusterInvoker æ˜¯ä¸€ç§å¤±è´¥å®‰å…¨çš„ Cluster Invokerã€‚æ‰€è°“çš„å¤±è´¥å®‰å…¨æ˜¯æŒ‡ï¼Œå½“è°ƒç”¨è¿‡ç¨‹ä¸­å‡ºç°å¼‚å¸¸æ—¶ï¼ŒFailsafeClusterInvoker ä»…ä¼šæ‰“å°å¼‚å¸¸ï¼Œè€Œä¸ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚é€‚ç”¨äºå†™å…¥å®¡è®¡æ—¥å¿—ç­‰æ“ä½œã€‚ä¸‹é¢åˆ†ææºç ã€‚\npublic class FailsafeClusterInvoker&lt;T> extends AbstractClusterInvoker&lt;T> &#123;\n\n    @Override\n    public Result doInvoke(Invocation invocation, List&lt;Invoker&lt;T>> invokers, LoadBalance loadbalance) throws RpcException &#123;\n        try &#123;\n            checkInvokers(invokers, invocation);\n            // é€‰æ‹© Invoker\n            Invoker&lt;T> invoker = select(loadbalance, invocation, invokers, null);\n            // è¿›è¡Œè¿œç¨‹è°ƒç”¨\n            return invoker.invoke(invocation);\n        &#125; catch (Throwable e) &#123;\n\t\t\t// æ‰“å°é”™è¯¯æ—¥å¿—ï¼Œä½†ä¸æŠ›å‡º\n            logger.error(\"Failsafe ignore exception: \" + e.getMessage(), e);\n            // è¿”å›ç©ºç»“æœå¿½ç•¥é”™è¯¯\n            return new RpcResult();\n        &#125;\n    &#125;\n&#125;\n\nFailsafeClusterInvoker çš„é€»è¾‘å’Œ FailfastClusterInvoker çš„é€»è¾‘ä¸€æ ·ç®€å•ï¼Œæ— éœ€è¿‡å¤šè¯´æ˜ã€‚ç»§ç»­å‘ä¸‹åˆ†æã€‚\n\n3.2.5 ForkingClusterInvokerForkingClusterInvoker ä¼šåœ¨è¿è¡Œæ—¶é€šè¿‡çº¿ç¨‹æ± åˆ›å»ºå¤šä¸ªçº¿ç¨‹ï¼Œå¹¶å‘è°ƒç”¨å¤šä¸ªæœåŠ¡æä¾›è€…ã€‚åªè¦æœ‰ä¸€ä¸ªæœåŠ¡æä¾›è€…æˆåŠŸè¿”å›äº†ç»“æœï¼ŒdoInvoke æ–¹æ³•å°±ä¼šç«‹å³ç»“æŸè¿è¡Œã€‚ForkingClusterInvoker çš„åº”ç”¨åœºæ™¯æ˜¯åœ¨ä¸€äº›å¯¹å®æ—¶æ€§è¦æ±‚æ¯”è¾ƒé«˜è¯»æ“ä½œï¼ˆæ³¨æ„æ˜¯è¯»æ“ä½œï¼Œå¹¶è¡Œå†™æ“ä½œå¯èƒ½ä¸å®‰å…¨ï¼‰ä¸‹ä½¿ç”¨ï¼Œä½†è¿™å°†ä¼šè€—è´¹æ›´å¤šçš„èµ„æºã€‚ä¸‹é¢æ¥çœ‹è¯¥ç±»çš„å®ç°ã€‚\npublic class ForkingClusterInvoker&lt;T> extends AbstractClusterInvoker&lt;T> &#123;\n    \n    private final ExecutorService executor = Executors.newCachedThreadPool(\n            new NamedInternalThreadFactory(\"forking-cluster-timer\", true));\n\n    @Override\n    public Result doInvoke(final Invocation invocation, List&lt;Invoker&lt;T>> invokers, LoadBalance loadbalance) throws RpcException &#123;\n        try &#123;\n            checkInvokers(invokers, invocation);\n            final List&lt;Invoker&lt;T>> selected;\n            // è·å– forks é…ç½®\n            final int forks = getUrl().getParameter(Constants.FORKS_KEY, Constants.DEFAULT_FORKS);\n            // è·å–è¶…æ—¶é…ç½®\n            final int timeout = getUrl().getParameter(Constants.TIMEOUT_KEY, Constants.DEFAULT_TIMEOUT);\n            // å¦‚æœ forks é…ç½®ä¸åˆç†ï¼Œåˆ™ç›´æ¥å°† invokers èµ‹å€¼ç»™ selected\n            if (forks &lt;= 0 || forks >= invokers.size()) &#123;\n                selected = invokers;\n            &#125; else &#123;\n                selected = new ArrayList&lt;Invoker&lt;T>>();\n                // å¾ªç¯é€‰å‡º forks ä¸ª Invokerï¼Œå¹¶æ·»åŠ åˆ° selected ä¸­\n                for (int i = 0; i &lt; forks; i++) &#123;\n                    // é€‰æ‹© Invoker\n                    Invoker&lt;T> invoker = select(loadbalance, invocation, invokers, selected);\n                    if (!selected.contains(invoker)) &#123;\n                        selected.add(invoker);\n                    &#125;\n                &#125;\n            &#125;\n            \n            // ----------------------âœ¨ åˆ†å‰²çº¿1 âœ¨---------------------- //\n            \n            RpcContext.getContext().setInvokers((List) selected);\n            final AtomicInteger count = new AtomicInteger();\n            final BlockingQueue&lt;Object> ref = new LinkedBlockingQueue&lt;Object>();\n            // éå† selected åˆ—è¡¨\n            for (final Invoker&lt;T> invoker : selected) &#123;\n                // ä¸ºæ¯ä¸ª Invoker åˆ›å»ºä¸€ä¸ªæ‰§è¡Œçº¿ç¨‹\n                executor.execute(new Runnable() &#123;\n                    @Override\n                    public void run() &#123;\n                        try &#123;\n                            // è¿›è¡Œè¿œç¨‹è°ƒç”¨\n                            Result result = invoker.invoke(invocation);\n                            // å°†ç»“æœå­˜åˆ°é˜»å¡é˜Ÿåˆ—ä¸­\n                            ref.offer(result);\n                        &#125; catch (Throwable e) &#123;\n                            int value = count.incrementAndGet();\n                            // ä»…åœ¨ value å¤§äºç­‰äº selected.size() æ—¶ï¼Œæ‰å°†å¼‚å¸¸å¯¹è±¡\n                            // æ”¾å…¥é˜»å¡é˜Ÿåˆ—ä¸­ï¼Œè¯·å¤§å®¶æ€è€ƒä¸€ä¸‹ä¸ºä»€ä¹ˆè¦è¿™æ ·åšã€‚\n                            if (value >= selected.size()) &#123;\n                                // å°†å¼‚å¸¸å¯¹è±¡å­˜å…¥åˆ°é˜»å¡é˜Ÿåˆ—ä¸­\n                                ref.offer(e);\n                            &#125;\n                        &#125;\n                    &#125;\n                &#125;);\n            &#125;\n            \n            // ----------------------âœ¨ åˆ†å‰²çº¿2 âœ¨---------------------- //\n            \n            try &#123;\n                // ä»é˜»å¡é˜Ÿåˆ—ä¸­å–å‡ºè¿œç¨‹è°ƒç”¨ç»“æœ\n                Object ret = ref.poll(timeout, TimeUnit.MILLISECONDS);\n                \n                // å¦‚æœç»“æœç±»å‹ä¸º Throwableï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸\n                if (ret instanceof Throwable) &#123;\n                    Throwable e = (Throwable) ret;\n                    throw new RpcException(..., \"Failed to forking invoke provider ...\");\n                &#125;\n                \n                // è¿”å›ç»“æœ\n                return (Result) ret;\n            &#125; catch (InterruptedException e) &#123;\n                throw new RpcException(\"Failed to forking invoke provider ...\");\n            &#125;\n        &#125; finally &#123;\n            RpcContext.getContext().clearAttachments();\n        &#125;\n    &#125;\n&#125;\n\nForkingClusterInvoker çš„ doInvoker æ–¹æ³•æ¯”è¾ƒé•¿ï¼Œè¿™é‡Œé€šè¿‡ä¸¤ä¸ªåˆ†å‰²çº¿å°†æ•´ä¸ªæ–¹æ³•åˆ’åˆ†ä¸ºä¸‰ä¸ªé€»è¾‘å—ã€‚ä»æ–¹æ³•å¼€å§‹åˆ°åˆ†å‰²çº¿1ä¹‹é—´çš„ä»£ç ä¸»è¦æ˜¯ç”¨äºé€‰å‡º forks ä¸ª Invokerï¼Œä¸ºæ¥ä¸‹æ¥çš„å¹¶å‘è°ƒç”¨æä¾›è¾“å…¥ã€‚åˆ†å‰²çº¿1å’Œåˆ†å‰²çº¿2ä¹‹é—´çš„é€»è¾‘é€šè¿‡çº¿ç¨‹æ± å¹¶å‘è°ƒç”¨å¤šä¸ª Invokerï¼Œå¹¶å°†ç»“æœå­˜å‚¨åœ¨é˜»å¡é˜Ÿåˆ—ä¸­ã€‚åˆ†å‰²çº¿2åˆ°æ–¹æ³•ç»“å°¾ä¹‹é—´çš„é€»è¾‘ä¸»è¦ç”¨äºä»é˜»å¡é˜Ÿåˆ—ä¸­è·å–è¿”å›ç»“æœï¼Œå¹¶å¯¹è¿”å›ç»“æœç±»å‹è¿›è¡Œåˆ¤æ–­ã€‚å¦‚æœä¸ºå¼‚å¸¸ç±»å‹ï¼Œåˆ™ç›´æ¥æŠ›å‡ºï¼Œå¦åˆ™è¿”å›ã€‚\nä»¥ä¸Šå°±æ˜¯ForkingClusterInvoker çš„ doInvoker æ–¹æ³•å¤§è‡´è¿‡ç¨‹ã€‚æˆ‘ä»¬åœ¨åˆ†å‰²çº¿1å’Œåˆ†å‰²çº¿2ä¹‹é—´çš„ä»£ç ä¸Šç•™äº†ä¸€ä¸ªé—®é¢˜ï¼Œé—®é¢˜æ˜¯è¿™æ ·çš„ï¼šä¸ºä»€ä¹ˆè¦åœ¨value &gt;= selected.size()çš„æƒ…å†µä¸‹ï¼Œæ‰å°†å¼‚å¸¸å¯¹è±¡æ·»åŠ åˆ°é˜»å¡é˜Ÿåˆ—ä¸­ï¼Ÿè¿™é‡Œæ¥è§£ç­”ä¸€ä¸‹ã€‚åŸå› æ˜¯è¿™æ ·çš„ï¼Œåœ¨å¹¶è¡Œè°ƒç”¨å¤šä¸ªæœåŠ¡æä¾›è€…çš„æƒ…å†µä¸‹ï¼Œåªè¦æœ‰ä¸€ä¸ªæœåŠ¡æä¾›è€…èƒ½å¤ŸæˆåŠŸè¿”å›ç»“æœï¼Œè€Œå…¶ä»–å…¨éƒ¨å¤±è´¥ã€‚æ­¤æ—¶ ForkingClusterInvoker ä»åº”è¯¥è¿”å›æˆåŠŸçš„ç»“æœï¼Œè€ŒéæŠ›å‡ºå¼‚å¸¸ã€‚åœ¨value &gt;= selected.size()æ—¶å°†å¼‚å¸¸å¯¹è±¡æ”¾å…¥é˜»å¡é˜Ÿåˆ—ä¸­ï¼Œå¯ä»¥ä¿è¯å¼‚å¸¸å¯¹è±¡ä¸ä¼šå‡ºç°åœ¨æ­£å¸¸ç»“æœçš„å‰é¢ï¼Œè¿™æ ·å¯ä»é˜»å¡é˜Ÿåˆ—ä¸­ä¼˜å…ˆå–å‡ºæ­£å¸¸çš„ç»“æœã€‚\nå…³äº ForkingClusterInvoker å°±å…ˆåˆ†æåˆ°è¿™ï¼Œæ¥ä¸‹æ¥åˆ†ææœ€åä¸€ä¸ª Cluster Invokerã€‚\n\n3.2.6 BroadcastClusterInvokeræœ¬ç« çš„æœ€åï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹ BroadcastClusterInvokerã€‚BroadcastClusterInvoker ä¼šé€ä¸ªè°ƒç”¨æ¯ä¸ªæœåŠ¡æä¾›è€…ï¼Œå¦‚æœå…¶ä¸­ä¸€å°æŠ¥é”™ï¼Œåœ¨å¾ªç¯è°ƒç”¨ç»“æŸåï¼ŒBroadcastClusterInvoker ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚è¯¥ç±»é€šå¸¸ç”¨äºé€šçŸ¥æ‰€æœ‰æä¾›è€…æ›´æ–°ç¼“å­˜æˆ–æ—¥å¿—ç­‰æœ¬åœ°èµ„æºä¿¡æ¯ã€‚æºç å¦‚ä¸‹ã€‚\npublic class BroadcastClusterInvoker&lt;T> extends AbstractClusterInvoker&lt;T> &#123;\n\n    @Override\n    public Result doInvoke(final Invocation invocation, List&lt;Invoker&lt;T>> invokers, LoadBalance loadbalance) throws RpcException &#123;\n        checkInvokers(invokers, invocation);\n        RpcContext.getContext().setInvokers((List) invokers);\n        RpcException exception = null;\n        Result result = null;\n        // éå† Invoker åˆ—è¡¨ï¼Œé€ä¸ªè°ƒç”¨\n        for (Invoker&lt;T> invoker : invokers) &#123;\n            try &#123;\n                // è¿›è¡Œè¿œç¨‹è°ƒç”¨\n                result = invoker.invoke(invocation);\n            &#125; catch (RpcException e) &#123;\n                exception = e;\n                logger.warn(e.getMessage(), e);\n            &#125; catch (Throwable e) &#123;\n                exception = new RpcException(e.getMessage(), e);\n                logger.warn(e.getMessage(), e);\n            &#125;\n        &#125;\n        \n        // exception ä¸ä¸ºç©ºï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸\n        if (exception != null) &#123;\n            throw exception;\n        &#125;\n        return result;\n    &#125;\n&#125;\n\nä»¥ä¸Šå°±æ˜¯ BroadcastClusterInvoker çš„ä»£ç ï¼Œæ¯”è¾ƒç®€å•ï¼Œå°±ä¸å¤šè¯´äº†ã€‚\n\n4.æ€»ç»“æœ¬ç¯‡æ–‡ç« è¯¦ç»†åˆ†æäº†é›†ç¾¤å®¹é”™çš„å‡ ç§å®ç°æ–¹å¼ã€‚é›†ç¾¤å®¹é”™å¯¹äº Dubbo æ¡†æ¶æ¥è¯´ï¼Œæ˜¯å¾ˆé‡è¦çš„é€»è¾‘ã€‚é›†ç¾¤æ¨¡å—å¤„äºæœåŠ¡æä¾›è€…å’Œæ¶ˆè´¹è€…ä¹‹é—´ï¼Œå¯¹äºæœåŠ¡æ¶ˆè´¹è€…æ¥è¯´ï¼Œé›†ç¾¤å¯å‘å…¶å±è”½æœåŠ¡æä¾›è€…é›†ç¾¤çš„æƒ…å†µï¼Œä½¿å…¶èƒ½å¤Ÿä¸“å¿ƒè¿›è¡Œè¿œç¨‹è°ƒç”¨ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œé€šè¿‡é›†ç¾¤æ¨¡å—ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å¯¹æœåŠ¡ä¹‹é—´çš„è°ƒç”¨é“¾è·¯è¿›è¡Œç¼–æ’ä¼˜åŒ–ï¼Œæ²»ç†æœåŠ¡ã€‚æ€»çš„æ¥è¯´ï¼Œå¯¹äº Dubbo è€Œè¨€ï¼Œé›†ç¾¤å®¹é”™ç›¸å…³é€»è¾‘æ˜¯éå¸¸é‡è¦çš„ã€‚æƒ³è¦å¯¹ Dubbo æœ‰æ¯”è¾ƒæ·±çš„ç†è§£ï¼Œé›†ç¾¤å®¹é”™æ˜¯å¿…é¡»è¦æŒæ¡çš„ã€‚\nå…³äºé›†ç¾¤æ¨¡å—å°±å…ˆåˆ†æåˆ°è¿™ï¼Œæ„Ÿè°¢é˜…è¯»ã€‚\næœ¬æ–‡ä»‹ç»äº†è´Ÿè½½å‡è¡¡çš„åŸç†å’Œå®ç°ç»†èŠ‚\n\nè´Ÿè½½å‡è¡¡1.ç®€ä»‹LoadBalance ä¸­æ–‡æ„æ€ä¸ºè´Ÿè½½å‡è¡¡ï¼Œå®ƒçš„èŒè´£æ˜¯å°†ç½‘ç»œè¯·æ±‚ï¼Œæˆ–è€…å…¶ä»–å½¢å¼çš„è´Ÿè½½â€œå‡æ‘Šâ€åˆ°ä¸åŒçš„æœºå™¨ä¸Šã€‚é¿å…é›†ç¾¤ä¸­éƒ¨åˆ†æœåŠ¡å™¨å‹åŠ›è¿‡å¤§ï¼Œè€Œå¦ä¸€äº›æœåŠ¡å™¨æ¯”è¾ƒç©ºé—²çš„æƒ…å†µã€‚é€šè¿‡è´Ÿè½½å‡è¡¡ï¼Œå¯ä»¥è®©æ¯å°æœåŠ¡å™¨è·å–åˆ°é€‚åˆè‡ªå·±å¤„ç†èƒ½åŠ›çš„è´Ÿè½½ã€‚åœ¨ä¸ºé«˜è´Ÿè½½æœåŠ¡å™¨åˆ†æµçš„åŒæ—¶ï¼Œè¿˜å¯ä»¥é¿å…èµ„æºæµªè´¹ï¼Œä¸€ä¸¾ä¸¤å¾—ã€‚è´Ÿè½½å‡è¡¡å¯åˆ†ä¸ºè½¯ä»¶è´Ÿè½½å‡è¡¡å’Œç¡¬ä»¶è´Ÿè½½å‡è¡¡ã€‚åœ¨æˆ‘ä»¬æ—¥å¸¸å¼€å‘ä¸­ï¼Œä¸€èˆ¬å¾ˆéš¾æ¥è§¦åˆ°ç¡¬ä»¶è´Ÿè½½å‡è¡¡ã€‚ä½†è½¯ä»¶è´Ÿè½½å‡è¡¡è¿˜æ˜¯å¯ä»¥æ¥è§¦åˆ°çš„ï¼Œæ¯”å¦‚ Nginxã€‚åœ¨ Dubbo ä¸­ï¼Œä¹Ÿæœ‰è´Ÿè½½å‡è¡¡çš„æ¦‚å¿µå’Œç›¸åº”çš„å®ç°ã€‚Dubbo éœ€è¦å¯¹æœåŠ¡æ¶ˆè´¹è€…çš„è°ƒç”¨è¯·æ±‚è¿›è¡Œåˆ†é…ï¼Œé¿å…å°‘æ•°æœåŠ¡æä¾›è€…è´Ÿè½½è¿‡å¤§ã€‚æœåŠ¡æä¾›è€…è´Ÿè½½è¿‡å¤§ï¼Œä¼šå¯¼è‡´éƒ¨åˆ†è¯·æ±‚è¶…æ—¶ã€‚å› æ­¤å°†è´Ÿè½½å‡è¡¡åˆ°æ¯ä¸ªæœåŠ¡æä¾›è€…ä¸Šï¼Œæ˜¯éå¸¸å¿…è¦çš„ã€‚Dubbo æä¾›äº†4ç§è´Ÿè½½å‡è¡¡å®ç°ï¼Œåˆ†åˆ«æ˜¯åŸºäºæƒé‡éšæœºç®—æ³•çš„ RandomLoadBalanceã€åŸºäºæœ€å°‘æ´»è·ƒè°ƒç”¨æ•°ç®—æ³•çš„ LeastActiveLoadBalanceã€åŸºäº hash ä¸€è‡´æ€§çš„ ConsistentHashLoadBalanceï¼Œä»¥åŠåŸºäºåŠ æƒè½®è¯¢ç®—æ³•çš„ RoundRobinLoadBalanceã€‚è¿™å‡ ä¸ªè´Ÿè½½å‡è¡¡ç®—æ³•ä»£ç ä¸æ˜¯å¾ˆé•¿ï¼Œä½†æ˜¯æƒ³çœ‹æ‡‚ä¹Ÿä¸æ˜¯å¾ˆå®¹æ˜“ï¼Œéœ€è¦å¤§å®¶å¯¹è¿™å‡ ä¸ªç®—æ³•çš„åŸç†æœ‰ä¸€å®šäº†è§£æ‰è¡Œã€‚å¦‚æœä¸æ˜¯å¾ˆäº†è§£ï¼Œä¹Ÿæ²¡ä¸ç”¨å¤ªæ‹…å¿ƒã€‚æˆ‘ä»¬ä¼šåœ¨åˆ†ææ¯ä¸ªç®—æ³•çš„æºç ä¹‹å‰ï¼Œå¯¹ç®—æ³•åŸç†è¿›è¡Œç®€å•çš„è®²è§£ï¼Œå¸®åŠ©å¤§å®¶å»ºç«‹åˆæ­¥çš„å°è±¡ã€‚\næœ¬ç³»åˆ—æ–‡ç« åœ¨ç¼–å†™ä¹‹åˆæ˜¯åŸºäº Dubbo 2.6.4 çš„ï¼Œè¿‘æœŸï¼ŒDubbo 2.6.5 å‘å¸ƒäº†ï¼Œå…¶ä¸­å°±æœ‰é’ˆå¯¹å¯¹è´Ÿè½½å‡è¡¡éƒ¨åˆ†çš„ä¼˜åŒ–ã€‚å› æ­¤æˆ‘ä»¬åœ¨åˆ†æå®Œ 2.6.4 ç‰ˆæœ¬åçš„æºç åï¼Œä¼šå¦å¤–åˆ†æ 2.6.5 æ›´æ–°çš„éƒ¨åˆ†ã€‚å…¶ä»–çš„å°±ä¸å¤šè¯´äº†ï¼Œè¿›å…¥æ­£é¢˜å§ã€‚\n\n2.æºç åˆ†æåœ¨ Dubbo ä¸­ï¼Œæ‰€æœ‰è´Ÿè½½å‡è¡¡å®ç°ç±»å‡ç»§æ‰¿è‡ª AbstractLoadBalanceï¼Œè¯¥ç±»å®ç°äº† LoadBalance æ¥å£ï¼Œå¹¶å°è£…äº†ä¸€äº›å…¬å…±çš„é€»è¾‘ã€‚æ‰€ä»¥åœ¨åˆ†æè´Ÿè½½å‡è¡¡å®ç°ä¹‹å‰ï¼Œå…ˆæ¥çœ‹ä¸€ä¸‹ AbstractLoadBalance çš„é€»è¾‘ã€‚é¦–å…ˆæ¥çœ‹ä¸€ä¸‹è´Ÿè½½å‡è¡¡çš„å…¥å£æ–¹æ³• selectï¼Œå¦‚ä¸‹ï¼š\n@Override\npublic &lt;T> Invoker&lt;T> select(List&lt;Invoker&lt;T>> invokers, URL url, Invocation invocation) &#123;\n    if (invokers == null || invokers.isEmpty())\n        return null;\n    // å¦‚æœ invokers åˆ—è¡¨ä¸­ä»…æœ‰ä¸€ä¸ª Invokerï¼Œç›´æ¥è¿”å›å³å¯ï¼Œæ— éœ€è¿›è¡Œè´Ÿè½½å‡è¡¡\n    if (invokers.size() == 1)\n        return invokers.get(0);\n    \n    // è°ƒç”¨ doSelect æ–¹æ³•è¿›è¡Œè´Ÿè½½å‡è¡¡ï¼Œè¯¥æ–¹æ³•ä¸ºæŠ½è±¡æ–¹æ³•ï¼Œç”±å­ç±»å®ç°\n    return doSelect(invokers, url, invocation);\n&#125;\n\nprotected abstract &lt;T> Invoker&lt;T> doSelect(List&lt;Invoker&lt;T>> invokers, URL url, Invocation invocation);\n\nselect æ–¹æ³•çš„é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œé¦–å…ˆä¼šæ£€æµ‹ invokers é›†åˆçš„åˆæ³•æ€§ï¼Œç„¶åå†æ£€æµ‹ invokers é›†åˆå…ƒç´ æ•°é‡ã€‚å¦‚æœåªåŒ…å«ä¸€ä¸ª Invokerï¼Œç›´æ¥è¿”å›è¯¥ Inovker å³å¯ã€‚å¦‚æœåŒ…å«å¤šä¸ª Invokerï¼Œæ­¤æ—¶éœ€è¦é€šè¿‡è´Ÿè½½å‡è¡¡ç®—æ³•é€‰æ‹©ä¸€ä¸ª Invokerã€‚å…·ä½“çš„è´Ÿè½½å‡è¡¡ç®—æ³•ç”±å­ç±»å®ç°ï¼Œæ¥ä¸‹æ¥ç« èŠ‚ä¼šå¯¹è¿™äº›å­ç±»ä¸€ä¸€è¿›è¡Œè¯¦ç»†åˆ†æã€‚\nAbstractLoadBalance é™¤äº†å®ç°äº† LoadBalance æ¥å£æ–¹æ³•ï¼Œè¿˜å°è£…äº†ä¸€äº›å…¬å…±é€»è¾‘ï¼Œæ¯”å¦‚æœåŠ¡æä¾›è€…æƒé‡è®¡ç®—é€»è¾‘ã€‚å…·ä½“å®ç°å¦‚ä¸‹ï¼š\nprotected int getWeight(Invoker&lt;?> invoker, Invocation invocation) &#123;\n    // ä» url ä¸­è·å–æƒé‡ weight é…ç½®å€¼\n    int weight = invoker.getUrl().getMethodParameter(invocation.getMethodName(), Constants.WEIGHT_KEY, Constants.DEFAULT_WEIGHT);\n    if (weight > 0) &#123;\n        // è·å–æœåŠ¡æä¾›è€…å¯åŠ¨æ—¶é—´æˆ³\n        long timestamp = invoker.getUrl().getParameter(Constants.REMOTE_TIMESTAMP_KEY, 0L);\n        if (timestamp > 0L) &#123;\n            // è®¡ç®—æœåŠ¡æä¾›è€…è¿è¡Œæ—¶é•¿\n            int uptime = (int) (System.currentTimeMillis() - timestamp);\n            // è·å–æœåŠ¡é¢„çƒ­æ—¶é—´ï¼Œé»˜è®¤ä¸º10åˆ†é’Ÿ\n            int warmup = invoker.getUrl().getParameter(Constants.WARMUP_KEY, Constants.DEFAULT_WARMUP);\n            // å¦‚æœæœåŠ¡è¿è¡Œæ—¶é—´å°äºé¢„çƒ­æ—¶é—´ï¼Œåˆ™é‡æ–°è®¡ç®—æœåŠ¡æƒé‡ï¼Œå³é™æƒ\n            if (uptime > 0 &amp;&amp; uptime &lt; warmup) &#123;\n                // é‡æ–°è®¡ç®—æœåŠ¡æƒé‡\n                weight = calculateWarmupWeight(uptime, warmup, weight);\n            &#125;\n        &#125;\n    &#125;\n    return weight;\n&#125;\n\nstatic int calculateWarmupWeight(int uptime, int warmup, int weight) &#123;\n    // è®¡ç®—æƒé‡ï¼Œä¸‹é¢ä»£ç é€»è¾‘ä¸Šå½¢ä¼¼äº (uptime / warmup) * weightã€‚\n    // éšç€æœåŠ¡è¿è¡Œæ—¶é—´ uptime å¢å¤§ï¼Œæƒé‡è®¡ç®—å€¼ ww ä¼šæ…¢æ…¢æ¥è¿‘é…ç½®å€¼ weight\n    int ww = (int) ((float) uptime / ((float) warmup / (float) weight));\n    return ww &lt; 1 ? 1 : (ww > weight ? weight : ww);\n&#125;\n\nä¸Šé¢æ˜¯æƒé‡çš„è®¡ç®—è¿‡ç¨‹ï¼Œè¯¥è¿‡ç¨‹ä¸»è¦ç”¨äºä¿è¯å½“æœåŠ¡è¿è¡Œæ—¶é•¿å°äºæœåŠ¡é¢„çƒ­æ—¶é—´æ—¶ï¼Œå¯¹æœåŠ¡è¿›è¡Œé™æƒï¼Œé¿å…è®©æœåŠ¡åœ¨å¯åŠ¨ä¹‹åˆå°±å¤„äºé«˜è´Ÿè½½çŠ¶æ€ã€‚æœåŠ¡é¢„çƒ­æ˜¯ä¸€ä¸ªä¼˜åŒ–æ‰‹æ®µï¼Œä¸æ­¤ç±»ä¼¼çš„è¿˜æœ‰ JVM é¢„çƒ­ã€‚ä¸»è¦ç›®çš„æ˜¯è®©æœåŠ¡å¯åŠ¨åâ€œä½åŠŸç‡â€è¿è¡Œä¸€æ®µæ—¶é—´ï¼Œä½¿å…¶æ•ˆç‡æ…¢æ…¢æå‡è‡³æœ€ä½³çŠ¶æ€ã€‚\nå…³äº AbstractLoadBalance å°±å…ˆåˆ†æåˆ°è¿™ï¼Œæ¥ä¸‹æ¥åˆ†æå„ä¸ªå®ç°ç±»çš„ä»£ç ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬ä» Dubbo ç¼ºçœçš„å®ç°ç±» RandomLoadBalance çœ‹èµ·ã€‚\n\n2.1 RandomLoadBalanceRandomLoadBalance æ˜¯åŠ æƒéšæœºç®—æ³•çš„å…·ä½“å®ç°ï¼Œå®ƒçš„ç®—æ³•æ€æƒ³å¾ˆç®€å•ã€‚å‡è®¾æˆ‘ä»¬æœ‰ä¸€ç»„æœåŠ¡å™¨ servers &#x3D; [A, B, C]ï¼Œä»–ä»¬å¯¹åº”çš„æƒé‡ä¸º weights &#x3D; [5, 3, 2]ï¼Œæƒé‡æ€»å’Œä¸º10ã€‚ç°åœ¨æŠŠè¿™äº›æƒé‡å€¼å¹³é“ºåœ¨ä¸€ç»´åæ ‡å€¼ä¸Šï¼Œ[0, 5) åŒºé—´å±äºæœåŠ¡å™¨ Aï¼Œ[5, 8) åŒºé—´å±äºæœåŠ¡å™¨ Bï¼Œ[8, 10) åŒºé—´å±äºæœåŠ¡å™¨ Cã€‚æ¥ä¸‹æ¥é€šè¿‡éšæœºæ•°ç”Ÿæˆå™¨ç”Ÿæˆä¸€ä¸ªèŒƒå›´åœ¨ [0, 10) ä¹‹é—´çš„éšæœºæ•°ï¼Œç„¶åè®¡ç®—è¿™ä¸ªéšæœºæ•°ä¼šè½åˆ°å“ªä¸ªåŒºé—´ä¸Šã€‚æ¯”å¦‚æ•°å­—3ä¼šè½åˆ°æœåŠ¡å™¨ A å¯¹åº”çš„åŒºé—´ä¸Šï¼Œæ­¤æ—¶è¿”å›æœåŠ¡å™¨ A å³å¯ã€‚æƒé‡è¶Šå¤§çš„æœºå™¨ï¼Œåœ¨åæ ‡è½´ä¸Šå¯¹åº”çš„åŒºé—´èŒƒå›´å°±è¶Šå¤§ï¼Œå› æ­¤éšæœºæ•°ç”Ÿæˆå™¨ç”Ÿæˆçš„æ•°å­—å°±ä¼šæœ‰æ›´å¤§çš„æ¦‚ç‡è½åˆ°æ­¤åŒºé—´å†…ã€‚åªè¦éšæœºæ•°ç”Ÿæˆå™¨äº§ç”Ÿçš„éšæœºæ•°åˆ†å¸ƒæ€§å¾ˆå¥½ï¼Œåœ¨ç»è¿‡å¤šæ¬¡é€‰æ‹©åï¼Œæ¯ä¸ªæœåŠ¡å™¨è¢«é€‰ä¸­çš„æ¬¡æ•°æ¯”ä¾‹æ¥è¿‘å…¶æƒé‡æ¯”ä¾‹ã€‚æ¯”å¦‚ï¼Œç»è¿‡ä¸€ä¸‡æ¬¡é€‰æ‹©åï¼ŒæœåŠ¡å™¨ A è¢«é€‰ä¸­çš„æ¬¡æ•°å¤§çº¦ä¸º5000æ¬¡ï¼ŒæœåŠ¡å™¨ B è¢«é€‰ä¸­çš„æ¬¡æ•°çº¦ä¸º3000æ¬¡ï¼ŒæœåŠ¡å™¨ C è¢«é€‰ä¸­çš„æ¬¡æ•°çº¦ä¸º2000æ¬¡ã€‚\nä»¥ä¸Šå°±æ˜¯ RandomLoadBalance èƒŒåçš„ç®—æ³•æ€æƒ³ï¼Œæ¯”è¾ƒç®€å•ã€‚ä¸‹é¢å¼€å§‹åˆ†ææºç ã€‚\npublic class RandomLoadBalance extends AbstractLoadBalance &#123;\n\n    public static final String NAME = \"random\";\n\n    private final Random random = new Random();\n\n    @Override\n    protected &lt;T> Invoker&lt;T> doSelect(List&lt;Invoker&lt;T>> invokers, URL url, Invocation invocation) &#123;\n        int length = invokers.size();\n        int totalWeight = 0;\n        boolean sameWeight = true;\n        // ä¸‹é¢è¿™ä¸ªå¾ªç¯æœ‰ä¸¤ä¸ªä½œç”¨ï¼Œç¬¬ä¸€æ˜¯è®¡ç®—æ€»æƒé‡ totalWeightï¼Œ\n        // ç¬¬äºŒæ˜¯æ£€æµ‹æ¯ä¸ªæœåŠ¡æä¾›è€…çš„æƒé‡æ˜¯å¦ç›¸åŒ\n        for (int i = 0; i &lt; length; i++) &#123;\n            int weight = getWeight(invokers.get(i), invocation);\n            // ç´¯åŠ æƒé‡\n            totalWeight += weight;\n            // æ£€æµ‹å½“å‰æœåŠ¡æä¾›è€…çš„æƒé‡ä¸ä¸Šä¸€ä¸ªæœåŠ¡æä¾›è€…çš„æƒé‡æ˜¯å¦ç›¸åŒï¼Œ\n            // ä¸ç›¸åŒçš„è¯ï¼Œåˆ™å°† sameWeight ç½®ä¸º falseã€‚\n            if (sameWeight &amp;&amp; i > 0\n                    &amp;&amp; weight != getWeight(invokers.get(i - 1), invocation)) &#123;\n                sameWeight = false;\n            &#125;\n        &#125;\n        \n        // ä¸‹é¢çš„ if åˆ†æ”¯ä¸»è¦ç”¨äºè·å–éšæœºæ•°ï¼Œå¹¶è®¡ç®—éšæœºæ•°è½åœ¨å“ªä¸ªåŒºé—´ä¸Š\n        if (totalWeight > 0 &amp;&amp; !sameWeight) &#123;\n            // éšæœºè·å–ä¸€ä¸ª [0, totalWeight) åŒºé—´å†…çš„æ•°å­—\n            int offset = random.nextInt(totalWeight);\n            // å¾ªç¯è®© offset æ•°å‡å»æœåŠ¡æä¾›è€…æƒé‡å€¼ï¼Œå½“ offset å°äº0æ—¶ï¼Œè¿”å›ç›¸åº”çš„ Invokerã€‚\n            // ä¸¾ä¾‹è¯´æ˜ä¸€ä¸‹ï¼Œæˆ‘ä»¬æœ‰ servers = [A, B, C]ï¼Œweights = [5, 3, 2]ï¼Œoffset = 7ã€‚\n            // ç¬¬ä¸€æ¬¡å¾ªç¯ï¼Œoffset - 5 = 2 > 0ï¼Œå³ offset > 5ï¼Œ\n            // è¡¨æ˜å…¶ä¸ä¼šè½åœ¨æœåŠ¡å™¨ A å¯¹åº”çš„åŒºé—´ä¸Šã€‚\n            // ç¬¬äºŒæ¬¡å¾ªç¯ï¼Œoffset - 3 = -1 &lt; 0ï¼Œå³ 5 &lt; offset &lt; 8ï¼Œ\n            // è¡¨æ˜å…¶ä¼šè½åœ¨æœåŠ¡å™¨ B å¯¹åº”çš„åŒºé—´ä¸Š\n            for (int i = 0; i &lt; length; i++) &#123;\n                // è®©éšæœºå€¼ offset å‡å»æƒé‡å€¼\n                offset -= getWeight(invokers.get(i), invocation);\n                if (offset &lt; 0) &#123;\n                    // è¿”å›ç›¸åº”çš„ Invoker\n                    return invokers.get(i);\n                &#125;\n            &#125;\n        &#125;\n        \n        // å¦‚æœæ‰€æœ‰æœåŠ¡æä¾›è€…æƒé‡å€¼ç›¸åŒï¼Œæ­¤æ—¶ç›´æ¥éšæœºè¿”å›ä¸€ä¸ªå³å¯\n        return invokers.get(random.nextInt(length));\n    &#125;\n&#125;\n\nRandomLoadBalance çš„ç®—æ³•æ€æƒ³æ¯”è¾ƒç®€å•ï¼Œåœ¨ç»è¿‡å¤šæ¬¡è¯·æ±‚åï¼Œèƒ½å¤Ÿå°†è°ƒç”¨è¯·æ±‚æŒ‰ç…§æƒé‡å€¼è¿›è¡Œâ€œå‡åŒ€â€åˆ†é…ã€‚å½“ç„¶ RandomLoadBalance ä¹Ÿå­˜åœ¨ä¸€å®šçš„ç¼ºç‚¹ï¼Œå½“è°ƒç”¨æ¬¡æ•°æ¯”è¾ƒå°‘æ—¶ï¼ŒRandom äº§ç”Ÿçš„éšæœºæ•°å¯èƒ½ä¼šæ¯”è¾ƒé›†ä¸­ï¼Œæ­¤æ—¶å¤šæ•°è¯·æ±‚ä¼šè½åˆ°åŒä¸€å°æœåŠ¡å™¨ä¸Šã€‚è¿™ä¸ªç¼ºç‚¹å¹¶ä¸æ˜¯å¾ˆä¸¥é‡ï¼Œå¤šæ•°æƒ…å†µä¸‹å¯ä»¥å¿½ç•¥ã€‚RandomLoadBalance æ˜¯ä¸€ä¸ªç®€å•ï¼Œé«˜æ•ˆçš„è´Ÿè½½å‡è¡¡å®ç°ï¼Œå› æ­¤ Dubbo é€‰æ‹©å®ƒä½œä¸ºç¼ºçœå®ç°ã€‚\nå…³äº RandomLoadBalance å°±å…ˆåˆ°è¿™äº†ï¼Œæ¥ä¸‹æ¥åˆ†æ LeastActiveLoadBalanceã€‚\n\n2.2 LeastActiveLoadBalanceLeastActiveLoadBalance ç¿»è¯‘è¿‡æ¥æ˜¯æœ€å°æ´»è·ƒæ•°è´Ÿè½½å‡è¡¡ã€‚æ´»è·ƒè°ƒç”¨æ•°è¶Šå°ï¼Œè¡¨æ˜è¯¥æœåŠ¡æä¾›è€…æ•ˆç‡è¶Šé«˜ï¼Œå•ä½æ—¶é—´å†…å¯å¤„ç†æ›´å¤šçš„è¯·æ±‚ã€‚æ­¤æ—¶åº”ä¼˜å…ˆå°†è¯·æ±‚åˆ†é…ç»™è¯¥æœåŠ¡æä¾›è€…ã€‚åœ¨å…·ä½“å®ç°ä¸­ï¼Œæ¯ä¸ªæœåŠ¡æä¾›è€…å¯¹åº”ä¸€ä¸ªæ´»è·ƒæ•° activeã€‚åˆå§‹æƒ…å†µä¸‹ï¼Œæ‰€æœ‰æœåŠ¡æä¾›è€…æ´»è·ƒæ•°å‡ä¸º0ã€‚æ¯æ”¶åˆ°ä¸€ä¸ªè¯·æ±‚ï¼Œæ´»è·ƒæ•°åŠ 1ï¼Œå®Œæˆè¯·æ±‚ååˆ™å°†æ´»è·ƒæ•°å‡1ã€‚åœ¨æœåŠ¡è¿è¡Œä¸€æ®µæ—¶é—´åï¼Œæ€§èƒ½å¥½çš„æœåŠ¡æä¾›è€…å¤„ç†è¯·æ±‚çš„é€Ÿåº¦æ›´å¿«ï¼Œå› æ­¤æ´»è·ƒæ•°ä¸‹é™çš„ä¹Ÿè¶Šå¿«ï¼Œæ­¤æ—¶è¿™æ ·çš„æœåŠ¡æä¾›è€…èƒ½å¤Ÿä¼˜å…ˆè·å–åˆ°æ–°çš„æœåŠ¡è¯·æ±‚ã€è¿™å°±æ˜¯æœ€å°æ´»è·ƒæ•°è´Ÿè½½å‡è¡¡ç®—æ³•çš„åŸºæœ¬æ€æƒ³ã€‚é™¤äº†æœ€å°æ´»è·ƒæ•°ï¼ŒLeastActiveLoadBalance åœ¨å®ç°ä¸Šè¿˜å¼•å…¥äº†æƒé‡å€¼ã€‚æ‰€ä»¥å‡†ç¡®çš„æ¥è¯´ï¼ŒLeastActiveLoadBalance æ˜¯åŸºäºåŠ æƒæœ€å°æ´»è·ƒæ•°ç®—æ³•å®ç°çš„ã€‚ä¸¾ä¸ªä¾‹å­è¯´æ˜ä¸€ä¸‹ï¼Œåœ¨ä¸€ä¸ªæœåŠ¡æä¾›è€…é›†ç¾¤ä¸­ï¼Œæœ‰ä¸¤ä¸ªæ€§èƒ½ä¼˜å¼‚çš„æœåŠ¡æä¾›è€…ã€‚æŸä¸€æ—¶åˆ»å®ƒä»¬çš„æ´»è·ƒæ•°ç›¸åŒï¼Œæ­¤æ—¶ Dubbo ä¼šæ ¹æ®å®ƒä»¬çš„æƒé‡å»åˆ†é…è¯·æ±‚ï¼Œæƒé‡è¶Šå¤§ï¼Œè·å–åˆ°æ–°è¯·æ±‚çš„æ¦‚ç‡å°±è¶Šå¤§ã€‚å¦‚æœä¸¤ä¸ªæœåŠ¡æä¾›è€…æƒé‡ç›¸åŒï¼Œæ­¤æ—¶éšæœºé€‰æ‹©ä¸€ä¸ªå³å¯ã€‚å…³äº LeastActiveLoadBalance çš„èƒŒæ™¯çŸ¥è¯†å°±å…ˆä»‹ç»åˆ°è¿™é‡Œï¼Œä¸‹é¢å¼€å§‹åˆ†ææºç ã€‚\npublic class LeastActiveLoadBalance extends AbstractLoadBalance &#123;\n\n    public static final String NAME = \"leastactive\";\n\n    private final Random random = new Random();\n\n    @Override\n    protected &lt;T> Invoker&lt;T> doSelect(List&lt;Invoker&lt;T>> invokers, URL url, Invocation invocation) &#123;\n        int length = invokers.size();\n        // æœ€å°çš„æ´»è·ƒæ•°\n        int leastActive = -1;\n        // å…·æœ‰ç›¸åŒâ€œæœ€å°æ´»è·ƒæ•°â€çš„æœåŠ¡è€…æä¾›è€…ï¼ˆä»¥ä¸‹ç”¨ Invoker ä»£ç§°ï¼‰æ•°é‡\n        int leastCount = 0; \n        // leastIndexs ç”¨äºè®°å½•å…·æœ‰ç›¸åŒâ€œæœ€å°æ´»è·ƒæ•°â€çš„ Invoker åœ¨ invokers åˆ—è¡¨ä¸­çš„ä¸‹æ ‡ä¿¡æ¯\n        int[] leastIndexs = new int[length];\n        int totalWeight = 0;\n        // ç¬¬ä¸€ä¸ªæœ€å°æ´»è·ƒæ•°çš„ Invoker æƒé‡å€¼ï¼Œç”¨äºä¸å…¶ä»–å…·æœ‰ç›¸åŒæœ€å°æ´»è·ƒæ•°çš„ Invoker çš„æƒé‡è¿›è¡Œå¯¹æ¯”ï¼Œ\n        // ä»¥æ£€æµ‹æ˜¯å¦â€œæ‰€æœ‰å…·æœ‰ç›¸åŒæœ€å°æ´»è·ƒæ•°çš„ Invoker çš„æƒé‡â€å‡ç›¸ç­‰\n        int firstWeight = 0;\n        boolean sameWeight = true;\n\n        // éå† invokers åˆ—è¡¨\n        for (int i = 0; i &lt; length; i++) &#123;\n            Invoker&lt;T> invoker = invokers.get(i);\n            // è·å– Invoker å¯¹åº”çš„æ´»è·ƒæ•°\n            int active = RpcStatus.getStatus(invoker.getUrl(), invocation.getMethodName()).getActive();\n            // è·å–æƒé‡ - â­ï¸\n            int weight = invoker.getUrl().getMethodParameter(invocation.getMethodName(), Constants.WEIGHT_KEY, Constants.DEFAULT_WEIGHT);\n            // å‘ç°æ›´å°çš„æ´»è·ƒæ•°ï¼Œé‡æ–°å¼€å§‹\n            if (leastActive == -1 || active &lt; leastActive) &#123;\n            \t// ä½¿ç”¨å½“å‰æ´»è·ƒæ•° active æ›´æ–°æœ€å°æ´»è·ƒæ•° leastActive\n                leastActive = active;\n                // æ›´æ–° leastCount ä¸º 1\n                leastCount = 1;\n                // è®°å½•å½“å‰ä¸‹æ ‡å€¼åˆ° leastIndexs ä¸­\n                leastIndexs[0] = i;\n                totalWeight = weight;\n                firstWeight = weight;\n                sameWeight = true;\n\n            // å½“å‰ Invoker çš„æ´»è·ƒæ•° active ä¸æœ€å°æ´»è·ƒæ•° leastActive ç›¸åŒ \n            &#125; else if (active == leastActive) &#123;\n            \t// åœ¨ leastIndexs ä¸­è®°å½•ä¸‹å½“å‰ Invoker åœ¨ invokers é›†åˆä¸­çš„ä¸‹æ ‡\n                leastIndexs[leastCount++] = i;\n                // ç´¯åŠ æƒé‡\n                totalWeight += weight;\n                // æ£€æµ‹å½“å‰ Invoker çš„æƒé‡ä¸ firstWeight æ˜¯å¦ç›¸ç­‰ï¼Œ\n                // ä¸ç›¸ç­‰åˆ™å°† sameWeight ç½®ä¸º false\n                if (sameWeight &amp;&amp; i > 0\n                    &amp;&amp; weight != firstWeight) &#123;\n                    sameWeight = false;\n                &#125;\n            &#125;\n        &#125;\n        \n        // å½“åªæœ‰ä¸€ä¸ª Invoker å…·æœ‰æœ€å°æ´»è·ƒæ•°ï¼Œæ­¤æ—¶ç›´æ¥è¿”å›è¯¥ Invoker å³å¯\n        if (leastCount == 1) &#123;\n            return invokers.get(leastIndexs[0]);\n        &#125;\n\n        // æœ‰å¤šä¸ª Invoker å…·æœ‰ç›¸åŒçš„æœ€å°æ´»è·ƒæ•°ï¼Œä½†å®ƒä»¬ä¹‹é—´çš„æƒé‡ä¸åŒ\n        if (!sameWeight &amp;&amp; totalWeight > 0) &#123;\n        \t// éšæœºç”Ÿæˆä¸€ä¸ª [0, totalWeight) ä¹‹é—´çš„æ•°å­—\n            int offsetWeight = random.nextInt(totalWeight);\n            // å¾ªç¯è®©éšæœºæ•°å‡å»å…·æœ‰æœ€å°æ´»è·ƒæ•°çš„ Invoker çš„æƒé‡å€¼ï¼Œ\n            // å½“ offset å°äºç­‰äº0æ—¶ï¼Œè¿”å›ç›¸åº”çš„ Invoker\n            for (int i = 0; i &lt; leastCount; i++) &#123;\n                int leastIndex = leastIndexs[i];\n                // è·å–æƒé‡å€¼ï¼Œå¹¶è®©éšæœºæ•°å‡å»æƒé‡å€¼ - â­ï¸\n                offsetWeight -= getWeight(invokers.get(leastIndex), invocation);\n                if (offsetWeight &lt;= 0)\n                    return invokers.get(leastIndex);\n            &#125;\n        &#125;\n        // å¦‚æœæƒé‡ç›¸åŒæˆ–æƒé‡ä¸º0æ—¶ï¼Œéšæœºè¿”å›ä¸€ä¸ª Invoker\n        return invokers.get(leastIndexs[random.nextInt(leastCount)]);\n    &#125;\n&#125;\n\nä¸Šé¢ä»£ç çš„é€»è¾‘æ¯”è¾ƒå¤šï¼Œæˆ‘ä»¬åœ¨ä»£ç ä¸­å†™äº†å¤§é‡çš„æ³¨é‡Šï¼Œæœ‰å¸®åŠ©å¤§å®¶ç†è§£ä»£ç é€»è¾‘ã€‚ä¸‹é¢ç®€å•æ€»ç»“ä¸€ä¸‹ä»¥ä¸Šä»£ç æ‰€åšçš„äº‹æƒ…ï¼Œå¦‚ä¸‹ï¼š\n\néå† invokers åˆ—è¡¨ï¼Œå¯»æ‰¾æ´»è·ƒæ•°æœ€å°çš„ Invoker\nå¦‚æœæœ‰å¤šä¸ª Invoker å…·æœ‰ç›¸åŒçš„æœ€å°æ´»è·ƒæ•°ï¼Œæ­¤æ—¶è®°å½•ä¸‹è¿™äº› Invoker åœ¨ invokers é›†åˆä¸­çš„ä¸‹æ ‡ï¼Œå¹¶ç´¯åŠ å®ƒä»¬çš„æƒé‡ï¼Œæ¯”è¾ƒå®ƒä»¬çš„æƒé‡å€¼æ˜¯å¦ç›¸ç­‰\nå¦‚æœåªæœ‰ä¸€ä¸ª Invoker å…·æœ‰æœ€å°çš„æ´»è·ƒæ•°ï¼Œæ­¤æ—¶ç›´æ¥è¿”å›è¯¥ Invoker å³å¯\nå¦‚æœæœ‰å¤šä¸ª Invoker å…·æœ‰æœ€å°æ´»è·ƒæ•°ï¼Œä¸”å®ƒä»¬çš„æƒé‡ä¸ç›¸ç­‰ï¼Œæ­¤æ—¶å¤„ç†æ–¹å¼å’Œ RandomLoadBalance ä¸€è‡´\nå¦‚æœæœ‰å¤šä¸ª Invoker å…·æœ‰æœ€å°æ´»è·ƒæ•°ï¼Œä½†å®ƒä»¬çš„æƒé‡ç›¸ç­‰ï¼Œæ­¤æ—¶éšæœºè¿”å›ä¸€ä¸ªå³å¯\n\nä»¥ä¸Šå°±æ˜¯ LeastActiveLoadBalance å¤§è‡´çš„å®ç°é€»è¾‘ï¼Œå¤§å®¶åœ¨é˜…è¯»çš„æºç çš„è¿‡ç¨‹ä¸­è¦æ³¨æ„åŒºåˆ†æ´»è·ƒæ•°ä¸æƒé‡è¿™ä¸¤ä¸ªæ¦‚å¿µï¼Œä¸è¦æ··ä¸ºä¸€è°ˆã€‚\nä»¥ä¸Šåˆ†ææ˜¯åŸºäº Dubbo 2.6.4 ç‰ˆæœ¬è¿›è¡Œçš„ï¼Œç”±äºè¿‘æœŸ Dubbo 2.6.5 å‘å¸ƒäº†ï¼Œå¹¶å¯¹ LeastActiveLoadBalance è¿›è¡Œäº†ä¸€äº›ä¿®æ”¹ï¼Œä¸‹é¢ç®€å•æ¥ä»‹ç»ä¸€ä¸‹ä¿®æ”¹å†…å®¹ã€‚å›åˆ°ä¸Šé¢çš„æºç ä¸­ï¼Œæˆ‘ä»¬åœ¨ä¸Šé¢çš„ä»£ç ä¸­æ ‡æ³¨äº†ä¸¤ä¸ªé»„è‰²çš„äº”è§’æ˜Ÿâ­ï¸ã€‚ä¸¤å¤„æ ‡è®°å¯¹åº”çš„ä»£ç åˆ†åˆ«å¦‚ä¸‹ï¼š\nint weight = invoker.getUrl().getMethodParameter(invocation.getMethodName(), Constants.WEIGHT_KEY, Constants.DEFAULT_WEIGHT);\noffsetWeight -= getWeight(invokers.get(leastIndex), invocation);\n\né—®é¢˜å‡ºåœ¨æœåŠ¡é¢„çƒ­é˜¶æ®µï¼Œç¬¬ä¸€è¡Œä»£ç ç›´æ¥ä» url ä¸­å–æƒé‡å€¼ï¼Œæœªè¢«é™æƒè¿‡ã€‚ç¬¬äºŒè¡Œä»£ç è·å–åˆ°çš„æ˜¯ç»è¿‡é™æƒåçš„æƒé‡ã€‚ç¬¬ä¸€è¡Œä»£ç è·å–åˆ°çš„æƒé‡å€¼æœ€ç»ˆä¼šè¢«ç´¯åŠ åˆ°æƒé‡æ€»å’Œ totalWeight ä¸­ï¼Œè¿™ä¸ªæ—¶å€™ä¼šå¯¼è‡´ä¸€ä¸ªé—®é¢˜ã€‚offsetWeight æ˜¯ä¸€ä¸ªåœ¨ [0, totalWeight) èŒƒå›´å†…çš„éšæœºæ•°ï¼Œè€Œå®ƒæ‰€å‡å»çš„æ˜¯ç»è¿‡é™æƒçš„æƒé‡ã€‚å¾ˆæœ‰å¯èƒ½åœ¨ç»è¿‡ leastCount æ¬¡è¿ç®—åï¼ŒoffsetWeight ä»ç„¶æ˜¯å¤§äº0çš„ï¼Œå¯¼è‡´æ— æ³•é€‰ä¸­ Invokerã€‚è¿™ä¸ªé—®é¢˜å¯¹åº”çš„ issue ä¸º #904ï¼Œå¹¶åœ¨ pull request #2172 ä¸­è¢«ä¿®å¤ã€‚å…·ä½“çš„ä¿®å¤é€»è¾‘æ˜¯å°†æ ‡æ³¨ä¸€å¤„çš„ä»£ç ä¿®æ”¹ä¸ºï¼š\n// afterWarmup ç­‰ä»·äºä¸Šé¢çš„ weight å˜é‡ï¼Œè¿™æ ·å‘½åæ˜¯ä¸ºäº†å¼ºè°ƒè¯¥å˜é‡ç»è¿‡äº† warmup é™æƒå¤„ç†\nint afterWarmup = getWeight(invoker, invocation);\n\nå¦å¤–ï¼Œ2.6.4 ç‰ˆæœ¬ä¸­çš„ LeastActiveLoadBalance è¿˜æœ‰ä¸€ä¸ªç¼ºé™·ï¼Œå³å½“ä¸€ç»„ Invoker å…·æœ‰ç›¸åŒçš„æœ€å°æ´»è·ƒæ•°ï¼Œä¸”å…¶ä¸­ä¸€ä¸ª Invoker çš„æƒé‡å€¼ä¸º1ï¼Œæ­¤æ—¶è¿™ä¸ª Invoker æ— æ³•è¢«é€‰ä¸­ã€‚ç¼ºé™·ä»£ç å¦‚ä¸‹ï¼š\nint offsetWeight = random.nextInt(totalWeight);\nfor (int i = 0; i &lt; leastCount; i++) &#123;\n    int leastIndex = leastIndexs[i];\n    offsetWeight -= getWeight(invokers.get(leastIndex), invocation);\n    if (offsetWeight &lt;= 0)    // âŒ\n        return invokers.get(leastIndex);\n&#125;\n\né—®é¢˜å‡ºåœ¨äº†offsetWeight &lt;= 0ä¸Šï¼Œä¸¾ä¾‹è¯´æ˜ï¼Œå‡è®¾æœ‰ä¸€ç»„ Invoker çš„æƒé‡ä¸º 5ã€2ã€1ï¼ŒoffsetWeight æœ€å¤§å€¼ä¸º 7ã€‚å‡è®¾ offsetWeight &#x3D; 7ï¼Œä½ ä¼šå‘ç°ï¼Œå½“ for å¾ªç¯è¿›è¡Œç¬¬äºŒæ¬¡éå†å offsetWeight &#x3D; 7 - 5 - 2 &#x3D; 0ï¼Œæå‰è¿”å›äº†ã€‚æ­¤æ—¶ï¼Œæ­¤æ—¶æƒé‡ä¸º1çš„ Invoker å°±æ²¡æœ‰æœºä¼šè¢«é€‰ä¸­äº†ã€‚è¯¥é—®é¢˜åœ¨ Dubbo 2.6.5 ä¸­è¢«ä¿®å¤äº†ï¼Œä¿®æ”¹åçš„ä»£ç å¦‚ä¸‹ï¼š\nint offsetWeight = random.nextInt(totalWeight) + 1;\n\nä»¥ä¸Šå°±æ˜¯ Dubbo 2.6.5 å¯¹ LeastActiveLoadBalance çš„æ›´æ–°ï¼Œå†…å®¹ä¸æ˜¯å¾ˆå¤šï¼Œå…ˆåˆ†æåˆ°è¿™ã€‚æ¥ä¸‹æ¥åˆ†æåŸºäºä¸€è‡´æ€§ hash æ€æƒ³çš„ ConsistentHashLoadBalanceã€‚\n\n2.3 ConsistentHashLoadBalanceä¸€è‡´æ€§ hash ç®—æ³•ç”±éº»çœç†å·¥å­¦é™¢çš„ Karger åŠå…¶åˆä½œè€…äº1997å¹´æå‡ºçš„ï¼Œç®—æ³•æå‡ºä¹‹åˆæ˜¯ç”¨äºå¤§è§„æ¨¡ç¼“å­˜ç³»ç»Ÿçš„è´Ÿè½½å‡è¡¡ã€‚å®ƒçš„å·¥ä½œè¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼Œé¦–å…ˆæ ¹æ® ip æˆ–è€…å…¶ä»–çš„ä¿¡æ¯ä¸ºç¼“å­˜èŠ‚ç‚¹ç”Ÿæˆä¸€ä¸ª hashï¼Œå¹¶å°†è¿™ä¸ª hash æŠ•å°„åˆ° [0, 2^32 - 1] çš„åœ†ç¯ä¸Šã€‚å½“æœ‰æŸ¥è¯¢æˆ–å†™å…¥è¯·æ±‚æ—¶ï¼Œåˆ™ä¸ºç¼“å­˜é¡¹çš„ key ç”Ÿæˆä¸€ä¸ª hash å€¼ã€‚ç„¶åæŸ¥æ‰¾ç¬¬ä¸€ä¸ªå¤§äºæˆ–ç­‰äºè¯¥ hash å€¼çš„ç¼“å­˜èŠ‚ç‚¹ï¼Œå¹¶åˆ°è¿™ä¸ªèŠ‚ç‚¹ä¸­æŸ¥è¯¢æˆ–å†™å…¥ç¼“å­˜é¡¹ã€‚å¦‚æœå½“å‰èŠ‚ç‚¹æŒ‚äº†ï¼Œåˆ™åœ¨ä¸‹ä¸€æ¬¡æŸ¥è¯¢æˆ–å†™å…¥ç¼“å­˜æ—¶ï¼Œä¸ºç¼“å­˜é¡¹æŸ¥æ‰¾å¦ä¸€ä¸ªå¤§äºå…¶ hash å€¼çš„ç¼“å­˜èŠ‚ç‚¹å³å¯ã€‚å¤§è‡´æ•ˆæœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæ¯ä¸ªç¼“å­˜èŠ‚ç‚¹åœ¨åœ†ç¯ä¸Šå æ®ä¸€ä¸ªä½ç½®ã€‚å¦‚æœç¼“å­˜é¡¹çš„ key çš„ hash å€¼å°äºç¼“å­˜èŠ‚ç‚¹ hash å€¼ï¼Œåˆ™åˆ°è¯¥ç¼“å­˜èŠ‚ç‚¹ä¸­å­˜å‚¨æˆ–è¯»å–ç¼“å­˜é¡¹ã€‚æ¯”å¦‚ä¸‹é¢ç»¿è‰²ç‚¹å¯¹åº”çš„ç¼“å­˜é¡¹å°†ä¼šè¢«å­˜å‚¨åˆ° cache-2 èŠ‚ç‚¹ä¸­ã€‚ç”±äº cache-3 æŒ‚äº†ï¼ŒåŸæœ¬åº”è¯¥å­˜åˆ°è¯¥èŠ‚ç‚¹ä¸­çš„ç¼“å­˜é¡¹æœ€ç»ˆä¼šå­˜å‚¨åˆ° cache-4 èŠ‚ç‚¹ä¸­ã€‚\n\nä¸‹é¢æ¥çœ‹çœ‹ä¸€è‡´æ€§ hash åœ¨ Dubbo ä¸­çš„åº”ç”¨ã€‚æˆ‘ä»¬æŠŠä¸Šå›¾çš„ç¼“å­˜èŠ‚ç‚¹æ›¿æ¢æˆ Dubbo çš„æœåŠ¡æä¾›è€…ï¼Œäºæ˜¯å¾—åˆ°äº†ä¸‹å›¾ï¼š\n\nè¿™é‡Œç›¸åŒé¢œè‰²çš„èŠ‚ç‚¹å‡å±äºåŒä¸€ä¸ªæœåŠ¡æä¾›è€…ï¼Œæ¯”å¦‚ Invoker1-1ï¼ŒInvoker1-2ï¼Œâ€¦â€¦, Invoker1-160ã€‚è¿™æ ·åšçš„ç›®çš„æ˜¯é€šè¿‡å¼•å…¥è™šæ‹ŸèŠ‚ç‚¹ï¼Œè®© Invoker åœ¨åœ†ç¯ä¸Šåˆ†æ•£å¼€æ¥ï¼Œé¿å…æ•°æ®å€¾æ–œé—®é¢˜ã€‚æ‰€è°“æ•°æ®å€¾æ–œæ˜¯æŒ‡ï¼Œç”±äºèŠ‚ç‚¹ä¸å¤Ÿåˆ†æ•£ï¼Œå¯¼è‡´å¤§é‡è¯·æ±‚è½åˆ°äº†åŒä¸€ä¸ªèŠ‚ç‚¹ä¸Šï¼Œè€Œå…¶ä»–èŠ‚ç‚¹åªä¼šæ¥æ”¶åˆ°äº†å°‘é‡è¯·æ±‚çš„æƒ…å†µã€‚æ¯”å¦‚ï¼š\n\nå¦‚ä¸Šï¼Œç”±äº Invoker-1 å’Œ Invoker-2 åœ¨åœ†ç¯ä¸Šåˆ†å¸ƒä¸å‡ï¼Œå¯¼è‡´ç³»ç»Ÿä¸­75%çš„è¯·æ±‚éƒ½ä¼šè½åˆ° Invoker-1 ä¸Šï¼Œåªæœ‰ 25% çš„è¯·æ±‚ä¼šè½åˆ° Invoker-2 ä¸Šã€‚è§£å†³è¿™ä¸ªé—®é¢˜åŠæ³•æ˜¯å¼•å…¥è™šæ‹ŸèŠ‚ç‚¹ï¼Œé€šè¿‡è™šæ‹ŸèŠ‚ç‚¹å‡è¡¡å„ä¸ªèŠ‚ç‚¹çš„è¯·æ±‚é‡ã€‚\nåˆ°è¿™é‡ŒèƒŒæ™¯çŸ¥è¯†å°±æ™®åŠå®Œäº†ï¼Œæ¥ä¸‹æ¥å¼€å§‹åˆ†ææºç ã€‚æˆ‘ä»¬å…ˆä» ConsistentHashLoadBalance çš„ doSelect æ–¹æ³•å¼€å§‹çœ‹èµ·ï¼Œå¦‚ä¸‹ï¼š\npublic class ConsistentHashLoadBalance extends AbstractLoadBalance &#123;\n\n    private final ConcurrentMap&lt;String, ConsistentHashSelector&lt;?>> selectors = \n        new ConcurrentHashMap&lt;String, ConsistentHashSelector&lt;?>>();\n\n    @Override\n    protected &lt;T> Invoker&lt;T> doSelect(List&lt;Invoker&lt;T>> invokers, URL url, Invocation invocation) &#123;\n        String methodName = RpcUtils.getMethodName(invocation);\n        String key = invokers.get(0).getUrl().getServiceKey() + \".\" + methodName;\n\n        // è·å– invokers åŸå§‹çš„ hashcode\n        int identityHashCode = System.identityHashCode(invokers);\n        ConsistentHashSelector&lt;T> selector = (ConsistentHashSelector&lt;T>) selectors.get(key);\n        // å¦‚æœ invokers æ˜¯ä¸€ä¸ªæ–°çš„ List å¯¹è±¡ï¼Œæ„å‘³ç€æœåŠ¡æä¾›è€…æ•°é‡å‘ç”Ÿäº†å˜åŒ–ï¼Œå¯èƒ½æ–°å¢ä¹Ÿå¯èƒ½å‡å°‘äº†ã€‚\n        // æ­¤æ—¶ selector.identityHashCode != identityHashCode æ¡ä»¶æˆç«‹\n        if (selector == null || selector.identityHashCode != identityHashCode) &#123;\n            // åˆ›å»ºæ–°çš„ ConsistentHashSelector\n            selectors.put(key, new ConsistentHashSelector&lt;T>(invokers, methodName, identityHashCode));\n            selector = (ConsistentHashSelector&lt;T>) selectors.get(key);\n        &#125;\n\n        // è°ƒç”¨ ConsistentHashSelector çš„ select æ–¹æ³•é€‰æ‹© Invoker\n        return selector.select(invocation);\n    &#125;\n    \n    private static final class ConsistentHashSelector&lt;T> &#123;...&#125;\n&#125;\n\nå¦‚ä¸Šï¼ŒdoSelect æ–¹æ³•ä¸»è¦åšäº†ä¸€äº›å‰ç½®å·¥ä½œï¼Œæ¯”å¦‚æ£€æµ‹ invokers åˆ—è¡¨æ˜¯ä¸æ˜¯å˜åŠ¨è¿‡ï¼Œä»¥åŠåˆ›å»º ConsistentHashSelectorã€‚è¿™äº›å·¥ä½œåšå®Œåï¼Œæ¥ä¸‹æ¥å¼€å§‹è°ƒç”¨ ConsistentHashSelector çš„ select æ–¹æ³•æ‰§è¡Œè´Ÿè½½å‡è¡¡é€»è¾‘ã€‚åœ¨åˆ†æ select æ–¹æ³•ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹ä¸€è‡´æ€§ hash é€‰æ‹©å™¨ ConsistentHashSelector çš„åˆå§‹åŒ–è¿‡ç¨‹ï¼Œå¦‚ä¸‹ï¼š\nprivate static final class ConsistentHashSelector&lt;T> &#123;\n\n    // ä½¿ç”¨ TreeMap å­˜å‚¨ Invoker è™šæ‹ŸèŠ‚ç‚¹\n    private final TreeMap&lt;Long, Invoker&lt;T>> virtualInvokers;\n\n    private final int replicaNumber;\n\n    private final int identityHashCode;\n\n    private final int[] argumentIndex;\n\n    ConsistentHashSelector(List&lt;Invoker&lt;T>> invokers, String methodName, int identityHashCode) &#123;\n        this.virtualInvokers = new TreeMap&lt;Long, Invoker&lt;T>>();\n        this.identityHashCode = identityHashCode;\n        URL url = invokers.get(0).getUrl();\n        // è·å–è™šæ‹ŸèŠ‚ç‚¹æ•°ï¼Œé»˜è®¤ä¸º160\n        this.replicaNumber = url.getMethodParameter(methodName, \"hash.nodes\", 160);\n        // è·å–å‚ä¸ hash è®¡ç®—çš„å‚æ•°ä¸‹æ ‡å€¼ï¼Œé»˜è®¤å¯¹ç¬¬ä¸€ä¸ªå‚æ•°è¿›è¡Œ hash è¿ç®—\n        String[] index = Constants.COMMA_SPLIT_PATTERN.split(url.getMethodParameter(methodName, \"hash.arguments\", \"0\"));\n        argumentIndex = new int[index.length];\n        for (int i = 0; i &lt; index.length; i++) &#123;\n            argumentIndex[i] = Integer.parseInt(index[i]);\n        &#125;\n        for (Invoker&lt;T> invoker : invokers) &#123;\n            String address = invoker.getUrl().getAddress();\n            for (int i = 0; i &lt; replicaNumber / 4; i++) &#123;\n                // å¯¹ address + i è¿›è¡Œ md5 è¿ç®—ï¼Œå¾—åˆ°ä¸€ä¸ªé•¿åº¦ä¸º16çš„å­—èŠ‚æ•°ç»„\n                byte[] digest = md5(address + i);\n                // å¯¹ digest éƒ¨åˆ†å­—èŠ‚è¿›è¡Œ4æ¬¡ hash è¿ç®—ï¼Œå¾—åˆ°å››ä¸ªä¸åŒçš„ long å‹æ­£æ•´æ•°\n                for (int h = 0; h &lt; 4; h++) &#123;\n                    // h = 0 æ—¶ï¼Œå– digest ä¸­ä¸‹æ ‡ä¸º 0 ~ 3 çš„4ä¸ªå­—èŠ‚è¿›è¡Œä½è¿ç®—\n                    // h = 1 æ—¶ï¼Œå– digest ä¸­ä¸‹æ ‡ä¸º 4 ~ 7 çš„4ä¸ªå­—èŠ‚è¿›è¡Œä½è¿ç®—\n                    // h = 2, h = 3 æ—¶è¿‡ç¨‹åŒä¸Š\n                    long m = hash(digest, h);\n                    // å°† hash åˆ° invoker çš„æ˜ å°„å…³ç³»å­˜å‚¨åˆ° virtualInvokers ä¸­ï¼Œ\n                    // virtualInvokers éœ€è¦æä¾›é«˜æ•ˆçš„æŸ¥è¯¢æ“ä½œï¼Œå› æ­¤é€‰ç”¨ TreeMap ä½œä¸ºå­˜å‚¨ç»“æ„\n                    virtualInvokers.put(m, invoker);\n                &#125;\n            &#125;\n        &#125;\n    &#125;\n&#125;\n\nConsistentHashSelector çš„æ„é€ æ–¹æ³•æ‰§è¡Œäº†ä¸€ç³»åˆ—çš„åˆå§‹åŒ–é€»è¾‘ï¼Œæ¯”å¦‚ä»é…ç½®ä¸­è·å–è™šæ‹ŸèŠ‚ç‚¹æ•°ä»¥åŠå‚ä¸ hash è®¡ç®—çš„å‚æ•°ä¸‹æ ‡ï¼Œé»˜è®¤æƒ…å†µä¸‹åªä½¿ç”¨ç¬¬ä¸€ä¸ªå‚æ•°è¿›è¡Œ hashã€‚éœ€è¦ç‰¹åˆ«è¯´æ˜çš„æ˜¯ï¼ŒConsistentHashLoadBalance çš„è´Ÿè½½å‡è¡¡é€»è¾‘åªå—å‚æ•°å€¼å½±å“ï¼Œå…·æœ‰ç›¸åŒå‚æ•°å€¼çš„è¯·æ±‚å°†ä¼šè¢«åˆ†é…ç»™åŒä¸€ä¸ªæœåŠ¡æä¾›è€…ã€‚ConsistentHashLoadBalance ä¸ å…³ç³»æƒé‡ï¼Œå› æ­¤ä½¿ç”¨æ—¶éœ€è¦æ³¨æ„ä¸€ä¸‹ã€‚\nåœ¨è·å–è™šæ‹ŸèŠ‚ç‚¹æ•°å’Œå‚æ•°ä¸‹æ ‡é…ç½®åï¼Œæ¥ä¸‹æ¥è¦åšçš„äº‹æƒ…æ˜¯è®¡ç®—è™šæ‹ŸèŠ‚ç‚¹ hash å€¼ï¼Œå¹¶å°†è™šæ‹ŸèŠ‚ç‚¹å­˜å‚¨åˆ° TreeMap ä¸­ã€‚åˆ°æ­¤ï¼ŒConsistentHashSelector åˆå§‹åŒ–å·¥ä½œå°±å®Œæˆäº†ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ select æ–¹æ³•çš„é€»è¾‘ã€‚\npublic Invoker&lt;T> select(Invocation invocation) &#123;\n    // å°†å‚æ•°è½¬ä¸º key\n    String key = toKey(invocation.getArguments());\n    // å¯¹å‚æ•° key è¿›è¡Œ md5 è¿ç®—\n    byte[] digest = md5(key);\n    // å– digest æ•°ç»„çš„å‰å››ä¸ªå­—èŠ‚è¿›è¡Œ hash è¿ç®—ï¼Œå†å°† hash å€¼ä¼ ç»™ selectForKey æ–¹æ³•ï¼Œ\n    // å¯»æ‰¾åˆé€‚çš„ Invoker\n    return selectForKey(hash(digest, 0));\n&#125;\n\nprivate Invoker&lt;T> selectForKey(long hash) &#123;\n    // åˆ° TreeMap ä¸­æŸ¥æ‰¾ç¬¬ä¸€ä¸ªèŠ‚ç‚¹å€¼å¤§äºæˆ–ç­‰äºå½“å‰ hash çš„ Invoker\n    Map.Entry&lt;Long, Invoker&lt;T>> entry = virtualInvokers.tailMap(hash, true).firstEntry();\n    // å¦‚æœ hash å¤§äº Invoker åœ¨åœ†ç¯ä¸Šæœ€å¤§çš„ä½ç½®ï¼Œæ­¤æ—¶ entry = nullï¼Œ\n    // éœ€è¦å°† TreeMap çš„å¤´èŠ‚ç‚¹èµ‹å€¼ç»™ entry\n    if (entry == null) &#123;\n        entry = virtualInvokers.firstEntry();\n    &#125;\n\n    // è¿”å› Invoker\n    return entry.getValue();\n&#125;\n\nå¦‚ä¸Šï¼Œé€‰æ‹©çš„è¿‡ç¨‹ç›¸å¯¹æ¯”è¾ƒç®€å•äº†ã€‚é¦–å…ˆæ˜¯å¯¹å‚æ•°è¿›è¡Œ md5 ä»¥åŠ hash è¿ç®—ï¼Œå¾—åˆ°ä¸€ä¸ª hash å€¼ã€‚ç„¶åå†æ‹¿è¿™ä¸ªå€¼åˆ° TreeMap ä¸­æŸ¥æ‰¾ç›®æ ‡ Invoker å³å¯ã€‚\nåˆ°æ­¤å…³äº ConsistentHashLoadBalance å°±åˆ†æå®Œäº†ã€‚åœ¨é˜…è¯» ConsistentHashLoadBalance æºç ä¹‹å‰ï¼Œå¤§å®¶ä¸€å®šè¦å…ˆè¡¥å……èƒŒæ™¯çŸ¥è¯†ï¼Œä¸ç„¶å¾ˆéš¾çœ‹æ‡‚ä»£ç é€»è¾‘ã€‚\n\n2.4 RoundRobinLoadBalanceæœ¬èŠ‚ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ Dubbo ä¸­åŠ æƒè½®è¯¢è´Ÿè½½å‡è¡¡çš„å®ç° RoundRobinLoadBalanceã€‚åœ¨è¯¦ç»†åˆ†ææºç å‰ï¼Œæˆ‘ä»¬å…ˆæ¥äº†è§£ä¸€ä¸‹ä»€ä¹ˆæ˜¯åŠ æƒè½®è¯¢ã€‚è¿™é‡Œä»æœ€ç®€å•çš„è½®è¯¢å¼€å§‹è®²èµ·ï¼Œæ‰€è°“è½®è¯¢æ˜¯æŒ‡å°†è¯·æ±‚è½®æµåˆ†é…ç»™æ¯å°æœåŠ¡å™¨ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬æœ‰ä¸‰å°æœåŠ¡å™¨ Aã€Bã€Cã€‚æˆ‘ä»¬å°†ç¬¬ä¸€ä¸ªè¯·æ±‚åˆ†é…ç»™æœåŠ¡å™¨ Aï¼Œç¬¬äºŒä¸ªè¯·æ±‚åˆ†é…ç»™æœåŠ¡å™¨ Bï¼Œç¬¬ä¸‰ä¸ªè¯·æ±‚åˆ†é…ç»™æœåŠ¡å™¨ Cï¼Œç¬¬å››ä¸ªè¯·æ±‚å†æ¬¡åˆ†é…ç»™æœåŠ¡å™¨ Aã€‚è¿™ä¸ªè¿‡ç¨‹å°±å«åšè½®è¯¢ã€‚è½®è¯¢æ˜¯ä¸€ç§æ— çŠ¶æ€è´Ÿè½½å‡è¡¡ç®—æ³•ï¼Œå®ç°ç®€å•ï¼Œé€‚ç”¨äºæ¯å°æœåŠ¡å™¨æ€§èƒ½ç›¸è¿‘çš„åœºæ™¯ä¸‹ã€‚ä½†ç°å®æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¹¶ä¸èƒ½ä¿è¯æ¯å°æœåŠ¡å™¨æ€§èƒ½å‡ç›¸è¿‘ã€‚å¦‚æœæˆ‘ä»¬å°†ç­‰é‡çš„è¯·æ±‚åˆ†é…ç»™æ€§èƒ½è¾ƒå·®çš„æœåŠ¡å™¨ï¼Œè¿™æ˜¾ç„¶æ˜¯ä¸åˆç†çš„ã€‚å› æ­¤ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬éœ€è¦å¯¹è½®è¯¢è¿‡ç¨‹è¿›è¡ŒåŠ æƒï¼Œä»¥è°ƒæ§æ¯å°æœåŠ¡å™¨çš„è´Ÿè½½ã€‚ç»è¿‡åŠ æƒåï¼Œæ¯å°æœåŠ¡å™¨èƒ½å¤Ÿå¾—åˆ°çš„è¯·æ±‚æ•°æ¯”ä¾‹ï¼Œæ¥è¿‘æˆ–ç­‰äºä»–ä»¬çš„æƒé‡æ¯”ã€‚æ¯”å¦‚æœåŠ¡å™¨ Aã€Bã€C æƒé‡æ¯”ä¸º 5:2:1ã€‚é‚£ä¹ˆåœ¨8æ¬¡è¯·æ±‚ä¸­ï¼ŒæœåŠ¡å™¨ A å°†æ”¶åˆ°å…¶ä¸­çš„5æ¬¡è¯·æ±‚ï¼ŒæœåŠ¡å™¨ B ä¼šæ”¶åˆ°å…¶ä¸­çš„2æ¬¡è¯·æ±‚ï¼ŒæœåŠ¡å™¨ C åˆ™æ”¶åˆ°å…¶ä¸­çš„1æ¬¡è¯·æ±‚ã€‚\nä»¥ä¸Šå°±æ˜¯åŠ æƒè½®è¯¢çš„ç®—æ³•æ€æƒ³ï¼Œææ‡‚äº†è¿™ä¸ªæ€æƒ³ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±å¯ä»¥åˆ†ææºç äº†ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹ 2.6.4 ç‰ˆæœ¬çš„ RoundRobinLoadBalanceã€‚\npublic class RoundRobinLoadBalance extends AbstractLoadBalance &#123;\n\n    public static final String NAME = \"roundrobin\";\n\n    private final ConcurrentMap&lt;String, AtomicPositiveInteger> sequences = \n        new ConcurrentHashMap&lt;String, AtomicPositiveInteger>();\n\n    @Override\n    protected &lt;T> Invoker&lt;T> doSelect(List&lt;Invoker&lt;T>> invokers, URL url, Invocation invocation) &#123;\n        // key = å…¨é™å®šç±»å + \".\" + æ–¹æ³•åï¼Œæ¯”å¦‚ com.xxx.DemoService.sayHello\n        String key = invokers.get(0).getUrl().getServiceKey() + \".\" + invocation.getMethodName();\n        int length = invokers.size();\n        // æœ€å¤§æƒé‡\n        int maxWeight = 0;\n        // æœ€å°æƒé‡\n        int minWeight = Integer.MAX_VALUE;\n        final LinkedHashMap&lt;Invoker&lt;T>, IntegerWrapper> invokerToWeightMap = new LinkedHashMap&lt;Invoker&lt;T>, IntegerWrapper>();\n        // æƒé‡æ€»å’Œ\n        int weightSum = 0;\n\n        // ä¸‹é¢è¿™ä¸ªå¾ªç¯ä¸»è¦ç”¨äºæŸ¥æ‰¾æœ€å¤§å’Œæœ€å°æƒé‡ï¼Œè®¡ç®—æƒé‡æ€»å’Œç­‰\n        for (int i = 0; i &lt; length; i++) &#123;\n            int weight = getWeight(invokers.get(i), invocation);\n            // è·å–æœ€å¤§å’Œæœ€å°æƒé‡\n            maxWeight = Math.max(maxWeight, weight);\n            minWeight = Math.min(minWeight, weight);\n            if (weight > 0) &#123;\n                // å°† weight å°è£…åˆ° IntegerWrapper ä¸­\n                invokerToWeightMap.put(invokers.get(i), new IntegerWrapper(weight));\n                // ç´¯åŠ æƒé‡\n                weightSum += weight;\n            &#125;\n        &#125;\n\n        // æŸ¥æ‰¾ key å¯¹åº”çš„å¯¹åº” AtomicPositiveInteger å®ä¾‹ï¼Œä¸ºç©ºåˆ™åˆ›å»ºã€‚\n        // è¿™é‡Œå¯ä»¥æŠŠ AtomicPositiveInteger çœ‹æˆä¸€ä¸ªé»‘ç›’ï¼Œå¤§å®¶åªè¦çŸ¥é“\n        // AtomicPositiveInteger ç”¨äºè®°å½•æœåŠ¡çš„è°ƒç”¨ç¼–å·å³å¯ã€‚è‡³äºç»†èŠ‚ï¼Œ\n        // å¤§å®¶å¦‚æœæ„Ÿå…´è¶£ï¼Œå¯ä»¥è‡ªè¡Œåˆ†æ\n        AtomicPositiveInteger sequence = sequences.get(key);\n        if (sequence == null) &#123;\n            sequences.putIfAbsent(key, new AtomicPositiveInteger());\n            sequence = sequences.get(key);\n        &#125;\n\n        // è·å–å½“å‰çš„è°ƒç”¨ç¼–å·\n        int currentSequence = sequence.getAndIncrement();\n        // å¦‚æœæœ€å°æƒé‡å°äºæœ€å¤§æƒé‡ï¼Œè¡¨æ˜æœåŠ¡æä¾›è€…ä¹‹é—´çš„æƒé‡æ˜¯ä¸ç›¸ç­‰çš„\n        if (maxWeight > 0 &amp;&amp; minWeight &lt; maxWeight) &#123;\n            // ä½¿ç”¨è°ƒç”¨ç¼–å·å¯¹æƒé‡æ€»å’Œè¿›è¡Œå–ä½™æ“ä½œ\n            int mod = currentSequence % weightSum;\n            // è¿›è¡Œ maxWeight æ¬¡éå†\n            for (int i = 0; i &lt; maxWeight; i++) &#123;\n                // éå† invokerToWeightMap\n                for (Map.Entry&lt;Invoker&lt;T>, IntegerWrapper> each : invokerToWeightMap.entrySet()) &#123;\n\t\t\t\t\t// è·å– Invoker\n                    final Invoker&lt;T> k = each.getKey();\n                    // è·å–æƒé‡åŒ…è£…ç±» IntegerWrapper\n                    final IntegerWrapper v = each.getValue();\n                    \n                    // å¦‚æœ mod = 0ï¼Œä¸”æƒé‡å¤§äº0ï¼Œæ­¤æ—¶è¿”å›ç›¸åº”çš„ Invoker\n                    if (mod == 0 &amp;&amp; v.getValue() > 0) &#123;\n                        return k;\n                    &#125;\n                    \n                    // mod != 0ï¼Œä¸”æƒé‡å¤§äº0ï¼Œæ­¤æ—¶å¯¹æƒé‡å’Œ mod åˆ†åˆ«è¿›è¡Œè‡ªå‡æ“ä½œ\n                    if (v.getValue() > 0) &#123;\n                        v.decrement();\n                        mod--;\n                    &#125;\n                &#125;\n            &#125;\n        &#125;\n        \n        // æœåŠ¡æä¾›è€…ä¹‹é—´çš„æƒé‡ç›¸ç­‰ï¼Œæ­¤æ—¶é€šè¿‡è½®è¯¢é€‰æ‹© Invoker\n        return invokers.get(currentSequence % length);\n    &#125;\n\n    // IntegerWrapper æ˜¯ä¸€ä¸ª int åŒ…è£…ç±»ï¼Œä¸»è¦åŒ…å«äº†ä¸€ä¸ªè‡ªå‡æ–¹æ³•ã€‚\n    private static final class IntegerWrapper &#123;\n        private int value;\n\n        public void decrement() &#123;\n            this.value--;\n        &#125;\n        \n        // çœç•¥éƒ¨åˆ†ä»£ç \n    &#125;\n&#125;\n\nå¦‚ä¸Šï¼ŒRoundRobinLoadBalance çš„æ¯è¡Œä»£ç éƒ½ä¸æ˜¯å¾ˆéš¾ç†è§£ï¼Œä½†æ˜¯å°†å®ƒä»¬ç»„åˆåœ¨ä¸€èµ·ä¹‹åï¼Œå°±ä¸æ˜¯å¾ˆå¥½ç†è§£äº†ã€‚æ‰€ä»¥ä¸‹é¢æˆ‘ä»¬ä¸¾ä¾‹è¿›è¡Œè¯´æ˜ï¼Œå‡è®¾æˆ‘ä»¬æœ‰ä¸‰å°æœåŠ¡å™¨ servers &#x3D; [A, B, C]ï¼Œå¯¹åº”çš„æƒé‡ä¸º weights &#x3D; [2, 5, 1]ã€‚æ¥ä¸‹æ¥å¯¹ä¸Šé¢çš„é€»è¾‘è¿›è¡Œç®€å•çš„æ¨¡æ‹Ÿã€‚\nmod &#x3D; 0ï¼šæ»¡è¶³æ¡ä»¶ï¼Œæ­¤æ—¶ç›´æ¥è¿”å›æœåŠ¡å™¨ A\nmod &#x3D; 1ï¼šéœ€è¦è¿›è¡Œä¸€æ¬¡é€’å‡æ“ä½œæ‰èƒ½æ»¡è¶³æ¡ä»¶ï¼Œæ­¤æ—¶è¿”å›æœåŠ¡å™¨ B\nmod &#x3D; 2ï¼šéœ€è¦è¿›è¡Œä¸¤æ¬¡é€’å‡æ“ä½œæ‰èƒ½æ»¡è¶³æ¡ä»¶ï¼Œæ­¤æ—¶è¿”å›æœåŠ¡å™¨ C\nmod &#x3D; 3ï¼šéœ€è¦è¿›è¡Œä¸‰æ¬¡é€’å‡æ“ä½œæ‰èƒ½æ»¡è¶³æ¡ä»¶ï¼Œç»è¿‡é€’å‡åï¼ŒæœåŠ¡å™¨æƒé‡ä¸º [1, 4, 0]ï¼Œæ­¤æ—¶è¿”å›æœåŠ¡å™¨ A\nmod &#x3D; 4ï¼šéœ€è¦è¿›è¡Œå››æ¬¡é€’å‡æ“ä½œæ‰èƒ½æ»¡è¶³æ¡ä»¶ï¼Œç»è¿‡é€’å‡åï¼ŒæœåŠ¡å™¨æƒé‡ä¸º [0, 4, 0]ï¼Œæ­¤æ—¶è¿”å›æœåŠ¡å™¨ B\nmod &#x3D; 5ï¼šéœ€è¦è¿›è¡Œäº”æ¬¡é€’å‡æ“ä½œæ‰èƒ½æ»¡è¶³æ¡ä»¶ï¼Œç»è¿‡é€’å‡åï¼ŒæœåŠ¡å™¨æƒé‡ä¸º [0, 3, 0]ï¼Œæ­¤æ—¶è¿”å›æœåŠ¡å™¨ B\nmod &#x3D; 6ï¼šéœ€è¦è¿›è¡Œå…­æ¬¡é€’å‡æ“ä½œæ‰èƒ½æ»¡è¶³æ¡ä»¶ï¼Œç»è¿‡é€’å‡åï¼ŒæœåŠ¡å™¨æƒé‡ä¸º [0, 2, 0]ï¼Œæ­¤æ—¶è¿”å›æœåŠ¡å™¨ B\nmod &#x3D; 7ï¼šéœ€è¦è¿›è¡Œä¸ƒæ¬¡é€’å‡æ“ä½œæ‰èƒ½æ»¡è¶³æ¡ä»¶ï¼Œç»è¿‡é€’å‡åï¼ŒæœåŠ¡å™¨æƒé‡ä¸º [0, 1, 0]ï¼Œæ­¤æ—¶è¿”å›æœåŠ¡å™¨ B\nç»è¿‡8æ¬¡è°ƒç”¨åï¼Œæˆ‘ä»¬å¾—åˆ°çš„è´Ÿè½½å‡è¡¡ç»“æœä¸º [A, B, C, A, B, B, B, B]ï¼Œæ¬¡æ•°æ¯” A:B:C &#x3D; 2:5:1ï¼Œç­‰äºæƒé‡æ¯”ã€‚å½“ sequence &#x3D; 8 æ—¶ï¼Œmod &#x3D; 0ï¼Œæ­¤æ—¶é‡å¤´å†æ¥ã€‚ä»ä¸Šé¢çš„æ¨¡æ‹Ÿè¿‡ç¨‹å¯ä»¥çœ‹å‡ºï¼Œå½“ mod &gt;&#x3D; 3 åï¼ŒæœåŠ¡å™¨ C å°±ä¸ä¼šè¢«é€‰ä¸­äº†ï¼Œå› ä¸ºå®ƒçš„æƒé‡è¢«å‡ä¸º0äº†ã€‚å½“ mod &gt;&#x3D; 4 åï¼ŒæœåŠ¡å™¨ A çš„æƒé‡è¢«å‡ä¸º0ï¼Œæ­¤å A å°±ä¸ä¼šå†è¢«é€‰ä¸­ã€‚\nä»¥ä¸Šæ˜¯ 2.6.4 ç‰ˆæœ¬çš„ RoundRobinLoadBalance åˆ†æè¿‡ç¨‹ï¼Œ2.6.4 ç‰ˆæœ¬çš„ RoundRobinLoadBalance åœ¨æŸäº›æƒ…å†µä¸‹å­˜åœ¨ç€æ¯”è¾ƒä¸¥é‡çš„æ€§èƒ½é—®é¢˜ï¼Œè¯¥é—®é¢˜æœ€åˆæ˜¯åœ¨ issue #2578 ä¸­è¢«åé¦ˆå‡ºæ¥ã€‚é—®é¢˜å‡ºåœ¨äº† Invoker çš„è¿”å›æ—¶æœºä¸Šï¼ŒRoundRobinLoadBalance éœ€è¦åœ¨mod == 0 &amp;&amp; v.getValue() &gt; 0 æ¡ä»¶æˆç«‹çš„æƒ…å†µä¸‹æ‰ä¼šè¢«è¿”å›ç›¸åº”çš„ Invokerã€‚å‡å¦‚ mod å¾ˆå¤§ï¼Œæ¯”å¦‚ 10000ï¼Œ50000ï¼Œç”šè‡³æ›´å¤§æ—¶ï¼ŒdoSelect æ–¹æ³•éœ€è¦è¿›è¡Œå¾ˆå¤šæ¬¡è®¡ç®—æ‰èƒ½å°† mod å‡ä¸º0ã€‚ç”±æ­¤å¯çŸ¥ï¼ŒdoSelect çš„æ•ˆç‡ä¸ mod æœ‰å…³ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(mod)ã€‚mod åˆå—æœ€å¤§æƒé‡ maxWeight çš„å½±å“ï¼Œå› æ­¤å½“æŸä¸ªæœåŠ¡æä¾›è€…é…ç½®äº†éå¸¸å¤§çš„æƒé‡ï¼Œæ­¤æ—¶ RoundRobinLoadBalance ä¼šäº§ç”Ÿæ¯”è¾ƒä¸¥é‡çš„æ€§èƒ½é—®é¢˜ã€‚è¿™ä¸ªé—®é¢˜è¢«åé¦ˆåï¼Œç¤¾åŒºå¾ˆå¿«åšäº†å›åº”ã€‚å¹¶å¯¹ RoundRobinLoadBalance çš„ä»£ç è¿›è¡Œäº†é‡æ„ï¼Œå°†æ—¶é—´å¤æ‚åº¦ä¼˜åŒ–è‡³äº†å¸¸é‡çº§åˆ«ã€‚è¿™ä¸ªä¼˜åŒ–å¯ä»¥è¯´å¾ˆå¥½äº†ï¼Œä¸‹é¢æˆ‘ä»¬æ¥å­¦ä¹ ä¸€ä¸‹ä¼˜åŒ–åçš„ä»£ç ã€‚\npublic class RoundRobinLoadBalance extends AbstractLoadBalance &#123;\n\n    public static final String NAME = \"roundrobin\";\n\n    private final ConcurrentMap&lt;String, AtomicPositiveInteger> sequences = new ConcurrentHashMap&lt;String, AtomicPositiveInteger>();\n\n    private final ConcurrentMap&lt;String, AtomicPositiveInteger> indexSeqs = new ConcurrentHashMap&lt;String, AtomicPositiveInteger>();\n\n    @Override\n    protected &lt;T> Invoker&lt;T> doSelect(List&lt;Invoker&lt;T>> invokers, URL url, Invocation invocation) &#123;\n        String key = invokers.get(0).getUrl().getServiceKey() + \".\" + invocation.getMethodName();\n        int length = invokers.size();\n        int maxWeight = 0;\n        int minWeight = Integer.MAX_VALUE;\n        final List&lt;Invoker&lt;T>> invokerToWeightList = new ArrayList&lt;>();\n        \n        // æŸ¥æ‰¾æœ€å¤§å’Œæœ€å°æƒé‡\n        for (int i = 0; i &lt; length; i++) &#123;\n            int weight = getWeight(invokers.get(i), invocation);\n            maxWeight = Math.max(maxWeight, weight);\n            minWeight = Math.min(minWeight, weight);\n            if (weight > 0) &#123;\n                invokerToWeightList.add(invokers.get(i));\n            &#125;\n        &#125;\n        \n        // è·å–å½“å‰æœåŠ¡å¯¹åº”çš„è°ƒç”¨åºåˆ—å¯¹è±¡ AtomicPositiveInteger\n        AtomicPositiveInteger sequence = sequences.get(key);\n        if (sequence == null) &#123;\n            // åˆ›å»º AtomicPositiveIntegerï¼Œé»˜è®¤å€¼ä¸º0\n            sequences.putIfAbsent(key, new AtomicPositiveInteger());\n            sequence = sequences.get(key);\n        &#125;\n        \n        // è·å–ä¸‹æ ‡åºåˆ—å¯¹è±¡ AtomicPositiveInteger\n        AtomicPositiveInteger indexSeq = indexSeqs.get(key);\n        if (indexSeq == null) &#123;\n            // åˆ›å»º AtomicPositiveIntegerï¼Œé»˜è®¤å€¼ä¸º -1\n            indexSeqs.putIfAbsent(key, new AtomicPositiveInteger(-1));\n            indexSeq = indexSeqs.get(key);\n        &#125;\n\n        if (maxWeight > 0 &amp;&amp; minWeight &lt; maxWeight) &#123;\n            length = invokerToWeightList.size();\n            while (true) &#123;\n                int index = indexSeq.incrementAndGet() % length;\n                int currentWeight = sequence.get() % maxWeight;\n\n                // æ¯å¾ªç¯ä¸€è½®ï¼ˆindex = 0ï¼‰ï¼Œé‡æ–°è®¡ç®— currentWeight\n                if (index == 0) &#123;\n                    currentWeight = sequence.incrementAndGet() % maxWeight;\n                &#125;\n                \n                // æ£€æµ‹ Invoker çš„æƒé‡æ˜¯å¦å¤§äº currentWeightï¼Œå¤§äºåˆ™è¿”å›\n                if (getWeight(invokerToWeightList.get(index), invocation) > currentWeight) &#123;\n                    return invokerToWeightList.get(index);\n                &#125;\n            &#125;\n        &#125;\n        \n        // æ‰€æœ‰ Invoker æƒé‡ç›¸ç­‰ï¼Œæ­¤æ—¶è¿›è¡Œæ™®é€šçš„è½®è¯¢å³å¯\n        return invokers.get(sequence.incrementAndGet() % length);\n    &#125;\n&#125;\n\nä¸Šé¢ä»£ç çš„é€»è¾‘æ˜¯è¿™æ ·çš„ï¼Œæ¯è¿›è¡Œä¸€è½®å¾ªç¯ï¼Œé‡æ–°è®¡ç®— currentWeightã€‚å¦‚æœå½“å‰ Invoker æƒé‡å¤§äº currentWeightï¼Œåˆ™è¿”å›è¯¥ Invokerã€‚ä¸‹é¢ä¸¾ä¾‹è¯´æ˜ï¼Œå‡è®¾æœåŠ¡å™¨ [A, B, C] å¯¹åº”æƒé‡ [5, 2, 1]ã€‚\nç¬¬ä¸€è½®å¾ªç¯ï¼ŒcurrentWeight &#x3D; 1ï¼Œå¯è¿”å› A å’Œ B\nç¬¬äºŒè½®å¾ªç¯ï¼ŒcurrentWeight &#x3D; 2ï¼Œè¿”å› A\nç¬¬ä¸‰è½®å¾ªç¯ï¼ŒcurrentWeight &#x3D; 3ï¼Œè¿”å› A\nç¬¬å››è½®å¾ªç¯ï¼ŒcurrentWeight &#x3D; 4ï¼Œè¿”å› A\nç¬¬äº”è½®å¾ªç¯ï¼ŒcurrentWeight &#x3D; 0ï¼Œè¿”å› A, B, C\nå¦‚ä¸Šï¼Œè¿™é‡Œçš„ä¸€è½®å¾ªç¯æ˜¯æŒ‡ index å†æ¬¡å˜ä¸º0æ‰€ç»å†è¿‡çš„å¾ªç¯ï¼Œè¿™é‡Œå¯ä»¥æŠŠ index &#x3D; 0 çœ‹åšæ˜¯ä¸€è½®å¾ªç¯çš„å¼€å§‹ã€‚æ¯ä¸€è½®å¾ªç¯çš„æ¬¡æ•°ä¸ Invoker çš„æ•°é‡æœ‰å…³ï¼ŒInvoker æ•°é‡é€šå¸¸ä¸ä¼šå¤ªå¤šï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è®¤ä¸ºä¸Šé¢ä»£ç çš„æ—¶é—´å¤æ‚åº¦ä¸ºå¸¸æ•°çº§ã€‚\né‡æ„åçš„ RoundRobinLoadBalance çœ‹èµ·æ¥å·²ç»å¾ˆä¸é”™äº†ï¼Œä½†æ˜¯åœ¨ä»£ç æ›´æ–°ä¸ä¹…åï¼Œå¾ˆå¿«åˆè¢«é‡æ„äº†ã€‚è¿™æ¬¡é‡æ„åŸå› æ˜¯æ–°çš„ RoundRobinLoadBalance åœ¨æŸäº›æƒ…å†µä¸‹é€‰å‡ºçš„æœåŠ¡å™¨åºåˆ—ä¸å¤Ÿå‡åŒ€ã€‚æ¯”å¦‚ï¼ŒæœåŠ¡å™¨ [A, B, C] å¯¹åº”æƒé‡ [5, 1, 1]ã€‚è¿›è¡Œ7æ¬¡è´Ÿè½½å‡è¡¡åï¼Œé€‰æ‹©å‡ºæ¥çš„åºåˆ—ä¸º [A, A, A, A, A, B, C]ã€‚å‰5ä¸ªè¯·æ±‚å…¨éƒ¨éƒ½è½åœ¨äº†æœåŠ¡å™¨ Aä¸Šï¼Œè¿™å°†ä¼šä½¿æœåŠ¡å™¨ A çŸ­æ—¶é—´å†…æ¥æ”¶å¤§é‡çš„è¯·æ±‚ï¼Œå‹åŠ›é™¡å¢ã€‚è€Œ B å’Œ C æ­¤æ—¶æ— è¯·æ±‚ï¼Œå¤„äºç©ºé—²çŠ¶æ€ã€‚è€Œæˆ‘ä»¬æœŸæœ›çš„ç»“æœæ˜¯è¿™æ ·çš„ [A, A, B, A, C, A, A]ï¼Œä¸åŒæœåŠ¡å™¨å¯ä»¥ç©¿æ’è·å–è¯·æ±‚ã€‚ä¸ºäº†å¢åŠ è´Ÿè½½å‡è¡¡ç»“æœçš„å¹³æ»‘æ€§ï¼Œç¤¾åŒºå†æ¬¡å¯¹ RoundRobinLoadBalance çš„å®ç°è¿›è¡Œäº†é‡æ„ï¼Œè¿™æ¬¡é‡æ„å‚è€ƒè‡ª Nginx çš„å¹³æ»‘åŠ æƒè½®è¯¢è´Ÿè½½å‡è¡¡ã€‚æ¯ä¸ªæœåŠ¡å™¨å¯¹åº”ä¸¤ä¸ªæƒé‡ï¼Œåˆ†åˆ«ä¸º weight å’Œ currentWeightã€‚å…¶ä¸­ weight æ˜¯å›ºå®šçš„ï¼ŒcurrentWeight ä¼šåŠ¨æ€è°ƒæ•´ï¼Œåˆå§‹å€¼ä¸º0ã€‚å½“æœ‰æ–°çš„è¯·æ±‚è¿›æ¥æ—¶ï¼Œéå†æœåŠ¡å™¨åˆ—è¡¨ï¼Œè®©å®ƒçš„ currentWeight åŠ ä¸Šè‡ªèº«æƒé‡ã€‚éå†å®Œæˆåï¼Œæ‰¾åˆ°æœ€å¤§çš„ currentWeightï¼Œå¹¶å°†å…¶å‡å»æƒé‡æ€»å’Œï¼Œç„¶åè¿”å›ç›¸åº”çš„æœåŠ¡å™¨å³å¯ã€‚\nä¸Šé¢æè¿°ä¸æ˜¯å¾ˆå¥½ç†è§£ï¼Œä¸‹é¢è¿˜æ˜¯ä¸¾ä¾‹è¿›è¡Œè¯´æ˜ã€‚è¿™é‡Œä»ç„¶ä½¿ç”¨æœåŠ¡å™¨ [A, B, C] å¯¹åº”æƒé‡ [5, 1, 1] çš„ä¾‹å­è¯´æ˜ï¼Œç°åœ¨æœ‰7ä¸ªè¯·æ±‚ä¾æ¬¡è¿›å…¥è´Ÿè½½å‡è¡¡é€»è¾‘ï¼Œé€‰æ‹©è¿‡ç¨‹å¦‚ä¸‹ï¼š\n\n\n\nè¯·æ±‚ç¼–å·\ncurrentWeight æ•°ç»„\né€‰æ‹©ç»“æœ\nå‡å»æƒé‡æ€»å’Œåçš„ currentWeight æ•°ç»„\n\n\n\n1\n[5, 1, 1]\nA\n[-2, 1, 1]\n\n\n2\n[3, 2, 2]\nA\n[-4, 2, 2]\n\n\n3\n[1, 3, 3]\nB\n[1, -4, 3]\n\n\n4\n[6, -3, 4]\nA\n[-1, -3, 4]\n\n\n5\n[4, -2, 5]\nC\n[4, -2, -2]\n\n\n6\n[9, -1, -1]\nA\n[2, -1, -1]\n\n\n7\n[7, 0, 0]\nA\n[0, 0, 0]\n\n\nå¦‚ä¸Šï¼Œç»è¿‡å¹³æ»‘æ€§å¤„ç†åï¼Œå¾—åˆ°çš„æœåŠ¡å™¨åºåˆ—ä¸º [A, A, B, A, C, A, A]ï¼Œç›¸æ¯”ä¹‹å‰çš„åºåˆ— [A, A, A, A, A, B, C]ï¼Œåˆ†å¸ƒæ€§è¦å¥½ä¸€äº›ã€‚åˆå§‹æƒ…å†µä¸‹ currentWeight &#x3D; [0, 0, 0]ï¼Œç¬¬7ä¸ªè¯·æ±‚å¤„ç†å®Œåï¼ŒcurrentWeight å†æ¬¡å˜ä¸º [0, 0, 0]ã€‚\nä»¥ä¸Šå°±æ˜¯å¹³æ»‘åŠ æƒè½®è¯¢çš„è®¡ç®—è¿‡ç¨‹ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ Dubbo-2.6.5 æ˜¯å¦‚ä½•å®ç°ä¸Šé¢çš„è®¡ç®—è¿‡ç¨‹çš„ã€‚\npublic class RoundRobinLoadBalance extends AbstractLoadBalance &#123;\n    public static final String NAME = \"roundrobin\";\n    \n    private static int RECYCLE_PERIOD = 60000;\n    \n    protected static class WeightedRoundRobin &#123;\n        // æœåŠ¡æä¾›è€…æƒé‡\n        private int weight;\n        // å½“å‰æƒé‡\n        private AtomicLong current = new AtomicLong(0);\n        // æœ€åä¸€æ¬¡æ›´æ–°æ—¶é—´\n        private long lastUpdate;\n        \n        public void setWeight(int weight) &#123;\n            this.weight = weight;\n            // åˆå§‹æƒ…å†µä¸‹ï¼Œcurrent = 0\n            current.set(0);\n        &#125;\n        public long increaseCurrent() &#123;\n            // current = current + weightï¼›\n            return current.addAndGet(weight);\n        &#125;\n        public void sel(int total) &#123;\n            // current = current - total;\n            current.addAndGet(-1 * total);\n        &#125;\n    &#125;\n\n    // åµŒå¥— Map ç»“æ„ï¼Œå­˜å‚¨çš„æ•°æ®ç»“æ„ç¤ºä¾‹å¦‚ä¸‹ï¼š\n    // &#123;\n    //     \"UserService.query\": &#123;\n    //         \"url1\": WeightedRoundRobin@123, \n    //         \"url2\": WeightedRoundRobin@456, \n    //     &#125;,\n    //     \"UserService.update\": &#123;\n    //         \"url1\": WeightedRoundRobin@123, \n    //         \"url2\": WeightedRoundRobin@456,\n    //     &#125;\n    // &#125;\n    // æœ€å¤–å±‚ä¸ºæœåŠ¡ç±»å + æ–¹æ³•åï¼Œç¬¬äºŒå±‚ä¸º url åˆ° WeightedRoundRobin çš„æ˜ å°„å…³ç³»ã€‚\n    // è¿™é‡Œæˆ‘ä»¬å¯ä»¥å°† url çœ‹æˆæ˜¯æœåŠ¡æä¾›è€…çš„ id\n    private ConcurrentMap&lt;String, ConcurrentMap&lt;String, WeightedRoundRobin>> methodWeightMap = new ConcurrentHashMap&lt;String, ConcurrentMap&lt;String, WeightedRoundRobin>>();\n    \n    // åŸå­æ›´æ–°é”\n    private AtomicBoolean updateLock = new AtomicBoolean();\n    \n    @Override\n    protected &lt;T> Invoker&lt;T> doSelect(List&lt;Invoker&lt;T>> invokers, URL url, Invocation invocation) &#123;\n        String key = invokers.get(0).getUrl().getServiceKey() + \".\" + invocation.getMethodName();\n        // è·å– url åˆ° WeightedRoundRobin æ˜ å°„è¡¨ï¼Œå¦‚æœä¸ºç©ºï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„\n        ConcurrentMap&lt;String, WeightedRoundRobin> map = methodWeightMap.get(key);\n        if (map == null) &#123;\n            methodWeightMap.putIfAbsent(key, new ConcurrentHashMap&lt;String, WeightedRoundRobin>());\n            map = methodWeightMap.get(key);\n        &#125;\n        int totalWeight = 0;\n        long maxCurrent = Long.MIN_VALUE;\n        \n        // è·å–å½“å‰æ—¶é—´\n        long now = System.currentTimeMillis();\n        Invoker&lt;T> selectedInvoker = null;\n        WeightedRoundRobin selectedWRR = null;\n\n        // ä¸‹é¢è¿™ä¸ªå¾ªç¯ä¸»è¦åšäº†è¿™æ ·å‡ ä»¶äº‹æƒ…ï¼š\n        //   1. éå† Invoker åˆ—è¡¨ï¼Œæ£€æµ‹å½“å‰ Invoker æ˜¯å¦æœ‰\n        //      ç›¸åº”çš„ WeightedRoundRobinï¼Œæ²¡æœ‰åˆ™åˆ›å»º\n        //   2. æ£€æµ‹ Invoker æƒé‡æ˜¯å¦å‘ç”Ÿäº†å˜åŒ–ï¼Œè‹¥å˜åŒ–äº†ï¼Œ\n        //      åˆ™æ›´æ–° WeightedRoundRobin çš„ weight å­—æ®µ\n        //   3. è®© current å­—æ®µåŠ ä¸Šè‡ªèº«æƒé‡ï¼Œç­‰ä»·äº current += weight\n        //   4. è®¾ç½® lastUpdate å­—æ®µï¼Œå³ lastUpdate = now\n        //   5. å¯»æ‰¾å…·æœ‰æœ€å¤§ current çš„ Invokerï¼Œä»¥åŠ Invoker å¯¹åº”çš„ WeightedRoundRobinï¼Œ\n        //      æš‚å­˜èµ·æ¥ï¼Œç•™ä½œåç”¨\n        //   6. è®¡ç®—æƒé‡æ€»å’Œ\n        for (Invoker&lt;T> invoker : invokers) &#123;\n            String identifyString = invoker.getUrl().toIdentityString();\n            WeightedRoundRobin weightedRoundRobin = map.get(identifyString);\n            int weight = getWeight(invoker, invocation);\n            if (weight &lt; 0) &#123;\n                weight = 0;\n            &#125;\n            \n            // æ£€æµ‹å½“å‰ Invoker æ˜¯å¦æœ‰å¯¹åº”çš„ WeightedRoundRobinï¼Œæ²¡æœ‰åˆ™åˆ›å»º\n            if (weightedRoundRobin == null) &#123;\n                weightedRoundRobin = new WeightedRoundRobin();\n                // è®¾ç½® Invoker æƒé‡\n                weightedRoundRobin.setWeight(weight);\n                // å­˜å‚¨ url å”¯ä¸€æ ‡è¯† identifyString åˆ° weightedRoundRobin çš„æ˜ å°„å…³ç³»\n                map.putIfAbsent(identifyString, weightedRoundRobin);\n                weightedRoundRobin = map.get(identifyString);\n            &#125;\n            // Invoker æƒé‡ä¸ç­‰äº WeightedRoundRobin ä¸­ä¿å­˜çš„æƒé‡ï¼Œè¯´æ˜æƒé‡å˜åŒ–äº†ï¼Œæ­¤æ—¶è¿›è¡Œæ›´æ–°\n            if (weight != weightedRoundRobin.getWeight()) &#123;\n                weightedRoundRobin.setWeight(weight);\n            &#125;\n            \n            // è®© current åŠ ä¸Šè‡ªèº«æƒé‡ï¼Œç­‰ä»·äº current += weight\n            long cur = weightedRoundRobin.increaseCurrent();\n            // è®¾ç½® lastUpdateï¼Œè¡¨ç¤ºè¿‘æœŸæ›´æ–°è¿‡\n            weightedRoundRobin.setLastUpdate(now);\n            // æ‰¾å‡ºæœ€å¤§çš„ current \n            if (cur > maxCurrent) &#123;\n                maxCurrent = cur;\n                // å°†å…·æœ‰æœ€å¤§ current æƒé‡çš„ Invoker èµ‹å€¼ç»™ selectedInvoker\n                selectedInvoker = invoker;\n                // å°† Invoker å¯¹åº”çš„ weightedRoundRobin èµ‹å€¼ç»™ selectedWRRï¼Œç•™ä½œåç”¨\n                selectedWRR = weightedRoundRobin;\n            &#125;\n            \n            // è®¡ç®—æƒé‡æ€»å’Œ\n            totalWeight += weight;\n        &#125;\n\n        // å¯¹ &lt;identifyString, WeightedRoundRobin> è¿›è¡Œæ£€æŸ¥ï¼Œè¿‡æ»¤æ‰é•¿æ—¶é—´æœªè¢«æ›´æ–°çš„èŠ‚ç‚¹ã€‚\n        // è¯¥èŠ‚ç‚¹å¯èƒ½æŒ‚äº†ï¼Œinvokers ä¸­ä¸åŒ…å«è¯¥èŠ‚ç‚¹ï¼Œæ‰€ä»¥è¯¥èŠ‚ç‚¹çš„ lastUpdate é•¿æ—¶é—´æ— æ³•è¢«æ›´æ–°ã€‚\n        // è‹¥æœªæ›´æ–°æ—¶é•¿è¶…è¿‡é˜ˆå€¼åï¼Œå°±ä¼šè¢«ç§»é™¤æ‰ï¼Œé»˜è®¤é˜ˆå€¼ä¸º60ç§’ã€‚\n        if (!updateLock.get() &amp;&amp; invokers.size() != map.size()) &#123;\n            if (updateLock.compareAndSet(false, true)) &#123;\n                try &#123;\n                    ConcurrentMap&lt;String, WeightedRoundRobin> newMap = new ConcurrentHashMap&lt;String, WeightedRoundRobin>();\n                    // æ‹·è´\n                    newMap.putAll(map);\n                    \n                    // éå†ä¿®æ”¹ï¼Œå³ç§»é™¤è¿‡æœŸè®°å½•\n                    Iterator&lt;Entry&lt;String, WeightedRoundRobin>> it = newMap.entrySet().iterator();\n                    while (it.hasNext()) &#123;\n                        Entry&lt;String, WeightedRoundRobin> item = it.next();\n                        if (now - item.getValue().getLastUpdate() > RECYCLE_PERIOD) &#123;\n                            it.remove();\n                        &#125;\n                    &#125;\n                    \n                    // æ›´æ–°å¼•ç”¨\n                    methodWeightMap.put(key, newMap);\n                &#125; finally &#123;\n                    updateLock.set(false);\n                &#125;\n            &#125;\n        &#125;\n\n        if (selectedInvoker != null) &#123;\n            // è®© current å‡å»æƒé‡æ€»å’Œï¼Œç­‰ä»·äº current -= totalWeight\n            selectedWRR.sel(totalWeight);\n            // è¿”å›å…·æœ‰æœ€å¤§ current çš„ Invoker\n            return selectedInvoker;\n        &#125;\n        \n        // should not happen here\n        return invokers.get(0);\n    &#125;\n&#125;\n\nä»¥ä¸Šå°±æ˜¯ Dubbo-2.6.5 ç‰ˆæœ¬çš„ RoundRobinLoadBalanceï¼Œå¤§å®¶å¦‚æœèƒ½å¤Ÿç†è§£å¹³æ»‘åŠ æƒè½®è¯¢ç®—æ³•çš„è®¡ç®—è¿‡ç¨‹ï¼Œå†é…åˆä»£ç ä¸­æ³¨é‡Šï¼Œç†è§£ä¸Šé¢çš„ä»£ç åº”è¯¥ä¸éš¾ã€‚\n\n3.æ€»ç»“æœ¬ç¯‡æ–‡ç« å¯¹ Dubbo ä¸­çš„å‡ ç§è´Ÿè½½å‡è¡¡å®ç°è¿›è¡Œäº†è¯¦ç»†çš„åˆ†æï¼Œå†…å®¹æ¯”è¾ƒå¤šï¼Œå¤§å®¶æ…¢æ…¢æ¶ˆåŒ–ã€‚ç†è§£è´Ÿè½½å‡è¡¡ä»£ç é€»è¾‘çš„å…³é”®ä¹‹å¤„åœ¨äºå¯¹èƒŒæ™¯çŸ¥è¯†çš„ç†è§£ï¼Œå› æ­¤å¤§å®¶åœ¨é˜…è¯»æºç å‰ï¼ŒåŠ¡å¿…å…ˆäº†è§£æ¯ç§è´Ÿè½½å‡è¡¡å¯¹åº”çš„èƒŒæ™¯çŸ¥è¯†ã€‚\næœ¬æ–‡ä»‹ç»äº†æœåŠ¡è°ƒç”¨è¿‡ç¨‹çš„åŸç†å’Œå®ç°ç»†èŠ‚\n\næœåŠ¡å¯¼å‡º1. ç®€ä»‹åœ¨å‰é¢çš„æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬åˆ†æäº† Dubbo SPIã€æœåŠ¡å¯¼å‡ºä¸å¼•å…¥ã€ä»¥åŠé›†ç¾¤å®¹é”™æ–¹é¢çš„ä»£ç ã€‚ç»è¿‡å‰æ–‡çš„é“ºå«ï¼Œæœ¬ç¯‡æ–‡ç« æˆ‘ä»¬ç»ˆäºå¯ä»¥åˆ†ææœåŠ¡è°ƒç”¨è¿‡ç¨‹äº†ã€‚Dubbo æœåŠ¡è°ƒç”¨è¿‡ç¨‹æ¯”è¾ƒå¤æ‚ï¼ŒåŒ…å«ä¼—å¤šæ­¥éª¤ï¼Œæ¯”å¦‚å‘é€è¯·æ±‚ã€ç¼–è§£ç ã€æœåŠ¡é™çº§ã€è¿‡æ»¤å™¨é“¾å¤„ç†ã€åºåˆ—åŒ–ã€çº¿ç¨‹æ´¾å‘ä»¥åŠå“åº”è¯·æ±‚ç­‰æ­¥éª¤ã€‚é™äºç¯‡å¹…åŸå› ï¼Œæœ¬ç¯‡æ–‡ç« æ— æ³•å¯¹æ‰€æœ‰çš„æ­¥éª¤ä¸€ä¸€è¿›è¡Œåˆ†æã€‚æœ¬ç¯‡æ–‡ç« å°†ä¼šé‡ç‚¹åˆ†æè¯·æ±‚çš„å‘é€ä¸æ¥æ”¶ã€ç¼–è§£ç ã€çº¿ç¨‹æ´¾å‘ä»¥åŠå“åº”çš„å‘é€ä¸æ¥æ”¶ç­‰è¿‡ç¨‹ï¼Œè‡³äºæœåŠ¡é™çº§ã€è¿‡æ»¤å™¨é“¾å’Œåºåˆ—åŒ–å¤§å®¶è‡ªè¡Œè¿›è¡Œåˆ†æï¼Œä¹Ÿå¯ä»¥å°†å…¶å½“æˆä¸€ä¸ªé»‘ç›’ï¼Œæš‚æ—¶å¿½ç•¥ä¹Ÿæ²¡å…³ç³»ã€‚ä»‹ç»å®Œæœ¬ç¯‡æ–‡ç« è¦åˆ†æçš„å†…å®¹ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è¿›å…¥æ­£é¢˜å§ã€‚\n\n2. æºç åˆ†æåœ¨è¿›è¡Œæºç åˆ†æä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥é€šè¿‡ä¸€å¼ å›¾äº†è§£ Dubbo æœåŠ¡è°ƒç”¨è¿‡ç¨‹ã€‚\n\né¦–å…ˆæœåŠ¡æ¶ˆè´¹è€…é€šè¿‡ä»£ç†å¯¹è±¡ Proxy å‘èµ·è¿œç¨‹è°ƒç”¨ï¼Œæ¥ç€é€šè¿‡ç½‘ç»œå®¢æˆ·ç«¯ Client å°†ç¼–ç åçš„è¯·æ±‚å‘é€ç»™æœåŠ¡æä¾›æ–¹çš„ç½‘ç»œå±‚ä¸Šï¼Œä¹Ÿå°±æ˜¯ Serverã€‚Server åœ¨æ”¶åˆ°è¯·æ±‚åï¼Œé¦–å…ˆè¦åšçš„äº‹æƒ…æ˜¯å¯¹æ•°æ®åŒ…è¿›è¡Œè§£ç ã€‚ç„¶åå°†è§£ç åçš„è¯·æ±‚å‘é€è‡³åˆ†å‘å™¨ Dispatcherï¼Œå†ç”±åˆ†å‘å™¨å°†è¯·æ±‚æ´¾å‘åˆ°æŒ‡å®šçš„çº¿ç¨‹æ± ä¸Šï¼Œæœ€åç”±çº¿ç¨‹æ± è°ƒç”¨å…·ä½“çš„æœåŠ¡ã€‚è¿™å°±æ˜¯ä¸€ä¸ªè¿œç¨‹è°ƒç”¨è¯·æ±‚çš„å‘é€ä¸æ¥æ”¶è¿‡ç¨‹ã€‚è‡³äºå“åº”çš„å‘é€ä¸æ¥æ”¶è¿‡ç¨‹ï¼Œè¿™å¼ å›¾ä¸­æ²¡æœ‰è¡¨ç°å‡ºæ¥ã€‚å¯¹äºè¿™ä¸¤ä¸ªè¿‡ç¨‹ï¼Œæˆ‘ä»¬ä¹Ÿä¼šè¿›è¡Œè¯¦ç»†åˆ†æã€‚\n\n2.1 æœåŠ¡è°ƒç”¨æ–¹å¼Dubbo æ”¯æŒåŒæ­¥å’Œå¼‚æ­¥ä¸¤ç§è°ƒç”¨æ–¹å¼ï¼Œå…¶ä¸­å¼‚æ­¥è°ƒç”¨è¿˜å¯ç»†åˆ†ä¸ºâ€œæœ‰è¿”å›å€¼â€çš„å¼‚æ­¥è°ƒç”¨å’Œâ€œæ— è¿”å›å€¼â€çš„å¼‚æ­¥è°ƒç”¨ã€‚æ‰€è°“â€œæ— è¿”å›å€¼â€å¼‚æ­¥è°ƒç”¨æ˜¯æŒ‡æœåŠ¡æ¶ˆè´¹æ–¹åªç®¡è°ƒç”¨ï¼Œä½†ä¸å…³å¿ƒè°ƒç”¨ç»“æœï¼Œæ­¤æ—¶ Dubbo ä¼šç›´æ¥è¿”å›ä¸€ä¸ªç©ºçš„ RpcResultã€‚è‹¥è¦ä½¿ç”¨å¼‚æ­¥ç‰¹æ€§ï¼Œéœ€è¦æœåŠ¡æ¶ˆè´¹æ–¹æ‰‹åŠ¨è¿›è¡Œé…ç½®ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒDubbo ä½¿ç”¨åŒæ­¥è°ƒç”¨æ–¹å¼ã€‚\næœ¬èŠ‚ä»¥åŠå…¶ä»–ç« èŠ‚å°†ä¼šä½¿ç”¨ Dubbo å®˜æ–¹æä¾›çš„ Demo åˆ†ææ•´ä¸ªè°ƒç”¨è¿‡ç¨‹ï¼Œä¸‹é¢æˆ‘ä»¬ä» DemoService æ¥å£çš„ä»£ç†ç±»å¼€å§‹è¿›è¡Œåˆ†æã€‚Dubbo é»˜è®¤ä½¿ç”¨ Javassist æ¡†æ¶ä¸ºæœåŠ¡æ¥å£ç”ŸæˆåŠ¨æ€ä»£ç†ç±»ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å…ˆå°†ä»£ç†ç±»è¿›è¡Œåç¼–è¯‘æ‰èƒ½çœ‹åˆ°æºç ã€‚è¿™é‡Œä½¿ç”¨é˜¿é‡Œå¼€æº Java åº”ç”¨è¯Šæ–­å·¥å…· Arthas åç¼–è¯‘ä»£ç†ç±»ï¼Œç»“æœå¦‚ä¸‹ï¼š\n/**\n * Arthas åç¼–è¯‘æ­¥éª¤ï¼š\n * 1. å¯åŠ¨ Arthas\n *    java -jar arthas-boot.jar\n *\n * 2. è¾“å…¥ç¼–å·é€‰æ‹©è¿›ç¨‹\n *    Arthas å¯åŠ¨åï¼Œä¼šæ‰“å° Java åº”ç”¨è¿›ç¨‹åˆ—è¡¨ï¼Œå¦‚ä¸‹ï¼š\n *    [1]: 11232 org.jetbrains.jps.cmdline.Launcher\n *    [2]: 22370 org.jetbrains.jps.cmdline.Launcher\n *    [3]: 22371 com.alibaba.dubbo.demo.consumer.Consumer\n *    [4]: 22362 com.alibaba.dubbo.demo.provider.Provider\n *    [5]: 2074 org.apache.zookeeper.server.quorum.QuorumPeerMain\n * è¿™é‡Œè¾“å…¥ç¼–å· 3ï¼Œè®© Arthas å…³è”åˆ°å¯åŠ¨ç±»ä¸º com.....Consumer çš„ Java è¿›ç¨‹ä¸Š\n *\n * 3. ç”±äº Demo é¡¹ç›®ä¸­åªæœ‰ä¸€ä¸ªæœåŠ¡æ¥å£ï¼Œå› æ­¤æ­¤æ¥å£çš„ä»£ç†ç±»ç±»åä¸º proxy0ï¼Œæ­¤æ—¶ä½¿ç”¨ sc å‘½ä»¤æœç´¢è¿™ä¸ªç±»åã€‚\n *    $ sc *.proxy0\n *    com.alibaba.dubbo.common.bytecode.proxy0\n *\n * 4. ä½¿ç”¨ jad å‘½ä»¤åç¼–è¯‘ com.alibaba.dubbo.common.bytecode.proxy0\n *    $ jad com.alibaba.dubbo.common.bytecode.proxy0\n *\n * æ›´å¤šä½¿ç”¨æ–¹æ³•è¯·å‚è€ƒ Arthas å®˜æ–¹æ–‡æ¡£ï¼š\n *   https://alibaba.github.io/arthas/quick-start.html\n */\npublic class proxy0 implements ClassGenerator.DC, EchoService, DemoService &#123;\n    // æ–¹æ³•æ•°ç»„\n    public static Method[] methods;\n    private InvocationHandler handler;\n\n    public proxy0(InvocationHandler invocationHandler) &#123;\n        this.handler = invocationHandler;\n    &#125;\n\n    public proxy0() &#123;\n    &#125;\n\n    public String sayHello(String string) &#123;\n        // å°†å‚æ•°å­˜å‚¨åˆ° Object æ•°ç»„ä¸­\n        Object[] arrobject = new Object[]&#123;string&#125;;\n        // è°ƒç”¨ InvocationHandler å®ç°ç±»çš„ invoke æ–¹æ³•å¾—åˆ°è°ƒç”¨ç»“æœ\n        Object object = this.handler.invoke(this, methods[0], arrobject);\n        // è¿”å›è°ƒç”¨ç»“æœ\n        return (String)object;\n    &#125;\n\n    /** å›å£°æµ‹è¯•æ–¹æ³• */\n    public Object $echo(Object object) &#123;\n        Object[] arrobject = new Object[]&#123;object&#125;;\n        Object object2 = this.handler.invoke(this, methods[1], arrobject);\n        return object2;\n    &#125;\n&#125;\n\nå¦‚ä¸Šï¼Œä»£ç†ç±»çš„é€»è¾‘æ¯”è¾ƒç®€å•ã€‚é¦–å…ˆå°†è¿è¡Œæ—¶å‚æ•°å­˜å‚¨åˆ°æ•°ç»„ä¸­ï¼Œç„¶åè°ƒç”¨ InvocationHandler æ¥å£å®ç°ç±»çš„ invoke æ–¹æ³•ï¼Œå¾—åˆ°è°ƒç”¨ç»“æœï¼Œæœ€åå°†ç»“æœè½¬å‹å¹¶è¿”å›ç»™è°ƒç”¨æ–¹ã€‚å…³äºä»£ç†ç±»çš„é€»è¾‘å°±è¯´è¿™ä¹ˆå¤šï¼Œç»§ç»­å‘ä¸‹åˆ†æã€‚\npublic class InvokerInvocationHandler implements InvocationHandler &#123;\n\n    private final Invoker&lt;?> invoker;\n\n    public InvokerInvocationHandler(Invoker&lt;?> handler) &#123;\n        this.invoker = handler;\n    &#125;\n\n    @Override\n    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123;\n        String methodName = method.getName();\n        Class&lt;?>[] parameterTypes = method.getParameterTypes();\n        \n        // æ‹¦æˆªå®šä¹‰åœ¨ Object ç±»ä¸­çš„æ–¹æ³•ï¼ˆæœªè¢«å­ç±»é‡å†™ï¼‰ï¼Œæ¯”å¦‚ wait/notify\n        if (method.getDeclaringClass() == Object.class) &#123;\n            return method.invoke(invoker, args);\n        &#125;\n        \n        // å¦‚æœ toStringã€hashCode å’Œ equals ç­‰æ–¹æ³•è¢«å­ç±»é‡å†™äº†ï¼Œè¿™é‡Œä¹Ÿç›´æ¥è°ƒç”¨\n        if (\"toString\".equals(methodName) &amp;&amp; parameterTypes.length == 0) &#123;\n            return invoker.toString();\n        &#125;\n        if (\"hashCode\".equals(methodName) &amp;&amp; parameterTypes.length == 0) &#123;\n            return invoker.hashCode();\n        &#125;\n        if (\"equals\".equals(methodName) &amp;&amp; parameterTypes.length == 1) &#123;\n            return invoker.equals(args[0]);\n        &#125;\n        \n        // å°† method å’Œ args å°è£…åˆ° RpcInvocation ä¸­ï¼Œå¹¶æ‰§è¡Œåç»­çš„è°ƒç”¨\n        return invoker.invoke(new RpcInvocation(method, args)).recreate();\n    &#125;\n&#125;\n\nInvokerInvocationHandler ä¸­çš„ invoker æˆå‘˜å˜é‡ç±»å‹ä¸º MockClusterInvokerï¼ŒMockClusterInvoker å†…éƒ¨å°è£…äº†æœåŠ¡é™çº§é€»è¾‘ã€‚ä¸‹é¢ç®€å•çœ‹ä¸€ä¸‹ï¼š\npublic class MockClusterInvoker&lt;T> implements Invoker&lt;T> &#123;\n    \n    private final Invoker&lt;T> invoker;\n    \n    public Result invoke(Invocation invocation) throws RpcException &#123;\n        Result result = null;\n\n        // è·å– mock é…ç½®å€¼\n        String value = directory.getUrl().getMethodParameter(invocation.getMethodName(), Constants.MOCK_KEY, Boolean.FALSE.toString()).trim();\n        if (value.length() == 0 || value.equalsIgnoreCase(\"false\")) &#123;\n            // æ—  mock é€»è¾‘ï¼Œç›´æ¥è°ƒç”¨å…¶ä»– Invoker å¯¹è±¡çš„ invoke æ–¹æ³•ï¼Œ\n            // æ¯”å¦‚ FailoverClusterInvoker\n            result = this.invoker.invoke(invocation);\n        &#125; else if (value.startsWith(\"force\")) &#123;\n            // force:xxx ç›´æ¥æ‰§è¡Œ mock é€»è¾‘ï¼Œä¸å‘èµ·è¿œç¨‹è°ƒç”¨\n            result = doMockInvoke(invocation, null);\n        &#125; else &#123;\n            // fail:xxx è¡¨ç¤ºæ¶ˆè´¹æ–¹å¯¹è°ƒç”¨æœåŠ¡å¤±è´¥åï¼Œå†æ‰§è¡Œ mock é€»è¾‘ï¼Œä¸æŠ›å‡ºå¼‚å¸¸\n            try &#123;\n                // è°ƒç”¨å…¶ä»– Invoker å¯¹è±¡çš„ invoke æ–¹æ³•\n                result = this.invoker.invoke(invocation);\n            &#125; catch (RpcException e) &#123;\n                if (e.isBiz()) &#123;\n                    throw e;\n                &#125; else &#123;\n                    // è°ƒç”¨å¤±è´¥ï¼Œæ‰§è¡Œ mock é€»è¾‘\n                    result = doMockInvoke(invocation, e);\n                &#125;\n            &#125;\n        &#125;\n        return result;\n    &#125;\n    \n    // çœç•¥å…¶ä»–æ–¹æ³•\n&#125;\n\næœåŠ¡é™çº§ä¸æ˜¯æœ¬æ–‡é‡ç‚¹ï¼Œå› æ­¤è¿™é‡Œå°±ä¸åˆ†æ doMockInvoke æ–¹æ³•äº†ã€‚è€ƒè™‘åˆ°å‰æ–‡å·²ç»è¯¦ç»†åˆ†æè¿‡ FailoverClusterInvokerï¼Œå› æ­¤æœ¬èŠ‚ç•¥è¿‡ FailoverClusterInvokerï¼Œç›´æ¥åˆ†æ DubboInvokerã€‚\npublic abstract class AbstractInvoker&lt;T> implements Invoker&lt;T> &#123;\n    \n    public Result invoke(Invocation inv) throws RpcException &#123;\n        if (destroyed.get()) &#123;\n            throw new RpcException(\"Rpc invoker for service ...\");\n        &#125;\n        RpcInvocation invocation = (RpcInvocation) inv;\n        // è®¾ç½® Invoker\n        invocation.setInvoker(this);\n        if (attachment != null &amp;&amp; attachment.size() > 0) &#123;\n            // è®¾ç½® attachment\n            invocation.addAttachmentsIfAbsent(attachment);\n        &#125;\n        Map&lt;String, String> contextAttachments = RpcContext.getContext().getAttachments();\n        if (contextAttachments != null &amp;&amp; contextAttachments.size() != 0) &#123;\n            // æ·»åŠ  contextAttachments åˆ° RpcInvocation#attachment å˜é‡ä¸­\n            invocation.addAttachments(contextAttachments);\n        &#125;\n        if (getUrl().getMethodParameter(invocation.getMethodName(), Constants.ASYNC_KEY, false)) &#123;\n            // è®¾ç½®å¼‚æ­¥ä¿¡æ¯åˆ° RpcInvocation#attachment ä¸­\n            invocation.setAttachment(Constants.ASYNC_KEY, Boolean.TRUE.toString());\n        &#125;\n        RpcUtils.attachInvocationIdIfAsync(getUrl(), invocation);\n\n        try &#123;\n            // æŠ½è±¡æ–¹æ³•ï¼Œç”±å­ç±»å®ç°\n            return doInvoke(invocation);\n        &#125; catch (InvocationTargetException e) &#123;\n            // ...\n        &#125; catch (RpcException e) &#123;\n            // ...\n        &#125; catch (Throwable e) &#123;\n            return new RpcResult(e);\n        &#125;\n    &#125;\n\n    protected abstract Result doInvoke(Invocation invocation) throws Throwable;\n    \n    // çœç•¥å…¶ä»–æ–¹æ³•\n&#125;\n\nä¸Šé¢çš„ä»£ç æ¥è‡ª AbstractInvoker ç±»ï¼Œå…¶ä¸­å¤§éƒ¨åˆ†ä»£ç ç”¨äºæ·»åŠ ä¿¡æ¯åˆ° RpcInvocation#attachment å˜é‡ä¸­ï¼Œæ·»åŠ å®Œæ¯•åï¼Œè°ƒç”¨ doInvoke æ‰§è¡Œåç»­çš„è°ƒç”¨ã€‚doInvoke æ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œéœ€è¦ç”±å­ç±»å®ç°ï¼Œä¸‹é¢åˆ° DubboInvoker ä¸­çœ‹ä¸€ä¸‹ã€‚\npublic class DubboInvoker&lt;T> extends AbstractInvoker&lt;T> &#123;\n    \n    private final ExchangeClient[] clients;\n    \n    protected Result doInvoke(final Invocation invocation) throws Throwable &#123;\n        RpcInvocation inv = (RpcInvocation) invocation;\n        final String methodName = RpcUtils.getMethodName(invocation);\n        // è®¾ç½® path å’Œ version åˆ° attachment ä¸­\n        inv.setAttachment(Constants.PATH_KEY, getUrl().getPath());\n        inv.setAttachment(Constants.VERSION_KEY, version);\n\n        ExchangeClient currentClient;\n        if (clients.length == 1) &#123;\n            // ä» clients æ•°ç»„ä¸­è·å– ExchangeClient\n            currentClient = clients[0];\n        &#125; else &#123;\n            currentClient = clients[index.getAndIncrement() % clients.length];\n        &#125;\n        try &#123;\n            // è·å–å¼‚æ­¥é…ç½®\n            boolean isAsync = RpcUtils.isAsync(getUrl(), invocation);\n            // isOneway ä¸º trueï¼Œè¡¨ç¤ºâ€œå•å‘â€é€šä¿¡\n            boolean isOneway = RpcUtils.isOneway(getUrl(), invocation);\n            int timeout = getUrl().getMethodParameter(methodName, Constants.TIMEOUT_KEY, Constants.DEFAULT_TIMEOUT);\n\n            // å¼‚æ­¥æ— è¿”å›å€¼\n            if (isOneway) &#123;\n                boolean isSent = getUrl().getMethodParameter(methodName, Constants.SENT_KEY, false);\n                // å‘é€è¯·æ±‚\n                currentClient.send(inv, isSent);\n                // è®¾ç½®ä¸Šä¸‹æ–‡ä¸­çš„ future å­—æ®µä¸º null\n                RpcContext.getContext().setFuture(null);\n                // è¿”å›ä¸€ä¸ªç©ºçš„ RpcResult\n                return new RpcResult();\n            &#125; \n\n            // å¼‚æ­¥æœ‰è¿”å›å€¼\n            else if (isAsync) &#123;\n                // å‘é€è¯·æ±‚ï¼Œå¹¶å¾—åˆ°ä¸€ä¸ª ResponseFuture å®ä¾‹\n                ResponseFuture future = currentClient.request(inv, timeout);\n                // è®¾ç½® future åˆ°ä¸Šä¸‹æ–‡ä¸­\n                RpcContext.getContext().setFuture(new FutureAdapter&lt;Object>(future));\n                // æš‚æ—¶è¿”å›ä¸€ä¸ªç©ºç»“æœ\n                return new RpcResult();\n            &#125; \n\n            // åŒæ­¥è°ƒç”¨\n            else &#123;\n                RpcContext.getContext().setFuture(null);\n                // å‘é€è¯·æ±‚ï¼Œå¾—åˆ°ä¸€ä¸ª ResponseFuture å®ä¾‹ï¼Œå¹¶è°ƒç”¨è¯¥å®ä¾‹çš„ get æ–¹æ³•è¿›è¡Œç­‰å¾…\n                return (Result) currentClient.request(inv, timeout).get();\n            &#125;\n        &#125; catch (TimeoutException e) &#123;\n            throw new RpcException(..., \"Invoke remote method timeout....\");\n        &#125; catch (RemotingException e) &#123;\n            throw new RpcException(..., \"Failed to invoke remote method: ...\");\n        &#125;\n    &#125;\n    \n    // çœç•¥å…¶ä»–æ–¹æ³•\n&#125;\n\nä¸Šé¢çš„ä»£ç åŒ…å«äº† Dubbo å¯¹åŒæ­¥å’Œå¼‚æ­¥è°ƒç”¨çš„å¤„ç†é€»è¾‘ï¼Œææ‡‚äº†ä¸Šé¢çš„ä»£ç ï¼Œä¼šå¯¹ Dubbo çš„åŒæ­¥å’Œå¼‚æ­¥è°ƒç”¨æ–¹å¼æœ‰æ›´æ·±å…¥çš„äº†è§£ã€‚Dubbo å®ç°åŒæ­¥å’Œå¼‚æ­¥è°ƒç”¨æ¯”è¾ƒå…³é”®çš„ä¸€ç‚¹å°±åœ¨äºç”±è°è°ƒç”¨ ResponseFuture çš„ get æ–¹æ³•ã€‚åŒæ­¥è°ƒç”¨æ¨¡å¼ä¸‹ï¼Œç”±æ¡†æ¶è‡ªèº«è°ƒç”¨ ResponseFuture çš„ get æ–¹æ³•ã€‚å¼‚æ­¥è°ƒç”¨æ¨¡å¼ä¸‹ï¼Œåˆ™ç”±ç”¨æˆ·è°ƒç”¨è¯¥æ–¹æ³•ã€‚ResponseFuture æ˜¯ä¸€ä¸ªæ¥å£ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å®ƒçš„é»˜è®¤å®ç°ç±» DefaultFuture çš„æºç ã€‚\npublic class DefaultFuture implements ResponseFuture &#123;\n    \n    private static final Map&lt;Long, Channel> CHANNELS = \n        new ConcurrentHashMap&lt;Long, Channel>();\n\n    private static final Map&lt;Long, DefaultFuture> FUTURES = \n        new ConcurrentHashMap&lt;Long, DefaultFuture>();\n    \n    private final long id;\n    private final Channel channel;\n    private final Request request;\n    private final int timeout;\n    private final Lock lock = new ReentrantLock();\n    private final Condition done = lock.newCondition();\n    private volatile Response response;\n    \n    public DefaultFuture(Channel channel, Request request, int timeout) &#123;\n        this.channel = channel;\n        this.request = request;\n        \n        // è·å–è¯·æ±‚ idï¼Œè¿™ä¸ª id å¾ˆé‡è¦ï¼Œåé¢è¿˜ä¼šè§åˆ°\n        this.id = request.getId();\n        this.timeout = timeout > 0 ? timeout : channel.getUrl().getPositiveParameter(Constants.TIMEOUT_KEY, Constants.DEFAULT_TIMEOUT);\n        // å­˜å‚¨ &lt;requestId, DefaultFuture> æ˜ å°„å…³ç³»åˆ° FUTURES ä¸­\n        FUTURES.put(id, this);\n        CHANNELS.put(id, channel);\n    &#125;\n    \n    @Override\n    public Object get() throws RemotingException &#123;\n        return get(timeout);\n    &#125;\n\n    @Override\n    public Object get(int timeout) throws RemotingException &#123;\n        if (timeout &lt;= 0) &#123;\n            timeout = Constants.DEFAULT_TIMEOUT;\n        &#125;\n        \n        // æ£€æµ‹æœåŠ¡æä¾›æ–¹æ˜¯å¦æˆåŠŸè¿”å›äº†è°ƒç”¨ç»“æœ\n        if (!isDone()) &#123;\n            long start = System.currentTimeMillis();\n            lock.lock();\n            try &#123;\n                // å¾ªç¯æ£€æµ‹æœåŠ¡æä¾›æ–¹æ˜¯å¦æˆåŠŸè¿”å›äº†è°ƒç”¨ç»“æœ\n                while (!isDone()) &#123;\n                    // å¦‚æœè°ƒç”¨ç»“æœå°šæœªè¿”å›ï¼Œè¿™é‡Œç­‰å¾…ä¸€æ®µæ—¶é—´\n                    done.await(timeout, TimeUnit.MILLISECONDS);\n                    // å¦‚æœè°ƒç”¨ç»“æœæˆåŠŸè¿”å›ï¼Œæˆ–ç­‰å¾…è¶…æ—¶ï¼Œæ­¤æ—¶è·³å‡º while å¾ªç¯ï¼Œæ‰§è¡Œåç»­çš„é€»è¾‘\n                    if (isDone() || System.currentTimeMillis() - start > timeout) &#123;\n                        break;\n                    &#125;\n                &#125;\n            &#125; catch (InterruptedException e) &#123;\n                throw new RuntimeException(e);\n            &#125; finally &#123;\n                lock.unlock();\n            &#125;\n            \n            // å¦‚æœè°ƒç”¨ç»“æœä»æœªè¿”å›ï¼Œåˆ™æŠ›å‡ºè¶…æ—¶å¼‚å¸¸\n            if (!isDone()) &#123;\n                throw new TimeoutException(sent > 0, channel, getTimeoutMessage(false));\n            &#125;\n        &#125;\n        \n        // è¿”å›è°ƒç”¨ç»“æœ\n        return returnFromResponse();\n    &#125;\n    \n    @Override\n    public boolean isDone() &#123;\n        // é€šè¿‡æ£€æµ‹ response å­—æ®µä¸ºç©ºä¸å¦ï¼Œåˆ¤æ–­æ˜¯å¦æ”¶åˆ°äº†è°ƒç”¨ç»“æœ\n        return response != null;\n    &#125;\n    \n    private Object returnFromResponse() throws RemotingException &#123;\n        Response res = response;\n        if (res == null) &#123;\n            throw new IllegalStateException(\"response cannot be null\");\n        &#125;\n        \n        // å¦‚æœè°ƒç”¨ç»“æœçš„çŠ¶æ€ä¸º Response.OKï¼Œåˆ™è¡¨ç¤ºè°ƒç”¨è¿‡ç¨‹æ­£å¸¸ï¼ŒæœåŠ¡æä¾›æ–¹æˆåŠŸè¿”å›äº†è°ƒç”¨ç»“æœ\n        if (res.getStatus() == Response.OK) &#123;\n            return res.getResult();\n        &#125;\n        \n        // æŠ›å‡ºå¼‚å¸¸\n        if (res.getStatus() == Response.CLIENT_TIMEOUT || res.getStatus() == Response.SERVER_TIMEOUT) &#123;\n            throw new TimeoutException(res.getStatus() == Response.SERVER_TIMEOUT, channel, res.getErrorMessage());\n        &#125;\n        throw new RemotingException(channel, res.getErrorMessage());\n    &#125;\n    \n    // çœç•¥å…¶ä»–æ–¹æ³•\n&#125;\n\nå¦‚ä¸Šï¼Œå½“æœåŠ¡æ¶ˆè´¹è€…è¿˜æœªæ¥æ”¶åˆ°è°ƒç”¨ç»“æœæ—¶ï¼Œç”¨æˆ·çº¿ç¨‹è°ƒç”¨ get æ–¹æ³•ä¼šè¢«é˜»å¡ä½ã€‚åŒæ­¥è°ƒç”¨æ¨¡å¼ä¸‹ï¼Œæ¡†æ¶è·å¾— DefaultFuture å¯¹è±¡åï¼Œä¼šç«‹å³è°ƒç”¨ get æ–¹æ³•è¿›è¡Œç­‰å¾…ã€‚è€Œå¼‚æ­¥æ¨¡å¼ä¸‹åˆ™æ˜¯å°†è¯¥å¯¹è±¡å°è£…åˆ° FutureAdapter å®ä¾‹ä¸­ï¼Œå¹¶å°† FutureAdapter å®ä¾‹è®¾ç½®åˆ° RpcContext ä¸­ï¼Œä¾›ç”¨æˆ·ä½¿ç”¨ã€‚FutureAdapter æ˜¯ä¸€ä¸ªé€‚é…å™¨ï¼Œç”¨äºå°† Dubbo ä¸­çš„ ResponseFuture ä¸ JDK ä¸­çš„ Future è¿›è¡Œé€‚é…ã€‚è¿™æ ·å½“ç”¨æˆ·çº¿ç¨‹è°ƒç”¨ Future çš„ get æ–¹æ³•æ—¶ï¼Œç»è¿‡ FutureAdapter é€‚é…ï¼Œæœ€ç»ˆä¼šè°ƒç”¨ ResponseFuture å®ç°ç±»å¯¹è±¡çš„ get æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯ DefaultFuture çš„ get æ–¹æ³•ã€‚\nåˆ°è¿™é‡Œå…³äº Dubbo å‡ ç§è°ƒç”¨æ–¹å¼çš„ä»£ç é€»è¾‘å°±åˆ†æå®Œäº†ï¼Œä¸‹é¢æ¥åˆ†æè¯·æ±‚æ•°æ®çš„å‘é€ä¸æ¥æ”¶ï¼Œä»¥åŠå“åº”æ•°æ®çš„å‘é€ä¸æ¥æ”¶è¿‡ç¨‹ã€‚\n\n2.2 æœåŠ¡æ¶ˆè´¹æ–¹å‘é€è¯·æ±‚\n2.2.1 å‘é€è¯·æ±‚æœ¬èŠ‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹åŒæ­¥è°ƒç”¨æ¨¡å¼ä¸‹ï¼ŒæœåŠ¡æ¶ˆè´¹æ–¹æ˜¯å¦‚ä½•å‘é€è°ƒç”¨è¯·æ±‚çš„ã€‚åœ¨æ·±å…¥åˆ†ææºç å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€å¼ å›¾ã€‚\n\nè¿™å¼ å›¾å±•ç¤ºäº†æœåŠ¡æ¶ˆè´¹æ–¹å‘é€è¯·æ±‚è¿‡ç¨‹çš„éƒ¨åˆ†è°ƒç”¨æ ˆï¼Œç•¥ä¸ºå¤æ‚ã€‚ä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼Œç»è¿‡å¤šæ¬¡è°ƒç”¨åï¼Œæ‰å°†è¯·æ±‚æ•°æ®é€è‡³ Netty NioClientSocketChannelã€‚è¿™æ ·åšçš„åŸå› æ˜¯é€šè¿‡ Exchange å±‚ä¸ºæ¡†æ¶å¼•å…¥ Request å’Œ Response è¯­ä¹‰ï¼Œè¿™ä¸€ç‚¹ä¼šåœ¨æ¥ä¸‹æ¥çš„æºç åˆ†æè¿‡ç¨‹ä¸­ä¼šçœ‹åˆ°ã€‚å…¶ä»–çš„å°±ä¸å¤šè¯´äº†ï¼Œä¸‹é¢å¼€å§‹è¿›è¡Œåˆ†æã€‚é¦–å…ˆåˆ†æ ReferenceCountExchangeClient çš„æºç ã€‚\nfinal class ReferenceCountExchangeClient implements ExchangeClient &#123;\n\n    private final URL url;\n    private final AtomicInteger referenceCount = new AtomicInteger(0);\n\n    public ReferenceCountExchangeClient(ExchangeClient client, ConcurrentMap&lt;String, LazyConnectExchangeClient> ghostClientMap) &#123;\n        this.client = client;\n        // å¼•ç”¨è®¡æ•°è‡ªå¢\n        referenceCount.incrementAndGet();\n        this.url = client.getUrl();\n        \n        // ...\n    &#125;\n\n    @Override\n    public ResponseFuture request(Object request) throws RemotingException &#123;\n        // ç›´æ¥è°ƒç”¨è¢«è£…é¥°å¯¹è±¡çš„åŒç­¾åæ–¹æ³•\n        return client.request(request);\n    &#125;\n\n    @Override\n    public ResponseFuture request(Object request, int timeout) throws RemotingException &#123;\n        // ç›´æ¥è°ƒç”¨è¢«è£…é¥°å¯¹è±¡çš„åŒç­¾åæ–¹æ³•\n        return client.request(request, timeout);\n    &#125;\n\n    /** å¼•ç”¨è®¡æ•°è‡ªå¢ï¼Œè¯¥æ–¹æ³•ç”±å¤–éƒ¨è°ƒç”¨ */\n    public void incrementAndGetCount() &#123;\n        // referenceCount è‡ªå¢\n        referenceCount.incrementAndGet();\n    &#125;\n    \n        @Override\n    public void close(int timeout) &#123;\n        // referenceCount è‡ªå‡\n        if (referenceCount.decrementAndGet() &lt;= 0) &#123;\n            if (timeout == 0) &#123;\n                client.close();\n            &#125; else &#123;\n                client.close(timeout);\n            &#125;\n            client = replaceWithLazyClient();\n        &#125;\n    &#125;\n    \n    // çœç•¥éƒ¨åˆ†æ–¹æ³•\n&#125;\n\nReferenceCountExchangeClient å†…éƒ¨å®šä¹‰äº†ä¸€ä¸ªå¼•ç”¨è®¡æ•°å˜é‡ referenceCountï¼Œæ¯å½“è¯¥å¯¹è±¡è¢«å¼•ç”¨ä¸€æ¬¡ referenceCount éƒ½ä¼šè¿›è¡Œè‡ªå¢ã€‚æ¯å½“ close æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼ŒreferenceCount è¿›è¡Œè‡ªå‡ã€‚ReferenceCountExchangeClient å†…éƒ¨ä»…å®ç°äº†ä¸€ä¸ªå¼•ç”¨è®¡æ•°çš„åŠŸèƒ½ï¼Œå…¶ä»–æ–¹æ³•å¹¶æ— å¤æ‚é€»è¾‘ï¼Œå‡æ˜¯ç›´æ¥è°ƒç”¨è¢«è£…é¥°å¯¹è±¡çš„ç›¸å…³æ–¹æ³•ã€‚æ‰€ä»¥è¿™é‡Œå°±ä¸å¤šè¯´äº†ï¼Œç»§ç»­å‘ä¸‹åˆ†æï¼Œè¿™æ¬¡æ˜¯ HeaderExchangeClientã€‚\npublic class HeaderExchangeClient implements ExchangeClient &#123;\n\n    private static final ScheduledThreadPoolExecutor scheduled = new ScheduledThreadPoolExecutor(2, new NamedThreadFactory(\"dubbo-remoting-client-heartbeat\", true));\n    private final Client client;\n    private final ExchangeChannel channel;\n    private ScheduledFuture&lt;?> heartbeatTimer;\n    private int heartbeat;\n    private int heartbeatTimeout;\n\n    public HeaderExchangeClient(Client client, boolean needHeartbeat) &#123;\n        if (client == null) &#123;\n            throw new IllegalArgumentException(\"client == null\");\n        &#125;\n        this.client = client;\n        \n        // åˆ›å»º HeaderExchangeChannel å¯¹è±¡\n        this.channel = new HeaderExchangeChannel(client);\n        \n        // ä»¥ä¸‹ä»£ç å‡ä¸å¿ƒè·³æ£€æµ‹é€»è¾‘æœ‰å…³\n        String dubbo = client.getUrl().getParameter(Constants.DUBBO_VERSION_KEY);\n        this.heartbeat = client.getUrl().getParameter(Constants.HEARTBEAT_KEY, dubbo != null &amp;&amp; dubbo.startsWith(\"1.0.\") ? Constants.DEFAULT_HEARTBEAT : 0);\n        this.heartbeatTimeout = client.getUrl().getParameter(Constants.HEARTBEAT_TIMEOUT_KEY, heartbeat * 3);\n        if (heartbeatTimeout &lt; heartbeat * 2) &#123;\n            throw new IllegalStateException(\"heartbeatTimeout &lt; heartbeatInterval * 2\");\n        &#125;\n        if (needHeartbeat) &#123;\n            // å¼€å¯å¿ƒè·³æ£€æµ‹å®šæ—¶å™¨\n            startHeartbeatTimer();\n        &#125;\n    &#125;\n\n    @Override\n    public ResponseFuture request(Object request) throws RemotingException &#123;\n        // ç›´æ¥ HeaderExchangeChannel å¯¹è±¡çš„åŒç­¾åæ–¹æ³•\n        return channel.request(request);\n    &#125;\n\n    @Override\n    public ResponseFuture request(Object request, int timeout) throws RemotingException &#123;\n        // ç›´æ¥ HeaderExchangeChannel å¯¹è±¡çš„åŒç­¾åæ–¹æ³•\n        return channel.request(request, timeout);\n    &#125;\n\n    @Override\n    public void close() &#123;\n        doClose();\n        channel.close();\n    &#125;\n    \n    private void doClose() &#123;\n        // åœæ­¢å¿ƒè·³æ£€æµ‹å®šæ—¶å™¨\n        stopHeartbeatTimer();\n    &#125;\n\n    private void startHeartbeatTimer() &#123;\n        stopHeartbeatTimer();\n        if (heartbeat > 0) &#123;\n            heartbeatTimer = scheduled.scheduleWithFixedDelay(\n                    new HeartBeatTask(new HeartBeatTask.ChannelProvider() &#123;\n                        @Override\n                        public Collection&lt;Channel> getChannels() &#123;\n                            return Collections.&lt;Channel>singletonList(HeaderExchangeClient.this);\n                        &#125;\n                    &#125;, heartbeat, heartbeatTimeout),\n                    heartbeat, heartbeat, TimeUnit.MILLISECONDS);\n        &#125;\n    &#125;\n\n    private void stopHeartbeatTimer() &#123;\n        if (heartbeatTimer != null &amp;&amp; !heartbeatTimer.isCancelled()) &#123;\n            try &#123;\n                heartbeatTimer.cancel(true);\n                scheduled.purge();\n            &#125; catch (Throwable e) &#123;\n                if (logger.isWarnEnabled()) &#123;\n                    logger.warn(e.getMessage(), e);\n                &#125;\n            &#125;\n        &#125;\n        heartbeatTimer = null;\n    &#125;\n    \n    // çœç•¥éƒ¨åˆ†æ–¹æ³•\n&#125;\n\nHeaderExchangeClient ä¸­å¾ˆå¤šæ–¹æ³•åªæœ‰ä¸€è¡Œä»£ç ï¼Œå³è°ƒç”¨ HeaderExchangeChannel å¯¹è±¡çš„åŒç­¾åæ–¹æ³•ã€‚é‚£ HeaderExchangeClient æœ‰ä»€ä¹ˆç”¨å¤„å‘¢ï¼Ÿç­”æ¡ˆæ˜¯å°è£…äº†ä¸€äº›å…³äºå¿ƒè·³æ£€æµ‹çš„é€»è¾‘ã€‚å¿ƒè·³æ£€æµ‹å¹¶éæœ¬æ–‡æ‰€å…³æ³¨çš„ç‚¹ï¼Œå› æ­¤å°±ä¸å¤šè¯´äº†ï¼Œç»§ç»­å‘ä¸‹çœ‹ã€‚\nfinal class HeaderExchangeChannel implements ExchangeChannel &#123;\n    \n    private final Channel channel;\n    \n    HeaderExchangeChannel(Channel channel) &#123;\n        if (channel == null) &#123;\n            throw new IllegalArgumentException(\"channel == null\");\n        &#125;\n        \n        // è¿™é‡Œçš„ channel æŒ‡å‘çš„æ˜¯ NettyClient\n        this.channel = channel;\n    &#125;\n    \n    @Override\n    public ResponseFuture request(Object request) throws RemotingException &#123;\n        return request(request, channel.getUrl().getPositiveParameter(Constants.TIMEOUT_KEY, Constants.DEFAULT_TIMEOUT));\n    &#125;\n\n    @Override\n    public ResponseFuture request(Object request, int timeout) throws RemotingException &#123;\n        if (closed) &#123;\n            throw new RemotingException(..., \"Failed to send request ...);\n        &#125;\n        // åˆ›å»º Request å¯¹è±¡\n        Request req = new Request();\n        req.setVersion(Version.getProtocolVersion());\n        // è®¾ç½®åŒå‘é€šä¿¡æ ‡å¿—ä¸º true\n        req.setTwoWay(true);\n        // è¿™é‡Œçš„ request å˜é‡ç±»å‹ä¸º RpcInvocation\n        req.setData(request);\n                                        \n        // åˆ›å»º DefaultFuture å¯¹è±¡\n        DefaultFuture future = new DefaultFuture(channel, req, timeout);\n        try &#123;\n            // è°ƒç”¨ NettyClient çš„ send æ–¹æ³•å‘é€è¯·æ±‚\n            channel.send(req);\n        &#125; catch (RemotingException e) &#123;\n            future.cancel();\n            throw e;\n        &#125;\n        // è¿”å› DefaultFuture å¯¹è±¡\n        return future;\n    &#125;\n&#125;\n\nåˆ°è¿™é‡Œå¤§å®¶ç»ˆäºçœ‹åˆ°äº† Request è¯­ä¹‰äº†ï¼Œä¸Šé¢çš„æ–¹æ³•é¦–å…ˆå®šä¹‰äº†ä¸€ä¸ª Request å¯¹è±¡ï¼Œç„¶åå†å°†è¯¥å¯¹è±¡ä¼ ç»™ NettyClient çš„ send æ–¹æ³•ï¼Œè¿›è¡Œåç»­çš„è°ƒç”¨ã€‚éœ€è¦è¯´æ˜çš„æ˜¯ï¼ŒNettyClient ä¸­å¹¶æœªå®ç° send æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ç»§æ‰¿è‡ªçˆ¶ç±» AbstractPeerï¼Œä¸‹é¢ç›´æ¥åˆ†æ AbstractPeer çš„ä»£ç ã€‚\npublic abstract class AbstractPeer implements Endpoint, ChannelHandler &#123;\n    \n    @Override\n    public void send(Object message) throws RemotingException &#123;\n        // è¯¥æ–¹æ³•ç”± AbstractClient ç±»å®ç°\n        send(message, url.getParameter(Constants.SENT_KEY, false));\n    &#125;\n    \n    // çœç•¥å…¶ä»–æ–¹æ³•\n&#125;\n\npublic abstract class AbstractClient extends AbstractEndpoint implements Client &#123;\n    \n    @Override\n    public void send(Object message, boolean sent) throws RemotingException &#123;\n        if (send_reconnect &amp;&amp; !isConnected()) &#123;\n            connect();\n        &#125;\n        \n        // è·å– Channelï¼ŒgetChannel æ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œå…·ä½“ç”±å­ç±»å®ç°\n        Channel channel = getChannel();\n        if (channel == null || !channel.isConnected()) &#123;\n            throw new RemotingException(this, \"message can not send ...\");\n        &#125;\n        \n        // ç»§ç»­å‘ä¸‹è°ƒç”¨\n        channel.send(message, sent);\n    &#125;\n    \n    protected abstract Channel getChannel();\n    \n    // çœç•¥å…¶ä»–æ–¹æ³•\n&#125;\n\né»˜è®¤æƒ…å†µä¸‹ï¼ŒDubbo ä½¿ç”¨ Netty ä½œä¸ºåº•å±‚çš„é€šä¿¡æ¡†æ¶ï¼Œå› æ­¤ä¸‹é¢æˆ‘ä»¬åˆ° NettyClient ç±»ä¸­çœ‹ä¸€ä¸‹ getChannel æ–¹æ³•çš„å®ç°é€»è¾‘ã€‚\npublic class NettyClient extends AbstractClient &#123;\n    \n    // è¿™é‡Œçš„ Channel å…¨é™å®šåç§°ä¸º org.jboss.netty.channel.Channel\n    private volatile Channel channel;\n\n    @Override\n    protected com.alibaba.dubbo.remoting.Channel getChannel() &#123;\n        Channel c = channel;\n        if (c == null || !c.isConnected())\n            return null;\n        // è·å–ä¸€ä¸ª NettyChannel ç±»å‹å¯¹è±¡\n        return NettyChannel.getOrAddChannel(c, getUrl(), this);\n    &#125;\n&#125;\n\nfinal class NettyChannel extends AbstractChannel &#123;\n\n    private static final ConcurrentMap&lt;org.jboss.netty.channel.Channel, NettyChannel> channelMap = \n        new ConcurrentHashMap&lt;org.jboss.netty.channel.Channel, NettyChannel>();\n\n    private final org.jboss.netty.channel.Channel channel;\n    \n    /** ç§æœ‰æ„é€ æ–¹æ³• */\n    private NettyChannel(org.jboss.netty.channel.Channel channel, URL url, ChannelHandler handler) &#123;\n        super(url, handler);\n        if (channel == null) &#123;\n            throw new IllegalArgumentException(\"netty channel == null;\");\n        &#125;\n        this.channel = channel;\n    &#125;\n\n    static NettyChannel getOrAddChannel(org.jboss.netty.channel.Channel ch, URL url, ChannelHandler handler) &#123;\n        if (ch == null) &#123;\n            return null;\n        &#125;\n        \n        // å°è¯•ä»é›†åˆä¸­è·å– NettyChannel å®ä¾‹\n        NettyChannel ret = channelMap.get(ch);\n        if (ret == null) &#123;\n            // å¦‚æœ ret = nullï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„ NettyChannel å®ä¾‹\n            NettyChannel nc = new NettyChannel(ch, url, handler);\n            if (ch.isConnected()) &#123;\n                // å°† &lt;Channel, NettyChannel> é”®å€¼å¯¹å­˜å…¥ channelMap é›†åˆä¸­\n                ret = channelMap.putIfAbsent(ch, nc);\n            &#125;\n            if (ret == null) &#123;\n                ret = nc;\n            &#125;\n        &#125;\n        return ret;\n    &#125;\n&#125;\n\nè·å–åˆ° NettyChannel å®ä¾‹åï¼Œå³å¯è¿›è¡Œåç»­çš„è°ƒç”¨ã€‚ä¸‹é¢çœ‹ä¸€ä¸‹ NettyChannel çš„ send æ–¹æ³•ã€‚\npublic void send(Object message, boolean sent) throws RemotingException &#123;\n    super.send(message, sent);\n\n    boolean success = true;\n    int timeout = 0;\n    try &#123;\n        // å‘é€æ¶ˆæ¯(åŒ…å«è¯·æ±‚å’Œå“åº”æ¶ˆæ¯)\n        ChannelFuture future = channel.write(message);\n        \n        // sent çš„å€¼æºäº &lt;dubbo:method sent=\"true/false\" /> ä¸­ sent çš„é…ç½®å€¼ï¼Œæœ‰ä¸¤ç§é…ç½®å€¼ï¼š\n        //   1. true: ç­‰å¾…æ¶ˆæ¯å‘å‡ºï¼Œæ¶ˆæ¯å‘é€å¤±è´¥å°†æŠ›å‡ºå¼‚å¸¸\n        //   2. false: ä¸ç­‰å¾…æ¶ˆæ¯å‘å‡ºï¼Œå°†æ¶ˆæ¯æ”¾å…¥ IO é˜Ÿåˆ—ï¼Œå³åˆ»è¿”å›\n        // é»˜è®¤æƒ…å†µä¸‹ sent = falseï¼›\n        if (sent) &#123;\n            timeout = getUrl().getPositiveParameter(Constants.TIMEOUT_KEY, Constants.DEFAULT_TIMEOUT);\n            // ç­‰å¾…æ¶ˆæ¯å‘å‡ºï¼Œè‹¥åœ¨è§„å®šæ—¶é—´æ²¡èƒ½å‘å‡ºï¼Œsuccess ä¼šè¢«ç½®ä¸º false\n            success = future.await(timeout);\n        &#125;\n        Throwable cause = future.getCause();\n        if (cause != null) &#123;\n            throw cause;\n        &#125;\n    &#125; catch (Throwable e) &#123;\n        throw new RemotingException(this, \"Failed to send message ...\");\n    &#125;\n\n    // è‹¥ success ä¸º falseï¼Œè¿™é‡ŒæŠ›å‡ºå¼‚å¸¸\n    if (!success) &#123;\n        throw new RemotingException(this, \"Failed to send message ...\");\n    &#125;\n&#125;\n\nç»å†å¤šæ¬¡è°ƒç”¨ï¼Œåˆ°è¿™é‡Œè¯·æ±‚æ•°æ®çš„å‘é€è¿‡ç¨‹å°±ç»“æŸäº†ï¼Œè¿‡ç¨‹æ¼«é•¿ã€‚ä¸ºäº†ä¾¿äºå¤§å®¶é˜…è¯»ä»£ç ï¼Œè¿™é‡Œä»¥ DemoService ä¸ºä¾‹ï¼Œå°† sayHello æ–¹æ³•çš„æ•´ä¸ªè°ƒç”¨è·¯å¾„è´´å‡ºæ¥ã€‚\nproxy0#sayHello(String)\n  â€”&gt; InvokerInvocationHandler#invoke(Object, Method, Object[])\n    â€”&gt; MockClusterInvoker#invoke(Invocation)\n      â€”&gt; AbstractClusterInvoker#invoke(Invocation)\n        â€”&gt; FailoverClusterInvoker#doInvoke(Invocation, List&lt;Invoker&lt;T&gt;&gt;, LoadBalance)\n          â€”&gt; Filter#invoke(Invoker, Invocation)  &#x2F;&#x2F; åŒ…å«å¤šä¸ª Filter è°ƒç”¨\n            â€”&gt; ListenerInvokerWrapper#invoke(Invocation) \n              â€”&gt; AbstractInvoker#invoke(Invocation) \n                â€”&gt; DubboInvoker#doInvoke(Invocation)\n                  â€”&gt; ReferenceCountExchangeClient#request(Object, int)\n                    â€”&gt; HeaderExchangeClient#request(Object, int)\n                      â€”&gt; HeaderExchangeChannel#request(Object, int)\n                        â€”&gt; AbstractPeer#send(Object)\n                          â€”&gt; AbstractClient#send(Object, boolean)\n                            â€”&gt; NettyChannel#send(Object, boolean)\n                              â€”&gt; NioClientSocketChannel#write(Object)\n\nåœ¨ Netty ä¸­ï¼Œå‡ºç«™æ•°æ®åœ¨å‘å‡ºä¹‹å‰è¿˜éœ€è¦è¿›è¡Œç¼–ç æ“ä½œï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹è¯·æ±‚æ•°æ®çš„ç¼–ç é€»è¾‘ã€‚\n\n2.2.2 è¯·æ±‚ç¼–ç åœ¨åˆ†æè¯·æ±‚ç¼–ç é€»è¾‘ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹ Dubbo æ•°æ®åŒ…ç»“æ„ã€‚\n\nDubbo æ•°æ®åŒ…åˆ†ä¸ºæ¶ˆæ¯å¤´å’Œæ¶ˆæ¯ä½“ï¼Œæ¶ˆæ¯å¤´ç”¨äºå­˜å‚¨ä¸€äº›å…ƒä¿¡æ¯ï¼Œæ¯”å¦‚é­”æ•°ï¼ˆMagicï¼‰ï¼Œæ•°æ®åŒ…ç±»å‹ï¼ˆRequest&#x2F;Responseï¼‰ï¼Œæ¶ˆæ¯ä½“é•¿åº¦ï¼ˆData Lengthï¼‰ç­‰ã€‚æ¶ˆæ¯ä½“ä¸­ç”¨äºå­˜å‚¨å…·ä½“çš„è°ƒç”¨æ¶ˆæ¯ï¼Œæ¯”å¦‚æ–¹æ³•åç§°ï¼Œå‚æ•°åˆ—è¡¨ç­‰ã€‚ä¸‹é¢ç®€å•åˆ—ä¸¾ä¸€ä¸‹æ¶ˆæ¯å¤´çš„å†…å®¹ã€‚\n\n\n\nåç§»é‡(Bit)\nå­—æ®µ\nå–å€¼\n\n\n\n0 ~ 7\né­”æ•°é«˜ä½\n0xda00\n\n\n8 ~ 15\né­”æ•°ä½ä½\n0xbb\n\n\n16\næ•°æ®åŒ…ç±»å‹\n0 - Response, 1 - Request\n\n\n17\nè°ƒç”¨æ–¹å¼\nä»…åœ¨ç¬¬16ä½è¢«è®¾ä¸º1çš„æƒ…å†µä¸‹æœ‰æ•ˆï¼Œ0 - å•å‘è°ƒç”¨ï¼Œ1 - åŒå‘è°ƒç”¨\n\n\n18\näº‹ä»¶æ ‡è¯†\n0 - å½“å‰æ•°æ®åŒ…æ˜¯è¯·æ±‚æˆ–å“åº”åŒ…ï¼Œ1 - å½“å‰æ•°æ®åŒ…æ˜¯å¿ƒè·³åŒ…\n\n\n19 ~ 23\nåºåˆ—åŒ–å™¨ç¼–å·\n2 - Hessian2Serialization 3 - JavaSerialization 4 - CompactedJavaSerialization 6 - FastJsonSerialization 7 - NativeJavaSerialization 8 - KryoSerialization 9 - FstSerialization\n\n\n24 ~ 31\nçŠ¶æ€\n20 - OK 30 - CLIENT_TIMEOUT 31 - SERVER_TIMEOUT 40 - BAD_REQUEST 50 - BAD_RESPONSE â€¦â€¦\n\n\n32 ~ 95\nè¯·æ±‚ç¼–å·\nå…±8å­—èŠ‚ï¼Œè¿è¡Œæ—¶ç”Ÿæˆ\n\n\n96 ~ 127\næ¶ˆæ¯ä½“é•¿åº¦\nè¿è¡Œæ—¶è®¡ç®—\n\n\näº†è§£äº† Dubbo æ•°æ®åŒ…æ ¼å¼ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±å¯ä»¥æ¢ç´¢ç¼–ç è¿‡ç¨‹äº†ã€‚è¿™æ¬¡æˆ‘ä»¬å¼€é—¨è§å±±ï¼Œç›´æ¥åˆ†æç¼–ç é€»è¾‘æ‰€åœ¨ç±»ã€‚å¦‚ä¸‹ï¼š\npublic class ExchangeCodec extends TelnetCodec &#123;\n\n    // æ¶ˆæ¯å¤´é•¿åº¦\n    protected static final int HEADER_LENGTH = 16;\n    // é­”æ•°å†…å®¹\n    protected static final short MAGIC = (short) 0xdabb;\n    protected static final byte MAGIC_HIGH = Bytes.short2bytes(MAGIC)[0];\n    protected static final byte MAGIC_LOW = Bytes.short2bytes(MAGIC)[1];\n    protected static final byte FLAG_REQUEST = (byte) 0x80;\n    protected static final byte FLAG_TWOWAY = (byte) 0x40;\n    protected static final byte FLAG_EVENT = (byte) 0x20;\n    protected static final int SERIALIZATION_MASK = 0x1f;\n    private static final Logger logger = LoggerFactory.getLogger(ExchangeCodec.class);\n\n    public Short getMagicCode() &#123;\n        return MAGIC;\n    &#125;\n\n    @Override\n    public void encode(Channel channel, ChannelBuffer buffer, Object msg) throws IOException &#123;\n        if (msg instanceof Request) &#123;\n            // å¯¹ Request å¯¹è±¡è¿›è¡Œç¼–ç \n            encodeRequest(channel, buffer, (Request) msg);\n        &#125; else if (msg instanceof Response) &#123;\n            // å¯¹ Response å¯¹è±¡è¿›è¡Œç¼–ç ï¼Œåé¢åˆ†æ\n            encodeResponse(channel, buffer, (Response) msg);\n        &#125; else &#123;\n            super.encode(channel, buffer, msg);\n        &#125;\n    &#125;\n\n    protected void encodeRequest(Channel channel, ChannelBuffer buffer, Request req) throws IOException &#123;\n        Serialization serialization = getSerialization(channel);\n\n        // åˆ›å»ºæ¶ˆæ¯å¤´å­—èŠ‚æ•°ç»„ï¼Œé•¿åº¦ä¸º 16\n        byte[] header = new byte[HEADER_LENGTH];\n\n        // è®¾ç½®é­”æ•°\n        Bytes.short2bytes(MAGIC, header);\n\n        // è®¾ç½®æ•°æ®åŒ…ç±»å‹ï¼ˆRequest/Responseï¼‰å’Œåºåˆ—åŒ–å™¨ç¼–å·\n        header[2] = (byte) (FLAG_REQUEST | serialization.getContentTypeId());\n\n        // è®¾ç½®é€šä¿¡æ–¹å¼(å•å‘/åŒå‘)\n        if (req.isTwoWay()) &#123;\n            header[2] |= FLAG_TWOWAY;\n        &#125;\n        \n        // è®¾ç½®äº‹ä»¶æ ‡è¯†\n        if (req.isEvent()) &#123;\n            header[2] |= FLAG_EVENT;\n        &#125;\n\n        // è®¾ç½®è¯·æ±‚ç¼–å·ï¼Œ8ä¸ªå­—èŠ‚ï¼Œä»ç¬¬4ä¸ªå­—èŠ‚å¼€å§‹è®¾ç½®\n        Bytes.long2bytes(req.getId(), header, 4);\n\n        // è·å– buffer å½“å‰çš„å†™ä½ç½®\n        int savedWriteIndex = buffer.writerIndex();\n        // æ›´æ–° writerIndexï¼Œä¸ºæ¶ˆæ¯å¤´é¢„ç•™ 16 ä¸ªå­—èŠ‚çš„ç©ºé—´\n        buffer.writerIndex(savedWriteIndex + HEADER_LENGTH);\n        ChannelBufferOutputStream bos = new ChannelBufferOutputStream(buffer);\n        // åˆ›å»ºåºåˆ—åŒ–å™¨ï¼Œæ¯”å¦‚ Hessian2ObjectOutput\n        ObjectOutput out = serialization.serialize(channel.getUrl(), bos);\n        if (req.isEvent()) &#123;\n            // å¯¹äº‹ä»¶æ•°æ®è¿›è¡Œåºåˆ—åŒ–æ“ä½œ\n            encodeEventData(channel, out, req.getData());\n        &#125; else &#123;\n            // å¯¹è¯·æ±‚æ•°æ®è¿›è¡Œåºåˆ—åŒ–æ“ä½œ\n            encodeRequestData(channel, out, req.getData(), req.getVersion());\n        &#125;\n        out.flushBuffer();\n        if (out instanceof Cleanable) &#123;\n            ((Cleanable) out).cleanup();\n        &#125;\n        bos.flush();\n        bos.close();\n        \n        // è·å–å†™å…¥çš„å­—èŠ‚æ•°ï¼Œä¹Ÿå°±æ˜¯æ¶ˆæ¯ä½“é•¿åº¦\n        int len = bos.writtenBytes();\n        checkPayload(channel, len);\n\n        // å°†æ¶ˆæ¯ä½“é•¿åº¦å†™å…¥åˆ°æ¶ˆæ¯å¤´ä¸­\n        Bytes.int2bytes(len, header, 12);\n\n        // å°† buffer æŒ‡é’ˆç§»åŠ¨åˆ° savedWriteIndexï¼Œä¸ºå†™æ¶ˆæ¯å¤´åšå‡†å¤‡\n        buffer.writerIndex(savedWriteIndex);\n        // ä» savedWriteIndex ä¸‹æ ‡å¤„å†™å…¥æ¶ˆæ¯å¤´\n        buffer.writeBytes(header);\n        // è®¾ç½®æ–°çš„ writerIndexï¼ŒwriterIndex = åŸå†™ä¸‹æ ‡ + æ¶ˆæ¯å¤´é•¿åº¦ + æ¶ˆæ¯ä½“é•¿åº¦\n        buffer.writerIndex(savedWriteIndex + HEADER_LENGTH + len);\n    &#125;\n    \n    // çœç•¥å…¶ä»–æ–¹æ³•\n&#125;\n\nä»¥ä¸Šå°±æ˜¯è¯·æ±‚å¯¹è±¡çš„ç¼–ç è¿‡ç¨‹ï¼Œè¯¥è¿‡ç¨‹é¦–å…ˆä¼šé€šè¿‡ä½è¿ç®—å°†æ¶ˆæ¯å¤´å†™å…¥åˆ° header æ•°ç»„ä¸­ã€‚ç„¶åå¯¹ Request å¯¹è±¡çš„ data å­—æ®µæ‰§è¡Œåºåˆ—åŒ–æ“ä½œï¼Œåºåˆ—åŒ–åçš„æ•°æ®æœ€ç»ˆä¼šå­˜å‚¨åˆ° ChannelBuffer ä¸­ã€‚åºåˆ—åŒ–æ“ä½œæ‰§è¡Œå®Œåï¼Œå¯å¾—åˆ°æ•°æ®åºåˆ—åŒ–åçš„é•¿åº¦ lenï¼Œç´§æ¥ç€å°† len å†™å…¥åˆ° header æŒ‡å®šä½ç½®å¤„ã€‚æœ€åå†å°†æ¶ˆæ¯å¤´å­—èŠ‚æ•°ç»„ header å†™å…¥åˆ° ChannelBuffer ä¸­ï¼Œæ•´ä¸ªç¼–ç è¿‡ç¨‹å°±ç»“æŸäº†ã€‚æœ¬èŠ‚çš„æœ€åï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹ Request å¯¹è±¡çš„ data å­—æ®µåºåˆ—åŒ–è¿‡ç¨‹ï¼Œä¹Ÿå°±æ˜¯ encodeRequestData æ–¹æ³•çš„é€»è¾‘ï¼Œå¦‚ä¸‹ï¼š\npublic class DubboCodec extends ExchangeCodec implements Codec2 &#123;\n    \n\tprotected void encodeRequestData(Channel channel, ObjectOutput out, Object data, String version) throws IOException &#123;\n        RpcInvocation inv = (RpcInvocation) data;\n\n        // ä¾æ¬¡åºåˆ—åŒ– dubbo versionã€pathã€version\n        out.writeUTF(version);\n        out.writeUTF(inv.getAttachment(Constants.PATH_KEY));\n        out.writeUTF(inv.getAttachment(Constants.VERSION_KEY));\n\n        // åºåˆ—åŒ–è°ƒç”¨æ–¹æ³•å\n        out.writeUTF(inv.getMethodName());\n        // å°†å‚æ•°ç±»å‹è½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼Œå¹¶è¿›è¡Œåºåˆ—åŒ–\n        out.writeUTF(ReflectUtils.getDesc(inv.getParameterTypes()));\n        Object[] args = inv.getArguments();\n        if (args != null)\n            for (int i = 0; i &lt; args.length; i++) &#123;\n                // å¯¹è¿è¡Œæ—¶å‚æ•°è¿›è¡Œåºåˆ—åŒ–\n                out.writeObject(encodeInvocationArgument(channel, inv, i));\n            &#125;\n        \n        // åºåˆ—åŒ– attachments\n        out.writeObject(inv.getAttachments());\n    &#125;\n&#125;\n\nè‡³æ­¤ï¼Œå…³äºæœåŠ¡æ¶ˆè´¹æ–¹å‘é€è¯·æ±‚çš„è¿‡ç¨‹å°±åˆ†æå®Œäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æœåŠ¡æä¾›æ–¹æ˜¯å¦‚ä½•æ¥æ”¶è¯·æ±‚çš„ã€‚\n\n2.3 æœåŠ¡æä¾›æ–¹æ¥æ”¶è¯·æ±‚å‰é¢è¯´è¿‡ï¼Œé»˜è®¤æƒ…å†µä¸‹ Dubbo ä½¿ç”¨ Netty ä½œä¸ºåº•å±‚çš„é€šä¿¡æ¡†æ¶ã€‚Netty æ£€æµ‹åˆ°æœ‰æ•°æ®å…¥ç«™åï¼Œé¦–å…ˆä¼šé€šè¿‡è§£ç å™¨å¯¹æ•°æ®è¿›è¡Œè§£ç ï¼Œå¹¶å°†è§£ç åçš„æ•°æ®ä¼ é€’ç»™ä¸‹ä¸€ä¸ªå…¥ç«™å¤„ç†å™¨çš„æŒ‡å®šæ–¹æ³•ã€‚æ‰€ä»¥åœ¨è¿›è¡Œåç»­çš„åˆ†æä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹æ•°æ®è§£ç è¿‡ç¨‹ã€‚\n\n2.3.1 è¯·æ±‚è§£ç è¿™é‡Œç›´æ¥åˆ†æè¯·æ±‚æ•°æ®çš„è§£ç é€»è¾‘ï¼Œå¿½ç•¥ä¸­é—´è¿‡ç¨‹ï¼Œå¦‚ä¸‹ï¼š\npublic class ExchangeCodec extends TelnetCodec &#123;\n    \n    @Override\n    public Object decode(Channel channel, ChannelBuffer buffer) throws IOException &#123;\n        int readable = buffer.readableBytes();\n        // åˆ›å»ºæ¶ˆæ¯å¤´å­—èŠ‚æ•°ç»„\n        byte[] header = new byte[Math.min(readable, HEADER_LENGTH)];\n        // è¯»å–æ¶ˆæ¯å¤´æ•°æ®\n        buffer.readBytes(header);\n        // è°ƒç”¨é‡è½½æ–¹æ³•è¿›è¡Œåç»­è§£ç å·¥ä½œ\n        return decode(channel, buffer, readable, header);\n    &#125;\n\n    @Override\n    protected Object decode(Channel channel, ChannelBuffer buffer, int readable, byte[] header) throws IOException &#123;\n        // æ£€æŸ¥é­”æ•°æ˜¯å¦ç›¸ç­‰\n        if (readable > 0 &amp;&amp; header[0] != MAGIC_HIGH\n                || readable > 1 &amp;&amp; header[1] != MAGIC_LOW) &#123;\n            int length = header.length;\n            if (header.length &lt; readable) &#123;\n                header = Bytes.copyOf(header, readable);\n                buffer.readBytes(header, length, readable - length);\n            &#125;\n            for (int i = 1; i &lt; header.length - 1; i++) &#123;\n                if (header[i] == MAGIC_HIGH &amp;&amp; header[i + 1] == MAGIC_LOW) &#123;\n                    buffer.readerIndex(buffer.readerIndex() - header.length + i);\n                    header = Bytes.copyOf(header, i);\n                    break;\n                &#125;\n            &#125;\n            // é€šè¿‡ telnet å‘½ä»¤è¡Œå‘é€çš„æ•°æ®åŒ…ä¸åŒ…å«æ¶ˆæ¯å¤´ï¼Œæ‰€ä»¥è¿™é‡Œ\n            // è°ƒç”¨ TelnetCodec çš„ decode æ–¹æ³•å¯¹æ•°æ®åŒ…è¿›è¡Œè§£ç \n            return super.decode(channel, buffer, readable, header);\n        &#125;\n        \n        // æ£€æµ‹å¯è¯»æ•°æ®é‡æ˜¯å¦å°‘äºæ¶ˆæ¯å¤´é•¿åº¦ï¼Œè‹¥å°äºåˆ™ç«‹å³è¿”å› DecodeResult.NEED_MORE_INPUT\n        if (readable &lt; HEADER_LENGTH) &#123;\n            return DecodeResult.NEED_MORE_INPUT;\n        &#125;\n\n        // ä»æ¶ˆæ¯å¤´ä¸­è·å–æ¶ˆæ¯ä½“é•¿åº¦\n        int len = Bytes.bytes2int(header, 12);\n        // æ£€æµ‹æ¶ˆæ¯ä½“é•¿åº¦æ˜¯å¦è¶…å‡ºé™åˆ¶ï¼Œè¶…å‡ºåˆ™æŠ›å‡ºå¼‚å¸¸\n        checkPayload(channel, len);\n\n        int tt = len + HEADER_LENGTH;\n        // æ£€æµ‹å¯è¯»çš„å­—èŠ‚æ•°æ˜¯å¦å°äºå®é™…çš„å­—èŠ‚æ•°\n        if (readable &lt; tt) &#123;\n            return DecodeResult.NEED_MORE_INPUT;\n        &#125;\n        \n        ChannelBufferInputStream is = new ChannelBufferInputStream(buffer, len);\n\n        try &#123;\n            // ç»§ç»­è¿›è¡Œè§£ç å·¥ä½œ\n            return decodeBody(channel, is, header);\n        &#125; finally &#123;\n            if (is.available() > 0) &#123;\n                try &#123;\n                    StreamUtils.skipUnusedStream(is);\n                &#125; catch (IOException e) &#123;\n                    logger.warn(e.getMessage(), e);\n                &#125;\n            &#125;\n        &#125;\n    &#125;\n&#125;\n\nä¸Šé¢æ–¹æ³•é€šè¿‡æ£€æµ‹æ¶ˆæ¯å¤´ä¸­çš„é­”æ•°æ˜¯å¦ä¸è§„å®šçš„é­”æ•°ç›¸ç­‰ï¼Œæå‰æ‹¦æˆªæ‰éå¸¸è§„æ•°æ®åŒ…ï¼Œæ¯”å¦‚é€šè¿‡ telnet å‘½ä»¤è¡Œå‘å‡ºçš„æ•°æ®åŒ…ã€‚æ¥ç€å†å¯¹æ¶ˆæ¯ä½“é•¿åº¦ï¼Œä»¥åŠå¯è¯»å­—èŠ‚æ•°è¿›è¡Œæ£€æµ‹ã€‚æœ€åè°ƒç”¨ decodeBody æ–¹æ³•è¿›è¡Œåç»­çš„è§£ç å·¥ä½œï¼ŒExchangeCodec ä¸­å®ç°äº† decodeBody æ–¹æ³•ï¼Œä½†å› å…¶å­ç±» DubboCodec è¦†å†™äº†è¯¥æ–¹æ³•ï¼Œæ‰€ä»¥åœ¨è¿è¡Œæ—¶ DubboCodec ä¸­çš„ decodeBody æ–¹æ³•ä¼šè¢«è°ƒç”¨ã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¯¥æ–¹æ³•çš„ä»£ç ã€‚\npublic class DubboCodec extends ExchangeCodec implements Codec2 &#123;\n\n    @Override\n    protected Object decodeBody(Channel channel, InputStream is, byte[] header) throws IOException &#123;\n        // è·å–æ¶ˆæ¯å¤´ä¸­çš„ç¬¬ä¸‰ä¸ªå­—èŠ‚ï¼Œå¹¶é€šè¿‡é€»è¾‘ä¸è¿ç®—å¾—åˆ°åºåˆ—åŒ–å™¨ç¼–å·\n        byte flag = header[2], proto = (byte) (flag &amp; SERIALIZATION_MASK);\n        Serialization s = CodecSupport.getSerialization(channel.getUrl(), proto);\n        // è·å–è°ƒç”¨ç¼–å·\n        long id = Bytes.bytes2long(header, 4);\n        // é€šè¿‡é€»è¾‘ä¸è¿ç®—å¾—åˆ°è°ƒç”¨ç±»å‹ï¼Œ0 - Responseï¼Œ1 - Request\n        if ((flag &amp; FLAG_REQUEST) == 0) &#123;\n            // å¯¹å“åº”ç»“æœè¿›è¡Œè§£ç ï¼Œå¾—åˆ° Response å¯¹è±¡ã€‚è¿™ä¸ªéæœ¬èŠ‚å†…å®¹ï¼Œåé¢å†åˆ†æ\n            // ...\n        &#125; else &#123;\n            // åˆ›å»º Request å¯¹è±¡\n            Request req = new Request(id);\n            req.setVersion(Version.getProtocolVersion());\n            // é€šè¿‡é€»è¾‘ä¸è¿ç®—å¾—åˆ°é€šä¿¡æ–¹å¼ï¼Œå¹¶è®¾ç½®åˆ° Request å¯¹è±¡ä¸­\n            req.setTwoWay((flag &amp; FLAG_TWOWAY) != 0);\n            \n            // é€šè¿‡ä½è¿ç®—æ£€æµ‹æ•°æ®åŒ…æ˜¯å¦ä¸ºäº‹ä»¶ç±»å‹\n            if ((flag &amp; FLAG_EVENT) != 0) &#123;\n                // è®¾ç½®å¿ƒè·³äº‹ä»¶åˆ° Request å¯¹è±¡ä¸­\n                req.setEvent(Request.HEARTBEAT_EVENT);\n            &#125;\n            try &#123;\n                Object data;\n                if (req.isHeartbeat()) &#123;\n                    // å¯¹å¿ƒè·³åŒ…è¿›è¡Œè§£ç ï¼Œè¯¥æ–¹æ³•å·²è¢«æ ‡æ³¨ä¸ºåºŸå¼ƒ\n                    data = decodeHeartbeatData(channel, deserialize(s, channel.getUrl(), is));\n                &#125; else if (req.isEvent()) &#123;\n                    // å¯¹äº‹ä»¶æ•°æ®è¿›è¡Œè§£ç \n                    data = decodeEventData(channel, deserialize(s, channel.getUrl(), is));\n                &#125; else &#123;\n                    DecodeableRpcInvocation inv;\n                    // æ ¹æ® url å‚æ•°åˆ¤æ–­æ˜¯å¦åœ¨ IO çº¿ç¨‹ä¸Šå¯¹æ¶ˆæ¯ä½“è¿›è¡Œè§£ç \n                    if (channel.getUrl().getParameter(\n                            Constants.DECODE_IN_IO_THREAD_KEY,\n                            Constants.DEFAULT_DECODE_IN_IO_THREAD)) &#123;\n                        inv = new DecodeableRpcInvocation(channel, req, is, proto);\n                        // åœ¨å½“å‰çº¿ç¨‹ï¼Œä¹Ÿå°±æ˜¯ IO çº¿ç¨‹ä¸Šè¿›è¡Œåç»­çš„è§£ç å·¥ä½œã€‚æ­¤å·¥ä½œå®Œæˆåï¼Œå¯å°†\n                        // è°ƒç”¨æ–¹æ³•åã€attachmentã€ä»¥åŠè°ƒç”¨å‚æ•°è§£æå‡ºæ¥\n                        inv.decode();\n                    &#125; else &#123;\n                        // ä»…åˆ›å»º DecodeableRpcInvocation å¯¹è±¡ï¼Œä½†ä¸åœ¨å½“å‰çº¿ç¨‹ä¸Šæ‰§è¡Œè§£ç é€»è¾‘\n                        inv = new DecodeableRpcInvocation(channel, req,\n                                new UnsafeByteArrayInputStream(readMessageData(is)), proto);\n                    &#125;\n                    data = inv;\n                &#125;\n                \n                // è®¾ç½® data åˆ° Request å¯¹è±¡ä¸­\n                req.setData(data);\n            &#125; catch (Throwable t) &#123;\n                // è‹¥è§£ç è¿‡ç¨‹ä¸­å‡ºç°å¼‚å¸¸ï¼Œåˆ™å°† broken å­—æ®µè®¾ä¸º trueï¼Œ\n                // å¹¶å°†å¼‚å¸¸å¯¹è±¡è®¾ç½®åˆ° Reqeust å¯¹è±¡ä¸­\n                req.setBroken(true);\n                req.setData(t);\n            &#125;\n            return req;\n        &#125;\n    &#125;\n&#125;\n\nå¦‚ä¸Šï¼ŒdecodeBody å¯¹éƒ¨åˆ†å­—æ®µè¿›è¡Œäº†è§£ç ï¼Œå¹¶å°†è§£ç å¾—åˆ°çš„å­—æ®µå°è£…åˆ° Request ä¸­ã€‚éšåä¼šè°ƒç”¨ DecodeableRpcInvocation çš„ decode æ–¹æ³•è¿›è¡Œåç»­çš„è§£ç å·¥ä½œã€‚æ­¤å·¥ä½œå®Œæˆåï¼Œå¯å°†è°ƒç”¨æ–¹æ³•åã€attachmentã€ä»¥åŠè°ƒç”¨å‚æ•°è§£æå‡ºæ¥ã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ DecodeableRpcInvocation çš„ decode æ–¹æ³•é€»è¾‘ã€‚\npublic class DecodeableRpcInvocation extends RpcInvocation implements Codec, Decodeable &#123;\n    \n\t@Override\n    public Object decode(Channel channel, InputStream input) throws IOException &#123;\n        ObjectInput in = CodecSupport.getSerialization(channel.getUrl(), serializationType)\n                .deserialize(channel.getUrl(), input);\n\n        // é€šè¿‡ååºåˆ—åŒ–å¾—åˆ° dubbo versionï¼Œå¹¶ä¿å­˜åˆ° attachments å˜é‡ä¸­\n        String dubboVersion = in.readUTF();\n        request.setVersion(dubboVersion);\n        setAttachment(Constants.DUBBO_VERSION_KEY, dubboVersion);\n\n        // é€šè¿‡ååºåˆ—åŒ–å¾—åˆ° pathï¼Œversionï¼Œå¹¶ä¿å­˜åˆ° attachments å˜é‡ä¸­\n        setAttachment(Constants.PATH_KEY, in.readUTF());\n        setAttachment(Constants.VERSION_KEY, in.readUTF());\n\n        // é€šè¿‡ååºåˆ—åŒ–å¾—åˆ°è°ƒç”¨æ–¹æ³•å\n        setMethodName(in.readUTF());\n        try &#123;\n            Object[] args;\n            Class&lt;?>[] pts;\n            // é€šè¿‡ååºåˆ—åŒ–å¾—åˆ°å‚æ•°ç±»å‹å­—ç¬¦ä¸²ï¼Œæ¯”å¦‚ Ljava/lang/String;\n            String desc = in.readUTF();\n            if (desc.length() == 0) &#123;\n                pts = DubboCodec.EMPTY_CLASS_ARRAY;\n                args = DubboCodec.EMPTY_OBJECT_ARRAY;\n            &#125; else &#123;\n                // å°† desc è§£æä¸ºå‚æ•°ç±»å‹æ•°ç»„\n                pts = ReflectUtils.desc2classArray(desc);\n                args = new Object[pts.length];\n                for (int i = 0; i &lt; args.length; i++) &#123;\n                    try &#123;\n                        // è§£æè¿è¡Œæ—¶å‚æ•°\n                        args[i] = in.readObject(pts[i]);\n                    &#125; catch (Exception e) &#123;\n                        if (log.isWarnEnabled()) &#123;\n                            log.warn(\"Decode argument failed: \" + e.getMessage(), e);\n                        &#125;\n                    &#125;\n                &#125;\n            &#125;\n            \n            // è®¾ç½®å‚æ•°ç±»å‹æ•°ç»„\n            setParameterTypes(pts);\n\n            // é€šè¿‡ååºåˆ—åŒ–å¾—åˆ°åŸ attachment çš„å†…å®¹\n            Map&lt;String, String> map = (Map&lt;String, String>) in.readObject(Map.class);\n            if (map != null &amp;&amp; map.size() > 0) &#123;\n                Map&lt;String, String> attachment = getAttachments();\n                if (attachment == null) &#123;\n                    attachment = new HashMap&lt;String, String>();\n                &#125;\n                // å°† map ä¸å½“å‰å¯¹è±¡ä¸­çš„ attachment é›†åˆè¿›è¡Œèåˆ\n                attachment.putAll(map);\n                setAttachments(attachment);\n            &#125;\n            \n            // å¯¹ callback ç±»å‹çš„å‚æ•°è¿›è¡Œå¤„ç†\n            for (int i = 0; i &lt; args.length; i++) &#123;\n                args[i] = decodeInvocationArgument(channel, this, pts, i, args[i]);\n            &#125;\n\n            // è®¾ç½®å‚æ•°åˆ—è¡¨\n            setArguments(args);\n\n        &#125; catch (ClassNotFoundException e) &#123;\n            throw new IOException(StringUtils.toString(\"Read invocation data failed.\", e));\n        &#125; finally &#123;\n            if (in instanceof Cleanable) &#123;\n                ((Cleanable) in).cleanup();\n            &#125;\n        &#125;\n        return this;\n    &#125;\n&#125;\n\nä¸Šé¢çš„æ–¹æ³•é€šè¿‡ååºåˆ—åŒ–å°†è¯¸å¦‚ pathã€versionã€è°ƒç”¨æ–¹æ³•åã€å‚æ•°åˆ—è¡¨ç­‰ä¿¡æ¯ä¾æ¬¡è§£æå‡ºæ¥ï¼Œå¹¶è®¾ç½®åˆ°ç›¸åº”çš„å­—æ®µä¸­ï¼Œæœ€ç»ˆå¾—åˆ°ä¸€ä¸ªå…·æœ‰å®Œæ•´è°ƒç”¨ä¿¡æ¯çš„ DecodeableRpcInvocation å¯¹è±¡ã€‚\nåˆ°è¿™é‡Œï¼Œè¯·æ±‚æ•°æ®è§£ç çš„è¿‡ç¨‹å°±åˆ†æå®Œäº†ã€‚æ­¤æ—¶æˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ª Request å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡ä¼šè¢«ä¼ é€åˆ°ä¸‹ä¸€ä¸ªå…¥ç«™å¤„ç†å™¨ä¸­ï¼Œæˆ‘ä»¬ç»§ç»­å¾€ä¸‹çœ‹ã€‚\n\n2.3.2 è°ƒç”¨æœåŠ¡è§£ç å™¨å°†æ•°æ®åŒ…è§£ææˆ Request å¯¹è±¡åï¼ŒNettyHandler çš„ messageReceived æ–¹æ³•ç´§æ¥ç€ä¼šæ”¶åˆ°è¿™ä¸ªå¯¹è±¡ï¼Œå¹¶å°†è¿™ä¸ªå¯¹è±¡ç»§ç»­å‘ä¸‹ä¼ é€’ã€‚è¿™æœŸé—´è¯¥å¯¹è±¡ä¼šè¢«ä¾æ¬¡ä¼ é€’ç»™ NettyServerã€MultiMessageHandlerã€HeartbeatHandler ä»¥åŠ AllChannelHandlerã€‚æœ€åç”± AllChannelHandler å°†è¯¥å¯¹è±¡å°è£…åˆ° Runnable å®ç°ç±»å¯¹è±¡ä¸­ï¼Œå¹¶å°† Runnable æ”¾å…¥çº¿ç¨‹æ± ä¸­æ‰§è¡Œåç»­çš„è°ƒç”¨é€»è¾‘ã€‚æ•´ä¸ªè°ƒç”¨æ ˆå¦‚ä¸‹ï¼š\nNettyHandler#messageReceived(ChannelHandlerContext, MessageEvent)\n  â€”&gt; AbstractPeer#received(Channel, Object)\n    â€”&gt; MultiMessageHandler#received(Channel, Object)\n      â€”&gt; HeartbeatHandler#received(Channel, Object)\n        â€”&gt; AllChannelHandler#received(Channel, Object)\n          â€”&gt; ExecutorService#execute(Runnable)    &#x2F;&#x2F; ç”±çº¿ç¨‹æ± æ‰§è¡Œåç»­çš„è°ƒç”¨é€»è¾‘\n\nè€ƒè™‘åˆ°ç¯‡å¹…ï¼Œä»¥åŠå¾ˆå¤šä¸­é—´è°ƒç”¨çš„é€»è¾‘å¹¶éååˆ†é‡è¦ï¼Œæ‰€ä»¥è¿™é‡Œå°±ä¸å¯¹è°ƒç”¨æ ˆä¸­çš„æ¯ä¸ªæ–¹æ³•éƒ½è¿›è¡Œåˆ†æäº†ã€‚è¿™é‡Œæˆ‘ä»¬ç›´æ¥åˆ†æè°ƒç”¨æ ˆä¸­çš„åˆ†æç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªè°ƒç”¨æ–¹æ³•é€»è¾‘ã€‚å¦‚ä¸‹ï¼š\n@Sharable\npublic class NettyHandler extends SimpleChannelHandler &#123;\n    \n    private final Map&lt;String, Channel> channels = new ConcurrentHashMap&lt;String, Channel>();\n\n    private final URL url;\n\n    private final ChannelHandler handler;\n    \n    public NettyHandler(URL url, ChannelHandler handler) &#123;\n        if (url == null) &#123;\n            throw new IllegalArgumentException(\"url == null\");\n        &#125;\n        if (handler == null) &#123;\n            throw new IllegalArgumentException(\"handler == null\");\n        &#125;\n        this.url = url;\n        \n        // è¿™é‡Œçš„ handler ç±»å‹ä¸º NettyServer\n        this.handler = handler;\n    &#125;\n    \n\tpublic void messageReceived(ChannelHandlerContext ctx, MessageEvent e) throws Exception &#123;\n        // è·å– NettyChannel\n        NettyChannel channel = NettyChannel.getOrAddChannel(ctx.getChannel(), url, handler);\n        try &#123;\n            // ç»§ç»­å‘ä¸‹è°ƒç”¨\n            handler.received(channel, e.getMessage());\n        &#125; finally &#123;\n            NettyChannel.removeChannelIfDisconnected(ctx.getChannel());\n        &#125;\n    &#125;\n&#125;\n\nå¦‚ä¸Šï¼ŒNettyHandler ä¸­çš„ messageReceived é€»è¾‘æ¯”è¾ƒç®€å•ã€‚é¦–å…ˆæ ¹æ®ä¸€äº›ä¿¡æ¯è·å– NettyChannel å®ä¾‹ï¼Œç„¶åå°† NettyChannel å®ä¾‹ä»¥åŠ Request å¯¹è±¡å‘ä¸‹ä¼ é€’ã€‚ä¸‹é¢å†æ¥çœ‹çœ‹ AllChannelHandler çš„é€»è¾‘ï¼Œåœ¨è¯¦ç»†åˆ†æä»£ç ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥äº†è§£ä¸€ä¸‹ Dubbo ä¸­çš„çº¿ç¨‹æ´¾å‘æ¨¡å‹ã€‚\n\n2.3.2.1 çº¿ç¨‹æ´¾å‘æ¨¡å‹Dubbo å°†åº•å±‚é€šä¿¡æ¡†æ¶ä¸­æ¥æ”¶è¯·æ±‚çš„çº¿ç¨‹ç§°ä¸º IO çº¿ç¨‹ã€‚å¦‚æœä¸€äº›äº‹ä»¶å¤„ç†é€»è¾‘å¯ä»¥å¾ˆå¿«æ‰§è¡Œå®Œï¼Œæ¯”å¦‚åªåœ¨å†…å­˜æ‰“ä¸€ä¸ªæ ‡è®°ï¼Œæ­¤æ—¶ç›´æ¥åœ¨ IO çº¿ç¨‹ä¸Šæ‰§è¡Œè¯¥æ®µé€»è¾‘å³å¯ã€‚ä½†å¦‚æœäº‹ä»¶çš„å¤„ç†é€»è¾‘æ¯”è¾ƒè€—æ—¶ï¼Œæ¯”å¦‚è¯¥æ®µé€»è¾‘ä¼šå‘èµ·æ•°æ®åº“æŸ¥è¯¢æˆ–è€… HTTP è¯·æ±‚ã€‚æ­¤æ—¶æˆ‘ä»¬å°±ä¸åº”è¯¥è®©äº‹ä»¶å¤„ç†é€»è¾‘åœ¨ IO çº¿ç¨‹ä¸Šæ‰§è¡Œï¼Œè€Œæ˜¯åº”è¯¥æ´¾å‘åˆ°çº¿ç¨‹æ± ä¸­å»æ‰§è¡Œã€‚åŸå› ä¹Ÿå¾ˆç®€å•ï¼ŒIO çº¿ç¨‹ä¸»è¦ç”¨äºæ¥æ”¶è¯·æ±‚ï¼Œå¦‚æœ IO çº¿ç¨‹è¢«å æ»¡ï¼Œå°†å¯¼è‡´å®ƒä¸èƒ½æ¥æ”¶æ–°çš„è¯·æ±‚ã€‚\nä»¥ä¸Šå°±æ˜¯çº¿ç¨‹æ´¾å‘çš„èƒŒæ™¯ï¼Œä¸‹é¢æˆ‘ä»¬å†æ¥é€šè¿‡ Dubbo è°ƒç”¨å›¾ï¼Œçœ‹ä¸€ä¸‹çº¿ç¨‹æ´¾å‘å™¨æ‰€å¤„çš„ä½ç½®ã€‚\n\nå¦‚ä¸Šå›¾ï¼Œçº¢æ¡†ä¸­çš„ Dispatcher å°±æ˜¯çº¿ç¨‹æ´¾å‘å™¨ã€‚éœ€è¦è¯´æ˜çš„æ˜¯ï¼ŒDispatcher çœŸå®çš„èŒè´£åˆ›å»ºå…·æœ‰çº¿ç¨‹æ´¾å‘èƒ½åŠ›çš„ ChannelHandlerï¼Œæ¯”å¦‚ AllChannelHandlerã€MessageOnlyChannelHandler å’Œ ExecutionChannelHandler ç­‰ï¼Œå…¶æœ¬èº«å¹¶ä¸å…·å¤‡çº¿ç¨‹æ´¾å‘èƒ½åŠ›ã€‚Dubbo æ”¯æŒ 5 ç§ä¸åŒçš„çº¿ç¨‹æ´¾å‘ç­–ç•¥ï¼Œä¸‹é¢é€šè¿‡ä¸€ä¸ªè¡¨æ ¼åˆ—ä¸¾ä¸€ä¸‹ã€‚\n\n\n\nç­–ç•¥\nç”¨é€”\n\n\n\nall\næ‰€æœ‰æ¶ˆæ¯éƒ½æ´¾å‘åˆ°çº¿ç¨‹æ± ï¼ŒåŒ…æ‹¬è¯·æ±‚ï¼Œå“åº”ï¼Œè¿æ¥äº‹ä»¶ï¼Œæ–­å¼€äº‹ä»¶ç­‰\n\n\ndirect\næ‰€æœ‰æ¶ˆæ¯éƒ½ä¸æ´¾å‘åˆ°çº¿ç¨‹æ± ï¼Œå…¨éƒ¨åœ¨ IO çº¿ç¨‹ä¸Šç›´æ¥æ‰§è¡Œ\n\n\nmessage\nåªæœ‰è¯·æ±‚å’Œå“åº”æ¶ˆæ¯æ´¾å‘åˆ°çº¿ç¨‹æ± ï¼Œå…¶å®ƒæ¶ˆæ¯å‡åœ¨ IO çº¿ç¨‹ä¸Šæ‰§è¡Œ\n\n\nexecution\nåªæœ‰è¯·æ±‚æ¶ˆæ¯æ´¾å‘åˆ°çº¿ç¨‹æ± ï¼Œä¸å«å“åº”ã€‚å…¶å®ƒæ¶ˆæ¯å‡åœ¨ IO çº¿ç¨‹ä¸Šæ‰§è¡Œ\n\n\nconnection\nåœ¨ IO çº¿ç¨‹ä¸Šï¼Œå°†è¿æ¥æ–­å¼€äº‹ä»¶æ”¾å…¥é˜Ÿåˆ—ï¼Œæœ‰åºé€ä¸ªæ‰§è¡Œï¼Œå…¶å®ƒæ¶ˆæ¯æ´¾å‘åˆ°çº¿ç¨‹æ± \n\n\né»˜è®¤é…ç½®ä¸‹ï¼ŒDubbo ä½¿ç”¨ all æ´¾å‘ç­–ç•¥ï¼Œå³å°†æ‰€æœ‰çš„æ¶ˆæ¯éƒ½æ´¾å‘åˆ°çº¿ç¨‹æ± ä¸­ã€‚ä¸‹é¢æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹ AllChannelHandler çš„ä»£ç ã€‚\npublic class AllChannelHandler extends WrappedChannelHandler &#123;\n\n    public AllChannelHandler(ChannelHandler handler, URL url) &#123;\n        super(handler, url);\n    &#125;\n\n    /** å¤„ç†è¿æ¥äº‹ä»¶ */\n    @Override\n    public void connected(Channel channel) throws RemotingException &#123;\n        // è·å–çº¿ç¨‹æ± \n        ExecutorService cexecutor = getExecutorService();\n        try &#123;\n            // å°†è¿æ¥äº‹ä»¶æ´¾å‘åˆ°çº¿ç¨‹æ± ä¸­å¤„ç†\n            cexecutor.execute(new ChannelEventRunnable(channel, handler, ChannelState.CONNECTED));\n        &#125; catch (Throwable t) &#123;\n            throw new ExecutionException(..., \" error when process connected event .\", t);\n        &#125;\n    &#125;\n\n    /** å¤„ç†æ–­å¼€äº‹ä»¶ */\n    @Override\n    public void disconnected(Channel channel) throws RemotingException &#123;\n        ExecutorService cexecutor = getExecutorService();\n        try &#123;\n            cexecutor.execute(new ChannelEventRunnable(channel, handler, ChannelState.DISCONNECTED));\n        &#125; catch (Throwable t) &#123;\n            throw new ExecutionException(..., \"error when process disconnected event .\", t);\n        &#125;\n    &#125;\n\n    /** å¤„ç†è¯·æ±‚å’Œå“åº”æ¶ˆæ¯ï¼Œè¿™é‡Œçš„ message å˜é‡ç±»å‹å¯èƒ½æ˜¯ Requestï¼Œä¹Ÿå¯èƒ½æ˜¯ Response */\n    @Override\n    public void received(Channel channel, Object message) throws RemotingException &#123;\n        ExecutorService cexecutor = getExecutorService();\n        try &#123;\n            // å°†è¯·æ±‚å’Œå“åº”æ¶ˆæ¯æ´¾å‘åˆ°çº¿ç¨‹æ± ä¸­å¤„ç†\n            cexecutor.execute(new ChannelEventRunnable(channel, handler, ChannelState.RECEIVED, message));\n        &#125; catch (Throwable t) &#123;\n            if(message instanceof Request &amp;&amp; t instanceof RejectedExecutionException)&#123;\n                Request request = (Request)message;\n                // å¦‚æœé€šä¿¡æ–¹å¼ä¸ºåŒå‘é€šä¿¡ï¼Œæ­¤æ—¶å°† Server side ... threadpool is exhausted \n                // é”™è¯¯ä¿¡æ¯å°è£…åˆ° Response ä¸­ï¼Œå¹¶è¿”å›ç»™æœåŠ¡æ¶ˆè´¹æ–¹ã€‚\n                if(request.isTwoWay())&#123;\n                    String msg = \"Server side(\" + url.getIp() + \",\" + url.getPort() \n                        + \") threadpool is exhausted ,detail msg:\" + t.getMessage();\n                    Response response = new Response(request.getId(), request.getVersion());\n                    response.setStatus(Response.SERVER_THREADPOOL_EXHAUSTED_ERROR);\n                    response.setErrorMessage(msg);\n                    // è¿”å›åŒ…å«é”™è¯¯ä¿¡æ¯çš„ Response å¯¹è±¡\n                    channel.send(response);\n                    return;\n                &#125;\n            &#125;\n            throw new ExecutionException(..., \" error when process received event .\", t);\n        &#125;\n    &#125;\n\n    /** å¤„ç†å¼‚å¸¸ä¿¡æ¯ */\n    @Override\n    public void caught(Channel channel, Throwable exception) throws RemotingException &#123;\n        ExecutorService cexecutor = getExecutorService();\n        try &#123;\n            cexecutor.execute(new ChannelEventRunnable(channel, handler, ChannelState.CAUGHT, exception));\n        &#125; catch (Throwable t) &#123;\n            throw new ExecutionException(..., \"error when process caught event ...\");\n        &#125;\n    &#125;\n&#125;\n\nå¦‚ä¸Šï¼Œè¯·æ±‚å¯¹è±¡ä¼šè¢«å°è£… ChannelEventRunnable ä¸­ï¼ŒChannelEventRunnable å°†ä¼šæ˜¯æœåŠ¡è°ƒç”¨è¿‡ç¨‹çš„æ–°èµ·ç‚¹ã€‚æ‰€ä»¥æ¥ä¸‹æ¥æˆ‘ä»¬ä»¥ ChannelEventRunnable ä¸ºèµ·ç‚¹å‘ä¸‹æ¢ç´¢ã€‚\n\n2.3.2.2 è°ƒç”¨æœåŠ¡æœ¬å°èŠ‚ï¼Œæˆ‘ä»¬ä» ChannelEventRunnable å¼€å§‹åˆ†æï¼Œè¯¥ç±»çš„ä¸»è¦ä»£ç å¦‚ä¸‹ï¼š\npublic class ChannelEventRunnable implements Runnable &#123;\n    \n    private final ChannelHandler handler;\n    private final Channel channel;\n    private final ChannelState state;\n    private final Throwable exception;\n    private final Object message;\n    \n    @Override\n    public void run() &#123;\n        // æ£€æµ‹é€šé“çŠ¶æ€ï¼Œå¯¹äºè¯·æ±‚æˆ–å“åº”æ¶ˆæ¯ï¼Œæ­¤æ—¶ state = RECEIVED\n        if (state == ChannelState.RECEIVED) &#123;\n            try &#123;\n                // å°† channel å’Œ message ä¼ ç»™ ChannelHandler å¯¹è±¡ï¼Œè¿›è¡Œåç»­çš„è°ƒç”¨\n                handler.received(channel, message);\n            &#125; catch (Exception e) &#123;\n                logger.warn(\"... operation error, channel is ... message is ...\");\n            &#125;\n        &#125; \n        \n        // å…¶ä»–æ¶ˆæ¯ç±»å‹é€šè¿‡ switch è¿›è¡Œå¤„ç†\n        else &#123;\n            switch (state) &#123;\n            case CONNECTED:\n                try &#123;\n                    handler.connected(channel);\n                &#125; catch (Exception e) &#123;\n                    logger.warn(\"... operation error, channel is ...\");\n                &#125;\n                break;\n            case DISCONNECTED:\n                // ...\n            case SENT:\n                // ...\n            case CAUGHT:\n                // ...\n            default:\n                logger.warn(\"unknown state: \" + state + \", message is \" + message);\n            &#125;\n        &#125;\n\n    &#125;\n&#125;\n\nå¦‚ä¸Šï¼Œè¯·æ±‚å’Œå“åº”æ¶ˆæ¯å‡ºç°é¢‘ç‡æ˜æ˜¾æ¯”å…¶ä»–ç±»å‹æ¶ˆæ¯é«˜ï¼Œæ‰€ä»¥è¿™é‡Œå¯¹è¯¥ç±»å‹çš„æ¶ˆæ¯è¿›è¡Œäº†é’ˆå¯¹æ€§åˆ¤æ–­ã€‚ChannelEventRunnable ä»…æ˜¯ä¸€ä¸ªä¸­è½¬ç«™ï¼Œå®ƒçš„ run æ–¹æ³•ä¸­å¹¶ä¸åŒ…å«å…·ä½“çš„è°ƒç”¨é€»è¾‘ï¼Œä»…ç”¨äºå°†å‚æ•°ä¼ ç»™å…¶ä»– ChannelHandler å¯¹è±¡è¿›è¡Œå¤„ç†ï¼Œè¯¥å¯¹è±¡ç±»å‹ä¸º DecodeHandlerã€‚\npublic class DecodeHandler extends AbstractChannelHandlerDelegate &#123;\n\n    public DecodeHandler(ChannelHandler handler) &#123;\n        super(handler);\n    &#125;\n\n    @Override\n    public void received(Channel channel, Object message) throws RemotingException &#123;\n        if (message instanceof Decodeable) &#123;\n            // å¯¹ Decodeable æ¥å£å®ç°ç±»å¯¹è±¡è¿›è¡Œè§£ç \n            decode(message);\n        &#125;\n\n        if (message instanceof Request) &#123;\n            // å¯¹ Request çš„ data å­—æ®µè¿›è¡Œè§£ç \n            decode(((Request) message).getData());\n        &#125;\n\n        if (message instanceof Response) &#123;\n            // å¯¹ Request çš„ result å­—æ®µè¿›è¡Œè§£ç \n            decode(((Response) message).getResult());\n        &#125;\n\n        // æ‰§è¡Œåç»­é€»è¾‘\n        handler.received(channel, message);\n    &#125;\n\n    private void decode(Object message) &#123;\n        // Decodeable æ¥å£ç›®å‰æœ‰ä¸¤ä¸ªå®ç°ç±»ï¼Œ\n        // åˆ†åˆ«ä¸º DecodeableRpcInvocation å’Œ DecodeableRpcResult\n        if (message != null &amp;&amp; message instanceof Decodeable) &#123;\n            try &#123;\n                // æ‰§è¡Œè§£ç é€»è¾‘\n                ((Decodeable) message).decode();\n            &#125; catch (Throwable e) &#123;\n                if (log.isWarnEnabled()) &#123;\n                    log.warn(\"Call Decodeable.decode failed: \" + e.getMessage(), e);\n                &#125;\n            &#125;\n        &#125;\n    &#125;\n&#125;\n\nDecodeHandler ä¸»è¦æ˜¯åŒ…å«äº†ä¸€äº›è§£ç é€»è¾‘ã€‚2.2.1 èŠ‚åˆ†æè¯·æ±‚è§£ç æ—¶è¯´è¿‡ï¼Œè¯·æ±‚è§£ç å¯åœ¨ IO çº¿ç¨‹ä¸Šæ‰§è¡Œï¼Œä¹Ÿå¯åœ¨çº¿ç¨‹æ± ä¸­æ‰§è¡Œï¼Œè¿™ä¸ªå–å†³äºè¿è¡Œæ—¶é…ç½®ã€‚DecodeHandler å­˜åœ¨çš„æ„ä¹‰å°±æ˜¯ä¿è¯è¯·æ±‚æˆ–å“åº”å¯¹è±¡å¯åœ¨çº¿ç¨‹æ± ä¸­è¢«è§£ç ã€‚è§£ç å®Œæ¯•åï¼Œå®Œå…¨è§£ç åçš„ Request å¯¹è±¡ä¼šç»§ç»­å‘åä¼ é€’ï¼Œä¸‹ä¸€ç«™æ˜¯ HeaderExchangeHandlerã€‚\npublic class HeaderExchangeHandler implements ChannelHandlerDelegate &#123;\n\n    private final ExchangeHandler handler;\n\n    public HeaderExchangeHandler(ExchangeHandler handler) &#123;\n        if (handler == null) &#123;\n            throw new IllegalArgumentException(\"handler == null\");\n        &#125;\n        this.handler = handler;\n    &#125;\n\n    @Override\n    public void received(Channel channel, Object message) throws RemotingException &#123;\n        channel.setAttribute(KEY_READ_TIMESTAMP, System.currentTimeMillis());\n        ExchangeChannel exchangeChannel = HeaderExchangeChannel.getOrAddChannel(channel);\n        try &#123;\n            // å¤„ç†è¯·æ±‚å¯¹è±¡\n            if (message instanceof Request) &#123;\n                Request request = (Request) message;\n                if (request.isEvent()) &#123;\n                    // å¤„ç†äº‹ä»¶\n                    handlerEvent(channel, request);\n                &#125; \n                // å¤„ç†æ™®é€šçš„è¯·æ±‚\n                else &#123;\n                    // åŒå‘é€šä¿¡\n                    if (request.isTwoWay()) &#123;\n                        // å‘åè°ƒç”¨æœåŠ¡ï¼Œå¹¶å¾—åˆ°è°ƒç”¨ç»“æœ\n                        Response response = handleRequest(exchangeChannel, request);\n                        // å°†è°ƒç”¨ç»“æœè¿”å›ç»™æœåŠ¡æ¶ˆè´¹ç«¯\n                        channel.send(response);\n                    &#125; \n                    // å¦‚æœæ˜¯å•å‘é€šä¿¡ï¼Œä»…å‘åè°ƒç”¨æŒ‡å®šæœåŠ¡å³å¯ï¼Œæ— éœ€è¿”å›è°ƒç”¨ç»“æœ\n                    else &#123;\n                        handler.received(exchangeChannel, request.getData());\n                    &#125;\n                &#125;\n            &#125;      \n            // å¤„ç†å“åº”å¯¹è±¡ï¼ŒæœåŠ¡æ¶ˆè´¹æ–¹ä¼šæ‰§è¡Œæ­¤å¤„é€»è¾‘ï¼Œåé¢åˆ†æ\n            else if (message instanceof Response) &#123;\n                handleResponse(channel, (Response) message);\n            &#125; else if (message instanceof String) &#123;\n                // telnet ç›¸å…³ï¼Œå¿½ç•¥\n            &#125; else &#123;\n                handler.received(exchangeChannel, message);\n            &#125;\n        &#125; finally &#123;\n            HeaderExchangeChannel.removeChannelIfDisconnected(channel);\n        &#125;\n    &#125;\n\n    Response handleRequest(ExchangeChannel channel, Request req) throws RemotingException &#123;\n        Response res = new Response(req.getId(), req.getVersion());\n        // æ£€æµ‹è¯·æ±‚æ˜¯å¦åˆæ³•ï¼Œä¸åˆæ³•åˆ™è¿”å›çŠ¶æ€ç ä¸º BAD_REQUEST çš„å“åº”\n        if (req.isBroken()) &#123;\n            Object data = req.getData();\n\n            String msg;\n            if (data == null)\n                msg = null;\n            else if\n                (data instanceof Throwable) msg = StringUtils.toString((Throwable) data);\n            else\n                msg = data.toString();\n            res.setErrorMessage(\"Fail to decode request due to: \" + msg);\n            // è®¾ç½® BAD_REQUEST çŠ¶æ€\n            res.setStatus(Response.BAD_REQUEST);\n\n            return res;\n        &#125;\n        \n        // è·å– data å­—æ®µå€¼ï¼Œä¹Ÿå°±æ˜¯ RpcInvocation å¯¹è±¡\n        Object msg = req.getData();\n        try &#123;\n            // ç»§ç»­å‘ä¸‹è°ƒç”¨\n            Object result = handler.reply(channel, msg);\n            // è®¾ç½® OK çŠ¶æ€ç \n            res.setStatus(Response.OK);\n            // è®¾ç½®è°ƒç”¨ç»“æœ\n            res.setResult(result);\n        &#125; catch (Throwable e) &#123;\n            // è‹¥è°ƒç”¨è¿‡ç¨‹å‡ºç°å¼‚å¸¸ï¼Œåˆ™è®¾ç½® SERVICE_ERRORï¼Œè¡¨ç¤ºæœåŠ¡ç«¯å¼‚å¸¸\n            res.setStatus(Response.SERVICE_ERROR);\n            res.setErrorMessage(StringUtils.toString(e));\n        &#125;\n        return res;\n    &#125;\n&#125;\n\nåˆ°è¿™é‡Œï¼Œæˆ‘ä»¬çœ‹åˆ°äº†æ¯”è¾ƒæ¸…æ™°çš„è¯·æ±‚å’Œå“åº”é€»è¾‘ã€‚å¯¹äºåŒå‘é€šä¿¡ï¼ŒHeaderExchangeHandler é¦–å…ˆå‘åè¿›è¡Œè°ƒç”¨ï¼Œå¾—åˆ°è°ƒç”¨ç»“æœã€‚ç„¶åå°†è°ƒç”¨ç»“æœå°è£…åˆ° Response å¯¹è±¡ä¸­ï¼Œæœ€åå†å°†è¯¥å¯¹è±¡è¿”å›ç»™æœåŠ¡æ¶ˆè´¹æ–¹ã€‚å¦‚æœè¯·æ±‚ä¸åˆæ³•ï¼Œæˆ–è€…è°ƒç”¨å¤±è´¥ï¼Œåˆ™å°†é”™è¯¯ä¿¡æ¯å°è£…åˆ° Response å¯¹è±¡ä¸­ï¼Œå¹¶è¿”å›ç»™æœåŠ¡æ¶ˆè´¹æ–¹ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ç»§ç»­å‘ååˆ†æï¼ŒæŠŠå‰©ä½™çš„è°ƒç”¨è¿‡ç¨‹åˆ†æå®Œã€‚ä¸‹é¢åˆ†æå®šä¹‰åœ¨ DubboProtocol ç±»ä¸­çš„åŒ¿åç±»å¯¹è±¡é€»è¾‘ï¼Œå¦‚ä¸‹ï¼š\npublic class DubboProtocol extends AbstractProtocol &#123;\n\n    public static final String NAME = \"dubbo\";\n    \n    private ExchangeHandler requestHandler = new ExchangeHandlerAdapter() &#123;\n\n        @Override\n        public Object reply(ExchangeChannel channel, Object message) throws RemotingException &#123;\n            if (message instanceof Invocation) &#123;\n                Invocation inv = (Invocation) message;\n                // è·å– Invoker å®ä¾‹\n                Invoker&lt;?> invoker = getInvoker(channel, inv);\n                if (Boolean.TRUE.toString().equals(inv.getAttachments().get(IS_CALLBACK_SERVICE_INVOKE))) &#123;\n                    // å›è°ƒç›¸å…³ï¼Œå¿½ç•¥\n                &#125;\n                RpcContext.getContext().setRemoteAddress(channel.getRemoteAddress());\n                // é€šè¿‡ Invoker è°ƒç”¨å…·ä½“çš„æœåŠ¡\n                return invoker.invoke(inv);\n            &#125;\n            throw new RemotingException(channel, \"Unsupported request: ...\");\n        &#125;\n        \n        // å¿½ç•¥å…¶ä»–æ–¹æ³•\n    &#125;\n    \n    Invoker&lt;?> getInvoker(Channel channel, Invocation inv) throws RemotingException &#123;\n        // å¿½ç•¥å›è°ƒå’Œæœ¬åœ°å­˜æ ¹ç›¸å…³é€»è¾‘\n        // ...\n        \n        int port = channel.getLocalAddress().getPort();\n        \n        // è®¡ç®— service keyï¼Œæ ¼å¼ä¸º groupName/serviceName:serviceVersion:portã€‚æ¯”å¦‚ï¼š\n        //   dubbo/com.alibaba.dubbo.demo.DemoService:1.0.0:20880\n        String serviceKey = serviceKey(port, path, inv.getAttachments().get(Constants.VERSION_KEY), inv.getAttachments().get(Constants.GROUP_KEY));\n\n        // ä» exporterMap æŸ¥æ‰¾ä¸ serviceKey ç›¸å¯¹åº”çš„ DubboExporter å¯¹è±¡ï¼Œ\n        // æœåŠ¡å¯¼å‡ºè¿‡ç¨‹ä¸­ä¼šå°† &lt;serviceKey, DubboExporter> æ˜ å°„å…³ç³»å­˜å‚¨åˆ° exporterMap é›†åˆä¸­\n        DubboExporter&lt;?> exporter = (DubboExporter&lt;?>) exporterMap.get(serviceKey);\n\n        if (exporter == null)\n            throw new RemotingException(channel, \"Not found exported service ...\");\n\n        // è·å– Invoker å¯¹è±¡ï¼Œå¹¶è¿”å›\n        return exporter.getInvoker();\n    &#125;\n    \n    // å¿½ç•¥å…¶ä»–æ–¹æ³•\n&#125;\n\nä»¥ä¸Šé€»è¾‘ç”¨äºè·å–ä¸æŒ‡å®šæœåŠ¡å¯¹åº”çš„ Invoker å®ä¾‹ï¼Œå¹¶é€šè¿‡ Invoker çš„ invoke æ–¹æ³•è°ƒç”¨æœåŠ¡é€»è¾‘ã€‚invoke æ–¹æ³•å®šä¹‰åœ¨ AbstractProxyInvoker ä¸­ï¼Œä»£ç å¦‚ä¸‹ã€‚\npublic abstract class AbstractProxyInvoker&lt;T> implements Invoker&lt;T> &#123;\n\n    @Override\n    public Result invoke(Invocation invocation) throws RpcException &#123;\n        try &#123;\n            // è°ƒç”¨ doInvoke æ‰§è¡Œåç»­çš„è°ƒç”¨ï¼Œå¹¶å°†è°ƒç”¨ç»“æœå°è£…åˆ° RpcResult ä¸­ï¼Œå¹¶\n            return new RpcResult(doInvoke(proxy, invocation.getMethodName(), invocation.getParameterTypes(), invocation.getArguments()));\n        &#125; catch (InvocationTargetException e) &#123;\n            return new RpcResult(e.getTargetException());\n        &#125; catch (Throwable e) &#123;\n            throw new RpcException(\"Failed to invoke remote proxy method ...\");\n        &#125;\n    &#125;\n    \n    protected abstract Object doInvoke(T proxy, String methodName, Class&lt;?>[] parameterTypes, Object[] arguments) throws Throwable;\n&#125;\n\nå¦‚ä¸Šï¼ŒdoInvoke æ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œè¿™ä¸ªéœ€è¦ç”±å…·ä½“çš„ Invoker å®ä¾‹å®ç°ã€‚Invoker å®ä¾‹æ˜¯åœ¨è¿è¡Œæ—¶é€šè¿‡ JavassistProxyFactory åˆ›å»ºçš„ï¼Œåˆ›å»ºé€»è¾‘å¦‚ä¸‹ï¼š\npublic class JavassistProxyFactory extends AbstractProxyFactory &#123;\n    \n    // çœç•¥å…¶ä»–æ–¹æ³•\n\n    @Override\n    public &lt;T> Invoker&lt;T> getInvoker(T proxy, Class&lt;T> type, URL url) &#123;\n        final Wrapper wrapper = Wrapper.getWrapper(proxy.getClass().getName().indexOf('$') &lt; 0 ? proxy.getClass() : type);\n        // åˆ›å»ºåŒ¿åç±»å¯¹è±¡\n        return new AbstractProxyInvoker&lt;T>(proxy, type, url) &#123;\n            @Override\n            protected Object doInvoke(T proxy, String methodName,\n                                      Class&lt;?>[] parameterTypes,\n                                      Object[] arguments) throws Throwable &#123;\n                // è°ƒç”¨ invokeMethod æ–¹æ³•è¿›è¡Œåç»­çš„è°ƒç”¨\n                return wrapper.invokeMethod(proxy, methodName, parameterTypes, arguments);\n            &#125;\n        &#125;;\n    &#125;\n&#125;\n\nWrapper æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå…¶ä¸­ invokeMethod æ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ã€‚Dubbo ä¼šåœ¨è¿è¡Œæ—¶é€šè¿‡ Javassist æ¡†æ¶ä¸º Wrapper ç”Ÿæˆå®ç°ç±»ï¼Œå¹¶å®ç° invokeMethod æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æœ€ç»ˆä¼šæ ¹æ®è°ƒç”¨ä¿¡æ¯è°ƒç”¨å…·ä½“çš„æœåŠ¡ã€‚ä»¥ DemoServiceImpl ä¸ºä¾‹ï¼ŒJavassist ä¸ºå…¶ç”Ÿæˆçš„ä»£ç†ç±»å¦‚ä¸‹ã€‚\n/** Wrapper0 æ˜¯åœ¨è¿è¡Œæ—¶ç”Ÿæˆçš„ï¼Œå¤§å®¶å¯ä½¿ç”¨ Arthas è¿›è¡Œåç¼–è¯‘ */\npublic class Wrapper0 extends Wrapper implements ClassGenerator.DC &#123;\n    public static String[] pns;\n    public static Map pts;\n    public static String[] mns;\n    public static String[] dmns;\n    public static Class[] mts0;\n\n    // çœç•¥å…¶ä»–æ–¹æ³•\n\n    public Object invokeMethod(Object object, String string, Class[] arrclass, Object[] arrobject) throws InvocationTargetException &#123;\n        DemoService demoService;\n        try &#123;\n            // ç±»å‹è½¬æ¢\n            demoService = (DemoService)object;\n        &#125;\n        catch (Throwable throwable) &#123;\n            throw new IllegalArgumentException(throwable);\n        &#125;\n        try &#123;\n            // æ ¹æ®æ–¹æ³•åè°ƒç”¨æŒ‡å®šçš„æ–¹æ³•\n            if (\"sayHello\".equals(string) &amp;&amp; arrclass.length == 1) &#123;\n                return demoService.sayHello((String)arrobject[0]);\n            &#125;\n        &#125;\n        catch (Throwable throwable) &#123;\n            throw new InvocationTargetException(throwable);\n        &#125;\n        throw new NoSuchMethodException(new StringBuffer().append(\"Not found method \\\"\").append(string).append(\"\\\" in class com.alibaba.dubbo.demo.DemoService.\").toString());\n    &#125;\n&#125;\n\nåˆ°è¿™é‡Œï¼Œæ•´ä¸ªæœåŠ¡è°ƒç”¨è¿‡ç¨‹å°±åˆ†æå®Œäº†ã€‚æœ€åæŠŠè°ƒç”¨è¿‡ç¨‹è´´å‡ºæ¥ï¼Œå¦‚ä¸‹ï¼š\nChannelEventRunnable#run()\n  â€”&gt; DecodeHandler#received(Channel, Object)\n    â€”&gt; HeaderExchangeHandler#received(Channel, Object)\n      â€”&gt; HeaderExchangeHandler#handleRequest(ExchangeChannel, Request)\n        â€”&gt; DubboProtocol.requestHandler#reply(ExchangeChannel, Object)\n          â€”&gt; Filter#invoke(Invoker, Invocation)\n            â€”&gt; AbstractProxyInvoker#invoke(Invocation)\n              â€”&gt; Wrapper0#invokeMethod(Object, String, Class[], Object[])\n                â€”&gt; DemoServiceImpl#sayHello(String)\n\n\n2.4 æœåŠ¡æä¾›æ–¹è¿”å›è°ƒç”¨ç»“æœæœåŠ¡æä¾›æ–¹è°ƒç”¨æŒ‡å®šæœåŠ¡åï¼Œä¼šå°†è°ƒç”¨ç»“æœå°è£…åˆ° Response å¯¹è±¡ä¸­ï¼Œå¹¶å°†è¯¥å¯¹è±¡è¿”å›ç»™æœåŠ¡æ¶ˆè´¹æ–¹ã€‚æœåŠ¡æä¾›æ–¹ä¹Ÿæ˜¯é€šè¿‡ NettyChannel çš„ send æ–¹æ³•å°† Response å¯¹è±¡è¿”å›ï¼Œè¿™ä¸ªæ–¹æ³•åœ¨ 2.2.1 èŠ‚åˆ†æè¿‡ï¼Œè¿™é‡Œå°±ä¸åœ¨é‡å¤åˆ†æäº†ã€‚æœ¬èŠ‚æˆ‘ä»¬ä»…éœ€å…³æ³¨ Response å¯¹è±¡çš„ç¼–ç è¿‡ç¨‹å³å¯ï¼Œè¿™é‡Œä»ç„¶çœç•¥ä¸€äº›ä¸­é—´è°ƒç”¨ï¼Œç›´æ¥åˆ†æå…·ä½“çš„ç¼–ç é€»è¾‘ã€‚\npublic class ExchangeCodec extends TelnetCodec &#123;\n\tpublic void encode(Channel channel, ChannelBuffer buffer, Object msg) throws IOException &#123;\n        if (msg instanceof Request) &#123;\n            encodeRequest(channel, buffer, (Request) msg);\n        &#125; else if (msg instanceof Response) &#123;\n            // å¯¹å“åº”å¯¹è±¡è¿›è¡Œç¼–ç \n            encodeResponse(channel, buffer, (Response) msg);\n        &#125; else &#123;\n            super.encode(channel, buffer, msg);\n        &#125;\n    &#125;\n    \n    protected void encodeResponse(Channel channel, ChannelBuffer buffer, Response res) throws IOException &#123;\n        int savedWriteIndex = buffer.writerIndex();\n        try &#123;\n            Serialization serialization = getSerialization(channel);\n            // åˆ›å»ºæ¶ˆæ¯å¤´å­—èŠ‚æ•°ç»„\n            byte[] header = new byte[HEADER_LENGTH];\n            // è®¾ç½®é­”æ•°\n            Bytes.short2bytes(MAGIC, header);\n            // è®¾ç½®åºåˆ—åŒ–å™¨ç¼–å·\n            header[2] = serialization.getContentTypeId();\n            if (res.isHeartbeat()) header[2] |= FLAG_EVENT;\n            // è·å–å“åº”çŠ¶æ€\n            byte status = res.getStatus();\n            // è®¾ç½®å“åº”çŠ¶æ€\n            header[3] = status;\n            // è®¾ç½®è¯·æ±‚ç¼–å·\n            Bytes.long2bytes(res.getId(), header, 4);\n\n            // æ›´æ–° writerIndexï¼Œä¸ºæ¶ˆæ¯å¤´é¢„ç•™ 16 ä¸ªå­—èŠ‚çš„ç©ºé—´\n            buffer.writerIndex(savedWriteIndex + HEADER_LENGTH);\n            ChannelBufferOutputStream bos = new ChannelBufferOutputStream(buffer);\n            ObjectOutput out = serialization.serialize(channel.getUrl(), bos);\n           \n            if (status == Response.OK) &#123;\n                if (res.isHeartbeat()) &#123;\n                    // å¯¹å¿ƒè·³å“åº”ç»“æœè¿›è¡Œåºåˆ—åŒ–ï¼Œå·²åºŸå¼ƒ\n                    encodeHeartbeatData(channel, out, res.getResult());\n                &#125; else &#123;\n                    // å¯¹è°ƒç”¨ç»“æœè¿›è¡Œåºåˆ—åŒ–\n                    encodeResponseData(channel, out, res.getResult(), res.getVersion());\n                &#125;\n            &#125; else &#123; \n                // å¯¹é”™è¯¯ä¿¡æ¯è¿›è¡Œåºåˆ—åŒ–\n                out.writeUTF(res.getErrorMessage())\n            &#125;;\n            out.flushBuffer();\n            if (out instanceof Cleanable) &#123;\n                ((Cleanable) out).cleanup();\n            &#125;\n            bos.flush();\n            bos.close();\n\n            // è·å–å†™å…¥çš„å­—èŠ‚æ•°ï¼Œä¹Ÿå°±æ˜¯æ¶ˆæ¯ä½“é•¿åº¦\n            int len = bos.writtenBytes();\n            checkPayload(channel, len);\n            \n            // å°†æ¶ˆæ¯ä½“é•¿åº¦å†™å…¥åˆ°æ¶ˆæ¯å¤´ä¸­\n            Bytes.int2bytes(len, header, 12);\n            // å°† buffer æŒ‡é’ˆç§»åŠ¨åˆ° savedWriteIndexï¼Œä¸ºå†™æ¶ˆæ¯å¤´åšå‡†å¤‡\n            buffer.writerIndex(savedWriteIndex);\n            // ä» savedWriteIndex ä¸‹æ ‡å¤„å†™å…¥æ¶ˆæ¯å¤´\n            buffer.writeBytes(header); \n            // è®¾ç½®æ–°çš„ writerIndexï¼ŒwriterIndex = åŸå†™ä¸‹æ ‡ + æ¶ˆæ¯å¤´é•¿åº¦ + æ¶ˆæ¯ä½“é•¿åº¦\n            buffer.writerIndex(savedWriteIndex + HEADER_LENGTH + len);\n        &#125; catch (Throwable t) &#123;\n            // å¼‚å¸¸å¤„ç†é€»è¾‘ä¸æ˜¯å¾ˆéš¾ç†è§£ï¼Œä½†æ˜¯ä»£ç ç•¥å¤šï¼Œè¿™é‡Œå¿½ç•¥äº†\n        &#125;\n    &#125;\n&#125;\n\npublic class DubboCodec extends ExchangeCodec implements Codec2 &#123;\n    \n\tprotected void encodeResponseData(Channel channel, ObjectOutput out, Object data, String version) throws IOException &#123;\n        Result result = (Result) data;\n        // æ£€æµ‹å½“å‰åè®®ç‰ˆæœ¬æ˜¯å¦æ”¯æŒå¸¦æœ‰ attachment é›†åˆçš„ Response å¯¹è±¡\n        boolean attach = Version.isSupportResponseAttachment(version);\n        Throwable th = result.getException();\n        \n        // å¼‚å¸¸ä¿¡æ¯ä¸ºç©º\n        if (th == null) &#123;\n            Object ret = result.getValue();\n            // è°ƒç”¨ç»“æœä¸ºç©º\n            if (ret == null) &#123;\n                // åºåˆ—åŒ–å“åº”ç±»å‹\n                out.writeByte(attach ? RESPONSE_NULL_VALUE_WITH_ATTACHMENTS : RESPONSE_NULL_VALUE);\n            &#125; \n            // è°ƒç”¨ç»“æœéç©º\n            else &#123;\n                // åºåˆ—åŒ–å“åº”ç±»å‹\n                out.writeByte(attach ? RESPONSE_VALUE_WITH_ATTACHMENTS : RESPONSE_VALUE);\n                // åºåˆ—åŒ–è°ƒç”¨ç»“æœ\n                out.writeObject(ret);\n            &#125;\n        &#125; \n        // å¼‚å¸¸ä¿¡æ¯éç©º\n        else &#123;\n            // åºåˆ—åŒ–å“åº”ç±»å‹\n            out.writeByte(attach ? RESPONSE_WITH_EXCEPTION_WITH_ATTACHMENTS : RESPONSE_WITH_EXCEPTION);\n            // åºåˆ—åŒ–å¼‚å¸¸å¯¹è±¡\n            out.writeObject(th);\n        &#125;\n\n        if (attach) &#123;\n            // è®°å½• Dubbo åè®®ç‰ˆæœ¬\n            result.getAttachments().put(Constants.DUBBO_VERSION_KEY, Version.getProtocolVersion());\n            // åºåˆ—åŒ– attachments é›†åˆ\n            out.writeObject(result.getAttachments());\n        &#125;\n    &#125;\n&#125;\n\nä»¥ä¸Šå°±æ˜¯ Response å¯¹è±¡ç¼–ç çš„è¿‡ç¨‹ï¼Œå’Œå‰é¢åˆ†æçš„ Request å¯¹è±¡ç¼–ç è¿‡ç¨‹å¾ˆç›¸ä¼¼ã€‚å¦‚æœå¤§å®¶èƒ½çœ‹ Request å¯¹è±¡çš„ç¼–ç é€»è¾‘ï¼Œé‚£ä¹ˆè¿™é‡Œçš„ Response å¯¹è±¡çš„ç¼–ç é€»è¾‘ä¹Ÿä¸éš¾ç†è§£ï¼Œå°±ä¸å¤šè¯´äº†ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å†æ¥åˆ†æåŒå‘é€šä¿¡çš„æœ€åä¸€ç¯ â€”â€” æœåŠ¡æ¶ˆè´¹æ–¹æ¥æ”¶è°ƒç”¨ç»“æœã€‚\n\n2.5 æœåŠ¡æ¶ˆè´¹æ–¹æ¥æ”¶è°ƒç”¨ç»“æœæœåŠ¡æ¶ˆè´¹æ–¹åœ¨æ”¶åˆ°å“åº”æ•°æ®åï¼Œé¦–å…ˆè¦åšçš„äº‹æƒ…æ˜¯å¯¹å“åº”æ•°æ®è¿›è¡Œè§£ç ï¼Œå¾—åˆ° Response å¯¹è±¡ã€‚ç„¶åå†å°†è¯¥å¯¹è±¡ä¼ é€’ç»™ä¸‹ä¸€ä¸ªå…¥ç«™å¤„ç†å™¨ï¼Œè¿™ä¸ªå…¥ç«™å¤„ç†å™¨å°±æ˜¯ NettyHandlerã€‚æ¥ä¸‹æ¥ NettyHandler ä¼šå°†è¿™ä¸ªå¯¹è±¡ç»§ç»­å‘ä¸‹ä¼ é€’ï¼Œæœ€å AllChannelHandler çš„ received æ–¹æ³•ä¼šæ”¶åˆ°è¿™ä¸ªå¯¹è±¡ï¼Œå¹¶å°†è¿™ä¸ªå¯¹è±¡æ´¾å‘åˆ°çº¿ç¨‹æ± ä¸­ã€‚è¿™ä¸ªè¿‡ç¨‹å’ŒæœåŠ¡æä¾›æ–¹æ¥æ”¶è¯·æ±‚çš„è¿‡ç¨‹æ˜¯ä¸€æ ·çš„ï¼Œå› æ­¤è¿™é‡Œå°±ä¸é‡å¤åˆ†æäº†ã€‚æœ¬èŠ‚æˆ‘ä»¬é‡ç‚¹åˆ†æä¸¤ä¸ªæ–¹é¢çš„å†…å®¹ï¼Œä¸€æ˜¯å“åº”æ•°æ®çš„è§£ç è¿‡ç¨‹ï¼ŒäºŒæ˜¯ Dubbo å¦‚ä½•å°†è°ƒç”¨ç»“æœä¼ é€’ç»™ç”¨æˆ·çº¿ç¨‹çš„ã€‚ä¸‹é¢å…ˆæ¥åˆ†æå“åº”æ•°æ®çš„è§£ç è¿‡ç¨‹ã€‚\n\n2.5.1 å“åº”æ•°æ®è§£ç å“åº”æ•°æ®è§£ç é€»è¾‘ä¸»è¦çš„é€»è¾‘å°è£…åœ¨ DubboCodec ä¸­ï¼Œæˆ‘ä»¬ç›´æ¥åˆ†æè¿™ä¸ªç±»çš„ä»£ç ã€‚å¦‚ä¸‹ï¼š\npublic class DubboCodec extends ExchangeCodec implements Codec2 &#123;\n\n    @Override\n    protected Object decodeBody(Channel channel, InputStream is, byte[] header) throws IOException &#123;\n        byte flag = header[2], proto = (byte) (flag &amp; SERIALIZATION_MASK);\n        Serialization s = CodecSupport.getSerialization(channel.getUrl(), proto);\n        // è·å–è¯·æ±‚ç¼–å·\n        long id = Bytes.bytes2long(header, 4);\n        // æ£€æµ‹æ¶ˆæ¯ç±»å‹ï¼Œè‹¥ä¸‹é¢çš„æ¡ä»¶æˆç«‹ï¼Œè¡¨æ˜æ¶ˆæ¯ç±»å‹ä¸º Response\n        if ((flag &amp; FLAG_REQUEST) == 0) &#123;\n            // åˆ›å»º Response å¯¹è±¡\n            Response res = new Response(id);\n            // æ£€æµ‹äº‹ä»¶æ ‡å¿—ä½\n            if ((flag &amp; FLAG_EVENT) != 0) &#123;\n                // è®¾ç½®å¿ƒè·³äº‹ä»¶\n                res.setEvent(Response.HEARTBEAT_EVENT);\n            &#125;\n            // è·å–å“åº”çŠ¶æ€\n            byte status = header[3];\n            // è®¾ç½®å“åº”çŠ¶æ€\n            res.setStatus(status);\n            \n            // å¦‚æœå“åº”çŠ¶æ€ä¸º OKï¼Œè¡¨æ˜è°ƒç”¨è¿‡ç¨‹æ­£å¸¸\n            if (status == Response.OK) &#123;\n                try &#123;\n                    Object data;\n                    if (res.isHeartbeat()) &#123;\n                        // ååºåˆ—åŒ–å¿ƒè·³æ•°æ®ï¼Œå·²åºŸå¼ƒ\n                        data = decodeHeartbeatData(channel, deserialize(s, channel.getUrl(), is));\n                    &#125; else if (res.isEvent()) &#123;\n                        // ååºåˆ—åŒ–äº‹ä»¶æ•°æ®\n                        data = decodeEventData(channel, deserialize(s, channel.getUrl(), is));\n                    &#125; else &#123;\n                        DecodeableRpcResult result;\n                        // æ ¹æ® url å‚æ•°å†³å®šæ˜¯å¦åœ¨ IO çº¿ç¨‹ä¸Šæ‰§è¡Œè§£ç é€»è¾‘\n                        if (channel.getUrl().getParameter(\n                                Constants.DECODE_IN_IO_THREAD_KEY,\n                                Constants.DEFAULT_DECODE_IN_IO_THREAD)) &#123;\n                            // åˆ›å»º DecodeableRpcResult å¯¹è±¡\n                            result = new DecodeableRpcResult(channel, res, is,\n                                    (Invocation) getRequestData(id), proto);\n                            // è¿›è¡Œåç»­çš„è§£ç å·¥ä½œ\n                            result.decode();\n                        &#125; else &#123;\n                            // åˆ›å»º DecodeableRpcResult å¯¹è±¡\n                            result = new DecodeableRpcResult(channel, res,\n                                    new UnsafeByteArrayInputStream(readMessageData(is)),\n                                    (Invocation) getRequestData(id), proto);\n                        &#125;\n                        data = result;\n                    &#125;\n                    \n                    // è®¾ç½® DecodeableRpcResult å¯¹è±¡åˆ° Response å¯¹è±¡ä¸­\n                    res.setResult(data);\n                &#125; catch (Throwable t) &#123;\n                    // è§£ç è¿‡ç¨‹ä¸­å‡ºç°äº†é”™è¯¯ï¼Œæ­¤æ—¶è®¾ç½® CLIENT_ERROR çŠ¶æ€ç åˆ° Response å¯¹è±¡ä¸­\n                    res.setStatus(Response.CLIENT_ERROR);\n                    res.setErrorMessage(StringUtils.toString(t));\n                &#125;\n            &#125; \n            // å“åº”çŠ¶æ€é OKï¼Œè¡¨æ˜è°ƒç”¨è¿‡ç¨‹å‡ºç°äº†å¼‚å¸¸\n            else &#123;\n                // ååºåˆ—åŒ–å¼‚å¸¸ä¿¡æ¯ï¼Œå¹¶è®¾ç½®åˆ° Response å¯¹è±¡ä¸­\n                res.setErrorMessage(deserialize(s, channel.getUrl(), is).readUTF());\n            &#125;\n            return res;\n        &#125; else &#123;\n            // å¯¹è¯·æ±‚æ•°æ®è¿›è¡Œè§£ç ï¼Œå‰é¢å·²åˆ†æè¿‡ï¼Œæ­¤å¤„å¿½ç•¥\n        &#125;\n    &#125;\n&#125;\n\nä»¥ä¸Šå°±æ˜¯å“åº”æ•°æ®çš„è§£ç è¿‡ç¨‹ï¼Œä¸Šé¢é€»è¾‘çœ‹èµ·æ¥æ˜¯ä¸æ˜¯ä¼¼æ›¾ç›¸è¯†ã€‚å¯¹çš„ï¼Œæˆ‘ä»¬åœ¨å‰é¢ç« èŠ‚åˆ†æè¿‡ DubboCodec çš„ decodeBody æ–¹æ³•ä¸­å…³äºè¯·æ±‚æ•°æ®çš„è§£ç è¿‡ç¨‹ï¼Œè¯¥è¿‡ç¨‹å’Œå“åº”æ•°æ®çš„è§£ç è¿‡ç¨‹å¾ˆç›¸ä¼¼ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬ç»§ç»­åˆ†æè°ƒç”¨ç»“æœçš„ååºåˆ—åŒ–è¿‡ç¨‹ï¼Œå¦‚ä¸‹ï¼š\npublic class DecodeableRpcResult extends RpcResult implements Codec, Decodeable &#123;\n    \n    private Invocation invocation;\n\t\n    @Override\n    public void decode() throws Exception &#123;\n        if (!hasDecoded &amp;&amp; channel != null &amp;&amp; inputStream != null) &#123;\n            try &#123;\n                // æ‰§è¡Œååºåˆ—åŒ–æ“ä½œ\n                decode(channel, inputStream);\n            &#125; catch (Throwable e) &#123;\n                // ååºåˆ—åŒ–å¤±è´¥ï¼Œè®¾ç½® CLIENT_ERROR çŠ¶æ€åˆ° Response å¯¹è±¡ä¸­\n                response.setStatus(Response.CLIENT_ERROR);\n                // è®¾ç½®å¼‚å¸¸ä¿¡æ¯\n                response.setErrorMessage(StringUtils.toString(e));\n            &#125; finally &#123;\n                hasDecoded = true;\n            &#125;\n        &#125;\n    &#125;\n    \n    @Override\n    public Object decode(Channel channel, InputStream input) throws IOException &#123;\n        ObjectInput in = CodecSupport.getSerialization(channel.getUrl(), serializationType)\n                .deserialize(channel.getUrl(), input);\n        \n        // ååºåˆ—åŒ–å“åº”ç±»å‹\n        byte flag = in.readByte();\n        switch (flag) &#123;\n            case DubboCodec.RESPONSE_NULL_VALUE:\n                break;\n            case DubboCodec.RESPONSE_VALUE:\n                // ...\n                break;\n            case DubboCodec.RESPONSE_WITH_EXCEPTION:\n                // ...\n                break;\n                \n            // è¿”å›å€¼ä¸ºç©ºï¼Œä¸”æºå¸¦äº† attachments é›†åˆ\n            case DubboCodec.RESPONSE_NULL_VALUE_WITH_ATTACHMENTS:\n                try &#123;\n                    // ååºåˆ—åŒ– attachments é›†åˆï¼Œå¹¶å­˜å‚¨èµ·æ¥ \n                    setAttachments((Map&lt;String, String>) in.readObject(Map.class));\n                &#125; catch (ClassNotFoundException e) &#123;\n                    throw new IOException(StringUtils.toString(\"Read response data failed.\", e));\n                &#125;\n                break;\n                \n            // è¿”å›å€¼ä¸ä¸ºç©ºï¼Œä¸”æºå¸¦äº† attachments é›†åˆ\n            case DubboCodec.RESPONSE_VALUE_WITH_ATTACHMENTS:\n                try &#123;\n                    // è·å–è¿”å›å€¼ç±»å‹\n                    Type[] returnType = RpcUtils.getReturnTypes(invocation);\n                    // ååºåˆ—åŒ–è°ƒç”¨ç»“æœï¼Œå¹¶ä¿å­˜èµ·æ¥\n                    setValue(returnType == null || returnType.length == 0 ? in.readObject() :\n                            (returnType.length == 1 ? in.readObject((Class&lt;?>) returnType[0])\n                                    : in.readObject((Class&lt;?>) returnType[0], returnType[1])));\n                    // ååºåˆ—åŒ– attachments é›†åˆï¼Œå¹¶å­˜å‚¨èµ·æ¥\n                    setAttachments((Map&lt;String, String>) in.readObject(Map.class));\n                &#125; catch (ClassNotFoundException e) &#123;\n                    throw new IOException(StringUtils.toString(\"Read response data failed.\", e));\n                &#125;\n                break;\n                \n            // å¼‚å¸¸å¯¹è±¡ä¸ä¸ºç©ºï¼Œä¸”æºå¸¦äº† attachments é›†åˆ\n            case DubboCodec.RESPONSE_WITH_EXCEPTION_WITH_ATTACHMENTS:\n                try &#123;\n                    // ååºåˆ—åŒ–å¼‚å¸¸å¯¹è±¡\n                    Object obj = in.readObject();\n                    if (obj instanceof Throwable == false)\n                        throw new IOException(\"Response data error, expect Throwable, but get \" + obj);\n                    // è®¾ç½®å¼‚å¸¸å¯¹è±¡\n                    setException((Throwable) obj);\n                    // ååºåˆ—åŒ– attachments é›†åˆï¼Œå¹¶å­˜å‚¨èµ·æ¥\n                    setAttachments((Map&lt;String, String>) in.readObject(Map.class));\n                &#125; catch (ClassNotFoundException e) &#123;\n                    throw new IOException(StringUtils.toString(\"Read response data failed.\", e));\n                &#125;\n                break;\n            default:\n                throw new IOException(\"Unknown result flag, expect '0' '1' '2', get \" + flag);\n        &#125;\n        if (in instanceof Cleanable) &#123;\n            ((Cleanable) in).cleanup();\n        &#125;\n        return this;\n    &#125;\n&#125;\n\næœ¬ç¯‡æ–‡ç« æ‰€åˆ†æçš„æºç ç‰ˆæœ¬ä¸º 2.6.4ï¼Œè¯¥ç‰ˆæœ¬ä¸‹çš„ Response æ”¯æŒ attachments é›†åˆï¼Œæ‰€ä»¥ä¸Šé¢ä»…å¯¹éƒ¨åˆ† case åˆ†æ”¯è¿›è¡Œäº†æ³¨é‡Šã€‚å…¶ä»– case åˆ†æ”¯çš„é€»è¾‘æ¯”è¢«æ³¨é‡Šåˆ†æ”¯çš„é€»è¾‘æ›´ä¸ºç®€å•ï¼Œè¿™é‡Œå°±å¿½ç•¥äº†ã€‚æˆ‘ä»¬æ‰€ä½¿ç”¨çš„æµ‹è¯•æœåŠ¡æ¥å£ DemoService åŒ…å«äº†ä¸€ä¸ªå…·æœ‰è¿”å›å€¼çš„æ–¹æ³•ï¼Œæ­£å¸¸è°ƒç”¨ä¸‹ï¼Œçº¿ç¨‹ä¼šè¿›å…¥ RESPONSE_VALUE_WITH_ATTACHMENTS åˆ†æ”¯ä¸­ã€‚ç„¶åçº¿ç¨‹ä¼šä» invocation å˜é‡ï¼ˆå¤§å®¶æ¢ç´¢ä¸€ä¸‹ invocation å˜é‡çš„ç”±æ¥ï¼‰ä¸­è·å–è¿”å›å€¼ç±»å‹ï¼Œæ¥ç€å¯¹è°ƒç”¨ç»“æœè¿›è¡Œååºåˆ—åŒ–ï¼Œå¹¶å°†åºåˆ—åŒ–åçš„ç»“æœå­˜å‚¨èµ·æ¥ã€‚æœ€åå¯¹ attachments é›†åˆè¿›è¡Œååºåˆ—åŒ–ï¼Œå¹¶å­˜åˆ°æŒ‡å®šå­—æ®µä¸­ã€‚åˆ°æ­¤ï¼Œå…³äºå“åº”æ•°æ®çš„è§£ç è¿‡ç¨‹å°±åˆ†æå®Œäº†ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å†æ¥æ¢ç´¢ä¸€ä¸‹å“åº”å¯¹è±¡ Response çš„å»å‘ã€‚\n\n2.5.2 å‘ç”¨æˆ·çº¿ç¨‹ä¼ é€’è°ƒç”¨ç»“æœå“åº”æ•°æ®è§£ç å®Œæˆåï¼ŒDubbo ä¼šå°†å“åº”å¯¹è±¡æ´¾å‘åˆ°çº¿ç¨‹æ± ä¸Šã€‚è¦æ³¨æ„çš„æ˜¯ï¼Œçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹å¹¶éç”¨æˆ·çš„è°ƒç”¨çº¿ç¨‹ï¼Œæ‰€ä»¥è¦æƒ³åŠæ³•å°†å“åº”å¯¹è±¡ä»çº¿ç¨‹æ± çº¿ç¨‹ä¼ é€’åˆ°ç”¨æˆ·çº¿ç¨‹ä¸Šã€‚æˆ‘ä»¬åœ¨ 2.1 èŠ‚åˆ†æè¿‡ç”¨æˆ·çº¿ç¨‹åœ¨å‘é€å®Œè¯·æ±‚åçš„åŠ¨ä½œï¼Œå³è°ƒç”¨ DefaultFuture çš„ get æ–¹æ³•ç­‰å¾…å“åº”å¯¹è±¡çš„åˆ°æ¥ã€‚å½“å“åº”å¯¹è±¡åˆ°æ¥åï¼Œç”¨æˆ·çº¿ç¨‹ä¼šè¢«å”¤é†’ï¼Œå¹¶é€šè¿‡è°ƒç”¨ç¼–å·è·å–å±äºè‡ªå·±çš„å“åº”å¯¹è±¡ã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æ•´ä¸ªè¿‡ç¨‹å¯¹åº”çš„ä»£ç ã€‚\npublic class HeaderExchangeHandler implements ChannelHandlerDelegate &#123;\n    \n    @Override\n    public void received(Channel channel, Object message) throws RemotingException &#123;\n        channel.setAttribute(KEY_READ_TIMESTAMP, System.currentTimeMillis());\n        ExchangeChannel exchangeChannel = HeaderExchangeChannel.getOrAddChannel(channel);\n        try &#123;\n            if (message instanceof Request) &#123;\n                // å¤„ç†è¯·æ±‚ï¼Œå‰é¢å·²åˆ†æè¿‡ï¼Œçœç•¥\n            &#125; else if (message instanceof Response) &#123;\n                // å¤„ç†å“åº”\n                handleResponse(channel, (Response) message);\n            &#125; else if (message instanceof String) &#123;\n                // telnet ç›¸å…³ï¼Œå¿½ç•¥\n            &#125; else &#123;\n                handler.received(exchangeChannel, message);\n            &#125;\n        &#125; finally &#123;\n            HeaderExchangeChannel.removeChannelIfDisconnected(channel);\n        &#125;\n    &#125;\n\n    static void handleResponse(Channel channel, Response response) throws RemotingException &#123;\n        if (response != null &amp;&amp; !response.isHeartbeat()) &#123;\n            // ç»§ç»­å‘ä¸‹è°ƒç”¨\n            DefaultFuture.received(channel, response);\n        &#125;\n    &#125;\n&#125;\n\npublic class DefaultFuture implements ResponseFuture &#123;  \n    \n    private final Lock lock = new ReentrantLock();\n    private final Condition done = lock.newCondition();\n    private volatile Response response;\n    \n\tpublic static void received(Channel channel, Response response) &#123;\n        try &#123;\n            // æ ¹æ®è°ƒç”¨ç¼–å·ä» FUTURES é›†åˆä¸­æŸ¥æ‰¾æŒ‡å®šçš„ DefaultFuture å¯¹è±¡\n            DefaultFuture future = FUTURES.remove(response.getId());\n            if (future != null) &#123;\n                // ç»§ç»­å‘ä¸‹è°ƒç”¨\n                future.doReceived(response);\n            &#125; else &#123;\n                logger.warn(\"The timeout response finally returned at ...\");\n            &#125;\n        &#125; finally &#123;\n            CHANNELS.remove(response.getId());\n        &#125;\n    &#125;\n\n\tprivate void doReceived(Response res) &#123;\n        lock.lock();\n        try &#123;\n            // ä¿å­˜å“åº”å¯¹è±¡\n            response = res;\n            if (done != null) &#123;\n                // å”¤é†’ç”¨æˆ·çº¿ç¨‹\n                done.signal();\n            &#125;\n        &#125; finally &#123;\n            lock.unlock();\n        &#125;\n        if (callback != null) &#123;\n            invokeCallback(callback);\n        &#125;\n    &#125;\n&#125;\n\nä»¥ä¸Šé€»è¾‘æ˜¯å°†å“åº”å¯¹è±¡ä¿å­˜åˆ°ç›¸åº”çš„ DefaultFuture å®ä¾‹ä¸­ï¼Œç„¶åå†å”¤é†’ç”¨æˆ·çº¿ç¨‹ï¼Œéšåç”¨æˆ·çº¿ç¨‹å³å¯ä» DefaultFuture å®ä¾‹ä¸­è·å–åˆ°ç›¸åº”ç»“æœã€‚\næœ¬ç¯‡æ–‡ç« åœ¨å¤šä¸ªåœ°æ–¹éƒ½å¼ºè°ƒè¿‡è°ƒç”¨ç¼–å·å¾ˆé‡è¦ï¼Œä½†ä¸€ç›´æ²¡æœ‰è§£é‡ŠåŸå› ï¼Œè¿™é‡Œç®€å•è¯´æ˜ä¸€ä¸‹ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒæœåŠ¡æ¶ˆè´¹æ–¹ä¼šå¹¶å‘è°ƒç”¨å¤šä¸ªæœåŠ¡ï¼Œæ¯ä¸ªç”¨æˆ·çº¿ç¨‹å‘é€è¯·æ±‚åï¼Œä¼šè°ƒç”¨ä¸åŒ DefaultFuture å¯¹è±¡çš„ get æ–¹æ³•è¿›è¡Œç­‰å¾…ã€‚ ä¸€æ®µæ—¶é—´åï¼ŒæœåŠ¡æ¶ˆè´¹æ–¹çš„çº¿ç¨‹æ± ä¼šæ”¶åˆ°å¤šä¸ªå“åº”å¯¹è±¡ã€‚è¿™ä¸ªæ—¶å€™è¦è€ƒè™‘ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚ä½•å°†æ¯ä¸ªå“åº”å¯¹è±¡ä¼ é€’ç»™ç›¸åº”çš„ DefaultFuture å¯¹è±¡ï¼Œä¸”ä¸å‡ºé”™ã€‚ç­”æ¡ˆæ˜¯é€šè¿‡è°ƒç”¨ç¼–å·ã€‚DefaultFuture è¢«åˆ›å»ºæ—¶ï¼Œä¼šè¦æ±‚ä¼ å…¥ä¸€ä¸ª Request å¯¹è±¡ã€‚æ­¤æ—¶ DefaultFuture å¯ä» Request å¯¹è±¡ä¸­è·å–è°ƒç”¨ç¼–å·ï¼Œå¹¶å°† &lt;è°ƒç”¨ç¼–å·, DefaultFuture å¯¹è±¡&gt; æ˜ å°„å…³ç³»å­˜å…¥åˆ°é™æ€ Map ä¸­ï¼Œå³ FUTURESã€‚çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹åœ¨æ”¶åˆ° Response å¯¹è±¡åï¼Œä¼šæ ¹æ® Response å¯¹è±¡ä¸­çš„è°ƒç”¨ç¼–å·åˆ° FUTURES é›†åˆä¸­å–å‡ºç›¸åº”çš„ DefaultFuture å¯¹è±¡ï¼Œç„¶åå†å°† Response å¯¹è±¡è®¾ç½®åˆ° DefaultFuture å¯¹è±¡ä¸­ã€‚æœ€åå†å”¤é†’ç”¨æˆ·çº¿ç¨‹ï¼Œè¿™æ ·ç”¨æˆ·çº¿ç¨‹å³å¯ä» DefaultFuture å¯¹è±¡ä¸­è·å–è°ƒç”¨ç»“æœäº†ã€‚æ•´ä¸ªè¿‡ç¨‹å¤§è‡´å¦‚ä¸‹å›¾ï¼š\n\n\n3. æ€»ç»“æœ¬ç¯‡æ–‡ç« ä¸»è¦å¯¹ Dubbo ä¸­çš„å‡ ç§æœåŠ¡è°ƒç”¨æ–¹å¼ï¼Œä»¥åŠä»åŒå‘é€šä¿¡çš„è§’åº¦å¯¹æ•´ä¸ªé€šä¿¡è¿‡ç¨‹è¿›è¡Œäº†è¯¦ç»†çš„åˆ†æã€‚æŒ‰ç…§é€šä¿¡é¡ºåºï¼Œé€šä¿¡è¿‡ç¨‹åŒ…æ‹¬æœåŠ¡æ¶ˆè´¹æ–¹å‘é€è¯·æ±‚ï¼ŒæœåŠ¡æä¾›æ–¹æ¥æ”¶è¯·æ±‚ï¼ŒæœåŠ¡æä¾›æ–¹è¿”å›å“åº”æ•°æ®ï¼ŒæœåŠ¡æ¶ˆè´¹æ–¹æ¥æ”¶å“åº”æ•°æ®ç­‰è¿‡ç¨‹ã€‚ç†è§£è¿™äº›è¿‡ç¨‹éœ€è¦å¤§å®¶å¯¹ç½‘ç»œç¼–ç¨‹ï¼Œå°¤å…¶æ˜¯ Netty æœ‰ä¸€å®šçš„äº†è§£ã€‚é™äºç¯‡å¹…åŸå› ï¼Œæœ¬ç¯‡æ–‡ç« æ— æ³•å°†æœåŠ¡è°ƒç”¨çš„æ‰€æœ‰å†…å®¹éƒ½ä¸€ä¸€è¿›è¡Œåˆ†æã€‚å¯¹äºæœ¬ç¯‡æ–‡ç« æœªè®²åˆ°æˆ–æœªè¯¦ç»†åˆ†æçš„å†…å®¹ï¼Œæ¯”å¦‚æœåŠ¡é™çº§ã€è¿‡æ»¤å™¨é“¾ã€ä»¥åŠåºåˆ—åŒ–ç­‰ã€‚å¤§å®¶è‹¥æ„Ÿå…´è¶£ï¼Œå¯è‡ªè¡Œè¿›è¡Œåˆ†æã€‚å¹¶å°†åˆ†ææ•´ç†æˆæ–‡ï¼Œåˆ†äº«ç»™ç¤¾åŒºã€‚\næœ¬ç¯‡æ–‡ç« å°±åˆ°è¿™é‡Œäº†ï¼Œæ„Ÿè°¢é˜…è¯»ã€‚\n\n\n\n\n\n\n\n\n\nåŸæ–‡åœ°å€ï¼šhttps://dubbo.apache.org/zh/docsv2.7/dev/source/refer-service/\nä½œè€…ï¼š Dubbo å®˜æ–¹\næœ¬æ–‡ä»‹ç»äº† Dubbo æœåŠ¡å¼•ç”¨çš„è¿‡ç¨‹å’Œå®ç°ç»†èŠ‚\n\næœåŠ¡å¼•ç”¨1. ç®€ä»‹ä¸Šä¸€ç¯‡æ–‡ç« è¯¦ç»†åˆ†æäº†æœåŠ¡å¯¼å‡ºçš„è¿‡ç¨‹ï¼Œæœ¬ç¯‡æ–‡ç« æˆ‘ä»¬è¶çƒ­æ‰“é“ï¼Œç»§ç»­åˆ†ææœåŠ¡å¼•ç”¨è¿‡ç¨‹ã€‚åœ¨ Dubbo ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸¤ç§æ–¹å¼å¼•ç”¨è¿œç¨‹æœåŠ¡ã€‚ç¬¬ä¸€ç§æ˜¯ä½¿ç”¨æœåŠ¡ç›´è¿çš„æ–¹å¼å¼•ç”¨æœåŠ¡ï¼Œç¬¬äºŒç§æ–¹å¼æ˜¯åŸºäºæ³¨å†Œä¸­å¿ƒè¿›è¡Œå¼•ç”¨ã€‚æœåŠ¡ç›´è¿çš„æ–¹å¼ä»…é€‚åˆåœ¨è°ƒè¯•æˆ–æµ‹è¯•æœåŠ¡çš„åœºæ™¯ä¸‹ä½¿ç”¨ï¼Œä¸é€‚åˆåœ¨çº¿ä¸Šç¯å¢ƒä½¿ç”¨ã€‚å› æ­¤ï¼Œæœ¬æ–‡æˆ‘å°†é‡ç‚¹åˆ†æé€šè¿‡æ³¨å†Œä¸­å¿ƒå¼•ç”¨æœåŠ¡çš„è¿‡ç¨‹ã€‚ä»æ³¨å†Œä¸­å¿ƒä¸­è·å–æœåŠ¡é…ç½®åªæ˜¯æœåŠ¡å¼•ç”¨è¿‡ç¨‹ä¸­çš„ä¸€ç¯ï¼Œé™¤æ­¤ä¹‹å¤–ï¼ŒæœåŠ¡æ¶ˆè´¹è€…è¿˜éœ€è¦ç»å† Invoker åˆ›å»ºã€ä»£ç†ç±»åˆ›å»ºç­‰æ­¥éª¤ã€‚è¿™äº›æ­¥éª¤ï¼Œå°†åœ¨åç»­ç« èŠ‚ä¸­ä¸€ä¸€è¿›è¡Œåˆ†æã€‚\n\n2.æœåŠ¡å¼•ç”¨åŸç†Dubbo æœåŠ¡å¼•ç”¨çš„æ—¶æœºæœ‰ä¸¤ä¸ªï¼Œç¬¬ä¸€ä¸ªæ˜¯åœ¨ Spring å®¹å™¨è°ƒç”¨ ReferenceBean çš„ afterPropertiesSet æ–¹æ³•æ—¶å¼•ç”¨æœåŠ¡ï¼Œç¬¬äºŒä¸ªæ˜¯åœ¨ ReferenceBean å¯¹åº”çš„æœåŠ¡è¢«æ³¨å…¥åˆ°å…¶ä»–ç±»ä¸­æ—¶å¼•ç”¨ã€‚è¿™ä¸¤ä¸ªå¼•ç”¨æœåŠ¡çš„æ—¶æœºåŒºåˆ«åœ¨äºï¼Œç¬¬ä¸€ä¸ªæ˜¯é¥¿æ±‰å¼çš„ï¼Œç¬¬äºŒä¸ªæ˜¯æ‡’æ±‰å¼çš„ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒDubbo ä½¿ç”¨æ‡’æ±‰å¼å¼•ç”¨æœåŠ¡ã€‚å¦‚æœéœ€è¦ä½¿ç”¨é¥¿æ±‰å¼ï¼Œå¯é€šè¿‡é…ç½® dubbo:reference çš„ init å±æ€§å¼€å¯ã€‚ä¸‹é¢æˆ‘ä»¬æŒ‰ç…§ Dubbo é»˜è®¤é…ç½®è¿›è¡Œåˆ†æï¼Œæ•´ä¸ªåˆ†æè¿‡ç¨‹ä» ReferenceBean çš„ getObject æ–¹æ³•å¼€å§‹ã€‚å½“æˆ‘ä»¬çš„æœåŠ¡è¢«æ³¨å…¥åˆ°å…¶ä»–ç±»ä¸­æ—¶ï¼ŒSpring ä¼šç¬¬ä¸€æ—¶é—´è°ƒç”¨ getObject æ–¹æ³•ï¼Œå¹¶ç”±è¯¥æ–¹æ³•æ‰§è¡ŒæœåŠ¡å¼•ç”¨é€»è¾‘ã€‚æŒ‰ç…§æƒ¯ä¾‹ï¼Œåœ¨è¿›è¡Œå…·ä½“å·¥ä½œä¹‹å‰ï¼Œéœ€å…ˆè¿›è¡Œé…ç½®æ£€æŸ¥ä¸æ”¶é›†å·¥ä½œã€‚æ¥ç€æ ¹æ®æ”¶é›†åˆ°çš„ä¿¡æ¯å†³å®šæœåŠ¡ç”¨çš„æ–¹å¼ï¼Œæœ‰ä¸‰ç§ï¼Œç¬¬ä¸€ç§æ˜¯å¼•ç”¨æœ¬åœ° (JVM) æœåŠ¡ï¼Œç¬¬äºŒæ˜¯é€šè¿‡ç›´è¿æ–¹å¼å¼•ç”¨è¿œç¨‹æœåŠ¡ï¼Œç¬¬ä¸‰æ˜¯é€šè¿‡æ³¨å†Œä¸­å¿ƒå¼•ç”¨è¿œç¨‹æœåŠ¡ã€‚ä¸ç®¡æ˜¯å“ªç§å¼•ç”¨æ–¹å¼ï¼Œæœ€åéƒ½ä¼šå¾—åˆ°ä¸€ä¸ª Invoker å®ä¾‹ã€‚å¦‚æœæœ‰å¤šä¸ªæ³¨å†Œä¸­å¿ƒï¼Œå¤šä¸ªæœåŠ¡æä¾›è€…ï¼Œè¿™ä¸ªæ—¶å€™ä¼šå¾—åˆ°ä¸€ç»„ Invoker å®ä¾‹ï¼Œæ­¤æ—¶éœ€è¦é€šè¿‡é›†ç¾¤ç®¡ç†ç±» Cluster å°†å¤šä¸ª Invoker åˆå¹¶æˆä¸€ä¸ªå®ä¾‹ã€‚åˆå¹¶åçš„ Invoker å®ä¾‹å·²ç»å…·å¤‡è°ƒç”¨æœ¬åœ°æˆ–è¿œç¨‹æœåŠ¡çš„èƒ½åŠ›äº†ï¼Œä½†å¹¶ä¸èƒ½å°†æ­¤å®ä¾‹æš´éœ²ç»™ç”¨æˆ·ä½¿ç”¨ï¼Œè¿™ä¼šå¯¹ç”¨æˆ·ä¸šåŠ¡ä»£ç é€ æˆä¾µå…¥ã€‚æ­¤æ—¶æ¡†æ¶è¿˜éœ€è¦é€šè¿‡ä»£ç†å·¥å‚ç±» (ProxyFactory) ä¸ºæœåŠ¡æ¥å£ç”Ÿæˆä»£ç†ç±»ï¼Œå¹¶è®©ä»£ç†ç±»å»è°ƒç”¨ Invoker é€»è¾‘ã€‚é¿å…äº† Dubbo æ¡†æ¶ä»£ç å¯¹ä¸šåŠ¡ä»£ç çš„ä¾µå…¥ï¼ŒåŒæ—¶ä¹Ÿè®©æ¡†æ¶æ›´å®¹æ˜“ä½¿ç”¨ã€‚\nä»¥ä¸Šå°±æ˜¯æœåŠ¡å¼•ç”¨çš„å¤§è‡´åŸç†ï¼Œä¸‹é¢æˆ‘ä»¬æ·±å…¥åˆ°ä»£ç ä¸­ï¼Œè¯¦ç»†åˆ†ææœåŠ¡å¼•ç”¨ç»†èŠ‚ã€‚\n\n3.æºç åˆ†ææœåŠ¡å¼•ç”¨çš„å…¥å£æ–¹æ³•ä¸º ReferenceBean çš„ getObject æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å®šä¹‰åœ¨ Spring çš„ FactoryBean æ¥å£ä¸­ï¼ŒReferenceBean å®ç°äº†è¿™ä¸ªæ–¹æ³•ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š\npublic Object getObject() throws Exception &#123;\n    return get();\n&#125;\n\npublic synchronized T get() &#123;\n    if (destroyed) &#123;\n        throw new IllegalStateException(\"Already destroyed!\");\n    &#125;\n    // æ£€æµ‹ ref æ˜¯å¦ä¸ºç©ºï¼Œä¸ºç©ºåˆ™é€šè¿‡ init æ–¹æ³•åˆ›å»º\n    if (ref == null) &#123;\n        // init æ–¹æ³•ä¸»è¦ç”¨äºå¤„ç†é…ç½®ï¼Œä»¥åŠè°ƒç”¨ createProxy ç”Ÿæˆä»£ç†ç±»\n        init();\n    &#125;\n    return ref;\n&#125;\n\nä»¥ä¸Šä¸¤ä¸ªæ–¹æ³•çš„ä»£ç æ¯”è¾ƒç®€çŸ­ï¼Œå¹¶ä¸éš¾ç†è§£ã€‚è¿™é‡Œéœ€è¦ç‰¹åˆ«è¯´æ˜ä¸€ä¸‹ï¼Œå¦‚æœä½ å¯¹ 2.6.4 åŠä»¥ä¸‹ç‰ˆæœ¬çš„ getObject æ–¹æ³•è¿›è¡Œè°ƒè¯•æ—¶ï¼Œä¼šç¢°åˆ°æ¯”è¾ƒå¥‡æ€ªçš„çš„é—®é¢˜ã€‚è¿™é‡Œå‡è®¾ä½ ä½¿ç”¨ IDEAï¼Œä¸”ä¿æŒäº† IDEA çš„é»˜è®¤é…ç½®ã€‚å½“ä½ é¢è°ƒè¯•åˆ° get æ–¹æ³•çš„if (ref == null)æ—¶ï¼Œä½ ä¼šå‘ç° ref ä¸ä¸ºç©ºï¼Œå¯¼è‡´ä½ æ— æ³•è¿›å…¥åˆ° init æ–¹æ³•ä¸­ç»§ç»­è°ƒè¯•ã€‚å¯¼è‡´è¿™ä¸ªç°è±¡çš„åŸå› æ˜¯ Dubbo æ¡†æ¶æœ¬èº«æœ‰ä¸€äº›å°é—®é¢˜ã€‚è¯¥é—®é¢˜å·²ç»åœ¨ pull request #2754 ä¿®å¤äº†æ­¤é—®é¢˜ï¼Œå¹¶è·Ÿéš 2.6.5 ç‰ˆæœ¬å‘å¸ƒäº†ã€‚å¦‚æœä½ æ­£åœ¨å­¦ä¹  2.6.4 åŠä»¥ä¸‹ç‰ˆæœ¬ï¼Œå¯é€šè¿‡ä¿®æ”¹ IDEA é…ç½®è§„é¿è¿™ä¸ªé—®é¢˜ã€‚é¦–å…ˆ IDEA é…ç½®å¼¹çª—ä¸­æœç´¢ toStringï¼Œç„¶åå–æ¶ˆEnable &#39;toString&#39; object viewå‹¾é€‰ã€‚å…·ä½“å¦‚ä¸‹ï¼š\n\n\n3.1 å¤„ç†é…ç½®Dubbo æä¾›äº†ä¸°å¯Œçš„é…ç½®ï¼Œç”¨äºè°ƒæ•´å’Œä¼˜åŒ–æ¡†æ¶è¡Œä¸ºï¼Œæ€§èƒ½ç­‰ã€‚Dubbo åœ¨å¼•ç”¨æˆ–å¯¼å‡ºæœåŠ¡æ—¶ï¼Œé¦–å…ˆä¼šå¯¹è¿™äº›é…ç½®è¿›è¡Œæ£€æŸ¥å’Œå¤„ç†ï¼Œä»¥ä¿è¯é…ç½®çš„æ­£ç¡®æ€§ã€‚é…ç½®è§£æé€»è¾‘å°è£…åœ¨ ReferenceConfig çš„ init æ–¹æ³•ä¸­ï¼Œä¸‹é¢è¿›è¡Œåˆ†æã€‚\nprivate void init() &#123;\n    // é¿å…é‡å¤åˆå§‹åŒ–\n    if (initialized) &#123;\n        return;\n    &#125;\n    initialized = true;\n    // æ£€æµ‹æ¥å£ååˆæ³•æ€§\n    if (interfaceName == null || interfaceName.length() == 0) &#123;\n        throw new IllegalStateException(\"interface not allow null!\");\n    &#125;\n\n    // æ£€æµ‹ consumer å˜é‡æ˜¯å¦ä¸ºç©ºï¼Œä¸ºç©ºåˆ™åˆ›å»º\n    checkDefault();\n    appendProperties(this);\n    if (getGeneric() == null &amp;&amp; getConsumer() != null) &#123;\n        // è®¾ç½® generic\n        setGeneric(getConsumer().getGeneric());\n    &#125;\n\n    // æ£€æµ‹æ˜¯å¦ä¸ºæ³›åŒ–æ¥å£\n    if (ProtocolUtils.isGeneric(getGeneric())) &#123;\n        interfaceClass = GenericService.class;\n    &#125; else &#123;\n        try &#123;\n            // åŠ è½½ç±»\n            interfaceClass = Class.forName(interfaceName, true, Thread.currentThread()\n                    .getContextClassLoader());\n        &#125; catch (ClassNotFoundException e) &#123;\n            throw new IllegalStateException(e.getMessage(), e);\n        &#125;\n        checkInterfaceAndMethods(interfaceClass, methods);\n    &#125;\n    \n    // -------------------------------âœ¨ åˆ†å‰²çº¿1 âœ¨------------------------------\n\n    // ä»ç³»ç»Ÿå˜é‡ä¸­è·å–ä¸æ¥å£åå¯¹åº”çš„å±æ€§å€¼\n    String resolve = System.getProperty(interfaceName);\n    String resolveFile = null;\n    if (resolve == null || resolve.length() == 0) &#123;\n        // ä»ç³»ç»Ÿå±æ€§ä¸­è·å–è§£ææ–‡ä»¶è·¯å¾„\n        resolveFile = System.getProperty(\"dubbo.resolve.file\");\n        if (resolveFile == null || resolveFile.length() == 0) &#123;\n            // ä»æŒ‡å®šä½ç½®åŠ è½½é…ç½®æ–‡ä»¶\n            File userResolveFile = new File(new File(System.getProperty(\"user.home\")), \"dubbo-resolve.properties\");\n            if (userResolveFile.exists()) &#123;\n                // è·å–æ–‡ä»¶ç»å¯¹è·¯å¾„\n                resolveFile = userResolveFile.getAbsolutePath();\n            &#125;\n        &#125;\n        if (resolveFile != null &amp;&amp; resolveFile.length() > 0) &#123;\n            Properties properties = new Properties();\n            FileInputStream fis = null;\n            try &#123;\n                fis = new FileInputStream(new File(resolveFile));\n                // ä»æ–‡ä»¶ä¸­åŠ è½½é…ç½®\n                properties.load(fis);\n            &#125; catch (IOException e) &#123;\n                throw new IllegalStateException(\"Unload ..., cause:...\");\n            &#125; finally &#123;\n                try &#123;\n                    if (null != fis) fis.close();\n                &#125; catch (IOException e) &#123;\n                    logger.warn(e.getMessage(), e);\n                &#125;\n            &#125;\n            // è·å–ä¸æ¥å£åå¯¹åº”çš„é…ç½®\n            resolve = properties.getProperty(interfaceName);\n        &#125;\n    &#125;\n    if (resolve != null &amp;&amp; resolve.length() > 0) &#123;\n        // å°† resolve èµ‹å€¼ç»™ url\n        url = resolve;\n    &#125;\n    \n    // -------------------------------âœ¨ åˆ†å‰²çº¿2 âœ¨------------------------------\n    if (consumer != null) &#123;\n        if (application == null) &#123;\n            // ä» consumer ä¸­è·å– Application å®ä¾‹ï¼Œä¸‹åŒ\n            application = consumer.getApplication();\n        &#125;\n        if (module == null) &#123;\n            module = consumer.getModule();\n        &#125;\n        if (registries == null) &#123;\n            registries = consumer.getRegistries();\n        &#125;\n        if (monitor == null) &#123;\n            monitor = consumer.getMonitor();\n        &#125;\n    &#125;\n    if (module != null) &#123;\n        if (registries == null) &#123;\n            registries = module.getRegistries();\n        &#125;\n        if (monitor == null) &#123;\n            monitor = module.getMonitor();\n        &#125;\n    &#125;\n    if (application != null) &#123;\n        if (registries == null) &#123;\n            registries = application.getRegistries();\n        &#125;\n        if (monitor == null) &#123;\n            monitor = application.getMonitor();\n        &#125;\n    &#125;\n    \n    // æ£€æµ‹ Application åˆæ³•æ€§\n    checkApplication();\n    // æ£€æµ‹æœ¬åœ°å­˜æ ¹é…ç½®åˆæ³•æ€§\n    checkStubAndMock(interfaceClass);\n    \n\t// -------------------------------âœ¨ åˆ†å‰²çº¿3 âœ¨------------------------------\n    \n    Map&lt;String, String> map = new HashMap&lt;String, String>();\n    Map&lt;Object, Object> attributes = new HashMap&lt;Object, Object>();\n\n    // æ·»åŠ  sideã€åè®®ç‰ˆæœ¬ä¿¡æ¯ã€æ—¶é—´æˆ³å’Œè¿›ç¨‹å·ç­‰ä¿¡æ¯åˆ° map ä¸­\n    map.put(Constants.SIDE_KEY, Constants.CONSUMER_SIDE);\n    map.put(Constants.DUBBO_VERSION_KEY, Version.getProtocolVersion());\n    map.put(Constants.TIMESTAMP_KEY, String.valueOf(System.currentTimeMillis()));\n    if (ConfigUtils.getPid() > 0) &#123;\n        map.put(Constants.PID_KEY, String.valueOf(ConfigUtils.getPid()));\n    &#125;\n\n    // éæ³›åŒ–æœåŠ¡\n    if (!isGeneric()) &#123;\n        // è·å–ç‰ˆæœ¬\n        String revision = Version.getVersion(interfaceClass, version);\n        if (revision != null &amp;&amp; revision.length() > 0) &#123;\n            map.put(\"revision\", revision);\n        &#125;\n\n        // è·å–æ¥å£æ–¹æ³•åˆ—è¡¨ï¼Œå¹¶æ·»åŠ åˆ° map ä¸­\n        String[] methods = Wrapper.getWrapper(interfaceClass).getMethodNames();\n        if (methods.length == 0) &#123;\n            map.put(\"methods\", Constants.ANY_VALUE);\n        &#125; else &#123;\n            map.put(\"methods\", StringUtils.join(new HashSet&lt;String>(Arrays.asList(methods)), \",\"));\n        &#125;\n    &#125;\n    map.put(Constants.INTERFACE_KEY, interfaceName);\n    // å°† ApplicationConfigã€ConsumerConfigã€ReferenceConfig ç­‰å¯¹è±¡çš„å­—æ®µä¿¡æ¯æ·»åŠ åˆ° map ä¸­\n    appendParameters(map, application);\n    appendParameters(map, module);\n    appendParameters(map, consumer, Constants.DEFAULT_KEY);\n    appendParameters(map, this);\n    \n\t// -------------------------------âœ¨ åˆ†å‰²çº¿4 âœ¨------------------------------\n    \n    String prefix = StringUtils.getServiceKey(map);\n    if (methods != null &amp;&amp; !methods.isEmpty()) &#123;\n        // éå† MethodConfig åˆ—è¡¨\n        for (MethodConfig method : methods) &#123;\n            appendParameters(map, method, method.getName());\n            String retryKey = method.getName() + \".retry\";\n            // æ£€æµ‹ map æ˜¯å¦åŒ…å« methodName.retry\n            if (map.containsKey(retryKey)) &#123;\n                String retryValue = map.remove(retryKey);\n                if (\"false\".equals(retryValue)) &#123;\n                    // æ·»åŠ é‡è¯•æ¬¡æ•°é…ç½® methodName.retries\n                    map.put(method.getName() + \".retries\", \"0\");\n                &#125;\n            &#125;\n \n            // æ·»åŠ  MethodConfig ä¸­çš„â€œå±æ€§â€å­—æ®µåˆ° attributes\n            // æ¯”å¦‚ onreturnã€onthrowã€oninvoke ç­‰\n            appendAttributes(attributes, method, prefix + \".\" + method.getName());\n            checkAndConvertImplicitConfig(method, map, attributes);\n        &#125;\n    &#125;\n    \n\t// -------------------------------âœ¨ åˆ†å‰²çº¿5 âœ¨------------------------------\n\n    // è·å–æœåŠ¡æ¶ˆè´¹è€… ip åœ°å€\n    String hostToRegistry = ConfigUtils.getSystemProperty(Constants.DUBBO_IP_TO_REGISTRY);\n    if (hostToRegistry == null || hostToRegistry.length() == 0) &#123;\n        hostToRegistry = NetUtils.getLocalHost();\n    &#125; else if (isInvalidLocalHost(hostToRegistry)) &#123;\n        throw new IllegalArgumentException(\"Specified invalid registry ip from property...\" );\n    &#125;\n    map.put(Constants.REGISTER_IP_KEY, hostToRegistry);\n\n    // å­˜å‚¨ attributes åˆ°ç³»ç»Ÿä¸Šä¸‹æ–‡ä¸­\n    StaticContext.getSystemContext().putAll(attributes);\n\n    // åˆ›å»ºä»£ç†ç±»\n    ref = createProxy(map);\n\n    // æ ¹æ®æœåŠ¡åï¼ŒReferenceConfigï¼Œä»£ç†ç±»æ„å»º ConsumerModelï¼Œ\n    // å¹¶å°† ConsumerModel å­˜å…¥åˆ° ApplicationModel ä¸­\n    ConsumerModel consumerModel = new ConsumerModel(getUniqueServiceName(), this, ref, interfaceClass.getMethods());\n    ApplicationModel.initConsumerModel(getUniqueServiceName(), consumerModel);\n&#125;\n\n\nä¸Šé¢çš„ä»£ç å¾ˆé•¿ï¼Œåšçš„äº‹æƒ…æ¯”è¾ƒå¤šã€‚è¿™é‡Œæ ¹æ®ä»£ç é€»è¾‘ï¼Œå¯¹ä»£ç è¿›è¡Œäº†åˆ†å—ï¼Œä¸‹é¢æˆ‘ä»¬ä¸€èµ·æ¥çœ‹ä¸€ä¸‹ã€‚\né¦–å…ˆæ˜¯æ–¹æ³•å¼€å§‹åˆ°åˆ†å‰²çº¿1ä¹‹é—´çš„ä»£ç ã€‚è¿™æ®µä»£ç ä¸»è¦ç”¨äºæ£€æµ‹ ConsumerConfig å®ä¾‹æ˜¯å¦å­˜åœ¨ï¼Œå¦‚ä¸å­˜åœ¨åˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„å®ä¾‹ï¼Œç„¶åé€šè¿‡ç³»ç»Ÿå˜é‡æˆ– dubbo.properties é…ç½®æ–‡ä»¶å¡«å…… ConsumerConfig çš„å­—æ®µã€‚æ¥ç€æ˜¯æ£€æµ‹æ³›åŒ–é…ç½®ï¼Œå¹¶æ ¹æ®é…ç½®è®¾ç½® interfaceClass çš„å€¼ã€‚æ¥ç€æ¥çœ‹åˆ†å‰²çº¿1åˆ°åˆ†å‰²çº¿2ä¹‹é—´çš„é€»è¾‘ã€‚è¿™æ®µé€»è¾‘ç”¨äºä»ç³»ç»Ÿå±æ€§æˆ–é…ç½®æ–‡ä»¶ä¸­åŠ è½½ä¸æ¥å£åç›¸å¯¹åº”çš„é…ç½®ï¼Œå¹¶å°†è§£æç»“æœèµ‹å€¼ç»™ url å­—æ®µã€‚url å­—æ®µçš„ä½œç”¨ä¸€èˆ¬æ˜¯ç”¨äºç‚¹å¯¹ç‚¹è°ƒç”¨ã€‚ç»§ç»­å‘ä¸‹çœ‹ï¼Œåˆ†å‰²çº¿2å’Œåˆ†å‰²çº¿3ä¹‹é—´çš„ä»£ç ç”¨äºæ£€æµ‹å‡ ä¸ªæ ¸å¿ƒé…ç½®ç±»æ˜¯å¦ä¸ºç©ºï¼Œä¸ºç©ºåˆ™å°è¯•ä»å…¶ä»–é…ç½®ç±»ä¸­è·å–ã€‚åˆ†å‰²çº¿3ä¸åˆ†å‰²çº¿4ä¹‹é—´çš„ä»£ç ä¸»è¦ç”¨äºæ”¶é›†å„ç§é…ç½®ï¼Œå¹¶å°†é…ç½®å­˜å‚¨åˆ° map ä¸­ã€‚åˆ†å‰²çº¿4å’Œåˆ†å‰²çº¿5ä¹‹é—´çš„ä»£ç ç”¨äºå¤„ç† MethodConfig å®ä¾‹ã€‚è¯¥å®ä¾‹åŒ…å«äº†äº‹ä»¶é€šçŸ¥é…ç½®ï¼Œæ¯”å¦‚ onreturnã€onthrowã€oninvoke ç­‰ã€‚åˆ†å‰²çº¿5åˆ°æ–¹æ³•ç»“å°¾çš„ä»£ç ä¸»è¦ç”¨äºè§£ææœåŠ¡æ¶ˆè´¹è€… ipï¼Œä»¥åŠè°ƒç”¨ createProxy åˆ›å»ºä»£ç†å¯¹è±¡ã€‚å…³äºè¯¥æ–¹æ³•çš„è¯¦ç»†åˆ†æï¼Œå°†ä¼šåœ¨æ¥ä¸‹æ¥çš„ç« èŠ‚ä¸­å±•å¼€ã€‚\n\n3.2 å¼•ç”¨æœåŠ¡æœ¬èŠ‚æˆ‘ä»¬è¦ä» createProxy å¼€å§‹çœ‹èµ·ã€‚ä»å­—é¢æ„æ€ä¸Šæ¥çœ‹ï¼ŒcreateProxy ä¼¼ä¹åªæ˜¯ç”¨äºåˆ›å»ºä»£ç†å¯¹è±¡çš„ã€‚ä½†å®é™…ä¸Šå¹¶éå¦‚æ­¤ï¼Œè¯¥æ–¹æ³•è¿˜ä¼šè°ƒç”¨å…¶ä»–æ–¹æ³•æ„å»ºä»¥åŠåˆå¹¶ Invoker å®ä¾‹ã€‚å…·ä½“ç»†èŠ‚å¦‚ä¸‹ã€‚\nprivate T createProxy(Map&lt;String, String> map) &#123;\n    URL tmpUrl = new URL(\"temp\", \"localhost\", 0, map);\n    final boolean isJvmRefer;\n    if (isInjvm() == null) &#123;\n        // url é…ç½®è¢«æŒ‡å®šï¼Œåˆ™ä¸åšæœ¬åœ°å¼•ç”¨\n        if (url != null &amp;&amp; url.length() > 0) &#123;\n            isJvmRefer = false;\n        // æ ¹æ® url çš„åè®®ã€scope ä»¥åŠ injvm ç­‰å‚æ•°æ£€æµ‹æ˜¯å¦éœ€è¦æœ¬åœ°å¼•ç”¨\n        // æ¯”å¦‚å¦‚æœç”¨æˆ·æ˜¾å¼é…ç½®äº† scope=localï¼Œæ­¤æ—¶ isInjvmRefer è¿”å› true\n        &#125; else if (InjvmProtocol.getInjvmProtocol().isInjvmRefer(tmpUrl)) &#123;\n            isJvmRefer = true;\n        &#125; else &#123;\n            isJvmRefer = false;\n        &#125;\n    &#125; else &#123;\n        // è·å– injvm é…ç½®å€¼\n        isJvmRefer = isInjvm().booleanValue();\n    &#125;\n\n    // æœ¬åœ°å¼•ç”¨\n    if (isJvmRefer) &#123;\n        // ç”Ÿæˆæœ¬åœ°å¼•ç”¨ URLï¼Œåè®®ä¸º injvm\n        URL url = new URL(Constants.LOCAL_PROTOCOL, NetUtils.LOCALHOST, 0, interfaceClass.getName()).addParameters(map);\n        // è°ƒç”¨ refer æ–¹æ³•æ„å»º InjvmInvoker å®ä¾‹\n        invoker = refprotocol.refer(interfaceClass, url);\n        \n    // è¿œç¨‹å¼•ç”¨\n    &#125; else &#123;\n        // url ä¸ä¸ºç©ºï¼Œè¡¨æ˜ç”¨æˆ·å¯èƒ½æƒ³è¿›è¡Œç‚¹å¯¹ç‚¹è°ƒç”¨\n        if (url != null &amp;&amp; url.length() > 0) &#123;\n            // å½“éœ€è¦é…ç½®å¤šä¸ª url æ—¶ï¼Œå¯ç”¨åˆ†å·è¿›è¡Œåˆ†å‰²ï¼Œè¿™é‡Œä¼šè¿›è¡Œåˆ‡åˆ†\n            String[] us = Constants.SEMICOLON_SPLIT_PATTERN.split(url);\n            if (us != null &amp;&amp; us.length > 0) &#123;\n                for (String u : us) &#123;\n                    URL url = URL.valueOf(u);\n                    if (url.getPath() == null || url.getPath().length() == 0) &#123;\n                        // è®¾ç½®æ¥å£å…¨é™å®šåä¸º url è·¯å¾„\n                        url = url.setPath(interfaceName);\n                    &#125;\n                    \n                    // æ£€æµ‹ url åè®®æ˜¯å¦ä¸º registryï¼Œè‹¥æ˜¯ï¼Œè¡¨æ˜ç”¨æˆ·æƒ³ä½¿ç”¨æŒ‡å®šçš„æ³¨å†Œä¸­å¿ƒ\n                    if (Constants.REGISTRY_PROTOCOL.equals(url.getProtocol())) &#123;\n                        // å°† map è½¬æ¢ä¸ºæŸ¥è¯¢å­—ç¬¦ä¸²ï¼Œå¹¶ä½œä¸º refer å‚æ•°çš„å€¼æ·»åŠ åˆ° url ä¸­\n                        urls.add(url.addParameterAndEncoded(Constants.REFER_KEY, StringUtils.toQueryString(map)));\n                    &#125; else &#123;\n                        // åˆå¹¶ urlï¼Œç§»é™¤æœåŠ¡æä¾›è€…çš„ä¸€äº›é…ç½®ï¼ˆè¿™äº›é…ç½®æ¥æºäºç”¨æˆ·é…ç½®çš„ url å±æ€§ï¼‰ï¼Œ\n                        // æ¯”å¦‚çº¿ç¨‹æ± ç›¸å…³é…ç½®ã€‚å¹¶ä¿ç•™æœåŠ¡æä¾›è€…çš„éƒ¨åˆ†é…ç½®ï¼Œæ¯”å¦‚ç‰ˆæœ¬ï¼Œgroupï¼Œæ—¶é—´æˆ³ç­‰\n                        // æœ€åå°†åˆå¹¶åçš„é…ç½®è®¾ç½®ä¸º url æŸ¥è¯¢å­—ç¬¦ä¸²ä¸­ã€‚\n                        urls.add(ClusterUtils.mergeUrl(url, map));\n                    &#125;\n                &#125;\n            &#125;\n        &#125; else &#123;\n            // åŠ è½½æ³¨å†Œä¸­å¿ƒ url\n            List&lt;URL> us = loadRegistries(false);\n            if (us != null &amp;&amp; !us.isEmpty()) &#123;\n                for (URL u : us) &#123;\n                    URL monitorUrl = loadMonitor(u);\n                    if (monitorUrl != null) &#123;\n                        map.put(Constants.MONITOR_KEY, URL.encode(monitorUrl.toFullString()));\n                    &#125;\n                    // æ·»åŠ  refer å‚æ•°åˆ° url ä¸­ï¼Œå¹¶å°† url æ·»åŠ åˆ° urls ä¸­\n                    urls.add(u.addParameterAndEncoded(Constants.REFER_KEY, StringUtils.toQueryString(map)));\n                &#125;\n            &#125;\n\n            // æœªé…ç½®æ³¨å†Œä¸­å¿ƒï¼ŒæŠ›å‡ºå¼‚å¸¸\n            if (urls.isEmpty()) &#123;\n                throw new IllegalStateException(\"No such any registry to reference...\");\n            &#125;\n        &#125;\n\n        // å•ä¸ªæ³¨å†Œä¸­å¿ƒæˆ–æœåŠ¡æä¾›è€…(æœåŠ¡ç›´è¿ï¼Œä¸‹åŒ)\n        if (urls.size() == 1) &#123;\n            // è°ƒç”¨ RegistryProtocol çš„ refer æ„å»º Invoker å®ä¾‹\n            invoker = refprotocol.refer(interfaceClass, urls.get(0));\n            \n        // å¤šä¸ªæ³¨å†Œä¸­å¿ƒæˆ–å¤šä¸ªæœåŠ¡æä¾›è€…ï¼Œæˆ–è€…ä¸¤è€…æ··åˆ\n        &#125; else &#123;\n            List&lt;Invoker&lt;?>> invokers = new ArrayList&lt;Invoker&lt;?>>();\n            URL registryURL = null;\n\n            // è·å–æ‰€æœ‰çš„ Invoker\n            for (URL url : urls) &#123;\n                // é€šè¿‡ refprotocol è°ƒç”¨ refer æ„å»º Invokerï¼Œrefprotocol ä¼šåœ¨è¿è¡Œæ—¶\n                // æ ¹æ® url åè®®å¤´åŠ è½½æŒ‡å®šçš„ Protocol å®ä¾‹ï¼Œå¹¶è°ƒç”¨å®ä¾‹çš„ refer æ–¹æ³•\n                invokers.add(refprotocol.refer(interfaceClass, url));\n                if (Constants.REGISTRY_PROTOCOL.equals(url.getProtocol())) &#123;\n                    registryURL = url;\n                &#125;\n            &#125;\n            if (registryURL != null) &#123;\n                // å¦‚æœæ³¨å†Œä¸­å¿ƒé“¾æ¥ä¸ä¸ºç©ºï¼Œåˆ™å°†ä½¿ç”¨ AvailableCluster\n                URL u = registryURL.addParameter(Constants.CLUSTER_KEY, AvailableCluster.NAME);\n                // åˆ›å»º StaticDirectory å®ä¾‹ï¼Œå¹¶ç”± Cluster å¯¹å¤šä¸ª Invoker è¿›è¡Œåˆå¹¶\n                invoker = cluster.join(new StaticDirectory(u, invokers));\n            &#125; else &#123;\n                invoker = cluster.join(new StaticDirectory(invokers));\n            &#125;\n        &#125;\n    &#125;\n\n    Boolean c = check;\n    if (c == null &amp;&amp; consumer != null) &#123;\n        c = consumer.isCheck();\n    &#125;\n    if (c == null) &#123;\n        c = true;\n    &#125;\n    \n    // invoker å¯ç”¨æ€§æ£€æŸ¥\n    if (c &amp;&amp; !invoker.isAvailable()) &#123;\n        throw new IllegalStateException(\"No provider available for the service...\");\n    &#125;\n\n    // ç”Ÿæˆä»£ç†ç±»\n    return (T) proxyFactory.getProxy(invoker);\n&#125;\n\n\nä¸Šé¢ä»£ç å¾ˆå¤šï¼Œä¸è¿‡é€»è¾‘æ¯”è¾ƒæ¸…æ™°ã€‚é¦–å…ˆæ ¹æ®é…ç½®æ£€æŸ¥æ˜¯å¦ä¸ºæœ¬åœ°è°ƒç”¨ï¼Œè‹¥æ˜¯ï¼Œåˆ™è°ƒç”¨ InjvmProtocol çš„ refer æ–¹æ³•ç”Ÿæˆ InjvmInvoker å®ä¾‹ã€‚è‹¥ä¸æ˜¯ï¼Œåˆ™è¯»å–ç›´è¿é…ç½®é¡¹ï¼Œæˆ–æ³¨å†Œä¸­å¿ƒ urlï¼Œå¹¶å°†è¯»å–åˆ°çš„ url å­˜å‚¨åˆ° urls ä¸­ã€‚ç„¶åæ ¹æ® urls å…ƒç´ æ•°é‡è¿›è¡Œåç»­æ“ä½œã€‚è‹¥ urls å…ƒç´ æ•°é‡ä¸º1ï¼Œåˆ™ç›´æ¥é€šè¿‡ Protocol è‡ªé€‚åº”æ‹“å±•ç±»æ„å»º Invoker å®ä¾‹æ¥å£ã€‚è‹¥ urls å…ƒç´ æ•°é‡å¤§äº1ï¼Œå³å­˜åœ¨å¤šä¸ªæ³¨å†Œä¸­å¿ƒæˆ–æœåŠ¡ç›´è¿ urlï¼Œæ­¤æ—¶å…ˆæ ¹æ® url æ„å»º Invokerã€‚ç„¶åå†é€šè¿‡ Cluster åˆå¹¶å¤šä¸ª Invokerï¼Œæœ€åè°ƒç”¨ ProxyFactory ç”Ÿæˆä»£ç†ç±»ã€‚Invoker çš„æ„å»ºè¿‡ç¨‹ä»¥åŠä»£ç†ç±»çš„è¿‡ç¨‹æ¯”è¾ƒé‡è¦ï¼Œå› æ­¤æ¥ä¸‹æ¥å°†åˆ†ä¸¤å°èŠ‚å¯¹è¿™ä¸¤ä¸ªè¿‡ç¨‹è¿›è¡Œåˆ†æã€‚\n\n3.2.1 åˆ›å»º InvokerInvoker æ˜¯ Dubbo çš„æ ¸å¿ƒæ¨¡å‹ï¼Œä»£è¡¨ä¸€ä¸ªå¯æ‰§è¡Œä½“ã€‚åœ¨æœåŠ¡æä¾›æ–¹ï¼ŒInvoker ç”¨äºè°ƒç”¨æœåŠ¡æä¾›ç±»ã€‚åœ¨æœåŠ¡æ¶ˆè´¹æ–¹ï¼ŒInvoker ç”¨äºæ‰§è¡Œè¿œç¨‹è°ƒç”¨ã€‚Invoker æ˜¯ç”± Protocol å®ç°ç±»æ„å»ºè€Œæ¥ã€‚Protocol å®ç°ç±»æœ‰å¾ˆå¤šï¼Œæœ¬èŠ‚ä¼šåˆ†ææœ€å¸¸ç”¨çš„ä¸¤ä¸ªï¼Œåˆ†åˆ«æ˜¯ RegistryProtocol å’Œ DubboProtocolï¼Œå…¶ä»–çš„å¤§å®¶è‡ªè¡Œåˆ†æã€‚ä¸‹é¢å…ˆæ¥åˆ†æ DubboProtocol çš„ refer æ–¹æ³•æºç ã€‚å¦‚ä¸‹ï¼š\npublic &lt;T> Invoker&lt;T> refer(Class&lt;T> serviceType, URL url) throws RpcException &#123;\n    optimizeSerialization(url);\n    // åˆ›å»º DubboInvoker\n    DubboInvoker&lt;T> invoker = new DubboInvoker&lt;T>(serviceType, url, getClients(url), invokers);\n    invokers.add(invoker);\n    return invoker;\n&#125;\n\n\nä¸Šé¢æ–¹æ³•çœ‹èµ·æ¥æ¯”è¾ƒç®€å•ï¼Œä¸è¿‡è¿™é‡Œæœ‰ä¸€ä¸ªè°ƒç”¨éœ€è¦æˆ‘ä»¬æ³¨æ„ä¸€ä¸‹ï¼Œå³ getClientsã€‚è¿™ä¸ªæ–¹æ³•ç”¨äºè·å–å®¢æˆ·ç«¯å®ä¾‹ï¼Œå®ä¾‹ç±»å‹ä¸º ExchangeClientã€‚ExchangeClient å®é™…ä¸Šå¹¶ä¸å…·å¤‡é€šä¿¡èƒ½åŠ›ï¼Œå®ƒéœ€è¦åŸºäºæ›´åº•å±‚çš„å®¢æˆ·ç«¯å®ä¾‹è¿›è¡Œé€šä¿¡ã€‚æ¯”å¦‚ NettyClientã€MinaClient ç­‰ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒDubbo ä½¿ç”¨ NettyClient è¿›è¡Œé€šä¿¡ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç®€å•çœ‹ä¸€ä¸‹ getClients æ–¹æ³•çš„é€»è¾‘ã€‚\nprivate ExchangeClient[] getClients(URL url) &#123;\n    // æ˜¯å¦å…±äº«è¿æ¥\n    boolean service_share_connect = false;\n  \t// è·å–è¿æ¥æ•°ï¼Œé»˜è®¤ä¸º0ï¼Œè¡¨ç¤ºæœªé…ç½®\n    int connections = url.getParameter(Constants.CONNECTIONS_KEY, 0);\n    // å¦‚æœæœªé…ç½® connectionsï¼Œåˆ™å…±äº«è¿æ¥\n    if (connections == 0) &#123;\n        service_share_connect = true;\n        connections = 1;\n    &#125;\n\n    ExchangeClient[] clients = new ExchangeClient[connections];\n    for (int i = 0; i &lt; clients.length; i++) &#123;\n        if (service_share_connect) &#123;\n            // è·å–å…±äº«å®¢æˆ·ç«¯\n            clients[i] = getSharedClient(url);\n        &#125; else &#123;\n            // åˆå§‹åŒ–æ–°çš„å®¢æˆ·ç«¯\n            clients[i] = initClient(url);\n        &#125;\n    &#125;\n    return clients;\n&#125;\n\n\nè¿™é‡Œæ ¹æ® connections æ•°é‡å†³å®šæ˜¯è·å–å…±äº«å®¢æˆ·ç«¯è¿˜æ˜¯åˆ›å»ºæ–°çš„å®¢æˆ·ç«¯å®ä¾‹ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œä½¿ç”¨å…±äº«å®¢æˆ·ç«¯å®ä¾‹ã€‚getSharedClient æ–¹æ³•ä¸­ä¹Ÿä¼šè°ƒç”¨ initClient æ–¹æ³•ï¼Œå› æ­¤ä¸‹é¢æˆ‘ä»¬ä¸€èµ·çœ‹ä¸€ä¸‹è¿™ä¸¤ä¸ªæ–¹æ³•ã€‚\nprivate ExchangeClient getSharedClient(URL url) &#123;\n    String key = url.getAddress();\n    // è·å–å¸¦æœ‰â€œå¼•ç”¨è®¡æ•°â€åŠŸèƒ½çš„ ExchangeClient\n    ReferenceCountExchangeClient client = referenceClientMap.get(key);\n    if (client != null) &#123;\n        if (!client.isClosed()) &#123;\n            // å¢åŠ å¼•ç”¨è®¡æ•°\n            client.incrementAndGetCount();\n            return client;\n        &#125; else &#123;\n            referenceClientMap.remove(key);\n        &#125;\n    &#125;\n\n    locks.putIfAbsent(key, new Object());\n    synchronized (locks.get(key)) &#123;\n        if (referenceClientMap.containsKey(key)) &#123;\n            return referenceClientMap.get(key);\n        &#125;\n\n        // åˆ›å»º ExchangeClient å®¢æˆ·ç«¯\n        ExchangeClient exchangeClient = initClient(url);\n        // å°† ExchangeClient å®ä¾‹ä¼ ç»™ ReferenceCountExchangeClientï¼Œè¿™é‡Œä½¿ç”¨äº†è£…é¥°æ¨¡å¼\n        client = new ReferenceCountExchangeClient(exchangeClient, ghostClientMap);\n        referenceClientMap.put(key, client);\n        ghostClientMap.remove(key);\n        locks.remove(key);\n        return client;\n    &#125;\n&#125;\n\n\nä¸Šé¢æ–¹æ³•å…ˆè®¿é—®ç¼“å­˜ï¼Œè‹¥ç¼“å­˜æœªå‘½ä¸­ï¼Œåˆ™é€šè¿‡ initClient æ–¹æ³•åˆ›å»ºæ–°çš„ ExchangeClient å®ä¾‹ï¼Œå¹¶å°†è¯¥å®ä¾‹ä¼ ç»™ ReferenceCountExchangeClient æ„é€ æ–¹æ³•åˆ›å»ºä¸€ä¸ªå¸¦æœ‰å¼•ç”¨è®¡æ•°åŠŸèƒ½çš„ ExchangeClient å®ä¾‹ã€‚ReferenceCountExchangeClient å†…éƒ¨å®ç°æ¯”è¾ƒç®€å•ï¼Œå°±ä¸åˆ†æäº†ã€‚ä¸‹é¢æˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹ initClient æ–¹æ³•çš„ä»£ç ã€‚\nprivate ExchangeClient initClient(URL url) &#123;\n\n    // è·å–å®¢æˆ·ç«¯ç±»å‹ï¼Œé»˜è®¤ä¸º netty\n    String str = url.getParameter(Constants.CLIENT_KEY, url.getParameter(Constants.SERVER_KEY, Constants.DEFAULT_REMOTING_CLIENT));\n\n    // æ·»åŠ ç¼–è§£ç å’Œå¿ƒè·³åŒ…å‚æ•°åˆ° url ä¸­\n    url = url.addParameter(Constants.CODEC_KEY, DubboCodec.NAME);\n    url = url.addParameterIfAbsent(Constants.HEARTBEAT_KEY, String.valueOf(Constants.DEFAULT_HEARTBEAT));\n\n    // æ£€æµ‹å®¢æˆ·ç«¯ç±»å‹æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™æŠ›å‡ºå¼‚å¸¸\n    if (str != null &amp;&amp; str.length() > 0 &amp;&amp; !ExtensionLoader.getExtensionLoader(Transporter.class).hasExtension(str)) &#123;\n        throw new RpcException(\"Unsupported client type: ...\");\n    &#125;\n\n    ExchangeClient client;\n    try &#123;\n        // è·å– lazy é…ç½®ï¼Œå¹¶æ ¹æ®é…ç½®å€¼å†³å®šåˆ›å»ºçš„å®¢æˆ·ç«¯ç±»å‹\n        if (url.getParameter(Constants.LAZY_CONNECT_KEY, false)) &#123;\n            // åˆ›å»ºæ‡’åŠ è½½ ExchangeClient å®ä¾‹\n            client = new LazyConnectExchangeClient(url, requestHandler);\n        &#125; else &#123;\n            // åˆ›å»ºæ™®é€š ExchangeClient å®ä¾‹\n            client = Exchangers.connect(url, requestHandler);\n        &#125;\n    &#125; catch (RemotingException e) &#123;\n        throw new RpcException(\"Fail to create remoting client for service...\");\n    &#125;\n    return client;\n&#125;\n\n\ninitClient æ–¹æ³•é¦–å…ˆè·å–ç”¨æˆ·é…ç½®çš„å®¢æˆ·ç«¯ç±»å‹ï¼Œé»˜è®¤ä¸º nettyã€‚ç„¶åæ£€æµ‹ç”¨æˆ·é…ç½®çš„å®¢æˆ·ç«¯ç±»å‹æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™æŠ›å‡ºå¼‚å¸¸ã€‚æœ€åæ ¹æ® lazy é…ç½®å†³å®šåˆ›å»ºä»€ä¹ˆç±»å‹çš„å®¢æˆ·ç«¯ã€‚è¿™é‡Œçš„ LazyConnectExchangeClient ä»£ç å¹¶ä¸æ˜¯å¾ˆå¤æ‚ï¼Œè¯¥ç±»ä¼šåœ¨ request æ–¹æ³•è¢«è°ƒç”¨æ—¶é€šè¿‡ Exchangers çš„ connect æ–¹æ³•åˆ›å»º ExchangeClient å®¢æˆ·ç«¯ï¼Œè¯¥ç±»çš„ä»£ç æœ¬èŠ‚å°±ä¸åˆ†æäº†ã€‚ä¸‹é¢æˆ‘ä»¬åˆ†æä¸€ä¸‹ Exchangers çš„ connect æ–¹æ³•ã€‚\npublic static ExchangeClient connect(URL url, ExchangeHandler handler) throws RemotingException &#123;\n    if (url == null) &#123;\n        throw new IllegalArgumentException(\"url == null\");\n    &#125;\n    if (handler == null) &#123;\n        throw new IllegalArgumentException(\"handler == null\");\n    &#125;\n    url = url.addParameterIfAbsent(Constants.CODEC_KEY, \"exchange\");\n    // è·å– Exchanger å®ä¾‹ï¼Œé»˜è®¤ä¸º HeaderExchangeClient\n    return getExchanger(url).connect(url, handler);\n&#125;\n\n\nå¦‚ä¸Šï¼ŒgetExchanger ä¼šé€šè¿‡ SPI åŠ è½½ HeaderExchanger å®ä¾‹ï¼Œè¿™ä¸ªæ–¹æ³•æ¯”è¾ƒç®€å•ï¼Œå¤§å®¶è‡ªå·±çœ‹ä¸€ä¸‹å§ã€‚æ¥ä¸‹æ¥åˆ†æ HeaderExchanger.connect çš„å®ç°ã€‚\npublic ExchangeClient connect(URL url, ExchangeHandler handler) throws RemotingException &#123;\n    // è¿™é‡ŒåŒ…å«äº†å¤šä¸ªè°ƒç”¨ï¼Œåˆ†åˆ«å¦‚ä¸‹ï¼š\n    // 1. åˆ›å»º HeaderExchangeHandler å¯¹è±¡\n    // 2. åˆ›å»º DecodeHandler å¯¹è±¡\n    // 3. é€šè¿‡ Transporters æ„å»º Client å®ä¾‹\n    // 4. åˆ›å»º HeaderExchangeClient å¯¹è±¡\n    return new HeaderExchangeClient(Transporters.connect(url, new DecodeHandler(new HeaderExchangeHandler(handler))), true);\n&#125;\n\n\n\nè¿™é‡Œçš„è°ƒç”¨æ¯”è¾ƒå¤šï¼Œæˆ‘ä»¬è¿™é‡Œé‡ç‚¹çœ‹ä¸€ä¸‹ Transporters çš„ connect æ–¹æ³•ã€‚å¦‚ä¸‹ï¼š\npublic static Client connect(URL url, ChannelHandler... handlers) throws RemotingException &#123;\n    if (url == null) &#123;\n        throw new IllegalArgumentException(\"url == null\");\n    &#125;\n    ChannelHandler handler;\n    if (handlers == null || handlers.length == 0) &#123;\n        handler = new ChannelHandlerAdapter();\n    &#125; else if (handlers.length == 1) &#123;\n        handler = handlers[0];\n    &#125; else &#123;\n        // å¦‚æœ handler æ•°é‡å¤§äº1ï¼Œåˆ™åˆ›å»ºä¸€ä¸ª ChannelHandler åˆ†å‘å™¨\n        handler = new ChannelHandlerDispatcher(handlers);\n    &#125;\n    \n    // è·å– Transporter è‡ªé€‚åº”æ‹“å±•ç±»ï¼Œå¹¶è°ƒç”¨ connect æ–¹æ³•ç”Ÿæˆ Client å®ä¾‹\n    return getTransporter().connect(url, handler);\n&#125;\n\n\n\nå¦‚ä¸Šï¼ŒgetTransporter æ–¹æ³•è¿”å›çš„æ˜¯è‡ªé€‚åº”æ‹“å±•ç±»ï¼Œè¯¥ç±»ä¼šåœ¨è¿è¡Œæ—¶æ ¹æ®å®¢æˆ·ç«¯ç±»å‹åŠ è½½æŒ‡å®šçš„ Transporter å®ç°ç±»ã€‚è‹¥ç”¨æˆ·æœªé…ç½®å®¢æˆ·ç«¯ç±»å‹ï¼Œåˆ™é»˜è®¤åŠ è½½ NettyTransporterï¼Œå¹¶è°ƒç”¨è¯¥ç±»çš„ connect æ–¹æ³•ã€‚å¦‚ä¸‹ï¼š\npublic Client connect(URL url, ChannelHandler listener) throws RemotingException &#123;\n    // åˆ›å»º NettyClient å¯¹è±¡\n    return new NettyClient(url, listener);\n&#125;\n\n\n\nåˆ°è¿™é‡Œå°±ä¸ç»§ç»­è·Ÿä¸‹å»äº†ï¼Œåœ¨å¾€ä¸‹å°±æ˜¯é€šè¿‡ Netty æä¾›çš„ API æ„å»º Netty å®¢æˆ·ç«¯äº†ï¼Œå¤§å®¶æœ‰å…´è¶£è‡ªå·±çœ‹çœ‹ã€‚åˆ°è¿™é‡Œï¼Œå…³äº DubboProtocol çš„ refer æ–¹æ³•å°±åˆ†æå®Œäº†ã€‚æ¥ä¸‹æ¥ï¼Œç»§ç»­åˆ†æ RegistryProtocol çš„ refer æ–¹æ³•é€»è¾‘ã€‚\npublic &lt;T> Invoker&lt;T> refer(Class&lt;T> type, URL url) throws RpcException &#123;\n    // å– registry å‚æ•°å€¼ï¼Œå¹¶å°†å…¶è®¾ç½®ä¸ºåè®®å¤´\n    url = url.setProtocol(url.getParameter(Constants.REGISTRY_KEY, Constants.DEFAULT_REGISTRY)).removeParameter(Constants.REGISTRY_KEY);\n    // è·å–æ³¨å†Œä¸­å¿ƒå®ä¾‹\n    Registry registry = registryFactory.getRegistry(url);\n    if (RegistryService.class.equals(type)) &#123;\n        return proxyFactory.getInvoker((T) registry, type, url);\n    &#125;\n\n    // å°† url æŸ¥è¯¢å­—ç¬¦ä¸²è½¬ä¸º Map\n    Map&lt;String, String> qs = StringUtils.parseQueryString(url.getParameterAndDecoded(Constants.REFER_KEY));\n    // è·å– group é…ç½®\n    String group = qs.get(Constants.GROUP_KEY);\n    if (group != null &amp;&amp; group.length() > 0) &#123;\n        if ((Constants.COMMA_SPLIT_PATTERN.split(group)).length > 1\n                || \"*\".equals(group)) &#123;\n            // é€šè¿‡ SPI åŠ è½½ MergeableCluster å®ä¾‹ï¼Œå¹¶è°ƒç”¨ doRefer ç»§ç»­æ‰§è¡ŒæœåŠ¡å¼•ç”¨é€»è¾‘\n            return doRefer(getMergeableCluster(), registry, type, url);\n        &#125;\n    &#125;\n    \n    // è°ƒç”¨ doRefer ç»§ç»­æ‰§è¡ŒæœåŠ¡å¼•ç”¨é€»è¾‘\n    return doRefer(cluster, registry, type, url);\n&#125;\n\n\n\nä¸Šé¢ä»£ç é¦–å…ˆä¸º url è®¾ç½®åè®®å¤´ï¼Œç„¶åæ ¹æ® url å‚æ•°åŠ è½½æ³¨å†Œä¸­å¿ƒå®ä¾‹ã€‚ç„¶åè·å– group é…ç½®ï¼Œæ ¹æ® group é…ç½®å†³å®š doRefer ç¬¬ä¸€ä¸ªå‚æ•°çš„ç±»å‹ã€‚è¿™é‡Œçš„é‡ç‚¹æ˜¯ doRefer æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š\nprivate &lt;T> Invoker&lt;T> doRefer(Cluster cluster, Registry registry, Class&lt;T> type, URL url) &#123;\n    // åˆ›å»º RegistryDirectory å®ä¾‹\n    RegistryDirectory&lt;T> directory = new RegistryDirectory&lt;T>(type, url);\n    // è®¾ç½®æ³¨å†Œä¸­å¿ƒå’Œåè®®\n    directory.setRegistry(registry);\n    directory.setProtocol(protocol);\n    Map&lt;String, String> parameters = new HashMap&lt;String, String>(directory.getUrl().getParameters());\n    // ç”ŸæˆæœåŠ¡æ¶ˆè´¹è€…é“¾æ¥\n    URL subscribeUrl = new URL(Constants.CONSUMER_PROTOCOL, parameters.remove(Constants.REGISTER_IP_KEY), 0, type.getName(), parameters);\n\n    // æ³¨å†ŒæœåŠ¡æ¶ˆè´¹è€…ï¼Œåœ¨ consumers ç›®å½•ä¸‹æ–°èŠ‚ç‚¹\n    if (!Constants.ANY_VALUE.equals(url.getServiceInterface())\n            &amp;&amp; url.getParameter(Constants.REGISTER_KEY, true)) &#123;\n        registry.register(subscribeUrl.addParameters(Constants.CATEGORY_KEY, Constants.CONSUMERS_CATEGORY,\n                Constants.CHECK_KEY, String.valueOf(false)));\n    &#125;\n\n    // è®¢é˜… providersã€configuratorsã€routers ç­‰èŠ‚ç‚¹æ•°æ®\n    directory.subscribe(subscribeUrl.addParameter(Constants.CATEGORY_KEY,\n            Constants.PROVIDERS_CATEGORY\n                    + \",\" + Constants.CONFIGURATORS_CATEGORY\n                    + \",\" + Constants.ROUTERS_CATEGORY));\n\n    // ä¸€ä¸ªæ³¨å†Œä¸­å¿ƒå¯èƒ½æœ‰å¤šä¸ªæœåŠ¡æä¾›è€…ï¼Œå› æ­¤è¿™é‡Œéœ€è¦å°†å¤šä¸ªæœåŠ¡æä¾›è€…åˆå¹¶ä¸ºä¸€ä¸ª\n    Invoker invoker = cluster.join(directory);\n    ProviderConsumerRegTable.registerConsumer(invoker, url, subscribeUrl, directory);\n    return invoker;\n&#125;\n\n\n\nå¦‚ä¸Šï¼ŒdoRefer æ–¹æ³•åˆ›å»ºä¸€ä¸ª RegistryDirectory å®ä¾‹ï¼Œç„¶åç”ŸæˆæœåŠ¡è€…æ¶ˆè´¹è€…é“¾æ¥ï¼Œå¹¶å‘æ³¨å†Œä¸­å¿ƒè¿›è¡Œæ³¨å†Œã€‚æ³¨å†Œå®Œæ¯•åï¼Œç´§æ¥ç€è®¢é˜… providersã€configuratorsã€routers ç­‰èŠ‚ç‚¹ä¸‹çš„æ•°æ®ã€‚å®Œæˆè®¢é˜…åï¼ŒRegistryDirectory ä¼šæ”¶åˆ°è¿™å‡ ä¸ªèŠ‚ç‚¹ä¸‹çš„å­èŠ‚ç‚¹ä¿¡æ¯ã€‚ç”±äºä¸€ä¸ªæœåŠ¡å¯èƒ½éƒ¨ç½²åœ¨å¤šå°æœåŠ¡å™¨ä¸Šï¼Œè¿™æ ·å°±ä¼šåœ¨ providers äº§ç”Ÿå¤šä¸ªèŠ‚ç‚¹ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦ Cluster å°†å¤šä¸ªæœåŠ¡èŠ‚ç‚¹åˆå¹¶ä¸ºä¸€ä¸ªï¼Œå¹¶ç”Ÿæˆä¸€ä¸ª Invokerã€‚å…³äº RegistryDirectory å’Œ Clusterï¼Œæœ¬æ–‡ä¸æ‰“ç®—è¿›è¡Œåˆ†æï¼Œç›¸å…³åˆ†æå°†ä¼šåœ¨éšåçš„æ–‡ç« ä¸­å±•å¼€ã€‚\n\n3.2.2 åˆ›å»ºä»£ç†Invoker åˆ›å»ºå®Œæ¯•åï¼Œæ¥ä¸‹æ¥è¦åšçš„äº‹æƒ…æ˜¯ä¸ºæœåŠ¡æ¥å£ç”Ÿæˆä»£ç†å¯¹è±¡ã€‚æœ‰äº†ä»£ç†å¯¹è±¡ï¼Œå³å¯è¿›è¡Œè¿œç¨‹è°ƒç”¨ã€‚ä»£ç†å¯¹è±¡ç”Ÿæˆçš„å…¥å£æ–¹æ³•ä¸º ProxyFactory çš„ getProxyï¼Œæ¥ä¸‹æ¥è¿›è¡Œåˆ†æã€‚\npublic &lt;T> T getProxy(Invoker&lt;T> invoker) throws RpcException &#123;\n    // è°ƒç”¨é‡è½½æ–¹æ³•\n    return getProxy(invoker, false);\n&#125;\n\npublic &lt;T> T getProxy(Invoker&lt;T> invoker, boolean generic) throws RpcException &#123;\n    Class&lt;?>[] interfaces = null;\n    // è·å–æ¥å£åˆ—è¡¨\n    String config = invoker.getUrl().getParameter(\"interfaces\");\n    if (config != null &amp;&amp; config.length() > 0) &#123;\n        // åˆ‡åˆ†æ¥å£åˆ—è¡¨\n        String[] types = Constants.COMMA_SPLIT_PATTERN.split(config);\n        if (types != null &amp;&amp; types.length > 0) &#123;\n            interfaces = new Class&lt;?>[types.length + 2];\n            // è®¾ç½®æœåŠ¡æ¥å£ç±»å’Œ EchoService.class åˆ° interfaces ä¸­\n            interfaces[0] = invoker.getInterface();\n            interfaces[1] = EchoService.class;\n            for (int i = 0; i &lt; types.length; i++) &#123;\n                // åŠ è½½æ¥å£ç±»\n                interfaces[i + 1] = ReflectUtils.forName(types[i]);\n            &#125;\n        &#125;\n    &#125;\n    if (interfaces == null) &#123;\n        interfaces = new Class&lt;?>[]&#123;invoker.getInterface(), EchoService.class&#125;;\n    &#125;\n\n    // ä¸º http å’Œ hessian åè®®æä¾›æ³›åŒ–è°ƒç”¨æ”¯æŒï¼Œå‚è€ƒ pull request #1827\n    if (!invoker.getInterface().equals(GenericService.class) &amp;&amp; generic) &#123;\n        int len = interfaces.length;\n        Class&lt;?>[] temp = interfaces;\n        // åˆ›å»ºæ–°çš„ interfaces æ•°ç»„\n        interfaces = new Class&lt;?>[len + 1];\n        System.arraycopy(temp, 0, interfaces, 0, len);\n        // è®¾ç½® GenericService.class åˆ°æ•°ç»„ä¸­\n        interfaces[len] = GenericService.class;\n    &#125;\n\n    // è°ƒç”¨é‡è½½æ–¹æ³•\n    return getProxy(invoker, interfaces);\n&#125;\n\npublic abstract &lt;T> T getProxy(Invoker&lt;T> invoker, Class&lt;?>[] types);\n\n\n\nå¦‚ä¸Šï¼Œä¸Šé¢å¤§æ®µä»£ç éƒ½æ˜¯ç”¨æ¥è·å– interfaces æ•°ç»„çš„ï¼Œæˆ‘ä»¬ç»§ç»­å¾€ä¸‹çœ‹ã€‚getProxy(Invoker, Class&lt;?&gt;[]) è¿™ä¸ªæ–¹æ³•æ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œä¸‹é¢æˆ‘ä»¬åˆ° JavassistProxyFactory ç±»ä¸­çœ‹ä¸€ä¸‹è¯¥æ–¹æ³•çš„å®ç°ä»£ç ã€‚\npublic &lt;T> T getProxy(Invoker&lt;T> invoker, Class&lt;?>[] interfaces) &#123;\n    // ç”Ÿæˆ Proxy å­ç±»ï¼ˆProxy æ˜¯æŠ½è±¡ç±»ï¼‰ã€‚å¹¶è°ƒç”¨ Proxy å­ç±»çš„ newInstance æ–¹æ³•åˆ›å»º Proxy å®ä¾‹\n    return (T) Proxy.getProxy(interfaces).newInstance(new InvokerInvocationHandler(invoker));\n&#125;\n\n\n\nä¸Šé¢ä»£ç å¹¶ä¸å¤šï¼Œé¦–å…ˆæ˜¯é€šè¿‡ Proxy çš„ getProxy æ–¹æ³•è·å– Proxy å­ç±»ï¼Œç„¶ååˆ›å»º InvokerInvocationHandler å¯¹è±¡ï¼Œå¹¶å°†è¯¥å¯¹è±¡ä¼ ç»™ newInstance ç”Ÿæˆ Proxy å®ä¾‹ã€‚InvokerInvocationHandler å®ç° JDK çš„ InvocationHandler æ¥å£ï¼Œå…·ä½“çš„ç”¨é€”æ˜¯æ‹¦æˆªæ¥å£ç±»è°ƒç”¨ã€‚è¯¥ç±»é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œè¿™é‡Œå°±ä¸åˆ†æäº†ã€‚ä¸‹é¢æˆ‘ä»¬é‡ç‚¹å…³æ³¨ä¸€ä¸‹ Proxy çš„ getProxy æ–¹æ³•ï¼Œå¦‚ä¸‹ã€‚\npublic static Proxy getProxy(Class&lt;?>... ics) &#123;\n    // è°ƒç”¨é‡è½½æ–¹æ³•\n    return getProxy(ClassHelper.getClassLoader(Proxy.class), ics);\n&#125;\n\npublic static Proxy getProxy(ClassLoader cl, Class&lt;?>... ics) &#123;\n    if (ics.length > 65535)\n        throw new IllegalArgumentException(\"interface limit exceeded\");\n\n    StringBuilder sb = new StringBuilder();\n    // éå†æ¥å£åˆ—è¡¨\n    for (int i = 0; i &lt; ics.length; i++) &#123;\n        String itf = ics[i].getName();\n        // æ£€æµ‹ç±»å‹æ˜¯å¦ä¸ºæ¥å£\n        if (!ics[i].isInterface())\n            throw new RuntimeException(itf + \" is not a interface.\");\n\n        Class&lt;?> tmp = null;\n        try &#123;\n            // é‡æ–°åŠ è½½æ¥å£ç±»\n            tmp = Class.forName(itf, false, cl);\n        &#125; catch (ClassNotFoundException e) &#123;\n        &#125;\n\n        // æ£€æµ‹æ¥å£æ˜¯å¦ç›¸åŒï¼Œè¿™é‡Œ tmp æœ‰å¯èƒ½ä¸ºç©º\n        if (tmp != ics[i])\n            throw new IllegalArgumentException(ics[i] + \" is not visible from class loader\");\n\n        // æ‹¼æ¥æ¥å£å…¨é™å®šåï¼Œåˆ†éš”ç¬¦ä¸º ;\n        sb.append(itf).append(';');\n    &#125;\n\n    // ä½¿ç”¨æ‹¼æ¥åçš„æ¥å£åä½œä¸º key\n    String key = sb.toString();\n\n    Map&lt;String, Object> cache;\n    synchronized (ProxyCacheMap) &#123;\n        cache = ProxyCacheMap.get(cl);\n        if (cache == null) &#123;\n            cache = new HashMap&lt;String, Object>();\n            ProxyCacheMap.put(cl, cache);\n        &#125;\n    &#125;\n\n    Proxy proxy = null;\n    synchronized (cache) &#123;\n        do &#123;\n            // ä»ç¼“å­˜ä¸­è·å– Reference&lt;Proxy> å®ä¾‹\n            Object value = cache.get(key);\n            if (value instanceof Reference&lt;?>) &#123;\n                proxy = (Proxy) ((Reference&lt;?>) value).get();\n                if (proxy != null) &#123;\n                    return proxy;\n                &#125;\n            &#125;\n\n            // å¹¶å‘æ§åˆ¶ï¼Œä¿è¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è¿›è¡Œåç»­æ“ä½œ\n            if (value == PendingGenerationMarker) &#123;\n                try &#123;\n                    // å…¶ä»–çº¿ç¨‹åœ¨æ­¤å¤„è¿›è¡Œç­‰å¾…\n                    cache.wait();\n                &#125; catch (InterruptedException e) &#123;\n                &#125;\n            &#125; else &#123;\n                // æ”¾ç½®æ ‡å¿—ä½åˆ°ç¼“å­˜ä¸­ï¼Œå¹¶è·³å‡º while å¾ªç¯è¿›è¡Œåç»­æ“ä½œ\n                cache.put(key, PendingGenerationMarker);\n                break;\n            &#125;\n        &#125;\n        while (true);\n    &#125;\n\n    long id = PROXY_CLASS_COUNTER.getAndIncrement();\n    String pkg = null;\n    ClassGenerator ccp = null, ccm = null;\n    try &#123;\n        // åˆ›å»º ClassGenerator å¯¹è±¡\n        ccp = ClassGenerator.newInstance(cl);\n\n        Set&lt;String> worked = new HashSet&lt;String>();\n        List&lt;Method> methods = new ArrayList&lt;Method>();\n\n        for (int i = 0; i &lt; ics.length; i++) &#123;\n            // æ£€æµ‹æ¥å£è®¿é—®çº§åˆ«æ˜¯å¦ä¸º protected æˆ– private\n            if (!Modifier.isPublic(ics[i].getModifiers())) &#123;\n                // è·å–æ¥å£åŒ…å\n                String npkg = ics[i].getPackage().getName();\n                if (pkg == null) &#123;\n                    pkg = npkg;\n                &#125; else &#123;\n                    if (!pkg.equals(npkg))\n                        // é public çº§åˆ«çš„æ¥å£å¿…é¡»åœ¨åŒä¸€ä¸ªåŒ…ä¸‹ï¼Œå¦è€…æŠ›å‡ºå¼‚å¸¸\n                        throw new IllegalArgumentException(\"non-public interfaces from different packages\");\n                &#125;\n            &#125;\n            \n            // æ·»åŠ æ¥å£åˆ° ClassGenerator ä¸­\n            ccp.addInterface(ics[i]);\n\n            // éå†æ¥å£æ–¹æ³•\n            for (Method method : ics[i].getMethods()) &#123;\n                // è·å–æ–¹æ³•æè¿°ï¼Œå¯ç†è§£ä¸ºæ–¹æ³•ç­¾å\n                String desc = ReflectUtils.getDesc(method);\n                // å¦‚æœæ–¹æ³•æè¿°å­—ç¬¦ä¸²å·²åœ¨ worked ä¸­ï¼Œåˆ™å¿½ç•¥ã€‚è€ƒè™‘è¿™ç§æƒ…å†µï¼Œ\n                // A æ¥å£å’Œ B æ¥å£ä¸­åŒ…å«ä¸€ä¸ªå®Œå…¨ç›¸åŒçš„æ–¹æ³•\n                if (worked.contains(desc))\n                    continue;\n                worked.add(desc);\n\n                int ix = methods.size();\n                // è·å–æ–¹æ³•è¿”å›å€¼ç±»å‹\n                Class&lt;?> rt = method.getReturnType();\n                // è·å–å‚æ•°åˆ—è¡¨\n                Class&lt;?>[] pts = method.getParameterTypes();\n\n                // ç”Ÿæˆ Object[] args = new Object[1...N]\n                StringBuilder code = new StringBuilder(\"Object[] args = new Object[\").append(pts.length).append(\"];\");\n                for (int j = 0; j &lt; pts.length; j++)\n                    // ç”Ÿæˆ args[1...N] = ($w)$1...N;\n                    code.append(\" args[\").append(j).append(\"] = ($w)$\").append(j + 1).append(\";\");\n                // ç”Ÿæˆ InvokerHandler æ¥å£çš„ invoker æ–¹æ³•è°ƒç”¨è¯­å¥ï¼Œå¦‚ä¸‹ï¼š\n                // Object ret = handler.invoke(this, methods[1...N], args);\n                code.append(\" Object ret = handler.invoke(this, methods[\" + ix + \"], args);\");\n\n                // è¿”å›å€¼ä¸ä¸º void\n                if (!Void.TYPE.equals(rt))\n                    // ç”Ÿæˆè¿”å›è¯­å¥ï¼Œå½¢å¦‚ return (java.lang.String) ret;\n                    code.append(\" return \").append(asArgument(rt, \"ret\")).append(\";\");\n\n                methods.add(method);\n                // æ·»åŠ æ–¹æ³•åã€è®¿é—®æ§åˆ¶ç¬¦ã€å‚æ•°åˆ—è¡¨ã€æ–¹æ³•ä»£ç ç­‰ä¿¡æ¯åˆ° ClassGenerator ä¸­ \n                ccp.addMethod(method.getName(), method.getModifiers(), rt, pts, method.getExceptionTypes(), code.toString());\n            &#125;\n        &#125;\n\n        if (pkg == null)\n            pkg = PACKAGE_NAME;\n\n        // æ„å»ºæ¥å£ä»£ç†ç±»åç§°ï¼špkg + \".proxy\" + idï¼Œæ¯”å¦‚ org.apache.dubbo.proxy0\n        String pcn = pkg + \".proxy\" + id;\n        ccp.setClassName(pcn);\n        ccp.addField(\"public static java.lang.reflect.Method[] methods;\");\n        // ç”Ÿæˆ private java.lang.reflect.InvocationHandler handler;\n        ccp.addField(\"private \" + InvocationHandler.class.getName() + \" handler;\");\n\n        // ä¸ºæ¥å£ä»£ç†ç±»æ·»åŠ å¸¦æœ‰ InvocationHandler å‚æ•°çš„æ„é€ æ–¹æ³•ï¼Œæ¯”å¦‚ï¼š\n        // porxy0(java.lang.reflect.InvocationHandler arg0) &#123;\n        //     handler=$1;\n    \t// &#125;\n        ccp.addConstructor(Modifier.PUBLIC, new Class&lt;?>[]&#123;InvocationHandler.class&#125;, new Class&lt;?>[0], \"handler=$1;\");\n        // ä¸ºæ¥å£ä»£ç†ç±»æ·»åŠ é»˜è®¤æ„é€ æ–¹æ³•\n        ccp.addDefaultConstructor();\n        \n        // ç”Ÿæˆæ¥å£ä»£ç†ç±»\n        Class&lt;?> clazz = ccp.toClass();\n        clazz.getField(\"methods\").set(null, methods.toArray(new Method[0]));\n\n        // æ„å»º Proxy å­ç±»åç§°ï¼Œæ¯”å¦‚ Proxy1ï¼ŒProxy2 ç­‰\n        String fcn = Proxy.class.getName() + id;\n        ccm = ClassGenerator.newInstance(cl);\n        ccm.setClassName(fcn);\n        ccm.addDefaultConstructor();\n        ccm.setSuperClass(Proxy.class);\n        // ä¸º Proxy çš„æŠ½è±¡æ–¹æ³• newInstance ç”Ÿæˆå®ç°ä»£ç ï¼Œå½¢å¦‚ï¼š\n        // public Object newInstance(java.lang.reflect.InvocationHandler h) &#123; \n        //     return new org.apache.dubbo.proxy0($1);\n        // &#125;\n        ccm.addMethod(\"public Object newInstance(\" + InvocationHandler.class.getName() + \" h)&#123; return new \" + pcn + \"($1); &#125;\");\n        // ç”Ÿæˆ Proxy å®ç°ç±»\n        Class&lt;?> pc = ccm.toClass();\n        // é€šè¿‡åå°„åˆ›å»º Proxy å®ä¾‹\n        proxy = (Proxy) pc.newInstance();\n    &#125; catch (RuntimeException e) &#123;\n        throw e;\n    &#125; catch (Exception e) &#123;\n        throw new RuntimeException(e.getMessage(), e);\n    &#125; finally &#123;\n        if (ccp != null)\n            // é‡Šæ”¾èµ„æº\n            ccp.release();\n        if (ccm != null)\n            ccm.release();\n        synchronized (cache) &#123;\n            if (proxy == null)\n                cache.remove(key);\n            else\n                // å†™ç¼“å­˜\n                cache.put(key, new WeakReference&lt;Proxy>(proxy));\n            // å”¤é†’å…¶ä»–ç­‰å¾…çº¿ç¨‹\n            cache.notifyAll();\n        &#125;\n    &#125;\n    return proxy;\n&#125;\n\n\n\nä¸Šé¢ä»£ç æ¯”è¾ƒå¤æ‚ï¼Œæˆ‘ä»¬å†™äº†å¤§é‡çš„æ³¨é‡Šã€‚å¤§å®¶åœ¨é˜…è¯»è¿™æ®µä»£ç æ—¶ï¼Œè¦ææ¸…æ¥š ccp å’Œ ccm çš„ç”¨é€”ï¼Œä¸ç„¶ä¼šè¢«ææ™•ã€‚ccp ç”¨äºä¸ºæœåŠ¡æ¥å£ç”Ÿæˆä»£ç†ç±»ï¼Œæ¯”å¦‚æˆ‘ä»¬æœ‰ä¸€ä¸ª DemoService æ¥å£ï¼Œè¿™ä¸ªæ¥å£ä»£ç†ç±»å°±æ˜¯ç”± ccp ç”Ÿæˆçš„ã€‚ccm åˆ™æ˜¯ç”¨äºä¸º org.apache.dubbo.common.bytecode.Proxy æŠ½è±¡ç±»ç”Ÿæˆå­ç±»ï¼Œä¸»è¦æ˜¯å®ç° Proxy ç±»çš„æŠ½è±¡æ–¹æ³•ã€‚ä¸‹é¢ä»¥ org.apache.dubbo.demo.DemoService è¿™ä¸ªæ¥å£ä¸ºä¾‹ï¼Œæ¥çœ‹ä¸€ä¸‹è¯¥æ¥å£ä»£ç†ç±»ä»£ç å¤§è‡´æ˜¯æ€æ ·çš„ï¼ˆå¿½ç•¥ EchoService æ¥å£ï¼‰ã€‚\npackage org.apache.dubbo.common.bytecode;\n\npublic class proxy0 implements org.apache.dubbo.demo.DemoService &#123;\n\n    public static java.lang.reflect.Method[] methods;\n\n    private java.lang.reflect.InvocationHandler handler;\n\n    public proxy0() &#123;\n    &#125;\n\n    public proxy0(java.lang.reflect.InvocationHandler arg0) &#123;\n        handler = $1;\n    &#125;\n\n    public java.lang.String sayHello(java.lang.String arg0) &#123;\n        Object[] args = new Object[1];\n        args[0] = ($w) $1;\n        Object ret = handler.invoke(this, methods[0], args);\n        return (java.lang.String) ret;\n    &#125;\n&#125;\n\n\n\nå¥½äº†ï¼Œåˆ°è¿™é‡Œä»£ç†ç±»ç”Ÿæˆé€»è¾‘å°±åˆ†æå®Œäº†ã€‚æ•´ä¸ªè¿‡ç¨‹æ¯”è¾ƒå¤æ‚ï¼Œå¤§å®¶éœ€è¦è€å¿ƒçœ‹ä¸€ä¸‹ã€‚\n\n4.æ€»ç»“æœ¬ç¯‡æ–‡ç« å¯¹æœåŠ¡å¼•ç”¨çš„è¿‡ç¨‹è¿›è¡Œäº†è¾ƒä¸ºè¯¦å°½çš„åˆ†æï¼Œè¿˜æœ‰ä¸€äº›é€»è¾‘æš‚æ—¶æ²¡æœ‰åˆ†æåˆ°ï¼Œæ¯”å¦‚ Directoryã€Clusterã€‚è¿™äº›æ¥å£åŠå®ç°ç±»åŠŸèƒ½æ¯”è¾ƒç‹¬ç«‹ï¼Œåç»­ä¼šå•ç‹¬æˆæ–‡è¿›è¡Œåˆ†æã€‚æš‚æ—¶æˆ‘ä»¬å¯ä»¥å…ˆæŠŠè¿™äº›ç±»çœ‹æˆé»‘ç›’ï¼Œåªè¦çŸ¥é“è¿™äº›ç±»çš„ç”¨é€”å³å¯ã€‚å…³äºæœåŠ¡å¼•ç”¨è¿‡ç¨‹å°±åˆ†æåˆ°è¿™é‡Œã€‚\n\n\n\n\n\n\n\n\n\nåŸæ–‡åœ°å€ï¼šhttps://dubbo.apache.org/zh/docsv2.7/dev/source/export-service/\nä½œè€…ï¼š Dubbo å®˜æ–¹\næœ¬æ–‡ä»‹ç»äº† Dubbo æœåŠ¡å¯¼å‡ºçš„è¿‡ç¨‹å’Œå®ç°ç»†èŠ‚\næœåŠ¡è°ƒç”¨è¿‡ç¨‹1.ç®€ä»‹æœ¬ç¯‡æ–‡ç« ï¼Œæˆ‘ä»¬æ¥ç ”ç©¶ä¸€ä¸‹ Dubbo å¯¼å‡ºæœåŠ¡çš„è¿‡ç¨‹ã€‚Dubbo æœåŠ¡å¯¼å‡ºè¿‡ç¨‹å§‹äº Spring å®¹å™¨å‘å¸ƒåˆ·æ–°äº‹ä»¶ï¼ŒDubbo åœ¨æ¥æ”¶åˆ°äº‹ä»¶åï¼Œä¼šç«‹å³æ‰§è¡ŒæœåŠ¡å¯¼å‡ºé€»è¾‘ã€‚æ•´ä¸ªé€»è¾‘å¤§è‡´å¯åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼Œç¬¬ä¸€éƒ¨åˆ†æ˜¯å‰ç½®å·¥ä½œï¼Œä¸»è¦ç”¨äºæ£€æŸ¥å‚æ•°ï¼Œç»„è£… URLã€‚ç¬¬äºŒéƒ¨åˆ†æ˜¯å¯¼å‡ºæœåŠ¡ï¼ŒåŒ…å«å¯¼å‡ºæœåŠ¡åˆ°æœ¬åœ° (JVM)ï¼Œå’Œå¯¼å‡ºæœåŠ¡åˆ°è¿œç¨‹ä¸¤ä¸ªè¿‡ç¨‹ã€‚ç¬¬ä¸‰éƒ¨åˆ†æ˜¯å‘æ³¨å†Œä¸­å¿ƒæ³¨å†ŒæœåŠ¡ï¼Œç”¨äºæœåŠ¡å‘ç°ã€‚æœ¬ç¯‡æ–‡ç« å°†ä¼šå¯¹è¿™ä¸‰ä¸ªéƒ¨åˆ†ä»£ç è¿›è¡Œè¯¦ç»†çš„åˆ†æã€‚\n\n2.æºç åˆ†ææœåŠ¡å¯¼å‡ºçš„å…¥å£æ–¹æ³•æ˜¯ ServiceBean çš„ onApplicationEventã€‚onApplicationEvent æ˜¯ä¸€ä¸ªäº‹ä»¶å“åº”æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šåœ¨æ”¶åˆ° Spring ä¸Šä¸‹æ–‡åˆ·æ–°äº‹ä»¶åæ‰§è¡ŒæœåŠ¡å¯¼å‡ºæ“ä½œã€‚æ–¹æ³•ä»£ç å¦‚ä¸‹ï¼š\npublic void onApplicationEvent(ContextRefreshedEvent event) &#123;\n    // æ˜¯å¦æœ‰å»¶è¿Ÿå¯¼å‡º &amp;&amp; æ˜¯å¦å·²å¯¼å‡º &amp;&amp; æ˜¯ä¸æ˜¯å·²è¢«å–æ¶ˆå¯¼å‡º\n    if (isDelay() &amp;&amp; !isExported() &amp;&amp; !isUnexported()) &#123;\n        // å¯¼å‡ºæœåŠ¡\n        export();\n    &#125;\n&#125;\n\n\n\nè¿™ä¸ªæ–¹æ³•é¦–å…ˆä¼šæ ¹æ®æ¡ä»¶å†³å®šæ˜¯å¦å¯¼å‡ºæœåŠ¡ï¼Œæ¯”å¦‚æœ‰äº›æœåŠ¡è®¾ç½®äº†å»¶æ—¶å¯¼å‡ºï¼Œé‚£ä¹ˆæ­¤æ—¶å°±ä¸åº”è¯¥åœ¨æ­¤å¤„å¯¼å‡ºã€‚è¿˜æœ‰ä¸€äº›æœåŠ¡å·²ç»è¢«å¯¼å‡ºäº†ï¼Œæˆ–è€…å½“å‰æœåŠ¡è¢«å–æ¶ˆå¯¼å‡ºäº†ï¼Œæ­¤æ—¶ä¹Ÿä¸èƒ½å†æ¬¡å¯¼å‡ºç›¸å…³æœåŠ¡ã€‚æ³¨æ„è¿™é‡Œçš„ isDelay æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å­—é¢æ„æ€æ˜¯â€œæ˜¯å¦å»¶è¿Ÿå¯¼å‡ºæœåŠ¡â€ï¼Œè¿”å› true è¡¨ç¤ºå»¶è¿Ÿå¯¼å‡ºï¼Œfalse è¡¨ç¤ºä¸å»¶è¿Ÿå¯¼å‡ºã€‚ä½†æ˜¯è¯¥æ–¹æ³•çœŸå®æ„æ€å´å¹¶éå¦‚æ­¤ï¼Œå½“æ–¹æ³•è¿”å› true æ—¶ï¼Œè¡¨ç¤ºæ— éœ€å»¶è¿Ÿå¯¼å‡ºã€‚è¿”å› false æ—¶ï¼Œè¡¨ç¤ºéœ€è¦å»¶è¿Ÿå¯¼å‡ºã€‚ä¸å­—é¢æ„æ€æ°æ°ç›¸åï¼Œè¿™ä¸ªéœ€è¦å¤§å®¶æ³¨æ„ä¸€ä¸‹ã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•çš„é€»è¾‘ã€‚\n// -â˜†- ServiceBean\nprivate boolean isDelay() &#123;\n    // è·å– delay\n    Integer delay = getDelay();\n    ProviderConfig provider = getProvider();\n    if (delay == null &amp;&amp; provider != null) &#123;\n        // å¦‚æœå‰é¢è·å–çš„ delay ä¸ºç©ºï¼Œè¿™é‡Œç»§ç»­è·å–\n        delay = provider.getDelay();\n    &#125;\n    // åˆ¤æ–­ delay æ˜¯å¦ä¸ºç©ºï¼Œæˆ–è€…ç­‰äº -1\n    return supportedApplicationListener &amp;&amp; (delay == null || delay == -1);\n&#125;\n\n\n\næš‚æ—¶å¿½ç•¥ supportedApplicationListener è¿™ä¸ªæ¡ä»¶ï¼Œå½“ delay ä¸ºç©ºï¼Œæˆ–è€…ç­‰äº-1æ—¶ï¼Œè¯¥æ–¹æ³•è¿”å› trueï¼Œè€Œä¸æ˜¯ falseã€‚è¿™ä¸ªæ–¹æ³•çš„è¿”å›å€¼è®©äººæœ‰ç‚¹å›°æƒ‘ã€‚è¯¥æ–¹æ³•ç›®å‰å·²è¢«é‡æ„ï¼Œè¯¦ç»†è¯·å‚è€ƒ dubbo #2686ã€‚\nç°åœ¨è§£é‡Šä¸€ä¸‹ supportedApplicationListener å˜é‡å«ä¹‰ï¼Œè¯¥å˜é‡ç”¨äºè¡¨ç¤ºå½“å‰çš„ Spring å®¹å™¨æ˜¯å¦æ”¯æŒ ApplicationListenerï¼Œè¿™ä¸ªå€¼åˆå§‹ä¸º falseã€‚åœ¨ Spring å®¹å™¨å°†è‡ªå·±è®¾ç½®åˆ° ServiceBean ä¸­æ—¶ï¼ŒServiceBean çš„ setApplicationContext æ–¹æ³•ä¼šæ£€æµ‹ Spring å®¹å™¨æ˜¯å¦æ”¯æŒ ApplicationListenerã€‚è‹¥æ”¯æŒï¼Œåˆ™å°† supportedApplicationListener ç½®ä¸º trueã€‚ServiceBean æ˜¯ Dubbo ä¸ Spring æ¡†æ¶è¿›è¡Œæ•´åˆçš„å…³é”®ï¼Œå¯ä»¥çœ‹åšæ˜¯ä¸¤ä¸ªæ¡†æ¶ä¹‹é—´çš„æ¡¥æ¢ã€‚å…·æœ‰åŒæ ·ä½œç”¨çš„ç±»è¿˜æœ‰ ReferenceBeanã€‚\nç°åœ¨æˆ‘ä»¬çŸ¥é“äº† Dubbo æœåŠ¡å¯¼å‡ºè¿‡ç¨‹çš„èµ·ç‚¹ï¼Œæ¥ä¸‹æ¥å¯¹æœåŠ¡å¯¼å‡ºçš„å‰ç½®é€»è¾‘è¿›è¡Œåˆ†æã€‚\n\n2.1 å‰ç½®å·¥ä½œå‰ç½®å·¥ä½œä¸»è¦åŒ…å«ä¸¤ä¸ªéƒ¨åˆ†ï¼Œåˆ†åˆ«æ˜¯é…ç½®æ£€æŸ¥ï¼Œä»¥åŠ URL è£…é…ã€‚åœ¨å¯¼å‡ºæœåŠ¡ä¹‹å‰ï¼ŒDubbo éœ€è¦æ£€æŸ¥ç”¨æˆ·çš„é…ç½®æ˜¯å¦åˆç†ï¼Œæˆ–è€…ä¸ºç”¨æˆ·è¡¥å……ç¼ºçœé…ç½®ã€‚é…ç½®æ£€æŸ¥å®Œæˆåï¼Œæ¥ä¸‹æ¥éœ€è¦æ ¹æ®è¿™äº›é…ç½®ç»„è£… URLã€‚åœ¨ Dubbo ä¸­ï¼ŒURL çš„ä½œç”¨ååˆ†é‡è¦ã€‚Dubbo ä½¿ç”¨ URL ä½œä¸ºé…ç½®è½½ä½“ï¼Œæ‰€æœ‰çš„æ‹“å±•ç‚¹éƒ½æ˜¯é€šè¿‡ URL è·å–é…ç½®ã€‚è¿™ä¸€ç‚¹ï¼Œå®˜æ–¹æ–‡æ¡£ä¸­æœ‰æ‰€è¯´æ˜ã€‚\n\n\n\n\n\n\n\n\n\né‡‡ç”¨ URL ä½œä¸ºé…ç½®ä¿¡æ¯çš„ç»Ÿä¸€æ ¼å¼ï¼Œæ‰€æœ‰æ‰©å±•ç‚¹éƒ½é€šè¿‡ä¼ é€’ URL æºå¸¦é…ç½®ä¿¡æ¯ã€‚\næ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å…ˆæ¥åˆ†æé…ç½®æ£€æŸ¥éƒ¨åˆ†çš„æºç ï¼Œéšåå†æ¥åˆ†æ URL ç»„è£…éƒ¨åˆ†çš„æºç ã€‚\n\n2.1.1 æ£€æŸ¥é…ç½®æœ¬èŠ‚æˆ‘ä»¬æ¥ç€å‰é¢çš„æºç å‘ä¸‹åˆ†æï¼Œå‰é¢è¯´è¿‡ onApplicationEvent æ–¹æ³•åœ¨ç»è¿‡ä¸€äº›åˆ¤æ–­åï¼Œä¼šå†³å®šæ˜¯å¦è°ƒç”¨ export æ–¹æ³•å¯¼å‡ºæœåŠ¡ã€‚é‚£ä¹ˆä¸‹é¢æˆ‘ä»¬ä» export æ–¹æ³•å¼€å§‹è¿›è¡Œåˆ†æï¼Œå¦‚ä¸‹ï¼š\npublic synchronized void export() &#123;\n    if (provider != null) &#123;\n        // è·å– export å’Œ delay é…ç½®\n        if (export == null) &#123;\n            export = provider.getExport();\n        &#125;\n        if (delay == null) &#123;\n            delay = provider.getDelay();\n        &#125;\n    &#125;\n    // å¦‚æœ export ä¸º falseï¼Œåˆ™ä¸å¯¼å‡ºæœåŠ¡\n    if (export != null &amp;&amp; !export) &#123;\n        return;\n    &#125;\n\n    // delay > 0ï¼Œå»¶æ—¶å¯¼å‡ºæœåŠ¡\n    if (delay != null &amp;&amp; delay > 0) &#123;\n        delayExportExecutor.schedule(new Runnable() &#123;\n            @Override\n            public void run() &#123;\n                doExport();\n            &#125;\n        &#125;, delay, TimeUnit.MILLISECONDS);\n        \n    // ç«‹å³å¯¼å‡ºæœåŠ¡\n    &#125; else &#123;\n        doExport();\n    &#125;\n&#125;\n\n\n\nexport æ–¹æ³•å¯¹ä¸¤é¡¹é…ç½®è¿›è¡Œäº†æ£€æŸ¥ï¼Œå¹¶æ ¹æ®é…ç½®æ‰§è¡Œç›¸åº”çš„åŠ¨ä½œã€‚é¦–å…ˆæ˜¯ export é…ç½®ï¼Œè¿™ä¸ªé…ç½®å†³å®šäº†æ˜¯å¦å¯¼å‡ºæœåŠ¡ã€‚æœ‰æ—¶å€™æˆ‘ä»¬åªæ˜¯æƒ³æœ¬åœ°å¯åŠ¨æœåŠ¡è¿›è¡Œä¸€äº›è°ƒè¯•å·¥ä½œï¼Œæˆ‘ä»¬å¹¶ä¸å¸Œæœ›æŠŠæœ¬åœ°å¯åŠ¨çš„æœåŠ¡æš´éœ²å‡ºå»ç»™åˆ«äººè°ƒç”¨ã€‚æ­¤æ—¶ï¼Œæˆ‘ä»¬å¯é€šè¿‡é…ç½® export ç¦æ­¢æœåŠ¡å¯¼å‡ºï¼Œæ¯”å¦‚ï¼š\n&lt;dubbo:provider export=\"false\" />\n\n\n\ndelay é…ç½®é¡¾åæ€ä¹‰ï¼Œç”¨äºå»¶è¿Ÿå¯¼å‡ºæœåŠ¡ï¼Œè¿™ä¸ªå°±ä¸åˆ†æäº†ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬ç»§ç»­åˆ†ææºç ï¼Œè¿™æ¬¡è¦åˆ†æçš„æ˜¯ doExport æ–¹æ³•ã€‚\nprotected synchronized void doExport() &#123;\n    if (unexported) &#123;\n        throw new IllegalStateException(\"Already unexported!\");\n    &#125;\n    if (exported) &#123;\n        return;\n    &#125;\n    exported = true;\n    // æ£€æµ‹ interfaceName æ˜¯å¦åˆæ³•\n    if (interfaceName == null || interfaceName.length() == 0) &#123;\n        throw new IllegalStateException(\"interface not allow null!\");\n    &#125;\n    // æ£€æµ‹ provider æ˜¯å¦ä¸ºç©ºï¼Œä¸ºç©ºåˆ™æ–°å»ºä¸€ä¸ªï¼Œå¹¶é€šè¿‡ç³»ç»Ÿå˜é‡ä¸ºå…¶åˆå§‹åŒ–\n    checkDefault();\n\n    // ä¸‹é¢å‡ ä¸ª if è¯­å¥ç”¨äºæ£€æµ‹ providerã€application ç­‰æ ¸å¿ƒé…ç½®ç±»å¯¹è±¡æ˜¯å¦ä¸ºç©ºï¼Œ\n    // è‹¥ä¸ºç©ºï¼Œåˆ™å°è¯•ä»å…¶ä»–é…ç½®ç±»å¯¹è±¡ä¸­è·å–ç›¸åº”çš„å®ä¾‹ã€‚\n    if (provider != null) &#123;\n        if (application == null) &#123;\n            application = provider.getApplication();\n        &#125;\n        if (module == null) &#123;\n            module = provider.getModule();\n        &#125;\n        if (registries == null) &#123;...&#125;\n        if (monitor == null) &#123;...&#125;\n        if (protocols == null) &#123;...&#125;\n    &#125;\n    if (module != null) &#123;\n        if (registries == null) &#123;\n            registries = module.getRegistries();\n        &#125;\n        if (monitor == null) &#123;...&#125;\n    &#125;\n    if (application != null) &#123;\n        if (registries == null) &#123;\n            registries = application.getRegistries();\n        &#125;\n        if (monitor == null) &#123;...&#125;\n    &#125;\n\n    // æ£€æµ‹ ref æ˜¯å¦ä¸ºæ³›åŒ–æœåŠ¡ç±»å‹\n    if (ref instanceof GenericService) &#123;\n        // è®¾ç½® interfaceClass ä¸º GenericService.class\n        interfaceClass = GenericService.class;\n        if (StringUtils.isEmpty(generic)) &#123;\n            // è®¾ç½® generic = \"true\"\n            generic = Boolean.TRUE.toString();\n        &#125;\n        \n    // ref é GenericService ç±»å‹\n    &#125; else &#123;\n        try &#123;\n            interfaceClass = Class.forName(interfaceName, true, Thread.currentThread()\n                    .getContextClassLoader());\n        &#125; catch (ClassNotFoundException e) &#123;\n            throw new IllegalStateException(e.getMessage(), e);\n        &#125;\n        // å¯¹ interfaceClassï¼Œä»¥åŠ &lt;dubbo:method> æ ‡ç­¾ä¸­çš„å¿…è¦å­—æ®µè¿›è¡Œæ£€æŸ¥\n        checkInterfaceAndMethods(interfaceClass, methods);\n        // å¯¹ ref åˆæ³•æ€§è¿›è¡Œæ£€æµ‹\n        checkRef();\n        // è®¾ç½® generic = \"false\"\n        generic = Boolean.FALSE.toString();\n    &#125;\n\n    // local å’Œ stub åœ¨åŠŸèƒ½åº”è¯¥æ˜¯ä¸€è‡´çš„ï¼Œç”¨äºé…ç½®æœ¬åœ°å­˜æ ¹\n    if (local != null) &#123;\n        if (\"true\".equals(local)) &#123;\n            local = interfaceName + \"Local\";\n        &#125;\n        Class&lt;?> localClass;\n        try &#123;\n            // è·å–æœ¬åœ°å­˜æ ¹ç±»\n            localClass = ClassHelper.forNameWithThreadContextClassLoader(local);\n        &#125; catch (ClassNotFoundException e) &#123;\n            throw new IllegalStateException(e.getMessage(), e);\n        &#125;\n        // æ£€æµ‹æœ¬åœ°å­˜æ ¹ç±»æ˜¯å¦å¯èµ‹å€¼ç»™æ¥å£ç±»ï¼Œè‹¥ä¸å¯èµ‹å€¼åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œæé†’ä½¿ç”¨è€…æœ¬åœ°å­˜æ ¹ç±»ç±»å‹ä¸åˆæ³•\n        if (!interfaceClass.isAssignableFrom(localClass)) &#123;\n            throw new IllegalStateException(\"The local implementation class \" + localClass.getName() + \" not implement interface \" + interfaceName);\n        &#125;\n    &#125;\n\n    if (stub != null) &#123;\n        // æ­¤å¤„çš„ä»£ç å’Œä¸Šä¸€ä¸ª if åˆ†æ”¯çš„ä»£ç åŸºæœ¬ä¸€è‡´ï¼Œè¿™é‡Œçœç•¥\n    &#125;\n\n    // æ£€æµ‹å„ç§å¯¹è±¡æ˜¯å¦ä¸ºç©ºï¼Œä¸ºç©ºåˆ™æ–°å»ºï¼Œæˆ–è€…æŠ›å‡ºå¼‚å¸¸\n    checkApplication();\n    checkRegistry();\n    checkProtocol();\n    appendProperties(this);\n    checkStubAndMock(interfaceClass);\n    if (path == null || path.length() == 0) &#123;\n        path = interfaceName;\n    &#125;\n\n    // å¯¼å‡ºæœåŠ¡\n    doExportUrls();\n\n    // ProviderModel è¡¨ç¤ºæœåŠ¡æä¾›è€…æ¨¡å‹ï¼Œæ­¤å¯¹è±¡ä¸­å­˜å‚¨äº†ä¸æœåŠ¡æä¾›è€…ç›¸å…³çš„ä¿¡æ¯ã€‚\n    // æ¯”å¦‚æœåŠ¡çš„é…ç½®ä¿¡æ¯ï¼ŒæœåŠ¡å®ä¾‹ç­‰ã€‚æ¯ä¸ªè¢«å¯¼å‡ºçš„æœåŠ¡å¯¹åº”ä¸€ä¸ª ProviderModelã€‚\n    // ApplicationModel æŒæœ‰æ‰€æœ‰çš„ ProviderModelã€‚\n    ProviderModel providerModel = new ProviderModel(getUniqueServiceName(), this, ref);\n    ApplicationModel.initProviderModel(getUniqueServiceName(), providerModel);\n&#125;\n\n\n\nä»¥ä¸Šå°±æ˜¯é…ç½®æ£€æŸ¥çš„ç›¸å…³åˆ†æï¼Œä»£ç æ¯”è¾ƒå¤šï¼Œéœ€è¦å¤§å®¶è€å¿ƒçœ‹ä¸€ä¸‹ã€‚ä¸‹é¢å¯¹é…ç½®æ£€æŸ¥çš„é€»è¾‘è¿›è¡Œç®€å•çš„æ€»ç»“ï¼Œå¦‚ä¸‹ï¼š\n\næ£€æµ‹ dubbo:service æ ‡ç­¾çš„ interface å±æ€§åˆæ³•æ€§ï¼Œä¸åˆæ³•åˆ™æŠ›å‡ºå¼‚å¸¸\næ£€æµ‹ ProviderConfigã€ApplicationConfig ç­‰æ ¸å¿ƒé…ç½®ç±»å¯¹è±¡æ˜¯å¦ä¸ºç©ºï¼Œè‹¥ä¸ºç©ºï¼Œåˆ™å°è¯•ä»å…¶ä»–é…ç½®ç±»å¯¹è±¡ä¸­è·å–ç›¸åº”çš„å®ä¾‹ã€‚\næ£€æµ‹å¹¶å¤„ç†æ³›åŒ–æœåŠ¡å’Œæ™®é€šæœåŠ¡ç±»\næ£€æµ‹æœ¬åœ°å­˜æ ¹é…ç½®ï¼Œå¹¶è¿›è¡Œç›¸åº”çš„å¤„ç†\nå¯¹ ApplicationConfigã€RegistryConfig ç­‰é…ç½®ç±»è¿›è¡Œæ£€æµ‹ï¼Œä¸ºç©ºåˆ™å°è¯•åˆ›å»ºï¼Œè‹¥æ— æ³•åˆ›å»ºåˆ™æŠ›å‡ºå¼‚å¸¸\n\né…ç½®æ£€æŸ¥å¹¶éæœ¬æ–‡é‡ç‚¹ï¼Œå› æ­¤è¿™é‡Œä¸æ‰“ç®—å¯¹ doExport æ–¹æ³•æ‰€è°ƒç”¨çš„æ–¹æ³•è¿›è¡Œåˆ†æï¼ˆdoExportUrls æ–¹æ³•é™¤å¤–ï¼‰ã€‚åœ¨è¿™äº›æ–¹æ³•ä¸­ï¼Œé™¤äº† appendProperties æ–¹æ³•ç¨å¾®å¤æ‚ä¸€äº›ï¼Œå…¶ä»–æ–¹æ³•é€»è¾‘ä¸æ˜¯å¾ˆå¤æ‚ã€‚å› æ­¤ï¼Œå¤§å®¶å¯è‡ªè¡Œåˆ†æã€‚\n\n2.1.2 å¤šåè®®å¤šæ³¨å†Œä¸­å¿ƒå¯¼å‡ºæœåŠ¡Dubbo å…è®¸æˆ‘ä»¬ä½¿ç”¨ä¸åŒçš„åè®®å¯¼å‡ºæœåŠ¡ï¼Œä¹Ÿå…è®¸æˆ‘ä»¬å‘å¤šä¸ªæ³¨å†Œä¸­å¿ƒæ³¨å†ŒæœåŠ¡ã€‚Dubbo åœ¨ doExportUrls æ–¹æ³•ä¸­å¯¹å¤šåè®®ï¼Œå¤šæ³¨å†Œä¸­å¿ƒè¿›è¡Œäº†æ”¯æŒã€‚ç›¸å…³ä»£ç å¦‚ä¸‹ï¼š\nprivate void doExportUrls() &#123;\n    // åŠ è½½æ³¨å†Œä¸­å¿ƒé“¾æ¥\n    List&lt;URL> registryURLs = loadRegistries(true);\n    // éå† protocolsï¼Œå¹¶åœ¨æ¯ä¸ªåè®®ä¸‹å¯¼å‡ºæœåŠ¡\n    for (ProtocolConfig protocolConfig : protocols) &#123;\n        doExportUrlsFor1Protocol(protocolConfig, registryURLs);\n    &#125;\n&#125;\n\n\n\nä¸Šé¢ä»£ç é¦–å…ˆæ˜¯é€šè¿‡ loadRegistries åŠ è½½æ³¨å†Œä¸­å¿ƒé“¾æ¥ï¼Œç„¶åå†éå† ProtocolConfig é›†åˆå¯¼å‡ºæ¯ä¸ªæœåŠ¡ã€‚å¹¶åœ¨å¯¼å‡ºæœåŠ¡çš„è¿‡ç¨‹ä¸­ï¼Œå°†æœåŠ¡æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹ loadRegistries æ–¹æ³•çš„é€»è¾‘ã€‚\nprotected List&lt;URL> loadRegistries(boolean provider) &#123;\n    // æ£€æµ‹æ˜¯å¦å­˜åœ¨æ³¨å†Œä¸­å¿ƒé…ç½®ç±»ï¼Œä¸å­˜åœ¨åˆ™æŠ›å‡ºå¼‚å¸¸\n    checkRegistry();\n    List&lt;URL> registryList = new ArrayList&lt;URL>();\n    if (registries != null &amp;&amp; !registries.isEmpty()) &#123;\n        for (RegistryConfig config : registries) &#123;\n            String address = config.getAddress();\n            if (address == null || address.length() == 0) &#123;\n                // è‹¥ address ä¸ºç©ºï¼Œåˆ™å°†å…¶è®¾ä¸º 0.0.0.0\n                address = Constants.ANYHOST_VALUE;\n            &#125;\n\n            // ä»ç³»ç»Ÿå±æ€§ä¸­åŠ è½½æ³¨å†Œä¸­å¿ƒåœ°å€\n            String sysaddress = System.getProperty(\"dubbo.registry.address\");\n            if (sysaddress != null &amp;&amp; sysaddress.length() > 0) &#123;\n                address = sysaddress;\n            &#125;\n            // æ£€æµ‹ address æ˜¯å¦åˆæ³•\n            if (address.length() > 0 &amp;&amp; !RegistryConfig.NO_AVAILABLE.equalsIgnoreCase(address)) &#123;\n                Map&lt;String, String> map = new HashMap&lt;String, String>();\n                // æ·»åŠ  ApplicationConfig ä¸­çš„å­—æ®µä¿¡æ¯åˆ° map ä¸­\n                appendParameters(map, application);\n                // æ·»åŠ  RegistryConfig å­—æ®µä¿¡æ¯åˆ° map ä¸­\n                appendParameters(map, config);\n                \n                // æ·»åŠ  pathã€pidï¼Œprotocol ç­‰ä¿¡æ¯åˆ° map ä¸­\n                map.put(\"path\", RegistryService.class.getName());\n                map.put(\"dubbo\", Version.getProtocolVersion());\n                map.put(Constants.TIMESTAMP_KEY, String.valueOf(System.currentTimeMillis()));\n                if (ConfigUtils.getPid() > 0) &#123;\n                    map.put(Constants.PID_KEY, String.valueOf(ConfigUtils.getPid()));\n                &#125;\n                if (!map.containsKey(\"protocol\")) &#123;\n                    if (ExtensionLoader.getExtensionLoader(RegistryFactory.class).hasExtension(\"remote\")) &#123;\n                        map.put(\"protocol\", \"remote\");\n                    &#125; else &#123;\n                        map.put(\"protocol\", \"dubbo\");\n                    &#125;\n                &#125;\n\n                // è§£æå¾—åˆ° URL åˆ—è¡¨ï¼Œaddress å¯èƒ½åŒ…å«å¤šä¸ªæ³¨å†Œä¸­å¿ƒ ipï¼Œ\n                // å› æ­¤è§£æå¾—åˆ°çš„æ˜¯ä¸€ä¸ª URL åˆ—è¡¨\n                List&lt;URL> urls = UrlUtils.parseURLs(address, map);\n                for (URL url : urls) &#123;\n                    url = url.addParameter(Constants.REGISTRY_KEY, url.getProtocol());\n                    // å°† URL åè®®å¤´è®¾ç½®ä¸º registry\n                    url = url.setProtocol(Constants.REGISTRY_PROTOCOL);\n                    // é€šè¿‡åˆ¤æ–­æ¡ä»¶ï¼Œå†³å®šæ˜¯å¦æ·»åŠ  url åˆ° registryList ä¸­ï¼Œæ¡ä»¶å¦‚ä¸‹ï¼š\n                    // (æœåŠ¡æä¾›è€… &amp;&amp; register = true æˆ– null) \n                    //    || (éæœåŠ¡æä¾›è€… &amp;&amp; subscribe = true æˆ– null)\n                    if ((provider &amp;&amp; url.getParameter(Constants.REGISTER_KEY, true))\n                            || (!provider &amp;&amp; url.getParameter(Constants.SUBSCRIBE_KEY, true))) &#123;\n                        registryList.add(url);\n                    &#125;\n                &#125;\n            &#125;\n        &#125;\n    &#125;\n    return registryList;\n&#125;\n\n\n\nloadRegistries æ–¹æ³•ä¸»è¦åŒ…å«å¦‚ä¸‹çš„é€»è¾‘ï¼š\n\næ£€æµ‹æ˜¯å¦å­˜åœ¨æ³¨å†Œä¸­å¿ƒé…ç½®ç±»ï¼Œä¸å­˜åœ¨åˆ™æŠ›å‡ºå¼‚å¸¸\næ„å»ºå‚æ•°æ˜ å°„é›†åˆï¼Œä¹Ÿå°±æ˜¯ map\næ„å»ºæ³¨å†Œä¸­å¿ƒé“¾æ¥åˆ—è¡¨\néå†é“¾æ¥åˆ—è¡¨ï¼Œå¹¶æ ¹æ®æ¡ä»¶å†³å®šæ˜¯å¦å°†å…¶æ·»åŠ åˆ° registryList ä¸­\n\nå…³äºå¤šåè®®å¤šæ³¨å†Œä¸­å¿ƒå¯¼å‡ºæœåŠ¡å°±å…ˆåˆ†æåˆ°è¿™ï¼Œä»£ç ä¸æ˜¯å¾ˆå¤šï¼Œæ¥ä¸‹æ¥åˆ†æ URL ç»„è£…è¿‡ç¨‹ã€‚\n\n2.1.3 ç»„è£… URLé…ç½®æ£€æŸ¥å®Œæ¯•åï¼Œç´§æ¥ç€è¦åšçš„äº‹æƒ…æ˜¯æ ¹æ®é…ç½®ï¼Œä»¥åŠå…¶ä»–ä¸€äº›ä¿¡æ¯ç»„è£… URLã€‚å‰é¢è¯´è¿‡ï¼ŒURL æ˜¯ Dubbo é…ç½®çš„è½½ä½“ï¼Œé€šè¿‡ URL å¯è®© Dubbo çš„å„ç§é…ç½®åœ¨å„ä¸ªæ¨¡å—ä¹‹é—´ä¼ é€’ã€‚URL ä¹‹äº Dubboï¼ŒçŠ¹å¦‚æ°´ä¹‹äºé±¼ï¼Œéå¸¸é‡è¦ã€‚å¤§å®¶åœ¨é˜…è¯» Dubbo æœåŠ¡å¯¼å‡ºç›¸å…³æºç çš„è¿‡ç¨‹ä¸­ï¼Œè¦æ³¨æ„ URL å†…å®¹çš„å˜åŒ–ã€‚æ—¢ç„¶ URL å¦‚æ­¤é‡è¦ï¼Œé‚£ä¹ˆä¸‹é¢æˆ‘ä»¬æ¥äº†è§£ä¸€ä¸‹ URL ç»„è£…çš„è¿‡ç¨‹ã€‚\nprivate void doExportUrlsFor1Protocol(ProtocolConfig protocolConfig, List&lt;URL> registryURLs) &#123;\n    String name = protocolConfig.getName();\n    // å¦‚æœåè®®åä¸ºç©ºï¼Œæˆ–ç©ºä¸²ï¼Œåˆ™å°†åè®®åå˜é‡è®¾ç½®ä¸º dubbo\n    if (name == null || name.length() == 0) &#123;\n        name = \"dubbo\";\n    &#125;\n\n    Map&lt;String, String> map = new HashMap&lt;String, String>();\n    // æ·»åŠ  sideã€ç‰ˆæœ¬ã€æ—¶é—´æˆ³ä»¥åŠè¿›ç¨‹å·ç­‰ä¿¡æ¯åˆ° map ä¸­\n    map.put(Constants.SIDE_KEY, Constants.PROVIDER_SIDE);\n    map.put(Constants.DUBBO_VERSION_KEY, Version.getProtocolVersion());\n    map.put(Constants.TIMESTAMP_KEY, String.valueOf(System.currentTimeMillis()));\n    if (ConfigUtils.getPid() > 0) &#123;\n        map.put(Constants.PID_KEY, String.valueOf(ConfigUtils.getPid()));\n    &#125;\n\n    // é€šè¿‡åå°„å°†å¯¹è±¡çš„å­—æ®µä¿¡æ¯æ·»åŠ åˆ° map ä¸­\n    appendParameters(map, application);\n    appendParameters(map, module);\n    appendParameters(map, provider, Constants.DEFAULT_KEY);\n    appendParameters(map, protocolConfig);\n    appendParameters(map, this);\n\n    // methods ä¸º MethodConfig é›†åˆï¼ŒMethodConfig ä¸­å­˜å‚¨äº† &lt;dubbo:method> æ ‡ç­¾çš„é…ç½®ä¿¡æ¯\n    if (methods != null &amp;&amp; !methods.isEmpty()) &#123;\n        // è¿™æ®µä»£ç ç”¨äºæ·»åŠ  Callback é…ç½®åˆ° map ä¸­ï¼Œä»£ç å¤ªé•¿ï¼Œå¾…ä¼šå•ç‹¬åˆ†æ\n    &#125;\n\n    // æ£€æµ‹ generic æ˜¯å¦ä¸º \"true\"ï¼Œå¹¶æ ¹æ®æ£€æµ‹ç»“æœå‘ map ä¸­æ·»åŠ ä¸åŒçš„ä¿¡æ¯\n    if (ProtocolUtils.isGeneric(generic)) &#123;\n        map.put(Constants.GENERIC_KEY, generic);\n        map.put(Constants.METHODS_KEY, Constants.ANY_VALUE);\n    &#125; else &#123;\n        String revision = Version.getVersion(interfaceClass, version);\n        if (revision != null &amp;&amp; revision.length() > 0) &#123;\n            map.put(\"revision\", revision);\n        &#125;\n\n        // ä¸ºæ¥å£ç”ŸæˆåŒ…è£¹ç±» Wrapperï¼ŒWrapper ä¸­åŒ…å«äº†æ¥å£çš„è¯¦ç»†ä¿¡æ¯ï¼Œæ¯”å¦‚æ¥å£æ–¹æ³•åæ•°ç»„ï¼Œå­—æ®µä¿¡æ¯ç­‰\n        String[] methods = Wrapper.getWrapper(interfaceClass).getMethodNames();\n        // æ·»åŠ æ–¹æ³•ååˆ° map ä¸­ï¼Œå¦‚æœåŒ…å«å¤šä¸ªæ–¹æ³•åï¼Œåˆ™ç”¨é€—å·éš”å¼€ï¼Œæ¯”å¦‚ method = init,destroy\n        if (methods.length == 0) &#123;\n            logger.warn(\"NO method found in service interface ...\");\n            map.put(Constants.METHODS_KEY, Constants.ANY_VALUE);\n        &#125; else &#123;\n            // å°†é€—å·ä½œä¸ºåˆ†éš”ç¬¦è¿æ¥æ–¹æ³•åï¼Œå¹¶å°†è¿æ¥åçš„å­—ç¬¦ä¸²æ”¾å…¥ map ä¸­\n            map.put(Constants.METHODS_KEY, StringUtils.join(new HashSet&lt;String>(Arrays.asList(methods)), \",\"));\n        &#125;\n    &#125;\n\n    // æ·»åŠ  token åˆ° map ä¸­\n    if (!ConfigUtils.isEmpty(token)) &#123;\n        if (ConfigUtils.isDefault(token)) &#123;\n            // éšæœºç”Ÿæˆ token\n            map.put(Constants.TOKEN_KEY, UUID.randomUUID().toString());\n        &#125; else &#123;\n            map.put(Constants.TOKEN_KEY, token);\n        &#125;\n    &#125;\n    // åˆ¤æ–­åè®®åæ˜¯å¦ä¸º injvm\n    if (Constants.LOCAL_PROTOCOL.equals(protocolConfig.getName())) &#123;\n        protocolConfig.setRegister(false);\n        map.put(\"notify\", \"false\");\n    &#125;\n\n    // è·å–ä¸Šä¸‹æ–‡è·¯å¾„\n    String contextPath = protocolConfig.getContextpath();\n    if ((contextPath == null || contextPath.length() == 0) &amp;&amp; provider != null) &#123;\n        contextPath = provider.getContextpath();\n    &#125;\n\n    // è·å– host å’Œ port\n    String host = this.findConfigedHosts(protocolConfig, registryURLs, map);\n    Integer port = this.findConfigedPorts(protocolConfig, name, map);\n    // ç»„è£… URL\n    URL url = new URL(name, host, port, (contextPath == null || contextPath.length() == 0 ? \"\" : contextPath + \"/\") + path, map);\n    \n    // çœç•¥æ— å…³ä»£ç \n&#125;\n\n\n\nä¸Šé¢çš„ä»£ç é¦–å…ˆæ˜¯å°†ä¸€äº›ä¿¡æ¯ï¼Œæ¯”å¦‚ç‰ˆæœ¬ã€æ—¶é—´æˆ³ã€æ–¹æ³•åä»¥åŠå„ç§é…ç½®å¯¹è±¡çš„å­—æ®µä¿¡æ¯æ”¾å…¥åˆ° map ä¸­ï¼Œmap ä¸­çš„å†…å®¹å°†ä½œä¸º URL çš„æŸ¥è¯¢å­—ç¬¦ä¸²ã€‚æ„å»ºå¥½ map åï¼Œç´§æ¥ç€æ˜¯è·å–ä¸Šä¸‹æ–‡è·¯å¾„ã€ä¸»æœºåä»¥åŠç«¯å£å·ç­‰ä¿¡æ¯ã€‚æœ€åå°† map å’Œä¸»æœºåç­‰æ•°æ®ä¼ ç»™ URL æ„é€ æ–¹æ³•åˆ›å»º URL å¯¹è±¡ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œå‡ºç°çš„ URL å¹¶é java.net.URLï¼Œè€Œæ˜¯ com.alibaba.dubbo.common.URLã€‚\nä¸Šé¢çœç•¥äº†ä¸€æ®µä»£ç ï¼Œè¿™é‡Œç®€å•åˆ†æä¸€ä¸‹ã€‚è¿™æ®µä»£ç ç”¨äºæ£€æµ‹ dubbo:method æ ‡ç­¾ä¸­çš„é…ç½®ä¿¡æ¯ï¼Œå¹¶å°†ç›¸å…³é…ç½®æ·»åŠ åˆ° map ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š\nprivate void doExportUrlsFor1Protocol(ProtocolConfig protocolConfig, List&lt;URL> registryURLs) &#123;\n    // ...\n\n    // methods ä¸º MethodConfig é›†åˆï¼ŒMethodConfig ä¸­å­˜å‚¨äº† &lt;dubbo:method> æ ‡ç­¾çš„é…ç½®ä¿¡æ¯\n    if (methods != null &amp;&amp; !methods.isEmpty()) &#123;\n        for (MethodConfig method : methods) &#123;\n            // æ·»åŠ  MethodConfig å¯¹è±¡çš„å­—æ®µä¿¡æ¯åˆ° map ä¸­ï¼Œé”® = æ–¹æ³•å.å±æ€§åã€‚\n            // æ¯”å¦‚å­˜å‚¨ &lt;dubbo:method name=\"sayHello\" retries=\"2\"> å¯¹åº”çš„ MethodConfigï¼Œ\n            // é”® = sayHello.retriesï¼Œmap = &#123;\"sayHello.retries\": 2, \"xxx\": \"yyy\"&#125;\n            appendParameters(map, method, method.getName());\n\n            String retryKey = method.getName() + \".retry\";\n            if (map.containsKey(retryKey)) &#123;\n                String retryValue = map.remove(retryKey);\n                // æ£€æµ‹ MethodConfig retry æ˜¯å¦ä¸º falseï¼Œè‹¥æ˜¯ï¼Œåˆ™è®¾ç½®é‡è¯•æ¬¡æ•°ä¸º0\n                if (\"false\".equals(retryValue)) &#123;\n                    map.put(method.getName() + \".retries\", \"0\");\n                &#125;\n            &#125;\n            \n            // è·å– ArgumentConfig åˆ—è¡¨\n            List&lt;ArgumentConfig> arguments = method.getArguments();\n            if (arguments != null &amp;&amp; !arguments.isEmpty()) &#123;\n                for (ArgumentConfig argument : arguments) &#123;\n                    // æ£€æµ‹ type å±æ€§æ˜¯å¦ä¸ºç©ºï¼Œæˆ–è€…ç©ºä¸²ï¼ˆåˆ†æ”¯1 â­ï¸ï¼‰\n                    if (argument.getType() != null &amp;&amp; argument.getType().length() > 0) &#123;\n                        Method[] methods = interfaceClass.getMethods();\n                        if (methods != null &amp;&amp; methods.length > 0) &#123;\n                            for (int i = 0; i &lt; methods.length; i++) &#123;\n                                String methodName = methods[i].getName();\n                                // æ¯”å¯¹æ–¹æ³•åï¼ŒæŸ¥æ‰¾ç›®æ ‡æ–¹æ³•\n                                if (methodName.equals(method.getName())) &#123;\n                                    Class&lt;?>[] argtypes = methods[i].getParameterTypes();\n                                    if (argument.getIndex() != -1) &#123;\n                                        // æ£€æµ‹ ArgumentConfig ä¸­çš„ type å±æ€§ä¸æ–¹æ³•å‚æ•°åˆ—è¡¨\n                                        // ä¸­çš„å‚æ•°åç§°æ˜¯å¦ä¸€è‡´ï¼Œä¸ä¸€è‡´åˆ™æŠ›å‡ºå¼‚å¸¸(åˆ†æ”¯2 â­ï¸)\n                                        if (argtypes[argument.getIndex()].getName().equals(argument.getType())) &#123;\n                                            // æ·»åŠ  ArgumentConfig å­—æ®µä¿¡æ¯åˆ° map ä¸­ï¼Œ\n                                            // é”®å‰ç¼€ = æ–¹æ³•å.indexï¼Œæ¯”å¦‚:\n                                            // map = &#123;\"sayHello.3\": true&#125;\n                                            appendParameters(map, argument, method.getName() + \".\" + argument.getIndex());\n                                        &#125; else &#123;\n                                            throw new IllegalArgumentException(\"argument config error: ...\");\n                                        &#125;\n                                    &#125; else &#123;    // åˆ†æ”¯3 â­ï¸\n                                        for (int j = 0; j &lt; argtypes.length; j++) &#123;\n                                            Class&lt;?> argclazz = argtypes[j];\n                                            // ä»å‚æ•°ç±»å‹åˆ—è¡¨ä¸­æŸ¥æ‰¾ç±»å‹åç§°ä¸º argument.type çš„å‚æ•°\n                                            if (argclazz.getName().equals(argument.getType())) &#123;\n                                                appendParameters(map, argument, method.getName() + \".\" + j);\n                                                if (argument.getIndex() != -1 &amp;&amp; argument.getIndex() != j) &#123;\n                                                    throw new IllegalArgumentException(\"argument config error: ...\");\n                                                &#125;\n                                            &#125;\n                                        &#125;\n                                    &#125;\n                                &#125;\n                            &#125;\n                        &#125;\n\n                    // ç”¨æˆ·æœªé…ç½® type å±æ€§ï¼Œä½†é…ç½®äº† index å±æ€§ï¼Œä¸” index != -1\n                    &#125; else if (argument.getIndex() != -1) &#123;    // åˆ†æ”¯4 â­ï¸\n                        // æ·»åŠ  ArgumentConfig å­—æ®µä¿¡æ¯åˆ° map ä¸­\n                        appendParameters(map, argument, method.getName() + \".\" + argument.getIndex());\n                    &#125; else &#123;\n                        throw new IllegalArgumentException(\"argument config must set index or type\");\n                    &#125;\n                &#125;\n            &#125;\n        &#125;\n    &#125;\n\n    // ...\n&#125;\n\n\n\nä¸Šé¢è¿™æ®µä»£ç  for å¾ªç¯å’Œ if else åˆ†æ”¯åµŒå¥—å¤ªå¤šï¼Œå¯¼è‡´å±‚æ¬¡å¤ªæ·±ï¼Œä¸åˆ©äºé˜…è¯»ï¼Œéœ€è¦è€å¿ƒçœ‹ä¸€ä¸‹ã€‚å¤§å®¶åœ¨çœ‹è¿™æ®µä»£ç æ—¶ï¼Œæ³¨æ„æŠŠå‡ ä¸ªé‡è¦çš„æ¡ä»¶åˆ†æ”¯æ‰¾å‡ºæ¥ã€‚åªè¦ç†è§£äº†è¿™å‡ ä¸ªåˆ†æ”¯çš„æ„å›¾ï¼Œå°±å¯ä»¥å¼„æ‡‚è¿™æ®µä»£ç ã€‚è¯·æ³¨æ„ä¸Šé¢ä»£ç ä¸­â­ï¸ç¬¦å·ï¼Œè¿™å‡ ä¸ªç¬¦å·æ ‡è¯†å‡ºäº†4ä¸ªé‡è¦çš„åˆ†æ”¯ï¼Œä¸‹é¢ç”¨ä¼ªä»£ç è§£é‡Šä¸€ä¸‹è¿™å‡ ä¸ªåˆ†æ”¯çš„å«ä¹‰ã€‚\n// è·å– ArgumentConfig åˆ—è¡¨\nfor (éå† ArgumentConfig åˆ—è¡¨) &#123;\n    if (type ä¸ä¸º nullï¼Œä¹Ÿä¸ä¸ºç©ºä¸²) &#123;    // åˆ†æ”¯1\n        1. é€šè¿‡åå°„è·å– interfaceClass çš„æ–¹æ³•åˆ—è¡¨\n        for (éå†æ–¹æ³•åˆ—è¡¨) &#123;\n            1. æ¯”å¯¹æ–¹æ³•åï¼ŒæŸ¥æ‰¾ç›®æ ‡æ–¹æ³•\n        \t2. é€šè¿‡åå°„è·å–ç›®æ ‡æ–¹æ³•çš„å‚æ•°ç±»å‹æ•°ç»„ argtypes\n            if (index != -1) &#123;    // åˆ†æ”¯2\n                1. ä» argtypes æ•°ç»„ä¸­è·å–ä¸‹æ ‡ index å¤„çš„å…ƒç´  argType\n                2. æ£€æµ‹ argType çš„åç§°ä¸ ArgumentConfig ä¸­çš„ type å±æ€§æ˜¯å¦ä¸€è‡´\n                3. æ·»åŠ  ArgumentConfig å­—æ®µä¿¡æ¯åˆ° map ä¸­ï¼Œæˆ–æŠ›å‡ºå¼‚å¸¸\n            &#125; else &#123;    // åˆ†æ”¯3\n                1. éå†å‚æ•°ç±»å‹æ•°ç»„ argtypesï¼ŒæŸ¥æ‰¾ argument.type ç±»å‹çš„å‚æ•°\n                2. æ·»åŠ  ArgumentConfig å­—æ®µä¿¡æ¯åˆ° map ä¸­\n            &#125;\n        &#125;\n    &#125; else if (index != -1) &#123;    // åˆ†æ”¯4\n\t\t1. æ·»åŠ  ArgumentConfig å­—æ®µä¿¡æ¯åˆ° map ä¸­\n    &#125;\n&#125;\n\n\n\nåœ¨æœ¬èŠ‚åˆ†æçš„æºç ä¸­ï¼ŒappendParameters è¿™ä¸ªæ–¹æ³•å‡ºç°çš„æ¬¡æ•°æ¯”è¾ƒå¤šï¼Œè¯¥æ–¹æ³•ç”¨äºå°†å¯¹è±¡å­—æ®µä¿¡æ¯æ·»åŠ åˆ° map ä¸­ã€‚å®ç°ä¸Šåˆ™æ˜¯é€šè¿‡åå°„è·å–ç›®æ ‡å¯¹è±¡çš„ getter æ–¹æ³•ï¼Œå¹¶è°ƒç”¨è¯¥æ–¹æ³•è·å–å±æ€§å€¼ã€‚ç„¶åå†é€šè¿‡ getter æ–¹æ³•åè§£æå‡ºå±æ€§åï¼Œæ¯”å¦‚ä»æ–¹æ³•å getName ä¸­å¯è§£æå‡ºå±æ€§ nameã€‚å¦‚æœç”¨æˆ·ä¼ å…¥äº†å±æ€§åå‰ç¼€ï¼Œæ­¤æ—¶éœ€è¦å°†å±æ€§ååŠ å…¥å‰ç¼€å†…å®¹ã€‚æœ€åå°† &lt;å±æ€§åï¼Œå±æ€§å€¼&gt; é”®å€¼å¯¹å­˜å…¥åˆ° map ä¸­å°±è¡Œäº†ã€‚é™äºç¯‡å¹…åŸå› ï¼Œè¿™é‡Œå°±ä¸åˆ†æ appendParameters æ–¹æ³•çš„æºç äº†ï¼Œå¤§å®¶è¯·è‡ªè¡Œåˆ†æã€‚\n\n2.2 å¯¼å‡º Dubbo æœåŠ¡å‰ç½®å·¥ä½œåšå®Œï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥è¿›è¡ŒæœåŠ¡å¯¼å‡ºäº†ã€‚æœåŠ¡å¯¼å‡ºåˆ†ä¸ºå¯¼å‡ºåˆ°æœ¬åœ° (JVM)ï¼Œå’Œå¯¼å‡ºåˆ°è¿œç¨‹ã€‚åœ¨æ·±å…¥åˆ†ææœåŠ¡å¯¼å‡ºçš„æºç å‰ï¼Œæˆ‘ä»¬å…ˆæ¥ä»å®è§‚å±‚é¢ä¸Šçœ‹ä¸€ä¸‹æœåŠ¡å¯¼å‡ºé€»è¾‘ã€‚å¦‚ä¸‹ï¼š\nprivate void doExportUrlsFor1Protocol(ProtocolConfig protocolConfig, List&lt;URL> registryURLs) &#123;\n    \n    // çœç•¥æ— å…³ä»£ç \n    \n    if (ExtensionLoader.getExtensionLoader(ConfiguratorFactory.class)\n            .hasExtension(url.getProtocol())) &#123;\n        // åŠ è½½ ConfiguratorFactoryï¼Œå¹¶ç”Ÿæˆ Configurator å®ä¾‹ï¼Œç„¶åé€šè¿‡å®ä¾‹é…ç½® url\n        url = ExtensionLoader.getExtensionLoader(ConfiguratorFactory.class)\n                .getExtension(url.getProtocol()).getConfigurator(url).configure(url);\n    &#125;\n\n    String scope = url.getParameter(Constants.SCOPE_KEY);\n    // å¦‚æœ scope = noneï¼Œåˆ™ä»€ä¹ˆéƒ½ä¸åš\n    if (!Constants.SCOPE_NONE.toString().equalsIgnoreCase(scope)) &#123;\n        // scope != remoteï¼Œå¯¼å‡ºåˆ°æœ¬åœ°\n        if (!Constants.SCOPE_REMOTE.toString().equalsIgnoreCase(scope)) &#123;\n            exportLocal(url);\n        &#125;\n\n        // scope != localï¼Œå¯¼å‡ºåˆ°è¿œç¨‹\n        if (!Constants.SCOPE_LOCAL.toString().equalsIgnoreCase(scope)) &#123;\n            if (registryURLs != null &amp;&amp; !registryURLs.isEmpty()) &#123;\n                for (URL registryURL : registryURLs) &#123;\n                    url = url.addParameterIfAbsent(Constants.DYNAMIC_KEY, registryURL.getParameter(Constants.DYNAMIC_KEY));\n                    // åŠ è½½ç›‘è§†å™¨é“¾æ¥\n                    URL monitorUrl = loadMonitor(registryURL);\n                    if (monitorUrl != null) &#123;\n                        // å°†ç›‘è§†å™¨é“¾æ¥ä½œä¸ºå‚æ•°æ·»åŠ åˆ° url ä¸­\n                        url = url.addParameterAndEncoded(Constants.MONITOR_KEY, monitorUrl.toFullString());\n                    &#125;\n\n                    String proxy = url.getParameter(Constants.PROXY_KEY);\n                    if (StringUtils.isNotEmpty(proxy)) &#123;\n                        registryURL = registryURL.addParameter(Constants.PROXY_KEY, proxy);\n                    &#125;\n\n                    // ä¸ºæœåŠ¡æä¾›ç±»(ref)ç”Ÿæˆ Invoker\n                    Invoker&lt;?> invoker = proxyFactory.getInvoker(ref, (Class) interfaceClass, registryURL.addParameterAndEncoded(Constants.EXPORT_KEY, url.toFullString()));\n                    // DelegateProviderMetaDataInvoker ç”¨äºæŒæœ‰ Invoker å’Œ ServiceConfig\n                    DelegateProviderMetaDataInvoker wrapperInvoker = new DelegateProviderMetaDataInvoker(invoker, this);\n\n                    // å¯¼å‡ºæœåŠ¡ï¼Œå¹¶ç”Ÿæˆ Exporter\n                    Exporter&lt;?> exporter = protocol.export(wrapperInvoker);\n                    exporters.add(exporter);\n                &#125;\n                \n            // ä¸å­˜åœ¨æ³¨å†Œä¸­å¿ƒï¼Œä»…å¯¼å‡ºæœåŠ¡\n            &#125; else &#123;\n                Invoker&lt;?> invoker = proxyFactory.getInvoker(ref, (Class) interfaceClass, url);\n                DelegateProviderMetaDataInvoker wrapperInvoker = new DelegateProviderMetaDataInvoker(invoker, this);\n\n                Exporter&lt;?> exporter = protocol.export(wrapperInvoker);\n                exporters.add(exporter);\n            &#125;\n        &#125;\n    &#125;\n    this.urls.add(url);\n&#125;\n\n\n\nä¸Šé¢ä»£ç æ ¹æ® url ä¸­çš„ scope å‚æ•°å†³å®šæœåŠ¡å¯¼å‡ºæ–¹å¼ï¼Œåˆ†åˆ«å¦‚ä¸‹ï¼š\n\nscope &#x3D; noneï¼Œä¸å¯¼å‡ºæœåŠ¡\nscope !&#x3D; remoteï¼Œå¯¼å‡ºåˆ°æœ¬åœ°\nscope !&#x3D; localï¼Œå¯¼å‡ºåˆ°è¿œç¨‹\n\nä¸ç®¡æ˜¯å¯¼å‡ºåˆ°æœ¬åœ°ï¼Œè¿˜æ˜¯è¿œç¨‹ã€‚è¿›è¡ŒæœåŠ¡å¯¼å‡ºä¹‹å‰ï¼Œå‡éœ€è¦å…ˆåˆ›å»º Invokerï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„æ­¥éª¤ã€‚å› æ­¤ä¸‹é¢å…ˆæ¥åˆ†æ Invoker çš„åˆ›å»ºè¿‡ç¨‹ã€‚\n\n2.2.1 Invoker åˆ›å»ºè¿‡ç¨‹åœ¨ Dubbo ä¸­ï¼ŒInvoker æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„æ¨¡å‹ã€‚åœ¨æœåŠ¡æä¾›ç«¯ï¼Œä»¥åŠæœåŠ¡å¼•ç”¨ç«¯å‡ä¼šå‡ºç° Invokerã€‚Dubbo å®˜æ–¹æ–‡æ¡£ä¸­å¯¹ Invoker è¿›è¡Œäº†è¯´æ˜ï¼Œè¿™é‡Œå¼•ç”¨ä¸€ä¸‹ã€‚\n\n\n\n\n\n\n\n\n\nInvoker æ˜¯å®ä½“åŸŸï¼Œå®ƒæ˜¯ Dubbo çš„æ ¸å¿ƒæ¨¡å‹ï¼Œå…¶å®ƒæ¨¡å‹éƒ½å‘å®ƒé æ‰°ï¼Œæˆ–è½¬æ¢æˆå®ƒï¼Œå®ƒä»£è¡¨ä¸€ä¸ªå¯æ‰§è¡Œä½“ï¼Œå¯å‘å®ƒå‘èµ· invoke è°ƒç”¨ï¼Œå®ƒæœ‰å¯èƒ½æ˜¯ä¸€ä¸ªæœ¬åœ°çš„å®ç°ï¼Œä¹Ÿå¯èƒ½æ˜¯ä¸€ä¸ªè¿œç¨‹çš„å®ç°ï¼Œä¹Ÿå¯èƒ½ä¸€ä¸ªé›†ç¾¤å®ç°ã€‚\næ—¢ç„¶ Invoker å¦‚æ­¤é‡è¦ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¾ˆæœ‰å¿…è¦ææ¸…æ¥š Invoker çš„ç”¨é€”ã€‚Invoker æ˜¯ç”± ProxyFactory åˆ›å»ºè€Œæ¥ï¼ŒDubbo é»˜è®¤çš„ ProxyFactory å®ç°ç±»æ˜¯ JavassistProxyFactoryã€‚ä¸‹é¢æˆ‘ä»¬åˆ° JavassistProxyFactory ä»£ç ä¸­ï¼Œæ¢ç´¢ Invoker çš„åˆ›å»ºè¿‡ç¨‹ã€‚å¦‚ä¸‹ï¼š\npublic &lt;T> Invoker&lt;T> getInvoker(T proxy, Class&lt;T> type, URL url) &#123;\n\t// ä¸ºç›®æ ‡ç±»åˆ›å»º Wrapper\n    final Wrapper wrapper = Wrapper.getWrapper(proxy.getClass().getName().indexOf('$') &lt; 0 ? proxy.getClass() : type);\n    // åˆ›å»ºåŒ¿å Invoker ç±»å¯¹è±¡ï¼Œå¹¶å®ç° doInvoke æ–¹æ³•ã€‚\n    return new AbstractProxyInvoker&lt;T>(proxy, type, url) &#123;\n        @Override\n        protected Object doInvoke(T proxy, String methodName,\n                                  Class&lt;?>[] parameterTypes,\n                                  Object[] arguments) throws Throwable &#123;\n\t\t\t// è°ƒç”¨ Wrapper çš„ invokeMethod æ–¹æ³•ï¼ŒinvokeMethod æœ€ç»ˆä¼šè°ƒç”¨ç›®æ ‡æ–¹æ³•\n            return wrapper.invokeMethod(proxy, methodName, parameterTypes, arguments);\n        &#125;\n    &#125;;\n&#125;\n\n\n\nå¦‚ä¸Šï¼ŒJavassistProxyFactory åˆ›å»ºäº†ä¸€ä¸ªç»§æ‰¿è‡ª AbstractProxyInvoker ç±»çš„åŒ¿åå¯¹è±¡ï¼Œå¹¶è¦†å†™äº†æŠ½è±¡æ–¹æ³• doInvokeã€‚è¦†å†™åçš„ doInvoke é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œä»…æ˜¯å°†è°ƒç”¨è¯·æ±‚è½¬å‘ç»™äº† Wrapper ç±»çš„ invokeMethod æ–¹æ³•ã€‚Wrapper ç”¨äºâ€œåŒ…è£¹â€ç›®æ ‡ç±»ï¼ŒWrapper æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œä»…å¯é€šè¿‡ getWrapper(Class) æ–¹æ³•åˆ›å»ºå­ç±»ã€‚åœ¨åˆ›å»º Wrapper å­ç±»çš„è¿‡ç¨‹ä¸­ï¼Œå­ç±»ä»£ç ç”Ÿæˆé€»è¾‘ä¼šå¯¹ getWrapper æ–¹æ³•ä¼ å…¥çš„ Class å¯¹è±¡è¿›è¡Œè§£æï¼Œæ‹¿åˆ°è¯¸å¦‚ç±»æ–¹æ³•ï¼Œç±»æˆå‘˜å˜é‡ç­‰ä¿¡æ¯ã€‚ä»¥åŠç”Ÿæˆ invokeMethod æ–¹æ³•ä»£ç å’Œå…¶ä»–ä¸€äº›æ–¹æ³•ä»£ç ã€‚ä»£ç ç”Ÿæˆå®Œæ¯•åï¼Œé€šè¿‡ Javassist ç”Ÿæˆ Class å¯¹è±¡ï¼Œæœ€åå†é€šè¿‡åå°„åˆ›å»º Wrapper å®ä¾‹ã€‚ç›¸å…³çš„ä»£ç å¦‚ä¸‹ï¼š\n public static Wrapper getWrapper(Class&lt;?> c) &#123;\t\n    while (ClassGenerator.isDynamicClass(c))\n        c = c.getSuperclass();\n\n    if (c == Object.class)\n        return OBJECT_WRAPPER;\n\n    // ä»ç¼“å­˜ä¸­è·å– Wrapper å®ä¾‹\n    Wrapper ret = WRAPPER_MAP.get(c);\n    if (ret == null) &#123;\n        // ç¼“å­˜æœªå‘½ä¸­ï¼Œåˆ›å»º Wrapper\n        ret = makeWrapper(c);\n        // å†™å…¥ç¼“å­˜\n        WRAPPER_MAP.put(c, ret);\n    &#125;\n    return ret;\n&#125;\n\n\n\ngetWrapper æ–¹æ³•ä»…åŒ…å«ä¸€äº›ç¼“å­˜æ“ä½œé€»è¾‘ï¼Œä¸éš¾ç†è§£ã€‚ä¸‹é¢æˆ‘ä»¬çœ‹ä¸€ä¸‹ makeWrapper æ–¹æ³•ã€‚\nprivate static Wrapper makeWrapper(Class&lt;?> c) &#123;\n    // æ£€æµ‹ c æ˜¯å¦ä¸ºåŸºæœ¬ç±»å‹ï¼Œè‹¥æ˜¯åˆ™æŠ›å‡ºå¼‚å¸¸\n    if (c.isPrimitive())\n        throw new IllegalArgumentException(\"Can not create wrapper for primitive type: \" + c);\n\n    String name = c.getName();\n    ClassLoader cl = ClassHelper.getClassLoader(c);\n\n    // c1 ç”¨äºå­˜å‚¨ setPropertyValue æ–¹æ³•ä»£ç \n    StringBuilder c1 = new StringBuilder(\"public void setPropertyValue(Object o, String n, Object v)&#123; \");\n    // c2 ç”¨äºå­˜å‚¨ getPropertyValue æ–¹æ³•ä»£ç \n    StringBuilder c2 = new StringBuilder(\"public Object getPropertyValue(Object o, String n)&#123; \");\n    // c3 ç”¨äºå­˜å‚¨ invokeMethod æ–¹æ³•ä»£ç \n    StringBuilder c3 = new StringBuilder(\"public Object invokeMethod(Object o, String n, Class[] p, Object[] v) throws \" + InvocationTargetException.class.getName() + \"&#123; \");\n\n    // ç”Ÿæˆç±»å‹è½¬æ¢ä»£ç åŠå¼‚å¸¸æ•æ‰ä»£ç ï¼Œæ¯”å¦‚ï¼š\n    //   DemoService w; try &#123; w = ((DemoServcie) $1); &#125;&#125;catch(Throwable e)&#123; throw new IllegalArgumentException(e); &#125;\n    c1.append(name).append(\" w; try&#123; w = ((\").append(name).append(\")$1); &#125;catch(Throwable e)&#123; throw new IllegalArgumentException(e); &#125;\");\n    c2.append(name).append(\" w; try&#123; w = ((\").append(name).append(\")$1); &#125;catch(Throwable e)&#123; throw new IllegalArgumentException(e); &#125;\");\n    c3.append(name).append(\" w; try&#123; w = ((\").append(name).append(\")$1); &#125;catch(Throwable e)&#123; throw new IllegalArgumentException(e); &#125;\");\n\n    // pts ç”¨äºå­˜å‚¨æˆå‘˜å˜é‡åå’Œç±»å‹\n    Map&lt;String, Class&lt;?>> pts = new HashMap&lt;String, Class&lt;?>>();\n    // ms ç”¨äºå­˜å‚¨æ–¹æ³•æè¿°ä¿¡æ¯ï¼ˆå¯ç†è§£ä¸ºæ–¹æ³•ç­¾åï¼‰åŠ Method å®ä¾‹\n    Map&lt;String, Method> ms = new LinkedHashMap&lt;String, Method>();\n    // mns ä¸ºæ–¹æ³•ååˆ—è¡¨\n    List&lt;String> mns = new ArrayList&lt;String>();\n    // dmns ç”¨äºå­˜å‚¨â€œå®šä¹‰åœ¨å½“å‰ç±»ä¸­çš„æ–¹æ³•â€çš„åç§°\n    List&lt;String> dmns = new ArrayList&lt;String>();\n\n    // --------------------------------âœ¨ åˆ†å‰²çº¿1 âœ¨-------------------------------------\n\n    // è·å– public è®¿é—®çº§åˆ«çš„å­—æ®µï¼Œå¹¶ä¸ºæ‰€æœ‰å­—æ®µç”Ÿæˆæ¡ä»¶åˆ¤æ–­è¯­å¥\n    for (Field f : c.getFields()) &#123;\n        String fn = f.getName();\n        Class&lt;?> ft = f.getType();\n        if (Modifier.isStatic(f.getModifiers()) || Modifier.isTransient(f.getModifiers()))\n            // å¿½ç•¥å…³é”®å­— static æˆ– transient ä¿®é¥°çš„å˜é‡\n            continue;\n\n        // ç”Ÿæˆæ¡ä»¶åˆ¤æ–­åŠèµ‹å€¼è¯­å¥ï¼Œæ¯”å¦‚ï¼š\n        // if( $2.equals(\"name\") ) &#123; w.name = (java.lang.String) $3; return;&#125;\n        // if( $2.equals(\"age\") ) &#123; w.age = ((Number) $3).intValue(); return;&#125;\n        c1.append(\" if( $2.equals(\\\"\").append(fn).append(\"\\\") )&#123; w.\").append(fn).append(\"=\").append(arg(ft, \"$3\")).append(\"; return; &#125;\");\n\n        // ç”Ÿæˆæ¡ä»¶åˆ¤æ–­åŠè¿”å›è¯­å¥ï¼Œæ¯”å¦‚ï¼š\n        // if( $2.equals(\"name\") ) &#123; return ($w)w.name; &#125;\n        c2.append(\" if( $2.equals(\\\"\").append(fn).append(\"\\\") )&#123; return ($w)w.\").append(fn).append(\"; &#125;\");\n\n        // å­˜å‚¨ &lt;å­—æ®µå, å­—æ®µç±»å‹> é”®å€¼å¯¹åˆ° pts ä¸­\n        pts.put(fn, ft);\n    &#125;\n\n    // --------------------------------âœ¨ åˆ†å‰²çº¿2 âœ¨-------------------------------------\n\n    Method[] methods = c.getMethods();\n    // æ£€æµ‹ c ä¸­æ˜¯å¦åŒ…å«åœ¨å½“å‰ç±»ä¸­å£°æ˜çš„æ–¹æ³•\n    boolean hasMethod = hasMethods(methods);\n    if (hasMethod) &#123;\n        c3.append(\" try&#123;\");\n    &#125;\n    for (Method m : methods) &#123;\n        if (m.getDeclaringClass() == Object.class)\n            // å¿½ç•¥ Object ä¸­å®šä¹‰çš„æ–¹æ³•\n            continue;\n\n        String mn = m.getName();\n        // ç”Ÿæˆæ–¹æ³•ååˆ¤æ–­è¯­å¥ï¼Œæ¯”å¦‚ï¼š\n        // if ( \"sayHello\".equals( $2 )\n        c3.append(\" if( \\\"\").append(mn).append(\"\\\".equals( $2 ) \");\n        int len = m.getParameterTypes().length;\n        // ç”Ÿæˆâ€œè¿è¡Œæ—¶ä¼ å…¥çš„å‚æ•°æ•°é‡ä¸æ–¹æ³•å‚æ•°åˆ—è¡¨é•¿åº¦â€åˆ¤æ–­è¯­å¥ï¼Œæ¯”å¦‚ï¼š\n        // &amp;&amp; $3.length == 2\n        c3.append(\" &amp;&amp; \").append(\" $3.length == \").append(len);\n\n        boolean override = false;\n        for (Method m2 : methods) &#123;\n            // æ£€æµ‹æ–¹æ³•æ˜¯å¦å­˜åœ¨é‡è½½æƒ…å†µï¼Œæ¡ä»¶ä¸ºï¼šæ–¹æ³•å¯¹è±¡ä¸åŒ &amp;&amp; æ–¹æ³•åç›¸åŒ\n            if (m != m2 &amp;&amp; m.getName().equals(m2.getName())) &#123;\n                override = true;\n                break;\n            &#125;\n        &#125;\n        // å¯¹é‡è½½æ–¹æ³•è¿›è¡Œå¤„ç†ï¼Œè€ƒè™‘ä¸‹é¢çš„æ–¹æ³•ï¼š\n        //    1. void sayHello(Integer, String)\n        //    2. void sayHello(Integer, Integer)\n        // æ–¹æ³•åç›¸åŒï¼Œå‚æ•°åˆ—è¡¨é•¿åº¦ä¹Ÿç›¸åŒï¼Œå› æ­¤ä¸èƒ½ä»…é€šè¿‡è¿™ä¸¤é¡¹åˆ¤æ–­ä¸¤ä¸ªæ–¹æ³•æ˜¯å¦ç›¸ç­‰ã€‚\n        // éœ€è¦è¿›ä¸€æ­¥åˆ¤æ–­æ–¹æ³•çš„å‚æ•°ç±»å‹\n        if (override) &#123;\n            if (len > 0) &#123;\n                for (int l = 0; l &lt; len; l++) &#123;\n                    // ç”Ÿæˆå‚æ•°ç±»å‹è¿›è¡Œæ£€æµ‹ä»£ç ï¼Œæ¯”å¦‚ï¼š\n                    // &amp;&amp; $3[0].getName().equals(\"java.lang.Integer\") \n                    //    &amp;&amp; $3[1].getName().equals(\"java.lang.String\")\n                    c3.append(\" &amp;&amp; \").append(\" $3[\").append(l).append(\"].getName().equals(\\\"\")\n                            .append(m.getParameterTypes()[l].getName()).append(\"\\\")\");\n                &#125;\n            &#125;\n        &#125;\n\n        // æ·»åŠ  ) &#123;ï¼Œå®Œæˆæ–¹æ³•åˆ¤æ–­è¯­å¥ï¼Œæ­¤æ—¶ç”Ÿæˆçš„ä»£ç å¯èƒ½å¦‚ä¸‹ï¼ˆå·²æ ¼å¼åŒ–ï¼‰ï¼š\n        // if (\"sayHello\".equals($2) \n        //     &amp;&amp; $3.length == 2\n        //     &amp;&amp; $3[0].getName().equals(\"java.lang.Integer\") \n        //     &amp;&amp; $3[1].getName().equals(\"java.lang.String\")) &#123;\n        c3.append(\" ) &#123; \");\n\n        // æ ¹æ®è¿”å›å€¼ç±»å‹ç”Ÿæˆç›®æ ‡æ–¹æ³•è°ƒç”¨è¯­å¥\n        if (m.getReturnType() == Void.TYPE)\n            // w.sayHello((java.lang.Integer)$4[0], (java.lang.String)$4[1]); return null;\n            c3.append(\" w.\").append(mn).append('(').append(args(m.getParameterTypes(), \"$4\")).append(\");\").append(\" return null;\");\n        else\n            // return w.sayHello((java.lang.Integer)$4[0], (java.lang.String)$4[1]);\n            c3.append(\" return ($w)w.\").append(mn).append('(').append(args(m.getParameterTypes(), \"$4\")).append(\");\");\n\n        // æ·»åŠ  &#125;, ç”Ÿæˆçš„ä»£ç å½¢å¦‚ï¼ˆå·²æ ¼å¼åŒ–ï¼‰ï¼š\n        // if (\"sayHello\".equals($2) \n        //     &amp;&amp; $3.length == 2\n        //     &amp;&amp; $3[0].getName().equals(\"java.lang.Integer\") \n        //     &amp;&amp; $3[1].getName().equals(\"java.lang.String\")) &#123;\n        //\n        //     w.sayHello((java.lang.Integer)$4[0], (java.lang.String)$4[1]); \n        //     return null;\n        // &#125;\n        c3.append(\" &#125;\");\n\n        // æ·»åŠ æ–¹æ³•ååˆ° mns é›†åˆä¸­\n        mns.add(mn);\n        // æ£€æµ‹å½“å‰æ–¹æ³•æ˜¯å¦åœ¨ c ä¸­è¢«å£°æ˜çš„\n        if (m.getDeclaringClass() == c)\n            // è‹¥æ˜¯ï¼Œåˆ™å°†å½“å‰æ–¹æ³•åæ·»åŠ åˆ° dmns ä¸­\n            dmns.add(mn);\n        ms.put(ReflectUtils.getDesc(m), m);\n    &#125;\n    if (hasMethod) &#123;\n        // æ·»åŠ å¼‚å¸¸æ•æ‰è¯­å¥\n        c3.append(\" &#125; catch(Throwable e) &#123; \");\n        c3.append(\"     throw new java.lang.reflect.InvocationTargetException(e); \");\n        c3.append(\" &#125;\");\n    &#125;\n\n    // æ·»åŠ  NoSuchMethodException å¼‚å¸¸æŠ›å‡ºä»£ç \n    c3.append(\" throw new \" + NoSuchMethodException.class.getName() + \"(\\\"Not found method \\\\\\\"\\\"+$2+\\\"\\\\\\\" in class \" + c.getName() + \".\\\"); &#125;\");\n\n    // --------------------------------âœ¨ åˆ†å‰²çº¿3 âœ¨-------------------------------------\n\n    Matcher matcher;\n    // å¤„ç† get/set æ–¹æ³•\n    for (Map.Entry&lt;String, Method> entry : ms.entrySet()) &#123;\n        String md = entry.getKey();\n        Method method = (Method) entry.getValue();\n        // åŒ¹é…ä»¥ get å¼€å¤´çš„æ–¹æ³•\n        if ((matcher = ReflectUtils.GETTER_METHOD_DESC_PATTERN.matcher(md)).matches()) &#123;\n            // è·å–å±æ€§å\n            String pn = propertyName(matcher.group(1));\n            // ç”Ÿæˆå±æ€§åˆ¤æ–­ä»¥åŠè¿”å›è¯­å¥ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š\n            // if( $2.equals(\"name\") ) &#123; return ($w).w.getName(); &#125;\n            c2.append(\" if( $2.equals(\\\"\").append(pn).append(\"\\\") )&#123; return ($w)w.\").append(method.getName()).append(\"(); &#125;\");\n            pts.put(pn, method.getReturnType());\n\n        // åŒ¹é…ä»¥ is/has/can å¼€å¤´çš„æ–¹æ³•\n        &#125; else if ((matcher = ReflectUtils.IS_HAS_CAN_METHOD_DESC_PATTERN.matcher(md)).matches()) &#123;\n            String pn = propertyName(matcher.group(1));\n            // ç”Ÿæˆå±æ€§åˆ¤æ–­ä»¥åŠè¿”å›è¯­å¥ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š\n            // if( $2.equals(\"dream\") ) &#123; return ($w).w.hasDream(); &#125;\n            c2.append(\" if( $2.equals(\\\"\").append(pn).append(\"\\\") )&#123; return ($w)w.\").append(method.getName()).append(\"(); &#125;\");\n            pts.put(pn, method.getReturnType());\n\n        // åŒ¹é…ä»¥ set å¼€å¤´çš„æ–¹æ³•\n        &#125; else if ((matcher = ReflectUtils.SETTER_METHOD_DESC_PATTERN.matcher(md)).matches()) &#123;\n            Class&lt;?> pt = method.getParameterTypes()[0];\n            String pn = propertyName(matcher.group(1));\n            // ç”Ÿæˆå±æ€§åˆ¤æ–­ä»¥åŠ setter è°ƒç”¨è¯­å¥ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š\n            // if( $2.equals(\"name\") ) &#123; w.setName((java.lang.String)$3); return; &#125;\n            c1.append(\" if( $2.equals(\\\"\").append(pn).append(\"\\\") )&#123; w.\").append(method.getName()).append(\"(\").append(arg(pt, \"$3\")).append(\"); return; &#125;\");\n            pts.put(pn, pt);\n        &#125;\n    &#125;\n\n    // æ·»åŠ  NoSuchPropertyException å¼‚å¸¸æŠ›å‡ºä»£ç \n    c1.append(\" throw new \" + NoSuchPropertyException.class.getName() + \"(\\\"Not found property \\\\\\\"\\\"+$2+\\\"\\\\\\\" filed or setter method in class \" + c.getName() + \".\\\"); &#125;\");\n    c2.append(\" throw new \" + NoSuchPropertyException.class.getName() + \"(\\\"Not found property \\\\\\\"\\\"+$2+\\\"\\\\\\\" filed or setter method in class \" + c.getName() + \".\\\"); &#125;\");\n\n    // --------------------------------âœ¨ åˆ†å‰²çº¿4 âœ¨-------------------------------------\n\n    long id = WRAPPER_CLASS_COUNTER.getAndIncrement();\n    // åˆ›å»ºç±»ç”Ÿæˆå™¨\n    ClassGenerator cc = ClassGenerator.newInstance(cl);\n    // è®¾ç½®ç±»ååŠè¶…ç±»\n    cc.setClassName((Modifier.isPublic(c.getModifiers()) ? Wrapper.class.getName() : c.getName() + \"$sw\") + id);\n    cc.setSuperClass(Wrapper.class);\n\n    // æ·»åŠ é»˜è®¤æ„é€ æ–¹æ³•\n    cc.addDefaultConstructor();\n\n    // æ·»åŠ å­—æ®µ\n    cc.addField(\"public static String[] pns;\");\n    cc.addField(\"public static \" + Map.class.getName() + \" pts;\");\n    cc.addField(\"public static String[] mns;\");\n    cc.addField(\"public static String[] dmns;\");\n    for (int i = 0, len = ms.size(); i &lt; len; i++)\n        cc.addField(\"public static Class[] mts\" + i + \";\");\n\n    // æ·»åŠ æ–¹æ³•ä»£ç \n    cc.addMethod(\"public String[] getPropertyNames()&#123; return pns; &#125;\");\n    cc.addMethod(\"public boolean hasProperty(String n)&#123; return pts.containsKey($1); &#125;\");\n    cc.addMethod(\"public Class getPropertyType(String n)&#123; return (Class)pts.get($1); &#125;\");\n    cc.addMethod(\"public String[] getMethodNames()&#123; return mns; &#125;\");\n    cc.addMethod(\"public String[] getDeclaredMethodNames()&#123; return dmns; &#125;\");\n    cc.addMethod(c1.toString());\n    cc.addMethod(c2.toString());\n    cc.addMethod(c3.toString());\n\n    try &#123;\n        // ç”Ÿæˆç±»\n        Class&lt;?> wc = cc.toClass();\n        \n        // è®¾ç½®å­—æ®µå€¼\n        wc.getField(\"pts\").set(null, pts);\n        wc.getField(\"pns\").set(null, pts.keySet().toArray(new String[0]));\n        wc.getField(\"mns\").set(null, mns.toArray(new String[0]));\n        wc.getField(\"dmns\").set(null, dmns.toArray(new String[0]));\n        int ix = 0;\n        for (Method m : ms.values())\n            wc.getField(\"mts\" + ix++).set(null, m.getParameterTypes());\n\n        // åˆ›å»º Wrapper å®ä¾‹\n        return (Wrapper) wc.newInstance();\n    &#125; catch (RuntimeException e) &#123;\n        throw e;\n    &#125; catch (Throwable e) &#123;\n        throw new RuntimeException(e.getMessage(), e);\n    &#125; finally &#123;\n        cc.release();\n        ms.clear();\n        mns.clear();\n        dmns.clear();\n    &#125;\n&#125;\n\n\n\nä¸Šé¢ä»£ç å¾ˆé•¿ï¼Œå¤§å®¶è€å¿ƒçœ‹ä¸€ä¸‹ã€‚æˆ‘ä»¬åœ¨ä¸Šé¢ä»£ç ä¸­åšäº†å¤§é‡çš„æ³¨é‡Šï¼Œå¹¶æŒ‰åŠŸèƒ½å¯¹ä»£ç è¿›è¡Œäº†åˆ†å—ï¼Œä»¥å¸®åŠ©å¤§å®¶ç†è§£ä»£ç é€»è¾‘ã€‚ä¸‹é¢å¯¹è¿™æ®µä»£ç è¿›è¡Œè®²è§£ã€‚é¦–å…ˆæˆ‘ä»¬æŠŠç›®å…‰ç§»åˆ°åˆ†å‰²çº¿1ä¹‹ä¸Šçš„ä»£ç ï¼Œè¿™æ®µä»£ç ä¸»è¦ç”¨äºè¿›è¡Œä¸€äº›åˆå§‹åŒ–æ“ä½œã€‚æ¯”å¦‚åˆ›å»º c1ã€c2ã€c3 ä»¥åŠ ptsã€msã€mns ç­‰å˜é‡ï¼Œä»¥åŠå‘ c1ã€c2ã€c3 ä¸­æ·»åŠ æ–¹æ³•å®šä¹‰å’Œç±»å‹è½¬æ¢ä»£ç ã€‚æ¥ä¸‹æ¥æ˜¯åˆ†å‰²çº¿1åˆ°åˆ†å‰²çº¿2ä¹‹é—´çš„ä»£ç ï¼Œè¿™æ®µä»£ç ç”¨äºä¸º public çº§åˆ«çš„å­—æ®µç”Ÿæˆæ¡ä»¶åˆ¤æ–­å–å€¼ä¸èµ‹å€¼ä»£ç ã€‚è¿™æ®µä»£ç ä¸æ˜¯å¾ˆéš¾çœ‹æ‡‚ï¼Œå°±ä¸å¤šè¯´äº†ã€‚ç»§ç»­å‘ä¸‹çœ‹ï¼Œåˆ†å‰²çº¿2å’Œåˆ†éš”çº¿3ä¹‹é—´çš„ä»£ç ç”¨äºä¸ºå®šä¹‰åœ¨å½“å‰ç±»ä¸­çš„æ–¹æ³•ç”Ÿæˆåˆ¤æ–­è¯­å¥ï¼Œå’Œæ–¹æ³•è°ƒç”¨è¯­å¥ã€‚å› ä¸ºéœ€è¦å¯¹æ–¹æ³•é‡è½½è¿›è¡Œæ ¡éªŒï¼Œå› æ­¤åˆ°è¿™è¿™æ®µä»£ç çœ‹èµ·æ¥æœ‰ç‚¹å¤æ‚ã€‚ä¸è¿‡è€å¿ƒçœ‹ä¸€ä¸‹ï¼Œä¹Ÿä¸æ˜¯å¾ˆéš¾ç†è§£ã€‚æ¥ä¸‹æ¥æ˜¯åˆ†å‰²çº¿3å’Œåˆ†éš”çº¿4ä¹‹é—´çš„ä»£ç ï¼Œè¿™æ®µä»£ç ç”¨äºå¤„ç† getterã€setter ä»¥åŠä»¥ is&#x2F;has&#x2F;can å¼€å¤´çš„æ–¹æ³•ã€‚å¤„ç†æ–¹å¼æ˜¯é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼è·å–æ–¹æ³•ç±»å‹ï¼ˆget&#x2F;set&#x2F;is&#x2F;â€¦ï¼‰ï¼Œä»¥åŠå±æ€§åã€‚ä¹‹åä¸ºå±æ€§åç”Ÿæˆåˆ¤æ–­è¯­å¥ï¼Œç„¶åä¸ºæ–¹æ³•ç”Ÿæˆè°ƒç”¨è¯­å¥ã€‚æœ€åæˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹åˆ†éš”çº¿4ä»¥ä¸‹çš„ä»£ç ï¼Œè¿™æ®µä»£ç é€šè¿‡ ClassGenerator ä¸ºåˆšåˆšç”Ÿæˆçš„ä»£ç æ„å»º Class ç±»ï¼Œå¹¶é€šè¿‡åå°„åˆ›å»ºå¯¹è±¡ã€‚ClassGenerator æ˜¯ Dubbo è‡ªå·±å°è£…çš„ï¼Œè¯¥ç±»çš„æ ¸å¿ƒæ˜¯ toClass() çš„é‡è½½æ–¹æ³• toClass(ClassLoader, ProtectionDomain)ï¼Œè¯¥æ–¹æ³•é€šè¿‡ javassist æ„å»º Classã€‚è¿™é‡Œå°±ä¸åˆ†æ toClass æ–¹æ³•äº†ï¼Œå¤§å®¶è¯·è‡ªè¡Œåˆ†æã€‚\né˜…è¯» Wrapper ç±»ä»£ç éœ€è¦å¯¹ javassist æ¡†æ¶æœ‰æ‰€äº†è§£ã€‚å…³äº javassistï¼Œå¤§å®¶å¦‚æœä¸ç†Ÿæ‚‰ï¼Œè¯·è‡ªè¡ŒæŸ¥é˜…èµ„æ–™ï¼Œæœ¬èŠ‚ä¸æ‰“ç®—ä»‹ç» javassist ç›¸å…³å†…å®¹ã€‚\nå¥½äº†ï¼Œå…³äº Wrapper ç±»ç”Ÿæˆè¿‡ç¨‹å°±åˆ†æåˆ°è¿™ã€‚å¦‚æœå¤§å®¶çœ‹çš„ä¸æ˜¯å¾ˆæ˜ç™½ï¼Œå¯ä»¥å•ç‹¬ä¸º Wrapper åˆ›å»ºå•å…ƒæµ‹è¯•ï¼Œç„¶åå•æ­¥è°ƒè¯•ã€‚å¹¶å°†ç”Ÿæˆçš„ä»£ç æ‹·è´å‡ºæ¥ï¼Œæ ¼å¼åŒ–åå†è¿›è¡Œè§‚å¯Ÿå’Œç†è§£ã€‚\n\n2.2.2 å¯¼å‡ºæœåŠ¡åˆ°æœ¬åœ°æœ¬èŠ‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æœåŠ¡å¯¼å‡ºç›¸å…³çš„ä»£ç ï¼ŒæŒ‰ç…§ä»£ç æ‰§è¡Œé¡ºåºï¼Œæœ¬èŠ‚å…ˆæ¥åˆ†æå¯¼å‡ºæœåŠ¡åˆ°æœ¬åœ°çš„è¿‡ç¨‹ã€‚ç›¸å…³ä»£ç å¦‚ä¸‹ï¼š\nprivate void exportLocal(URL url) &#123;\n    // å¦‚æœ URL çš„åè®®å¤´ç­‰äº injvmï¼Œè¯´æ˜å·²ç»å¯¼å‡ºåˆ°æœ¬åœ°äº†ï¼Œæ— éœ€å†æ¬¡å¯¼å‡º\n    if (!Constants.LOCAL_PROTOCOL.equalsIgnoreCase(url.getProtocol())) &#123;\n        URL local = URL.valueOf(url.toFullString())\n            .setProtocol(Constants.LOCAL_PROTOCOL)    // è®¾ç½®åè®®å¤´ä¸º injvm\n            .setHost(LOCALHOST)\n            .setPort(0);\n        ServiceClassHolder.getInstance().pushServiceClass(getServiceClass(ref));\n        // åˆ›å»º Invokerï¼Œå¹¶å¯¼å‡ºæœåŠ¡ï¼Œè¿™é‡Œçš„ protocol ä¼šåœ¨è¿è¡Œæ—¶è°ƒç”¨ InjvmProtocol çš„ export æ–¹æ³•\n        Exporter&lt;?> exporter = protocol.export(\n            proxyFactory.getInvoker(ref, (Class) interfaceClass, local));\n        exporters.add(exporter);\n    &#125;\n&#125;\n\n\n\nexportLocal æ–¹æ³•æ¯”è¾ƒç®€å•ï¼Œé¦–å…ˆæ ¹æ® URL åè®®å¤´å†³å®šæ˜¯å¦å¯¼å‡ºæœåŠ¡ã€‚è‹¥éœ€å¯¼å‡ºï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„ URL å¹¶å°†åè®®å¤´ã€ä¸»æœºåä»¥åŠç«¯å£è®¾ç½®æˆæ–°çš„å€¼ã€‚ç„¶ååˆ›å»º Invokerï¼Œå¹¶è°ƒç”¨ InjvmProtocol çš„ export æ–¹æ³•å¯¼å‡ºæœåŠ¡ã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ InjvmProtocol çš„ export æ–¹æ³•éƒ½åšäº†å“ªäº›äº‹æƒ…ã€‚\npublic &lt;T> Exporter&lt;T> export(Invoker&lt;T> invoker) throws RpcException &#123;\n    // åˆ›å»º InjvmExporter\n    return new InjvmExporter&lt;T>(invoker, invoker.getUrl().getServiceKey(), exporterMap);\n&#125;\n\n\n\nå¦‚ä¸Šï¼ŒInjvmProtocol çš„ export æ–¹æ³•ä»…åˆ›å»ºäº†ä¸€ä¸ª InjvmExporterï¼Œæ— å…¶ä»–é€»è¾‘ã€‚åˆ°æ­¤å¯¼å‡ºæœåŠ¡åˆ°æœ¬åœ°å°±åˆ†æå®Œäº†ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç»§ç»­åˆ†æå¯¼å‡ºæœåŠ¡åˆ°è¿œç¨‹çš„è¿‡ç¨‹ã€‚\n\n2.2.3 å¯¼å‡ºæœåŠ¡åˆ°è¿œç¨‹ä¸å¯¼å‡ºæœåŠ¡åˆ°æœ¬åœ°ç›¸æ¯”ï¼Œå¯¼å‡ºæœåŠ¡åˆ°è¿œç¨‹çš„è¿‡ç¨‹è¦å¤æ‚ä¸å°‘ï¼Œå…¶åŒ…å«äº†æœåŠ¡å¯¼å‡ºä¸æœåŠ¡æ³¨å†Œä¸¤ä¸ªè¿‡ç¨‹ã€‚è¿™ä¸¤ä¸ªè¿‡ç¨‹æ¶‰åŠåˆ°äº†å¤§é‡çš„è°ƒç”¨ï¼Œæ¯”è¾ƒå¤æ‚ã€‚æŒ‰ç…§ä»£ç æ‰§è¡Œé¡ºåºï¼Œæœ¬èŠ‚å…ˆæ¥åˆ†ææœåŠ¡å¯¼å‡ºé€»è¾‘ï¼ŒæœåŠ¡æ³¨å†Œé€»è¾‘å°†åœ¨ä¸‹ä¸€èŠ‚è¿›è¡Œåˆ†æã€‚ä¸‹é¢å¼€å§‹åˆ†æï¼Œæˆ‘ä»¬æŠŠç›®å…‰ç§»åŠ¨åˆ° RegistryProtocol çš„ export æ–¹æ³•ä¸Šã€‚\npublic &lt;T> Exporter&lt;T> export(final Invoker&lt;T> originInvoker) throws RpcException &#123;\n    // å¯¼å‡ºæœåŠ¡\n    final ExporterChangeableWrapper&lt;T> exporter = doLocalExport(originInvoker);\n\n    // è·å–æ³¨å†Œä¸­å¿ƒ URLï¼Œä»¥ zookeeper æ³¨å†Œä¸­å¿ƒä¸ºä¾‹ï¼Œå¾—åˆ°çš„ç¤ºä¾‹ URL å¦‚ä¸‹ï¼š\n    // zookeeper://127.0.0.1:2181/com.alibaba.dubbo.registry.RegistryService?application=demo-provider&amp;dubbo=2.0.2&amp;export=dubbo%3A%2F%2F172.17.48.52%3A20880%2Fcom.alibaba.dubbo.demo.DemoService%3Fanyhost%3Dtrue%26application%3Ddemo-provider\n    URL registryUrl = getRegistryUrl(originInvoker);\n\n    // æ ¹æ® URL åŠ è½½ Registry å®ç°ç±»ï¼Œæ¯”å¦‚ ZookeeperRegistry\n    final Registry registry = getRegistry(originInvoker);\n    \n    // è·å–å·²æ³¨å†Œçš„æœåŠ¡æä¾›è€… URLï¼Œæ¯”å¦‚ï¼š\n    // dubbo://172.17.48.52:20880/com.alibaba.dubbo.demo.DemoService?anyhost=true&amp;application=demo-provider&amp;dubbo=2.0.2&amp;generic=false&amp;interface=com.alibaba.dubbo.demo.DemoService&amp;methods=sayHello\n    final URL registeredProviderUrl = getRegisteredProviderUrl(originInvoker);\n\n    // è·å– register å‚æ•°\n    boolean register = registeredProviderUrl.getParameter(\"register\", true);\n\n    // å‘æœåŠ¡æä¾›è€…ä¸æ¶ˆè´¹è€…æ³¨å†Œè¡¨ä¸­æ³¨å†ŒæœåŠ¡æä¾›è€…\n    ProviderConsumerRegTable.registerProvider(originInvoker, registryUrl, registeredProviderUrl);\n\n    // æ ¹æ® register çš„å€¼å†³å®šæ˜¯å¦æ³¨å†ŒæœåŠ¡\n    if (register) &#123;\n        // å‘æ³¨å†Œä¸­å¿ƒæ³¨å†ŒæœåŠ¡\n        register(registryUrl, registeredProviderUrl);\n        ProviderConsumerRegTable.getProviderWrapper(originInvoker).setReg(true);\n    &#125;\n\n    // è·å–è®¢é˜… URLï¼Œæ¯”å¦‚ï¼š\n    // provider://172.17.48.52:20880/com.alibaba.dubbo.demo.DemoService?category=configurators&amp;check=false&amp;anyhost=true&amp;application=demo-provider&amp;dubbo=2.0.2&amp;generic=false&amp;interface=com.alibaba.dubbo.demo.DemoService&amp;methods=sayHello\n    final URL overrideSubscribeUrl = getSubscribedOverrideUrl(registeredProviderUrl);\n    // åˆ›å»ºç›‘å¬å™¨\n    final OverrideListener overrideSubscribeListener = new OverrideListener(overrideSubscribeUrl, originInvoker);\n    overrideListeners.put(overrideSubscribeUrl, overrideSubscribeListener);\n    // å‘æ³¨å†Œä¸­å¿ƒè¿›è¡Œè®¢é˜… override æ•°æ®\n    registry.subscribe(overrideSubscribeUrl, overrideSubscribeListener);\n    // åˆ›å»ºå¹¶è¿”å› DestroyableExporter\n    return new DestroyableExporter&lt;T>(exporter, originInvoker, overrideSubscribeUrl, registeredProviderUrl);\n&#125;\n\n\n\n\nä¸Šé¢ä»£ç çœ‹èµ·æ¥æ¯”è¾ƒå¤æ‚ï¼Œä¸»è¦åšå¦‚ä¸‹ä¸€äº›æ“ä½œï¼š\n\nè°ƒç”¨ doLocalExport å¯¼å‡ºæœåŠ¡\nå‘æ³¨å†Œä¸­å¿ƒæ³¨å†ŒæœåŠ¡\nå‘æ³¨å†Œä¸­å¿ƒè¿›è¡Œè®¢é˜… override æ•°æ®\nåˆ›å»ºå¹¶è¿”å› DestroyableExporter\n\nåœ¨ä»¥ä¸Šæ“ä½œä¸­ï¼Œé™¤äº†åˆ›å»ºå¹¶è¿”å› DestroyableExporter æ²¡ä»€ä¹ˆéš¾åº¦å¤–ï¼Œå…¶ä»–å‡ æ­¥æ“ä½œéƒ½ä¸æ˜¯å¾ˆç®€å•ã€‚è¿™å…¶ä¸­ï¼Œå¯¼å‡ºæœåŠ¡å’Œæ³¨å†ŒæœåŠ¡æ˜¯æœ¬ç« è¦é‡ç‚¹åˆ†æçš„é€»è¾‘ã€‚ è®¢é˜… override æ•°æ®å¹¶éæœ¬æ–‡é‡ç‚¹å†…å®¹ï¼Œåé¢ä¼šç®€å•ä»‹ç»ä¸€ä¸‹ã€‚ä¸‹é¢å…ˆæ¥åˆ†æ doLocalExport æ–¹æ³•çš„é€»è¾‘ï¼Œå¦‚ä¸‹ï¼š\nprivate &lt;T> ExporterChangeableWrapper&lt;T> doLocalExport(final Invoker&lt;T> originInvoker) &#123;\n    String key = getCacheKey(originInvoker);\n    // è®¿é—®ç¼“å­˜\n    ExporterChangeableWrapper&lt;T> exporter = (ExporterChangeableWrapper&lt;T>) bounds.get(key);\n    if (exporter == null) &#123;\n        synchronized (bounds) &#123;\n            exporter = (ExporterChangeableWrapper&lt;T>) bounds.get(key);\n            if (exporter == null) &#123;\n                // åˆ›å»º Invoker ä¸ºå§”æ‰˜ç±»å¯¹è±¡\n                final Invoker&lt;?> invokerDelegete = new InvokerDelegete&lt;T>(originInvoker, getProviderUrl(originInvoker));\n                // è°ƒç”¨ protocol çš„ export æ–¹æ³•å¯¼å‡ºæœåŠ¡\n                exporter = new ExporterChangeableWrapper&lt;T>((Exporter&lt;T>) protocol.export(invokerDelegete), originInvoker);\n                \n                // å†™ç¼“å­˜\n                bounds.put(key, exporter);\n            &#125;\n        &#125;\n    &#125;\n    return exporter;\n&#125;\n\n\n\n\nä¸Šé¢çš„ä»£ç æ˜¯å…¸å‹çš„åŒé‡æ£€æŸ¥é”ï¼Œå¤§å®¶åœ¨é˜…è¯» Dubbo çš„æºç ä¸­ï¼Œä¼šå¤šæ¬¡è§åˆ°ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æŠŠé‡ç‚¹æ”¾åœ¨ Protocol çš„ export æ–¹æ³•ä¸Šã€‚å‡è®¾è¿è¡Œæ—¶åè®®ä¸º dubboï¼Œæ­¤å¤„çš„ protocol å˜é‡ä¼šåœ¨è¿è¡Œæ—¶åŠ è½½ DubboProtocolï¼Œå¹¶è°ƒç”¨ DubboProtocol çš„ export æ–¹æ³•ã€‚æ‰€ä»¥ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ç›®å…‰è½¬ç§»åˆ° DubboProtocol çš„ export æ–¹æ³•ä¸Šï¼Œç›¸å…³åˆ†æå¦‚ä¸‹ï¼š\npublic &lt;T> Exporter&lt;T> export(Invoker&lt;T> invoker) throws RpcException &#123;\n    URL url = invoker.getUrl();\n\n    // è·å–æœåŠ¡æ ‡è¯†ï¼Œç†è§£æˆæœåŠ¡åæ ‡ä¹Ÿè¡Œã€‚ç”±æœåŠ¡ç»„åï¼ŒæœåŠ¡åï¼ŒæœåŠ¡ç‰ˆæœ¬å·ä»¥åŠç«¯å£ç»„æˆã€‚æ¯”å¦‚ï¼š\n    // demoGroup/com.alibaba.dubbo.demo.DemoService:1.0.1:20880\n    String key = serviceKey(url);\n    // åˆ›å»º DubboExporter\n    DubboExporter&lt;T> exporter = new DubboExporter&lt;T>(invoker, key, exporterMap);\n    // å°† &lt;key, exporter> é”®å€¼å¯¹æ”¾å…¥ç¼“å­˜ä¸­\n    exporterMap.put(key, exporter);\n\n    // æœ¬åœ°å­˜æ ¹ç›¸å…³ä»£ç \n    Boolean isStubSupportEvent = url.getParameter(Constants.STUB_EVENT_KEY, Constants.DEFAULT_STUB_EVENT);\n    Boolean isCallbackservice = url.getParameter(Constants.IS_CALLBACK_SERVICE, false);\n    if (isStubSupportEvent &amp;&amp; !isCallbackservice) &#123;\n        String stubServiceMethods = url.getParameter(Constants.STUB_EVENT_METHODS_KEY);\n        if (stubServiceMethods == null || stubServiceMethods.length() == 0) &#123;\n            // çœç•¥æ—¥å¿—æ‰“å°ä»£ç \n        &#125; else &#123;\n            stubServiceMethodsMap.put(url.getServiceKey(), stubServiceMethods);\n        &#125;\n    &#125;\n\n    // å¯åŠ¨æœåŠ¡å™¨\n    openServer(url);\n    // ä¼˜åŒ–åºåˆ—åŒ–\n    optimizeSerialization(url);\n    return exporter;\n&#125;\n\n\n\n\nå¦‚ä¸Šï¼Œæˆ‘ä»¬é‡ç‚¹å…³æ³¨ DubboExporter çš„åˆ›å»ºä»¥åŠ openServer æ–¹æ³•ï¼Œå…¶ä»–é€»è¾‘çœ‹ä¸æ‡‚ä¹Ÿæ²¡å…³ç³»ï¼Œä¸å½±å“ç†è§£æœåŠ¡å¯¼å‡ºè¿‡ç¨‹ã€‚å¦å¤–ï¼ŒDubboExporter çš„ä»£ç æ¯”è¾ƒç®€å•ï¼Œå°±ä¸åˆ†æäº†ã€‚ä¸‹é¢åˆ†æ openServer æ–¹æ³•ã€‚\nprivate void openServer(URL url) &#123;\n    // è·å– host:portï¼Œå¹¶å°†å…¶ä½œä¸ºæœåŠ¡å™¨å®ä¾‹çš„ keyï¼Œç”¨äºæ ‡è¯†å½“å‰çš„æœåŠ¡å™¨å®ä¾‹\n    String key = url.getAddress();\n    boolean isServer = url.getParameter(Constants.IS_SERVER_KEY, true);\n    if (isServer) &#123;\n        // è®¿é—®ç¼“å­˜\n        ExchangeServer server = serverMap.get(key);\n        if (server == null) &#123;\n            // åˆ›å»ºæœåŠ¡å™¨å®ä¾‹\n            serverMap.put(key, createServer(url));\n        &#125; else &#123;\n            // æœåŠ¡å™¨å·²åˆ›å»ºï¼Œåˆ™æ ¹æ® url ä¸­çš„é…ç½®é‡ç½®æœåŠ¡å™¨\n            server.reset(url);\n        &#125;\n    &#125;\n&#125;\n\n\n\n\nå¦‚ä¸Šï¼Œåœ¨åŒä¸€å°æœºå™¨ä¸Šï¼ˆå•ç½‘å¡ï¼‰ï¼ŒåŒä¸€ä¸ªç«¯å£ä¸Šä»…å…è®¸å¯åŠ¨ä¸€ä¸ªæœåŠ¡å™¨å®ä¾‹ã€‚è‹¥æŸä¸ªç«¯å£ä¸Šå·²æœ‰æœåŠ¡å™¨å®ä¾‹ï¼Œæ­¤æ—¶åˆ™è°ƒç”¨ reset æ–¹æ³•é‡ç½®æœåŠ¡å™¨çš„ä¸€äº›é…ç½®ã€‚è€ƒè™‘åˆ°ç¯‡å¹…é—®é¢˜ï¼Œå…³äºæœåŠ¡å™¨å®ä¾‹é‡ç½®çš„ä»£ç å°±ä¸åˆ†æäº†ã€‚æ¥ä¸‹æ¥åˆ†ææœåŠ¡å™¨å®ä¾‹çš„åˆ›å»ºè¿‡ç¨‹ã€‚å¦‚ä¸‹ï¼š\nprivate ExchangeServer createServer(URL url) &#123;\n    url = url.addParameterIfAbsent(Constants.CHANNEL_READONLYEVENT_SENT_KEY,\n    // æ·»åŠ å¿ƒè·³æ£€æµ‹é…ç½®åˆ° url ä¸­\n    url = url.addParameterIfAbsent(Constants.HEARTBEAT_KEY, String.valueOf(Constants.DEFAULT_HEARTBEAT));\n\t// è·å– server å‚æ•°ï¼Œé»˜è®¤ä¸º netty\n    String str = url.getParameter(Constants.SERVER_KEY, Constants.DEFAULT_REMOTING_SERVER);\n\n\t// é€šè¿‡ SPI æ£€æµ‹æ˜¯å¦å­˜åœ¨ server å‚æ•°æ‰€ä»£è¡¨çš„ Transporter æ‹“å±•ï¼Œä¸å­˜åœ¨åˆ™æŠ›å‡ºå¼‚å¸¸\n    if (str != null &amp;&amp; str.length() > 0 &amp;&amp; !ExtensionLoader.getExtensionLoader(Transporter.class).hasExtension(str))\n        throw new RpcException(\"Unsupported server type: \" + str + \", url: \" + url);\n\n    // æ·»åŠ ç¼–ç è§£ç å™¨å‚æ•°\n    url = url.addParameter(Constants.CODEC_KEY, DubboCodec.NAME);\n    ExchangeServer server;\n    try &#123;\n        // åˆ›å»º ExchangeServer\n        server = Exchangers.bind(url, requestHandler);\n    &#125; catch (RemotingException e) &#123;\n        throw new RpcException(\"Fail to start server...\");\n    &#125;\n                                   \n\t// è·å– client å‚æ•°ï¼Œå¯æŒ‡å®š nettyï¼Œmina\n    str = url.getParameter(Constants.CLIENT_KEY);\n    if (str != null &amp;&amp; str.length() > 0) &#123;\n        // è·å–æ‰€æœ‰çš„ Transporter å®ç°ç±»åç§°é›†åˆï¼Œæ¯”å¦‚ supportedTypes = [netty, mina]\n        Set&lt;String> supportedTypes = ExtensionLoader.getExtensionLoader(Transporter.class).getSupportedExtensions();\n        // æ£€æµ‹å½“å‰ Dubbo æ‰€æ”¯æŒçš„ Transporter å®ç°ç±»åç§°åˆ—è¡¨ä¸­ï¼Œ\n        // æ˜¯å¦åŒ…å« client æ‰€è¡¨ç¤ºçš„ Transporterï¼Œè‹¥ä¸åŒ…å«ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸\n        if (!supportedTypes.contains(str)) &#123;\n            throw new RpcException(\"Unsupported client type...\");\n        &#125;\n    &#125;\n    return server;\n&#125;\n\n\n\n\nå¦‚ä¸Šï¼ŒcreateServer åŒ…å«ä¸‰ä¸ªæ ¸å¿ƒçš„é€»è¾‘ã€‚ç¬¬ä¸€æ˜¯æ£€æµ‹æ˜¯å¦å­˜åœ¨ server å‚æ•°æ‰€ä»£è¡¨çš„ Transporter æ‹“å±•ï¼Œä¸å­˜åœ¨åˆ™æŠ›å‡ºå¼‚å¸¸ã€‚ç¬¬äºŒæ˜¯åˆ›å»ºæœåŠ¡å™¨å®ä¾‹ã€‚ç¬¬ä¸‰æ˜¯æ£€æµ‹æ˜¯å¦æ”¯æŒ client å‚æ•°æ‰€è¡¨ç¤ºçš„ Transporter æ‹“å±•ï¼Œä¸å­˜åœ¨ä¹Ÿæ˜¯æŠ›å‡ºå¼‚å¸¸ã€‚ä¸¤æ¬¡æ£€æµ‹æ“ä½œæ‰€å¯¹åº”çš„ä»£ç æ¯”è¾ƒç›´ç™½äº†ï¼Œæ— éœ€å¤šè¯´ã€‚ä½†åˆ›å»ºæœåŠ¡å™¨çš„æ“ä½œç›®å‰è¿˜ä¸æ˜¯å¾ˆæ¸…æ™°ï¼Œæˆ‘ä»¬ç»§ç»­å¾€ä¸‹çœ‹ã€‚\npublic static ExchangeServer bind(URL url, ExchangeHandler handler) throws RemotingException &#123;\n    if (url == null) &#123;\n        throw new IllegalArgumentException(\"url == null\");\n    &#125;\n    if (handler == null) &#123;\n        throw new IllegalArgumentException(\"handler == null\");\n    &#125;\n    url = url.addParameterIfAbsent(Constants.CODEC_KEY, \"exchange\");\n    // è·å– Exchangerï¼Œé»˜è®¤ä¸º HeaderExchangerã€‚\n    // ç´§æ¥ç€è°ƒç”¨ HeaderExchanger çš„ bind æ–¹æ³•åˆ›å»º ExchangeServer å®ä¾‹\n    return getExchanger(url).bind(url, handler);\n&#125;\n\n\n\n\nä¸Šé¢ä»£ç æ¯”è¾ƒç®€å•ï¼Œå°±ä¸å¤šè¯´äº†ã€‚ä¸‹é¢çœ‹ä¸€ä¸‹ HeaderExchanger çš„ bind æ–¹æ³•ã€‚\npublic ExchangeServer bind(URL url, ExchangeHandler handler) throws RemotingException &#123;\n\t// åˆ›å»º HeaderExchangeServer å®ä¾‹ï¼Œè¯¥æ–¹æ³•åŒ…å«äº†å¤šä¸ªé€»è¾‘ï¼Œåˆ†åˆ«å¦‚ä¸‹ï¼š\n\t//   1. new HeaderExchangeHandler(handler)\n\t//\t 2. new DecodeHandler(new HeaderExchangeHandler(handler))\n\t//   3. Transporters.bind(url, new DecodeHandler(new HeaderExchangeHandler(handler)))\n    return new HeaderExchangeServer(Transporters.bind(url, new DecodeHandler(new HeaderExchangeHandler(handler))));\n&#125;\n\n\n\n\nHeaderExchanger çš„ bind æ–¹æ³•åŒ…å«çš„é€»è¾‘æ¯”è¾ƒå¤šï¼Œä½†ç›®å‰æˆ‘ä»¬ä»…éœ€å…³å¿ƒ Transporters çš„ bind æ–¹æ³•é€»è¾‘å³å¯ã€‚è¯¥æ–¹æ³•çš„ä»£ç å¦‚ä¸‹ï¼š\npublic static Server bind(URL url, ChannelHandler... handlers) throws RemotingException &#123;\n    if (url == null) &#123;\n        throw new IllegalArgumentException(\"url == null\");\n    &#125;\n    if (handlers == null || handlers.length == 0) &#123;\n        throw new IllegalArgumentException(\"handlers == null\");\n    &#125;\n    ChannelHandler handler;\n    if (handlers.length == 1) &#123;\n        handler = handlers[0];\n    &#125; else &#123;\n    \t// å¦‚æœ handlers å…ƒç´ æ•°é‡å¤§äº1ï¼Œåˆ™åˆ›å»º ChannelHandler åˆ†å‘å™¨\n        handler = new ChannelHandlerDispatcher(handlers);\n    &#125;\n    // è·å–è‡ªé€‚åº” Transporter å®ä¾‹ï¼Œå¹¶è°ƒç”¨å®ä¾‹æ–¹æ³•\n    return getTransporter().bind(url, handler);\n&#125;\n\n\n\n\nå¦‚ä¸Šï¼ŒgetTransporter() æ–¹æ³•è·å–çš„ Transporter æ˜¯åœ¨è¿è¡Œæ—¶åŠ¨æ€åˆ›å»ºçš„ï¼Œç±»åä¸º TransporterAdaptive ä¼šåœ¨è¿è¡Œæ—¶æ ¹æ®ä¼ å…¥çš„ URL å‚æ•°å†³å®šåŠ è½½ä»€ä¹ˆç±»å‹çš„ Transporterï¼Œé»˜è®¤ä¸º NettyTransporterã€‚ä¸‹é¢æˆ‘ä»¬ç»§ç»­è·Ÿä¸‹å»ï¼Œè¿™æ¬¡åˆ†æçš„æ˜¯ NettyTransporter çš„ bind æ–¹æ³•ã€‚\npublic Server bind(URL url, ChannelHandler listener) throws RemotingException &#123;\n\t// åˆ›å»º NettyServer\n\treturn new NettyServer(url, listener);\n&#125;\n\n\n\n\nè¿™é‡Œä»…æœ‰ä¸€å¥åˆ›å»º NettyServer çš„ä»£ç ï¼Œæ— éœ€å¤šè¯´ï¼Œæˆ‘ä»¬ç»§ç»­å‘ä¸‹çœ‹ã€‚\npublic class NettyServer extends AbstractServer implements Server &#123;\n    public NettyServer(URL url, ChannelHandler handler) throws RemotingException &#123;\n        // è°ƒç”¨çˆ¶ç±»æ„é€ æ–¹æ³•\n        super(url, ChannelHandlers.wrap(handler, ExecutorUtil.setThreadName(url, SERVER_THREAD_POOL_NAME)));\n    &#125;\n&#125;\n\n\npublic abstract class AbstractServer extends AbstractEndpoint implements Server &#123;\n    public AbstractServer(URL url, ChannelHandler handler) throws RemotingException &#123;\n        // è°ƒç”¨çˆ¶ç±»æ„é€ æ–¹æ³•ï¼Œè¿™é‡Œå°±ä¸ç”¨è·Ÿè¿›å»äº†ï¼Œæ²¡ä»€ä¹ˆå¤æ‚é€»è¾‘\n        super(url, handler);\n        localAddress = getUrl().toInetSocketAddress();\n\n        // è·å– ip å’Œç«¯å£\n        String bindIp = getUrl().getParameter(Constants.BIND_IP_KEY, getUrl().getHost());\n        int bindPort = getUrl().getParameter(Constants.BIND_PORT_KEY, getUrl().getPort());\n        if (url.getParameter(Constants.ANYHOST_KEY, false) || NetUtils.isInvalidLocalHost(bindIp)) &#123;\n            // è®¾ç½® ip ä¸º 0.0.0.0\n            bindIp = NetUtils.ANYHOST;\n        &#125;\n        bindAddress = new InetSocketAddress(bindIp, bindPort);\n        // è·å–æœ€å¤§å¯æ¥å—è¿æ¥æ•°\n        this.accepts = url.getParameter(Constants.ACCEPTS_KEY, Constants.DEFAULT_ACCEPTS);\n        this.idleTimeout = url.getParameter(Constants.IDLE_TIMEOUT_KEY, Constants.DEFAULT_IDLE_TIMEOUT);\n        try &#123;\n            // è°ƒç”¨æ¨¡æ¿æ–¹æ³• doOpen å¯åŠ¨æœåŠ¡å™¨\n            doOpen();\n        &#125; catch (Throwable t) &#123;\n            throw new RemotingException(\"Failed to bind \");\n        &#125;\n\n        DataStore dataStore = ExtensionLoader.getExtensionLoader(DataStore.class).getDefaultExtension();\n        executor = (ExecutorService) dataStore.get(Constants.EXECUTOR_SERVICE_COMPONENT_KEY, Integer.toString(url.getPort()));\n    &#125;\n    \n    protected abstract void doOpen() throws Throwable;\n\n    protected abstract void doClose() throws Throwable;\n&#125;\n\n\n\n\nä¸Šé¢ä»£ç å¤šä¸ºèµ‹å€¼ä»£ç ï¼Œä¸éœ€è¦å¤šè®²ã€‚æˆ‘ä»¬é‡ç‚¹å…³æ³¨ doOpen æŠ½è±¡æ–¹æ³•ï¼Œè¯¥æ–¹æ³•éœ€è¦å­ç±»å®ç°ã€‚ä¸‹é¢å›åˆ° NettyServer ä¸­ã€‚\nprotected void doOpen() throws Throwable &#123;\n    NettyHelper.setNettyLoggerFactory();\n    // åˆ›å»º boss å’Œ worker çº¿ç¨‹æ± \n    ExecutorService boss = Executors.newCachedThreadPool(new NamedThreadFactory(\"NettyServerBoss\", true));\n    ExecutorService worker = Executors.newCachedThreadPool(new NamedThreadFactory(\"NettyServerWorker\", true));\n    ChannelFactory channelFactory = new NioServerSocketChannelFactory(boss, worker, getUrl().getPositiveParameter(Constants.IO_THREADS_KEY, Constants.DEFAULT_IO_THREADS));\n    \n    // åˆ›å»º ServerBootstrap\n    bootstrap = new ServerBootstrap(channelFactory);\n\n    final NettyHandler nettyHandler = new NettyHandler(getUrl(), this);\n    channels = nettyHandler.getChannels();\n    bootstrap.setOption(\"child.tcpNoDelay\", true);\n    // è®¾ç½® PipelineFactory\n    bootstrap.setPipelineFactory(new ChannelPipelineFactory() &#123;\n        @Override\n        public ChannelPipeline getPipeline() &#123;\n            NettyCodecAdapter adapter = new NettyCodecAdapter(getCodec(), getUrl(), NettyServer.this);\n            ChannelPipeline pipeline = Channels.pipeline();\n            pipeline.addLast(\"decoder\", adapter.getDecoder());\n            pipeline.addLast(\"encoder\", adapter.getEncoder());\n            pipeline.addLast(\"handler\", nettyHandler);\n            return pipeline;\n        &#125;\n    &#125;);\n    // ç»‘å®šåˆ°æŒ‡å®šçš„ ip å’Œç«¯å£ä¸Š\n    channel = bootstrap.bind(getBindAddress());\n&#125;\n\n\n\n\nä»¥ä¸Šå°±æ˜¯ NettyServer åˆ›å»ºçš„è¿‡ç¨‹ï¼Œdubbo é»˜è®¤ä½¿ç”¨çš„ NettyServer æ˜¯åŸºäº netty 3.x ç‰ˆæœ¬å®ç°çš„ï¼Œæ¯”è¾ƒè€äº†ã€‚å› æ­¤ Dubbo å¦å¤–æä¾›äº† netty 4.x ç‰ˆæœ¬çš„ NettyServerï¼Œå¤§å®¶å¯åœ¨ä½¿ç”¨ Dubbo çš„è¿‡ç¨‹ä¸­æŒ‰éœ€è¿›è¡Œé…ç½®ã€‚\nåˆ°æ­¤ï¼Œå…³äºæœåŠ¡å¯¼å‡ºçš„è¿‡ç¨‹å°±åˆ†æå®Œäº†ã€‚æ•´ä¸ªè¿‡ç¨‹æ¯”è¾ƒå¤æ‚ï¼Œå¤§å®¶åœ¨åˆ†æçš„è¿‡ç¨‹ä¸­è€å¿ƒä¸€äº›ã€‚å¹¶ä¸”å¤šå†™ Demo è¿›è¡Œè°ƒè¯•ï¼Œä»¥ä¾¿èƒ½å¤Ÿæ›´å¥½çš„ç†è§£ä»£ç é€»è¾‘ã€‚\næœ¬èŠ‚å†…å®¹å…ˆåˆ°è¿™é‡Œï¼Œæ¥ä¸‹æ¥åˆ†ææœåŠ¡å¯¼å‡ºçš„å¦ä¸€å—é€»è¾‘ â€” æœåŠ¡æ³¨å†Œã€‚\n\n2.2.4 æœåŠ¡æ³¨å†Œæœ¬èŠ‚æˆ‘ä»¬æ¥åˆ†ææœåŠ¡æ³¨å†Œè¿‡ç¨‹ï¼ŒæœåŠ¡æ³¨å†Œæ“ä½œå¯¹äº Dubbo æ¥è¯´ä¸æ˜¯å¿…éœ€çš„ï¼Œé€šè¿‡æœåŠ¡ç›´è¿çš„æ–¹å¼å°±å¯ä»¥ç»•è¿‡æ³¨å†Œä¸­å¿ƒã€‚ä½†é€šå¸¸æˆ‘ä»¬ä¸ä¼šè¿™ä¹ˆåšï¼Œç›´è¿æ–¹å¼ä¸åˆ©äºæœåŠ¡æ²»ç†ï¼Œä»…æ¨èåœ¨æµ‹è¯•æœåŠ¡æ—¶ä½¿ç”¨ã€‚å¯¹äº Dubbo æ¥è¯´ï¼Œæ³¨å†Œä¸­å¿ƒè™½ä¸æ˜¯å¿…éœ€ï¼Œä½†å´æ˜¯å¿…è¦çš„ã€‚å› æ­¤ï¼Œå…³äºæ³¨å†Œä¸­å¿ƒä»¥åŠæœåŠ¡æ³¨å†Œç›¸å…³é€»è¾‘ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦ææ‡‚ã€‚\næœ¬èŠ‚å†…å®¹ä»¥ Zookeeper æ³¨å†Œä¸­å¿ƒä½œä¸ºåˆ†æç›®æ ‡ï¼Œå…¶ä»–ç±»å‹æ³¨å†Œä¸­å¿ƒå¤§å®¶å¯è‡ªè¡Œåˆ†æã€‚ä¸‹é¢ä»æœåŠ¡æ³¨å†Œçš„å…¥å£æ–¹æ³•å¼€å§‹åˆ†æï¼Œæˆ‘ä»¬æŠŠç›®å…‰å†æ¬¡ç§»åˆ° RegistryProtocol çš„ export æ–¹æ³•ä¸Šã€‚å¦‚ä¸‹ï¼š\npublic &lt;T> Exporter&lt;T> export(final Invoker&lt;T> originInvoker) throws RpcException &#123;\n    \n    // $&#123;å¯¼å‡ºæœåŠ¡&#125;\n    \n    // çœç•¥å…¶ä»–ä»£ç \n    \n    boolean register = registeredProviderUrl.getParameter(\"register\", true);\n    if (register) &#123;\n        // æ³¨å†ŒæœåŠ¡\n        register(registryUrl, registeredProviderUrl);\n        ProviderConsumerRegTable.getProviderWrapper(originInvoker).setReg(true);\n    &#125;\n    \n    final URL overrideSubscribeUrl = getSubscribedOverrideUrl(registeredProviderUrl);\n    final OverrideListener overrideSubscribeListener = new OverrideListener(overrideSubscribeUrl, originInvoker);\n    overrideListeners.put(overrideSubscribeUrl, overrideSubscribeListener);\n    // è®¢é˜… override æ•°æ®\n    registry.subscribe(overrideSubscribeUrl, overrideSubscribeListener);\n\n    // çœç•¥éƒ¨åˆ†ä»£ç \n&#125;\n\n\n\n\nRegistryProtocol çš„ export æ–¹æ³•åŒ…å«äº†æœåŠ¡å¯¼å‡ºï¼Œæ³¨å†Œï¼Œä»¥åŠæ•°æ®è®¢é˜…ç­‰é€»è¾‘ã€‚å…¶ä¸­æœåŠ¡å¯¼å‡ºé€»è¾‘ä¸Šä¸€èŠ‚å·²ç»åˆ†æè¿‡äº†ï¼Œæœ¬èŠ‚å°†åˆ†ææœåŠ¡æ³¨å†Œé€»è¾‘ï¼Œç›¸å…³ä»£ç å¦‚ä¸‹ï¼š\npublic void register(URL registryUrl, URL registedProviderUrl) &#123;\n    // è·å– Registry\n    Registry registry = registryFactory.getRegistry(registryUrl);\n    // æ³¨å†ŒæœåŠ¡\n    registry.register(registedProviderUrl);\n&#125;\n\n\n\n\nregister æ–¹æ³•åŒ…å«ä¸¤æ­¥æ“ä½œï¼Œç¬¬ä¸€æ­¥æ˜¯è·å–æ³¨å†Œä¸­å¿ƒå®ä¾‹ï¼Œç¬¬äºŒæ­¥æ˜¯å‘æ³¨å†Œä¸­å¿ƒæ³¨å†ŒæœåŠ¡ã€‚æ¥ä¸‹æ¥åˆ†ä¸¤èŠ‚å†…å®¹å¯¹è¿™ä¸¤æ­¥æ“ä½œè¿›è¡Œåˆ†æã€‚\n\n2.2.4.1 åˆ›å»ºæ³¨å†Œä¸­å¿ƒæœ¬èŠ‚å†…å®¹ä»¥ Zookeeper æ³¨å†Œä¸­å¿ƒä¸ºä¾‹è¿›è¡Œåˆ†æã€‚ä¸‹é¢å…ˆæ¥çœ‹ä¸€ä¸‹ getRegistry æ–¹æ³•çš„æºç ï¼Œè¿™ä¸ªæ–¹æ³•ç”± AbstractRegistryFactory å®ç°ã€‚å¦‚ä¸‹ï¼š\npublic Registry getRegistry(URL url) &#123;\n    url = url.setPath(RegistryService.class.getName())\n            .addParameter(Constants.INTERFACE_KEY, RegistryService.class.getName())\n            .removeParameters(Constants.EXPORT_KEY, Constants.REFER_KEY);\n    String key = url.toServiceString();\n    LOCK.lock();\n    try &#123;\n    \t// è®¿é—®ç¼“å­˜\n        Registry registry = REGISTRIES.get(key);\n        if (registry != null) &#123;\n            return registry;\n        &#125;\n        \n        // ç¼“å­˜æœªå‘½ä¸­ï¼Œåˆ›å»º Registry å®ä¾‹\n        registry = createRegistry(url);\n        if (registry == null) &#123;\n            throw new IllegalStateException(\"Can not create registry...\");\n        &#125;\n        \n        // å†™å…¥ç¼“å­˜\n        REGISTRIES.put(key, registry);\n        return registry;\n    &#125; finally &#123;\n        LOCK.unlock();\n    &#125;\n&#125;\n\nprotected abstract Registry createRegistry(URL url);\n\n\n\n\nå¦‚ä¸Šï¼ŒgetRegistry æ–¹æ³•å…ˆè®¿é—®ç¼“å­˜ï¼Œç¼“å­˜æœªå‘½ä¸­åˆ™è°ƒç”¨ createRegistry åˆ›å»º Registryï¼Œç„¶åå†™å…¥ç¼“å­˜ã€‚è¿™é‡Œçš„ createRegistry æ˜¯ä¸€ä¸ªæ¨¡æ¿æ–¹æ³•ï¼Œç”±å…·ä½“çš„å­ç±»å®ç°ã€‚å› æ­¤ï¼Œä¸‹é¢æˆ‘ä»¬åˆ° ZookeeperRegistryFactory ä¸­æ¢ç©¶ä¸€ç•ªã€‚\npublic class ZookeeperRegistryFactory extends AbstractRegistryFactory &#123;\n\n    // zookeeperTransporter ç”± SPI åœ¨è¿è¡Œæ—¶æ³¨å…¥ï¼Œç±»å‹ä¸º ZookeeperTransporter$Adaptive\n    private ZookeeperTransporter zookeeperTransporter;\n\n    public void setZookeeperTransporter(ZookeeperTransporter zookeeperTransporter) &#123;\n        this.zookeeperTransporter = zookeeperTransporter;\n    &#125;\n\n    @Override\n    public Registry createRegistry(URL url) &#123;\n        // åˆ›å»º ZookeeperRegistry\n        return new ZookeeperRegistry(url, zookeeperTransporter);\n    &#125;\n&#125;\n\n\n\n\nZookeeperRegistryFactory çš„ createRegistry æ–¹æ³•ä»…åŒ…å«ä¸€å¥ä»£ç ï¼Œæ— éœ€è§£é‡Šï¼Œç»§ç»­è·Ÿä¸‹å»ã€‚\npublic ZookeeperRegistry(URL url, ZookeeperTransporter zookeeperTransporter) &#123;\n    super(url);\n    if (url.isAnyHost()) &#123;\n        throw new IllegalStateException(\"registry address == null\");\n    &#125;\n    \n    // è·å–ç»„åï¼Œé»˜è®¤ä¸º dubbo\n    String group = url.getParameter(Constants.GROUP_KEY, DEFAULT_ROOT);\n    if (!group.startsWith(Constants.PATH_SEPARATOR)) &#123;\n        // group = \"/\" + group\n        group = Constants.PATH_SEPARATOR + group;\n    &#125;\n    this.root = group;\n    // åˆ›å»º Zookeeper å®¢æˆ·ç«¯ï¼Œé»˜è®¤ä¸º CuratorZookeeperTransporter\n    zkClient = zookeeperTransporter.connect(url);\n    // æ·»åŠ çŠ¶æ€ç›‘å¬å™¨\n    zkClient.addStateListener(new StateListener() &#123;\n        @Override\n        public void stateChanged(int state) &#123;\n            if (state == RECONNECTED) &#123;\n                try &#123;\n                    recover();\n                &#125; catch (Exception e) &#123;\n                    logger.error(e.getMessage(), e);\n                &#125;\n            &#125;\n        &#125;\n    &#125;);\n&#125;\n\n\n\n\nåœ¨ä¸Šé¢çš„ä»£ç ä»£ç ä¸­ï¼Œæˆ‘ä»¬é‡ç‚¹å…³æ³¨ ZookeeperTransporter çš„ connect æ–¹æ³•è°ƒç”¨ï¼Œè¿™ä¸ªæ–¹æ³•ç”¨äºåˆ›å»º Zookeeper å®¢æˆ·ç«¯ã€‚åˆ›å»ºå¥½ Zookeeper å®¢æˆ·ç«¯ï¼Œæ„å‘³ç€æ³¨å†Œä¸­å¿ƒçš„åˆ›å»ºè¿‡ç¨‹å°±ç»“æŸäº†ã€‚æ¥ä¸‹æ¥ï¼Œå†æ¥åˆ†æä¸€ä¸‹ Zookeeper å®¢æˆ·ç«¯çš„åˆ›å»ºè¿‡ç¨‹ã€‚\nå‰é¢è¯´è¿‡ï¼Œè¿™é‡Œçš„ zookeeperTransporter ç±»å‹ä¸ºè‡ªé€‚åº”æ‹“å±•ç±»ï¼Œå› æ­¤ connect æ–¹æ³•ä¼šåœ¨è¢«è°ƒç”¨æ—¶å†³å®šåŠ è½½ä»€ä¹ˆç±»å‹çš„ ZookeeperTransporter æ‹“å±•ï¼Œé»˜è®¤ä¸º CuratorZookeeperTransporterã€‚ä¸‹é¢æˆ‘ä»¬åˆ° CuratorZookeeperTransporter ä¸­çœ‹ä¸€çœ‹ã€‚\npublic ZookeeperClient connect(URL url) &#123;\n    // åˆ›å»º CuratorZookeeperClient\n    return new CuratorZookeeperClient(url);\n&#125;\n\n\n\n\nç»§ç»­å‘ä¸‹çœ‹ã€‚\npublic class CuratorZookeeperClient extends AbstractZookeeperClient&lt;CuratorWatcher> &#123;\n\n    private final CuratorFramework client;\n    \n    public CuratorZookeeperClient(URL url) &#123;\n        super(url);\n        try &#123;\n            // åˆ›å»º CuratorFramework æ„é€ å™¨\n            CuratorFrameworkFactory.Builder builder = CuratorFrameworkFactory.builder()\n                    .connectString(url.getBackupAddress())\n                    .retryPolicy(new RetryNTimes(1, 1000))\n                    .connectionTimeoutMs(5000);\n            String authority = url.getAuthority();\n            if (authority != null &amp;&amp; authority.length() > 0) &#123;\n                builder = builder.authorization(\"digest\", authority.getBytes());\n            &#125;\n            // æ„å»º CuratorFramework å®ä¾‹\n            client = builder.build();\n            // æ·»åŠ ç›‘å¬å™¨\n            client.getConnectionStateListenable().addListener(new ConnectionStateListener() &#123;\n                @Override\n                public void stateChanged(CuratorFramework client, ConnectionState state) &#123;\n                    if (state == ConnectionState.LOST) &#123;\n                        CuratorZookeeperClient.this.stateChanged(StateListener.DISCONNECTED);\n                    &#125; else if (state == ConnectionState.CONNECTED) &#123;\n                        CuratorZookeeperClient.this.stateChanged(StateListener.CONNECTED);\n                    &#125; else if (state == ConnectionState.RECONNECTED) &#123;\n                        CuratorZookeeperClient.this.stateChanged(StateListener.RECONNECTED);\n                    &#125;\n                &#125;\n            &#125;);\n            \n            // å¯åŠ¨å®¢æˆ·ç«¯\n            client.start();\n        &#125; catch (Exception e) &#123;\n            throw new IllegalStateException(e.getMessage(), e);\n        &#125;\n    &#125;\n&#125;\n\n\n\n\nCuratorZookeeperClient æ„é€ æ–¹æ³•ä¸»è¦ç”¨äºåˆ›å»ºå’Œå¯åŠ¨ CuratorFramework å®ä¾‹ã€‚ä»¥ä¸ŠåŸºæœ¬ä¸Šéƒ½æ˜¯ Curator æ¡†æ¶çš„ä»£ç ï¼Œå¤§å®¶å¦‚æœå¯¹ Curator æ¡†æ¶ä¸æ˜¯å¾ˆäº†è§£ï¼Œå¯ä»¥å‚è€ƒ Curator å®˜æ–¹æ–‡æ¡£ã€‚\næœ¬èŠ‚åˆ†æäº† ZookeeperRegistry å®ä¾‹çš„åˆ›å»ºè¿‡ç¨‹ï¼Œæ•´ä¸ªè¿‡ç¨‹å¹¶ä¸æ˜¯å¾ˆå¤æ‚ã€‚å¤§å®¶åœ¨çœ‹å®Œåˆ†æåï¼Œå¯ä»¥è‡ªè¡Œè°ƒè¯•ï¼Œä»¥åŠ æ·±ç†è§£ã€‚ç°åœ¨æ³¨å†Œä¸­å¿ƒå®ä¾‹åˆ›å»ºå¥½äº†ï¼Œæ¥ä¸‹æ¥è¦åšçš„äº‹æƒ…æ˜¯å‘æ³¨å†Œä¸­å¿ƒæ³¨å†ŒæœåŠ¡ï¼Œæˆ‘ä»¬ç»§ç»­å¾€ä¸‹çœ‹ã€‚\n\n2.2.4.2 èŠ‚ç‚¹åˆ›å»ºä»¥ Zookeeper ä¸ºä¾‹ï¼Œæ‰€è°“çš„æœåŠ¡æ³¨å†Œï¼Œæœ¬è´¨ä¸Šæ˜¯å°†æœåŠ¡é…ç½®æ•°æ®å†™å…¥åˆ° Zookeeper çš„æŸä¸ªè·¯å¾„çš„èŠ‚ç‚¹ä¸‹ã€‚ä¸ºäº†è®©å¤§å®¶æœ‰ä¸€ä¸ªç›´è§‚çš„äº†è§£ï¼Œä¸‹é¢æˆ‘ä»¬å°† Dubbo çš„ demo è·‘èµ·æ¥ï¼Œç„¶åé€šè¿‡ Zookeeper å¯è§†åŒ–å®¢æˆ·ç«¯ ZooInspector æŸ¥çœ‹èŠ‚ç‚¹æ•°æ®ã€‚å¦‚ä¸‹ï¼š\n\nä»ä¸Šå›¾ä¸­å¯ä»¥çœ‹åˆ° com.alibaba.dubbo.demo.DemoService è¿™ä¸ªæœåŠ¡å¯¹åº”çš„é…ç½®ä¿¡æ¯ï¼ˆå­˜å‚¨åœ¨ URL ä¸­ï¼‰æœ€ç»ˆè¢«æ³¨å†Œåˆ°äº† &#x2F;dubbo&#x2F;com.alibaba.dubbo.demo.DemoService&#x2F;providers&#x2F; èŠ‚ç‚¹ä¸‹ã€‚ææ‡‚äº†æœåŠ¡æ³¨å†Œçš„æœ¬è´¨ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬å°±å¯ä»¥å»é˜…è¯»æœåŠ¡æ³¨å†Œçš„ä»£ç äº†ã€‚æœåŠ¡æ³¨å†Œçš„æ¥å£ä¸º register(URL)ï¼Œè¿™ä¸ªæ–¹æ³•å®šä¹‰åœ¨ FailbackRegistry æŠ½è±¡ç±»ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š\npublic void register(URL url) &#123;\n    super.register(url);\n    failedRegistered.remove(url);\n    failedUnregistered.remove(url);\n    try &#123;\n        // æ¨¡æ¿æ–¹æ³•ï¼Œç”±å­ç±»å®ç°\n        doRegister(url);\n    &#125; catch (Exception e) &#123;\n        Throwable t = e;\n\n        // è·å– check å‚æ•°ï¼Œè‹¥ check = true å°†ä¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸\n        boolean check = getUrl().getParameter(Constants.CHECK_KEY, true)\n                &amp;&amp; url.getParameter(Constants.CHECK_KEY, true)\n                &amp;&amp; !Constants.CONSUMER_PROTOCOL.equals(url.getProtocol());\n        boolean skipFailback = t instanceof SkipFailbackWrapperException;\n        if (check || skipFailback) &#123;\n            if (skipFailback) &#123;\n                t = t.getCause();\n            &#125;\n            throw new IllegalStateException(\"Failed to register\");\n        &#125; else &#123;\n            logger.error(\"Failed to register\");\n        &#125;\n\n        // è®°å½•æ³¨å†Œå¤±è´¥çš„é“¾æ¥\n        failedRegistered.add(url);\n    &#125;\n&#125;\n\nprotected abstract void doRegister(URL url);\n\n\n\n\nå¦‚ä¸Šï¼Œæˆ‘ä»¬é‡ç‚¹å…³æ³¨ doRegister æ–¹æ³•è°ƒç”¨å³å¯ï¼Œå…¶ä»–çš„ä»£ç å…ˆå¿½ç•¥ã€‚doRegister æ–¹æ³•æ˜¯ä¸€ä¸ªæ¨¡æ¿æ–¹æ³•ï¼Œå› æ­¤æˆ‘ä»¬åˆ° FailbackRegistry å­ç±» ZookeeperRegistry ä¸­è¿›è¡Œåˆ†æã€‚å¦‚ä¸‹ï¼š\nprotected void doRegister(URL url) &#123;\n    try &#123;\n        // é€šè¿‡ Zookeeper å®¢æˆ·ç«¯åˆ›å»ºèŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹è·¯å¾„ç”± toUrlPath æ–¹æ³•ç”Ÿæˆï¼Œè·¯å¾„æ ¼å¼å¦‚ä¸‹:\n        //   /$&#123;group&#125;/$&#123;serviceInterface&#125;/providers/$&#123;url&#125;\n        // æ¯”å¦‚\n        //   /dubbo/org.apache.dubbo.DemoService/providers/dubbo%3A%2F%2F127.0.0.1......\n        zkClient.create(toUrlPath(url), url.getParameter(Constants.DYNAMIC_KEY, true));\n    &#125; catch (Throwable e) &#123;\n        throw new RpcException(\"Failed to register...\");\n    &#125;\n&#125;\n\n\n\n\nå¦‚ä¸Šï¼ŒZookeeperRegistry åœ¨ doRegister ä¸­è°ƒç”¨äº† Zookeeper å®¢æˆ·ç«¯åˆ›å»ºæœåŠ¡èŠ‚ç‚¹ã€‚èŠ‚ç‚¹è·¯å¾„ç”± toUrlPath æ–¹æ³•ç”Ÿæˆï¼Œè¯¥æ–¹æ³•é€»è¾‘ä¸éš¾ç†è§£ï¼Œå°±ä¸åˆ†æäº†ã€‚æ¥ä¸‹æ¥åˆ†æ create æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š\npublic void create(String path, boolean ephemeral) &#123;\n    if (!ephemeral) &#123;\n        // å¦‚æœè¦åˆ›å»ºçš„èŠ‚ç‚¹ç±»å‹éä¸´æ—¶èŠ‚ç‚¹ï¼Œé‚£ä¹ˆè¿™é‡Œè¦æ£€æµ‹èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨\n        if (checkExists(path)) &#123;\n            return;\n        &#125;\n    &#125;\n    int i = path.lastIndexOf('/');\n    if (i > 0) &#123;\n        // é€’å½’åˆ›å»ºä¸Šä¸€çº§è·¯å¾„\n        create(path.substring(0, i), false);\n    &#125;\n    \n    // æ ¹æ® ephemeral çš„å€¼åˆ›å»ºä¸´æ—¶æˆ–æŒä¹…èŠ‚ç‚¹\n    if (ephemeral) &#123;\n        createEphemeral(path);\n    &#125; else &#123;\n        createPersistent(path);\n    &#125;\n&#125;\n\n\n\n\nä¸Šé¢æ–¹æ³•å…ˆæ˜¯é€šè¿‡é€’å½’åˆ›å»ºå½“å‰èŠ‚ç‚¹çš„ä¸Šä¸€çº§è·¯å¾„ï¼Œç„¶åå†æ ¹æ® ephemeral çš„å€¼å†³å®šåˆ›å»ºä¸´æ—¶è¿˜æ˜¯æŒä¹…èŠ‚ç‚¹ã€‚createEphemeral å’Œ createPersistent è¿™ä¸¤ä¸ªæ–¹æ³•éƒ½æ¯”è¾ƒç®€å•ï¼Œè¿™é‡Œç®€å•åˆ†æå…¶ä¸­çš„ä¸€ä¸ªã€‚å¦‚ä¸‹ï¼š\npublic void createEphemeral(String path) &#123;\n    try &#123;\n        // é€šè¿‡ Curator æ¡†æ¶åˆ›å»ºèŠ‚ç‚¹\n        client.create().withMode(CreateMode.EPHEMERAL).forPath(path);\n    &#125; catch (NodeExistsException e) &#123;\n    &#125; catch (Exception e) &#123;\n        throw new IllegalStateException(e.getMessage(), e);\n    &#125;\n&#125;\n\nå¥½äº†ï¼Œåˆ°æ­¤å…³äºæœåŠ¡æ³¨å†Œçš„è¿‡ç¨‹å°±åˆ†æå®Œäº†ã€‚æ•´ä¸ªè¿‡ç¨‹å¯ç®€å•æ€»ç»“ä¸ºï¼šå…ˆåˆ›å»ºæ³¨å†Œä¸­å¿ƒå®ä¾‹ï¼Œä¹‹åå†é€šè¿‡æ³¨å†Œä¸­å¿ƒå®ä¾‹æ³¨å†ŒæœåŠ¡ã€‚æœ¬èŠ‚å…ˆåˆ°è¿™ï¼Œæ¥ä¸‹æ¥åˆ†ææ•°æ®è®¢é˜…è¿‡ç¨‹ã€‚\n\n2.2.5 è®¢é˜… override æ•°æ®&#x2F;&#x2F; å¾…è¡¥å……\n\n3.æ€»ç»“æœ¬ç¯‡æ–‡ç« è¯¦ç»†åˆ†æäº† Dubbo æœåŠ¡å¯¼å‡ºè¿‡ç¨‹ï¼ŒåŒ…æ‹¬é…ç½®æ£€æµ‹ï¼ŒURL ç»„è£…ï¼ŒInvoker åˆ›å»ºè¿‡ç¨‹ã€å¯¼å‡ºæœåŠ¡ä»¥åŠæ³¨å†ŒæœåŠ¡ç­‰ç­‰ã€‚ç¯‡å¹…æ¯”è¾ƒå¤§ï¼Œéœ€è¦å¤§å®¶è€å¿ƒé˜…è¯»ã€‚æœ¬ç¯‡æ–‡ç« å…ˆå°±åˆ°è¿™ï¼Œå¦‚æœæ–‡ç« æœ‰ä¸å¦¥é”™è¯¯ä¹‹å¤„ï¼Œå¸Œæœ›å¤§å®¶èƒ½å¤Ÿè¿›è¡Œåé¦ˆæˆ–ä¿®æ­£ã€‚\n","slug":"Dubboæºç åˆ†æ","date":"2022-06-11T08:15:34.680Z","categories_index":"æºç ","tags_index":"java,Dubbo,æºç ","author_index":"å°æä¸åœ¨_"}]